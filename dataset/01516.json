{
  "Title": "Missing access control",
  "Content": "The [`approveNewLandTunnel` function](https://github.com/thesandboxgame/sandbox-smart-contracts/blob/8430ea5fdb0f4905b9678689ce0cbc2f74a704b6/src/solc_0.8/polygon/child/land/PolygonLandTunnelMigration.sol#L99) in the `PolygonLandTunnelMigration` contract sets approval for the new land tunnel contract to transfer LAND tokens on behalf of the contract. This function lacks any access control and can be called by anyone.\n\n\nWhile this is not directly a security risk as only super-operators are approved to transfer LAND tokens to the contract within the `migrateToTunnelWithWithdraw` function, consider restricting this function such that only the `admin` can call it to further secure the contract.\n\n\n***Update:** Resolved in [pull request #946](https://github.com/thesandboxgame/sandbox-smart-contracts/pull/946) at commit [90a111e](https://github.com/thesandboxgame/sandbox-smart-contracts/pull/946/commits/90a111ea986ad9835d0819d295f1024ab810d86c).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "src/solc_0.8/polygon/child/land/PolygonLandTunnelMigration.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.2;\n\nimport \"../../../common/interfaces/IPolygonLandWithSetApproval.sol\";\nimport \"../../../common/interfaces/IPolygonLandTunnel.sol\";\nimport \"../../../common/interfaces/IERC721MandatoryTokenReceiver.sol\";\n\n/// @title Tunnel migration on L2\ncontract PolygonLandTunnelMigration is IERC721MandatoryTokenReceiver {\n    uint256 private constant GRID_SIZE = 408;\n\n    struct OwnerWithLandIds {\n        address owner;\n        uint256[] sizes;\n        uint256[] x;\n        uint256[] y;\n    }\n\n    IPolygonLandWithSetApproval public polygonLand;\n    address public newLandTunnel;\n    address public oldLandTunnel;\n    address private admin;\n\n    event TunnelLandsMigrated(address indexed oldLandTunnel, address indexed newLandTunnel, uint256[] ids);\n    event TunnelLandsMigratedWithWithdraw(OwnerWithLandIds _ownerWithLandIds);\n    event TunnelQuadsMigrated(\n        address indexed oldLandTunnel,\n        address indexed newLandTunnel,\n        uint256[] sizes,\n        uint256[] x,\n        uint256[] y\n    );\n    event AdminChanged(address _newAdmin);\n\n    modifier isAdmin() {\n        require(admin == msg.sender, \"PolygonLandTunnelMigration: !AUTHORISED\");\n        _;\n    }\n\n    /// @notice changes admin to new admin\n    /// @param _newAdmin the new admin to be set\n    function changeAdmin(address _newAdmin) external isAdmin {\n        require(_newAdmin != address(0), \"PolygonLandTunnelMigration: admin can't be zero address\");\n        admin = _newAdmin;\n        emit AdminChanged(_newAdmin);\n    }\n\n    constructor(\n        address _polygonLand,\n        address _newLandTunnel,\n        address _oldLandTunnel,\n        address _admin\n    ) {\n        require(_admin != address(0), \"PolygonLandTunnelMigration: admin cant be zero address\");\n        require(_polygonLand != address(0), \"PolygonLandTunnelMigration: polygonLand cant be zero address\");\n        require(_newLandTunnel != address(0), \"PolygonLandTunnelMigration: new Tunnel cant be zero address\");\n        require(_oldLandTunnel != address(0), \"PolygonLandTunnelMigration: old Tunnel cant be zero address\");\n        admin = _admin;\n        polygonLand = IPolygonLandWithSetApproval(_polygonLand);\n        newLandTunnel = _newLandTunnel;\n        oldLandTunnel = _oldLandTunnel;\n    }\n\n    /// @dev Transfers all the passed land ids from the old land tunnel to the new land tunnel\n    /// @notice This method needs super operator role to execute\n    /// @param ids of land tokens to be migrated\n    function migrateLandsToTunnel(uint256[] memory ids) external isAdmin {\n        polygonLand.batchTransferFrom(oldLandTunnel, newLandTunnel, ids, \"0x\");\n        emit TunnelLandsMigrated(oldLandTunnel, newLandTunnel, ids);\n    }\n\n    /// @dev Fetches locked land ids to this contract and withdraws again through the new tunnel\n    /// @notice This method needs super operator role to execute\n    /// @param _ownerWithLandIds struct containing token owner with their land ids\n    function migrateToTunnelWithWithdraw(OwnerWithLandIds memory _ownerWithLandIds) external isAdmin {\n        // check for gas limits based on the number of locked tokens\n        // Fetch locked tokens to this contract address\n        polygonLand.batchTransferQuad(\n            oldLandTunnel,\n            address(this),\n            _ownerWithLandIds.sizes,\n            _ownerWithLandIds.x,\n            _ownerWithLandIds.y,\n            \"0x\"\n        );\n        // Withdraw tokens to L1\n        IPolygonLandTunnel(newLandTunnel).batchTransferQuadToL1(\n            _ownerWithLandIds.owner,\n            _ownerWithLandIds.sizes,\n            _ownerWithLandIds.x,\n            _ownerWithLandIds.y,\n            \"0x\"\n        );\n\n        emit TunnelLandsMigratedWithWithdraw(_ownerWithLandIds);\n    }\n\n    ///@dev approves New Land Tunnel to transfer Lands on behalf of this contract\n    function approveNewLandTunnel() external {\n        polygonLand.setApprovalForAll(newLandTunnel, true);\n    }\n\n    /// @dev Transfers all the passed quads from the old land tunnel to the new land tunnel\n    /// @notice This method needs super operator role to execute\n    /// @param sizes of land quads to be migrated\n    /// @param x coordinate of land quads to be migrated\n    /// @param y coordinate of land quads to be migrated\n    function migrateQuadsToTunnel(\n        uint256[] memory sizes,\n        uint256[] memory x,\n        uint256[] memory y\n    ) external isAdmin {\n        polygonLand.batchTransferQuad(oldLandTunnel, newLandTunnel, sizes, x, y, \"0x\");\n        emit TunnelQuadsMigrated(oldLandTunnel, newLandTunnel, sizes, x, y);\n    }\n\n    function onERC721Received(\n        address, /* operator */\n        address, /* from */\n        uint256, /* tokenId */\n        bytes calldata /* data */\n    ) external pure override returns (bytes4) {\n        return this.onERC721Received.selector;\n    }\n\n    function onERC721BatchReceived(\n        address, /* operator */\n        address, /* from */\n        uint256[] calldata, /* ids */\n        bytes calldata /* data */\n    ) external pure override returns (bytes4) {\n        return this.onERC721BatchReceived.selector;\n    }\n\n    /// @dev to be called by external contact to check if this contract supports ERC721 token and batch token receive\n    /// @param interfaceId the interface to be checked if supported by the contract\n    /// 0x5e8bf644 is the interface of IERC721MandatoryTokenReceiver and 0x01ffc9a7 for the Eip 165 supports interface's interface id\n    function supportsInterface(bytes4 interfaceId) external pure returns (bool) {\n        return interfaceId == 0x5e8bf644 || interfaceId == 0x01ffc9a7;\n    }\n}"
    }
  ]
}