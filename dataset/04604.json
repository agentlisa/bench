{
  "Title": "Contract initialization is too complex",
  "Content": "The excessive use of the [strategy pattern](https://en.wikipedia.org/wiki/Strategy_pattern) for the crowdsale contract makes deployment and configuration much more complicated, requiring several [agent configurations](https://github.com/CoinFabrik/ico/blob/142f43f3bec4afd0ffff3fce06946cf67cb0272f/migrations/2_deploy_contracts.js#L34) (`setMintAgent`, `setReleaseAgent`, `setFinalizeAgent`), which is highly error prone. Consider defining a specialized version of `Crowdsale` (maybe calling it `HubiiCrowdsale`) that performs all required initialization steps, including setting up and configuring the agents and token contracts.\n\n\nAs a side note, note that all `setAgent` methods can be invoked at any time, not just during construction. This was one of the issues that enabled [the Parity MultiSig hack](https://blog.zeppelin.solutions/on-the-parity-wallet-multisig-hack-405a8c12e8f7), though in this case the `onlyOwner` modifier prevents similar attacks.\n\n\n**Update:** Hubii replied *“The split of the contract in several pieces was done to circumvent the gas limit in the mainnet last year. We understand this is not an issue now, and we have grouped the setup process within a single contract.”* Fixed in [`5a90957abf3f792951b3aad66d6eb0317f0500ca`](https://github.com/CoinFabrik/ico/commit/5a90957abf3f792951b3aad66d6eb0317f0500ca).\n\n\n",
  "Impact": "MEDIUM",
  "Source": "",
  "Code": [
    {
      "filename": "migrations/2_deploy_contracts.js",
      "content": "const SafeMath = artifacts.require('./SafeMath.sol');\nconst MultiSigWallet = artifacts.require('./MultiSigWallet.sol');\nconst FlatPricing = artifacts.require('./FlatPricing.sol');\nconst BonusFinalizeAgent = artifacts.require('./BonusFinalizeAgent.sol');\nconst CrowdsaleToken = artifacts.require('./CrowdsaleToken.sol');\nconst FixedCeiling = artifacts.require('./FixedCeiling.sol');\nconst Crowdsale = artifacts.require('./Crowdsale.sol');\n\nconst config = require('../config.js');\n\nmodule.exports = function(deployer) {\n    deployer.deploy(SafeMath);\n    deployer.link(SafeMath, FlatPricing);\n    deployer.link(SafeMath, BonusFinalizeAgent);\n    deployer.link(SafeMath, CrowdsaleToken);\n    deployer.link(SafeMath, FixedCeiling);\n    deployer.link(SafeMath, Crowdsale);\n\n    let CT_contract = [ CrowdsaleToken, config.tokenName, config.tokenSymbol, web3.toWei(config.initialSupply), config.decimals, config.mintable ];\n    let FP_contract = [ FlatPricing, web3.toWei(config.price) ];\n    let FC_contract = [ FixedCeiling, web3.toWei(config.chunkedMultipleCap), web3.toWei(config.limitPerAddress) ];\n    // TODO: change to use client's MultiSigWallet\n    let MW_contract = [ MultiSigWallet, [0x4cdabc27b48893058aa1675683af3485e4409eff], 1 ];\n    \n    return deployer.deploy([ CT_contract, FP_contract, FC_contract, MW_contract ])\n    .then(async function() {\n        await deployer.deploy(Crowdsale, CrowdsaleToken.address, FlatPricing.address, FixedCeiling.address, MultiSigWallet.address, config.startDate,  config.endDate,  web3.toWei(config.minimumFundingGoal));\n    })\n    .then(async function() {\n        await deployer.deploy(BonusFinalizeAgent, CrowdsaleToken.address, Crowdsale.address, config.BONUS_BASE_POINTS, MultiSigWallet.address);\n    })\n    .then(async function() {\n        let CT_prom = CrowdsaleToken.deployed()\n        .then(async function(tokenInstance) {\n            console.log('Setting Crowdsale as mint agent of CrowdsaleToken...');\n            await tokenInstance.setMintAgent(Crowdsale.address, true);\n            console.log('Setting BonusFinalizeAgent as mint agent of CrowdsaleToken...');\n            await tokenInstance.setMintAgent(BonusFinalizeAgent.address, true);\n            console.log('Setting BonusFinalizeAgent as release agent of CrowdsaleToken...');\n            await tokenInstance.setReleaseAgent(BonusFinalizeAgent.address);\n            // console.log('Transfering ownership of CrowdsaleToken to MultiSigWallet...');\n            // tokenInstance.transferOwnership(MultiSigWallet.address);\n        });\n        \n        let C_prom = Crowdsale.deployed()\n        .then(async function(crowdsaleInstance) {\n            console.log('Setting BonusFinalizeAgent as finalize agent of Crowdsale...');\n            await crowdsaleInstance.setFinalizeAgent(BonusFinalizeAgent.address);\n            // console.log('Transfering ownership of Crowdsale contract to MultiSigWallet...');\n            // crowdsaleInstance.transferOwnership(MultiSigWallet.address);\n        });\n\n        await Promise.all([ CT_prom, C_prom ]);\n    })\n    .catch(function(error) {\n        console.log(error);\n    });\n};"
    }
  ]
}