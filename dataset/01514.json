{
  "Title": "Setting the root and child tunnel addresses can be front-run",
  "Content": "The external [`setFxRootTunnel`](https://github.com/0xPolygon/fx-portal/blob/main/contracts/tunnel/FxBaseChildTunnel.sol#L37) and [`setFxChildTunnel`](https://github.com/0xPolygon/fx-portal/blob/main/contracts/tunnel/FxBaseRootTunnel.sol#L57) functions defined in the `FxBaseChildTunnel` and `FxBaseRootTunnel` contracts set the `fxRootTunnel` and `fxChildTunnel` state variables. These contracts are inherited by the [`FxBaseChildTunnelUpgradeable`](https://github.com/thesandboxgame/sandbox-smart-contracts/blob/8430ea5fdb0f4905b9678689ce0cbc2f74a704b6/src/solc_0.8/common/fx-portal/FxBaseChildTunnelUpgradeable.sol) and [`FxBaseRootTunnelUpgradeable`](https://github.com/thesandboxgame/sandbox-smart-contracts/blob/8430ea5fdb0f4905b9678689ce0cbc2f74a704b6/src/solc_0.8/common/fx-portal/FxBaseRootTunnelUpgradeable.sol) contracts and the functions are never overridden. Since these functions do not contain any access control, anyone can call them and set the aforementioned addresses to any address except the zero address. If these functions were front-run, the implementation contracts would need to be redeployed as it will not be possible to change these addresses after they have been set.\n\n\nConsider either including access control on these functions, calling them within the `initialize` functions, or ensuring that they are called within the same transaction as when the implementation contracts are initialized.\n\n\n***Update:** Resolved in [pull request #945](https://github.com/thesandboxgame/sandbox-smart-contracts/pull/945) at commit [b74749c](https://github.com/thesandboxgame/sandbox-smart-contracts/pull/945/commits/01ca8dd5cd1f014eff130329408fb2953cbb5dc5).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/tunnel/FxBaseChildTunnel.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n// IFxMessageProcessor represents interface to process message\nimport {IFxMessageProcessor} from \"../FxChild.sol\";\n\n/**\n * @notice Mock child tunnel contract to receive and send message from L2\n */\nabstract contract FxBaseChildTunnel is IFxMessageProcessor {\n    // MessageTunnel on L1 will get data from this event\n    event MessageSent(bytes message);\n\n    // fx child\n    address public fxChild;\n\n    // fx root tunnel\n    address public fxRootTunnel;\n\n    constructor(address _fxChild) {\n        fxChild = _fxChild;\n    }\n\n    // Sender must be fxRootTunnel in case of ERC20 tunnel\n    modifier validateSender(address sender) {\n        require(sender == fxRootTunnel, \"FxBaseChildTunnel: INVALID_SENDER_FROM_ROOT\");\n        _;\n    }\n\n    // set fxRootTunnel if not set already\n    function setFxRootTunnel(address _fxRootTunnel) external virtual {\n        require(fxRootTunnel == address(0x0), \"FxBaseChildTunnel: ROOT_TUNNEL_ALREADY_SET\");\n        fxRootTunnel = _fxRootTunnel;\n    }\n\n    function processMessageFromRoot(uint256 stateId, address rootMessageSender, bytes calldata data) external override {\n        require(msg.sender == fxChild, \"FxBaseChildTunnel: INVALID_SENDER\");\n        _processMessageFromRoot(stateId, rootMessageSender, data);\n    }\n\n    /**\n     * @notice Emit message that can be received on Root Tunnel\n     * @dev Call the internal function when need to emit message\n     * @param message bytes message that will be sent to Root Tunnel\n     * some message examples -\n     *   abi.encode(tokenId);\n     *   abi.encode(tokenId, tokenMetadata);\n     *   abi.encode(messageType, messageData);\n     */\n    function _sendMessageToRoot(bytes memory message) internal {\n        emit MessageSent(message);\n    }\n\n    /**\n     * @notice Process message received from Root Tunnel\n     * @dev function needs to be implemented to handle message as per requirement\n     * This is called by onStateReceive function.\n     * Since it is called via a system call, any event will not be emitted during its execution.\n     * @param stateId unique state id\n     * @param sender root message sender\n     * @param message bytes message that was sent from Root Tunnel\n     */\n    function _processMessageFromRoot(uint256 stateId, address sender, bytes memory message) internal virtual;\n}"
    }
  ]
}