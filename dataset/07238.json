{
  "Title": "[G-01] Don't apply the same value to state variables",
  "Content": "If `_whenDefault` is already `NEVER`, it'll save 2100 gas to not set it to that value again\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: /contracts/plugins/assets/FiatCollateral.sol\n\n189:             if (sum >= NEVER) _whenDefault = NEVER;\n\n```\nhttps://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/FiatCollateral.sol#L189\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/reports/2023-01-reserve",
  "Code": [
    {
      "filename": "contracts/plugins/assets/FiatCollateral.sol",
      "content": "// SPDX-License-Identifier: BlueOak-1.0.0\npragma solidity 0.8.9;\n\nimport \"@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol\";\nimport \"../../interfaces/IAsset.sol\";\nimport \"../../libraries/Fixed.sol\";\nimport \"./FiatCollateral.sol\";\nimport \"./Asset.sol\";\nimport \"./OracleLib.sol\";\n\nstruct CollateralConfig {\n    uint48 priceTimeout; // {s} The number of seconds over which saved prices decay\n    AggregatorV3Interface chainlinkFeed; // Feed units: {target/ref}\n    uint192 oracleError; // {1} The % the oracle feed can be off by\n    IERC20Metadata erc20; // The ERC20 of the collateral token\n    uint192 maxTradeVolume; // {UoA} The max trade volume, in UoA\n    uint48 oracleTimeout; // {s} The number of seconds until a oracle value becomes invalid\n    bytes32 targetName; // The bytes32 representation of the target name\n    uint192 defaultThreshold; // {1} A value like 0.05 that represents a deviation tolerance\n    // set defaultThreshold to zero to create SelfReferentialCollateral\n    uint48 delayUntilDefault; // {s} The number of seconds an oracle can mulfunction\n}\n\n/**\n * @title FiatCollateral\n * Parent class for all collateral. Can be extended to support changing refPerToks or non-fiat\n *\n * For: {tok} == {ref}, {ref} != {target}, {target} == {UoA}\n * Can be easily extended by (optionally) re-implementing:\n *   - tryPrice()\n *   - refPerTok()\n *   - targetPerRef()\n *   - claimRewards()\n * Should not have to re-implement any other methods.\n *\n * Can intentionally disable default checks by setting config.defaultThreshold to 0\n */\ncontract FiatCollateral is ICollateral, Asset {\n    using FixLib for uint192;\n    using OracleLib for AggregatorV3Interface;\n\n    // Default Status:\n    // _whenDefault == NEVER: no risk of default (initial value)\n    // _whenDefault > block.timestamp: delayed default may occur as soon as block.timestamp.\n    //                In this case, the asset may recover, reachiving _whenDefault == NEVER.\n    // _whenDefault <= block.timestamp: default has already happened (permanently)\n    uint48 private constant NEVER = type(uint48).max;\n    uint48 private _whenDefault = NEVER;\n\n    uint48 public immutable delayUntilDefault; // {s} e.g 86400\n\n    // targetName: The canonical name of this collateral's target unit.\n    bytes32 public immutable targetName;\n\n    uint192 public immutable pegBottom; // {target/ref} The bottom of the peg\n\n    uint192 public immutable pegTop; // {target/ref} The top of the peg\n\n    // does not become nonzero until after first refresh()\n    uint192 public prevReferencePrice; // previous rate, {ref/tok}\n\n    /// @param config.chainlinkFeed Feed units: {UoA/ref}\n    constructor(CollateralConfig memory config)\n        Asset(\n            config.priceTimeout,\n            config.chainlinkFeed,\n            config.oracleError,\n            config.erc20,\n            config.maxTradeVolume,\n            config.oracleTimeout\n        )\n    {\n        require(config.targetName != bytes32(0), \"targetName missing\");\n        if (config.defaultThreshold > 0) {\n            require(config.delayUntilDefault > 0, \"delayUntilDefault zero\");\n        }\n\n        targetName = config.targetName;\n        delayUntilDefault = config.delayUntilDefault;\n\n        // Cache constants\n        uint192 peg = targetPerRef(); // {target/ref}\n\n        // {target/ref}= {target/ref} * {1}\n        uint192 delta = peg.mul(config.defaultThreshold);\n        pegBottom = peg - delta;\n        pegTop = peg + delta;\n    }\n\n    /// Can revert, used by other contract functions in order to catch errors\n    /// Should not return FIX_MAX for low\n    /// Should only return FIX_MAX for high if low is 0\n    /// @dev Override this when pricing is more complicated than just a single oracle\n    /// @param low {UoA/tok} The low price estimate\n    /// @param high {UoA/tok} The high price estimate\n    /// @param pegPrice {target/ref} The actual price observed in the peg\n    function tryPrice()\n        external\n        view\n        virtual\n        override\n        returns (\n            uint192 low,\n            uint192 high,\n            uint192 pegPrice\n        )\n    {\n        pegPrice = chainlinkFeed.price(oracleTimeout); // {target/ref}\n\n        // {UoA/tok} = {target/ref} * {ref/tok} * {UoA/target} (1)\n        uint192 p = pegPrice.mul(refPerTok());\n        uint192 delta = p.mul(oracleError);\n\n        low = p - delta;\n        high = p + delta;\n    }\n\n    /// Should not revert\n    /// Refresh exchange rates and update default status.\n    /// @dev Should be general enough to not need to be overridden\n    function refresh() public virtual override(Asset, IAsset) {\n        if (alreadyDefaulted()) return;\n        CollateralStatus oldStatus = status();\n\n        // Check for soft default + save lotPrice\n        try this.tryPrice() returns (uint192 low, uint192 high, uint192 pegPrice) {\n            // {UoA/tok}, {UoA/tok}, {target/ref}\n            // (0, 0) is a valid price; (0, FIX_MAX) is unpriced\n\n            // Save prices if priced\n            if (high < FIX_MAX) {\n                savedLowPrice = low;\n                savedHighPrice = high;\n                lastSave = uint48(block.timestamp);\n            } else {\n                // must be unpriced\n                assert(low == 0);\n            }\n\n            // If the price is below the default-threshold price, default eventually\n            // uint192(+/-) is the same as Fix.plus/minus\n            if (pegPrice < pegBottom || pegPrice > pegTop || low == 0) {\n                markStatus(CollateralStatus.IFFY);\n            } else {\n                markStatus(CollateralStatus.SOUND);\n            }\n        } catch (bytes memory errData) {\n            // see: docs/solidity-style.md#Catching-Empty-Data\n            if (errData.length == 0) revert(); // solhint-disable-line reason-string\n            markStatus(CollateralStatus.IFFY);\n        }\n\n        // Check for hard default\n        uint192 referencePrice = refPerTok();\n        // uint192(<) is equivalent to Fix.lt\n        if (referencePrice < prevReferencePrice) {\n            markStatus(CollateralStatus.DISABLED);\n        }\n        prevReferencePrice = referencePrice;\n\n        CollateralStatus newStatus = status();\n        if (oldStatus != newStatus) {\n            emit CollateralStatusChanged(oldStatus, newStatus);\n        }\n    }\n\n    /// @return The collateral's status\n    function status() public view returns (CollateralStatus) {\n        if (_whenDefault == NEVER) {\n            return CollateralStatus.SOUND;\n        } else if (_whenDefault > block.timestamp) {\n            return CollateralStatus.IFFY;\n        } else {\n            return CollateralStatus.DISABLED;\n        }\n    }\n\n    // === Helpers for child classes ===\n\n    function markStatus(CollateralStatus status_) internal {\n        // untestable:\n        //      All calls to markStatus happen exclusively if the collateral is not defaulted\n        if (_whenDefault <= block.timestamp) return; // prevent DISABLED -> SOUND/IFFY\n\n        if (status_ == CollateralStatus.SOUND) {\n            _whenDefault = NEVER;\n        } else if (status_ == CollateralStatus.IFFY) {\n            uint256 sum = block.timestamp + uint256(delayUntilDefault);\n            if (sum >= NEVER) _whenDefault = NEVER;\n            else if (sum < _whenDefault) _whenDefault = uint48(sum);\n            // else: no change to _whenDefault\n            // untested:\n            //      explicit `if` to check DISABLED. else branch will never be hit\n        } else if (status_ == CollateralStatus.DISABLED) {\n            _whenDefault = uint48(block.timestamp);\n        }\n    }\n\n    function alreadyDefaulted() internal view returns (bool) {\n        return _whenDefault <= block.timestamp;\n    }\n\n    function whenDefault() external view returns (uint256) {\n        return _whenDefault;\n    }\n\n    // === End child helpers ===\n\n    /// @return {ref/tok} Quantity of whole reference units per whole collateral tokens\n    function refPerTok() public view virtual returns (uint192) {\n        return FIX_ONE;\n    }\n\n    /// @return {target/ref} Quantity of whole target units per whole reference unit in the peg\n    function targetPerRef() public view virtual returns (uint192) {\n        return FIX_ONE;\n    }\n\n    /// @return If the asset is an instance of ICollateral or not\n    function isCollateral() external pure virtual override(Asset, IAsset) returns (bool) {\n        return true;\n    }\n}"
    }
  ]
}