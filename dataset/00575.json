{
  "Title": "[M-07] Using stale price in Pyth Network",
  "Content": "**Severity**\n\n**Impact:** High - Using stale prices leads to inaccurate calculations of total asset values and share prices.\n\n**Likelihood:** Low - Price can be stale frequently if there is no update\n\n**Description**\n\nThe `StrategyV5Pyth` uses `pyth.getPriceUnsafe` for obtaining Pyth oracle price feeds to calculate the asset/input exchange rate.\n\n        function assetExchangeRate(uint8 inputId) public view returns (uint256) {\n            if (inputPythIds[inputId] == assetPythId)\n                return weiPerShare; // == weiPerUnit of asset == 1:1\n            PythStructs.Price memory inputPrice = pyth.getPriceUnsafe(inputPythIds[inputId]);\n            PythStructs.Price memory assetPrice = pyth.getPriceUnsafe(assetPythId);\n            ...\n        }\n\nHowever, from the Pyth documents, using the getPriceUnsafe can return stale price if the price is not updated.\n\n        /// @notice Returns the price of a price feed without any sanity checks.\n        /// @dev This function returns the most recent price update in this contract without any recency checks.\n        /// This function is unsafe as the returned price update may be arbitrarily far in the past.\n        ///\n        /// Users of this function should check the `publishTime` in the price to ensure that the returned price is\n        /// sufficiently recent for their application. If you are considering using this function, it may be\n        /// safer / easier to use either `getPrice` or `getPriceNoOlderThan`.\n        /// @return price - please read the documentation of PythStructs.Price to understand how to use this safely.\n        function getPriceUnsafe(\n            bytes32 id\n        ) external view returns (PythStructs.Price memory price);\n\nThe `assetExchangeRate` function doesn't verify `Price.publishTime`, potentially leading to outdated exchange rates, incorrect investment calculations, and distorted total asset values.\n\n**Recommendations**\n\nUsing `pyth.updatePriceFeeds` for updating prices, followed by `pyth.getPrice` for retrieval.\nFollowing the example in: https://github.com/pyth-network/pyth-sdk-solidity/blob/main/README.md#example-usage",
  "Impact": "MEDIUM",
  "Source": "",
  "Code": [
    {
      "filename": "README.md",
      "content": "# Pyth Solidity SDK\n\nThis package provides utilities for consuming prices from the [Pyth Network](https://pyth.network/) Oracle using Solidity. Also, it contains [the Pyth Interface ABI](./abis/IPyth.json) that you can use in your libraries\nto communicate with the Pyth contract.\n\nIt is **strongly recommended** to follow the [consumer best practices](https://docs.pyth.network/consumers/best-practices) when consuming Pyth data.\n\n## Installation\n\n```bash\nnpm install @pythnetwork/pyth-sdk-solidity\n```\n\n## Example Usage\n\nTo consume prices you should use the [`IPyth`](IPyth.sol) interface. Please make sure to read the documentation of this interface in order to use the prices safely.\n\nFor example, to read the latest price, call [`getPrice`](IPyth.sol) with the Price ID of the price feed you're interested in. The price feeds available on each chain are listed [below](#target-chains).\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"@pythnetwork/pyth-sdk-solidity/IPyth.sol\";\nimport \"@pythnetwork/pyth-sdk-solidity/PythStructs.sol\";\n\ncontract ExampleContract {\n  IPyth pyth;\n\n  constructor(address pythContract) {\n    pyth = IPyth(pythContract);\n  }\n\n  function getBtcUsdPrice(\n    bytes[] calldata priceUpdateData\n  ) public payable returns (PythStructs.Price memory) {\n    // Update the prices to the latest available values and pay the required fee for it. The `priceUpdateData` data\n    // should be retrieved from our off-chain Price Service API using the `pyth-evm-js` package.\n    // See section \"How Pyth Works on EVM Chains\" below for more information.\n    uint fee = pyth.getUpdateFee(priceUpdateData);\n    pyth.updatePriceFeeds{ value: fee }(priceUpdateData);\n\n    bytes32 priceID = 0xf9c0172ba10dfa4d19088d94f5bf61d3b54d5bd7483a322a982e1373ee8ea31b;\n    // Read the current value of priceID, aborting the transaction if the price has not been updated recently.\n    // Every chain has a default recency threshold which can be retrieved by calling the getValidTimePeriod() function on the contract.\n    // Please see IPyth.sol for variants of this function that support configurable recency thresholds and other useful features.\n    return pyth.getPrice(priceID);\n  }\n}\n\n```\n\n## How Pyth Works on EVM Chains\n\nPyth prices are published on Pythnet, and relayed to EVM chains using the [Wormhole Network](https://wormholenetwork.com/) as a cross-chain message passing bridge. The Wormhole Network observes when Pyth prices on Pythnet have changed and publishes an off-chain signed message attesting to this fact. This is explained in more detail [here](https://docs.wormholenetwork.com/wormhole/).\n\nThis signed message can then be submitted to the Pyth contract on the EVM networks along the required update fee for it, which will verify the Wormhole message and update the Pyth contract with the new price.\n\nPlease refer to [Pyth On-Demand Updates page](https://docs.pyth.network/consume-data/on-demand) for more information.\n\n## Solidity Target Chains\n\n[This](https://docs.pyth.network/consume-data/evm#networks) document contains list of the EVM networks that Pyth is available on.\n\nYou can find a list of available price feeds [here](https://pyth.network/developers/price-feed-ids/).\n\n## Mocking Pyth\n\n[MockPyth](./MockPyth.sol) is a mock contract that you can use and deploy locally to mock Pyth contract behaviour. To set and update price feeds you should call `updatePriceFeeds` and provide an array of encoded price feeds (the struct defined in [PythStructs](./PythStructs.sol)) as its argument. You can create encoded price feeds either by using web3.js or ethers ABI utilities or calling `createPriceFeedUpdateData` function in the mock contract.\n\n## Development\n\n### ABIs\n\nWhen making changes to a contract interface, please make sure to update the ABI files too. You can update it using `npm run generate-abi` and it will update the ABI files in [abis](./abis) directory. If you create a new contract, you also need to add the contract name in [the ABI generation script](./scripts/generateAbi.js#L5) so the script can create the ABI file for the new contract as well.\n\n### Releases\n\nWe use [Semantic Versioning](https://semver.org/) for our releases. In order to release a new version of this package and publish it to npm, follow these steps:\n\n1. Run `npm version <new version number> --no-git-tag-version`. This command will update the version of the package. Then push your changes to github.\n2. Once your change is merged into `main`, create a release with tag `v<new version number>` like `v1.5.2`, and a github action will automatically publish the new version of this package to npm.\n\n### pre-commit hooks\n\npre-commit is a tool that checks and fixes simple issues (formatting, ...) before each commit. You can install it by following [their website](https://pre-commit.com/). In order to enable checks for this repo run `pre-commit install` from command-line in the root of this repo.\n\nThe checks are also performed in the CI to ensure the code follows consistent formatting."
    }
  ]
}