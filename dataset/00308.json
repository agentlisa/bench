{
  "Title": "M-3: Orders on Optimism chains can not be settled due to revert of ````keep()````",
  "Content": "# Issue M-3: Orders on Optimism chains can not be settled due to revert of ````keep()```` \n\nSource: https://github.com/sherlock-audit/2024-02-perennial-v2-3-judging/issues/10 \n\n## Found by \nKingNFT\n## Summary\nAfter ````Ecotone```` upgrade, Optimism's ````OptGasInfo(\"0x420000000000000000000000000000000000000F\").scalar()```` function has been deprecated, which would cause ````Kept_Optimism```` contract  ````revert```` always.\n\nReference: https://docs.optimism.io/stack/transactions/fees#l1-data-fee\n\n## Vulnerability Detail\nThe issue arises on L29 of ````_calldataFee()```` function, as ```` OPT_GAS.scalar()```` would revert.\n\n```solidity\nFile: contracts\\attribute\\Kept\\Kept_Optimism.sol\n14: abstract contract Kept_Optimism is Kept {\n...\n16:     OptGasInfo constant OPT_GAS = OptGasInfo(0x420000000000000000000000000000000000000F);\n\n20:     function _calldataFee(\n...\n24:     ) internal view virtual override returns (UFixed18) {\n25:         return _fee(\n26:             OPT_GAS.getL1GasUsed(applicableCalldata),\n27:             multiplierCalldata,\n28:             bufferCalldata,\n29:             OPT_GAS.l1BaseFee() * OPT_GAS.scalar() / (10 ** OPT_GAS.decimals()) // @audit revert due to OPT_GAS.scalar()\n30:         );\n31:     }\n32: }\n\n```\n\nThe following PoC is built on both Optimism  and Base mainnet, we can see ```` OPT_GAS.scalar()```` reverts with ````GasPriceOracle: scalar() is deprecated```` message.\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"forge-std/Test.sol\";\n\ninterface OptGasInfo {\n    function scalar() external view returns (uint256);\n}\n\ncontract OptimismKeepFeeBug is Test {\n    uint256 constant BLOCK_HEIGHT = 12520000;//118120000; // Mar-30-2024 10:46:17 PM +UTC\n    string constant RPC_URL = \"https://mainnet.base.org\";//\"https://mainnet.optimism.io\";\n    OptGasInfo constant OPT_GAS = OptGasInfo(0x420000000000000000000000000000000000000F);\n\n    function setUp() public {\n        vm.createSelectFork(RPC_URL, BLOCK_HEIGHT);\n    }\n\n    function testOptGasInfoScalarCallRevert() public {\n        vm.expectRevert();\n        OPT_GAS.scalar();\n    }\n}\n```\n\nthe test log:\n```solidity\n2024-02-perennial-v2-3\\root> forge test --mc OptimismKeepFeeBug -vvvv\n[⠒] Compiling...\n[⠊] Compiling 1 files with 0.8.23Compiler run successful!\n[⠒] Compiling 1 files with 0.8.23\n[⠢] Solc 0.8.23 finished in 2.48s\n\nRunning 1 test for test/OptimismKeepFeeBug.t.sol:OptimismKeepFeeBug\n[PASS] testOptGasInfoScalarCallRevert() (gas: 13337)\nTraces:\n  [13337] OptimismKeepFeeBug::testOptGasInfoScalarCallRevert()\n    ├─ [0] VM::expectRevert(custom error f4844814:)\n    │   └─ ← ()\n    ├─ [7434] 0x420000000000000000000000000000000000000F::scalar() [staticcall]\n    │   ├─ [2436] 0xb528D11cC114E026F138fE568744c6D45ce6Da7A::scalar() [delegatecall]\n    │   │   └─ ← revert: GasPriceOracle: scalar() is deprecated\n    │   └─ ← revert: GasPriceOracle: scalar() is deprecated\n    └─ ← ()\n\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 842.07ms\n\nRan 1 test suites: 1 tests passed, 0 failed, 0 skipped (1 total tests)\n```\n## Impact\nOrders can not be settled, break of core functionality.\n\n## Code Snippet\nhttps://github.com/sherlock-audit/2024-02-perennial-v2-3/blob/main/root/contracts/attribute/Kept/Kept_Optimism.sol#L29\n\n## Tool used\n\nManual Review\n\n## Recommendation\nreference: https://docs.optimism.io/stack/transactions/fees#ecotone\n\n\n\n## Discussion\n\n**sherlock-admin4**\n\nThe protocol team fixed this issue in the following PRs/commits:\nhttps://github.com/equilibria-xyz/root/pull/90\n\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/254",
  "Code": [
    {
      "filename": "root/contracts/attribute/Kept/Kept_Optimism.sol",
      "content": "// SPDX-License-Identifier: Apache-2.0\npragma solidity ^0.8.13;\n\nimport \"./Kept.sol\";\n\ninterface OptGasInfo {\n    function getL1GasUsed(bytes memory) external view returns (uint256);\n    function l1BaseFee() external view returns (uint256);\n    function scalar() external view returns (uint256);\n    function decimals() external view returns (uint256);\n}\n\n/// @dev Optimism Kept implementation\nabstract contract Kept_Optimism is Kept {\n    // https://community.optimism.io/docs/developers/build/transaction-fees/#the-l1-data-fee\n    OptGasInfo constant OPT_GAS = OptGasInfo(0x420000000000000000000000000000000000000F);\n\n    // https://community.optimism.io/docs/developers/build/transaction-fees/#the-l1-data-fee\n    // Adds a buffer to the L1 gas used to account for the overhead of the transaction\n    function _calldataFee(\n        bytes memory applicableCalldata,\n        UFixed18 multiplierCalldata,\n        uint256 bufferCalldata\n    ) internal view virtual override returns (UFixed18) {\n        return _fee(\n            OPT_GAS.getL1GasUsed(applicableCalldata),\n            multiplierCalldata,\n            bufferCalldata,\n            OPT_GAS.l1BaseFee() * OPT_GAS.scalar() / (10 ** OPT_GAS.decimals())\n        );\n    }\n}"
    }
  ]
}