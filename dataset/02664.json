{
  "Title": "Incorrect math in slashing library comments",
  "Content": "In the [`SlashingLibrary`](https://github.com/UMAprotocol/protocol/blob/7938617bf79854811959eb605237edf6bdccbc90/packages/core/contracts/oracle/implementation/SlashingLibrary.sol) contract the functions [`calcWrongVoteSlashPerToken`](https://github.com/UMAprotocol/protocol/blob/7938617bf79854811959eb605237edf6bdccbc90/packages/core/contracts/oracle/implementation/SlashingLibrary.sol#L12) and [`calcNoVoteSlashPerToken`](https://github.com/UMAprotocol/protocol/blob/7938617bf79854811959eb605237edf6bdccbc90/packages/core/contracts/oracle/implementation/SlashingLibrary.sol#L44) are meant to return constants representing a slashing percentage per wrong vote or no vote that would counteract the 20% staking APY under the assumption of 120 yearly votes. Both functions contain commentary with an incorrect mathematical formula to counteract a 20% APY.\n\n\nMore specifically, the formula outlined in [the inline comments](https://github.com/UMAprotocol/protocol/blob/7938617bf79854811959eb605237edf6bdccbc90/packages/core/contracts/oracle/implementation/SlashingLibrary.sol#L17:L18)\n\n\n\n\n```\n0.2/(10*12)\n\n```\n\n\nuses basic interest instead of compound interest and assumes that a 20% increase will be negated with a subsequent 20% loss. However, the correct formula to counteract a 20% APY over 120 votes would be\n\n\n\n\n```\n 1 - (1 / 1.2)**(1/120)\n\n```\n\n\nWhile the current deviation between both values is negligible, applying the correct formula becomes crucially important for a higher APY and more yearly votes.\n\n\nConsider updating the documentation to include both the correct mathematical formula and an advisory to check the inequality\n\n\n\n\n```\n(1 + APY) * ( 1 - calcNoVoteSlashPerToken() )**expected_yearly_votes < 1\n\n```\n\n\nto prevent setting any incentives for staking without participating in votes.\n\n\n**Update:** *Fixed as of commit [`fed9d90bff9ec5052ced798e52ff36502f3cac1e`](https://github.com/UMAprotocol/protocol/pull/4066/commits/fed9d90bff9ec5052ced798e52ff36502f3cac1e) of [pull request #4066](https://github.com/UMAprotocol/protocol/pull/4066).*\n\n\n",
  "Impact": "MEDIUM",
  "Source": "",
  "Code": [
    {
      "filename": "packages/core/contracts/oracle/implementation/SlashingLibrary.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-only\npragma solidity ^0.8.0;\n\ncontract SlashingLibrary {\n    /**\n     * @notice Calculates the wrong vote slash per token.\n     * @param totalStaked The total amount of tokens staked.\n     * @param totalVotes The total amount of votes.\n     * @param totalCorrectVotes The total amount of correct votes.\n     * @return uint256 The amount of tokens to slash.\n     */\n    function calcWrongVoteSlashPerToken(\n        uint256 totalStaked,\n        uint256 totalVotes,\n        uint256 totalCorrectVotes\n    ) public pure returns (uint256) {\n        // This number is equal to the slash amount needed to cancel an APY of 20%\n        // if 10 votes are cast each month for a year. 0.2/(10*12)= ~0.0016\n        return 1600000000000000;\n    }\n\n    /**\n     * @notice Calculates the wrong vote slash per token for governance requests.\n     * @param totalStaked The total amount of tokens staked.\n     * @param totalVotes The total amount of votes.\n     * @param totalCorrectVotes The total amount of correct votes.\n     * @return uint256 The amount of tokens to slash.\n     */\n    function calcWrongVoteSlashPerTokenGovernance(\n        uint256 totalStaked,\n        uint256 totalVotes,\n        uint256 totalCorrectVotes\n    ) public pure returns (uint256) {\n        return 0;\n    }\n\n    /**\n     * @notice Calculates the no vote slash per token.\n     * @param totalStaked The total amount of tokens staked.\n     * @param totalVotes The total amount of votes.\n     * @param totalCorrectVotes The total amount of correct votes.\n     * @return uint256 The amount of tokens to slash.\n     */\n    function calcNoVoteSlashPerToken(\n        uint256 totalStaked,\n        uint256 totalVotes,\n        uint256 totalCorrectVotes\n    ) public pure returns (uint256) {\n        // This number is equal to the slash amount needed to cancel an APY of 20%\n        // if 10 votes are cast each month for a year. 0.2/(10*12)= ~0.0016\n        return 1600000000000000;\n    }\n\n    /**\n     * @notice Calculates all slashing trackers in one go to decrease cross-chain calls needed.\n     * @param totalStaked The total amount of tokens staked.\n     * @param totalVotes The total amount of votes.\n     * @param totalCorrectVotes The total amount of correct votes.\n     * @return  wrongVoteSlashPerToken The amount of tokens to slash for voting wrong.\n     * @return noVoteSlashPerToken The amount of tokens to slash for not voting.\n     */\n    function calcSlashing(\n        uint256 totalStaked,\n        uint256 totalVotes,\n        uint256 totalCorrectVotes,\n        bool isGovernance\n    ) public pure returns (uint256 wrongVoteSlashPerToken, uint256 noVoteSlashPerToken) {\n        return (\n            isGovernance\n                ? calcWrongVoteSlashPerTokenGovernance(totalStaked, totalVotes, totalCorrectVotes)\n                : calcWrongVoteSlashPerToken(totalStaked, totalVotes, totalCorrectVotes),\n            calcNoVoteSlashPerToken(totalStaked, totalVotes, totalCorrectVotes)\n        );\n    }\n}"
    }
  ]
}