{
  "Title": "[H03] Token transfers can silently fail",
  "Content": "**Update:** *Fixed in [pull request #69](https://github.com/endaoment/endaoment-contracts/pull/69).*\n\n\nThe [`finalizeGrant`](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Fund.sol#L119) function of the `Fund` contract and the  \n\n[`cashOutOrg`](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Org.sol#L91) function of the `Org` contract are both doing token `transfers` from the contract to some recipients.\n\n\nIn both cases, the `balanceOf(sender)` is not checked to be greater than `0` or greater or equal than the amount that is going to be transferred to the recipient.  \n\nMoreover, the returned values of the `transfer` methods, if present, are not checked.\n\n\nIf the transfer fails without reverting the transaction, [an event is emitted](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Org.sol#L96) or a [grant is erroneously marked as completed](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Fund.sol#L133).\n\n\nTo avoid finalizing grants without actually transferring tokens to the recipient organization, consider always checking the result of a token transfer and to validate first the amount to be transferred. This could also save some gas by not emitting unnecessary events.\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/Fund.sol",
      "content": "// SPDX-License-Identifier: BSD 3-Clause\n\npragma solidity ^0.6.10;\n\nimport \"./Administratable.sol\";\nimport \"./OrgFactory.sol\";\n\n// FUND CONTRACT\n/**\n * @title Fund\n * @author rheeger\n * @notice Fund is a contract that serves as an on-chain US Donor-Advised Fund.\n * It holds the proceeds of gifted cryptocurrency as ERC20 tokens, \n * and allows for the manager to submit Grant reccomendations to the contract. \n * The EndaomentAdmin can then chose to approve the Grant reccomendation, triggering\n * a SafeMath transfer of a 1% fee to the EndaomentAdmin and the remainder to the \n * recipient Org contract.\n */\ncontract Fund is Administratable {\n    using SafeMath for uint256;\n\n// ========== STATE VARIABLES ==========\n    struct Grant {\n        string description;\n        uint value;\n        address recipient;\n        bool complete;\n    }\n\n    address public manager;\n    address public admin;\n    mapping(address => bool) public contributors;\n    Grant[] public grants;\n    uint public totalContributors;\n\n// ========== CONSTRUCTOR ==========\n    /**\n    * @notice Create new Fund\n    * @param creator Address of the Fund's Primary Advisor\n    * @param adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    constructor (address creator, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.FUND_FACTORY){\n        require(creator != address(0));\n        manager = creator;\n    }\n\n// ========== Admin Management ==========\n    /**\n    * @notice Restricts method access to fund's manager\n    */\n    modifier restricted() {\n      require(msg.sender == manager);\n      _;\n    }\n\n// ========== Fund Management & Info ==========\n    /**\n    * @notice Change Fund Primary Advisor\n    * @param  newManager The address of the new PrimaryAdvisor.\n    * @param  adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    function changeManager (address newManager, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        manager = newManager;\n    }\n\n    /**\n    * @notice Checks recipient of a Grant is an address created by the OrgFactory \n    * @param  recipient The address of the Grant recipient.\n    * @param  orgFactoryContractAddress Address of the OrgFactory contract.\n    */\n    function checkRecipient(address recipient, address orgFactoryContractAddress) public view returns (bool) {\n        OrgFactory x = OrgFactory ( orgFactoryContractAddress );\n\n        return x.getAllowedOrg(recipient);\n    }\n\n    /**\n    * @notice Returns summary of details about the fund [tokenBalance, ethBlance, number of grants, managerAddress]. \n    * @param  tokenAddress The token address of the stablecoin being used by the web-server.\n    */\n    function getSummary(address tokenAddress) public view returns (uint, uint, uint, address) {\n        ERC20 t = ERC20(tokenAddress);\n        uint bal = t.balanceOf(address(this));\n\n        return (\n            bal,\n            address(this).balance,\n            grants.length,\n            manager\n        );\n    }\n\n    /**\n    * @notice Create new Grant Reccomendation\n    * @param  description The address of the Owner.\n    * @param  value The value of the grant in base units.\n    * @param  recipient The address of the recieving organization's contract.\n    * @param  orgFactoryContractAddress Address of the orgFactory Contract.\n    */\n    function createGrant(string memory description, uint256 value, address recipient, address orgFactoryContractAddress) public restricted {\n        require(checkRecipient(recipient, orgFactoryContractAddress) == true);\n\n        Grant memory newGrant = Grant({\n            description: description,\n            value: value,\n            recipient: recipient,\n            complete: false\n        });\n\n        grants.push(newGrant);\n    }\n\n    /**\n    * @notice Approve Grant Reccomendation\n    * @param  index This Grant's index position\n    * @param  tokenAddress The stablecoin's token address.\n    * @param  adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    function finalizeGrant(uint index, address tokenAddress, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ACCOUNTANT){\n        EndaomentAdmin endaomentAdmin = EndaomentAdmin(adminContractAddress);\n        admin = endaomentAdmin.getRoleAddress(IEndaomentAdmin.Role.ADMIN);\n        Grant storage grant = grants[index];\n        require(grant.complete == false);\n        ERC20 t = ERC20(tokenAddress);\n\n        //Process fees:\n        uint256 fee = (grant.value)/100;\n        uint256 finalGrant = (grant.value * 99)/100;\n        t.transfer(admin, fee);\n\n        t.transfer(grant.recipient, finalGrant);\n\n        grant.complete = true;\n    }\n\n    /**\n    * @notice Returns total number of grants submitted to the fund. \n    */\n    function getGrantsCount() public view returns (uint) {\n        return grants.length;\n    }\n}"
    },
    {
      "filename": "contracts/Org.sol",
      "content": "// SPDX-License-Identifier: BSD 3-Clause\n\npragma solidity ^0.6.10;\n\nimport \"./Administratable.sol\";\n\nimport \"@openzeppelin/contracts/token/ERC20/ERC20.sol\";\n\n//ORG CONTRACT\n/**\n * @title Org\n * @author rheeger\n * @notice Org is a contract that serves as a smart wallet for US nonprofit\n * organizations. It holds the organization's federal Tax ID number as taxID, \n * and allows for an address to submit a Claim struct to the contract whereby \n * the organization can direct recieved grant awards from Endaoment Funds.\n */\ncontract Org is Administratable {\n    using SafeMath for uint256;\n\n// ========== STATE VARIABLES ==========\n    \n    struct Claim {\n        string firstName;\n        string lastName;\n        string eMail;\n        address desiredWallet;\n        bool filesSubmitted;\n    }\n\n    uint public taxId;\n    address public orgWallet;\n    Claim[] public claims;\n    event cashOutComplete(uint cashOutAmount);\n\n\n// ========== CONSTRUCTOR ==========    \n    \n    /**\n    * @notice Create new Organization Contract\n    * @param ein The U.S. Tax Identification Number for the Organization\n    * @param adminContractAddress Contract Address for Endaoment Admin\n    */\n    constructor(uint ein, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ORG_FACTORY){\n        taxId = ein;\n    }\n\n// ========== Org Management & Info ==========\n    \n    /**\n     * @notice Create Organization Claim\n     * @param  fName First name of Administrator\n     * @param  lName Last name of Administrator\n     * @param  fSub Information Submitted successfully.\n     * @param  eMail Email contact for Organization Administrator.\n     * @param  orgAdminAddress Wallet address of Organization's Administrator.\n     */\n    function claimRequest(string memory fName, string memory lName, bool fSub, string memory eMail, address orgAdminAddress) public {\n        require (fSub == true);\n        require (msg.sender == orgAdminAddress);\n        \n        Claim memory newClaim = Claim({\n            firstName: fName,\n            lastName: lName,\n            eMail: eMail,\n            desiredWallet: msg.sender,\n            filesSubmitted: true\n        });\n\n        claims.push(newClaim);\n    }\n\n    /**\n     * @notice Approving Organization Claim \n     * @param  index Index value of Claim.\n     * @param  index Index value of Claim.\n     * @param adminContractAddress Contract Address for Endaoment Admin\n     */\n    function approveClaim(uint index, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        Claim storage claim = claims[index]; \n        \n        setOrgWallet(claim.desiredWallet, adminContractAddress);\n    }\n\n    /**\n     * @notice Cashing out Organization Contract \n     * @param  desiredWithdrawlAddress Destination for withdrawl\n     * @param tokenAddress Stablecoin address of desired token withdrawl\n     * @param adminContractAddress Contract Address for Endaoment Admin\n     */\n    function cashOutOrg(address desiredWithdrawlAddress, address tokenAddress, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ACCOUNTANT){\n        ERC20 token = ERC20(tokenAddress);\n        uint256 cashOutAmount = token.balanceOf(address(this));\n\n        token.transfer(desiredWithdrawlAddress, cashOutAmount);\n        emit cashOutComplete(cashOutAmount);\n    }\n\n    function setOrgWallet(address providedWallet, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        orgWallet = providedWallet;\n    }\n\n     function getTokenBalance(address tokenAddress) public view returns (uint) {\n            ERC20 t = ERC20(tokenAddress);\n            uint256 bal = t.balanceOf(address(this));\n\n        return bal;\n     }\n\n       function getClaimsCount() public view returns (uint) {\n        return claims.length;\n    }\n\n}"
    },
    {
      "filename": "contracts/Org.sol",
      "content": "// SPDX-License-Identifier: BSD 3-Clause\n\npragma solidity ^0.6.10;\n\nimport \"./Administratable.sol\";\n\nimport \"@openzeppelin/contracts/token/ERC20/ERC20.sol\";\n\n//ORG CONTRACT\n/**\n * @title Org\n * @author rheeger\n * @notice Org is a contract that serves as a smart wallet for US nonprofit\n * organizations. It holds the organization's federal Tax ID number as taxID, \n * and allows for an address to submit a Claim struct to the contract whereby \n * the organization can direct recieved grant awards from Endaoment Funds.\n */\ncontract Org is Administratable {\n    using SafeMath for uint256;\n\n// ========== STATE VARIABLES ==========\n    \n    struct Claim {\n        string firstName;\n        string lastName;\n        string eMail;\n        address desiredWallet;\n        bool filesSubmitted;\n    }\n\n    uint public taxId;\n    address public orgWallet;\n    Claim[] public claims;\n    event cashOutComplete(uint cashOutAmount);\n\n\n// ========== CONSTRUCTOR ==========    \n    \n    /**\n    * @notice Create new Organization Contract\n    * @param ein The U.S. Tax Identification Number for the Organization\n    * @param adminContractAddress Contract Address for Endaoment Admin\n    */\n    constructor(uint ein, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ORG_FACTORY){\n        taxId = ein;\n    }\n\n// ========== Org Management & Info ==========\n    \n    /**\n     * @notice Create Organization Claim\n     * @param  fName First name of Administrator\n     * @param  lName Last name of Administrator\n     * @param  fSub Information Submitted successfully.\n     * @param  eMail Email contact for Organization Administrator.\n     * @param  orgAdminAddress Wallet address of Organization's Administrator.\n     */\n    function claimRequest(string memory fName, string memory lName, bool fSub, string memory eMail, address orgAdminAddress) public {\n        require (fSub == true);\n        require (msg.sender == orgAdminAddress);\n        \n        Claim memory newClaim = Claim({\n            firstName: fName,\n            lastName: lName,\n            eMail: eMail,\n            desiredWallet: msg.sender,\n            filesSubmitted: true\n        });\n\n        claims.push(newClaim);\n    }\n\n    /**\n     * @notice Approving Organization Claim \n     * @param  index Index value of Claim.\n     * @param  index Index value of Claim.\n     * @param adminContractAddress Contract Address for Endaoment Admin\n     */\n    function approveClaim(uint index, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        Claim storage claim = claims[index]; \n        \n        setOrgWallet(claim.desiredWallet, adminContractAddress);\n    }\n\n    /**\n     * @notice Cashing out Organization Contract \n     * @param  desiredWithdrawlAddress Destination for withdrawl\n     * @param tokenAddress Stablecoin address of desired token withdrawl\n     * @param adminContractAddress Contract Address for Endaoment Admin\n     */\n    function cashOutOrg(address desiredWithdrawlAddress, address tokenAddress, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ACCOUNTANT){\n        ERC20 token = ERC20(tokenAddress);\n        uint256 cashOutAmount = token.balanceOf(address(this));\n\n        token.transfer(desiredWithdrawlAddress, cashOutAmount);\n        emit cashOutComplete(cashOutAmount);\n    }\n\n    function setOrgWallet(address providedWallet, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        orgWallet = providedWallet;\n    }\n\n     function getTokenBalance(address tokenAddress) public view returns (uint) {\n            ERC20 t = ERC20(tokenAddress);\n            uint256 bal = t.balanceOf(address(this));\n\n        return bal;\n     }\n\n       function getClaimsCount() public view returns (uint) {\n        return claims.length;\n    }\n\n}"
    }
  ]
}