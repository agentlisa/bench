{
  "Title": "[L03] Core contract cannot allocate all Tribe tokens",
  "Content": "The function [`allocateTribe`](https://github.com/fei-protocol/fei-protocol-core/blob/29aeefddd97f31c7f2a598fb3dca3ef24dc0beb4/contracts/core/Core.sol#L39) in the [`Core` contract](https://github.com/fei-protocol/fei-protocol-core/blob/29aeefddd97f31c7f2a598fb3dca3ef24dc0beb4/contracts/core/Core.sol) is used to distribute `TRIBE` tokens to specified addresses. A percentage of `TRIBE` tokens remains undistributed as a treasury. According to the Fei whitepaper, *the community can distribute this as it sees fit as the protocol develops.*\n\n\nHowever, in the allocation process, the function [requires](https://github.com/fei-protocol/fei-protocol-core/blob/29aeefddd97f31c7f2a598fb3dca3ef24dc0beb4/contracts/core/Core.sol#L41) that the amount to be distributed is *strictly* less than the contractâ€™s `TRIBE` balance. This means that the contract cannot allocate all of the `TRIBE` tokens it holds, and a single unit of `TRIBE` will be locked in the contract.\n\n\nConsider changing the [require statement](https://github.com/fei-protocol/fei-protocol-core/blob/29aeefddd97f31c7f2a598fb3dca3ef24dc0beb4/contracts/core/Core.sol#L41) to use >= instead of >, so that all of the `TRIBE` it holds can be allocated.\n\n\n**Update:** *Fixed in [PR#33](https://github.com/fei-protocol/fei-protocol-core/pull/33).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/core/Core.sol",
      "content": "pragma solidity ^0.6.0;\npragma experimental ABIEncoderV2;\n\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"./Permissions.sol\";\nimport \"./ICore.sol\";\nimport \"../token/IFei.sol\";\nimport \"../token/Fei.sol\";\nimport \"../dao/Tribe.sol\";\n\n/// @title ICore implementation\n/// @author Fei Protocol\ncontract Core is ICore, Permissions {\n\n\tIFei public override fei;\n\tIERC20 public override tribe;\n\n\taddress public override genesisGroup;\n\tbool public override hasGenesisGroupCompleted;\n\n\tconstructor() public {\n\t\t_setupGovernor(msg.sender);\n\t\tFei _fei = new Fei(address(this));\n\t\tfei = IFei(address(_fei));\n\n\t\tTribe _tribe = new Tribe(address(this), msg.sender);\n\t\ttribe = IERC20(address(_tribe));\n\t}\n\n\tfunction setFei(address token) external override onlyGovernor {\n\t\tfei = IFei(token);\n\t\temit FeiUpdate(token);\n\t}\n\n\tfunction setGenesisGroup(address _genesisGroup) external override onlyGovernor {\n\t\tgenesisGroup = _genesisGroup;\n\t}\n\n\tfunction allocateTribe(address to, uint amount) external override onlyGovernor {\n\t\tIERC20 _tribe = tribe;\n\t\trequire(_tribe.balanceOf(address(this)) > amount, \"Core: Not enough Tribe\");\n\n\t\t_tribe.transfer(to, amount);\n\n\t\temit TribeAllocation(to, amount);\n\t}\n\n\tfunction completeGenesisGroup() external override {\n\t\trequire(!hasGenesisGroupCompleted, \"Core: Genesis Group already complete\");\n\t\trequire(msg.sender == genesisGroup, \"Core: Caller is not Genesis Group\");\n\n\t\thasGenesisGroupCompleted = true;\n\n\t\t// solhint-disable-next-line not-rely-on-time\n\t\temit GenesisPeriodComplete(now);\n\t}\n}"
    },
    {
      "filename": "contracts/core/Core.sol",
      "content": "pragma solidity ^0.6.0;\npragma experimental ABIEncoderV2;\n\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"./Permissions.sol\";\nimport \"./ICore.sol\";\nimport \"../token/IFei.sol\";\nimport \"../token/Fei.sol\";\nimport \"../dao/Tribe.sol\";\n\n/// @title ICore implementation\n/// @author Fei Protocol\ncontract Core is ICore, Permissions {\n\n\tIFei public override fei;\n\tIERC20 public override tribe;\n\n\taddress public override genesisGroup;\n\tbool public override hasGenesisGroupCompleted;\n\n\tconstructor() public {\n\t\t_setupGovernor(msg.sender);\n\t\tFei _fei = new Fei(address(this));\n\t\tfei = IFei(address(_fei));\n\n\t\tTribe _tribe = new Tribe(address(this), msg.sender);\n\t\ttribe = IERC20(address(_tribe));\n\t}\n\n\tfunction setFei(address token) external override onlyGovernor {\n\t\tfei = IFei(token);\n\t\temit FeiUpdate(token);\n\t}\n\n\tfunction setGenesisGroup(address _genesisGroup) external override onlyGovernor {\n\t\tgenesisGroup = _genesisGroup;\n\t}\n\n\tfunction allocateTribe(address to, uint amount) external override onlyGovernor {\n\t\tIERC20 _tribe = tribe;\n\t\trequire(_tribe.balanceOf(address(this)) > amount, \"Core: Not enough Tribe\");\n\n\t\t_tribe.transfer(to, amount);\n\n\t\temit TribeAllocation(to, amount);\n\t}\n\n\tfunction completeGenesisGroup() external override {\n\t\trequire(!hasGenesisGroupCompleted, \"Core: Genesis Group already complete\");\n\t\trequire(msg.sender == genesisGroup, \"Core: Caller is not Genesis Group\");\n\n\t\thasGenesisGroupCompleted = true;\n\n\t\t// solhint-disable-next-line not-rely-on-time\n\t\temit GenesisPeriodComplete(now);\n\t}\n}"
    },
    {
      "filename": "contracts/core/Core.sol",
      "content": "pragma solidity ^0.6.0;\npragma experimental ABIEncoderV2;\n\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"./Permissions.sol\";\nimport \"./ICore.sol\";\nimport \"../token/IFei.sol\";\nimport \"../token/Fei.sol\";\nimport \"../dao/Tribe.sol\";\n\n/// @title ICore implementation\n/// @author Fei Protocol\ncontract Core is ICore, Permissions {\n\n\tIFei public override fei;\n\tIERC20 public override tribe;\n\n\taddress public override genesisGroup;\n\tbool public override hasGenesisGroupCompleted;\n\n\tconstructor() public {\n\t\t_setupGovernor(msg.sender);\n\t\tFei _fei = new Fei(address(this));\n\t\tfei = IFei(address(_fei));\n\n\t\tTribe _tribe = new Tribe(address(this), msg.sender);\n\t\ttribe = IERC20(address(_tribe));\n\t}\n\n\tfunction setFei(address token) external override onlyGovernor {\n\t\tfei = IFei(token);\n\t\temit FeiUpdate(token);\n\t}\n\n\tfunction setGenesisGroup(address _genesisGroup) external override onlyGovernor {\n\t\tgenesisGroup = _genesisGroup;\n\t}\n\n\tfunction allocateTribe(address to, uint amount) external override onlyGovernor {\n\t\tIERC20 _tribe = tribe;\n\t\trequire(_tribe.balanceOf(address(this)) > amount, \"Core: Not enough Tribe\");\n\n\t\t_tribe.transfer(to, amount);\n\n\t\temit TribeAllocation(to, amount);\n\t}\n\n\tfunction completeGenesisGroup() external override {\n\t\trequire(!hasGenesisGroupCompleted, \"Core: Genesis Group already complete\");\n\t\trequire(msg.sender == genesisGroup, \"Core: Caller is not Genesis Group\");\n\n\t\thasGenesisGroupCompleted = true;\n\n\t\t// solhint-disable-next-line not-rely-on-time\n\t\temit GenesisPeriodComplete(now);\n\t}\n}"
    }
  ]
}