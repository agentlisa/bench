{
  "Title": "Invalid depositary add/remove logic",
  "Content": "##### Description\nAt lines https://github.com/bondappetit/bondappetit-protocol/blob/88680691fe8d872c5fc26e9500d19cf7caaa9861/contracts/depositary/AgregateDepositaryBalanceView.sol#L49, https://github.com/bondappetit/bondappetit-protocol/blob/88680691fe8d872c5fc26e9500d19cf7caaa9861/contracts/depositary/AgregateDepositaryBalanceView.sol#L62 are defined functions to add or remove depositaries, `depositariesIndex` map contains depositary indexes added to `depositaries` array. At line https://github.com/bondappetit/bondappetit-protocol/blob/88680691fe8d872c5fc26e9500d19cf7caaa9861/contracts/depositary/AgregateDepositaryBalanceView.sol#L50 contract requires that `depositariesIndex[depositary] == 0`, that check allow to add already added depositary that have `0` index. Same error at line https://github.com/bondappetit/bondappetit-protocol/blob/88680691fe8d872c5fc26e9500d19cf7caaa9861/contracts/depositary/AgregateDepositaryBalanceView.sol#L64 that don't allow to remove depositary that have index `0`\n\n##### Recommendation\nWe recommend to remaster depositary existing check \n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/depositary/AgregateDepositaryBalanceView.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.6.0;\n\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\nimport \"../utils/OwnablePausable.sol\";\nimport \"./IDepositaryBalanceView.sol\";\n\ncontract AgregateDepositaryBalanceView is IDepositaryBalanceView, OwnablePausable {\n    using SafeMath for uint256;\n\n    /// @notice The number of depositaries in agregate.\n    uint256 public maxSize;\n\n    /// @notice Decimals balance.\n    uint256 public override decimals;\n\n    /// @notice Depositaries in agregate.\n    IDepositaryBalanceView[] public depositaries;\n\n    /// @dev Depositaries index.\n    mapping(address => uint256) internal depositariesIndex;\n\n    /// @notice An event thats emitted when an new depositary added to agregate.\n    event DepositaryAdded(address depositary);\n\n    /// @notice An event thats emitted when an depositary removed from agregate.\n    event DepositaryRemoved(address depositary);\n\n    /**\n     * @param _decimals Decimals balance.\n     * @param _maxSize Max number depositaries in agregate.\n     */\n    constructor(uint256 _decimals, uint256 _maxSize) public {\n        decimals = _decimals;\n        maxSize = _maxSize;\n    }\n\n    /**\n     * @return Depositaries count of agregate.\n     */\n    function size() public view returns (uint256) {\n        return depositaries.length;\n    }\n\n    /**\n     * @notice Add depositary address to agregate.\n     * @param depositary Added depositary address.\n     */\n    function addDepositary(address depositary) external onlyOwner {\n        require(depositariesIndex[depositary] == 0, \"AgregateDepositaryBalanceView::addDepositary: depositary already added\");\n        require(size() < maxSize, \"AgregateDepositaryBalanceView::addDepositary: too many depositaries\");\n\n        depositaries.push(IDepositaryBalanceView(depositary));\n        depositariesIndex[depositary] = size().sub(1);\n        emit DepositaryAdded(depositary);\n    }\n\n    /**\n     * @notice Removed depositary address from agregate.\n     * @param depositary Removed depositary address.\n     */\n    function removeDepositary(address depositary) external onlyOwner {\n        uint256 depositaryIndex = depositariesIndex[depositary];\n        require(depositaryIndex != 0, \"AgregateDepositaryBalanceView::removeDepositary: depositary already removed\");\n\n        delete depositariesIndex[depositary];\n        depositaries[depositaryIndex] = depositaries[size().sub(1)];\n        delete depositaries[size().sub(1)];\n        emit DepositaryRemoved(depositary);\n    }\n\n    /**\n     * @return Allowed depositaries list.\n     */\n    function allowedDepositaries() external view returns (address[] memory) {\n        address[] memory result = new address[](size());\n\n        for (uint256 i = 0; i < size(); i++) {\n            result[i] = address(depositaries[i]);\n        }\n\n        return result;\n    }\n\n    function balance() external view override returns (uint256) {\n        uint256 result;\n\n        for (uint256 i = 0; i < size(); i++) {\n            uint256 depositaryBalance = depositaries[i].balance();\n            uint256 depositaryDecimals = depositaries[i].decimals();\n            uint256 decimalsPower = decimals.sub(depositaryDecimals);\n            result = result.add(depositaryBalance.mul(10**decimalsPower));\n        }\n\n        return result;\n    }\n}"
    }
  ]
}