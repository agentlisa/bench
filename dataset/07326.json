{
  "Title": "[G-06] Can be removed to `assert` in function `_setImplementation`",
  "Content": "\nThe state variable `_IMPLEMENTATION_SLOT` constant is precomputed `keccak256(\"biconomy.scw.proxy.implementation\") - 1`. The assert check here is unnecessary. Removing this control provides gas optimization.\n\n```diff\ncontracts\\smart-contract-wallet\\common\\Singleton.sol:\n  12     function _setImplementation(address _imp) internal {\n- 13:         assert(_IMPLEMENTATION_SLOT == bytes32(uint256(keccak256(\"biconomy.scw.proxy.implementation\")) - 1));\n  14         // solhint-disable-next-line no-inline-assembly\n  15         assembly {\n  16           sstore(_IMPLEMENTATION_SLOT, _imp)\n  17          }\n  18     }\n```\nhttps://github.com/code-423n4/2023-01-biconomy/blob/main/scw-contracts/contracts/smart-contract-wallet/common/Singleton.sol#L13\n\n### Proof of Concept\nThe optimizer was turned on and set to 200 runs test was done in 0.8.12\n\n```solidity\ncontract GasTest is DSTest {\n    \n    Contract0 c0;\n    Contract1 c1;\n    \n    function setUp() public {\n        c0 = new Contract0();\n        c1 = new Contract1();\n    }\n    \n    function testGas() public {\n        c0._setImplementation(0xAb8483F64d9C6d1EcF9b849Ae677dD3315835cb2);\n        c1._setImplementation(0xAb8483F64d9C6d1EcF9b849Ae677dD3315835cb2);\n    }\n}\n\ncontract Contract0 {\n    // singleton slot always needs to be first declared variable, to ensure that it is at the same location as in the Proxy contract.\n\n    /* This is the keccak-256 hash of \"biconomy.scw.proxy.implementation\" subtracted by 1 */\n    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x37722d148fb373b961a84120b6c8d209709b45377878a466db32bbc40d95af26;\n\n    function _setImplementation(address _imp) public {\n        assert(_IMPLEMENTATION_SLOT == bytes32(uint256(keccak256(\"biconomy.scw.proxy.implementation\")) - 1));\n        // solhint-disable-next-line no-inline-assembly\n        assembly {\n          sstore(_IMPLEMENTATION_SLOT, _imp)\n         }\n    }\n}\n\ncontract Contract1 {\n    // singleton slot always needs to be first declared variable, to ensure that it is at the same location as in the Proxy contract.\n\n    /* This is the keccak-256 hash of \"biconomy.scw.proxy.implementation\" subtracted by 1 */\n    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x37722d148fb373b961a84120b6c8d209709b45377878a466db32bbc40d95af26;\n    \n    function _setImplementation(address _imp) public {\n        \n        assembly {\n            sstore(_IMPLEMENTATION_SLOT, _imp)\n        }\n    }\n}\n```\n### Gas Report\n```js\n╭──────────────────────────────────────┬─────────────────┬───────┬────────┬───────┬─────────╮\n│ src/test/test.sol:Contract0 contract ┆                 ┆       ┆        ┆       ┆         │\n╞══════════════════════════════════════╪═════════════════╪═══════╪════════╪═══════╪═════════╡\n│ Deployment Cost                      ┆ Deployment Size ┆       ┆        ┆       ┆         │\n├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤\n│ 71123                                ┆ 387             ┆       ┆        ┆       ┆         │\n├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤\n│ Function Name                        ┆ min             ┆ avg   ┆ median ┆ max   ┆ # calls │\n├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤\n│ _setImplementation                   ┆ 22435           ┆ 22435 ┆ 22435  ┆ 22435 ┆ 1       │\n╰──────────────────────────────────────┴─────────────────┴───────┴────────┴───────┴─────────╯\n╭──────────────────────────────────────┬─────────────────┬───────┬────────┬───────┬─────────╮\n│ src/test/test.sol:Contract1 contract ┆                 ┆       ┆        ┆       ┆         │\n╞══════════════════════════════════════╪═════════════════╪═══════╪════════╪═══════╪═════════╡\n│ Deployment Cost                      ┆ Deployment Size ┆       ┆        ┆       ┆         │\n├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤\n│ 38893                                ┆ 225             ┆       ┆        ┆       ┆         │\n├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤\n│ Function Name                        ┆ min             ┆ avg   ┆ median ┆ max   ┆ # calls │\n├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤\n│ _setImplementation                   ┆ 22336           ┆ 22336 ┆ 22336  ┆ 22336 ┆ 1       │\n╰──────────────────────────────────────┴─────────────────┴───────┴────────┴───────┴─────────╯\n```\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/contests/2023-01-biconomy-smart-contract-wallet-contest",
  "Code": [
    {
      "filename": "scw-contracts/contracts/smart-contract-wallet/common/Singleton.sol",
      "content": "// SPDX-License-Identifier: LGPL-3.0-only\npragma solidity 0.8.12;\n\n/// @title Singleton - Base for singleton contracts (should always be first super contract)\n///         This contract is tightly coupled to the proxy contract\ncontract Singleton {\n    // singleton slot always needs to be first declared variable, to ensure that it is at the same location as in the Proxy contract.\n\n    /* This is the keccak-256 hash of \"biconomy.scw.proxy.implementation\" subtracted by 1 */\n    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x37722d148fb373b961a84120b6c8d209709b45377878a466db32bbc40d95af26;\n\n    function _setImplementation(address _imp) internal {\n        assert(_IMPLEMENTATION_SLOT == bytes32(uint256(keccak256(\"biconomy.scw.proxy.implementation\")) - 1));\n        // solhint-disable-next-line no-inline-assembly\n        assembly {\n          sstore(_IMPLEMENTATION_SLOT, _imp)\n         }\n    }\n\n    function _getImplementation() internal view returns (address _imp) {\n        // solhint-disable-next-line no-inline-assembly\n        assembly {\n         _imp := sload(_IMPLEMENTATION_SLOT)\n        }\n    }\n\n}"
    }
  ]
}