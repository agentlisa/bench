{
  "Title": "[L10][Fixed] String is used as hash key",
  "Content": "The [`AddressBook` contract](https://github.com/opynfinance/GammaProtocol/blob/d151621b33134789b29dc78eb89dad2b557b25b9/contracts/AddressBook.sol#L13) keeps a record of all the current contracts in the Protocol so other contracts can make use of them.\n\n\nThe `AddressBook` contract [defines several `bytes32` constants](https://github.com/opynfinance/GammaProtocol/blob/d151621b33134789b29dc78eb89dad2b557b25b9/contracts/AddressBook.sol#L15-L29) for each one of the contracts, and then it uses those constants as key for the [`addresses` mapping](https://github.com/opynfinance/GammaProtocol/blob/d151621b33134789b29dc78eb89dad2b557b25b9/contracts/AddressBook.sol#L32), which goes from `bytes32` to the respective contractâ€™s address.\n\n\nHowever, these constants are set directly as a string with an implicit casting into a `bytes32` variable type. Furthermore, although the length of these strings is short enough to fit in a `bytes32` variable, in the future a new part of the Protocol could be added and its name may not fit under such type.\n\n\nIt is frequent to use the hashed version of the string as the key instead of the string itself because its length will always fit under a `bytes32` variable.\n\n\nConsider using the hashed version of the string instead of the direct string as the key for the `addresses` mapping.\n\n\n**Update:** *Fixed in [PR#295](https://github.com/opynfinance/GammaProtocol/pull/295).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/AddressBook.sol",
      "content": "/**\n * SPDX-License-Identifier: UNLICENSED\n */\npragma solidity 0.6.10;\n\nimport {Ownable} from \"./packages/oz/Ownable.sol\";\nimport {OwnedUpgradeabilityProxy} from \"./packages/oz/upgradeability/OwnedUpgradeabilityProxy.sol\";\n\n/**\n * @author Opyn Team\n * @title AddressBook Module\n */\ncontract AddressBook is Ownable {\n    /// @dev Otoken implementation key\n    bytes32 private constant OTOKEN_IMPL = \"OTOKEN_IMPL\";\n    /// @dev OtokenFactory key\n    bytes32 private constant OTOKEN_FACTORY = \"OTOKEN_FACTORY\";\n    /// @dev Whitelist key\n    bytes32 private constant WHITELIST = \"WHITELIST\";\n    /// @dev Controller key\n    bytes32 private constant CONTROLLER = \"CONTROLLER\";\n    /// @dev MarginPool key\n    bytes32 private constant MARGIN_POOL = \"MARGIN_POOL\";\n    /// @dev MarginCalculator key\n    bytes32 private constant MARGIN_CALCULATOR = \"MARGIN_CALCULATOR\";\n    /// @dev LiquidationManager key\n    bytes32 private constant LIQUIDATION_MANAGER = \"LIQUIDATION_MANAGER\";\n    /// @dev Oracle key\n    bytes32 private constant ORACLE = \"ORACLE\";\n\n    /// @dev mapping between key and address\n    mapping(bytes32 => address) private addresses;\n\n    /// @notice emits an event when a new proxy is created\n    event ProxyCreated(bytes32 id, address proxy);\n    /// @notice emits an event when a new address is added\n    event AddressAdded(bytes32 id, address add);\n\n    /**\n     * @notice return Otoken implementation address\n     * @return Otoken implementation address\n     */\n    function getOtokenImpl() external view returns (address) {\n        return getAddress(OTOKEN_IMPL);\n    }\n\n    /**\n     * @notice return oTokenFactory address\n     * @return OtokenFactory address\n     */\n    function getOtokenFactory() external view returns (address) {\n        return getAddress(OTOKEN_FACTORY);\n    }\n\n    /**\n     * @notice return Whitelist address\n     * @return Whitelist address\n     */\n    function getWhitelist() external view returns (address) {\n        return getAddress(WHITELIST);\n    }\n\n    /**\n     * @notice return Controller address\n     * @return Controller address\n     */\n    function getController() external view returns (address) {\n        return getAddress(CONTROLLER);\n    }\n\n    /**\n     * @notice return MarginPool address\n     * @return MarginPool address\n     */\n    function getMarginPool() external view returns (address) {\n        return getAddress(MARGIN_POOL);\n    }\n\n    /**\n     * @notice return MarginCalculator address\n     * @return MarginCalculator address\n     */\n    function getMarginCalculator() external view returns (address) {\n        return getAddress(MARGIN_CALCULATOR);\n    }\n\n    /**\n     * @notice return LiquidationManager address\n     * @return LiquidationManager address\n     */\n    function getLiquidationManager() external view returns (address) {\n        return getAddress(LIQUIDATION_MANAGER);\n    }\n\n    /**\n     * @notice return Oracle address\n     * @return Oracle address\n     */\n    function getOracle() external view returns (address) {\n        return getAddress(ORACLE);\n    }\n\n    /**\n     * @notice set Otoken implementation address\n     * @dev can only be called by the addressbook owner\n     * @param _otokenImpl Otoken implementation address\n     */\n    function setOtokenImpl(address _otokenImpl) external onlyOwner {\n        setAddress(OTOKEN_IMPL, _otokenImpl);\n    }\n\n    /**\n     * @notice set OtokenFactory address\n     * @dev can only be called by the addressbook owner\n     * @param _otokenFactory OtokenFactory address\n     */\n    function setOtokenFactory(address _otokenFactory) external onlyOwner {\n        setAddress(OTOKEN_FACTORY, _otokenFactory);\n    }\n\n    /**\n     * @notice set Whitelist address\n     * @dev can only be called by the addressbook owner\n     * @param _whitelist Whitelist address\n     */\n    function setWhitelist(address _whitelist) external onlyOwner {\n        setAddress(WHITELIST, _whitelist);\n    }\n\n    /**\n     * @notice set Controller address\n     * @dev can only be called by the addressbook owner\n     * @param _controller Controller address\n     */\n    function setController(address _controller) external onlyOwner {\n        updateImpl(CONTROLLER, _controller);\n    }\n\n    /**\n     * @notice set MarginPool address\n     * @dev can only be called by the addressbook owner\n     * @param _marginPool MarginPool address\n     */\n    function setMarginPool(address _marginPool) external onlyOwner {\n        setAddress(MARGIN_POOL, _marginPool);\n    }\n\n    /**\n     * @notice set MarginCalculator address\n     * @dev can only be called by the addressbook owner\n     * @param _marginCalculator MarginCalculator address\n     */\n    function setMarginCalculator(address _marginCalculator) external onlyOwner {\n        setAddress(MARGIN_CALCULATOR, _marginCalculator);\n    }\n\n    /**\n     * @notice set LiquidationManager address\n     * @dev can only be called by the addressbook owner\n     * @param _liquidationManager LiquidationManager address\n     */\n    function setLiquidationManager(address _liquidationManager) external onlyOwner {\n        setAddress(LIQUIDATION_MANAGER, _liquidationManager);\n    }\n\n    /**\n     * @notice set Oracle address\n     * @dev can only be called by the addressbook owner\n     * @param _oracle Oracle address\n     */\n    function setOracle(address _oracle) external onlyOwner {\n        setAddress(ORACLE, _oracle);\n    }\n\n    /**\n     * @notice return an address for specific key\n     * @param _key key address\n     * @return address\n     */\n    function getAddress(bytes32 _key) public view returns (address) {\n        return addresses[_key];\n    }\n\n    /**\n     * @notice set a specific address for a specific key\n     * @dev can only be called by the addressbook owner\n     * @param _key key\n     * @param _address address\n     */\n    function setAddress(bytes32 _key, address _address) public onlyOwner {\n        addresses[_key] = _address;\n\n        emit AddressAdded(_key, _address);\n    }\n\n    /**\n     * @dev internal function to update the implementation of a specific component of the protocol\n     * @param _id id of the contract to be updated\n     * @param _newAddress address of the new implementation\n     **/\n    function updateImpl(bytes32 _id, address _newAddress) public onlyOwner {\n        address payable proxyAddress = address(uint160(getAddress(_id)));\n\n        bytes memory params = abi.encodeWithSignature(\"initialize(address,address)\", address(this), owner());\n\n        if (proxyAddress == address(0)) {\n            OwnedUpgradeabilityProxy proxy = new OwnedUpgradeabilityProxy();\n            setAddress(_id, address(proxy));\n            emit ProxyCreated(_id, address(proxy));\n            proxy.upgradeToAndCall(_newAddress, params);\n        } else {\n            OwnedUpgradeabilityProxy proxy = OwnedUpgradeabilityProxy(proxyAddress);\n            proxy.upgradeTo(_newAddress);\n        }\n    }\n}"
    },
    {
      "filename": "contracts/AddressBook.sol",
      "content": "/**\n * SPDX-License-Identifier: UNLICENSED\n */\npragma solidity 0.6.10;\n\nimport {Ownable} from \"./packages/oz/Ownable.sol\";\nimport {OwnedUpgradeabilityProxy} from \"./packages/oz/upgradeability/OwnedUpgradeabilityProxy.sol\";\n\n/**\n * @author Opyn Team\n * @title AddressBook Module\n */\ncontract AddressBook is Ownable {\n    /// @dev Otoken implementation key\n    bytes32 private constant OTOKEN_IMPL = \"OTOKEN_IMPL\";\n    /// @dev OtokenFactory key\n    bytes32 private constant OTOKEN_FACTORY = \"OTOKEN_FACTORY\";\n    /// @dev Whitelist key\n    bytes32 private constant WHITELIST = \"WHITELIST\";\n    /// @dev Controller key\n    bytes32 private constant CONTROLLER = \"CONTROLLER\";\n    /// @dev MarginPool key\n    bytes32 private constant MARGIN_POOL = \"MARGIN_POOL\";\n    /// @dev MarginCalculator key\n    bytes32 private constant MARGIN_CALCULATOR = \"MARGIN_CALCULATOR\";\n    /// @dev LiquidationManager key\n    bytes32 private constant LIQUIDATION_MANAGER = \"LIQUIDATION_MANAGER\";\n    /// @dev Oracle key\n    bytes32 private constant ORACLE = \"ORACLE\";\n\n    /// @dev mapping between key and address\n    mapping(bytes32 => address) private addresses;\n\n    /// @notice emits an event when a new proxy is created\n    event ProxyCreated(bytes32 id, address proxy);\n    /// @notice emits an event when a new address is added\n    event AddressAdded(bytes32 id, address add);\n\n    /**\n     * @notice return Otoken implementation address\n     * @return Otoken implementation address\n     */\n    function getOtokenImpl() external view returns (address) {\n        return getAddress(OTOKEN_IMPL);\n    }\n\n    /**\n     * @notice return oTokenFactory address\n     * @return OtokenFactory address\n     */\n    function getOtokenFactory() external view returns (address) {\n        return getAddress(OTOKEN_FACTORY);\n    }\n\n    /**\n     * @notice return Whitelist address\n     * @return Whitelist address\n     */\n    function getWhitelist() external view returns (address) {\n        return getAddress(WHITELIST);\n    }\n\n    /**\n     * @notice return Controller address\n     * @return Controller address\n     */\n    function getController() external view returns (address) {\n        return getAddress(CONTROLLER);\n    }\n\n    /**\n     * @notice return MarginPool address\n     * @return MarginPool address\n     */\n    function getMarginPool() external view returns (address) {\n        return getAddress(MARGIN_POOL);\n    }\n\n    /**\n     * @notice return MarginCalculator address\n     * @return MarginCalculator address\n     */\n    function getMarginCalculator() external view returns (address) {\n        return getAddress(MARGIN_CALCULATOR);\n    }\n\n    /**\n     * @notice return LiquidationManager address\n     * @return LiquidationManager address\n     */\n    function getLiquidationManager() external view returns (address) {\n        return getAddress(LIQUIDATION_MANAGER);\n    }\n\n    /**\n     * @notice return Oracle address\n     * @return Oracle address\n     */\n    function getOracle() external view returns (address) {\n        return getAddress(ORACLE);\n    }\n\n    /**\n     * @notice set Otoken implementation address\n     * @dev can only be called by the addressbook owner\n     * @param _otokenImpl Otoken implementation address\n     */\n    function setOtokenImpl(address _otokenImpl) external onlyOwner {\n        setAddress(OTOKEN_IMPL, _otokenImpl);\n    }\n\n    /**\n     * @notice set OtokenFactory address\n     * @dev can only be called by the addressbook owner\n     * @param _otokenFactory OtokenFactory address\n     */\n    function setOtokenFactory(address _otokenFactory) external onlyOwner {\n        setAddress(OTOKEN_FACTORY, _otokenFactory);\n    }\n\n    /**\n     * @notice set Whitelist address\n     * @dev can only be called by the addressbook owner\n     * @param _whitelist Whitelist address\n     */\n    function setWhitelist(address _whitelist) external onlyOwner {\n        setAddress(WHITELIST, _whitelist);\n    }\n\n    /**\n     * @notice set Controller address\n     * @dev can only be called by the addressbook owner\n     * @param _controller Controller address\n     */\n    function setController(address _controller) external onlyOwner {\n        updateImpl(CONTROLLER, _controller);\n    }\n\n    /**\n     * @notice set MarginPool address\n     * @dev can only be called by the addressbook owner\n     * @param _marginPool MarginPool address\n     */\n    function setMarginPool(address _marginPool) external onlyOwner {\n        setAddress(MARGIN_POOL, _marginPool);\n    }\n\n    /**\n     * @notice set MarginCalculator address\n     * @dev can only be called by the addressbook owner\n     * @param _marginCalculator MarginCalculator address\n     */\n    function setMarginCalculator(address _marginCalculator) external onlyOwner {\n        setAddress(MARGIN_CALCULATOR, _marginCalculator);\n    }\n\n    /**\n     * @notice set LiquidationManager address\n     * @dev can only be called by the addressbook owner\n     * @param _liquidationManager LiquidationManager address\n     */\n    function setLiquidationManager(address _liquidationManager) external onlyOwner {\n        setAddress(LIQUIDATION_MANAGER, _liquidationManager);\n    }\n\n    /**\n     * @notice set Oracle address\n     * @dev can only be called by the addressbook owner\n     * @param _oracle Oracle address\n     */\n    function setOracle(address _oracle) external onlyOwner {\n        setAddress(ORACLE, _oracle);\n    }\n\n    /**\n     * @notice return an address for specific key\n     * @param _key key address\n     * @return address\n     */\n    function getAddress(bytes32 _key) public view returns (address) {\n        return addresses[_key];\n    }\n\n    /**\n     * @notice set a specific address for a specific key\n     * @dev can only be called by the addressbook owner\n     * @param _key key\n     * @param _address address\n     */\n    function setAddress(bytes32 _key, address _address) public onlyOwner {\n        addresses[_key] = _address;\n\n        emit AddressAdded(_key, _address);\n    }\n\n    /**\n     * @dev internal function to update the implementation of a specific component of the protocol\n     * @param _id id of the contract to be updated\n     * @param _newAddress address of the new implementation\n     **/\n    function updateImpl(bytes32 _id, address _newAddress) public onlyOwner {\n        address payable proxyAddress = address(uint160(getAddress(_id)));\n\n        bytes memory params = abi.encodeWithSignature(\"initialize(address,address)\", address(this), owner());\n\n        if (proxyAddress == address(0)) {\n            OwnedUpgradeabilityProxy proxy = new OwnedUpgradeabilityProxy();\n            setAddress(_id, address(proxy));\n            emit ProxyCreated(_id, address(proxy));\n            proxy.upgradeToAndCall(_newAddress, params);\n        } else {\n            OwnedUpgradeabilityProxy proxy = OwnedUpgradeabilityProxy(proxyAddress);\n            proxy.upgradeTo(_newAddress);\n        }\n    }\n}"
    }
  ]
}