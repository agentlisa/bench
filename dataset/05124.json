{
  "Title": "[M-04] Incorrect gas claiming logic in `ThrusterPoolDeployer`",
  "Content": "\nFrom the audit documentation:\n\n> All contracts that use gas should comply with the Blast gas claim logic.\n\nHowever, the `ThrusterPoolDeployer` contains a flaw in the implementation of `claimGas()` which will prevent it from ever claiming the gas it induces. The function attempts to claim gas for the zero address (`address(0)`) instead of the deployer's own address (`address(this)`):\n\n```solidity\n    function claimGas(address _recipient) external override onlyFactory returns (uint256 amount) {\n        amount = IBlast(BLAST).claimMaxGas(address(0), _recipient);\n    }\n```\n\nThis misconfiguration prevents the `ThrusterPoolDeployer` from reclaiming any gas, as the `IBlast.claimMaxGas()` call will always fail when provided with the zero address.\n\n### Proof of Concept\n\n<https://github.com/blast-io/blast/blob/master/blast-optimism/packages/contracts-bedrock/src/L2/Blast.sol#L274-L283>\n\n```solidity\n/**\n * @notice Claims gas available to be claimed at max claim rate for a specific contract. Called by an authorized user\n * @param contractAddress The address of the contract for which maximum gas is to be claimed\n * @param recipientOfGas The address of the recipient of the gas\n * @return The amount of gas that was claimed\n */\nfunction claimMaxGas(address contractAddress, address recipientOfGas) external returns (uint256) {\n\trequire(isAuthorized(contractAddress), \"Not allowed to claim max gas\");\n\treturn IGas(GAS_CONTRACT).claimMax(contractAddress, recipientOfGas);\n}\n```\n\n### Recommended Mitigation Steps\n\nUse `address(this)` rather than `0`.\n\n**[jooleseth (Thruster) confirmed and commented](https://github.com/code-423n4/2024-02-thruster-findings/issues/24#issuecomment-1963636092):**\n > I agree, we caught this issue a few days ago too. Blast had initially in their docs specified it should be address(0) instead of address(this) for gas claiming and we missed changing this in the audit commit freeze. Will agree to a Medium Risk bug for this, as it doesn't affect any user funds.\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2024-02-thruster",
  "Code": [
    {
      "filename": "blast-optimism/packages/contracts-bedrock/src/L2/Blast.sol",
      "content": "// SPDX-License-Identifier: BSL 1.1 - Copyright 2024 MetaLayer Labs Ltd.\npragma solidity 0.8.15;\n\nimport { Initializable } from \"@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol\";\n\nimport { Semver } from \"src/universal/Semver.sol\";\nimport { GasMode, IGas } from \"src/L2/Gas.sol\";\n\nenum YieldMode {\n    AUTOMATIC,\n    VOID,\n    CLAIMABLE\n}\n\ninterface IYield {\n    function configure(address contractAddress, uint8 flags) external returns (uint256);\n    function claim(address contractAddress, address recipientOfYield, uint256 desiredAmount) external returns (uint256);\n    function getClaimableAmount(address contractAddress) external view returns (uint256);\n    function getConfiguration(address contractAddress) external view returns (uint8);\n}\n\ninterface IBlast{\n    // configure\n    function configureContract(address contractAddress, YieldMode _yield, GasMode gasMode, address governor) external;\n    function configure(YieldMode _yield, GasMode gasMode, address governor) external;\n\n    // base configuration options\n    function configureClaimableYield() external;\n    function configureClaimableYieldOnBehalf(address contractAddress) external;\n    function configureAutomaticYield() external;\n    function configureAutomaticYieldOnBehalf(address contractAddress) external;\n    function configureVoidYield() external;\n    function configureVoidYieldOnBehalf(address contractAddress) external;\n    function configureClaimableGas() external;\n    function configureClaimableGasOnBehalf(address contractAddress) external;\n    function configureVoidGas() external;\n    function configureVoidGasOnBehalf(address contractAddress) external;\n    function configureGovernor(address _governor) external;\n    function configureGovernorOnBehalf(address _newGovernor, address contractAddress) external;\n\n    // claim yield\n    function claimYield(address contractAddress, address recipientOfYield, uint256 amount) external returns (uint256);\n    function claimAllYield(address contractAddress, address recipientOfYield) external returns (uint256);\n\n    // claim gas\n    function claimAllGas(address contractAddress, address recipientOfGas) external returns (uint256);\n    // NOTE: can be off by 1 bip\n    function claimGasAtMinClaimRate(address contractAddress, address recipientOfGas, uint256 minClaimRateBips) external returns (uint256);\n    function claimMaxGas(address contractAddress, address recipientOfGas) external returns (uint256);\n    function claimGas(address contractAddress, address recipientOfGas, uint256 gasToClaim, uint256 gasSecondsToConsume) external returns (uint256);\n\n    // read functions\n    function readClaimableYield(address contractAddress) external view returns (uint256);\n    function readYieldConfiguration(address contractAddress) external view returns (uint8);\n    function readGasParams(address contractAddress) external view returns (uint256 etherSeconds, uint256 etherBalance, uint256 lastUpdated, GasMode);\n}\n\n/// @custom:predeploy 0x4300000000000000000000000000000000000002\n/// @title Blast\ncontract Blast is IBlast, Initializable, Semver {\n    address public immutable YIELD_CONTRACT;\n    address public immutable GAS_CONTRACT;\n\n    mapping(address => address) public governorMap;\n\n    constructor(address _gasContract, address _yieldContract) Semver(1, 0, 0) {\n        GAS_CONTRACT = _gasContract;\n        YIELD_CONTRACT = _yieldContract;\n        _disableInitializers();\n    }\n\n    function initialize() public initializer {}\n\n    /**\n     * @notice Checks if the caller is the governor of the contract\n     * @param contractAddress The address of the contract\n     * @return A boolean indicating if the caller is the governor\n     */\n    function isGovernor(address contractAddress) public view returns (bool) {\n        return msg.sender == governorMap[contractAddress];\n    }\n    /**\n     * @notice Checks if the governor is not set for the contract\n     * @param contractAddress The address of the contract\n     * @return boolean indicating if the governor is not set\n     */\n    function governorNotSet(address contractAddress) internal view returns (bool) {\n        return governorMap[contractAddress] == address(0);\n    }\n    /**\n     * @notice Checks if the caller is authorized\n     * @param contractAddress The address of the contract\n     * @return A boolean indicating if the caller is authorized\n     */\n    function isAuthorized(address contractAddress) public view returns (bool) {\n        return isGovernor(contractAddress) || (governorNotSet(contractAddress) && msg.sender == contractAddress);\n    }\n\n    /**\n     * @notice contract configures its yield and gas modes and sets the governor. called by contract\n     * @param _yieldMode The yield mode to be set\n     * @param _gasMode The gas mode to be set\n     * @param governor The address of the governor to be set\n     */\n    function configure(YieldMode _yieldMode, GasMode _gasMode, address governor) external {\n        // requires that no governor is set for contract\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        // set governor\n        governorMap[msg.sender] = governor;\n        // set gas mode\n        IGas(GAS_CONTRACT).setGasMode(msg.sender, _gasMode);\n        // set yield mode\n        IYield(YIELD_CONTRACT).configure(msg.sender, uint8(_yieldMode));\n    }\n\n    /**\n     * @notice Configures the yield and gas modes and sets the governor for a specific contract. called by authorized user\n     * @param contractAddress The address of the contract to be configured\n     * @param _yieldMode The yield mode to be set\n     * @param _gasMode The gas mode to be set\n     * @param _newGovernor The address of the new governor to be set\n     */\n    function configureContract(address contractAddress, YieldMode _yieldMode, GasMode _gasMode, address _newGovernor) external {\n        // only allow governor, or if no governor is set, the contract itself to configure\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        // set governor\n        governorMap[contractAddress] = _newGovernor;\n        // set gas mode\n        IGas(GAS_CONTRACT).setGasMode(contractAddress, _gasMode);\n        // set yield mode\n        IYield(YIELD_CONTRACT).configure(contractAddress, uint8(_yieldMode));\n    }\n\n    /**\n     * @notice Configures the yield mode to CLAIMABLE for the contract that calls this function\n     */\n    function configureClaimableYield() external {\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        IYield(YIELD_CONTRACT).configure(msg.sender, uint8(YieldMode.CLAIMABLE));\n    }\n\n    /**\n     * @notice Configures the yield mode to CLAIMABLE for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract to be configured\n     */\n    function configureClaimableYieldOnBehalf(address contractAddress) external {\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        IYield(YIELD_CONTRACT).configure(contractAddress, uint8(YieldMode.CLAIMABLE));\n    }\n\n    /**\n     * @notice Configures the yield mode to AUTOMATIC for the contract that calls this function\n     */\n    function configureAutomaticYield() external {\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        IYield(YIELD_CONTRACT).configure(msg.sender, uint8(YieldMode.AUTOMATIC));\n    }\n\n    /**\n     * @notice Configures the yield mode to AUTOMATIC for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract to be configured\n     */\n    function configureAutomaticYieldOnBehalf(address contractAddress) external {\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        IYield(YIELD_CONTRACT).configure(contractAddress, uint8(YieldMode.AUTOMATIC));\n    }\n\n    /**\n     * @notice Configures the yield mode to VOID for the contract that calls this function\n     */\n    function configureVoidYield() external {\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        IYield(YIELD_CONTRACT).configure(msg.sender, uint8(YieldMode.VOID));\n    }\n\n    /**\n     * @notice Configures the yield mode to VOID for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract to be configured\n     */\n    function configureVoidYieldOnBehalf(address contractAddress) external {\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        IYield(YIELD_CONTRACT).configure(contractAddress, uint8(YieldMode.VOID));\n    }\n\n    /**\n     * @notice Configures the gas mode to CLAIMABLE for the contract that calls this function\n     */\n    function configureClaimableGas() external {\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        IGas(GAS_CONTRACT).setGasMode(msg.sender, GasMode.CLAIMABLE);\n    }\n\n    /**\n     * @notice Configures the gas mode to CLAIMABLE for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract to be configured\n     */\n    function configureClaimableGasOnBehalf(address contractAddress) external {\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        IGas(GAS_CONTRACT).setGasMode(contractAddress, GasMode.CLAIMABLE);\n    }\n\n    /**\n     * @notice Configures the gas mode to VOID for the contract that calls this function\n     */\n    function configureVoidGas() external {\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        IGas(GAS_CONTRACT).setGasMode(msg.sender, GasMode.VOID);\n    }\n\n    /**\n     * @notice Configures the gas mode to void for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract to be configured\n     */\n    function configureVoidGasOnBehalf(address contractAddress) external {\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        IGas(GAS_CONTRACT).setGasMode(contractAddress, GasMode.VOID);\n    }\n\n    /**\n     * @notice Configures the governor for the contract that calls this function\n     */\n    function configureGovernor(address _governor) external {\n        require(isAuthorized(msg.sender), \"not authorized to configure contract\");\n        governorMap[msg.sender] = _governor;\n    }\n\n    /**\n     * @notice Configures the governor for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract to be configured\n     */\n    function configureGovernorOnBehalf(address _newGovernor, address contractAddress) external {\n        require(isAuthorized(contractAddress), \"not authorized to configure contract\");\n        governorMap[contractAddress] = _newGovernor;\n    }\n\n\n    // claim methods\n\n    /**\n     * @notice Claims yield for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract for which yield is to be claimed\n     * @param recipientOfYield The address of the recipient of the yield\n     * @param amount The amount of yield to be claimed\n     * @return The amount of yield that was claimed\n     */\n    function claimYield(address contractAddress, address recipientOfYield, uint256 amount) external returns (uint256) {\n        require(isAuthorized(contractAddress), \"Not authorized to claim yield\");\n        return  IYield(YIELD_CONTRACT).claim(contractAddress, recipientOfYield, amount);\n    }\n    /**\n     * @notice Claims all yield for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract for which all yield is to be claimed\n     * @param recipientOfYield The address of the recipient of the yield\n     * @return The amount of yield that was claimed\n     */\n    function claimAllYield(address contractAddress, address recipientOfYield) external returns (uint256) {\n        require(isAuthorized(contractAddress), \"Not authorized to claim yield\");\n        uint256 amount = IYield(YIELD_CONTRACT).getClaimableAmount(contractAddress);\n        return  IYield(YIELD_CONTRACT).claim(contractAddress, recipientOfYield, amount);\n    }\n\n    /**\n     * @notice Claims all gas for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract for which all gas is to be claimed\n     * @param recipientOfGas The address of the recipient of the gas\n     * @return The amount of gas that was claimed\n     */\n    function claimAllGas(address contractAddress, address recipientOfGas) external returns (uint256) {\n        require(isAuthorized(contractAddress), \"Not allowed to claim all gas\");\n        return IGas(GAS_CONTRACT).claimAll(contractAddress, recipientOfGas);\n    }\n\n    /**\n     * @notice Claims gas at a minimum claim rate for a specific contract, with error rate '1'. Called by an authorized user\n     * @param contractAddress The address of the contract for which gas is to be claimed\n     * @param recipientOfGas The address of the recipient of the gas\n     * @param minClaimRateBips The minimum claim rate in basis points\n     * @return The amount of gas that was claimed\n     */\n    function claimGasAtMinClaimRate(address contractAddress, address recipientOfGas, uint256 minClaimRateBips) external returns (uint256) {\n        require(isAuthorized(contractAddress), \"Not allowed to claim gas at min claim rate\");\n        return IGas(GAS_CONTRACT).claimGasAtMinClaimRate(contractAddress, recipientOfGas, minClaimRateBips);\n    }\n\n    /**\n     * @notice Claims gas available to be claimed at max claim rate for a specific contract. Called by an authorized user\n     * @param contractAddress The address of the contract for which maximum gas is to be claimed\n     * @param recipientOfGas The address of the recipient of the gas\n     * @return The amount of gas that was claimed\n     */\n    function claimMaxGas(address contractAddress, address recipientOfGas) external returns (uint256) {\n        require(isAuthorized(contractAddress), \"Not allowed to claim max gas\");\n        return IGas(GAS_CONTRACT).claimMax(contractAddress, recipientOfGas);\n    }\n    /**\n     * @notice Claims a specific amount of gas for a specific contract. claim rate governed by integral of gas over time\n     * @param contractAddress The address of the contract for which gas is to be claimed\n     * @param recipientOfGas The address of the recipient of the gas\n     * @param gasToClaim The amount of gas to be claimed\n     * @param gasSecondsToConsume The amount of gas seconds to consume\n     * @return The amount of gas that was claimed\n     */\n    function claimGas(address contractAddress, address recipientOfGas, uint256 gasToClaim, uint256 gasSecondsToConsume) external returns (uint256) {\n        require(isAuthorized(contractAddress), \"Not allowed to claim gas\");\n        return IGas(GAS_CONTRACT).claim(contractAddress, recipientOfGas, gasToClaim, gasSecondsToConsume);\n    }\n\n    /**\n     * @notice Reads the claimable yield for a specific contract\n     * @param contractAddress The address of the contract for which the claimable yield is to be read\n     * @return claimable yield\n     */\n    function readClaimableYield(address contractAddress) public view returns (uint256) {\n        return IYield(YIELD_CONTRACT).getClaimableAmount(contractAddress);\n    }\n    /**\n     * @notice Reads the yield configuration for a specific contract\n     * @param contractAddress The address of the contract for which the yield configuration is to be read\n     * @return uint8 representing yield enum\n     */\n\n    function readYieldConfiguration(address contractAddress) public view returns (uint8) {\n        return IYield(YIELD_CONTRACT).getConfiguration(contractAddress);\n    }\n    /**\n     * @notice Reads the gas parameters for a specific contract\n     * @param contractAddress The address of the contract for which the gas parameters are to be read\n     * @return uint256 representing the accumulated ether seconds\n     * @return uint256 representing ether balance\n     * @return uint256 representing last update timestamp\n     * @return GasMode representing the gas mode (VOID, CLAIMABLE)\n     */\n    function readGasParams(address contractAddress) public view returns (uint256, uint256, uint256, GasMode) {\n        return IGas(GAS_CONTRACT).readGasParams(contractAddress);\n    }\n}"
    }
  ]
}