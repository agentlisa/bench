{
  "Title": "[M10] Not using OpenZeppelin contracts",
  "Content": "OpenZeppelin maintains a library of standard, audited, community-reviewed, and battle-tested smart contracts.  \n\nInstead of always importing these contracts, the Celo project reimplements them in some cases, while in other cases it just copies portions of them.  \n\nThis increases the amount of code that the cLabs team will have to maintain and misses all the improvements and bug fixes that the OpenZeppelin team is constantly implementing with the help of the community.  \n\nIn particular, the following contracts and libraries are being reimplemented or copied:\n\n\n* In the [`AddressHelper` library](https://github.com/celo-org/celo-monorepo/blob/7be22605e172ca536c028e408b147aab83202e4a/packages/protocol/contracts/common/libraries/AddressesHelper.sol#L6), an old version of the [`isContract` function](https://github.com/celo-org/celo-monorepo/blob/7be22605e172ca536c028e408b147aab83202e4a/packages/protocol/contracts/common/libraries/AddressesHelper.sol#L14) is used.  \n\nThe [most recent version of this function in the OpenZeppelin contracts project](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v2.5.0/contracts/utils/Address.sol#L18) uses `extcodehash` instead of `extcodesize` to give better guarantees and work with more cases.\n* [`Signatures` library](https://github.com/celo-org/celo-monorepo/blob/7be22605e172ca536c028e408b147aab83202e4a/packages/protocol/contracts/common/Signatures.sol) can be replaced with the [OpenZeppelin `ECDSA` library](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v2.5.0/contracts/cryptography/ECDSA.sol).\n* [`SafeCast` library](https://github.com/celo-org/celo-monorepo/blob/7be22605e172ca536c028e408b147aab83202e4a/packages/protocol/contracts/common/SafeCast.sol) can be replaced with the [OpenZeppelin `SafeCast` contract](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v2.5.0/contracts/utils/SafeCast.sol) which was included in the `v2.5.0` release.\n* [`StableToken` contract](https://github.com/celo-org/celo-monorepo/blob/7be22605e172ca536c028e408b147aab83202e4a/packages/protocol/contracts/stability/StableToken.sol) and [`GoldToken` contract](https://github.com/celo-org/celo-monorepo/blob/7be22605e172ca536c028e408b147aab83202e4a/packages/protocol/contracts/common/GoldToken.sol) can inherit from the [`IERC20` interface](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v2.5.0/contracts/token/ERC20/IERC20.sol) and the [`ERC20Detailed` contract](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v2.5.0/contracts/token/ERC20/ERC20Detailed.sol) among others where appropriate.\n\n\nConsider importing the OpenZeppelin contracts instead of reimplementing or copying them, and consider updating the library to its [latest version](https://github.com/OpenZeppelin/openzeppelin-contracts/tree/v2.5.0).\n\n\n***Update:** Partially fixed in [pull request #2877](https://github.com/celo-org/celo-monorepo/pull/2877/files). Now Celo is using version 2.5.0 of OpenZeppelin instead of copying the contracts to their repository. Except for the [`ReentrancyGuard` contract](https://github.com/celo-org/celo-monorepo/pull/2877/files#diff-36c36280e55a7a1b48201d70c2277802R9). This `ReentrancyGuard` version was copied into the Celo repository because the most recent version of `ReentrancyGuard` in OpenZeppelin requires its constructor to be called to work correctly. This does not happen when it is used through a proxy. However, note that the `ReentrancyGuard` version now in use by Celo worked with proxies just by coincidence, because the [`uint256 _guardCounter` variable](https://github.com/celo-org/celo-monorepo/pull/2877/files#diff-36c36280e55a7a1b48201d70c2277802R11) would work even if it is not initialized. The project [`openzeppelin-contracts-ethereum-package`](https://github.com/OpenZeppelin/openzeppelin-contracts-ethereum-package) is the one designed to work with proxies. Consider importing this package instead, which includes a `ReentrancyGuard` version with an [`initializer` function](https://github.com/OpenZeppelin/openzeppelin-contracts-ethereum-package/blob/master/contracts/utils/ReentrancyGuard.sol#L17).*\n\n\n",
  "Impact": "MEDIUM",
  "Source": "",
  "Code": [
    {
      "filename": "packages/protocol/contracts/common/libraries/AddressesHelper.sol",
      "content": "pragma solidity ^0.5.3;\n\n/**\n * @title Library with support functions to deal with addresses\n */\nlibrary AddressesHelper {\n  /**\n   * @dev isContract detect whether the address is \n   *      a contract address or externally owned account (EOA)\n   * WARNING: Calling this function from a constructor will return false\n   *          independently if the address given as parameter is a contract or EOA\n   * @return true if it is a contract address\n   */\n  function isContract(address addr) internal view returns (bool) {\n    uint256 size;\n    /* solium-disable-next-line security/no-inline-assembly */\n    assembly {\n      size := extcodesize(addr)\n    }\n    return size > 0;\n  }\n}"
    },
    {
      "filename": "contracts/utils/Address.sol",
      "content": "pragma solidity ^0.5.5;\n\n/**\n * @dev Collection of functions related to the address type\n */\nlibrary Address {\n    /**\n     * @dev Returns true if `account` is a contract.\n     *\n     * [IMPORTANT]\n     * ====\n     * It is unsafe to assume that an address for which this function returns\n     * false is an externally-owned account (EOA) and not a contract.\n     *\n     * Among others, `isContract` will return false for the following \n     * types of addresses:\n     *\n     *  - an externally-owned account\n     *  - a contract in construction\n     *  - an address where a contract will be created\n     *  - an address where a contract lived, but was destroyed\n     * ====\n     */\n    function isContract(address account) internal view returns (bool) {\n        // According to EIP-1052, 0x0 is the value returned for not-yet created accounts\n        // and 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470 is returned\n        // for accounts without code, i.e. `keccak256('')`\n        bytes32 codehash;\n        bytes32 accountHash = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;\n        // solhint-disable-next-line no-inline-assembly\n        assembly { codehash := extcodehash(account) }\n        return (codehash != accountHash && codehash != 0x0);\n    }\n\n    /**\n     * @dev Converts an `address` into `address payable`. Note that this is\n     * simply a type cast: the actual underlying value is not changed.\n     *\n     * _Available since v2.4.0._\n     */\n    function toPayable(address account) internal pure returns (address payable) {\n        return address(uint160(account));\n    }\n\n    /**\n     * @dev Replacement for Solidity's `transfer`: sends `amount` wei to\n     * `recipient`, forwarding all available gas and reverting on errors.\n     *\n     * https://eips.ethereum.org/EIPS/eip-1884[EIP1884] increases the gas cost\n     * of certain opcodes, possibly making contracts go over the 2300 gas limit\n     * imposed by `transfer`, making them unable to receive funds via\n     * `transfer`. {sendValue} removes this limitation.\n     *\n     * https://diligence.consensys.net/posts/2019/09/stop-using-soliditys-transfer-now/[Learn more].\n     *\n     * IMPORTANT: because control is transferred to `recipient`, care must be\n     * taken to not create reentrancy vulnerabilities. Consider using\n     * {ReentrancyGuard} or the\n     * https://solidity.readthedocs.io/en/v0.5.11/security-considerations.html#use-the-checks-effects-interactions-pattern[checks-effects-interactions pattern].\n     *\n     * _Available since v2.4.0._\n     */\n    function sendValue(address payable recipient, uint256 amount) internal {\n        require(address(this).balance >= amount, \"Address: insufficient balance\");\n\n        // solhint-disable-next-line avoid-call-value\n        (bool success, ) = recipient.call.value(amount)(\"\");\n        require(success, \"Address: unable to send value, recipient may have reverted\");\n    }\n}"
    }
  ]
}