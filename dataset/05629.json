{
  "Title": "[M-01] A safe that has been created using version `1.40=<` will not be compatible with Brahma",
  "Content": "\nSafe's created outside of the Brahma ecosystem should be able to seamlessly integrate into the `Brahma`. This Safe should call `WalletRegistry.registerWallet` to register. After registration,\nthis safe will be a `consoleAccount` and should be able to use the same functionality that all the other `consoleAccounts` have.\n\nHowever, Safe's that have been created using version `1.4.0=<` are not fully compatible with Brahma. This is because, in version 1.4.0, `IERC165` support has been [added](https://github.com/safe-global/safe-contracts/pull/310/files) to the `GuardManager.sol`, this is the code added:\n\n```diff\n+ if (guard != address(0)) {\n+ require(Guard(guard).supportsInterface(type(Guard).interfaceId), \"GS300\");\n+ }\n```\n\nThis means that every Safe that has been created using Safe's contract version 1.40 and up, can only add guards that support the `EIP-165` interface, as read from the [CHANGELOG.md](https://github.com/safe-global/safe-contracts/blob/main/CHANGELOG.md?plain=1#L206)\n\n### Proof of Concept\n\nConsider the following:\n\n- Alice has a safe setup.\n- Alice wants to integrate their safe into the Brahma ecosystem.\n- Alice calls `WalletRegistry.registerWallet` and this call succeeds.\n- Alice decides they want to implement the guard contract provided by the Brahma ecosystem, `SafeModeratorOverridable.sol`\n- Alice calls `GnosisSafe.setGuard(address(SafeModeratorOverridable))`.\n- This will fail because of this new require statement in Safe contracts `v1.4.0=<`:\n\n```\nfunction setGuard(address guard) external authorized {\n        if (guard != address(0)) {\n            require(Guard(guard).supportsInterface(type(Guard).interfaceId), \"GS300\");\n        }\n```\n\nBecause the `SafeModeratorOverridable.sol` does not support the `EIP-165` interface:\n\n```\nsource: contracts/src/core/SafeModeratorOverridable.sol\n\ncontract SafeModeratorOverridable is AddressProviderService, IGuard {\n```\n\nThis means that every Safe created with version 1.4.0 or up, can not implement the guard contract, which is a fundamental part of the way the `ConsoleAccounts` function.\n\n### Recommended Mitigation Steps\n\nAdd support for the `EIP-165` interface or update the Safe contracts used in Brahma from 1.3.0 to the most recent version.\n\n### Assessed type\n\nContext\n\n**[0xsomeone (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2023-10-brahma-findings/issues/383#issuecomment-1783092407):**\n > This appears to be a contender for \"best\" as it clearly pinpoints the flaw (i.e. Gnosis Safe instances created externally rather than via the code) as well as versions (i.e. `>=1.4.0`) the bug is applicable to.\n\n**[0xad1onchain (Brahma) confirmed](https://github.com/code-423n4/2023-10-brahma-findings/issues/383#issuecomment-1783607114)**\n\n**[0xad1onchain (Brahma) commented](https://github.com/code-423n4/2023-10-brahma-findings/issues/383#issuecomment-1817756510):**\n> Fixed, added the recommended IERC165 support.\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-10-brahma",
  "Code": [
    {
      "filename": "CHANGELOG.md?plain=1",
      "content": "# Changelog\n\nThis changelog only contains changes starting from version 1.3.0\n\n# Version 1.5.0\n\n## Rename repository\n\nIssue: [#719](https://github.com/safe-global/safe-smart-account/issues/719)\n\nThe repository was renamed from `safe-contracts` to `safe-smart-account` to better reflect the purpose of the contracts. Also, the npm package name was changed from `@safe-global/safe-contracts` to `@safe-global/safe-smart-account`.\n\n## Compiler settings\n\nSolidity compiler: [0.7.6](https://github.com/ethereum/solidity/releases/tag/v0.7.6) (for more info see issue [#251](https://github.com/safe-global/safe-smart-account/issues/251))\n\nSolidity optimizer: `disabled`\n\n## Expected addresses with [Safe Singleton Factory](https://github.com/safe-global/safe-singleton-factory)\n\n### Core contracts\n\n-   `Safe` at `0x41675C099F32341bf84BFc5382aF534df5C7461a`\n-   `SafeL2` at `0x29fcB43b46531BcA003ddC8FCB67FFE91900C762`\n\n### Factory contracts\n\n-   `SafeProxyFactory` at `0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67`\n\n### Handler contracts\n\n-   `TokenCallbackHandler` at `0xeDCF620325E82e3B9836eaaeFdc4283E99Dd7562`\n-   `CompatibilityFallbackHandler` at `0xfd0732Dc9E303f09fCEf3a7388Ad10A83459Ec99`\n\n### Lib contracts\n\n-   `MultiSend` at `0x38869bf66a61cF6bDB996A6aE40D5853Fd43B526`\n-   `MultiSendCallOnly` at `0x9641d764fc13c8B624c04430C7356C1C7C8102e2`\n-   `CreateCall` at `0x9b35Af71d77eaf8d7e40252370304687390A1A52`\n-   `SignMessageLib` at `0xd53cd0aB83D845Ac265BE939c57F53AD838012c9`\n\n### Storage reader contracts\n\n-   `SimulateTxAccessor` at `0x3d4BA2E0884aa488718476ca2FB8Efc291A46199`\n\n## Changes\n\n### General\n\n#### Use updated EIP-1271 function signature in the signature validation process\n\nIssue: [#391](https://github.com/safe-global/safe-smart-account/issues/391)\n\nNew function signature implemented and legacy function removed from compatibility fallback handler contract.\n\n#### Remove usage of `transfer` and `send`\n\nIssue: [#601](https://github.com/safe-global/safe-smart-account/issues/601)\n\nCalls to `transfer` and `send` were removed to make the contract not depend on any potential gas cost changes. The calls were replaced with `call`, and that should be kept in mind when using the contract and designing extensions due to potential reentrancy vectors.\n\n#### Make assembly blocks memory safe\n\nIssue: [#544](https://github.com/safe-global/safe-smart-account/issues/544)\n\nThe contracts couldn't be compiled with the solidity compiler versions 0.8.19+ because of the compiler optimizations that copy stack variables to memory to prevent stack-too-deep errors. In some assembly blocks, the scratch space was used, and that's not\nconsidered safe, so all the assembly blocks were adjusted to use safe memory allocation.\n\n#### Add `checkModuleTransaction` method to the guard\n\nIssue: [#335](https://github.com/safe-global/safe-smart-account/issues/335)\n\nThe `checkModuleTransaction` method was added to the guard to allow checking the module transactions before execution. The method is called before the `checkAfterExecution` method. While migrating, it should be checked if a Safe has an existing guard and if it implements the `checkModuleTransaction` method. If it doesn't, module transactions will be blocked.\n\n#### Add overloaded `checkNSignatures` method\n\nIssues: \n- [#557](https://github.com/safe-global/safe-smart-account/pull/557)\n- [#589](https://github.com/safe-global/safe-smart-account/pull/589)\n\nPreviously pre-approved signatures relying on the `msg.sender` variable couldn't be used in guards or modules without duplicating the logic within the module itself. This is now improved by adding an overloaded `checkNSignatures` method that accepts a `msg.sender` parameter. This allows the module to pass the `msg.sender` variable to the `checkNSignatures` method and use the pre-approved signatures. The old method was moved from the core contract to the `CompatibilityFallbackHandler`.\n\n#### `encodeTransactionData` public method removal\n\nTo fit all of the above changes into the bytecode size limit, the `encodeTransactionData` method was made private.\n\n# Version 1.4.1\n\n## Compiler settings\n\nSolidity compiler: [0.7.6](https://github.com/ethereum/solidity/releases/tag/v0.7.6) (for more info see issue [#251](https://github.com/safe-global/safe-smart-account/issues/251))\n\nSolidity optimizer: `disabled`\n\n## Expected addresses with [Safe Singleton Factory](https://github.com/safe-global/safe-singleton-factory)\n\n### Core contracts\n\n-   `Safe` at `0x41675C099F32341bf84BFc5382aF534df5C7461a`\n-   `SafeL2` at `0x29fcB43b46531BcA003ddC8FCB67FFE91900C762`\n\n### Factory contracts\n\n-   `SafeProxyFactory` at `0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67`\n\n### Handler contracts\n\n-   `TokenCallbackHandler` at `0xeDCF620325E82e3B9836eaaeFdc4283E99Dd7562`\n-   `CompatibilityFallbackHandler` at `0xfd0732Dc9E303f09fCEf3a7388Ad10A83459Ec99`\n\n### Lib contracts\n\n-   `MultiSend` at `0x38869bf66a61cF6bDB996A6aE40D5853Fd43B526`\n-   `MultiSendCallOnly` at `0x9641d764fc13c8B624c04430C7356C1C7C8102e2`\n-   `CreateCall` at `0x9b35Af71d77eaf8d7e40252370304687390A1A52`\n-   `SignMessageLib` at `0xd53cd0aB83D845Ac265BE939c57F53AD838012c9`\n\n### Storage reader contracts\n\n-   `SimulateTxAccessor` at `0x3d4BA2E0884aa488718476ca2FB8Efc291A46199`\n\n## Changes\n\n### Bugfixes\n\n#### Remove `gasleft()` usage in `setupModules`\n\nIssue: [#568](https://github.com/safe-global/safe-smart-account/issues/568)\n\n`setupModules` made a call to `gasleft()` that is invalid in the ERC-4337 standard. The call was replaced with `type(uint256).max` to forward all the available gas instead.\n\n\n# Version 1.4.0\n\n## Compiler settings\n\nSolidity compiler: [0.7.6](https://github.com/ethereum/solidity/releases/tag/v0.7.6) (for more info see issue [#251](https://github.com/safe-global/safe-smart-account/issues/251))\n\nSolidity optimizer: `disabled`\n\n## Expected addresses with [Safe Singleton Factory](https://github.com/safe-global/safe-singleton-factory)\n\n### Core contracts\n\n-   `Safe` at `0xc962E67D9490E154D81181879ddf4CD3b65D2132`\n-   `SafeL2` at `0x1eb4681c549d995AbdC4aB189cAbb9f00B508cAb`\n\n### Factory contracts\n\n-   `SafeProxyFactory` at `0x4e1DCf7AD4e460CfD30791CCC4F9c8a4f820ec67`\n\n### Handler contracts\n\n-   `TokenCallbackHandler` at `0xeDCF620325E82e3B9836eaaeFdc4283E99Dd7562`\n-   `CompatibilityFallbackHandler` at `0x2a15DE4410d4c8af0A7b6c12803120f43C42B820`\n\n### Lib contracts\n\n-   `MultiSend` at `0x38869bf66a61cF6bDB996A6aE40D5853Fd43B526`\n-   `MultiSendCallOnly` at `0x9641d764fc13c8B624c04430C7356C1C7C8102e2`\n-   `CreateCall` at `0x9b35Af71d77eaf8d7e40252370304687390A1A52`\n-   `SignMessageLib` at `0x58FCe385Ed16beB4BCE49c8DF34c7d6975807520`\n\n### Storage reader contracts\n\n-   `SimulateTxAccessor` at `0x3d4BA2E0884aa488718476ca2FB8Efc291A46199`\n\n## Changes\n\n### General\n\n#### Drop \"Gnosis\" from contract names\n\nRemoved the \"Gnosis\" prefix from all contract names.\n\n### Core contract"
    },
    {
      "filename": "[`contracts/SafeL2.sol`](https://github.com/safe-global/safe-smart-account/blob/3c3fc80f7f9aef1d39aaae2b53db5f4490051b0d/contracts/SafeL2.sol)",
      "content": "#### Remove usage of the `GAS` opcode in module execute flows\n\nIssue: [#459](https://github.com/safe-global/safe-smart-account/issues/459)\n\nThe following rule of usage of the `GAS` opcode in the ERC-4337 standard made it impossible to build a module to support ERC4337:\n\n> -   Must not use GAS opcode (unless followed immediately by one of { CALL, DELEGATECALL, CALLCODE, STATICCALL }.)\n\nWe removed the `GAS` opcode usage in module transactions to forward all the available gas instead.\n\n#### Require the `to` address to be a contract in `setupModules`\n\nIssue: [#483](https://github.com/safe-global/safe-smart-account/issues/483)\n\nThe `setupModules` method was changed to require the `to` address to be a contract. If the `to` address is not a contract, the transaction will revert with a `GS002` error code.\n\n#### Enforce the `dataHash` is equal to `data` in the signature verification process for contract signatures\n\nIssue: [#497](https://github.com/safe-global/safe-smart-account/issues/497)\n\nTo prevent unexpected behaviour, the `dataHash` must now equal a hash of the `data` in the signature verification process for contract signatures. Otherwise, the transaction will revert with a `GS027` error code.\n\n#### Fix `getModulesPaginated` to return a correct `next` pointer\n\nIssue: [#461](https://github.com/safe-global/safe-smart-account/issues/461)\n\nThe `getModulesPaginated` method was fixed to return a correct `next` pointer. The `next` pointer now equals the last module in the returned array.\n\n#### Check the EIP-165 signature of the Guard before adding\n\nIssue: [#309](https://github.com/safe-global/safe-smart-account/issues/309)\n\nWhen setting a guard, the core contract will check that the target address supports the Guard interface with an EIP-165 check. If it doesn't, the transaction will revert with the `GS300` error code.\n\n#### Index essential parameters when emitting events\n\nIssue: [#541](https://github.com/safe-global/safe-smart-account/issues/541)\n\nIndex essential parameters in the essential events, such as:\n\n-   Owner additions and removals (Indexed parameter - owner address)\n-   Fallback manager changes (Indexed parameter - fallback manager address)\n-   Module additions and removals (Indexed parameter - module address)\n-   Transaction guard changes (Indexed parameter - guard address)\n-   Transaction execution/failure (Indexed parameter - transaction hash)\n\n### Factory\n\nUmbrella issue: [#462](https://github.com/safe-global/safe-smart-account/issues/462)\n\n#### Remove the `createProxy` method\n\nThis method uses the `CREATE` opcode, which is not counterfactual for a specific deployment. This caused user errors and lost/stuck funds and is now removed.\n\n#### Add a check that Singleton exists for the initializer call\n\nIf the initializer data is provided, the Factory now checks that the Singleton contract exists and the success of the call to avoid a proxy being deployed uninitialized\n\n#### Add `createChainSpecificProxyWithNonce`\n\nThis method will use the chain id in the `CREATE2` salt; therefore, deploying a proxy to the same address on other networks is impossible.\nThis method should enable the creation of proxies that should exist only on one network (e.g. specific governance or admin accounts)\n\n#### Remove the `calculateProxyAddress` method\n\nMethod uses the revert approach to return data that only works well with some nodes, as they all return messages differently. Hence, we removed it, and the off-chain CREATE2 calculation is still possible.\n\n#### Remove the `proxyRuntimeCode` method\n\nThe `.runtimeCode` method is not supported by the ZkSync compiler, so we removed it.\n\n### Fallback handlers\n\nFiles:\n\n-   [CompatibilityFallbackHandler.sol](https://github.com/safe-global/safe-smart-account/blob/3c3fc80f7f9aef1d39aaae2b53db5f4490051b0d/contracts/handler/CompatibilityFallbackHandler.sol)\n-   [TokenCallbackHandler](https://github.com/safe-global/safe-smart-account/blob/3c3fc80f7f9aef1d39aaae2b53db5f4490051b0d/contracts/handler/TokenCallbackHandler.sol)\n\n#### Rename `DefaultCallbackHandler` to `TokenCallbackHandler`\n\nSince the `DefaultCallbackHandler` only handled token callbacks, it was renamed to `TokenCallbackHandler`.\n\n#### Remove `NAME` and `VERSION` constants\n\nThe `NAME` and `VERSION` constants were removed from the `CompatibilityFallbackHandler` contract.\n\n#### Fix function signature mismatch for `isValidSignature`\n\nIssue: [#440](https://github.com/safe-global/safe-smart-account/issues/440)\n\nFixed mismatch between the function signature in the `isValidSignature` method and the `ISignatureValidator` interface.\n\n### Libraries\n\n#### CreateCall"
    },
    {
      "filename": "[`contracts/libraries/CreateCall.sol`](https://github.com/safe-global/safe-smart-account/blob/3c3fc80f7f9aef1d39aaae2b53db5f4490051b0d/contracts/libraries/CreateCall.sol)",
      "content": "#### Index the created contract address in the `ContractCreation` event\n\nIssue: [#541](https://github.com/safe-global/safe-smart-account/issues/541)\n\nThe deployed contract address in the `ContractCreation` event is now indexed.\n\n### Deployment process\n\n#### Use the Safe Singleton Factory for all deployments\n\nIssue: [#460](https://github.com/safe-global/safe-smart-account/issues/460)\n\nDeployments with the [Safe Singleton Factory](https://github.com/safe-global/safe-singleton-factory) are now the default deployment process to ensure the same addresses on all chains.\n\n# Version 1.3.0-libs.0\n\n## Compiler settings\n\nSolidity compiler: [0.7.6](https://github.com/ethereum/solidity/releases/tag/v0.7.6) (more info see issue [#251](https://github.com/safe-global/safe-smart-account/issues/251))\n\nSolidity optimizer: `disabled`\n\n## Expected addresses with [Deterministic Deployment Proxy](https://github.com/Arachnid/deterministic-deployment-proxy) (default)\n\n### Core contracts\n- `GnosisSafe` at `0xd9Db270c1B5E3Bd161E8c8503c55cEABeE709552`\n- `GnosisSafeL2` at `0x3E5c63644E683549055b9Be8653de26E0B4CD36E`\n### Factory contracts\n- `GnosisSafeProxyFactory` at `0xa6B71E26C5e0845f74c812102Ca7114b6a896AB2`\n### Handler contracts\n- `DefaultCallbackHandler` at `0x1AC114C2099aFAf5261731655Dc6c306bFcd4Dbd`\n- `CompatibilityFallbackHandler` at `0xf48f2B2d2a534e402487b3ee7C18c33Aec0Fe5e4`\n### Lib contracts\n- `MultiSend` at `0xA238CBeb142c10Ef7Ad8442C6D1f9E89e07e7761`\n- `MultiSendCallOnly` at `0x40A2aCCbd92BCA938b02010E17A5b8929b49130D`\n- `CreateCall` at `0x7cbB62EaA69F79e6873cD1ecB2392971036cFAa4`\n- `SignMessageLib` at `0xA65387F16B013cf2Af4605Ad8aA5ec25a2cbA3a2`\n### Storage reader contracts\n- `SimulateTxAccessor` at `0x59AD6735bCd8152B84860Cb256dD9e96b85F69Da`\n\n## Expected addresses with [Safe Singleton Factory](https://github.com/safe-global/safe-singleton-factory)\n\n### Core contracts\n- `GnosisSafe` at `0x69f4D1788e39c87893C980c06EdF4b7f686e2938`\n- `GnosisSafeL2` at `0xfb1bffC9d739B8D520DaF37dF666da4C687191EA`\n### Factory contracts\n- `GnosisSafeProxyFactory` at `0xC22834581EbC8527d974F8a1c97E1bEA4EF910BC`\n### Handler contracts\n- `DefaultCallbackHandler` at `0x3d8E605B02032A941Cfe26897Ca94d77a5BC24b3`\n- `CompatibilityFallbackHandler` at `0x017062a1dE2FE6b99BE3d9d37841FeD19F573804`\n### Lib contracts\n- `MultiSend` at `0x998739BFdAAdde7C933B942a68053933098f9EDa`\n- `MultiSendCallOnly` at `0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B`\n- `CreateCall` at `0xB19D6FFc2182150F8Eb585b79D4ABcd7C5640A9d`\n- `SignMessageLib` at `0x98FFBBF51bb33A056B08ddf711f289936AafF717`\n### Storage reader contracts\n- `SimulateTxAccessor` at `0x727a77a074D1E6c4530e814F89E618a3298FC044`\n\n## Changes \n\n### Deployment process\n\nTo support deployment to networks that require replay protection support for the [Safe Singleton Factory](https://github.com/safe-global/safe-singleton-factory) has been added. This will result in an additional set of deterministic addresses which are listed above.\n\n### Libraries\n\nThe following libraries have been marked as production ready.\n\n#### SignMessageLib"
    },
    {
      "filename": "[`contracts/libraries/SignMessage.sol`](https://github.com/safe-global/safe-smart-account/blob/e57df14ea96dc7dabf93f041c7531f2ab6755c76/contracts/libraries/SignMessage.sol)",
      "content": "Expected behaviour:\n\nThe library is meant as a compatibility tool for the removed `signMessage` function from the pre-1.3.0 Safe contracts. It has the same signature and assumes the same storage layout as the previous Safe contract versions. After calling this function with a massage, the hash of that message should be marked as executed in the `signedMessages` mapping.\n\n#### GnosisSafeStorage"
    },
    {
      "filename": "[`contracts/libraries/GnosisSafeStorage.sol`](https://github.com/safe-global/safe-smart-account/blob/e57df14ea96dc7dabf93f041c7531f2ab6755c76/contracts/libraries/GnosisSafeStorage.sol)",
      "content": "Expected behaviour:\n\nThe contract contains the basic storage layout of the `GnosisSafe.sol` contract and can be used by library contracts to access the storage variables.\n\n# Version 1.3.0\n\n## Compiler settings\n\nSolidity compiler: [0.7.6](https://github.com/ethereum/solidity/releases/tag/v0.7.6) (more info see issue [#251](https://github.com/safe-global/safe-smart-account/issues/251))\n\nSolidity optimizer: `disabled`\n\n## Expected deterministic deployment addresses\n\n### Core contracts\n- `GnosisSafe` at `0xd9Db270c1B5E3Bd161E8c8503c55cEABeE709552`\n- `GnosisSafeL2` at `0x3E5c63644E683549055b9Be8653de26E0B4CD36E`\n### Factory contracts\n- `GnosisSafeProxyFactory` at `0xa6B71E26C5e0845f74c812102Ca7114b6a896AB2`\n### Handler contracts\n- `DefaultCallbackHandler` at `0x1AC114C2099aFAf5261731655Dc6c306bFcd4Dbd`\n- `CompatibilityFallbackHandler` at `0xf48f2B2d2a534e402487b3ee7C18c33Aec0Fe5e4`\n### Lib contracts\n- `MultiSend` at `0xA238CBeb142c10Ef7Ad8442C6D1f9E89e07e7761`\n- `MultiSendCallOnly` at `0x40A2aCCbd92BCA938b02010E17A5b8929b49130D`\n- `CreateCall` at `0x7cbB62EaA69F79e6873cD1ecB2392971036cFAa4`\n### Storage reader contracts\n- `SimulateTxAccessor` at `0x59AD6735bCd8152B84860Cb256dD9e96b85F69Da`\n\n## Changes\n\n### Core contract"
    },
    {
      "filename": "[`contracts/GnosisSafe.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/GnosisSafe.sol)",
      "content": "#### Add chainId to transaction hash\nIssue: [#170](https://github.com/safe-global/safe-smart-account/issues/170)\n\nExpected behaviour:\n\nThe `chainId` has been added to the [EIP-712](https://eips.ethereum.org/EIPS/eip-712) domain. In case of a change of the `chainId` (e.g. hardfork related) the new `chainId` will automatically be used for future signature checks.\n\n#### Add transaction guard\nIssue: [#224](https://github.com/safe-global/safe-smart-account/issues/224)\n\nExpected behaviour:\n\nIt is possible to add a transaction guard, which can check all of the parameters that have been sent to `execTransaction` prior to execution. For this check the `checkTransaction` needs to be implemented by the guard. In case that `checkTransaction` reverts, `execTransaction` will also revert. Another check that can be implemented by the guard is `checkAfterExecution`. This check is called at the very end of the execution and allows to perform checks on the final state of the Safe. The parameters passed to that check are the `safeTxHash` and a `success` boolean.\n\n#### Add StorageAccessible support\nIssue: [#201](https://github.com/safe-global/safe-smart-account/issues/201)\n\nExpected behaviour:\n\nIt is possible to use `simulateDelegatecallInternal` to simulate logic on the Safe by providing a contract and calldata. This contract will then be called via a delegatecall and the result will be returned via a revert.The revert data will have the following format: \n`success:bool || response.length:uint256 || response:bytes`. \n\nImportant: This method will always revert.\n\n#### Remove changeMasterCopy\nExpected behaviour:\n\nIt is not possible anymore to change the singleton address (formerly known as master copy) via a method call. To make the implications of a singleton address change more visible it is required to use a delegatecall with a migration contract. (See example migration in libraries)\n\n#### Make checkSignature public\nIssue: [#248](https://github.com/safe-global/safe-smart-account/issues/248)\n\nExpected behaviour:\n\nThe `checkSignature` method is now a view method that is public. This makes it possible that it can be used in other contracts (e.g. modules) to make it easier to reuse existing signature check logic. The function expects that there are at least enough valid signatures to hit the threshold.\nAnother method that has been added to make the usage from external contracts easier is `checkNSignatures` which allows to set how many valid signatures are expected.\nNote: The storage allocated by `approveHash` will no longer be zeroed when being used in `checkSignature`. If this is required a delegatecall with a contract that zeroes past approved hashes should be used.\n\n#### Remove authorized from requiredTxGas\nIssue: [#247](https://github.com/safe-global/safe-smart-account/issues/247)\n\nExpected behaviour:\n\nTo make it easier to interact with this method (e.g. by providing a wrapper). The requirement that the method can only be called by the Safe itself has been removed. The method will still always revert. \nNote: This method is superseded by the `StorageAccessible` logic and will be removed in the next major version.\n\n#### Move EIP-1271 logic to fallback handler\nIssue: [#223](https://github.com/safe-global/safe-smart-account/issues/223)\n\nExpected behaviour:\n\nAs [EIP-1271](https://eips.ethereum.org/EIPS/eip-1271) is still changing the logic for it has been moved to a fallback handler. The fallback handler uses the `checkSignatures` method to validate the signatures. Also this fallback handler supports the latest version of [EIP-1271](https://eips.ethereum.org/EIPS/eip-1271). The logic to mark a message hash as signed in the contract also has been moved to other contracts. `getMessageHash` has been moved to a fallback handler and `signMessage` into a library that can be used via delegatecall.\nNote: The `checkSignature` method still uses the previous version of [EIP-1271](https://eips.ethereum.org/EIPS/eip-1271) that uses the data to be signed instead of the hash of the data.\n\n#### Send along msg.sender to fallback handler\nIssue: [#246](https://github.com/safe-global/safe-smart-account/issues/246)\n\nExpected behaviour:\n\nWhen the Safe forwards a call to the fallback handler it will append the `msg.sender` to the calldata. This will allow the fallback handler to use this information. \nNote: Fallback handlers should make sure that the connected Safe supports this, else this can be used by the caller to influence the fallback handler (by specifying an arbitrary `msg.sender`)\n\n#### Revert on failure if safeTxGas and gasPrice are 0\nIssue: [#274](https://github.com/safe-global/safe-smart-account/issues/274)\n\nExpected behaviour:\n\nIf `safeTxGas` is 0 (therefore all available gas has been used for the internal tx) and `gasPrice` is also 0 (therefore no refund is involved) the transaction will revert when the internal tx fails. This makes it easier to interact with the Safe without having to estimate the internal transaction ahead of time.\n\n#### Add setup event\nIssue: [#233](https://github.com/safe-global/safe-smart-account/issues/233)\n\nExpected behaviour:\n\nThe Safe now emits an event that contains all setup information that influences the State of the nearly setup Safe. The initializer calldata is omitted to prevent excessive gas costs. And the refund information is omitted as they donâ€™t have an influence on the internal contract state.\n\n#### Add incoming ETH event\nIssue: [#209](https://github.com/safe-global/safe-smart-account/issues/209)\n\nExpected behaviour:\n\nWhen the Safe is receiving ETH it will now trigger an event (with exception of ETH received via a call to `execTransaction` or as a result of a selfdestruct of another contract).\nNote: It will not be possible anymore to send ETH via the solidity calls transfer or send to a Safe. This is expected to break because of the gas costs changes with the Berlin hard fork ([EIP-2929](https://eips.ethereum.org/EIPS/eip-2929)) in any case (even without the event) when using the legacy transaction format. As there is also a new transaction format ([EIP-2930](https://eips.ethereum.org/EIPS/eip-2930)) it is possible to use that together with the correct access list to still execute transfer/ send calls and emit the event.\n\n### Layer 2\n\n#### Add contract version that emits Safe tx information via events"
    },
    {
      "filename": "[`contracts/GnosisSafeL2.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/GnosisSafeL2.sol)",
      "content": "Expected behaviour:\n\nThe extended version will emit an event with all the information related to the Safe transaction that will be executed. As this is quite gas expensive, it is only expected that this version will be used on Layer 2 networks with low gas prices.\nIt is expected that the events are emitted on entry to the method. As the normal Safe methods emit already some events after the execution of the Safe transaction. This will make it possible to connect other events to that call as they are \"boxed\" by the GnosisSafeL2 events and the GnosisSafe events.\n\nExample:\n\nOn entry into `execTransaction` of the `GnosisSafeL2` contract a `SafeMultiSigTransaction` event will be emitted that contains all the parameters of the function and the `nonce`, `msg.sender` and `threshold`. Once the internal execution has finished the `execTransaction` of the `GnosisSafe` contract will emit a `ExecutionSuccess` or `ExecutionFailure` event. When processing the events of that transaction it is now possible to connect all events that were emitted between these two events to this specific Safe transaction.\nSame can be done with the `SafeModuleTransaction` and `ExecutionFromModuleSuccess` (or `ExecutionFromModuleFailure`) events when executing a transaction via a module.\n\n### Fallback handlers\n\n#### Add EIP-165 support to DefaultCallbackHandler\nIssue: [#161](https://github.com/safe-global/safe-smart-account/issues/161)"
    },
    {
      "filename": "[`contracts/handler/DefaultCallbackHandler.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/handler/DefaultCallbackHandler.sol)",
      "content": "Expected behaviour:\n\nIndicate via the `supportsInterface` method of [EIP-165](https://eips.ethereum.org/EIPS/eip-165) that the [EIP-721](https://eips.ethereum.org/EIPS/eip-721) and [EIP-1155](https://eips.ethereum.org/EIPS/eip-1155) receiver interfaces are supported. \n\n#### Add CompatibilityFallbackHandler\nIssue: [#223](https://github.com/safe-global/safe-smart-account/issues/223)"
    },
    {
      "filename": "[`contracts/handler/CompatibilityFallbackHandler.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/handler/CompatibilityFallbackHandler.sol)",
      "content": "Expected behaviour:\n\nThe `CompatibilityFallbackHandler` extends the `DefaultCallbackHandler` and implements support for some logic that has been removed from the core contracts. Namely [EIP-1271](https://eips.ethereum.org/EIPS/eip-1271) support and the non reverting method of the `StorageAccessible` contract. Also the fallback manager contains the logic to verify Safe messages.\n\n#### Add possibility to get sender in fallback handler"
    },
    {
      "filename": "[`contracts/handler/HandlerContext.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/handler/HandlerContext.sol)",
      "content": "Expected behaviour:\n\nThe `HandlerContext` can be used to retrieve the `msg.sender` and the Safe (aka manager) that have been forwarding the call to the fallback handler. The `msg.sender` is expected to be appended to the calldata (e.g. last 20 bytes). This will only work if used with a Safe contract that supports this (e.g. 1.3.0 or newer).\n\n### Guard\n\n#### Add DelegateCallTransactionGuard"
    },
    {
      "filename": "[`contracts/examples/guards/DelegateCallTransactionGuard.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/examples/guards/DelegateCallTransactionGuard.sol)",
      "content": "Note: **This contract is meant as an example to demonstrate how to facilitate a guard. This should not be used in production without further checks.**\n\nExpected behaviour:\n\nThis transaction guard can be used to prevent that Safe transactions that use a delegatecall operation are being executed. It is also possible to specify an exception when deploying the contract (e.g. a `MultiSendCallOnly` instance).\n\n#### Add DebugTransactionGuard"
    },
    {
      "filename": "[`contracts/examples/guards/DebugTransactionGuard.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/examples/guards/DebugTransactionGuard.sol)",
      "content": "Note: **This contract is meant as an example to demonstrate how to facilitate a guard. This should not be used in production without further checks.**\n\nExpected behaviour:\n\nThis transaction guard can be used to log more details about a transaction. This is similar to what the L2 version of the Safe does, but implemented as a transaction guard. One event will be emitted containing the transaction details and another to track the status of a specific nonce.\n\n#### Add ReentrancyTransactionGuard"
    },
    {
      "filename": "[`contracts/examples/guards/ReentrancyTransactionGuard.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/examples/guards/ReentrancyTransactionGuard.sol)",
      "content": "Note: **This contract is meant as an example to demonstrate how to facilitate a guard. This should not be used in production without further checks.**\n\nExpected behaviour:\n\nThis transaction guard can be used to prevent that Safe transactions can re-enter the `execTransaction` method. The transaction guard does not differentiate between different Safes, so if multiple Safes use the same guard instance it prevents reentrancy in all of the connected Safes.\n\n### Libraries\n\n#### Make multiSend payable to avoid check on msg.value\nIssue: [#227](https://github.com/safe-global/safe-smart-account/issues/227)"
    },
    {
      "filename": "[`contracts/libraries/MultiSend.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/libraries/MultiSend.sol)",
      "content": "Expected behaviour:\n\nThe `multiSend` is now payable therefore will enforce anymore that `msg.value` is 0. ETH that is not transferred out again will remain in `this` (the calling contract when used via a delegatecall or the contract when used via call, only possible with `MultiSendCallOnly`)\n\n#### Add MuliSend that disallows delegate operation"
    },
    {
      "filename": "[`contracts/libraries/MultiSendCallOnly.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/libraries/MultiSendCallOnly.sol)",
      "content": "Expected behaviour:\n\nThe logic is the same as for the normal `MultiSend`, but when an attempt is made to execute a transaction via a delegatecall the contract will revert.\nNote: The encoding of the data send to the `multiSend` method is exactly the same as for the normal `MultiSend`, this makes it easy to exchange the contracts depending on the use case.\n\n#### Add base contract for Safe storage layout"
    },
    {
      "filename": "[`contracts/examples/libraries/GnosisSafeStorage.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/examples/libraries/GnosisSafeStorage.sol)",
      "content": "Note: **This contract is meant as an example to demonstrate how to access the Safe state within a library contract. This should not be used in production without further checks.**\n\nExpected behaviour:\n\nThe contract contains the basic storage layout of the `GnosisSafe.sol` contract.\n\n#### Add contract to mark Safe messages as signed"
    },
    {
      "filename": "[`contracts/examples/libraries/SignMessage.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/examples/libraries/SignMessage.sol)",
      "content": "Note: **This contract is meant as an example to demonstrate how to mark Safe message as signed in the signedMessages mapping. This should not be used in production without further checks.**\n\nExpected behaviour:\n\nThe library is meant as a compatibility tool for the removed `signMessage` function from the pre-1.3.0 Safe contracts. It has the same signature and assumes the same storage layout as the previous Safe contract versions. After calling this function with a massage, the hash of that message should be marked as executed in the `signedMessages` mapping.\n\n#### Add Migration example to downgrade from 1.3.0 to 1.2.0"
    },
    {
      "filename": "[`contracts/examples/libraries/Migrate_1_3_0_to_1_2_0.sol`](https://github.com/safe-global/safe-smart-account/blob/ad6c7355d5bdf4f7fa348fbfcb9f07431769a3c9/contracts/examples/libraries/Migrate_1_3_0_to_1_2_0.sol)",
      "content": "Note: **This contract is meant as an example to demonstrate how to facilitate migration in the future. This should not be used in production without further checks.**\n\nExpected behaviour:\n\nThis migration can be used to migrate a Safe to another singleton address. Once the migration has been executed the singleton address will point to the address specified in the constructor of the migration and the domain separator will be properly set in storage (as this is required by the 1.2.0 version of the Safe contracts).\nNote: This is meant as an example contract, only to be used in production if you know what you do."
    }
  ]
}