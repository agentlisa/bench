{
  "Title": "Use of block numbers to express moments inÂ time",
  "Content": "Implementors of the [`TermsContracts`](https://github.com/dharmaprotocol/charta/blob/b110959477cf37375bf7e9344d40eb85219c8575/contracts/TermsContract.sol) interface are expected to define repayment terms as a function of block numbers, as documented and seen in the function signatures of [`getExpectedRepaymentValue`](https://github.com/dharmaprotocol/charta/blob/b110959477cf37375bf7e9344d40eb85219c8575/contracts/TermsContract.sol#L63) and [`getValueRepaid`](https://github.com/dharmaprotocol/charta/blob/b110959477cf37375bf7e9344d40eb85219c8575/contracts/TermsContract.sol#L72). To aid in this, entries in [`DebtRegistry`](https://github.com/dharmaprotocol/charta/blob/b110959477cf37375bf7e9344d40eb85219c8575/contracts/DebtRegistry.sol) record the issuance block number.\n\n\nBlock timestamps have a small risk of miner manipulation within a range of minutes, so it is recommended to use block numbers for certain usecases where this manipulation is a security risk. It should be noted, however, that [block times are not fixed](https://etherscan.io/chart/blocktime), and thus block numbers are not a reliable unit of time. For example, the constant [`SEVEN_DAYS_IN_BLOCKS`](https://github.com/dharmaprotocol/charta/blob/b110959477cf37375bf7e9344d40eb85219c8575/contracts/examples/NFTTermsContract.sol#L28) will not always represent the timespan of seven days that it is meant to.\n\n\nFor the specific use case of determining repayment dates we think that the predictability of timestamps is preferable, and that it does not compromise the security of the system. Consider changing interfaces and data structures to use timestamps instead of block numbers.\n\n\n***Update:** Changed to timestamps in [`d4dc030`](https://github.com/dharmaprotocol/charta/commit/d4dc030d54b8bff0e4def92619e4aeaf9eaed000).*\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/examples/NFTTermsContract.sol",
      "content": "/*\n\n  Copyright 2017 Dharma Labs Inc.\n\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n\n*/\n\npragma solidity 0.4.18;\n\nimport \"zeppelin-solidity/contracts/math/SafeMath.sol\";\nimport \"../DebtRegistry.sol\";\n\n\ncontract NFTTermsContract {\n    using SafeMath for uint;\n\n    uint public constant SEVEN_DAYS_IN_BLOCKS = 42300;\n\n    mapping (bytes32 => bool) debtRepaid;\n    mapping (bytes32 => mapping (uint => bool)) principalNFTsRepaid;\n\n    DebtRegistry debtRegistry;\n\n    address public repaymentPrincipalNFT;\n    address public repaymentRouter;\n\n    function NFTTermsContract(\n        address _debtRegistry,\n        address _repaymentPrincipalNFT,\n        address _repaymentRouter\n    )\n        public\n    {\n        debtRegistry = DebtRegistry(_debtRegistry);\n\n        repaymentPrincipalNFT = _repaymentPrincipalNFT;\n        repaymentRouter = _repaymentRouter;\n    }\n\n    function registerNFTRepayment(\n        bytes32 agreementId,\n        address payer,\n        address beneficiary,\n        uint256 tokenId,\n        address tokenAddress\n    )\n        public\n        returns (bool _success)\n    {\n        if (msg.sender != repaymentRouter) {\n            return false;\n        }\n\n        if (tokenAddress == repaymentPrincipalNFT) {\n            principalNFTsRepaid[agreementId][tokenId] = true;\n        }\n\n        return true;\n    }\n\n    function getExpectedRepaymentValue(\n        bytes32 agreementId,\n        uint256 blockNumber\n    )\n        public\n        view\n        returns (uint _expectedRepaymentValue)\n    {\n        if (debtRegistry.getIssuanceBlockNumber(agreementId).add(SEVEN_DAYS_IN_BLOCKS) < blockNumber) {\n            return 1;\n        } else {\n            return 0;\n        }\n    }\n\n    function getValueRepaid(\n        bytes32 agreementId,\n        uint256 blockNumber\n    )\n        public\n        view\n        returns (uint _valueRepaid)\n    {\n        uint tokenId = uint(debtRegistry.getTermsContractParameters(agreementId));\n\n        return principalNFTsRepaid[agreementId][tokenId] ? 1 : 0;\n    }\n}"
    }
  ]
}