{
  "Title": "[12] Comment and doc spec mismatch",
  "Content": "On https://www.desmos.com/calculator/im67z1tate, the integral of price is supposed to be `p(x) = p0 * (1 - k)^(t - x/r)`. However, the exponent varies on the formula adopted by the protocol:\n\nhttps://github.com/code-423n4/2023-12-revolutionprotocol/blob/main/packages/revolution/src/libs/VRGDAC.sol#L85\n\n```solidity\n    // given # of tokens sold, returns integral of price p(x) = p0 * (1 - k)^(x/r) \n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2023-12-revolutionprotocol",
  "Code": [
    {
      "filename": "packages/revolution/src/libs/VRGDAC.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.22;\n\nimport { wadExp, wadLn, wadMul, wadDiv, unsafeWadDiv, wadPow } from \"./SignedWadMath.sol\";\n\n/// @title Continuous Variable Rate Gradual Dutch Auction\n/// @author transmissions11 <t11s@paradigm.xyz>\n/// @author FrankieIsLost <frankie@paradigm.xyz>\n/// @author Dan Robinson <dan@paradigm.xyz>\n/// @notice Sell tokens roughly according to an issuance schedule.\ncontract VRGDAC {\n    /*//////////////////////////////////////////////////////////////\n                            VRGDA PARAMETERS\n    //////////////////////////////////////////////////////////////*/\n\n    int256 public immutable targetPrice;\n\n    int256 public immutable perTimeUnit;\n\n    int256 public immutable decayConstant;\n\n    int256 public immutable priceDecayPercent;\n\n    /// @notice Sets target price and per time unit price decay for the VRGDA.\n    /// @param _targetPrice The target price for a token if sold on pace, scaled by 1e18.\n    /// @param _priceDecayPercent The percent price decays per unit of time with no sales, scaled by 1e18.\n    /// @param _perTimeUnit The number of tokens to target selling in 1 full unit of time, scaled by 1e18.\n    constructor(int256 _targetPrice, int256 _priceDecayPercent, int256 _perTimeUnit) {\n        targetPrice = _targetPrice;\n\n        perTimeUnit = _perTimeUnit;\n\n        priceDecayPercent = _priceDecayPercent;\n\n        decayConstant = wadLn(1e18 - _priceDecayPercent);\n\n        // The decay constant must be negative for VRGDAs to work.\n        require(decayConstant < 0, \"NON_NEGATIVE_DECAY_CONSTANT\");\n    }\n\n    /*//////////////////////////////////////////////////////////////\n                              PRICING LOGIC\n    //////////////////////////////////////////////////////////////*/\n\n    // y to pay\n    // given # of tokens sold and # to buy, returns amount to pay\n    function xToY(int256 timeSinceStart, int256 sold, int256 amount) public view virtual returns (int256) {\n        unchecked {\n            return pIntegral(timeSinceStart, sold + amount) - pIntegral(timeSinceStart, sold);\n        }\n    }\n\n    // given amount to pay and amount sold so far, returns # of tokens to sell - raw form\n    function yToX(int256 timeSinceStart, int256 sold, int256 amount) public view virtual returns (int256) {\n        int256 soldDifference = wadMul(perTimeUnit, timeSinceStart) - sold;\n        unchecked {\n            return\n                wadMul(\n                    perTimeUnit,\n                    wadDiv(\n                        wadLn(\n                            wadDiv(\n                                wadMul(\n                                    targetPrice,\n                                    wadMul(\n                                        perTimeUnit,\n                                        wadExp(wadMul(soldDifference, wadDiv(decayConstant, perTimeUnit)))\n                                    )\n                                ),\n                                wadMul(\n                                    targetPrice,\n                                    wadMul(\n                                        perTimeUnit,\n                                        wadPow(1e18 - priceDecayPercent, wadDiv(soldDifference, perTimeUnit))\n                                    )\n                                ) - wadMul(amount, decayConstant)\n                            )\n                        ),\n                        decayConstant\n                    )\n                );\n        }\n    }\n\n    // given # of tokens sold, returns integral of price p(x) = p0 * (1 - k)^(x/r)\n    function pIntegral(int256 timeSinceStart, int256 sold) internal view returns (int256) {\n        return\n            wadDiv(\n                -wadMul(\n                    wadMul(targetPrice, perTimeUnit),\n                    wadPow(1e18 - priceDecayPercent, timeSinceStart - unsafeWadDiv(sold, perTimeUnit)) -\n                        wadPow(1e18 - priceDecayPercent, timeSinceStart)\n                ),\n                decayConstant\n            );\n    }\n}"
    }
  ]
}