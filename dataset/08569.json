{
  "Title": "[M-09] Unhandled chainlink revert would lock all price oracle access",
  "Content": "# Lines of code\n\nhttps://github.com/jbx-protocol/juice-contracts-v2-code4rena/blob/828bf2f3e719873daa08081cfa0d0a6deaa5ace5/contracts/JBChainlinkV3PriceFeed.sol#L44\n\n\n# Vulnerability details\n\n## Impact\n\nCall to `latestRoundData` could potentially revert and make it impossible to query any prices. Feeds cannot be changed after they are configured (https://github.com/jbx-protocol/juice-contracts-v2-code4rena/blob/828bf2f3e719873daa08081cfa0d0a6deaa5ace5/contracts/JBPrices.sol#L115) so this would result in a permanent denial of service.\n\n## Proof of Concept\n\nChainlink's multisigs can immediately block access to price feeds at will. Therefore, to prevent denial of service scenarios, it is recommended to query Chainlink price feeds using a defensive approach with Solidityâ€™s try/catch structure. In this way, if the call to the price feed fails, the caller contract is still in control and can handle any errors safely and explicitly.\n\nhttps://github.com/jbx-protocol/juice-contracts-v2-code4rena/blob/828bf2f3e719873daa08081cfa0d0a6deaa5ace5/contracts/JBPrices.sol#L69\n\n```\nif (_feed != IJBPriceFeed(address(0))) return _feed.currentPrice(_decimals);\n```\n\nhttps://github.com/jbx-protocol/juice-contracts-v2-code4rena/blob/828bf2f3e719873daa08081cfa0d0a6deaa5ace5/contracts/JBChainlinkV3PriceFeed.sol#L42-L44\n\n```\nfunction currentPrice(uint256 _decimals) external view override returns (uint256) {\n  // Get the latest round information. Only need the price is needed.\n  (, int256 _price, , , ) = feed.latestRoundData();\n```\n\nRefer to https://blog.openzeppelin.com/secure-smart-contract-guidelines-the-dangers-of-price-oracles/ for more information regarding potential risks to account for when relying on external price feed providers.\n\n## Tools Used\n\nvim\n\n## Recommended Mitigation Steps\n\nSurround the call to `latestRoundData()` with `try/catch` instead of calling it directly. In a scenario where the call reverts, the catch block can be used to call a fallback oracle or handle the error in any other suitable way.\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/contests/2022-07-juicebox-v2-contest",
  "Code": [
    {
      "filename": "contracts/JBChainlinkV3PriceFeed.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.6;\n\nimport '@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol';\nimport './interfaces/IJBPriceFeed.sol';\nimport './libraries/JBFixedPointNumber.sol';\n\n/** \n  @notice \n  A generalized price feed for the Chainlink AggregatorV3Interface.\n\n  @dev\n  Adheres to -\n  IJBPriceFeed: General interface for the methods in this contract that interact with the blockchain's state according to the protocol's rules.\n*/\ncontract JBChainlinkV3PriceFeed is IJBPriceFeed {\n  // A library that provides utility for fixed point numbers.\n  using JBFixedPointNumber for uint256;\n\n  //*********************************************************************//\n  // --------------------- public stored properties -------------------- //\n  //*********************************************************************//\n\n  /** \n    @notice \n    The feed that prices are reported from.\n  */\n  AggregatorV3Interface public feed;\n\n  //*********************************************************************//\n  // ------------------------- external views -------------------------- //\n  //*********************************************************************//\n\n  /** \n    @notice \n    Gets the current price from the feed, normalized to the specified number of decimals.\n\n    @param _decimals The number of decimals the returned fixed point price should include.\n\n    @return The current price of the feed, as a fixed point number with the specified number of decimals.\n  */\n  function currentPrice(uint256 _decimals) external view override returns (uint256) {\n    // Get the latest round information. Only need the price is needed.\n    (, int256 _price, , , ) = feed.latestRoundData();\n\n    // Get a reference to the number of decimals the feed uses.\n    uint256 _feedDecimals = feed.decimals();\n\n    // Return the price, adjusted to the target decimals.\n    return uint256(_price).adjustDecimals(_feedDecimals, _decimals);\n  }\n\n  //*********************************************************************//\n  // -------------------------- constructor ---------------------------- //\n  //*********************************************************************//\n\n  /** \n    @param _feed The feed to report prices from.\n  */\n  constructor(AggregatorV3Interface _feed) {\n    feed = _feed;\n  }\n}"
    }
  ]
}