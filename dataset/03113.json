{
  "Title": "Malicious user can register a scanner under any owner",
  "Content": "The [`ScannerRegistryCore` contract](https://github.com/forta-protocol/forta-token/blob/92d7a7ddd6672a7530a4bfc532d0d697e7f12744/contracts/components/scanners/ScannerRegistryCore.sol#L8) implements the functionality to allow the registration and minting of new scanners.\n\n\nNew scanners are meant to be registered by either calling the [`register` function](https://github.com/forta-protocol/forta-token/blob/92d7a7ddd6672a7530a4bfc532d0d697e7f12744/contracts/components/scanners/ScannerRegistryCore.sol#L27) from the scanner’s address or through the trusted forwarder, or by the admin when calling the [`adminRegister` function](https://github.com/forta-protocol/forta-token/blob/92d7a7ddd6672a7530a4bfc532d0d697e7f12744/contracts/components/scanners/ScannerRegistryCore.sol#L19). These functions then call the [`_register` function](https://github.com/forta-protocol/forta-token/blob/92d7a7ddd6672a7530a4bfc532d0d697e7f12744/contracts/components/scanners/ScannerRegistryCore.sol#L31) which implements the rest of the registration.\n\n\nHowever, this `_register` function is marked as a `public` function, meaning that any user could skip the checks and register a scanner in the same way as the admin does it.\n\n\nIn favor of restricting the admin functionalities to regular users, consider changing the visibility of the `_register` function to `internal`.\n\n\n***Update:** Fixed on [commit `11bb25a9034f19be44315203713bf94d138698b8` in pull request 49](https://github.com/forta-protocol/forta-token/pull/49/commits/11bb25a9034f19be44315203713bf94d138698b8).*\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/components/scanners/ScannerRegistryCore.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol\";\n\nimport \"../BaseComponentUpgradeable.sol\";\n\nabstract contract ScannerRegistryCore is\n    BaseComponentUpgradeable,\n    ERC721Upgradeable\n{\n    event ScannerUpdated(uint256 indexed scannerId, uint256 indexed chainId, string metadata);\n\n    modifier onlyOwnerOf(uint256 scannerId) {\n        require(_msgSender() == ownerOf(scannerId), \"ScannerRegistryCore: Restricted to scanner owner\");\n        _;\n    }\n\n    function adminRegister(address scanner, address owner, uint256 chainId, string calldata metadata) public onlyRole(SCANNER_ADMIN_ROLE) {\n        _register(scanner, owner, chainId, metadata);\n    }\n\n    function isRegistered(uint256 scannerId) public view returns(bool) {\n        return _exists(scannerId);\n    }\n\n    function register(address owner, uint256 chainId, string calldata metadata) virtual public {\n        _register(_msgSender(), owner, chainId, metadata);\n    }\n\n    function _register(address scanner, address owner, uint256 chainId, string calldata metadata) public {\n        uint256 scannerId = scannerAddressToId(scanner);\n        _mint(owner, scannerId);\n\n        _beforeScannerUpdate(scannerId, chainId, metadata);\n        _scannerUpdate(scannerId, chainId, metadata);\n        _afterScannerUpdate(scannerId, chainId, metadata);\n    }\n\n    function adminUpdate(address scanner, uint256 chainId, string calldata metadata) public onlyRole(SCANNER_ADMIN_ROLE) {\n        uint256 scannerId = scannerAddressToId(scanner);\n        require(isRegistered(scannerId), \"ScannerRegistryCore: scanner must be registered\");\n        _beforeScannerUpdate(scannerId, chainId, metadata);\n        _scannerUpdate(scannerId, chainId, metadata);\n        _afterScannerUpdate(scannerId, chainId, metadata);\n    }\n\n    function scannerAddressToId(address scanner) public pure returns(uint256) {\n        return uint256(uint160(scanner));\n    }\n\n    /**\n     * Hook: Scanner metadata change (create)\n     */\n    function _beforeScannerUpdate(uint256 scannerId, uint256 chainId, string calldata metadata) internal virtual {\n    }\n\n    function _scannerUpdate(uint256 scannerId, uint256 chainId, string calldata metadata) internal virtual {\n        emit ScannerUpdated(scannerId, chainId, metadata);\n    }\n\n    function _afterScannerUpdate(uint256 scannerId, uint256 chainId, string calldata metadata) internal virtual {\n        _emitHook(abi.encodeWithSignature(\"hook_afterScannerUpdate(uint256)\", scannerId));\n    }\n\n\n    function _msgSender() internal view virtual override(ContextUpgradeable, BaseComponentUpgradeable) returns (address sender) {\n        return super._msgSender();\n    }\n\n    function _msgData() internal view virtual override(ContextUpgradeable, BaseComponentUpgradeable) returns (bytes calldata) {\n        return super._msgData();\n    }\n\n    uint256[50] private __gap;\n}"
    },
    {
      "filename": "contracts/components/scanners/ScannerRegistryCore.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol\";\n\nimport \"../BaseComponentUpgradeable.sol\";\n\nabstract contract ScannerRegistryCore is\n    BaseComponentUpgradeable,\n    ERC721Upgradeable\n{\n    event ScannerUpdated(uint256 indexed scannerId, uint256 indexed chainId, string metadata);\n\n    modifier onlyOwnerOf(uint256 scannerId) {\n        require(_msgSender() == ownerOf(scannerId), \"ScannerRegistryCore: Restricted to scanner owner\");\n        _;\n    }\n\n    function adminRegister(address scanner, address owner, uint256 chainId, string calldata metadata) public onlyRole(SCANNER_ADMIN_ROLE) {\n        _register(scanner, owner, chainId, metadata);\n    }\n\n    function isRegistered(uint256 scannerId) public view returns(bool) {\n        return _exists(scannerId);\n    }\n\n    function register(address owner, uint256 chainId, string calldata metadata) virtual public {\n        _register(_msgSender(), owner, chainId, metadata);\n    }\n\n    function _register(address scanner, address owner, uint256 chainId, string calldata metadata) public {\n        uint256 scannerId = scannerAddressToId(scanner);\n        _mint(owner, scannerId);\n\n        _beforeScannerUpdate(scannerId, chainId, metadata);\n        _scannerUpdate(scannerId, chainId, metadata);\n        _afterScannerUpdate(scannerId, chainId, metadata);\n    }\n\n    function adminUpdate(address scanner, uint256 chainId, string calldata metadata) public onlyRole(SCANNER_ADMIN_ROLE) {\n        uint256 scannerId = scannerAddressToId(scanner);\n        require(isRegistered(scannerId), \"ScannerRegistryCore: scanner must be registered\");\n        _beforeScannerUpdate(scannerId, chainId, metadata);\n        _scannerUpdate(scannerId, chainId, metadata);\n        _afterScannerUpdate(scannerId, chainId, metadata);\n    }\n\n    function scannerAddressToId(address scanner) public pure returns(uint256) {\n        return uint256(uint160(scanner));\n    }\n\n    /**\n     * Hook: Scanner metadata change (create)\n     */\n    function _beforeScannerUpdate(uint256 scannerId, uint256 chainId, string calldata metadata) internal virtual {\n    }\n\n    function _scannerUpdate(uint256 scannerId, uint256 chainId, string calldata metadata) internal virtual {\n        emit ScannerUpdated(scannerId, chainId, metadata);\n    }\n\n    function _afterScannerUpdate(uint256 scannerId, uint256 chainId, string calldata metadata) internal virtual {\n        _emitHook(abi.encodeWithSignature(\"hook_afterScannerUpdate(uint256)\", scannerId));\n    }\n\n\n    function _msgSender() internal view virtual override(ContextUpgradeable, BaseComponentUpgradeable) returns (address sender) {\n        return super._msgSender();\n    }\n\n    function _msgData() internal view virtual override(ContextUpgradeable, BaseComponentUpgradeable) returns (bytes calldata) {\n        return super._msgData();\n    }\n\n    uint256[50] private __gap;\n}"
    }
  ]
}