{
  "Title": "[G-17]  Functions guaranteed to revert when called by normal users can be marked ",
  "Content": "<h2 id=\"g-17--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g-17--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g 17  functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-17]  Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost</p>\n<p><em>There are 32 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">gateway</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BridgeEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_controller</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyImpl</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">28</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">approveAll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">36</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">revokeAll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/gateway/BridgeEscrow.sol#L20\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/gateway/BridgeEscrow.sol#L20</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">gateway</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GraphTokenGateway</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPauseGuardian</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newPauseGuardian</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPaused</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newPaused</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernorOrGuardian</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/gateway/GraphTokenGateway.sol#L30\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/gateway/GraphTokenGateway.sol#L30</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">gateway</span><span class=\"mtk1\">/</span><span class=\"mtk12\">L1GraphTokenGateway</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_controller</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyImpl</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setArbitrumAddresses</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_inbox</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_l1Router</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setL2TokenAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_l2GRT</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setL2CounterpartAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_l2Counterpart</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setEscrowAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_escrow</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addToCallhookWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newWhitelisted</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeFromCallhookWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_notWhitelisted</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/gateway/L1GraphTokenGateway.sol#L99\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/gateway/L1GraphTokenGateway.sol#L99</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newGovernor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/governance/Governed.sol#L40\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/governance/Governed.sol#L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Managed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setController</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_controller</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyController</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/governance/Managed.sol#L95\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/governance/Managed.sol#L95</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">l2</span><span class=\"mtk1\">/</span><span class=\"mtk12\">gateway</span><span class=\"mtk1\">/</span><span class=\"mtk12\">L2GraphTokenGateway</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_controller</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyImpl</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">97</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setL2Router</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_l2Router</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setL1TokenAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_l1GRT</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setL1CounterpartAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_l1Counterpart</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/l2/gateway/L2GraphTokenGateway.sol#L87\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/l2/gateway/L2GraphTokenGateway.sol#L87</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">l2</span><span class=\"mtk1\">/</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GraphTokenUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addMinter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeMinter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyMinter</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/l2/token/GraphTokenUpgradeable.sol#L105\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/l2/token/GraphTokenUpgradeable.sol#L105</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">l2</span><span class=\"mtk1\">/</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">L2GraphToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyImpl</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setGateway</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gw</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setL1Address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bridgeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGateway</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bridgeBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGateway</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/l2/token/L2GraphToken.sol#L48\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/l2/token/L2GraphToken.sol#L48</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrades</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GraphProxyAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeProxyAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IGraphProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newAdmin</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">77</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">upgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IGraphProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_implementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">GraphUpgradeable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_implementation</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IGraphProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">        </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptProxyAndCall</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">97            </span><span class=\"mtk12\">GraphUpgradeable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_implementation</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">98            </span><span class=\"mtk12\">IGraphProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">99            </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">100:      ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/upgrades/GraphProxyAdmin.sol#L68\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/upgrades/GraphProxyAdmin.sol#L68</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgrades</span><span class=\"mtk1\">/</span><span class=\"mtk12\">GraphUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IGraphProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyProxyAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">        </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptProxyAndCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IGraphProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">60            </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">61:           </span><span class=\"mtk11\">onlyProxyAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/upgrades/GraphUpgradeable.sol#L50\">https://github.com/code-423n4/2022-10-thegraph/blob/48e7c7cf641847e07ba07e01176cb17ba8ad6432/contracts/upgrades/GraphUpgradeable.sol#L50</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-thegraph-findings/issues/117#issuecomment-1287387040\">tmigone (The Graph) commented</a>:</strong></p>\n<blockquote>\n<p>Weâ€™ve found this submission to be of high quality.</p>\n</blockquote>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<p><em>Mitigation review by Trust</em></p>\n<p><strong>Project repository:</strong> <a href=\"https://github.com/graphprotocol/contracts\">https://github.com/graphprotocol/contracts</a><br></p>\n<p><strong>Review commit:</strong> caf5ab5723353b9062878ade247a060a2b55514f<br></p>\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/contests/2022-10-the-graph-l2-bridge-contest",
  "Code": [
    {
      "filename": "contracts/gateway/BridgeEscrow.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n\npragma solidity ^0.7.6;\n\nimport \"../upgrades/GraphUpgradeable.sol\";\nimport \"../governance/Managed.sol\";\nimport \"../token/IGraphToken.sol\";\n\n/**\n * @title Bridge Escrow\n * @dev This contracts acts as a gateway for an L2 bridge (or several). It simply holds GRT and has\n * a set of spenders that can transfer the tokens; the L1 side of each L2 bridge has to be\n * approved as a spender.\n */\ncontract BridgeEscrow is GraphUpgradeable, Managed {\n    /**\n     * @dev Initialize this contract.\n     * @param _controller Address of the Controller that manages this contract\n     */\n    function initialize(address _controller) external onlyImpl {\n        Managed._initialize(_controller);\n    }\n\n    /**\n     * @dev Approve a spender (i.e. a bridge that manages the GRT funds held by the escrow)\n     * @param _spender Address of the spender that will be approved\n     */\n    function approveAll(address _spender) external onlyGovernor {\n        graphToken().approve(_spender, type(uint256).max);\n    }\n\n    /**\n     * @dev Revoke a spender (i.e. a bridge that will no longer manage the GRT funds held by the escrow)\n     * @param _spender Address of the spender that will be revoked\n     */\n    function revokeAll(address _spender) external onlyGovernor {\n        IGraphToken grt = graphToken();\n        grt.decreaseAllowance(_spender, grt.allowance(address(this), _spender));\n    }\n}"
    },
    {
      "filename": "contracts/gateway/GraphTokenGateway.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n\npragma solidity ^0.7.6;\n\nimport \"../upgrades/GraphUpgradeable.sol\";\nimport \"../arbitrum/ITokenGateway.sol\";\nimport \"../governance/Pausable.sol\";\nimport \"../governance/Managed.sol\";\n\n/**\n * @title L1/L2 Graph Token Gateway\n * @dev This includes everything that's shared between the L1 and L2 sides of the bridge.\n */\nabstract contract GraphTokenGateway is GraphUpgradeable, Pausable, Managed, ITokenGateway {\n    /**\n     * @dev Check if the caller is the Controller's governor or this contract's pause guardian.\n     */\n    modifier onlyGovernorOrGuardian() {\n        require(\n            msg.sender == controller.getGovernor() || msg.sender == pauseGuardian,\n            \"Only Governor or Guardian can call\"\n        );\n        _;\n    }\n\n    /**\n     * @notice Change the Pause Guardian for this contract\n     * @param _newPauseGuardian The address of the new Pause Guardian\n     */\n    function setPauseGuardian(address _newPauseGuardian) external onlyGovernor {\n        require(_newPauseGuardian != address(0), \"PauseGuardian must be set\");\n        _setPauseGuardian(_newPauseGuardian);\n    }\n\n    /**\n     * @dev Override the default pausing from Managed to allow pausing this\n     * particular contract instead of pausing from the Controller.\n     */\n    function _notPaused() internal view override {\n        require(!_paused, \"Paused (contract)\");\n    }\n\n    /**\n     * @notice Change the paused state of the contract\n     * @param _newPaused New value for the pause state (true means the transfers will be paused)\n     */\n    function setPaused(bool _newPaused) external onlyGovernorOrGuardian {\n        _setPaused(_newPaused);\n    }\n\n    /**\n     * @notice Getter to access paused state of this contract\n     */\n    function paused() external view returns (bool) {\n        return _paused;\n    }\n}"
    },
    {
      "filename": "contracts/gateway/L1GraphTokenGateway.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n\npragma solidity ^0.7.6;\npragma abicoder v2;\n\nimport \"@openzeppelin/contracts/utils/Address.sol\";\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\n\nimport \"../arbitrum/L1ArbitrumMessenger.sol\";\nimport \"./GraphTokenGateway.sol\";\n\n/**\n * @title L1 Graph Token Gateway Contract\n * @dev Provides the L1 side of the Ethereum-Arbitrum GRT bridge. Sends GRT to the L2 chain\n * by escrowing them and sending a message to the L2 gateway, and receives tokens from L2 by\n * releasing them from escrow.\n * Based on Offchain Labs' reference implementation and Livepeer's arbitrum-lpt-bridge\n * (See: https://github.com/OffchainLabs/arbitrum/tree/master/packages/arb-bridge-peripherals/contracts/tokenbridge\n * and https://github.com/livepeer/arbitrum-lpt-bridge)\n */\ncontract L1GraphTokenGateway is GraphTokenGateway, L1ArbitrumMessenger {\n    using SafeMath for uint256;\n\n    // Address of the Graph Token contract on L2\n    address public l2GRT;\n    // Address of the Arbitrum Inbox\n    address public inbox;\n    // Address of the Arbitrum Gateway Router on L1\n    address public l1Router;\n    // Address of the L2GraphTokenGateway on L2 that is the counterpart of this gateway\n    address public l2Counterpart;\n    // Address of the BridgeEscrow contract that holds the GRT in the bridge\n    address public escrow;\n    // Addresses for which this mapping is true are allowed to send callhooks in outbound transfers\n    mapping(address => bool) public callhookWhitelist;\n\n    // Emitted when an outbound transfer is initiated, i.e. tokens are deposited from L1 to L2\n    event DepositInitiated(\n        address l1Token,\n        address indexed from,\n        address indexed to,\n        uint256 indexed sequenceNumber,\n        uint256 amount\n    );\n\n    // Emitted when an incoming transfer is finalized, i.e tokens are withdrawn from L2 to L1\n    event WithdrawalFinalized(\n        address l1Token,\n        address indexed from,\n        address indexed to,\n        uint256 indexed exitNum,\n        uint256 amount\n    );\n\n    // Emitted when the Arbitrum Inbox and Gateway Router addresses have been updated\n    event ArbitrumAddressesSet(address inbox, address l1Router);\n    // Emitted when the L2 GRT address has been updated\n    event L2TokenAddressSet(address l2GRT);\n    // Emitted when the counterpart L2GraphTokenGateway address has been updated\n    event L2CounterpartAddressSet(address l2Counterpart);\n    // Emitted when the escrow address has been updated\n    event EscrowAddressSet(address escrow);\n    // Emitted when an address is added to the callhook whitelist\n    event AddedToCallhookWhitelist(address newWhitelisted);\n    // Emitted when an address is removed from the callhook whitelist\n    event RemovedFromCallhookWhitelist(address notWhitelisted);\n\n    /**\n     * @dev Allows a function to be called only by the gateway's L2 counterpart.\n     * The message will actually come from the Arbitrum Bridge, but the Outbox\n     * can tell us who the sender from L2 is.\n     */\n    modifier onlyL2Counterpart() {\n        require(inbox != address(0), \"INBOX_NOT_SET\");\n\n        // a message coming from the counterpart gateway was executed by the bridge\n        IBridge bridge = IInbox(inbox).bridge();\n        require(msg.sender == address(bridge), \"NOT_FROM_BRIDGE\");\n\n        // and the outbox reports that the L2 address of the sender is the counterpart gateway\n        address l2ToL1Sender = IOutbox(bridge.activeOutbox()).l2ToL1Sender();\n        require(l2ToL1Sender == l2Counterpart, \"ONLY_COUNTERPART_GATEWAY\");\n        _;\n    }\n\n    /**\n     * @dev Initialize this contract.\n     * The contract will be paused.\n     * Note some parameters have to be set separately as they are generally\n     * not expected to be available at initialization time:\n     * - inbox  and l1Router using setArbitrumAddresses\n     * - l2GRT using setL2TokenAddress\n     * - l2Counterpart using setL2CounterpartAddress\n     * - escrow using setEscrowAddress\n     * - whitelisted callhook callers using addToCallhookWhitelist\n     * - pauseGuardian using setPauseGuardian\n     * @param _controller Address of the Controller that manages this contract\n     */\n    function initialize(address _controller) external onlyImpl {\n        Managed._initialize(_controller);\n        _paused = true;\n    }\n\n    /**\n     * @dev Sets the addresses for L1 contracts provided by Arbitrum\n     * @param _inbox Address of the Inbox that is part of the Arbitrum Bridge\n     * @param _l1Router Address of the Gateway Router\n     */\n    function setArbitrumAddresses(address _inbox, address _l1Router) external onlyGovernor {\n        require(_inbox != address(0), \"INVALID_INBOX\");\n        require(_l1Router != address(0), \"INVALID_L1_ROUTER\");\n        inbox = _inbox;\n        l1Router = _l1Router;\n        emit ArbitrumAddressesSet(_inbox, _l1Router);\n    }\n\n    /**\n     * @dev Sets the address of the L2 Graph Token\n     * @param _l2GRT Address of the GRT contract on L2\n     */\n    function setL2TokenAddress(address _l2GRT) external onlyGovernor {\n        require(_l2GRT != address(0), \"INVALID_L2_GRT\");\n        l2GRT = _l2GRT;\n        emit L2TokenAddressSet(_l2GRT);\n    }\n\n    /**\n     * @dev Sets the address of the counterpart gateway on L2\n     * @param _l2Counterpart Address of the corresponding L2GraphTokenGateway on Arbitrum\n     */\n    function setL2CounterpartAddress(address _l2Counterpart) external onlyGovernor {\n        require(_l2Counterpart != address(0), \"INVALID_L2_COUNTERPART\");\n        l2Counterpart = _l2Counterpart;\n        emit L2CounterpartAddressSet(_l2Counterpart);\n    }\n\n    /**\n     * @dev Sets the address of the escrow contract on L1\n     * @param _escrow Address of the BridgeEscrow\n     */\n    function setEscrowAddress(address _escrow) external onlyGovernor {\n        require(_escrow != address(0) && Address.isContract(_escrow), \"INVALID_ESCROW\");\n        escrow = _escrow;\n        emit EscrowAddressSet(_escrow);\n    }\n\n    /**\n     * @dev Adds an address to the callhook whitelist.\n     * This address will be allowed to include callhooks when transferring tokens.\n     * @param _newWhitelisted Address to add to the whitelist\n     */\n    function addToCallhookWhitelist(address _newWhitelisted) external onlyGovernor {\n        require(_newWhitelisted != address(0), \"INVALID_ADDRESS\");\n        require(!callhookWhitelist[_newWhitelisted], \"ALREADY_WHITELISTED\");\n        callhookWhitelist[_newWhitelisted] = true;\n        emit AddedToCallhookWhitelist(_newWhitelisted);\n    }\n\n    /**\n     * @dev Removes an address from the callhook whitelist.\n     * This address will no longer be allowed to include callhooks when transferring tokens.\n     * @param _notWhitelisted Address to remove from the whitelist\n     */\n    function removeFromCallhookWhitelist(address _notWhitelisted) external onlyGovernor {\n        require(_notWhitelisted != address(0), \"INVALID_ADDRESS\");\n        require(callhookWhitelist[_notWhitelisted], \"NOT_WHITELISTED\");\n        callhookWhitelist[_notWhitelisted] = false;\n        emit RemovedFromCallhookWhitelist(_notWhitelisted);\n    }\n\n    /**\n     * @notice Creates and sends a retryable ticket to transfer GRT to L2 using the Arbitrum Inbox.\n     * The tokens are escrowed by the gateway until they are withdrawn back to L1.\n     * The ticket must be redeemed on L2 to receive tokens at the specified address.\n     * Note that the caller must previously allow the gateway to spend the specified amount of GRT.\n     * @dev maxGas and gasPriceBid must be set using Arbitrum's NodeInterface.estimateRetryableTicket method.\n     * Also note that whitelisted senders (some protocol contracts) can include additional calldata\n     * for a callhook to be executed on the L2 side when the tokens are received. In this case, the L2 transaction\n     * can revert if the callhook reverts, potentially locking the tokens on the bridge if the callhook\n     * never succeeds. This requires extra care when adding contracts to the whitelist, but is necessary to ensure that\n     * the tickets can be retried in the case of a temporary failure, and to ensure the atomicity of callhooks\n     * with token transfers.\n     * @param _l1Token L1 Address of the GRT contract (needed for compatibility with Arbitrum Gateway Router)\n     * @param _to Recipient address on L2\n     * @param _amount Amount of tokens to tranfer\n     * @param _maxGas Gas limit for L2 execution of the ticket\n     * @param _gasPriceBid Price per gas on L2\n     * @param _data Encoded maxSubmissionCost and sender address along with additional calldata\n     * @return Sequence number of the retryable ticket created by Inbox\n     */\n    function outboundTransfer(\n        address _l1Token,\n        address _to,\n        uint256 _amount,\n        uint256 _maxGas,\n        uint256 _gasPriceBid,\n        bytes calldata _data\n    ) external payable override notPaused returns (bytes memory) {\n        IGraphToken token = graphToken();\n        require(_l1Token == address(token), \"TOKEN_NOT_GRT\");\n        require(_amount > 0, \"INVALID_ZERO_AMOUNT\");\n        require(_to != address(0), \"INVALID_DESTINATION\");\n\n        // nested scopes to avoid stack too deep errors\n        address from;\n        uint256 seqNum;\n        {\n            uint256 maxSubmissionCost;\n            bytes memory outboundCalldata;\n            {\n                bytes memory extraData;\n                (from, maxSubmissionCost, extraData) = parseOutboundData(_data);\n                require(\n                    extraData.length == 0 || callhookWhitelist[msg.sender] == true,\n                    \"CALL_HOOK_DATA_NOT_ALLOWED\"\n                );\n                require(maxSubmissionCost > 0, \"NO_SUBMISSION_COST\");\n\n                {\n                    // makes sure only sufficient ETH is supplied as required for successful redemption on L2\n                    // if a user does not desire immediate redemption they should provide\n                    // a msg.value of AT LEAST maxSubmissionCost\n                    uint256 expectedEth = maxSubmissionCost.add(_maxGas.mul(_gasPriceBid));\n                    require(msg.value >= expectedEth, \"WRONG_ETH_VALUE\");\n                }\n                outboundCalldata = getOutboundCalldata(_l1Token, from, _to, _amount, extraData);\n            }\n            {\n                L2GasParams memory gasParams = L2GasParams(\n                    maxSubmissionCost,\n                    _maxGas,\n                    _gasPriceBid\n                );\n                // transfer tokens to escrow\n                token.transferFrom(from, escrow, _amount);\n                seqNum = sendTxToL2(\n                    inbox,\n                    l2Counterpart,\n                    from,\n                    msg.value,\n                    0,\n                    gasParams,\n                    outboundCalldata\n                );\n            }\n        }\n        emit DepositInitiated(_l1Token, from, _to, seqNum, _amount);\n\n        return abi.encode(seqNum);\n    }\n\n    /**\n     * @notice Receives withdrawn tokens from L2\n     * The equivalent tokens are released from escrow and sent to the destination.\n     * @dev can only accept transactions coming from the L2 GRT Gateway.\n     * The last parameter is unused but kept for compatibility with Arbitrum gateways,\n     * and the encoded exitNum is assumed to be 0.\n     * @param _l1Token L1 Address of the GRT contract (needed for compatibility with Arbitrum Gateway Router)\n     * @param _from Address of the sender\n     * @param _to Recepient address on L1\n     * @param _amount Amount of tokens transferred\n     */\n    function finalizeInboundTransfer(\n        address _l1Token,\n        address _from,\n        address _to,\n        uint256 _amount,\n        bytes calldata // _data, contains exitNum, unused by this contract\n    ) external payable override notPaused onlyL2Counterpart {\n        IGraphToken token = graphToken();\n        require(_l1Token == address(token), \"TOKEN_NOT_GRT\");\n\n        uint256 escrowBalance = token.balanceOf(escrow);\n        // If the bridge doesn't have enough tokens, something's very wrong!\n        require(_amount <= escrowBalance, \"BRIDGE_OUT_OF_FUNDS\");\n        token.transferFrom(escrow, _to, _amount);\n\n        emit WithdrawalFinalized(_l1Token, _from, _to, 0, _amount);\n    }\n\n    /**\n     * @notice Decodes calldata required for migration of tokens\n     * @dev Data must include maxSubmissionCost, extraData can be left empty. When the router\n     * sends an outbound message, data also contains the from address.\n     * @param _data encoded callhook data\n     * @return Sender of the tx\n     * @return Base ether value required to keep retryable ticket alive\n     * @return Additional data sent to L2\n     */\n    function parseOutboundData(bytes memory _data)\n        private\n        view\n        returns (\n            address,\n            uint256,\n            bytes memory\n        )\n    {\n        address from;\n        uint256 maxSubmissionCost;\n        bytes memory extraData;\n        if (msg.sender == l1Router) {\n            // Data encoded by the Gateway Router includes the sender address\n            (from, extraData) = abi.decode(_data, (address, bytes));\n        } else {\n            from = msg.sender;\n            extraData = _data;\n        }\n        // User-encoded data contains the max retryable ticket submission cost\n        // and additional L2 calldata\n        (maxSubmissionCost, extraData) = abi.decode(extraData, (uint256, bytes));\n        return (from, maxSubmissionCost, extraData);\n    }\n\n    /**\n     * @notice Creates calldata required to create a retryable ticket\n     * @dev encodes the target function with its params which\n     * will be called on L2 when the retryable ticket is redeemed\n     * @param _l1Token Address of the Graph token contract on L1\n     * @param _from Address on L1 from which we're transferring tokens\n     * @param _to Address on L2 to which we're transferring tokens\n     * @param _amount Amount of GRT to transfer\n     * @param _data Additional call data for the L2 transaction, which must be empty unless the caller is whitelisted\n     * @return Encoded calldata (including function selector) for the L2 transaction\n     */\n    function getOutboundCalldata(\n        address _l1Token,\n        address _from,\n        address _to,\n        uint256 _amount,\n        bytes memory _data\n    ) public pure returns (bytes memory) {\n        bytes memory emptyBytes;\n\n        return\n            abi.encodeWithSelector(\n                ITokenGateway.finalizeInboundTransfer.selector,\n                _l1Token,\n                _from,\n                _to,\n                _amount,\n                abi.encode(emptyBytes, _data)\n            );\n    }\n\n    /**\n     * @notice Calculate the L2 address of a bridged token\n     * @dev In our case, this would only work for GRT.\n     * @param _l1ERC20 address of L1 GRT contract\n     * @return L2 address of the bridged GRT token\n     */\n    function calculateL2TokenAddress(address _l1ERC20) external view override returns (address) {\n        IGraphToken token = graphToken();\n        if (_l1ERC20 != address(token)) {\n            return address(0);\n        }\n        return l2GRT;\n    }\n}"
    },
    {
      "filename": "contracts/governance/Governed.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n\npragma solidity ^0.7.6;\n\n/**\n * @title Graph Governance contract\n * @dev All contracts that will be owned by a Governor entity should extend this contract.\n */\ncontract Governed {\n    // -- State --\n\n    address public governor;\n    address public pendingGovernor;\n\n    // -- Events --\n\n    event NewPendingOwnership(address indexed from, address indexed to);\n    event NewOwnership(address indexed from, address indexed to);\n\n    /**\n     * @dev Check if the caller is the governor.\n     */\n    modifier onlyGovernor() {\n        require(msg.sender == governor, \"Only Governor can call\");\n        _;\n    }\n\n    /**\n     * @dev Initialize the governor to the contract caller.\n     */\n    function _initialize(address _initGovernor) internal {\n        governor = _initGovernor;\n    }\n\n    /**\n     * @dev Admin function to begin change of governor. The `_newGovernor` must call\n     * `acceptOwnership` to finalize the transfer.\n     * @param _newGovernor Address of new `governor`\n     */\n    function transferOwnership(address _newGovernor) external onlyGovernor {\n        require(_newGovernor != address(0), \"Governor must be set\");\n\n        address oldPendingGovernor = pendingGovernor;\n        pendingGovernor = _newGovernor;\n\n        emit NewPendingOwnership(oldPendingGovernor, pendingGovernor);\n    }\n\n    /**\n     * @dev Admin function for pending governor to accept role and update governor.\n     * This function must called by the pending governor.\n     */\n    function acceptOwnership() external {\n        require(\n            pendingGovernor != address(0) && msg.sender == pendingGovernor,\n            \"Caller must be pending governor\"\n        );\n\n        address oldGovernor = governor;\n        address oldPendingGovernor = pendingGovernor;\n\n        governor = pendingGovernor;\n        pendingGovernor = address(0);\n\n        emit NewOwnership(oldGovernor, governor);\n        emit NewPendingOwnership(oldPendingGovernor, pendingGovernor);\n    }\n}"
    },
    {
      "filename": "contracts/governance/Managed.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n\npragma solidity ^0.7.6;\n\nimport \"./IController.sol\";\n\nimport \"../curation/ICuration.sol\";\nimport \"../epochs/IEpochManager.sol\";\nimport \"../rewards/IRewardsManager.sol\";\nimport \"../staking/IStaking.sol\";\nimport \"../token/IGraphToken.sol\";\nimport \"../arbitrum/ITokenGateway.sol\";\n\n/**\n * @title Graph Managed contract\n * @dev The Managed contract provides an interface to interact with the Controller.\n * It also provides local caching for contract addresses. This mechanism relies on calling the\n * public `syncAllContracts()` function whenever a contract changes in the controller.\n *\n * Inspired by Livepeer:\n * https://github.com/livepeer/protocol/blob/streamflow/contracts/Controller.sol\n */\ncontract Managed {\n    // -- State --\n\n    // Controller that contract is registered with\n    IController public controller;\n    mapping(bytes32 => address) private addressCache;\n    uint256[10] private __gap;\n\n    // -- Events --\n\n    event ParameterUpdated(string param);\n    event SetController(address controller);\n\n    /**\n     * @dev Emitted when contract with `nameHash` is synced to `contractAddress`.\n     */\n    event ContractSynced(bytes32 indexed nameHash, address contractAddress);\n\n    // -- Modifiers --\n\n    function _notPartialPaused() internal view {\n        require(!controller.paused(), \"Paused\");\n        require(!controller.partialPaused(), \"Partial-paused\");\n    }\n\n    function _notPaused() internal view virtual {\n        require(!controller.paused(), \"Paused\");\n    }\n\n    function _onlyGovernor() internal view {\n        require(msg.sender == controller.getGovernor(), \"Caller must be Controller governor\");\n    }\n\n    function _onlyController() internal view {\n        require(msg.sender == address(controller), \"Caller must be Controller\");\n    }\n\n    modifier notPartialPaused() {\n        _notPartialPaused();\n        _;\n    }\n\n    modifier notPaused() {\n        _notPaused();\n        _;\n    }\n\n    // Check if sender is controller.\n    modifier onlyController() {\n        _onlyController();\n        _;\n    }\n\n    // Check if sender is the governor.\n    modifier onlyGovernor() {\n        _onlyGovernor();\n        _;\n    }\n\n    // -- Functions --\n\n    /**\n     * @dev Initialize the controller.\n     */\n    function _initialize(address _controller) internal {\n        _setController(_controller);\n    }\n\n    /**\n     * @notice Set Controller. Only callable by current controller.\n     * @param _controller Controller contract address\n     */\n    function setController(address _controller) external onlyController {\n        _setController(_controller);\n    }\n\n    /**\n     * @dev Set controller.\n     * @param _controller Controller contract address\n     */\n    function _setController(address _controller) internal {\n        require(_controller != address(0), \"Controller must be set\");\n        controller = IController(_controller);\n        emit SetController(_controller);\n    }\n\n    /**\n     * @dev Return Curation interface.\n     * @return Curation contract registered with Controller\n     */\n    function curation() internal view returns (ICuration) {\n        return ICuration(_resolveContract(keccak256(\"Curation\")));\n    }\n\n    /**\n     * @dev Return EpochManager interface.\n     * @return Epoch manager contract registered with Controller\n     */\n    function epochManager() internal view returns (IEpochManager) {\n        return IEpochManager(_resolveContract(keccak256(\"EpochManager\")));\n    }\n\n    /**\n     * @dev Return RewardsManager interface.\n     * @return Rewards manager contract registered with Controller\n     */\n    function rewardsManager() internal view returns (IRewardsManager) {\n        return IRewardsManager(_resolveContract(keccak256(\"RewardsManager\")));\n    }\n\n    /**\n     * @dev Return Staking interface.\n     * @return Staking contract registered with Controller\n     */\n    function staking() internal view returns (IStaking) {\n        return IStaking(_resolveContract(keccak256(\"Staking\")));\n    }\n\n    /**\n     * @dev Return GraphToken interface.\n     * @return Graph token contract registered with Controller\n     */\n    function graphToken() internal view returns (IGraphToken) {\n        return IGraphToken(_resolveContract(keccak256(\"GraphToken\")));\n    }\n\n    /**\n     * @dev Return GraphTokenGateway (L1 or L2) interface.\n     * @return Graph token gateway contract registered with Controller\n     */\n    function graphTokenGateway() internal view returns (ITokenGateway) {\n        return ITokenGateway(_resolveContract(keccak256(\"GraphTokenGateway\")));\n    }\n\n    /**\n     * @dev Resolve a contract address from the cache or the Controller if not found.\n     * @return Address of the contract\n     */\n    function _resolveContract(bytes32 _nameHash) internal view returns (address) {\n        address contractAddress = addressCache[_nameHash];\n        if (contractAddress == address(0)) {\n            contractAddress = controller.getContractProxy(_nameHash);\n        }\n        return contractAddress;\n    }\n\n    /**\n     * @dev Cache a contract address from the Controller registry.\n     * @param _name Name of the contract to sync into the cache\n     */\n    function _syncContract(string memory _name) internal {\n        bytes32 nameHash = keccak256(abi.encodePacked(_name));\n        address contractAddress = controller.getContractProxy(nameHash);\n        if (addressCache[nameHash] != contractAddress) {\n            addressCache[nameHash] = contractAddress;\n            emit ContractSynced(nameHash, contractAddress);\n        }\n    }\n\n    /**\n     * @dev Sync protocol contract addresses from the Controller registry.\n     * This function will cache all the contracts using the latest addresses\n     * Anyone can call the function whenever a Proxy contract change in the\n     * controller to ensure the protocol is using the latest version\n     */\n    function syncAllContracts() external {\n        _syncContract(\"Curation\");\n        _syncContract(\"EpochManager\");\n        _syncContract(\"RewardsManager\");\n        _syncContract(\"Staking\");\n        _syncContract(\"GraphToken\");\n        _syncContract(\"GraphTokenGateway\");\n    }\n}"
    },
    {
      "filename": "contracts/l2/gateway/L2GraphTokenGateway.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n\npragma solidity ^0.7.6;\npragma abicoder v2;\n\nimport \"@openzeppelin/contracts-upgradeable/utils/ReentrancyGuardUpgradeable.sol\";\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\n\nimport \"../../arbitrum/L2ArbitrumMessenger.sol\";\nimport \"../../arbitrum/AddressAliasHelper.sol\";\nimport \"../../gateway/GraphTokenGateway.sol\";\nimport \"../../gateway/ICallhookReceiver.sol\";\nimport \"../token/L2GraphToken.sol\";\n\n/**\n * @title L2 Graph Token Gateway Contract\n * @dev Provides the L2 side of the Ethereum-Arbitrum GRT bridge. Receives GRT from the L1 chain\n * and mints them on the L2 side. Sends GRT back to L1 by burning them on the L2 side.\n * Based on Offchain Labs' reference implementation and Livepeer's arbitrum-lpt-bridge\n * (See: https://github.com/OffchainLabs/arbitrum/tree/master/packages/arb-bridge-peripherals/contracts/tokenbridge\n * and https://github.com/livepeer/arbitrum-lpt-bridge)\n */\ncontract L2GraphTokenGateway is GraphTokenGateway, L2ArbitrumMessenger, ReentrancyGuardUpgradeable {\n    using SafeMath for uint256;\n\n    // Address of the Graph Token contract on L1\n    address public l1GRT;\n    // Address of the L1GraphTokenGateway that is the counterpart of this gateway on L1\n    address public l1Counterpart;\n    // Address of the Arbitrum Gateway Router on L2\n    address public l2Router;\n\n    // Calldata included in an outbound transfer, stored as a structure for convenience and stack depth\n    struct OutboundCalldata {\n        address from;\n        bytes extraData;\n    }\n\n    // Emitted when an incoming transfer is finalized, i.e. tokens were deposited from L1 to L2\n    event DepositFinalized(\n        address indexed l1Token,\n        address indexed from,\n        address indexed to,\n        uint256 amount\n    );\n\n    // Emitted when an outbound transfer is initiated, i.e. tokens are being withdrawn from L2 back to L1\n    event WithdrawalInitiated(\n        address l1Token,\n        address indexed from,\n        address indexed to,\n        uint256 indexed l2ToL1Id,\n        uint256 exitNum,\n        uint256 amount\n    );\n\n    // Emitted when the Arbitrum Gateway Router address on L2 has been updated\n    event L2RouterSet(address l2Router);\n    // Emitted when the L1 Graph Token address has been updated\n    event L1TokenAddressSet(address l1GRT);\n    // Emitted when the address of the counterpart gateway on L1 has been updated\n    event L1CounterpartAddressSet(address l1Counterpart);\n\n    /**\n     * @dev Checks that the sender is the L2 alias of the counterpart\n     * gateway on L1.\n     */\n    modifier onlyL1Counterpart() {\n        require(\n            msg.sender == AddressAliasHelper.applyL1ToL2Alias(l1Counterpart),\n            \"ONLY_COUNTERPART_GATEWAY\"\n        );\n        _;\n    }\n\n    /**\n     * @dev Initialize this contract.\n     * The contract will be paused.\n     * Note some parameters have to be set separately as they are generally\n     * not expected to be available at initialization time:\n     * - l2Router using setL2Router\n     * - l1GRT using setL1TokenAddress\n     * - l1Counterpart using setL1CounterpartAddress\n     * - pauseGuardian using setPauseGuardian\n     * @param _controller Address of the Controller that manages this contract\n     */\n    function initialize(address _controller) external onlyImpl {\n        Managed._initialize(_controller);\n        _paused = true;\n        __ReentrancyGuard_init();\n    }\n\n    /**\n     * @dev Sets the address of the Arbitrum Gateway Router on L2\n     * @param _l2Router Address of the L2 Router (provided by Arbitrum)\n     */\n    function setL2Router(address _l2Router) external onlyGovernor {\n        require(_l2Router != address(0), \"INVALID_L2_ROUTER\");\n        l2Router = _l2Router;\n        emit L2RouterSet(_l2Router);\n    }\n\n    /**\n     * @dev Sets the address of the Graph Token on L1\n     * @param _l1GRT L1 address of the Graph Token contract\n     */\n    function setL1TokenAddress(address _l1GRT) external onlyGovernor {\n        require(_l1GRT != address(0), \"INVALID_L1_GRT\");\n        l1GRT = _l1GRT;\n        emit L1TokenAddressSet(_l1GRT);\n    }\n\n    /**\n     * @dev Sets the address of the counterpart gateway on L1\n     * @param _l1Counterpart Address of the L1GraphTokenGateway on L1\n     */\n    function setL1CounterpartAddress(address _l1Counterpart) external onlyGovernor {\n        require(_l1Counterpart != address(0), \"INVALID_L1_COUNTERPART\");\n        l1Counterpart = _l1Counterpart;\n        emit L1CounterpartAddressSet(_l1Counterpart);\n    }\n\n    /**\n     * @notice Burns L2 tokens and initiates a transfer to L1.\n     * The tokens will be available on L1 only after the wait period (7 days) is over,\n     * and will require an Outbox.executeTransaction to finalize.\n     * Note that the caller must previously allow the gateway to spend the specified amount of GRT.\n     * @dev no additional callhook data is allowed. The two unused params are needed\n     * for compatibility with Arbitrum's gateway router.\n     * The function is payable for ITokenGateway compatibility, but msg.value must be zero.\n     * @param _l1Token L1 Address of GRT (needed for compatibility with Arbitrum Gateway Router)\n     * @param _to Recipient address on L1\n     * @param _amount Amount of tokens to burn\n     * @param _data Contains sender and additional data (always empty) to send to L1\n     * @return ID of the withdraw transaction\n     */\n    function outboundTransfer(\n        address _l1Token,\n        address _to,\n        uint256 _amount,\n        uint256, // unused on L2\n        uint256, // unused on L2\n        bytes calldata _data\n    ) public payable override notPaused nonReentrant returns (bytes memory) {\n        require(_l1Token == l1GRT, \"TOKEN_NOT_GRT\");\n        require(_amount > 0, \"INVALID_ZERO_AMOUNT\");\n        require(msg.value == 0, \"INVALID_NONZERO_VALUE\");"
    }
  ]
}