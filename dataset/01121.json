{
  "Title": "RDNT Bridge Fee Is Being Overcharged",
  "Content": "The new Radiant OFT v2 token allows cross-chain [transfers](https://github.com/radiant-capital/v2-core/blob/e8f21f103e17736907b62809d1ad902febc53714/contracts/radiant/token/RadiantOFT.sol#L109-L128) via LayerZero. Such a transfer involves two types of fees: the [native](https://github.com/radiant-capital/v2-core/blob/e8f21f103e17736907b62809d1ad902febc53714/contracts/radiant/token/RadiantOFT.sol#L89-L107) LayerZero fee and a [bridging fee](https://github.com/radiant-capital/v2-core/blob/e8f21f103e17736907b62809d1ad902febc53714/contracts/radiant/token/RadiantOFT.sol#L162-L174) charged by the Radiant protocol.\n\n\nIn order to enforce cross-chain compatibility (even with non-EVM chains), prior to a transfer LayerZero needs amounts to be truncated to a [certain number of decimals](https://github.com/LayerZero-Labs/solidity-examples/blob/0029055a8c19ae2106ba12d678971a931b2d927b/contracts/token/oft/v2/OFTV2.sol#L12-L16) configured as token decimals minus a shared decimals value. In this specific case, [shared decimals are configured to be `8`](https://github.com/radiant-capital/v2-core/blob/e8f21f103e17736907b62809d1ad902febc53714/contracts/radiant/token/RadiantOFT.sol#L55) and RDNT features `18` decimals, so amounts will be truncated to the closest `1e10` multiple. This means that for example when users want to transfer `1.99e10` tokens, only `1e10` tokens will be transferred.\n\n\nHowever, the [`getBridgeFee`](https://github.com/radiant-capital/v2-core/blob/e8f21f103e17736907b62809d1ad902febc53714/contracts/radiant/token/RadiantOFT.sol#L162-L174) calculation does not truncate input amounts so in the extreme scenario where the minimum value of `1e10` is transferred, the final fee charged will be almost double what it would have been if the amount was truncated first. This effect becomes much less noticeable for larger transfer amounts.\n\n\nConsider [truncating](https://github.com/radiant-capital/v2-core/blob/e8f21f103e17736907b62809d1ad902febc53714/contracts/radiant/token/RadiantOFT.sol#L134) the transfer `_amount` before calculating the bridge fee in order to not overcharge users.\n\n\n***Update:** Resolved in [pull request #217](https://github.com/radiant-capital/v2-core/pull/217) at commit [d59c6a1](https://github.com/radiant-capital/v2-core/commit/d59c6a14ff6a51c0aed61c636b0b248930633102).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/token/oft/v2/OFTV2.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport \"@openzeppelin/contracts/token/ERC20/ERC20.sol\";\nimport \"./BaseOFTV2.sol\";\n\ncontract OFTV2 is BaseOFTV2, ERC20 {\n\n    uint internal immutable ld2sdRate;\n\n    constructor(string memory _name, string memory _symbol, uint8 _sharedDecimals, address _lzEndpoint) ERC20(_name, _symbol) BaseOFTV2(_sharedDecimals, _lzEndpoint) {\n        uint8 decimals = decimals();\n        require(_sharedDecimals <= decimals, \"OFT: sharedDecimals must be <= decimals\");\n        ld2sdRate = 10 ** (decimals - _sharedDecimals);\n    }\n\n    /************************************************************************\n    * public functions\n    ************************************************************************/\n    function circulatingSupply() public view virtual override returns (uint) {\n        return totalSupply();\n    }\n\n    function token() public view virtual override returns (address) {\n        return address(this);\n    }\n\n    /************************************************************************\n    * internal functions\n    ************************************************************************/\n    function _debitFrom(address _from, uint16, bytes32, uint _amount) internal virtual override returns (uint) {\n        address spender = _msgSender();\n        if (_from != spender) _spendAllowance(_from, spender, _amount);\n        _burn(_from, _amount);\n        return _amount;\n    }\n\n    function _creditTo(uint16, address _toAddress, uint _amount) internal virtual override returns (uint) {\n        _mint(_toAddress, _amount);\n        return _amount;\n    }\n\n    function _transferFrom(address _from, address _to, uint _amount) internal virtual override returns (uint) {\n        address spender = _msgSender();\n        // if transfer from this contract, no need to check allowance\n        if (_from != address(this) && _from != spender) _spendAllowance(_from, spender, _amount);\n        _transfer(_from, _to, _amount);\n        return _amount;\n    }\n\n    function _ld2sdRate() internal view virtual override returns (uint) {\n        return ld2sdRate;\n    }\n}"
    }
  ]
}