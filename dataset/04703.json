{
  "Title": "[09] Owner transfer actions done in a single-step manner are dangerous",
  "Content": "\nhttps://github.com/code-423n4/2024-04-dyad/blob/4a987e536576139793a1c04690336d06c93fca90/script/deploy/Deploy.V2.s.sol#L69-L70\n\n```solidity\n    kerosineManager.transferOwnership(MAINNET_OWNER);\n```\n\nHowever, the protocol uses `Solmates Owned.sol` and inheriting from solmate's Owned contract means you are using a single-step ownership transfer pattern. If an admin provides an incorrect address for the new owner this will result in none of the `onlyOwner` marked methods being callable again. The better way to do this is to use a two-step ownership transfer approach, where the new owner should first claim its new rights before they are transferred.\n\nHere is the implementation of [Solmate's Owned.sol](https://github.com/transmissions11/solmate/blob/main/src/auth/Owned.sol#L39):\n\n```solidity\n    function transferOwnership(address newOwner) public virtual onlyOwner {\n        owner = newOwner;\n\n        emit OwnershipTransferred(msg.sender, newOwner);\n    }\n```\n\n### Impact\n\nAdmin role could be permanently lost.\n\n### Recommended Mitigation Steps\n\nUse OpenZeppelin's `Ownable2Step` instead of `Ownable`.\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2024-04-dyad",
  "Code": [
    {
      "filename": "script/deploy/Deploy.V2.s.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity =0.8.17;\n\nimport \"forge-std/Script.sol\";\n\nimport {Parameters}             from \"../../src/params/Parameters.sol\";\nimport {VaultManagerV2}         from \"../../src/core/VaultManagerV2.sol\";\nimport {DNft}                   from \"../../src/core/DNft.sol\";\nimport {Dyad}                   from \"../../src/core/Dyad.sol\";\nimport {Licenser}               from \"../../src/core/Licenser.sol\";\nimport {Vault}                  from \"../../src/core/Vault.sol\";\nimport {VaultWstEth}            from \"../../src/core/Vault.wsteth.sol\";\nimport {IWETH}                  from \"../../src/interfaces/IWETH.sol\";\nimport {IAggregatorV3}          from \"../../src/interfaces/IAggregatorV3.sol\";\nimport {KerosineManager}        from \"../../src/core/KerosineManager.sol\";\nimport {UnboundedKerosineVault} from \"../../src/core/Vault.kerosine.unbounded.sol\";\nimport {BoundedKerosineVault}   from \"../../src/core/Vault.kerosine.bounded.sol\";\nimport {Kerosine}               from \"../../src/staking/Kerosine.sol\";\nimport {KerosineDenominator}    from \"../../src/staking/KerosineDenominator.sol\";\n\nimport {ERC20} from \"@solmate/src/tokens/ERC20.sol\";\n\nstruct Contracts {\n  Kerosine               kerosene;\n  Licenser               vaultLicenser;\n  VaultManagerV2         vaultManager;\n  Vault                  ethVault;\n  VaultWstEth            wstEth;\n  KerosineManager        kerosineManager;\n  UnboundedKerosineVault unboundedKerosineVault;\n  BoundedKerosineVault   boundedKerosineVault;\n  KerosineDenominator    kerosineDenominator;\n}\n\ncontract DeployV2 is Script, Parameters {\n  function run() public returns (Contracts memory) {\n    vm.startBroadcast();  // ----------------------\n\n    Licenser vaultLicenser = new Licenser();\n\n    // Vault Manager needs to be licensed through the Vault Manager Licenser\n    VaultManagerV2 vaultManager = new VaultManagerV2(\n      DNft(MAINNET_DNFT),\n      Dyad(MAINNET_DYAD),\n      vaultLicenser\n    );\n\n    // weth vault\n    Vault ethVault = new Vault(\n      vaultManager,\n      ERC20        (MAINNET_WETH),\n      IAggregatorV3(MAINNET_WETH_ORACLE)\n    );\n\n    // wsteth vault\n    VaultWstEth wstEth = new VaultWstEth(\n      vaultManager, \n      ERC20        (MAINNET_WSTETH), \n      IAggregatorV3(MAINNET_CHAINLINK_STETH)\n    );\n\n    KerosineManager kerosineManager = new KerosineManager();\n\n    kerosineManager.add(address(ethVault));\n    kerosineManager.add(address(wstEth));\n\n    vaultManager.setKeroseneManager(kerosineManager);\n\n    kerosineManager.transferOwnership(MAINNET_OWNER);\n\n    UnboundedKerosineVault unboundedKerosineVault = new UnboundedKerosineVault(\n      vaultManager,\n      Kerosine(MAINNET_KEROSENE), \n      Dyad    (MAINNET_DYAD),\n      kerosineManager\n    );\n\n    BoundedKerosineVault boundedKerosineVault     = new BoundedKerosineVault(\n      vaultManager,\n      Kerosine(MAINNET_KEROSENE), \n      kerosineManager\n    );\n\n    KerosineDenominator kerosineDenominator       = new KerosineDenominator(\n      Kerosine(MAINNET_KEROSENE)\n    );\n\n    unboundedKerosineVault.setDenominator(kerosineDenominator);\n\n    unboundedKerosineVault.transferOwnership(MAINNET_OWNER);\n    boundedKerosineVault.  transferOwnership(MAINNET_OWNER);\n\n    vaultLicenser.add(address(ethVault));\n    vaultLicenser.add(address(wstEth));\n    vaultLicenser.add(address(unboundedKerosineVault));\n    // vaultLicenser.add(address(boundedKerosineVault));\n\n    vaultLicenser.transferOwnership(MAINNET_OWNER);\n\n    vm.stopBroadcast();  // ----------------------------\n\n    return Contracts(\n      Kerosine(MAINNET_KEROSENE),\n      vaultLicenser,\n      vaultManager,\n      ethVault,\n      wstEth,\n      kerosineManager,\n      unboundedKerosineVault,\n      boundedKerosineVault,\n      kerosineDenominator\n    );\n  }\n}"
    },
    {
      "filename": "src/auth/Owned.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-only\npragma solidity >=0.8.0;\n\n/// @notice Simple single owner authorization mixin.\n/// @author Solmate (https://github.com/transmissions11/solmate/blob/main/src/auth/Owned.sol)\nabstract contract Owned {\n    /*//////////////////////////////////////////////////////////////\n                                 EVENTS\n    //////////////////////////////////////////////////////////////*/\n\n    event OwnershipTransferred(address indexed user, address indexed newOwner);\n\n    /*//////////////////////////////////////////////////////////////\n                            OWNERSHIP STORAGE\n    //////////////////////////////////////////////////////////////*/\n\n    address public owner;\n\n    modifier onlyOwner() virtual {\n        require(msg.sender == owner, \"UNAUTHORIZED\");\n\n        _;\n    }\n\n    /*//////////////////////////////////////////////////////////////\n                               CONSTRUCTOR\n    //////////////////////////////////////////////////////////////*/\n\n    constructor(address _owner) {\n        owner = _owner;\n\n        emit OwnershipTransferred(address(0), _owner);\n    }\n\n    /*//////////////////////////////////////////////////////////////\n                             OWNERSHIP LOGIC\n    //////////////////////////////////////////////////////////////*/\n\n    function transferOwnership(address newOwner) public virtual onlyOwner {\n        owner = newOwner;\n\n        emit OwnershipTransferred(msg.sender, newOwner);\n    }\n}"
    }
  ]
}