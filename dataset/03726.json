{
  "Title": "zDAO Token - Specification violation - Snapshots are never taken  Partially Addressed",
  "Content": "\n\n#### Resolution\n\n\n\nAddressed with [zer0-os/[email protected]`81946d4`](https://github.com/zer0-os/zDAO-Token/commit/81946d451e8a9962b0c0d6fc8222313ec115cd53) by exposing the `_snapshot()` method to a dedicated snapshot role (likely to be a DAO) and the owner of the contract.\n\n\nWe would like to note that we informed the client that depending on how the snapshot method is used and how predictably snapshots are consumed this might open up a frontrunning vector where someone observing that a `_snapshot()` is about to be taken might sandwich the snapshot call, accumulate a lot of stake (via 2nd markets, lending platforms), and returning it right after it’s been taken. The risk of losing funds may be rather low (especially if performed by a miner) and the benefit from a DAO proposal using this snapshot might outweigh it. It is still recommended to increase the number of snapshots taken or take them on a regular basis (e.g. with every first transaction to the contract in a block) to make it harder to sandwich the snapshot taking.\n\n\n\n\n#### Description\n\n\nAccording to the [zDAO Token specification](https://github.com/zer0-os/zDAO-Token/blob/a053e1d7314ed62bccfc70a5110ef2dd5546deec/docs/zdaotoken.md#balance-snapshotting) the DAO token should implement a snapshot functionality to allow it being used for DAO governance votings.\n\n\n\n> \n> Any transfer, mint, or burn operation should result in a snapshot of the token balances of involved users being taken.\n> \n> \n> \n\n\nWhile the corresponding functionality is implemented and appears to update balances for snapshots, `_snapshot()` is never called, therefore, the snapshot is never taken. e.g. attempting to call `balanceOfAt` always results in an error as no snapshot is available.\n\n\n**zDAO-Token/contracts/ZeroDAOToken.sol:L12-L17**\n\n\n\n```\ncontract ZeroDAOToken is\n  OwnableUpgradeable,\n  ERC20Upgradeable,\n  ERC20PausableUpgradeable,\n  ERC20SnapshotUpgradeable\n{\n\n```\n**zDAO-Token/contracts/ZeroDAOToken.sol:L83-L83**\n\n\n\n```\n\\_updateAccountSnapshot(sender);\n\n```\nNote that this is an explicit requirement as per specification but unit tests do not seem to attempt calls to `balanceOfAt` at all.\n\n\n#### Recommendation\n\n\nActually, take a snapshot by calling `_snapshot()` once per block when executing the first transaction in a new block. Follow the openzeppeling documentation for [ERC20Snapshot](https://docs.openzeppelin.com/contracts/3.x/api/token/erc20#ERC20Snapshot).\n\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "docs/zdaotoken.md",
      "content": "# Zer0 DAO Token Contract\n\nThe Zer0 DAO Token is an ERC20 token designed for usage in Zer0 DAO's.\n\nMany copies of this token may be deployed in the future (one for each DAO) and as such the token contract needs to be safe and easy to use.\n\n## Intended Usage\n\nA Zer0 DAO Token is used to represent ownership of a DAO inside of Zer0.\nUsers who own a Zer0 DAO token have privileges granted by the DAO.\nOne of these privileges may be voting rights on proposals.\nThe weight of a users vote is determined by the quantity of tokens they own versus the total supply of tokens.\n\n\n## Specification\n\nThis is a list of feature specifications, it will attempt to describe each fundamental feature and any requirements around them.\n\n### ERC20 Token\n\nThe token needs to implement the [ERC20 Token Standard](https://eips.ethereum.org/EIPS/eip-20).\n\n### Transfer\n\nA user who owns Zer0 DAO tokens should be able to transfer their tokens to another account or wallet.\n\n### Pauseable\n\nThe Zer0 DAO token administrator (owner of the Zer0 DAO token contract) should be able to freeze and unfreeze token transactions.\n\nFreezing of token transactions will prevent:\n\n- Tokens from being transferred\n- Tokens from being bought or sold\n-  New tokens from being created\n\n### Upgradable\n\nIt is likely that additional functionality may be required of a Zer0 DAO token in the future. \nTherefore the Zer0 DAO token contracts should be upgradable to allow for functionality improvements without a token migration.\n\n### Balance Snapshotting\n\nVoting on a zDAO proposal may not require tokens to be ‘spent’ or ‘locked’ thus allowing a user to vote and then transfer their tokens before the vote has passed.\n\nAs such, the weight of a users vote must not change during the duration of a proposal. If it were changeable then it would be possible for a user to vote on a proposal, transfer their tokens, then vote a second time on the same proposal.\n\nTo prevent this balance snapshotting must be implemented, which will snapshot a users balance every time they send or receive tokens. zDAO can therefore use a users token balance at the start time of a proposal to determine voting weight.\n\nAny `transfer`, `mint`, or `burn` operation should result in a snapshot of the token balances of involved users being taken.\n\n### Bulk Transfer\n\nThe ability to transfer tokens from one account to many accounts with a single transaction is required to save on gas.\n\n### Ownable\n\nThe owner of the token contract has the ability to mint and burn tokens.  \nThe intended owner of this token is a Zer0 DAO."
    }
  ]
}