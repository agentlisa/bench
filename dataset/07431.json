{
  "Title": "[M-20] TokenggAVAX: maxDeposit and maxMint return wrong value when contract is paused",
  "Content": "# Lines of code\n\nhttps://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L156-L162\n\n\n# Vulnerability details\n\n## Impact\nThe `TokenggAVAX` contract ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L24](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L24)) can be paused.  \n\nThe `whenTokenNotPaused` modifier is applied to the following functions ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L225-L239](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L225-L239)):  \n`previewDeposit`, `previewMint`, `previewWithdraw` and `previewRedeem`  \n\nThereby any calls to functions that deposit or withdraw funds revert.  \n\nThere are two functions (`maxWithdraw` and `maxRedeem`) that calculate the max amount that can be withdrawn or redeemed respectively.  \n\nBoth functions return `0` if the `TokenggAVAX` contract is paused.  \n\nThe issue is that `TokenggAVAX` does not override the `maxDeposit` and `maxMint` functions ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L156-L162](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L156-L162)) in the `ERC4626Upgradable` contract like it does for `maxWithdraw` and `maxRedeem`.  \n\nThereby these two functions return a value that cannot actually be deposited or minted.  \n\nThis can cause any components that rely on any of these functions to return a correct value to malfunction.  \n\nSo `maxDeposit` and `maxMint` should return the value `0` when `TokenggAVAX` is paused.  \n\n## Proof of Concept\n1. The `TokenggAVAX` contract is paused by calling `Ocyticus.pauseEverything` ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Ocyticus.sol#L37-L43](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Ocyticus.sol#L37-L43))\n2. `TokenggAVAX.maxDeposit` returns `type(uint256).max` ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L157](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L157))\n3. However `deposit` cannot be called with this value because it is paused (`previewDeposit` reverts because of the `whenTokenNotPaused` modifier) ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L44](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L44))\n\n## Tools Used\nVSCode\n\n## Recommended Mitigation Steps\nThe `maxDeposit` and `maxMint` functions should be overridden by `TokenggAVAX` just like `maxWithdraw` and `maxRedeem` are overridden and return `0` when the contract is paused ([https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L206-L223](https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L206-L223)).  \n\nSo add these two functions to the `TokenggAVAX` contract:  \n```solidity\nfunction maxDeposit(address) public view override returns (uint256) {\n    if (getBool(keccak256(abi.encodePacked(\"contract.paused\", \"TokenggAVAX\")))) {\n        return 0;\n    }\n    return return type(uint256).max;\n}\n\nfunction maxMint(address) public view override returns (uint256) {\n    if (getBool(keccak256(abi.encodePacked(\"contract.paused\", \"TokenggAVAX\")))) {\n        return 0;\n    }\n    return return type(uint256).max;\n}\n```",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/contests/2022-12-gogopool-contest",
  "Code": [
    {
      "filename": "contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-only\npragma solidity >=0.8.0;\n\nimport {ERC20Upgradeable} from \"./ERC20Upgradeable.sol\";\n\nimport {ERC20} from \"@rari-capital/solmate/src/tokens/ERC20.sol\";\nimport {FixedPointMathLib} from \"@rari-capital/solmate/src/utils/FixedPointMathLib.sol\";\nimport {SafeTransferLib} from \"@rari-capital/solmate/src/utils/SafeTransferLib.sol\";\nimport {Initializable} from \"@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol\";\n\nabstract contract ERC4626Upgradeable is Initializable, ERC20Upgradeable {\n\tusing SafeTransferLib for ERC20;\n\tusing FixedPointMathLib for uint256;\n\n\t/*//////////////////////////////////////////////////////////////\n\t\tEVENTS\n\t//////////////////////////////////////////////////////////////*/\n\n\tevent Deposit(address indexed caller, address indexed owner, uint256 assets, uint256 shares);\n\n\tevent Withdraw(address indexed caller, address indexed receiver, address indexed owner, uint256 assets, uint256 shares);\n\n\t/*//////////////////////////////////////////////////////////////\n\t\tIMMUTABLES\n\t\t//////////////////////////////////////////////////////////////*/\n\n\tERC20 public asset;\n\n\tfunction __ERC4626Upgradeable_init(\n\t\tERC20 _asset,\n\t\tstring memory _name,\n\t\tstring memory _symbol\n\t) internal onlyInitializing {\n\t\t__ERC20Upgradeable_init(_name, _symbol, _asset.decimals());\n\t\tasset = _asset;\n\t}\n\n\t/*//////////////////////////////////////////////////////////////\n\t\t\tDEPOSIT/WITHDRAWAL LOGIC\n\t\t//////////////////////////////////////////////////////////////*/\n\n\tfunction deposit(uint256 assets, address receiver) public virtual returns (uint256 shares) {\n\t\t// Check for rounding error since we round down in previewDeposit.\n\t\trequire((shares = previewDeposit(assets)) != 0, \"ZERO_SHARES\");\n\n\t\t// Need to transfer before minting or ERC777s could reenter.\n\t\tasset.safeTransferFrom(msg.sender, address(this), assets);\n\n\t\t_mint(receiver, shares);\n\n\t\temit Deposit(msg.sender, receiver, assets, shares);\n\n\t\tafterDeposit(assets, shares);\n\t}\n\n\tfunction mint(uint256 shares, address receiver) public virtual returns (uint256 assets) {\n\t\tassets = previewMint(shares); // No need to check for rounding error, previewMint rounds up.\n\n\t\t// Need to transfer before minting or ERC777s could reenter.\n\t\tasset.safeTransferFrom(msg.sender, address(this), assets);\n\n\t\t_mint(receiver, shares);\n\n\t\temit Deposit(msg.sender, receiver, assets, shares);\n\n\t\tafterDeposit(assets, shares);\n\t}\n\n\tfunction withdraw(\n\t\tuint256 assets,\n\t\taddress receiver,\n\t\taddress owner\n\t) public virtual returns (uint256 shares) {\n\t\tshares = previewWithdraw(assets); // No need to check for rounding error, previewWithdraw rounds up.\n\n\t\tif (msg.sender != owner) {\n\t\t\tuint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.\n\n\t\t\tif (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;\n\t\t}\n\n\t\tbeforeWithdraw(assets, shares);\n\n\t\t_burn(owner, shares);\n\n\t\temit Withdraw(msg.sender, receiver, owner, assets, shares);\n\n\t\tasset.safeTransfer(receiver, assets);\n\t}\n\n\tfunction redeem(\n\t\tuint256 shares,\n\t\taddress receiver,\n\t\taddress owner\n\t) public virtual returns (uint256 assets) {\n\t\tif (msg.sender != owner) {\n\t\t\tuint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.\n\n\t\t\tif (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;\n\t\t}\n\n\t\t// Check for rounding error since we round down in previewRedeem.\n\t\trequire((assets = previewRedeem(shares)) != 0, \"ZERO_ASSETS\");\n\n\t\tbeforeWithdraw(assets, shares);\n\n\t\t_burn(owner, shares);\n\n\t\temit Withdraw(msg.sender, receiver, owner, assets, shares);\n\n\t\tasset.safeTransfer(receiver, assets);\n\t}\n\n\t/*//////////////////////////////////////////////////////////////\n\t\tACCOUNTING LOGIC\n\t//////////////////////////////////////////////////////////////*/\n\n\tfunction totalAssets() public view virtual returns (uint256);\n\n\tfunction convertToShares(uint256 assets) public view virtual returns (uint256) {\n\t\tuint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.\n\n\t\treturn supply == 0 ? assets : assets.mulDivDown(supply, totalAssets());\n\t}\n\n\tfunction convertToAssets(uint256 shares) public view virtual returns (uint256) {\n\t\tuint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.\n\n\t\treturn supply == 0 ? shares : shares.mulDivDown(totalAssets(), supply);\n\t}\n\n\tfunction previewDeposit(uint256 assets) public view virtual returns (uint256) {\n\t\treturn convertToShares(assets);\n\t}\n\n\tfunction previewMint(uint256 shares) public view virtual returns (uint256) {\n\t\tuint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.\n\n\t\treturn supply == 0 ? shares : shares.mulDivUp(totalAssets(), supply);\n\t}\n\n\tfunction previewWithdraw(uint256 assets) public view virtual returns (uint256) {\n\t\tuint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.\n\n\t\treturn supply == 0 ? assets : assets.mulDivUp(supply, totalAssets());\n\t}\n\n\tfunction previewRedeem(uint256 shares) public view virtual returns (uint256) {\n\t\treturn convertToAssets(shares);\n\t}\n\n\t/*//////////////////////////////////////////////////////////////\n\t\tDEPOSIT/WITHDRAWAL LIMIT LOGIC\n\t//////////////////////////////////////////////////////////////*/\n\n\tfunction maxDeposit(address) public view virtual returns (uint256) {\n\t\treturn type(uint256).max;\n\t}\n\n\tfunction maxMint(address) public view virtual returns (uint256) {\n\t\treturn type(uint256).max;\n\t}\n\n\tfunction maxWithdraw(address owner) public view virtual returns (uint256) {\n\t\treturn convertToAssets(balanceOf[owner]);\n\t}\n\n\tfunction maxRedeem(address owner) public view virtual returns (uint256) {\n\t\treturn balanceOf[owner];\n\t}\n\n\t/*//////////////////////////////////////////////////////////////\n\t\tINTERNAL HOOKS LOGIC\n\t//////////////////////////////////////////////////////////////*/\n\n\tfunction beforeWithdraw(uint256 assets, uint256 shares) internal virtual {}\n\n\tfunction afterDeposit(uint256 assets, uint256 shares) internal virtual {}\n}"
    }
  ]
}