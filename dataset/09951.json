{
  "Title": "[L-01] ",
  "Content": "<h2 id=\"l-01-approvalfollowmodulesol-lack-of-transfer-check-make-it-possible-for-anyone-to-become-follower-without-approved-by-the-profile-owner\" style=\"position:relative;\"><a href=\"#l-01-approvalfollowmodulesol-lack-of-transfer-check-make-it-possible-for-anyone-to-become-follower-without-approved-by-the-profile-owner\" aria-label=\"l 01 approvalfollowmodulesol lack of transfer check make it possible for anyone to become follower without approved by the profile owner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>ApprovalFollowModule.sol</code> lack of transfer check make it possible for anyone to become follower without approved by the profile owner</h2>\n<p>Per the comment in <code>ApprovalFollowModule</code>, it aims to create a whitelist system:</p>\n<blockquote>\n<p>This follow module only allows addresses that are approved for a profile by the profile owner to follow.</p>\n</blockquote>\n<p>However, the current implementation only validates if <code>_approvedByProfileByOwner</code> when minting a new <code>followNFT</code>. But since the <code>follow</code> relationship is verified by the <code>followNFT</code> and the <code>followNFT</code> can be transferred to an arbitrary address.</p>\n<p>As a result, a non-whitelisted address can bypass the whitelist by buying the <code>followNFT</code> from a whitelisted address.</p>\n<p>The <code>followModuleTransferHook</code> can be used for blocking transfers to unapproved addresses.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/follow/FollowValidatorFollowModuleBase.sol#L23-L38\">FollowValidatorFollowModuleBase.sol#L23-L38</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">validateFollow</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followNFTTokenId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ILensHub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getFollowNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">followNFTTokenId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that follower owns a followNFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">follower</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that follower owns the specific followNFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followNFTTokenId</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice created a private club and selected <code>ApprovalFollowModule</code> with 100 addresses of founding members and wanted to publish publications that can only be collected by those addresses;</li>\n<li>Bob as founding members of Alice’s private club, decides to sell his membership to Charlie by transfering the <code>followNFT</code> to Charlie, Charlie’s address has never be approved by Alice, but he is now a <code>follower</code> in Alice’s private club.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">followModuleTransferHook</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followNFTTokenId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_approvedByProfileByOwner</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">to</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowNotApproved</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_approvedByProfileByOwner</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">to</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// prevents repeat follows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1042476748\">oneski (Aave Lens) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is by design. A more sophisticated module could implement non-transferable behavior or allow transfer only to approved addresses.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1118561892\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>IMO, this is a valid issue. If we want to strictly adhere to the whitelist, we should not allow whitelisted addresses to transfer NFTs to non-whitelisted addresses. This limits the formation of secondary markets where users can bypass whitelist restrictions.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1125577120\">Zer0dot (Aave Lens) disagreed with Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>Unfortunately transferrability is in the nature of the protocol. The module’s purpose is not to limit follows to only whitelisted wallets (as this is impossible to guarantee in case follow NFTs existed previously, though one could use the validation function etc). Rather, the goal of this module is simply to only allow whitelisted users to mint follow NFTs, what they do with them is up to them. </p>\n<p>Due to the confusing nature of the module, I would not dispute this but I would still disagree that it’s a medium severity issue, I would mark it as low.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126113275\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>So if I’m understanding this correctly, whitelisted users who mint follow NFTs are free to do whatever with those, whether they sell them to other parties or give them away. It’s completely up to them?</p>\n<p>If that’s the case, I’ll agree and mark this as QA.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126121278\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Yeah although it’s valid enough, this is just how the module works.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126126555\">0xleastwood (judge) decreased severity to Low and commented</a>:</strong></p>\n<blockquote>\n<p>Okay, QA it is, good ser.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 12 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/44\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/56\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/41\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/17\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/74\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/75\">nahnah</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/13\">d4rk</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/84\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/83\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/79\">gzeon</a>, and <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/39\">0x1f8b</a>.</em></p>\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/contests/2022-02-aave-lens-contest",
  "Code": [
    {
      "filename": "contracts/core/modules/follow/FollowValidatorFollowModuleBase.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-only\n\npragma solidity 0.8.10;\n\nimport {IFollowModule} from '../../../interfaces/IFollowModule.sol';\nimport {ILensHub} from '../../../interfaces/ILensHub.sol';\nimport {Errors} from '../../../libraries/Errors.sol';\nimport {ModuleBase} from '../ModuleBase.sol';\nimport {IERC721} from '@openzeppelin/contracts/token/ERC721/IERC721.sol';\n\n/**\n * @title FollowValidatorFollowModuleBase\n * @author Lens Protocol\n *\n * @notice This abstract contract adds the default expected behavior for follow validation in a follow module\n * to inheriting contracts.\n */\nabstract contract FollowValidatorFollowModuleBase is IFollowModule, ModuleBase {\n    /**\n     * @notice Standard function to validate follow NFT ownership. This module is agnostic to follow NFT token IDs\n     * and other properties.\n     */\n    function validateFollow(\n        uint256 profileId,\n        address follower,\n        uint256 followNFTTokenId\n    ) external view override {\n        address followNFT = ILensHub(HUB).getFollowNFT(profileId);\n        if (followNFT == address(0)) revert Errors.FollowInvalid();\n        if (followNFTTokenId == 0) {\n            // check that follower owns a followNFT\n            if (IERC721(followNFT).balanceOf(follower) == 0) revert Errors.FollowInvalid();\n        } else {\n            // check that follower owns the specific followNFT\n            if (IERC721(followNFT).ownerOf(followNFTTokenId) != follower)\n                revert Errors.FollowInvalid();\n        }\n    }\n}"
    }
  ]
}