{
  "Title": "[L-02]  Wrong interest during leap years",
  "Content": "The `calculateLinearInterest()` function uses `SECONDS_PER_YEAR`, which is a constant, so the constant will have the wrong value during leap years. While the function is out of scope, it's eventually called by `PoolCore:getNormalizedIncome()`, which _is_ in scope.\n\n*There is 1 instance of this issue:*\n```solidity\nFile: /paraspace-core/contracts/protocol/libraries/math/MathUtils.sol\n\n23       function calculateLinearInterest(uint256 rate, uint40 lastUpdateTimestamp)\n24           internal\n25           view\n26           returns (uint256)\n27       {\n28           //solium-disable-next-line\n29           uint256 result = rate *\n30               (block.timestamp - uint256(lastUpdateTimestamp));\n31           unchecked {\n32               result = result / SECONDS_PER_YEAR;\n33           }\n34   \n35           return WadRayMath.RAY + result;\n36:      }\n\n```\nhttps://github.com/code-423n4/2022-11-paraspace/blob/c6820a279c64a299a783955749fdc977de8f0449/paraspace-core/contracts/protocol/libraries/math/MathUtils.sol#L23-L36\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2022-11-paraspace",
  "Code": [
    {
      "filename": "paraspace-core/contracts/protocol/libraries/math/MathUtils.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity 0.8.10;\n\nimport {WadRayMath} from \"./WadRayMath.sol\";\n\n/**\n * @title MathUtils library\n *\n * @notice Provides functions to perform linear and compounded interest calculations\n */\nlibrary MathUtils {\n    using WadRayMath for uint256;\n\n    /// @dev Ignoring leap years\n    uint256 internal constant SECONDS_PER_YEAR = 365 days;\n\n    /**\n     * @dev Function to calculate the interest accumulated using a linear interest rate formula\n     * @param rate The interest rate, in ray\n     * @param lastUpdateTimestamp The timestamp of the last update of the interest\n     * @return The interest rate linearly accumulated during the timeDelta, in ray\n     **/\n    function calculateLinearInterest(uint256 rate, uint40 lastUpdateTimestamp)\n        internal\n        view\n        returns (uint256)\n    {\n        //solium-disable-next-line\n        uint256 result = rate *\n            (block.timestamp - uint256(lastUpdateTimestamp));\n        unchecked {\n            result = result / SECONDS_PER_YEAR;\n        }\n\n        return WadRayMath.RAY + result;\n    }\n\n    /**\n     * @dev Function to calculate the interest using a compounded interest rate formula\n     * To avoid expensive exponentiation, the calculation is performed using a binomial approximation:\n     *\n     *  (1+x)^n = 1+n*x+[n/2*(n-1)]*x^2+[n/6*(n-1)*(n-2)*x^3...\n     *\n     * The approximation slightly underpays liquidity providers and undercharges borrowers, with the advantage of great\n     * gas cost reductions. The whitepaper contains reference to the approximation and a table showing the margin of\n     * error per different time periods\n     *\n     * @param rate The interest rate, in ray\n     * @param lastUpdateTimestamp The timestamp of the last update of the interest\n     * @return The interest rate compounded during the timeDelta, in ray\n     **/\n    function calculateCompoundedInterest(\n        uint256 rate,\n        uint40 lastUpdateTimestamp,\n        uint256 currentTimestamp\n    ) internal pure returns (uint256) {\n        //solium-disable-next-line\n        uint256 exp = currentTimestamp - uint256(lastUpdateTimestamp);\n\n        if (exp == 0) {\n            return WadRayMath.RAY;\n        }\n\n        uint256 expMinusOne;\n        uint256 expMinusTwo;\n        uint256 basePowerTwo;\n        uint256 basePowerThree;\n        unchecked {\n            expMinusOne = exp - 1;\n\n            expMinusTwo = exp > 2 ? exp - 2 : 0;\n\n            basePowerTwo =\n                rate.rayMul(rate) /\n                (SECONDS_PER_YEAR * SECONDS_PER_YEAR);\n            basePowerThree = basePowerTwo.rayMul(rate) / SECONDS_PER_YEAR;\n        }\n\n        uint256 secondTerm = exp * expMinusOne * basePowerTwo;\n        unchecked {\n            secondTerm /= 2;\n        }\n        uint256 thirdTerm = exp * expMinusOne * expMinusTwo * basePowerThree;\n        unchecked {\n            thirdTerm /= 6;\n        }\n\n        return\n            WadRayMath.RAY +\n            (rate * exp) /\n            SECONDS_PER_YEAR +\n            secondTerm +\n            thirdTerm;\n    }\n\n    /**\n     * @dev Calculates the compounded interest between the timestamp of the last update and the current block timestamp\n     * @param rate The interest rate (in ray)\n     * @param lastUpdateTimestamp The timestamp from which the interest accumulation needs to be calculated\n     * @return The interest rate compounded between lastUpdateTimestamp and current block timestamp, in ray\n     **/\n    function calculateCompoundedInterest(\n        uint256 rate,\n        uint40 lastUpdateTimestamp\n    ) internal view returns (uint256) {\n        return\n            calculateCompoundedInterest(\n                rate,\n                lastUpdateTimestamp,\n                block.timestamp\n            );\n    }\n}"
    }
  ]
}