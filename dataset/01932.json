{
  "Title": "H-1: All allowances to DepositStableCoinToDealer and GeneralRepay can be stolen due to unsafe call",
  "Content": "# Issue H-1: All allowances to DepositStableCoinToDealer and GeneralRepay can be stolen due to unsafe call \n\nSource: https://github.com/sherlock-audit/2023-04-jojo-judging/issues/428 \n\n## Found by \n0x52, 0xkazim, ArbitraryExecution, Bauer, BowTiedOriole, GalloDaSballo, Inspex, Jigsaw, MalfurionWhitehat, XDZIBEC, ctf\\_sec, dingo, jprod15, lil.eth, tvdung94, yy\n## Summary\n\nDepositStableCoinToDealer.sol and GeneralRepay.sol are helper contracts that allow a user to swap and enter JOJODealer and JUSDBank respectively. The issue is that the call is unsafe allowing the contract to call the token contracts directly and transfer tokens from anyone who has approved the contract.\n\n## Vulnerability Detail\n\nhttps://github.com/sherlock-audit/2023-04-jojo/blob/main/smart-contract-EVM/contracts/stableCoin/DepositStableCoinToDealer.sol#L30-L44\n\n        IERC20(asset).safeTransferFrom(msg.sender, address(this), amount);\n        (address approveTarget, address swapTarget, bytes memory data) = abi\n        .decode(param, (address, address, bytes));\n        // if usdt\n        IERC20(asset).approve(approveTarget, 0);\n        IERC20(asset).approve(approveTarget, amount);\n        (bool success, ) = swapTarget.call(data);\n        if (success == false) {\n            assembly {\n                let ptr := mload(0x40)\n                let size := returndatasize()\n                returndatacopy(ptr, 0, size)\n                revert(ptr, size)\n            }\n        }\n\nWe can see above that the call is totally unprotected allowing a user to make any call to any contract. This can be abused by calling the token contract and using the allowances of others. The attack would go as follows:\n\n1. User A approves the contract for 100 USDT\n2. User B sees this approval and calls depositStableCoin with the swap target as the USDT contract with themselves as the receiver\n3. This transfers all of user A USDT to them\n\n## Impact\n\nAll allowances can be stolen\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-04-jojo/blob/main/smart-contract-EVM/contracts/stableCoin/DepositStableCoinToDealer.sol#L23C14-L50\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nOnly allow users to call certain whitelisted contracts.\n\n\n\n## Discussion\n\n**JoscelynFarr**\n\nfix link:\nhttps://github.com/JOJOexchange/JUSDV1/commit/5770d15edac41c78d9726f02e988aa8e14601f3e\nhttps://github.com/JOJOexchange/smart-contract-EVM/commit/94ea554ec1c563e945bd388051f6438826818b47\n\n**IAm0x52**\n\nFixes look good. GeneralRepay and DepositStableCoinToDealer now implement contract whitelists\n\n",
  "Impact": "HIGH",
  "Source": "https://app.sherlock.xyz/audits/contests/70",
  "Code": [
    {
      "filename": "smart-contract-EVM/contracts/stableCoin/DepositStableCoinToDealer.sol",
      "content": "/*\n    Copyright 2022 JOJO Exchange\n    SPDX-License-Identifier: BUSL-1.1*/\npragma solidity 0.8.9;\nimport \"@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol\";\nimport \"../intf/IDealer.sol\";\n\ncontract DepositStableCoinToDealer {\n\n    using SafeERC20 for IERC20;\n\n    address public immutable JOJODealer;\n    address public immutable USDC;\n\n    constructor(\n        address _JOJODealer,\n        address _USDC\n    ) {\n        JOJODealer = _JOJODealer;\n        USDC = _USDC;\n    }\n\n    function depositStableCoin(\n        address asset,\n        uint256 amount,\n        address to,\n        bytes calldata param,\n        uint256 minReceive\n    ) external {\n        IERC20(asset).safeTransferFrom(msg.sender, address(this), amount);\n        (address approveTarget, address swapTarget, bytes memory data) = abi\n        .decode(param, (address, address, bytes));\n        // if usdt\n        IERC20(asset).approve(approveTarget, 0);\n        IERC20(asset).approve(approveTarget, amount);\n        (bool success, ) = swapTarget.call(data);\n        if (success == false) {\n            assembly {\n                let ptr := mload(0x40)\n                let size := returndatasize()\n                returndatacopy(ptr, 0, size)\n                revert(ptr, size)\n            }\n        }\n\n        uint256 USDCAmount = IERC20(USDC).balanceOf(address(this));\n        require(USDCAmount >= minReceive,\"receive amount is too small\");\n        IERC20(USDC).approve(JOJODealer, USDCAmount);\n        IDealer(JOJODealer).deposit(USDCAmount, 0, to);\n    }\n}"
    },
    {
      "filename": "smart-contract-EVM/contracts/stableCoin/DepositStableCoinToDealer.sol",
      "content": "/*\n    Copyright 2022 JOJO Exchange\n    SPDX-License-Identifier: BUSL-1.1*/\npragma solidity 0.8.9;\nimport \"@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol\";\nimport \"../intf/IDealer.sol\";\n\ncontract DepositStableCoinToDealer {\n\n    using SafeERC20 for IERC20;\n\n    address public immutable JOJODealer;\n    address public immutable USDC;\n\n    constructor(\n        address _JOJODealer,\n        address _USDC\n    ) {\n        JOJODealer = _JOJODealer;\n        USDC = _USDC;\n    }\n\n    function depositStableCoin(\n        address asset,\n        uint256 amount,\n        address to,\n        bytes calldata param,\n        uint256 minReceive\n    ) external {\n        IERC20(asset).safeTransferFrom(msg.sender, address(this), amount);\n        (address approveTarget, address swapTarget, bytes memory data) = abi\n        .decode(param, (address, address, bytes));\n        // if usdt\n        IERC20(asset).approve(approveTarget, 0);\n        IERC20(asset).approve(approveTarget, amount);\n        (bool success, ) = swapTarget.call(data);\n        if (success == false) {\n            assembly {\n                let ptr := mload(0x40)\n                let size := returndatasize()\n                returndatacopy(ptr, 0, size)\n                revert(ptr, size)\n            }\n        }\n\n        uint256 USDCAmount = IERC20(USDC).balanceOf(address(this));\n        require(USDCAmount >= minReceive,\"receive amount is too small\");\n        IERC20(USDC).approve(JOJODealer, USDCAmount);\n        IDealer(JOJODealer).deposit(USDCAmount, 0, to);\n    }\n}"
    }
  ]
}