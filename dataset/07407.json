{
  "Title": "[G-17]  Use custom errors rather than `revert()`/`require()` strings to save gas",
  "Content": "Custom errors are available from solidity version 0.8.4. Custom errors save [**~50 gas**](https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746) each time they're hit by [avoiding having to allocate and store the revert string](https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth). Not defining the strings also save deployment gas\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/libraries/OracleLibrary.sol\n\n/// @audit (valid but excluded finding)\n39:           require(twapDuration != 0, \"BP\");\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L39\n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/124#issuecomment-1364719842):**\n > Please also view [#13](https://github.com/code-423n4/2022-12-backed-findings/issues/13) for an excellent gas report.\n\n***\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/reports/2022-12-backed",
  "Code": [
    {
      "filename": "src/libraries/OracleLibrary.sol",
      "content": "// SPDX-License-Identifier: GPL-2.0-or-later\npragma solidity >=0.8.0;\n\nimport {IUniswapV3Pool} from \"v3-core/contracts/interfaces/IUniswapV3Pool.sol\";\nimport {TickMath} from \"fullrange/libraries/TickMath.sol\";\nimport {FullMath} from \"fullrange/libraries/FullMath.sol\";\n\nlibrary OracleLibrary {\n    /// from https://github.com/Uniswap/v3-periphery/blob/main/contracts/libraries/OracleLibrary.sol#L49\n    function getQuoteAtTick(int24 tick, uint128 baseAmount, address baseToken, address quoteToken)\n        internal\n        pure\n        returns (uint256 quoteAmount)\n    {\n        unchecked {\n            uint160 sqrtRatioX96 = TickMath.getSqrtRatioAtTick(tick);\n\n            // Calculate quoteAmount with better precision if it doesn't overflow when multiplied by itself\n            if (sqrtRatioX96 <= type(uint128).max) {\n                uint256 ratioX192 = uint256(sqrtRatioX96) * sqrtRatioX96;\n                quoteAmount = baseToken < quoteToken\n                    ? FullMath.mulDiv(ratioX192, baseAmount, 1 << 192)\n                    : FullMath.mulDiv(1 << 192, baseAmount, ratioX192);\n            } else {\n                uint256 ratioX128 = FullMath.mulDiv(sqrtRatioX96, sqrtRatioX96, 1 << 64);\n                quoteAmount = baseToken < quoteToken\n                    ? FullMath.mulDiv(ratioX128, baseAmount, 1 << 128)\n                    : FullMath.mulDiv(1 << 128, baseAmount, ratioX128);\n            }\n        }\n    }\n\n    // adapted from https://github.com/Uniswap/v3-periphery/blob/main/contracts/libraries/OracleLibrary.sol#L30-L40\n    function timeWeightedAverageTick(int56 startTick, int56 endTick, int56 twapDuration)\n        internal\n        view\n        returns (int24 twat)\n    {\n        require(twapDuration != 0, \"BP\");\n\n        unchecked {\n            int56 delta = endTick - startTick;\n\n            twat = int24(delta / twapDuration);\n\n            // Always round to negative infinity\n            if (delta < 0 && (delta % (twapDuration) != 0)) {\n                twat--;\n            }\n\n            twat;\n        }\n    }\n\n    // adapted from https://github.com/Uniswap/v3-periphery/blob/main/contracts/libraries/OracleLibrary.sol#L21-L28\n    function latestCumulativeTick(address pool) internal view returns (int56) {\n        uint32[] memory secondAgos = new uint32[](1);\n        secondAgos[0] = 0;\n        (int56[] memory tickCumulatives,) = IUniswapV3Pool(pool).observe(secondAgos);\n        return tickCumulatives[0];\n    }\n}"
    }
  ]
}