{
  "Title": "LibUnripeConvert.sol :: getBeanAmountOut() incorrectly calculates the amount of BEAN.",
  "Content": "# LibUnripeConvert.sol :: getBeanAmountOut() incorrectly calculates the amount of BEAN.\n\n### Severity\nMedium Risk\n\n### Relevant GitHub Links\n<a data-meta=\"codehawks-github-link\" href=\"https://github.com/Cyfrin/2024-04-beanstalk-2/blob/27ff8c87c9164c1fbff054be5f22e56f86cdf127/protocol/contracts/libraries/Convert/LibUnripeConvert.sol#L130-L145\">https://github.com/Cyfrin/2024-04-beanstalk-2/blob/27ff8c87c9164c1fbff054be5f22e56f86cdf127/protocol/contracts/libraries/Convert/LibUnripeConvert.sol#L130-L145</a>\n\n\n## Summary\n**`getBeanAmountOut()`** incorrectly uses **`C.UNRIPE_BEAN.totalSupply()`**  instead of **`C.UNRIPE_LP.totalSupply()`**  to calculate the BEAN amount, resulting in an incorrect calculation.\n## Vulnerability Details\n**`getBeanAmountOut()`**  calculates the amount of BEAN tokens a user would receive per BEAN:3CRV LP provided.\n```Solidity\nfunction getBeanAmountOut(uint256 amountIn)\n        internal\n        view\n        returns (uint256 bean)\n    {   \n        uint256 lp = LibUnripe.unripeToUnderlying(\n            C.UNRIPE_LP,\n            amountIn,\n@>          IBean(C.UNRIPE_BEAN).totalSupply()  \n        );\n        bean = LibWellConvert.getBeanAmountOut(LibBarnRaise.getBarnRaiseWell(), lp);\n        bean = LibUnripe\n            .underlyingToUnripe(C.UNRIPE_BEAN, bean)\n            .mul(LibUnripe.percentBeansRecapped())\n            .div(LibUnripe.percentLPRecapped());\n    }\n```\nAs observed, the calculation in **`getBeanAmountOut()`**  mistakenly utilizes **`IBean(C.UNRIPE_BEAN).totalSupply()`**  to determine the LP. However, this line calculates the LP not the BEAN token amount. The correct implementation is using **`IBean(C.UNRIPE_LP).totalSupply()`**  to next calcualte correctly the desired BEAN token quantity.\n## Impact\nThe BEAN token amount obtained is incorrect.\n## Tools Used\nManual review.\n## Recommendations\nChange **`IBean(C.UNRIPE_BEAN).totalSupply()`**  for **`IBean(C.UNRIPE_LP).totalSupply()`** .\n```diff\nfunction getBeanAmountOut(uint256 amountIn)\n        internal\n        view\n        returns (uint256 bean)\n    {   \n        uint256 lp = LibUnripe.unripeToUnderlying(\n            C.UNRIPE_LP,\n            amountIn,\n-          IBean(C.UNRIPE_BEAN).totalSupply()\n+          IBean(C.UNRIPE_LP).totalSupply() \n        );\n        bean = LibWellConvert.getBeanAmountOut(LibBarnRaise.getBarnRaiseWell(), lp);\n        bean = LibUnripe\n            .underlyingToUnripe(C.UNRIPE_BEAN, bean)\n            .mul(LibUnripe.percentBeansRecapped())\n            .div(LibUnripe.percentLPRecapped());\n    }\n```",
  "Impact": "LOW",
  "Source": "https://www.codehawks.com/contests/clu7665bs0001fmt5yahc8tyh",
  "Code": [
    {
      "filename": "protocol/contracts/libraries/Convert/LibUnripeConvert.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity =0.7.6;\npragma experimental ABIEncoderV2;\n\nimport {C} from \"contracts/C.sol\";\nimport {IBean} from \"contracts/interfaces/IBean.sol\";\nimport {LibWellConvert} from \"./LibWellConvert.sol\";\nimport {LibUnripe} from \"../LibUnripe.sol\";\nimport {LibConvertData} from \"./LibConvertData.sol\";\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\nimport {LibBarnRaise} from \"contracts/libraries/LibBarnRaise.sol\";\n\n/**\n * @title LibUnripeConvert\n * @author Publius\n */\nlibrary LibUnripeConvert {\n    using LibConvertData for bytes;\n    using SafeMath for uint256;\n\n    function convertLPToBeans(bytes memory convertData)\n        internal\n        returns (\n            address tokenOut,\n            address tokenIn,\n            uint256 amountOut,\n            uint256 amountIn\n        )\n    {\n        tokenOut = C.UNRIPE_BEAN;\n        tokenIn = C.UNRIPE_LP;\n        (uint256 lp, uint256 minBeans) = convertData.basicConvert();\n        uint256 minAmountOut = LibUnripe\n            .unripeToUnderlying(tokenOut, minBeans, IBean(C.UNRIPE_BEAN).totalSupply())\n            .mul(LibUnripe.percentLPRecapped())\n            .div(LibUnripe.percentBeansRecapped());\n        (\n            uint256 outUnderlyingAmount,\n            uint256 inUnderlyingAmount\n        ) = LibWellConvert._wellRemoveLiquidityTowardsPeg(\n                LibUnripe.unripeToUnderlying(tokenIn, lp, IBean(C.UNRIPE_LP).totalSupply()),\n                minAmountOut,\n                LibBarnRaise.getBarnRaiseWell()\n            );\n\n        amountIn = LibUnripe.underlyingToUnripe(tokenIn, inUnderlyingAmount);\n        LibUnripe.removeUnderlying(tokenIn, inUnderlyingAmount);\n        IBean(tokenIn).burn(amountIn);\n\n        amountOut = LibUnripe\n            .underlyingToUnripe(tokenOut, outUnderlyingAmount)\n            .mul(LibUnripe.percentBeansRecapped())\n            .div(LibUnripe.percentLPRecapped());\n        LibUnripe.addUnderlying(tokenOut, outUnderlyingAmount);\n        IBean(tokenOut).mint(address(this), amountOut);\n    }\n\n    function convertBeansToLP(bytes memory convertData)\n        internal\n        returns (\n            address tokenOut,\n            address tokenIn,\n            uint256 amountOut,\n            uint256 amountIn\n        )\n    {\n        tokenIn = C.UNRIPE_BEAN;\n        tokenOut = C.UNRIPE_LP;\n        (uint256 beans, uint256 minLP) = convertData.basicConvert();\n        uint256 minAmountOut = LibUnripe\n            .unripeToUnderlying(tokenOut, minLP, IBean(C.UNRIPE_LP).totalSupply())\n            .mul(LibUnripe.percentBeansRecapped())\n            .div(LibUnripe.percentLPRecapped());\n        (\n            uint256 outUnderlyingAmount,\n            uint256 inUnderlyingAmount\n        ) = LibWellConvert._wellAddLiquidityTowardsPeg(\n                LibUnripe.unripeToUnderlying(tokenIn, beans, IBean(C.UNRIPE_BEAN).totalSupply()),\n                minAmountOut,\n                LibBarnRaise.getBarnRaiseWell()\n            );\n\n        amountIn = LibUnripe.underlyingToUnripe(tokenIn, inUnderlyingAmount);\n        LibUnripe.removeUnderlying(tokenIn, inUnderlyingAmount);\n        IBean(tokenIn).burn(amountIn);\n\n        amountOut = LibUnripe\n            .underlyingToUnripe(tokenOut, outUnderlyingAmount)\n            .mul(LibUnripe.percentLPRecapped())\n            .div(LibUnripe.percentBeansRecapped());\n        LibUnripe.addUnderlying(tokenOut, outUnderlyingAmount);\n        IBean(tokenOut).mint(address(this), amountOut);\n    }\n\n    function beansToPeg() internal view returns (uint256 beans) {\n        uint256 underlyingBeans = LibWellConvert.beansToPeg(\n            LibBarnRaise.getBarnRaiseWell()\n        );\n        beans = LibUnripe.underlyingToUnripe(\n            C.UNRIPE_BEAN,\n            underlyingBeans\n        );\n    }\n\n    function lpToPeg() internal view returns (uint256 lp) {\n        uint256 underlyingLP = LibWellConvert.lpToPeg(\n            LibBarnRaise.getBarnRaiseWell()\n        );\n        lp = LibUnripe.underlyingToUnripe(C.UNRIPE_LP, underlyingLP);\n    }\n\n    function getLPAmountOut(uint256 amountIn)\n        internal\n        view\n        returns (uint256 lp)\n    {\n        uint256 beans = LibUnripe.unripeToUnderlying(\n            C.UNRIPE_BEAN,\n            amountIn,\n            IBean(C.UNRIPE_BEAN).totalSupply()\n        );\n        lp = LibWellConvert.getLPAmountOut(LibBarnRaise.getBarnRaiseWell(), beans);\n        lp = LibUnripe\n            .underlyingToUnripe(C.UNRIPE_LP, lp)\n            .mul(LibUnripe.percentLPRecapped())\n            .div(LibUnripe.percentBeansRecapped());\n    }\n\n    function getBeanAmountOut(uint256 amountIn)\n        internal\n        view\n        returns (uint256 bean)\n    {\n        uint256 lp = LibUnripe.unripeToUnderlying(\n            C.UNRIPE_LP,\n            amountIn,\n            IBean(C.UNRIPE_BEAN).totalSupply()\n        );\n        bean = LibWellConvert.getBeanAmountOut(LibBarnRaise.getBarnRaiseWell(), lp);\n        bean = LibUnripe\n            .underlyingToUnripe(C.UNRIPE_BEAN, bean)\n            .mul(LibUnripe.percentBeansRecapped())\n            .div(LibUnripe.percentLPRecapped());\n    }\n}"
    }
  ]
}