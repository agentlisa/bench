{
  "Title": "[L-03] Missing duplicate checks in `L2SecurityCouncilMgmtFactory`'s `deploy()`",
  "Content": "\nIn `L2SecurityCouncilMgmtFactory.sol`, the `deploy()` function only checks that every address in every cohort is an owner in `govChainEmergencySCSafe`:\n\n[L2SecurityCouncilMgmtFactory.sol#L111-L121](https://github.com/ArbitrumFoundation/governance/blob/c18de53820c505fc459f766c1b224810eaeaabc5/src/security-council-mgmt/factories/L2SecurityCouncilMgmtFactory.sol#L111-L121)\n\n```solidity\n        for (uint256 i = 0; i < dp.firstCohort.length; i++) {\n            if (!govChainEmergencySCSafe.isOwner(dp.firstCohort[i])) {\n                revert AddressNotInCouncil(owners, dp.firstCohort[i]);\n            }\n        }\n\n        for (uint256 i = 0; i < dp.secondCohort.length; i++) {\n            if (!govChainEmergencySCSafe.isOwner(dp.secondCohort[i])) {\n                revert AddressNotInCouncil(owners, dp.secondCohort[i]);\n            }\n        }\n```\n\nHowever, there is no check to ensure that `firstCohort` and `secondCohort` do not contain any duplicates, or that any address in one cohort is not in the other. This makes it possible for the `SecurityCouncilManager` contract to be deployed with incorrect cohorts.\n\n### Recommendation\n\nConsider checking the following:\n- `firstCohort` and `secondCohort` do not contain any duplicates\n- An address that is in `firstCohort` must not be in `secondCohort`, and vice versa.\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2023-08-arbitrum",
  "Code": [
    {
      "filename": "src/security-council-mgmt/factories/L2SecurityCouncilMgmtFactory.sol",
      "content": "// SPDX-License-Identifier: Apache-2.0\npragma solidity 0.8.16;\n\nimport \"@openzeppelin/contracts/access/Ownable.sol\";\nimport \"@openzeppelin/contracts/utils/Address.sol\";\nimport \"../governors/SecurityCouncilMemberElectionGovernor.sol\";\nimport \"../governors/SecurityCouncilNomineeElectionGovernor.sol\";\nimport \"../SecurityCouncilManager.sol\";\nimport \"../governors/SecurityCouncilMemberRemovalGovernor.sol\";\nimport \"@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol\";\nimport \"../interfaces/ISecurityCouncilManager.sol\";\nimport \"../interfaces/IGnosisSafe.sol\";\nimport \"../../ArbitrumTimelock.sol\";\nimport \"@openzeppelin/contracts-upgradeable/governance/utils/IVotesUpgradeable.sol\";\nimport \"../../UpgradeExecRouteBuilder.sol\";\nimport \"../Common.sol\";\n\nstruct DeployParams {\n    ChainAndUpExecLocation[] upgradeExecutors;\n    address govChainEmergencySecurityCouncil;\n    address l1ArbitrumTimelock;\n    address l2CoreGovTimelock;\n    address govChainProxyAdmin;\n    address[] secondCohort;\n    address[] firstCohort;\n    address l2UpgradeExecutor;\n    address arbToken;\n    uint256 l1TimelockMinDelay;\n    uint256 removalGovVotingDelay;\n    uint256 removalGovVotingPeriod;\n    uint256 removalGovQuorumNumerator;\n    uint256 removalGovProposalThreshold;\n    uint256 removalGovVoteSuccessNumerator;\n    uint64 removalGovMinPeriodAfterQuorum;\n    uint256 removalProposalExpirationBlocks;\n    SecurityCouncilData[] securityCouncils;\n    Date firstNominationStartDate;\n    uint256 nomineeVettingDuration;\n    address nomineeVetter;\n    uint256 nomineeQuorumNumerator;\n    uint256 nomineeVotingPeriod;\n    uint256 memberVotingPeriod;\n    uint256 fullWeightDuration;\n}\n\nstruct ContractImplementations {\n    address nomineeElectionGovernor;\n    address memberElectionGovernor;\n    address securityCouncilManager;\n    address securityCouncilMemberRemoverGov;\n}\n\n/// @notice Factory for deploying L2 Security Council management contracts.\n/// Prerequisites: core Arb DAO governance contracts, and a SecurityCouncilMemberSyncAction deployed for each governed security council (on each corresponding chain)\ncontract L2SecurityCouncilMgmtFactory is Ownable {\n    event ContractsDeployed(DeployedContracts deployedContracts);\n\n    // contracts deployed by factory\n    struct DeployedContracts {\n        SecurityCouncilNomineeElectionGovernor nomineeElectionGovernor;\n        SecurityCouncilMemberElectionGovernor memberElectionGovernor;\n        ISecurityCouncilManager securityCouncilManager;\n        SecurityCouncilMemberRemovalGovernor securityCouncilMemberRemoverGov;\n        UpgradeExecRouteBuilder upgradeExecRouteBuilder;\n    }\n\n    error AddressNotInCouncil(address[] securityCouncil, address account);\n    error InvalidCohortsSize(uint256 councilSize, uint256 firstCohortSize, uint256 secondCohortSize);\n\n    /// @dev deploys a transparent proxy for the given implementation contract\n    function _deployProxy(address proxyAdmin, address impl, bytes memory initData)\n        internal\n        returns (address)\n    {\n        return address(new TransparentUpgradeableProxy(impl, proxyAdmin, initData));\n    }\n\n    /// @notice deploys the L2 Security Council management contracts\n    /// @param  dp the deployment parameters\n    /// @param  impls contract implementations to deploy proxies for\n    function deploy(DeployParams memory dp, ContractImplementations memory impls)\n        external\n        onlyOwner\n        returns (DeployedContracts memory)\n    {\n        if (!Address.isContract(dp.govChainEmergencySecurityCouncil)) {\n            revert NotAContract(dp.govChainEmergencySecurityCouncil);\n        }\n\n        if (!Address.isContract(dp.govChainProxyAdmin)) {\n            revert NotAContract(dp.govChainProxyAdmin);\n        }\n\n        if (!Address.isContract(dp.l2UpgradeExecutor)) {\n            revert NotAContract(dp.l2UpgradeExecutor);\n        }\n\n        if (!Address.isContract(dp.arbToken)) {\n            revert NotAContract(dp.arbToken);\n        }\n\n        if (dp.nomineeVetter == address(0)) {\n            revert ZeroAddress();\n        }\n        IGnosisSafe govChainEmergencySCSafe = IGnosisSafe(dp.govChainEmergencySecurityCouncil);\n        address[] memory owners = govChainEmergencySCSafe.getOwners();\n        if (owners.length != (dp.firstCohort.length + dp.secondCohort.length)) {\n            revert InvalidCohortsSize(owners.length, dp.firstCohort.length, dp.secondCohort.length);\n        }\n\n        for (uint256 i = 0; i < dp.firstCohort.length; i++) {\n            if (!govChainEmergencySCSafe.isOwner(dp.firstCohort[i])) {\n                revert AddressNotInCouncil(owners, dp.firstCohort[i]);\n            }\n        }\n\n        for (uint256 i = 0; i < dp.secondCohort.length; i++) {\n            if (!govChainEmergencySCSafe.isOwner(dp.secondCohort[i])) {\n                revert AddressNotInCouncil(owners, dp.secondCohort[i]);\n            }\n        }\n\n        DeployedContracts memory deployedContracts;\n\n        // deploy nominee election governor\n        deployedContracts.nomineeElectionGovernor = SecurityCouncilNomineeElectionGovernor(\n            payable(_deployProxy(dp.govChainProxyAdmin, impls.nomineeElectionGovernor, \"\"))\n        );\n\n        // deploy member election governor\n        deployedContracts.memberElectionGovernor = SecurityCouncilMemberElectionGovernor(\n            payable(_deployProxy(dp.govChainProxyAdmin, impls.memberElectionGovernor, \"\"))\n        );\n\n        // deploy security council manager\n        deployedContracts.securityCouncilManager = SecurityCouncilManager(\n            _deployProxy(dp.govChainProxyAdmin, impls.securityCouncilManager, \"\")\n        );\n\n        // deploy security council member remover gov\n        deployedContracts.securityCouncilMemberRemoverGov = SecurityCouncilMemberRemovalGovernor(\n            payable(_deployProxy(dp.govChainProxyAdmin, impls.securityCouncilMemberRemoverGov, \"\"))\n        );\n\n        // create council manager roles\n        address[] memory memberRemovers = new address[](2);\n        memberRemovers[0] = address(deployedContracts.securityCouncilMemberRemoverGov);\n        memberRemovers[1] = dp.govChainEmergencySecurityCouncil;\n        SecurityCouncilManagerRoles memory roles = SecurityCouncilManagerRoles({\n            admin: dp.l2UpgradeExecutor,\n            cohortUpdator: address(deployedContracts.memberElectionGovernor),\n            memberAdder: dp.govChainEmergencySecurityCouncil,\n            memberRemovers: memberRemovers,\n            memberRotator: dp.govChainEmergencySecurityCouncil,\n            memberReplacer: dp.govChainEmergencySecurityCouncil\n        });\n\n        deployedContracts.upgradeExecRouteBuilder = new UpgradeExecRouteBuilder({\n            _upgradeExecutors: dp.upgradeExecutors,\n            _l1ArbitrumTimelock: dp.l1ArbitrumTimelock,\n            _l1TimelockMinDelay: dp.l1TimelockMinDelay\n        });\n\n        // init the deployed contracts\n        _initElectionGovernors(\n            dp,\n            deployedContracts.securityCouncilManager,\n            deployedContracts.nomineeElectionGovernor,\n            deployedContracts.memberElectionGovernor\n        );\n\n        deployedContracts.securityCouncilManager.initialize({\n            _firstCohort: dp.firstCohort,\n            _secondCohort: dp.secondCohort,\n            _securityCouncils: dp.securityCouncils,\n            _roles: roles,\n            _l2CoreGovTimelock: payable(dp.l2CoreGovTimelock),\n            _router: deployedContracts.upgradeExecRouteBuilder\n        });\n\n        _initRemovalGov(\n            dp,\n            deployedContracts.securityCouncilManager,\n            deployedContracts.securityCouncilMemberRemoverGov\n        );\n\n        emit ContractsDeployed(deployedContracts);\n        return deployedContracts;\n    }\n\n    /// @dev initializes the removal governor\n    function _initRemovalGov(\n        DeployParams memory dp,\n        ISecurityCouncilManager _securityCouncilManager,\n        SecurityCouncilMemberRemovalGovernor securityCouncilMemberRemoverGov\n    ) internal {\n        securityCouncilMemberRemoverGov.initialize({\n            _securityCouncilManager: _securityCouncilManager,\n            _voteSuccessNumerator: dp.removalGovVoteSuccessNumerator,\n            _token: IVotesUpgradeable(dp.arbToken),\n            _owner: dp.l2UpgradeExecutor,\n            _votingDelay: dp.removalGovVotingDelay,\n            _votingPeriod: dp.removalGovVotingPeriod,\n            _quorumNumerator: dp.removalGovQuorumNumerator,\n            _proposalThreshold: dp.removalGovProposalThreshold,\n            _minPeriodAfterQuorum: dp.removalGovMinPeriodAfterQuorum,\n            _proposalExpirationBlocks: dp.removalProposalExpirationBlocks\n        });\n    }\n\n    /// @dev initializes the election governors\n    function _initElectionGovernors(\n        DeployParams memory dp,\n        ISecurityCouncilManager securityCouncilManager,\n        SecurityCouncilNomineeElectionGovernor nomineeElectionGovernor,\n        SecurityCouncilMemberElectionGovernor memberElectionGovernor\n    ) internal {\n        nomineeElectionGovernor.initialize(\n            SecurityCouncilNomineeElectionGovernor.InitParams({\n                firstNominationStartDate: dp.firstNominationStartDate,\n                nomineeVettingDuration: dp.nomineeVettingDuration,\n                nomineeVetter: dp.nomineeVetter,\n                securityCouncilManager: securityCouncilManager,\n                securityCouncilMemberElectionGovernor: memberElectionGovernor,\n                token: IVotesUpgradeable(dp.arbToken),\n                owner: dp.l2UpgradeExecutor,\n                quorumNumeratorValue: dp.nomineeQuorumNumerator,\n                votingPeriod: dp.nomineeVotingPeriod\n            })\n        );\n\n        memberElectionGovernor.initialize({\n            _nomineeElectionGovernor: nomineeElectionGovernor,\n            _securityCouncilManager: securityCouncilManager,\n            _token: IVotesUpgradeable(dp.arbToken),\n            _owner: dp.l2UpgradeExecutor,\n            _votingPeriod: dp.memberVotingPeriod,\n            _fullWeightDuration: dp.fullWeightDuration\n        });\n    }\n}"
    }
  ]
}