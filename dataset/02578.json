{
  "Title": "M-2: Unable to deploy new leverage vault for certain MetaStable Pool",
  "Content": "# Issue M-2: Unable to deploy new leverage vault for certain MetaStable Pool \n\nSource: https://github.com/sherlock-audit/2022-12-notional-judging/issues/20 \n\n## Found by \nJeiwan, xiaoming90\n\n## Summary\n\nNotional might have an issue deploying the new leverage vault for a MetaStable Pool that does not have Balancer Oracle enabled.\n\n## Vulnerability Detail\n\nDuring deployment, the `MetaStable2TokenVaultMixin` contract checks if the MetaStable Pool's oracle is enabled. However, the Balancer Oracle has been deprecated (https://docs.balancer.fi/products/oracles-deprecated). In addition, Notional is no longer relying on Balancer Oracle in this iteration. Therefore, there is no need to check if the Balancer Oracle is enabled on the MetaStable Pool.\n\nhttps://github.com/sherlock-audit/2022-12-notional/blob/main/contracts/vaults/balancer/mixins/MetaStable2TokenVaultMixin.sol#L11\n\n```solidity\nFile: MetaStable2TokenVaultMixin.sol\n11: abstract contract MetaStable2TokenVaultMixin is TwoTokenPoolMixin {\n12:     constructor(NotionalProxy notional_, AuraVaultDeploymentParams memory params)\n13:         TwoTokenPoolMixin(notional_, params)\n14:     {\n15:         // The oracle is required for the vault to behave properly\n16:         (/* */, /* */, /* */, /* */, bool oracleEnabled) = \n17:             IMetaStablePool(address(BALANCER_POOL_TOKEN)).getOracleMiscData();\n18:         require(oracleEnabled);\n19:     }\n```\n\n## Impact\n\nNotional might have an issue deploying the new leverage vault for a MetaStable Pool that does not have Balancer Oracle enabled. Since Balancer Oracle has been deprecated, the Balancer Oracle will likely be disabled on the MetaStable Pool.\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2022-12-notional/blob/main/contracts/vaults/balancer/mixins/MetaStable2TokenVaultMixin.sol#L11\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nRemove the Balancer Oracle check from the constructor.\n\n```diff\n    constructor(NotionalProxy notional_, AuraVaultDeploymentParams memory params)\n        TwoTokenPoolMixin(notional_, params)\n    {\n-        // The oracle is required for the vault to behave properly\n-        (/* */, /* */, /* */, /* */, bool oracleEnabled) = \n-            IMetaStablePool(address(BALANCER_POOL_TOKEN)).getOracleMiscData();\n-        require(oracleEnabled);\n    }\n```\n\n## Discussion\n\n**weitianjie2000**\n\nvalid, will fix\n\n\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/31",
  "Code": [
    {
      "filename": "contracts/vaults/balancer/mixins/MetaStable2TokenVaultMixin.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0-only\npragma solidity 0.8.17;\n\nimport {IMetaStablePool} from \"../../../../interfaces/balancer/IBalancerPool.sol\";\nimport {StableOracleContext} from \"../BalancerVaultTypes.sol\";\nimport {TwoTokenPoolMixin} from \"./TwoTokenPoolMixin.sol\";\nimport {AuraVaultDeploymentParams} from \"../BalancerVaultTypes.sol\";\nimport {NotionalProxy} from \"../../../../interfaces/notional/NotionalProxy.sol\";\nimport {StableMath} from \"../internal/math/StableMath.sol\";\n\nabstract contract MetaStable2TokenVaultMixin is TwoTokenPoolMixin {\n    constructor(NotionalProxy notional_, AuraVaultDeploymentParams memory params)\n        TwoTokenPoolMixin(notional_, params)\n    {\n        // The oracle is required for the vault to behave properly\n        (/* */, /* */, /* */, /* */, bool oracleEnabled) = \n            IMetaStablePool(address(BALANCER_POOL_TOKEN)).getOracleMiscData();\n        require(oracleEnabled);\n    }\n\n    function _stableOracleContext() internal view returns (StableOracleContext memory) {\n        (\n            uint256 value,\n            /* bool isUpdating */,\n            uint256 precision\n        ) = IMetaStablePool(address(BALANCER_POOL_TOKEN)).getAmplificationParameter();\n        require(precision == StableMath._AMP_PRECISION);\n        \n        return StableOracleContext({\n            ampParam: value\n        });\n    }\n\n    uint256[40] private __gap; // Storage gap for future potential upgrades\n}"
    },
    {
      "filename": "contracts/vaults/balancer/mixins/MetaStable2TokenVaultMixin.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0-only\npragma solidity 0.8.17;\n\nimport {IMetaStablePool} from \"../../../../interfaces/balancer/IBalancerPool.sol\";\nimport {StableOracleContext} from \"../BalancerVaultTypes.sol\";\nimport {TwoTokenPoolMixin} from \"./TwoTokenPoolMixin.sol\";\nimport {AuraVaultDeploymentParams} from \"../BalancerVaultTypes.sol\";\nimport {NotionalProxy} from \"../../../../interfaces/notional/NotionalProxy.sol\";\nimport {StableMath} from \"../internal/math/StableMath.sol\";\n\nabstract contract MetaStable2TokenVaultMixin is TwoTokenPoolMixin {\n    constructor(NotionalProxy notional_, AuraVaultDeploymentParams memory params)\n        TwoTokenPoolMixin(notional_, params)\n    {\n        // The oracle is required for the vault to behave properly\n        (/* */, /* */, /* */, /* */, bool oracleEnabled) = \n            IMetaStablePool(address(BALANCER_POOL_TOKEN)).getOracleMiscData();\n        require(oracleEnabled);\n    }\n\n    function _stableOracleContext() internal view returns (StableOracleContext memory) {\n        (\n            uint256 value,\n            /* bool isUpdating */,\n            uint256 precision\n        ) = IMetaStablePool(address(BALANCER_POOL_TOKEN)).getAmplificationParameter();\n        require(precision == StableMath._AMP_PRECISION);\n        \n        return StableOracleContext({\n            ampParam: value\n        });\n    }\n\n    uint256[40] private __gap; // Storage gap for future potential upgrades\n}"
    }
  ]
}