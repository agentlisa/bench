{
  "Title": "Index not checked",
  "Content": "##### Description\nIndex `i` must be less than `N_COINS`:\nhttps://github.com/Gearbox-protocol/gearbox-contracts/blob/0ac33ba87212ce056ac6b6357ad74161d417158a/contracts/adapters/CurveV1.sol#L40\nhttps://github.com/Gearbox-protocol/gearbox-contracts/blob/0ac33ba87212ce056ac6b6357ad74161d417158a/contracts/adapters/CurveV1.sol#L58\n##### Recommendation\nWe recommend adding a check that `i < N_COINS`.",
  "Impact": "MEDIUM",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/adapters/CurveV1.sol",
      "content": "// SPDX-License-Identifier: MIT\n// Gearbox. Generalized leverage protocol that allows to take leverage and then use it across other DeFi protocols and platforms in a composable way.\n// (c) Gearbox.fi, 2021\npragma solidity ^0.7.4;\n\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\n\nimport {ICreditFilter} from \"../interfaces/ICreditFilter.sol\";\nimport {ICreditManager} from \"../interfaces/ICreditManager.sol\";\nimport {ICurvePool} from \"../integrations/curve/ICurvePool.sol\";\n\nimport {CreditAccount} from \"../credit/CreditAccount.sol\";\nimport {CreditManager} from \"../credit/CreditManager.sol\";\n\nimport {Constants} from \"../libraries/helpers/Constants.sol\";\nimport {Errors} from \"../libraries/helpers/Errors.sol\";\n\nimport \"hardhat/console.sol\";\n\n/// @title CurveV1 adapter\ncontract CurveV1Adapter is ICurvePool {\n    using SafeMath for uint256;\n\n    // Default swap contracts - uses for automatic close / liquidation process\n    ICurvePool public curvePool; //\n    ICreditManager public creditManager;\n    ICreditFilter public creditFilter;\n\n    /// @dev Constructor\n    /// @param _creditManager Address Credit manager\n    /// @param _curvePool Address of curve-compatible pool\n    constructor(address _creditManager, address _curvePool) {\n        creditManager = ICreditManager(_creditManager);\n        creditFilter = ICreditFilter(creditManager.creditFilter());\n\n        curvePool = ICurvePool(_curvePool);\n    }\n\n    function coins(uint256 i) external view override returns (address) {\n        return ICurvePool(curvePool).coins(i);\n    }\n\n    /// @dev Exchanges two assets on Curve-compatible pools. Restricted for pool calls only\n    /// @param i Index value for the coin to send\n    /// @param j Index value of the coin to receive\n    /// @param dx Amount of i being exchanged\n    /// @param min_dy Minimum amount of j to receive\n    function exchange(\n        int128 i,\n        int128 j,\n        uint256 dx,\n        uint256 min_dy\n    ) external override {\n        address creditAccount = creditManager.getCreditAccountOrRevert(\n            msg.sender\n        );\n\n        address tokenIn = curvePool.coins(uint256(i));\n        address tokenOut = curvePool.coins(uint256(j));\n\n        creditManager.provideCreditAccountAllowance(\n            creditAccount,\n            address(curvePool),\n            tokenIn\n        ); // T:[CVA-3]\n\n        bytes memory data = abi.encodeWithSelector(\n            bytes4(0x3df02124), // \"exchange(int128,int128,uint256,uint256)\",\n            i,\n            j,\n            dx,\n            min_dy\n        ); // T:[CVA-3]\n\n        creditManager.executeOrder(msg.sender, address(curvePool), data); // T:[CVA-3]\n\n        creditFilter.checkCollateralChange(\n            creditAccount,\n            tokenIn,\n            tokenOut,\n            dx,\n            min_dy\n        ); // T:[CVA-2]\n    }\n\n    function exchange_underlying(\n        int128 i,\n        int128 j,\n        uint256 dx,\n        uint256 min_dy\n    ) external override {\n        revert(Errors.NOT_IMPLEMENTED);\n    }\n\n    function get_dx_underlying(\n        int128 i,\n        int128 j,\n        uint256 dy\n    ) external view override returns (uint256) {\n        return curvePool.get_dx_underlying(i, j, dy);\n    }\n\n    function get_dy_underlying(\n        int128 i,\n        int128 j,\n        uint256 dx\n    ) external view override returns (uint256) {\n        return curvePool.get_dy_underlying(i, j, dx);\n    }\n\n    function get_dx(\n        int128 i,\n        int128 j,\n        uint256 dy\n    ) external view override returns (uint256) {\n        return curvePool.get_dx(i, j, dy);\n    }\n\n    function get_dy(\n        int128 i,\n        int128 j,\n        uint256 dx\n    ) external view override returns (uint256) {\n        return curvePool.get_dy(i, j, dx);\n    }\n\n    function get_virtual_price() external view override returns (uint256) {\n        return curvePool.get_virtual_price();\n    }\n}"
    },
    {
      "filename": "contracts/adapters/CurveV1.sol",
      "content": "// SPDX-License-Identifier: MIT\n// Gearbox. Generalized leverage protocol that allows to take leverage and then use it across other DeFi protocols and platforms in a composable way.\n// (c) Gearbox.fi, 2021\npragma solidity ^0.7.4;\n\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\n\nimport {ICreditFilter} from \"../interfaces/ICreditFilter.sol\";\nimport {ICreditManager} from \"../interfaces/ICreditManager.sol\";\nimport {ICurvePool} from \"../integrations/curve/ICurvePool.sol\";\n\nimport {CreditAccount} from \"../credit/CreditAccount.sol\";\nimport {CreditManager} from \"../credit/CreditManager.sol\";\n\nimport {Constants} from \"../libraries/helpers/Constants.sol\";\nimport {Errors} from \"../libraries/helpers/Errors.sol\";\n\nimport \"hardhat/console.sol\";\n\n/// @title CurveV1 adapter\ncontract CurveV1Adapter is ICurvePool {\n    using SafeMath for uint256;\n\n    // Default swap contracts - uses for automatic close / liquidation process\n    ICurvePool public curvePool; //\n    ICreditManager public creditManager;\n    ICreditFilter public creditFilter;\n\n    /// @dev Constructor\n    /// @param _creditManager Address Credit manager\n    /// @param _curvePool Address of curve-compatible pool\n    constructor(address _creditManager, address _curvePool) {\n        creditManager = ICreditManager(_creditManager);\n        creditFilter = ICreditFilter(creditManager.creditFilter());\n\n        curvePool = ICurvePool(_curvePool);\n    }\n\n    function coins(uint256 i) external view override returns (address) {\n        return ICurvePool(curvePool).coins(i);\n    }\n\n    /// @dev Exchanges two assets on Curve-compatible pools. Restricted for pool calls only\n    /// @param i Index value for the coin to send\n    /// @param j Index value of the coin to receive\n    /// @param dx Amount of i being exchanged\n    /// @param min_dy Minimum amount of j to receive\n    function exchange(\n        int128 i,\n        int128 j,\n        uint256 dx,\n        uint256 min_dy\n    ) external override {\n        address creditAccount = creditManager.getCreditAccountOrRevert(\n            msg.sender\n        );\n\n        address tokenIn = curvePool.coins(uint256(i));\n        address tokenOut = curvePool.coins(uint256(j));\n\n        creditManager.provideCreditAccountAllowance(\n            creditAccount,\n            address(curvePool),\n            tokenIn\n        ); // T:[CVA-3]\n\n        bytes memory data = abi.encodeWithSelector(\n            bytes4(0x3df02124), // \"exchange(int128,int128,uint256,uint256)\",\n            i,\n            j,\n            dx,\n            min_dy\n        ); // T:[CVA-3]\n\n        creditManager.executeOrder(msg.sender, address(curvePool), data); // T:[CVA-3]\n\n        creditFilter.checkCollateralChange(\n            creditAccount,\n            tokenIn,\n            tokenOut,\n            dx,\n            min_dy\n        ); // T:[CVA-2]\n    }\n\n    function exchange_underlying(\n        int128 i,\n        int128 j,\n        uint256 dx,\n        uint256 min_dy\n    ) external override {\n        revert(Errors.NOT_IMPLEMENTED);\n    }\n\n    function get_dx_underlying(\n        int128 i,\n        int128 j,\n        uint256 dy\n    ) external view override returns (uint256) {\n        return curvePool.get_dx_underlying(i, j, dy);\n    }\n\n    function get_dy_underlying(\n        int128 i,\n        int128 j,\n        uint256 dx\n    ) external view override returns (uint256) {\n        return curvePool.get_dy_underlying(i, j, dx);\n    }\n\n    function get_dx(\n        int128 i,\n        int128 j,\n        uint256 dy\n    ) external view override returns (uint256) {\n        return curvePool.get_dx(i, j, dy);\n    }\n\n    function get_dy(\n        int128 i,\n        int128 j,\n        uint256 dx\n    ) external view override returns (uint256) {\n        return curvePool.get_dy(i, j, dx);\n    }\n\n    function get_virtual_price() external view override returns (uint256) {\n        return curvePool.get_virtual_price();\n    }\n}"
    }
  ]
}