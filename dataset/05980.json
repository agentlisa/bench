{
  "Title": "[M-09] Create methods are suspicious of the reorg attack",
  "Content": "\nThe createVaultBooster() function deploys a new VaultBooster contract using the `create`, where the address derivation depends only on the VaultBoosterFactory nonce.\n\nRe-orgs can happen in all EVM chains and as confirmed the contracts will be deployed on most EVM compatible L2s including Arbitrum, etc. It is also planned to be deployed on ZKSync in future. In ethereum, where this is deployed, Re-orgs has already been happened. For more info, [check here](https://decrypt.co/101390/ethereum-beacon-chain-blockchain-reorg).\n\nThis issue will increase as some of the chains like Arbitrum and Polygon are suspicious of the reorg attacks.\n\nPolygon re-org reference: [click here](https://protos.com/polygon-hit-by-157-block-reorg-despite-hard-fork-to-reduce-reorgs/). This one happened this year in February, 2023.\n\nPolygon blocks forked: [check here](https://polygonscan.com/blocks_forked)\n\nThe issue would happen when users rely on the address derivation in advance or try to deploy the position clone with the same address on different EVM chains, any funds sent to the `new` contract could potentially be withdrawn by anyone else. All in all, it could lead to the theft of user funds.\n\n```Solidity\nFile: src/VaultBoosterFactory.sol\n\n    function createVaultBooster(PrizePool _prizePool, address _vault, address _owner) external returns (VaultBooster) {\n>>        VaultBooster booster = new VaultBooster(_prizePool, _vault, _owner);\n\n        emit CreatedVaultBooster(booster, _prizePool, _vault, _owner);\n\n        return booster;\n    }\n```\n\nOptimistic rollups (Optimism/Arbitrum) are also suspect to reorgs since if someone finds a fraud the blocks will be reverted, even though the user receives a confirmation.\n\n**Attack Scenario**<br>\nImagine that Alice deploys a new VaultBooster, and then sends funds to it. Bob sees that the network block reorg happens and calls createVaultBooster. Thus, it creates VaultBooster with an address to which Alice sends funds. Then Alices’ transactions are executed and Alice transfers funds to Bob’s controlled VaultBooster.\n\nThis is a Medium severity issue that has been referenced from below Code4rena reports:<br>\n<https://code4rena.com/reports/2023-01-rabbithole/#m-01-questfactory-is-suspicious-of-the-reorg-attack><br>\n<https://code4rena.com/reports/2023-04-frankencoin#m-14-re-org-attack-in-factory>\n\n### Proof of Concept\n\n<https://github.com/GenerationSoftware/pt-v5-vault-boost/blob/9d640051ab61a0fdbcc9500814b7f8242db9aec2/src/VaultBoosterFactory.sol#L29>\n\n### Recommended Mitigation Steps\n\nDeploy such contracts via `create2` with `salt` that includes `msg.sender`.\n\n**[asselstine (PoolTogether) confirmed via duplicate issue `#169`](https://github.com/code-423n4/2023-08-pooltogether-findings/issues/169#issuecomment-1673828427)**\n\n**[hickuphh3 (judge) commented](https://github.com/code-423n4/2023-08-pooltogether-findings/issues/31#issuecomment-1682442917):**\n > Accepting because of this:<br>\n> > *\"Imagine that Alice deploys a new VaultBooster, and then sends funds to it. Bob sees that the network block reorg happens and calls createVaultBooster. Thus, it creates VaultBooster with an address to which Alice sends funds. Then Alices’ transactions are executed and Alice transfers funds to Bob’s controlled VaultBooster.\"*\n> \n> Again, the scenario should have been more explicit: stating how the vault could be different, how funds are transferred & possibly exploited.\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-08-pooltogether",
  "Code": [
    {
      "filename": "src/VaultBoosterFactory.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0\npragma solidity ^0.8.0;\n\nimport { VaultBooster, PrizePool } from \"./VaultBooster.sol\";\n\n/// @title VaultBoosterFactory\n/// @author G9 Software Inc.\n/// @notice Factory contract for VaultBooster\ncontract VaultBoosterFactory  {\n\n    /// @notice Emitted when a new VaultBooster is created\n    /// @param vaultBooster The address of the new Vault Booster\n    /// @param prizePool The address of the prize pool to contribute to\n    /// @param vault The address of the vault to contribute for\n    /// @param owner The owner of the VaultBooster\n    event CreatedVaultBooster(\n        VaultBooster indexed vaultBooster,\n        PrizePool indexed prizePool,\n        address indexed vault,\n        address owner\n    );\n\n    /// @notice Creates a new vault booster contract\n    /// @param _prizePool The prize pool to contribute to\n    /// @param _vault The vault to contribute for\n    /// @param _owner The owner of the Vault Booster\n    /// @return The address of the new Vault Booster\n    function createVaultBooster(PrizePool _prizePool, address _vault, address _owner) external returns (VaultBooster) {\n        VaultBooster booster = new VaultBooster(_prizePool, _vault, _owner);\n\n        emit CreatedVaultBooster(booster, _prizePool, _vault, _owner);\n\n        return booster;\n    }\n}"
    }
  ]
}