{
  "Title": "M-4: Users can bypass Player royalties on EIP2981 compatible markets by selling clubs as a whole",
  "Content": "# Issue M-4: Users can bypass Player royalties on EIP2981 compatible markets by selling clubs as a whole \n\nSource: https://github.com/sherlock-audit/2023-04-footium-judging/issues/293 \n\n## Found by \n0x52, 0xRobocop\n## Summary\n\nPlayers have a royalty built in but clubs do not. This allows bulk sale of players via clubs to bypass the fee when selling players.\n\n## Vulnerability Detail\n\n[FootiumPlayer.sol#L16-L23](https://github.com/sherlock-audit/2023-04-footium/blob/main/footium-eth-shareable/contracts/FootiumPlayer.sol#L16-L23)\n\n    contract FootiumPlayer is\n        ERC721Upgradeable,\n        AccessControlUpgradeable,\n        ERC2981Upgradeable,\n        PausableUpgradeable,\n        ReentrancyGuardUpgradeable,\n        OwnableUpgradeable\n    {\n\nFootiumPlayer implements the EIP2981 standard which creates fees when buy/selling the players.\n\n[FootiumClub.sol#L15-L21](https://github.com/sherlock-audit/2023-04-footium/blob/main/footium-eth-shareable/contracts/FootiumClub.sol#L15-L21)\n\n    contract FootiumClub is\n        ERC721Upgradeable,\n        AccessControlUpgradeable,\n        PausableUpgradeable,\n        ReentrancyGuardUpgradeable,\n        OwnableUpgradeable\n    {\n\nFootiumClub on the other hand never implements this standard. This allows users to sell players by selling their club to avoid any kind of fee on player sales.\n\n## Impact\n\nUsers can bypass fees on player sales by selling club instead\n\n## Code Snippet\n\n[FootiumClub.sol#L15-L21](https://github.com/sherlock-audit/2023-04-footium/blob/main/footium-eth-shareable/contracts/FootiumClub.sol#L15-L21)\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nImplement EIP2981 on clubs as well\n\n\n\n## Discussion\n\n**thangtranth**\n\nEscalate for 10 USDC.\n\nI believe this issue is invalid because when reading the codebase, it seems to be the design choice of the Footium protocol to not charge new owner of the club the royalty fee for player transfer. The reason is in theory, the players still remain in the same club and are not transferred to other club. Transfer royalty is only applicable when a player NFT is transferred from one club to another, not when a club NFT is sold to a new owner. It is consistent with how other football works.\n\nFurthermore, there is no documentation that states or implies that buying a club NFT requires paying transfer royalty for every player NFT in the club. This leads me and many other Watsons to believe that this is not an issue.\n\nThe EIP2981 is not enforced, therefore if a user want to bypass the player royalties, there are many ways to do it so selling club as a whole is not necessary. For example listing in a NFT marketplace that does not support EIP2981, so no royalty is charged.\n\n**sherlock-admin**\n\n > Escalate for 10 USDC.\n> \n> I believe this issue is invalid because when reading the codebase, it seems to be the design choice of the Footium protocol to not charge new owner of the club the royalty fee for player transfer. The reason is in theory, the players still remain in the same club and are not transferred to other club. Transfer royalty is only applicable when a player NFT is transferred from one club to another, not when a club NFT is sold to a new owner. It is consistent with how other football works.\n> \n> Furthermore, there is no documentation that states or implies that buying a club NFT requires paying transfer royalty for every player NFT in the club. This leads me and many other Watsons to believe that this is not an issue.\n> \n> The EIP2981 is not enforced, therefore if a user want to bypass the player royalties, there are many ways to do it so selling club as a whole is not necessary. For example listing in a NFT marketplace that does not support EIP2981, so no royalty is charged.\n\nYou've created a valid escalation for 10 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**0xRobocop**\n\nEscalate for 10 USDC\n\nThis escalation is to contra-argument the escalation made by Watson thangtranth. \n\nWhile it is correct that the issue over-estimated the \"Users can bypass Player royalties\", and that this can be done in an easier way with a marketplace that does not enforce royalties via EIP2981 as mentioned in the watson's escalation. \n\nThere exists an inconsistency in that players NFTs implement the EIP2981 whereas that club NFTs do not, so marketplaces that do respect the EIP-2981 won't pay the royalties for the club NFTs, and this can be seen as a loss of \"yield\" for the developers of the footium protocol. \n\nThe argument that this seemed to be the intended behavior (not charging royalties for clubs) is subjective, as it could have easily been missed by the developers. And given that the sponsor confirmed the issue, it seems that this was the case.\n\n\n\n**sherlock-admin**\n\n > Escalate for 10 USDC\n> \n> This escalation is to contra-argument the escalation made by Watson thangtranth. \n> \n> While it is correct that the issue over-estimated the \"Users can bypass Player royalties\", and that this can be done in an easier way with a marketplace that does not enforce royalties via EIP2981 as mentioned in the watson's escalation. \n> \n> There exists an inconsistency in that players NFTs implement the EIP2981 whereas that club NFTs do not, so marketplaces that do respect the EIP-2981 won't pay the royalties for the club NFTs, and this can be seen as a loss of \"yield\" for the developers of the footium protocol. \n> \n> The argument that this seemed to be the intended behavior (not charging royalties for clubs) is subjective, as it could have easily been missed by the developers. And given that the sponsor confirmed the issue, it seems that this was the case.\n> \n> \n\nYou've created a valid escalation for 10 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**logiclogue**\n\nTo clarify here from the protocol designer, it's correct that we don't intend for clubs to pay for the royalties for all players on transfer. Instead, we anticipate that the club will subjectively be valued in terms of the players that belong to the club. As a result, clubs should implement the EIP2981 standard so that on club sale royalties will be paid back to the protocol developers\n\n**ctf-sec**\n\n[0xRobocop](https://github.com/0xRobocop) escalation is valid, a valid medium for this submission\n\n**hrishibhat**\n\nEscalation accepted\n\nValid medium\nGiven that the clubs should implement eip2981 to pay the protocol royalties on sale, considering this issue a valid medium\n\n**sherlock-admin**\n\n> Escalation accepted\n> \n> Valid medium\n> Given that the clubs should implement eip2981 to pay the protocol royalties on sale, considering this issue a valid medium\n\n    This issue's escalations have been accepted!\n\n    Contestants' payouts and scores will be updated according to the changes made on this issue.\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/71",
  "Code": [
    {
      "filename": "footium-eth-shareable/contracts/FootiumPlayer.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.16;\n\nimport {ERC721Upgradeable} from \"@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol\";\nimport {AccessControlUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol\";\nimport {OwnableUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport {CountersUpgradeable} from \"@openzeppelin/contracts-upgradeable/utils/CountersUpgradeable.sol\";\nimport {ERC2981Upgradeable} from \"@openzeppelin/contracts-upgradeable/token/common/ERC2981Upgradeable.sol\";\nimport {PausableUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol\";\nimport {ReentrancyGuardUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol\";\n\n/**\n * @title Footium Football Player Contract.\n * @notice An NFT football player.\n */\ncontract FootiumPlayer is\n    ERC721Upgradeable,\n    AccessControlUpgradeable,\n    ERC2981Upgradeable,\n    PausableUpgradeable,\n    ReentrancyGuardUpgradeable,\n    OwnableUpgradeable\n{\n    using CountersUpgradeable for CountersUpgradeable.Counter;\n\n    bytes32 public constant MINTER_ROLE = keccak256(\"MINTER_ROLE\");\n\n    CountersUpgradeable.Counter private _tokenIdCounter;\n    string private _base;\n\n    /**\n     * @notice Initializes the Footium Player contract.\n     * @param _receiver The royalty receiver address.\n     * @param _royaltyFeePercentage The royalty fee percentage (f.e. 500 means 5%).\n     * @param baseURI Token base metadata URI.\n     */\n    function initialize(\n        address _receiver,\n        uint96 _royaltyFeePercentage,\n        string memory baseURI\n    ) external initializer {\n        __ERC721_init(\"FootiumPlayer\", \"FFP\");\n        __AccessControl_init();\n        __ERC2981_init();\n        __Pausable_init();\n        __ReentrancyGuard_init();\n        __Ownable_init();\n\n        _base = baseURI;\n        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);\n        _setDefaultRoyalty(_receiver, _royaltyFeePercentage);\n    }\n\n    /**\n     * @notice Mints a Footium football player.\n     * @param to The address that will receive the player.\n     * @param tokenId The ID of the club to be minted.\n     * @dev Only address with `MINTER_ROLE` can mint a token.\n     * @dev Can be executed when the contract is not paused.\n     */\n    function safeMint(address to)\n        external\n        onlyRole(MINTER_ROLE)\n        nonReentrant\n        whenNotPaused\n        returns (uint256 tokenId)\n    {\n        tokenId = _tokenIdCounter.current();\n        _tokenIdCounter.increment();\n        _safeMint(to, tokenId);\n    }\n\n    /**\n     * @notice Returns token base metadata URI\n     */\n    function _baseURI() internal view override returns (string memory) {\n        return _base;\n    }\n\n    /**\n     * @notice Sets the base metadata URI.\n     * @param baseURI New base metadata URI to be set.\n     * @dev Only the contract owner can set a new URI.\n     */\n    function setBaseURI(string calldata baseURI) external onlyOwner {\n        _base = baseURI;\n    }\n\n    /**\n     * @notice Updates the royalty information.\n     * @param _receiver The royalty receiver address.\n     * @param _royaltyFeePercentage The royalty fee percentage (f.e. 500 means 5%).\n     * @dev Only owner address allowed.\n     */\n    function setRoyaltyInfo(address _receiver, uint96 _royaltyFeePercentage)\n        external\n        onlyOwner\n    {\n        _setDefaultRoyalty(_receiver, _royaltyFeePercentage);\n    }\n\n    /**\n     * @notice Unpause the contract\n     * @dev Only owner address allowed.\n     */\n    function activateContract() external onlyOwner {\n        _unpause();\n    }\n\n    /**\n     * @notice Pause the contract\n     * @dev Only owner address allowed.\n     */\n    function pauseContract() external onlyOwner {\n        _pause();\n    }\n\n    /**\n     * @dev See {IERC165-supportsInterface}.\n     */\n    function supportsInterface(bytes4 interfaceId)\n        public\n        view\n        override(\n            ERC721Upgradeable,\n            AccessControlUpgradeable,\n            ERC2981Upgradeable\n        )\n        returns (bool)\n    {\n        return super.supportsInterface(interfaceId);\n    }\n}"
    },
    {
      "filename": "footium-eth-shareable/contracts/FootiumClub.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.16;\n\nimport {ERC721Upgradeable, IERC721Upgradeable} from \"@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol\";\nimport {AccessControlUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol\";\nimport {OwnableUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport {PausableUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol\";\nimport {ReentrancyGuardUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol\";\nimport {FootiumEscrow} from \"./FootiumEscrow.sol\";\n\n/**\n * @title Footium Football Club\n * @notice An NFT football club.\n */\ncontract FootiumClub is\n    ERC721Upgradeable,\n    AccessControlUpgradeable,\n    PausableUpgradeable,\n    ReentrancyGuardUpgradeable,\n    OwnableUpgradeable\n{\n    /* Storage */\n\n    bytes32 public constant MINTER_ROLE = keccak256(\"MINTER_ROLE\");\n\n    string private _base;\n    mapping(uint256 => FootiumEscrow) public clubToEscrow;\n\n    /* Events */\n\n    event EscrowDeployed(\n        uint256 indexed tokenId,\n        FootiumEscrow indexed escrowAddress\n    );\n\n    /**\n     * @dev Initializes the FootiumClub contract.\n     * @param baseURI Footium Club  token base metadata URI.\n     */\n    function initialize(string memory baseURI) external initializer {\n        __ERC721_init(\"FootiumClub\", \"FFC\");\n        __AccessControl_init();\n        __Pausable_init();\n        __ReentrancyGuard_init();\n        __Ownable_init();\n\n        _base = baseURI;\n        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);\n    }\n\n    /** @notice Mints a Footium football club\n     * @dev Only accounts with the minting role can mint new clubs.\n     * @param to The address that will receive the club.\n     * @param tokenId The ID of the club to be minted.\n     */\n    function safeMint(address to, uint256 tokenId)\n        external\n        onlyRole(MINTER_ROLE)\n        nonReentrant\n        whenNotPaused\n    {\n        FootiumEscrow escrow = new FootiumEscrow(address(this), tokenId);\n        clubToEscrow[tokenId] = escrow;\n\n        _mint(to, tokenId);\n\n        emit EscrowDeployed(tokenId, escrow);\n    }\n\n    /**\n     * @notice Sets the base metadata URI.\n     * @param baseURI New base metadata URI to be set.\n     * @dev Only the contract owner can set a new URI.\n     */\n    function setBaseURI(string calldata baseURI) public onlyOwner {\n        _base = baseURI;\n    }\n\n    /**\n     * @notice Unpause the contract\n     * @dev Only owner address allowed.\n     */\n    function activateContract() external onlyOwner {\n        _unpause();\n    }\n\n    /**\n     * @notice Pause the contract\n     * @dev Only owner address allowed.\n     */\n    function pauseContract() external onlyOwner {\n        _pause();\n    }\n\n    function _baseURI() internal view override returns (string memory) {\n        return _base;\n    }\n\n    /**\n     * @dev See {IERC165-supportsInterface}.\n     */\n    function supportsInterface(bytes4 interfaceId)\n        public\n        view\n        override(ERC721Upgradeable, AccessControlUpgradeable)\n        returns (bool)\n    {\n        return super.supportsInterface(interfaceId);\n    }\n}"
    },
    {
      "filename": "footium-eth-shareable/contracts/FootiumClub.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.16;\n\nimport {ERC721Upgradeable, IERC721Upgradeable} from \"@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol\";\nimport {AccessControlUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol\";\nimport {OwnableUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport {PausableUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol\";\nimport {ReentrancyGuardUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol\";\nimport {FootiumEscrow} from \"./FootiumEscrow.sol\";\n\n/**\n * @title Footium Football Club\n * @notice An NFT football club.\n */\ncontract FootiumClub is\n    ERC721Upgradeable,\n    AccessControlUpgradeable,\n    PausableUpgradeable,\n    ReentrancyGuardUpgradeable,\n    OwnableUpgradeable\n{\n    /* Storage */\n\n    bytes32 public constant MINTER_ROLE = keccak256(\"MINTER_ROLE\");\n\n    string private _base;\n    mapping(uint256 => FootiumEscrow) public clubToEscrow;\n\n    /* Events */\n\n    event EscrowDeployed(\n        uint256 indexed tokenId,\n        FootiumEscrow indexed escrowAddress\n    );\n\n    /**\n     * @dev Initializes the FootiumClub contract.\n     * @param baseURI Footium Club  token base metadata URI.\n     */\n    function initialize(string memory baseURI) external initializer {\n        __ERC721_init(\"FootiumClub\", \"FFC\");\n        __AccessControl_init();\n        __Pausable_init();\n        __ReentrancyGuard_init();\n        __Ownable_init();\n\n        _base = baseURI;\n        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);\n    }\n\n    /** @notice Mints a Footium football club\n     * @dev Only accounts with the minting role can mint new clubs.\n     * @param to The address that will receive the club.\n     * @param tokenId The ID of the club to be minted.\n     */\n    function safeMint(address to, uint256 tokenId)\n        external\n        onlyRole(MINTER_ROLE)\n        nonReentrant\n        whenNotPaused\n    {\n        FootiumEscrow escrow = new FootiumEscrow(address(this), tokenId);\n        clubToEscrow[tokenId] = escrow;\n\n        _mint(to, tokenId);\n\n        emit EscrowDeployed(tokenId, escrow);\n    }\n\n    /**\n     * @notice Sets the base metadata URI.\n     * @param baseURI New base metadata URI to be set.\n     * @dev Only the contract owner can set a new URI.\n     */\n    function setBaseURI(string calldata baseURI) public onlyOwner {\n        _base = baseURI;\n    }\n\n    /**\n     * @notice Unpause the contract\n     * @dev Only owner address allowed.\n     */\n    function activateContract() external onlyOwner {\n        _unpause();\n    }\n\n    /**\n     * @notice Pause the contract\n     * @dev Only owner address allowed.\n     */\n    function pauseContract() external onlyOwner {\n        _pause();\n    }\n\n    function _baseURI() internal view override returns (string memory) {\n        return _base;\n    }\n\n    /**\n     * @dev See {IERC165-supportsInterface}.\n     */\n    function supportsInterface(bytes4 interfaceId)\n        public\n        view\n        override(ERC721Upgradeable, AccessControlUpgradeable)\n        returns (bool)\n    {\n        return super.supportsInterface(interfaceId);\n    }\n}"
    }
  ]
}