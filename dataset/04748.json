{
  "Title": "[H-01] Remove owner calls can be replayed to remove a different owner at the same index, leading to severe issues when combined with lack of last owner guard",
  "Content": "\nUsers are able to upgrade their account's owners via either directly onto the contract with a regular transaction or via an ERC-4337 EntryPoint transaction calling `executeWithoutChainIdValidation`. If a user chooses to use a combination of these methods it's very likely that the addresses at a particular ownership index differ across chain. Therefore if a user later calls `removeOwnerAtIndex` on another chain will end up removing different addresses on different chains. It is unlikely this would be the user's intention. The severity of this ranges from minimal (the user can just add the mistakenly removed owner back) or critical (the user mistakenly removes their only accessible owner on a specific chain, permanently locking the account).\n\n### Proof Of Concept\n\nScenario A: Alice permanently bricks her account on an unused chain:\n\n1.  Alice has a CoinbaseSmartWallet, and uses it on Base, Ethereum & Optimism\n2.  Alice later decides to add a new owner using a cross-chain `executeWithoutChainIdValidation`\n3.  Alice later wants to remove the initial owner (index 0) and does so by signing another cross-chain replayable signature\n4.  Despite it not being her intention anyone could take that signature and replay it on Arbitrum, Avalanche, etc as there is no check to stop the user from removing the final owner\n\nScenario A: Alice adds owners using both methods and ends up with undesired results:\n\n1.  Alice has a CoinbaseSmartWallet and uses it across all chains\n2.  She has Gnosis Safe's and ERC-6551 token bound accounts on different chains so adds them as owners on those specific chains using `execute`\n3.  She then adds a secondary EOA address on all chains using `executeWithoutChainIdValidation`\n4.  Now if she uses `executeWithoutChainIdValidation` to call `removeOwnerAtInde` she will be removing different owners on different chains, which is likely not her intention\n\nWhile more complex scenarios than this might sound bizarre it's important to remember that Alice could be using this smart account for the next N years, only making changes sporadically, and as her ownership mappings across different chains become more out of sync the likelihood of a significant error occurring increases.\n\n### Recommended Mitigation Steps\n\nAs `MultiOwnableStorage` uses a mapping to track owner information rather than a conventional array, it might be simpler to do away with the indexes entirely and have a `removeOwner(bytes calldata _ownerToRemove)` function. This would avoid the situations outlined above where when calling `removeOwnerAtIndex` removes different owners on different chains. To ensure replayability and avoid having a stuck nonce on chains where `_ownerToRemove` is not an owner the function should not revert in the case the owner is not there, but instead return a bool `removed` to indicate whether an owner was removed or not.\n\nThis would make it significantly less likely that users run into the issues stated above, without having to limit their freedom to make ownership changes manually or via ERC-4337 EntryPoint transactions.\n\n**[3docSec (judge) increased severity to High and commented](https://github.com/code-423n4/2024-03-coinbase-findings/issues/114#issuecomment-2022115164):**\n > Root cause: `removeOwnerAtIndex` can be replayed cross-chain despite the same index may point to a different owner. The issue was confirmed by the sponsor in the [issue #57](https://github.com/code-423n4/2024-03-coinbase-findings/issues/57) thread and addressed [in this PR](https://github.com/coinbase/smart-wallet/pull/42).\n >\n > After consulting with a fellow judge, I'm upgrading this one as high, as there is a well-defined attack path that causes the user to lose ownership of their wallet.\n\n**[Coinbase mitigated](https://github.com/code-423n4/2024-04-coinbase-mitigation/blob/main/README.md#scope):**\n> The issue is remediated by updating the parameterization of `removeOwnerAtIndex` to also take an `owner` argument. We then check that the `owner` passed matches the owner found at the index. In this way, we prevent a replayable transaction removing a different owner at the same index. (PR [here](https://github.com/coinbase/smart-wallet/pull/42))\n\n**Status:** Mitigation confirmed. Full details in reports from [McToady](https://github.com/code-423n4/2024-04-coinbase-mitigation-findings/issues/6), [cheatc0d3](https://github.com/code-423n4/2024-04-coinbase-mitigation-findings/issues/13), and [imare](https://github.com/code-423n4/2024-04-coinbase-mitigation-findings/issues/8).\n\n\n\n***\n \n",
  "Impact": "HIGH",
  "Source": "https://code4rena.com/reports/2024-03-coinbase",
  "Code": [
    {
      "filename": "README.md",
      "content": "# Coinbase Smart Wallet Mitigation Review details\n- Total Prize Pool: $12,500 in USDC\n  - HM awards: $10,500 in USDC\n  - Judge awards: $2,000 in USDC\n- Join [C4 Discord](https://discord.gg/code4rena) to register\n- Submit findings [using the C4 form](https://code4rena.com/audits/2024-04-coinbase-smart-wallet-mitigation-review/submit)\n- [Warden guidelines for C4 mitigation reviews](https://code4rena.notion.site/Guidelines-for-C4-mitigation-reviews-ed10fc5cfbf640bd8dcec66f38b343c4)\n- Starts April 5, 2024 20:00 UTC\n- Ends April 10, 2024 20:00 UTC\n\n## Important note \n\nEach warden must submit a mitigation review for *every* individual PR listed in the `Scope` section below. **Incomplete mitigation reviews will not be eligible for awards.**\n\n## Findings being mitigated\n\nMitigations of all issues listed here will be considered in-scope.\n\n- [H-01: Users making specific chain account ownership upgrades will likely cause issues when later using cross-chain replay-able ownership upgrades](https://github.com/code-423n4/2024-03-coinbase-findings/issues/114)\n\n- [M-01: Balance check during MagicSpend validation cannot ensure that MagicSpend has enough balance to cover the requested fund.](https://github.com/code-423n4/2024-03-coinbase-findings/issues/110)\n\n- [QA-01: All Smart Wallet funds will be lost if users remove all owners](https://github.com/code-423n4/2024-03-coinbase-findings/issues/181)\n\n## Scope\n\n### Mitigations of High & Medium Severity Issues\n- [H-01 Fix](https://github.com/coinbase/smart-wallet/pull/42): The issue is remediated by updating the parameterization of `removeOwnerAtIndex` to also take an `owner` argument. We then check that the `owner` passed matches the owner found at the index. In this way, we prevent a replayable transaction removing a different owner at the same index. \n- [M-01 Fix](https://github.com/coinbase/magic-spend/pull/17): This issue is complex to address. The warden suggested adding a variable to track in flight withdraws, and we [pursued this](https://github.com/coinbase/magic-spend/pull/16). However, we realized that bundlers penalize paymasters when the UserOp behaves differently when simulated in isolation vs. in the bundle, and this would not fix this. Instead, we give the owner a tool to address this probabilistically: the owner can set a `maxWithdrawDenominator` and we enforce that native asset withdraws must be `<= address(this).balance / maxWithdrawDenominator`. For example, if `maxWithdrawDenominator` is set to 20, it would take 20 native asset withdraws (each withdrawing max allowed) + 1 native asset withdraw in the same transaction to cause a revert. It is of course known that this doesn't entirely solve the issue, and the efficacy depends the value chosen and usage. \n- [QA-01 Fix](https://github.com/coinbase/smart-wallet/pull/43): We decided to take action here, changing `removeOwnerAtIndex` to revert if the owner is the last owner and adding `removeLastOwner`.\n\n### Additional Scope to be reviewed\n\nThese are additional changes that will be in scope.  \n\n| URL | Mitigation of | Original Issue | \n| ----------- | ------------- | ----------- |\n| [Gas Fixes 1](https://github.com/coinbase/magic-spend/pull/18#pullrequestreview-1981188702) | ADD-01 | [195](https://github.com/code-423n4/2024-03-coinbase-findings/issues/195) and [137](https://github.com/code-423n4/2024-03-coinbase-findings/issues/195) | \n| [Gas Fixes 2](https://github.com/coinbase/smart-wallet/pull/45) | ADD-02 | [195](https://github.com/code-423n4/2024-03-coinbase-findings/issues/195) and [38](https://github.com/code-423n4/2024-03-coinbase-findings/issues/38) | \n\n## Out of Scope\n\nWe are not taking action on [Issue 39](https://github.com/code-423n4/2024-03-coinbase-findings/issues/39)."
    }
  ]
}