{
  "Title": "[M-03] Protocol is not `EIP712` compliant: incorrect typehash for `Validation` and `Transaction` structures",
  "Content": "\nWhen implementing `EIP712`, among other things, for data structures that will be a part of signing message, a typehash must be defined.\n\nThe structure [typehash is defined as](https://eips.ethereum.org/EIPS/eip-712#definition-of-hashstruct): `typeHash = keccak256(encodeType(typeOf(s)))`\n\nWhere `encodeType` is the type of a struct that is encoded as: ` name ‖ \"(\" ‖ member₁ ‖ \",\" ‖ member₂ ‖ \",\" ‖ … ‖ memberₙ \")\"  `\n\nAnd each member is written as: `type ‖ \" \" ‖ name`.\n\nThe project uses 2 structures on the signed data `Transaction` and `Validation` [declared in `TypeHashHelper`](https://github.com/code-423n4/2023-10-brahma/blob/main/contracts/src/libraries/TypeHashHelper.sol#L13-L43):\n\n```Solidity\n    /**\n     * @notice Structural representation of transaction details\n     * @param operation type of operation\n     * @param to address to send tx to\n     * @param account address of safe\n     * @param executor address of executor if executed via executor plugin, address(0) if executed via execTransaction\n     * @param value txn value\n     * @param nonce txn nonce\n     * @param data txn callData\n     */\n    struct Transaction {\n        uint8 operation;\n        address to;\n        address account;\n        address executor;\n        uint256 value;\n        uint256 nonce;\n        bytes data;\n    }\n\n\n    /**\n     * @notice Type of validation struct to hash\n     * @param expiryEpoch max time till validity of the signature\n     * @param transactionStructHash txn digest generated using TypeHashHelper._buildTransactionStructHash()\n     * @param policyHash policy commit hash of the safe account\n     */\n    struct Validation {\n        uint32 expiryEpoch;\n        bytes32 transactionStructHash;\n        bytes32 policyHash;\n    }\n```\n\n**However, the precalculated typehash for each of the structure are of different structures**:\n\n1. For `Transaction` the hash is actually calculated on a now removed [`ExecutionParams` structure](https://github.com/code-423n4/2023-10-brahma/blob/main/contracts/src/libraries/TypeHashHelper.sol#L45-L50):\n\n```Solidity\n    /**\n     * @notice EIP712 typehash for transaction data\n     * @dev keccak256(\"ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\");\n     */\n    bytes32 public constant TRANSACTION_PARAMS_TYPEHASH =\n        0xfd4628b53a91b366f1977138e2eda53b93c8f5cc74bda8440f108d7da1e99290;\n```\n\n2. For `Validation` the hash is calculated on another old, [removed structure `ValidationParams`](https://github.com/code-423n4/2023-10-brahma/blob/main/contracts/src/libraries/TypeHashHelper.sol#L52-L57):\n\n```Solidity\n    /**\n     * @notice EIP712 typehash for validation data\n     * @dev keccak256(\"ValidationParams(ExecutionParams executionParams,bytes32 policyHash,uint32 expiryEpoch)ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\")\n     */\n    bytes32 public constant VALIDATION_PARAMS_TYPEHASH =\n        0x0c7f653e0f641e41fbb4ed1440c7d0b08b8d2a19e1c35cfc98de2d47519e15b1;\n```\n\n### POC\n\nThe issue went undetected in the initial development phase, and can be verified, because the [tests still use the old hashes](https://github.com/code-423n4/2023-10-brahma/blob/a6424230052fc47c4215200c19a8eef9b07dfccc/contracts/test/units/TypeHashHelper.t.sol#L18-L31):\n\n```Solidity\n    function testValidateConstants() public {\n        assertEq(\n            TypeHashHelper.TRANSACTION_PARAMS_TYPEHASH,\n            keccak256(\n                \"ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\"\n            )\n        );\n        assertEq(\n            TypeHashHelper.VALIDATION_PARAMS_TYPEHASH,\n            keccak256(\n                \"ValidationParams(ExecutionParams executionParams,bytes32 policyHash,uint32 expiryEpoch)ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\"\n            )\n        );\n    }\n```\n\nThe specific test can be verified by running:\n\n    forge test --fork-url \"https://eth-mainnet.g.alchemy.com/v2/<ALCHEMY_API_KEY>\" -vvv --ffi --match-test testValidateConstants\n\n### Impact\n\nProtocol is not EIP712 compliant, which will result in issues with integrators.\n\n### Tools Used\n\nAn [online `keccak256`](https://emn178.github.io/online-tools/keccak\\_256.html) checker for validating that the those hashes are not actually for the correct structures.\n\n### Recommendations\n\nModify the structure typehash (and tests) to point to the correct structures.\n\n**[0xad1onchain (Brahma) confirmed](https://github.com/code-423n4/2023-10-brahma-findings/issues/23#issuecomment-1779121889)**\n\n**[0xsomeone (judge) commented](https://github.com/code-423n4/2023-10-brahma-findings/issues/23#issuecomment-1787993817):**\n > The Warden has demonstrated that the contract is non-compliant with EIP-712 as the type-hashes defined within it are outdated and incorrect.\n> \n> The Warden has articulated what the potential impact is and, while slightly brief, the recommendation the Warden provided is correct.\n> \n> As a result, I fully accept this submission as satisfactory as well as the best of its kind. Issue [#182](https://github.com/code-423n4/2023-10-brahma-findings/issues/182) will be awarded partial credit, given that it managed to pinpoint a single flaw in a single type-hash rather than identify that multiple type hashes were incorrect.\n\n\n**[0xad1onchain (Brahma) commented](https://github.com/code-423n4/2023-10-brahma-findings/issues/23#issuecomment-1817756772):**\n> Fixed, amended EIP 712 struct.\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-10-brahma",
  "Code": [
    {
      "filename": "contracts/src/libraries/TypeHashHelper.sol",
      "content": "/// SPDX-License-Identifier: BUSL-1.1\n\n/// Copyright (C) 2023 Brahma.fi\n\npragma solidity 0.8.19;\n\n/**\n * @title TypeHashHelper\n * @author Brahma.fi\n * @notice Helper library containing functions to build EIP712 struct and type hashes\n */\nlibrary TypeHashHelper {\n    /**\n     * @notice Structural representation of transaction details\n     * @param operation type of operation\n     * @param to address to send tx to\n     * @param account address of safe\n     * @param executor address of executor if executed via executor plugin, address(0) if executed via execTransaction\n     * @param value txn value\n     * @param nonce txn nonce\n     * @param data txn callData\n     */\n    struct Transaction {\n        uint8 operation;\n        address to;\n        address account;\n        address executor;\n        uint256 value;\n        uint256 nonce;\n        bytes data;\n    }\n\n    /**\n     * @notice Type of validation struct to hash\n     * @param expiryEpoch max time till validity of the signature\n     * @param transactionStructHash txn digest generated using TypeHashHelper._buildTransactionStructHash()\n     * @param policyHash policy commit hash of the safe account\n     */\n    struct Validation {\n        uint32 expiryEpoch;\n        bytes32 transactionStructHash;\n        bytes32 policyHash;\n    }\n\n    /**\n     * @notice EIP712 typehash for transaction data\n     * @dev keccak256(\"ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\");\n     */\n    bytes32 public constant TRANSACTION_PARAMS_TYPEHASH =\n        0xfd4628b53a91b366f1977138e2eda53b93c8f5cc74bda8440f108d7da1e99290;\n\n    /**\n     * @notice EIP712 typehash for validation data\n     * @dev keccak256(\"ValidationParams(ExecutionParams executionParams,bytes32 policyHash,uint32 expiryEpoch)ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\")\n     */\n    bytes32 public constant VALIDATION_PARAMS_TYPEHASH =\n        0x0c7f653e0f641e41fbb4ed1440c7d0b08b8d2a19e1c35cfc98de2d47519e15b1;\n\n    /**\n     * @notice Builds EIP712 transaction struct hash\n     * @param txn transaction params struct\n     * @return transactionStructHash\n     */\n    function _buildTransactionStructHash(Transaction memory txn) internal pure returns (bytes32) {\n        return keccak256(\n            abi.encode(\n                TRANSACTION_PARAMS_TYPEHASH,\n                txn.to,\n                txn.value,\n                keccak256(txn.data),\n                txn.operation,\n                txn.account,\n                txn.executor,\n                txn.nonce\n            )\n        );\n    }\n\n    /**\n     * @notice Builds EIP712 validation struct hash\n     * @param validation validation params struct\n     * @return validationStructHash\n     */\n    function _buildValidationStructHash(Validation memory validation) internal pure returns (bytes32) {\n        return keccak256(\n            abi.encode(\n                VALIDATION_PARAMS_TYPEHASH,\n                validation.transactionStructHash,\n                validation.policyHash,\n                validation.expiryEpoch\n            )\n        );\n    }\n}"
    },
    {
      "filename": "contracts/src/libraries/TypeHashHelper.sol",
      "content": "/// SPDX-License-Identifier: BUSL-1.1\n\n/// Copyright (C) 2023 Brahma.fi\n\npragma solidity 0.8.19;\n\n/**\n * @title TypeHashHelper\n * @author Brahma.fi\n * @notice Helper library containing functions to build EIP712 struct and type hashes\n */\nlibrary TypeHashHelper {\n    /**\n     * @notice Structural representation of transaction details\n     * @param operation type of operation\n     * @param to address to send tx to\n     * @param account address of safe\n     * @param executor address of executor if executed via executor plugin, address(0) if executed via execTransaction\n     * @param value txn value\n     * @param nonce txn nonce\n     * @param data txn callData\n     */\n    struct Transaction {\n        uint8 operation;\n        address to;\n        address account;\n        address executor;\n        uint256 value;\n        uint256 nonce;\n        bytes data;\n    }\n\n    /**\n     * @notice Type of validation struct to hash\n     * @param expiryEpoch max time till validity of the signature\n     * @param transactionStructHash txn digest generated using TypeHashHelper._buildTransactionStructHash()\n     * @param policyHash policy commit hash of the safe account\n     */\n    struct Validation {\n        uint32 expiryEpoch;\n        bytes32 transactionStructHash;\n        bytes32 policyHash;\n    }\n\n    /**\n     * @notice EIP712 typehash for transaction data\n     * @dev keccak256(\"ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\");\n     */\n    bytes32 public constant TRANSACTION_PARAMS_TYPEHASH =\n        0xfd4628b53a91b366f1977138e2eda53b93c8f5cc74bda8440f108d7da1e99290;\n\n    /**\n     * @notice EIP712 typehash for validation data\n     * @dev keccak256(\"ValidationParams(ExecutionParams executionParams,bytes32 policyHash,uint32 expiryEpoch)ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\")\n     */\n    bytes32 public constant VALIDATION_PARAMS_TYPEHASH =\n        0x0c7f653e0f641e41fbb4ed1440c7d0b08b8d2a19e1c35cfc98de2d47519e15b1;\n\n    /**\n     * @notice Builds EIP712 transaction struct hash\n     * @param txn transaction params struct\n     * @return transactionStructHash\n     */\n    function _buildTransactionStructHash(Transaction memory txn) internal pure returns (bytes32) {\n        return keccak256(\n            abi.encode(\n                TRANSACTION_PARAMS_TYPEHASH,\n                txn.to,\n                txn.value,\n                keccak256(txn.data),\n                txn.operation,\n                txn.account,\n                txn.executor,\n                txn.nonce\n            )\n        );\n    }\n\n    /**\n     * @notice Builds EIP712 validation struct hash\n     * @param validation validation params struct\n     * @return validationStructHash\n     */\n    function _buildValidationStructHash(Validation memory validation) internal pure returns (bytes32) {\n        return keccak256(\n            abi.encode(\n                VALIDATION_PARAMS_TYPEHASH,\n                validation.transactionStructHash,\n                validation.policyHash,\n                validation.expiryEpoch\n            )\n        );\n    }\n}"
    },
    {
      "filename": "contracts/src/libraries/TypeHashHelper.sol",
      "content": "/// SPDX-License-Identifier: BUSL-1.1\n\n/// Copyright (C) 2023 Brahma.fi\n\npragma solidity 0.8.19;\n\n/**\n * @title TypeHashHelper\n * @author Brahma.fi\n * @notice Helper library containing functions to build EIP712 struct and type hashes\n */\nlibrary TypeHashHelper {\n    /**\n     * @notice Structural representation of transaction details\n     * @param operation type of operation\n     * @param to address to send tx to\n     * @param account address of safe\n     * @param executor address of executor if executed via executor plugin, address(0) if executed via execTransaction\n     * @param value txn value\n     * @param nonce txn nonce\n     * @param data txn callData\n     */\n    struct Transaction {\n        uint8 operation;\n        address to;\n        address account;\n        address executor;\n        uint256 value;\n        uint256 nonce;\n        bytes data;\n    }\n\n    /**\n     * @notice Type of validation struct to hash\n     * @param expiryEpoch max time till validity of the signature\n     * @param transactionStructHash txn digest generated using TypeHashHelper._buildTransactionStructHash()\n     * @param policyHash policy commit hash of the safe account\n     */\n    struct Validation {\n        uint32 expiryEpoch;\n        bytes32 transactionStructHash;\n        bytes32 policyHash;\n    }\n\n    /**\n     * @notice EIP712 typehash for transaction data\n     * @dev keccak256(\"ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\");\n     */\n    bytes32 public constant TRANSACTION_PARAMS_TYPEHASH =\n        0xfd4628b53a91b366f1977138e2eda53b93c8f5cc74bda8440f108d7da1e99290;\n\n    /**\n     * @notice EIP712 typehash for validation data\n     * @dev keccak256(\"ValidationParams(ExecutionParams executionParams,bytes32 policyHash,uint32 expiryEpoch)ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\")\n     */\n    bytes32 public constant VALIDATION_PARAMS_TYPEHASH =\n        0x0c7f653e0f641e41fbb4ed1440c7d0b08b8d2a19e1c35cfc98de2d47519e15b1;\n\n    /**\n     * @notice Builds EIP712 transaction struct hash\n     * @param txn transaction params struct\n     * @return transactionStructHash\n     */\n    function _buildTransactionStructHash(Transaction memory txn) internal pure returns (bytes32) {\n        return keccak256(\n            abi.encode(\n                TRANSACTION_PARAMS_TYPEHASH,\n                txn.to,\n                txn.value,\n                keccak256(txn.data),\n                txn.operation,\n                txn.account,\n                txn.executor,\n                txn.nonce\n            )\n        );\n    }\n\n    /**\n     * @notice Builds EIP712 validation struct hash\n     * @param validation validation params struct\n     * @return validationStructHash\n     */\n    function _buildValidationStructHash(Validation memory validation) internal pure returns (bytes32) {\n        return keccak256(\n            abi.encode(\n                VALIDATION_PARAMS_TYPEHASH,\n                validation.transactionStructHash,\n                validation.policyHash,\n                validation.expiryEpoch\n            )\n        );\n    }\n}"
    },
    {
      "filename": "contracts/test/units/TypeHashHelper.t.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.19;\n\nimport \"forge-std/Test.sol\";\nimport \"script/utils/ConsoleFactory.s.sol\";\nimport \"../libs/TypeHashHelper.lib.sol\";\nimport {TypeHashHelper} from \"src/libraries/TypeHashHelper.sol\";\n\ncontract TypeHashHelperTest is Test, ConsoleFactory(\"offchain/addressManager.ts\") {\n    TypeHashHelperLib typeHashHelperLib;\n\n    function setUp() public {\n        ConsoleFactory.deployConsole(address(this), false);\n        //\n        typeHashHelperLib = new TypeHashHelperLib();\n    }\n\n    function testValidateConstants() public {\n        assertEq(\n            TypeHashHelper.TRANSACTION_PARAMS_TYPEHASH,\n            keccak256(\n                \"ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\"\n            )\n        );\n        assertEq(\n            TypeHashHelper.VALIDATION_PARAMS_TYPEHASH,\n            keccak256(\n                \"ValidationParams(ExecutionParams executionParams,bytes32 policyHash,uint32 expiryEpoch)ExecutionParams(address to,uint256 value,bytes data,uint8 operation,address account,address executor,uint256 nonce)\"\n            )\n        );\n    }\n\n    function testBuildTransactionStructHash() public {\n        TypeHashHelper.Transaction memory _txn = TypeHashHelper.Transaction({\n            to: makeAddr(\"to\"),\n            value: uint256(11),\n            data: hex\"ff1234ff\",\n            operation: uint8(11),\n            account: makeAddr(\"account\"),\n            executor: makeAddr(\"executor\"),\n            nonce: uint256(11)\n        });\n\n        assertEq(\n            typeHashHelperLib.buildTransactionStructHash(_txn),\n            0x5f72e76e88de640bf015153834ad646b4d2dc7df92f385a34bf26eba8ea3a3f2\n        );\n    }\n\n    function testBuildValidationStructHash() public {\n        TypeHashHelper.Validation memory _vldn = TypeHashHelper.Validation({\n            transactionStructHash: keccak256(\"txn\"),\n            policyHash: keccak256(\"policy\"),\n            expiryEpoch: uint32(11)\n        });\n\n        assertEq(\n            typeHashHelperLib.buildValidationStructHash(_vldn),\n            0x669f8c6922c54ffb2e15e3d6d29dd6e92c47d2c49d83818752cbd5f00059e80c\n        );\n    }\n}"
    }
  ]
}