{
  "Title": "Rebasable as reward tokens breaks logic",
  "Content": "##### Description\nWith rebasable reward tokens, the calculation of farmed rewards will be incorrect because it relies on a strict amount of distributed tokens while the underlying reward balance will float. \nhttps://github.com/1inch/farming/blob/7a007ec7784cca2899889e99e46cf06d5788a7d9/contracts/accounting/FarmAccounting.sol#L21\n##### Recommendation\nWe recommend warning developers not to use rebasable tokens as reward tokens.\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/accounting/FarmAccounting.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport \"@openzeppelin/contracts/utils/math/Math.sol\";\n\nlibrary FarmAccounting {\n    struct Info {\n        uint40 finished;\n        uint32 duration;\n        uint184 reward;\n    }\n\n    uint256 constant internal _MAX_REWARD_AMOUNT = 1e42;\n\n    /// @dev Requires extra 18 decimals for precision, result should not exceed 10**54\n    function farmedSinceCheckpointScaled(Info memory info, uint256 checkpoint) internal view returns(uint256 amount) {\n        require(checkpoint >= info.finished - info.duration, \"FA: checkpoint < started\");\n        if (info.duration > 0) {\n            uint256 elapsed = Math.min(block.timestamp, info.finished) - Math.min(checkpoint, info.finished);\n            return elapsed * info.reward * 1e18 / info.duration;\n        }\n    }\n\n    function startFarming(Info storage info, uint256 amount, uint256 period, function() internal updateCheckpoint) internal returns(uint256) {\n        // If something left from prev farming add it to the new farming\n        Info memory prev = info;\n        if (block.timestamp < prev.finished) {\n            amount += prev.reward - farmedSinceCheckpointScaled(prev, prev.finished - prev.duration) / 1e18;\n        }\n\n        updateCheckpoint();\n        require(period <= type(uint32).max, \"FA: duration too large\");\n        require(amount <= _MAX_REWARD_AMOUNT, \"FA: amount too large\");\n        (info.finished, info.duration, info.reward) = (uint40(block.timestamp + period), uint32(period), uint184(amount));\n        return amount;\n    }\n}"
    }
  ]
}