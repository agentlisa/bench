{
  "Title": "Missing the `lookback` parameter when invoking the `getWstethUsdPrice()` in the `getTokenPrice` function",
  "Content": "# Missing the `lookback` parameter when invoking the `getWstethUsdPrice()` in the `getTokenPrice` function\n\n### Severity\nMedium Risk\n\n### Relevant GitHub Links\n<a data-meta=\"codehawks-github-link\" href=\"https://github.com/Cyfrin/2024-04-Beanstalk-2/blob/main/protocol/contracts/libraries/Oracle/LibUsdOracle.sol#L64\">https://github.com/Cyfrin/2024-04-Beanstalk-2/blob/main/protocol/contracts/libraries/Oracle/LibUsdOracle.sol#L64</a>\n\n\n## Summary\nThe `getWstethUsdPrice()` function is being called without using the `lookback` parameter if it's the WSTETH token.\nThe function uses a constant value of `0` for the `lookback` parameter when calling `LibWstethUsdOracle.getWstethUsdPrice()`.\nSo it always returns the current spot price for `wstETH`.\n\n## Vulnerability Details\n\n```\n    function getTokenPrice(address token, uint256 lookback) internal view returns (uint256) {\n         if (token == C.WETH) {\n            uint256 ethUsdPrice = LibEthUsdOracle.getEthUsdPrice(lookback);\n            if (ethUsdPrice == 0) return 0;\n            return ethUsdPrice;\n        }\n        if (token == C.WSTETH) {\n            uint256 wstethUsdPrice = LibWstethUsdOracle.getWstethUsdPrice(0); // @audit missing lookback?\n            if (wstethUsdPrice == 0) return 0;\n            return wstethUsdPrice;\n        }\n        revert(\"Oracle: Token not supported.\");\n    }\n```\n\n## Impact\nIt's always returning the current price instead of TWAP for `wstETH`.\nThis could lead to inaccurate calculations in calling this `getTokenPrice` for `wstETH`.\n\n\n## Tools Used\nManual review\n\n## Recommendations\n\nIt's recommended to use the `lookback` parameter instead of `0`.\n`uint256 wstethUsdPrice = LibWstethUsdOracle.getWstethUsdPrice(lookback);`",
  "Impact": "LOW",
  "Source": "https://www.codehawks.com/contests/clu7665bs0001fmt5yahc8tyh",
  "Code": [
    {
      "filename": "protocol/contracts/libraries/Oracle/LibUsdOracle.sol",
      "content": "/**\n * SPDX-License-Identifier: MIT\n **/\n\npragma solidity =0.7.6;\npragma experimental ABIEncoderV2;\n\nimport {LibEthUsdOracle} from \"./LibEthUsdOracle.sol\";\nimport {LibWstethUsdOracle} from \"./LibWstethUsdOracle.sol\";\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\nimport {C} from \"contracts/C.sol\";\n\n/**\n * @title Eth Usd Oracle Library\n * @notice Contains functionalty to fetch the manipulation resistant USD price of different tokens.\n * @dev currently supports:\n * - ETH/USD price\n **/\nlibrary LibUsdOracle {\n\n    using SafeMath for uint256;\n\n    function getUsdPrice(address token) internal view returns (uint256) {\n        return getUsdPrice(token, 0);\n    }\n\n    /**\n     * @dev Returns the price of a given token in in USD with the option of using a lookback. (Usd:token Price)\n     * `lookback` should be 0 if the instantaneous price is desired. Otherwise, it should be the\n     * TWAP lookback in seconds.\n     * If using a non-zero lookback, it is recommended to use a substantially large `lookback`\n     * (> 900 seconds) to protect against manipulation.\n     */\n    function getUsdPrice(address token, uint256 lookback) internal view returns (uint256) {\n        if (token == C.WETH) {\n            uint256 ethUsdPrice = LibEthUsdOracle.getEthUsdPrice(lookback);\n            if (ethUsdPrice == 0) return 0;\n            return uint256(1e24).div(ethUsdPrice);\n        }\n        if (token == C.WSTETH) {\n            uint256 wstethUsdPrice = LibWstethUsdOracle.getWstethUsdPrice(lookback);\n            if (wstethUsdPrice == 0) return 0;\n            return uint256(1e24).div(wstethUsdPrice);\n        }\n        revert(\"Oracle: Token not supported.\");\n    }\n\n    function getTokenPrice(address token) internal view returns (uint256) {\n        return getTokenPrice(token, 0);\n    }\n\n    /**\n     * @notice returns the price of a given token in USD (token:Usd Price)\n     * @dev if ETH returns 1000 USD, this function returns 1000\n     * (ignoring decimal precision)\n     */\n    function getTokenPrice(address token, uint256 lookback) internal view returns (uint256) {\n         if (token == C.WETH) {\n            uint256 ethUsdPrice = LibEthUsdOracle.getEthUsdPrice(lookback);\n            if (ethUsdPrice == 0) return 0;\n            return ethUsdPrice;\n        }\n        if (token == C.WSTETH) {\n            uint256 wstethUsdPrice = LibWstethUsdOracle.getWstethUsdPrice(0);\n            if (wstethUsdPrice == 0) return 0;\n            return wstethUsdPrice;\n        }\n        revert(\"Oracle: Token not supported.\");\n    }\n\n\n\n\n\n}"
    }
  ]
}