{
  "Title": "[M-10] Missing Return Statement in `_getReserves` Function in `MagicLpAggregator` Contract",
  "Content": "\nThe `MagicLpAggregator` contract contains a flaw within the `_getReserves` function where it fails to return the reserve values fetched from the `pair` contract. This oversight results in the `latestAnswer` function always returning zero, which can have severe implications for any systems that depend on this contract for accurate liquidity pool pricing data.\n\n### Impact\n\nThe missing return statement in the `_getReserves` function leads to the `latestAnswer` function always returning zero. This affects any dependent systems or contracts that rely on accurate price data from the `MagicLpAggregator` contract, as they will receive incorrect information, potentially leading to financial loss or system failure.\n\n### Proof of Concept\n\nThe `_getReserves` function in the provided code snippet does not return the fetched reserves:\n\n```solidity\n33:    function _getReserves() internal view virtual returns (uint256, uint256) {\n34:        (uint256 baseReserve, uint256 quoteReserve) = pair.getReserves();\n35:    }\n```\n\n<https://github.com/code-423n4/2024-03-abracadabra-money/blob/1f4693fdbf33e9ad28132643e2d6f7635834c6c6/src/oracles/aggregators/MagicLpAggregator.sol#L33C5-L35C6>\n\nDue to the missing return statement, the latestAnswer function uses uninitialized variables for `baseReserve` and `quoteReserve`, which default to zero:\n\n```solidity\nfunction latestAnswer() public view override returns (int256) {\n    // ...\n    (uint256 baseReserve, uint256 quoteReserve) = _getReserves();\n    baseReserve = baseReserve * (10 ** (WAD - baseDecimals)); // baseReserve defaults to 0\n    quoteReserve = quoteReserve * (10 ** (WAD - quoteDecimals)); // quoteReserve defaults to 0\n    // ...\n}\n```\n\n<https://github.com/code-423n4/2024-03-abracadabra-money/blob/1f4693fdbf33e9ad28132643e2d6f7635834c6c6/src/oracles/aggregators/MagicLpAggregator.sol#L42C1-L44C69>\n\n### Recommended Mitigation Steps\n\nUpdate `_getReserves()`\n\n```diff\n-    function _getReserves() internal view virtual returns (uint256, uint256) {\n+    function _getReserves() internal view virtual returns (uint256 baseReserve, uint256 quoteReserve) {\n-        (uint256 baseReserve, uint256 quoteReserve) = pair.getReserves();\n+        (baseReserve, quoteReserve) = pair.getReserves();\n     }\n```\n**[0xCalibur (Abracadabra) confirmed and commented](https://github.com/code-423n4/2024-03-abracadabra-money-findings/issues/146#issuecomment-2002303845):**\n > Fixed in main during the audit:\n> \n> https://github.com/Abracadabra-money/abracadabra-money-contracts\n\n_Note: For full discussion, see [here](https://github.com/code-423n4/2024-03-abracadabra-money-findings/issues/146)._\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2024-03-abracadabra-money",
  "Code": [
    {
      "filename": "src/oracles/aggregators/MagicLpAggregator.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity >=0.8.0;\n\nimport {FixedPointMathLib} from \"solady/utils/FixedPointMathLib.sol\";\nimport {IERC20Metadata} from \"openzeppelin-contracts/interfaces/IERC20Metadata.sol\";\nimport {IAggregator} from \"interfaces/IAggregator.sol\";\nimport {IMagicLP} from \"/mimswap/interfaces/IMagicLP.sol\";\n\ncontract MagicLpAggregator is IAggregator {\n    IMagicLP public immutable pair;\n    IAggregator public immutable baseOracle;\n    IAggregator public immutable quoteOracle;\n    uint8 public immutable baseDecimals;\n    uint8 public immutable quoteDecimals;\n\n    uint256 public constant WAD = 18;\n\n    /// @param pair_ The MagicLP pair address\n    /// @param baseOracle_ The base oracle\n    /// @param quoteOracle_ The quote oracle\n    constructor(IMagicLP pair_, IAggregator baseOracle_, IAggregator quoteOracle_) {\n        pair = pair_;\n        baseOracle = baseOracle_;\n        quoteOracle = quoteOracle_;\n        baseDecimals = IERC20Metadata(pair_._BASE_TOKEN_()).decimals();\n        quoteDecimals = IERC20Metadata(pair_._QUOTE_TOKEN_()).decimals();\n    }\n\n    function decimals() external pure override returns (uint8) {\n        return 18;\n    }\n\n    function _getReserves() internal view virtual returns (uint256, uint256) {\n        (uint256 baseReserve, uint256 quoteReserve) = pair.getReserves();\n    }\n\n    function latestAnswer() public view override returns (int256) {\n        uint256 baseAnswerNomalized = uint256(baseOracle.latestAnswer()) * (10 ** (WAD - baseOracle.decimals()));\n        uint256 quoteAnswerNormalized = uint256(quoteOracle.latestAnswer()) * (10 ** (WAD - quoteOracle.decimals()));\n        uint256 minAnswer = baseAnswerNomalized < quoteAnswerNormalized ? baseAnswerNomalized : quoteAnswerNormalized;\n\n        (uint256 baseReserve, uint256 quoteReserve) = _getReserves();\n        baseReserve = baseReserve * (10 ** (WAD - baseDecimals));\n        quoteReserve = quoteReserve * (10 ** (WAD - quoteDecimals));\n        return int256(minAnswer * (baseReserve + quoteReserve) / pair.totalSupply());\n    }\n\n    function latestRoundData() external view returns (uint80, int256, uint256, uint256, uint80) {\n        return (0, latestAnswer(), 0, 0, 0);\n    }\n}"
    },
    {
      "filename": "src/oracles/aggregators/MagicLpAggregator.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity >=0.8.0;\n\nimport {FixedPointMathLib} from \"solady/utils/FixedPointMathLib.sol\";\nimport {IERC20Metadata} from \"openzeppelin-contracts/interfaces/IERC20Metadata.sol\";\nimport {IAggregator} from \"interfaces/IAggregator.sol\";\nimport {IMagicLP} from \"/mimswap/interfaces/IMagicLP.sol\";\n\ncontract MagicLpAggregator is IAggregator {\n    IMagicLP public immutable pair;\n    IAggregator public immutable baseOracle;\n    IAggregator public immutable quoteOracle;\n    uint8 public immutable baseDecimals;\n    uint8 public immutable quoteDecimals;\n\n    uint256 public constant WAD = 18;\n\n    /// @param pair_ The MagicLP pair address\n    /// @param baseOracle_ The base oracle\n    /// @param quoteOracle_ The quote oracle\n    constructor(IMagicLP pair_, IAggregator baseOracle_, IAggregator quoteOracle_) {\n        pair = pair_;\n        baseOracle = baseOracle_;\n        quoteOracle = quoteOracle_;\n        baseDecimals = IERC20Metadata(pair_._BASE_TOKEN_()).decimals();\n        quoteDecimals = IERC20Metadata(pair_._QUOTE_TOKEN_()).decimals();\n    }\n\n    function decimals() external pure override returns (uint8) {\n        return 18;\n    }\n\n    function _getReserves() internal view virtual returns (uint256, uint256) {\n        (uint256 baseReserve, uint256 quoteReserve) = pair.getReserves();\n    }\n\n    function latestAnswer() public view override returns (int256) {\n        uint256 baseAnswerNomalized = uint256(baseOracle.latestAnswer()) * (10 ** (WAD - baseOracle.decimals()));\n        uint256 quoteAnswerNormalized = uint256(quoteOracle.latestAnswer()) * (10 ** (WAD - quoteOracle.decimals()));\n        uint256 minAnswer = baseAnswerNomalized < quoteAnswerNormalized ? baseAnswerNomalized : quoteAnswerNormalized;\n\n        (uint256 baseReserve, uint256 quoteReserve) = _getReserves();\n        baseReserve = baseReserve * (10 ** (WAD - baseDecimals));\n        quoteReserve = quoteReserve * (10 ** (WAD - quoteDecimals));\n        return int256(minAnswer * (baseReserve + quoteReserve) / pair.totalSupply());\n    }\n\n    function latestRoundData() external view returns (uint80, int256, uint256, uint256, uint80) {\n        return (0, latestAnswer(), 0, 0, 0);\n    }\n}"
    }
  ]
}