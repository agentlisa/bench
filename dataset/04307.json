{
  "Title": "[L01] Possibly miscalculated late penalty",
  "Content": "In the [`computeRegularFee` function](https://github.com/UMAprotocol/protocol/blob/9d403ddb5f2f07194daefe7da51e0e0a6306f2c4/core/contracts/oracle/implementation/Store.sol#L85) of the `Store` contract, the late penalty fee is calculated using the duration of time that the contract is paying for. It does not include any notion of the current time or the due date. This only makes sense if `startTime` is the time that the fee started accruing and `endTime` is the current time. If this is a requirement, it should be specified and enforced. Otherwise, contracts that use this function to calculate fees for different periods of time may be misinformed about the late penalty.\n\n\nDepending on how the function is intended to be used, consider replacing the `endTime` parameter with the current block time, or moving the late penalty fee calculation into its own separate function, and documenting the intended use either way.\n\n\n**Update:** *Fixed in [PR#1237](https://github.com/UMAprotocol/protocol/pull/1237). The late penalty is now scaled by the difference between `startTime` and the current time. Importantly, in the expected use case, it now scales quadratically with the number of unpaid weeks. The regular fee is unchanged.*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "core/contracts/oracle/implementation/Store.sol",
      "content": "pragma solidity ^0.6.0;\npragma experimental ABIEncoderV2;\n\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\nimport \"../../common/implementation/FixedPoint.sol\";\nimport \"../../common/implementation/MultiRole.sol\";\nimport \"../../common/implementation/Withdrawable.sol\";\nimport \"../interfaces/StoreInterface.sol\";\n\n\n/**\n * @title An implementation of Store that can accept Oracle fees in ETH or any arbitrary ERC20 token.\n */\ncontract Store is StoreInterface, MultiRole, Withdrawable {\n    using SafeMath for uint;\n    using FixedPoint for FixedPoint.Unsigned;\n    using FixedPoint for uint;\n\n    /****************************************\n     *    INTERNAL VARIABLES AND STORAGE    *\n     ****************************************/\n\n    enum Roles { Owner, Withdrawer }\n\n    FixedPoint.Unsigned public fixedOracleFeePerSecond; // Percentage of 1 E.g., .1 is 10% Oracle fee.\n    FixedPoint.Unsigned public weeklyDelayFee; // Percentage of 1 E.g., .1 is 10% weekly delay fee.\n\n    mapping(address => FixedPoint.Unsigned) public finalFees;\n    uint public constant SECONDS_PER_WEEK = 604800;\n\n    /****************************************\n     *                EVENTS                *\n     ****************************************/\n\n    event NewFixedOracleFeePerSecond(FixedPoint.Unsigned newOracleFee);\n\n    /**\n     * @notice Construct the Store contract.\n     */\n    constructor() public {\n        _createExclusiveRole(uint(Roles.Owner), uint(Roles.Owner), msg.sender);\n        createWithdrawRole(uint(Roles.Withdrawer), uint(Roles.Owner), msg.sender);\n    }\n\n    /****************************************\n     *  ORACLE FEE CALCULATION AND PAYMENT  *\n     ****************************************/\n\n    /**\n     * @notice Pays Oracle fees in ETH to the store.\n     * @dev To be used by contracts whose margin currency is ETH.\n     */\n    // TODO(#969) Remove once prettier-plugin-solidity can handle the \"override\" keyword\n    // prettier-ignore\n    function payOracleFees() external override payable {\n        require(msg.value > 0);\n    }\n\n    /**\n     * @notice Pays oracle fees in the margin currency, erc20Address, to the store.\n     * @dev To be used if the margin currency is an ERC20 token rather than ETH.\n     * All approved tokens are transferred.\n     * @param erc20Address address of the ERC20 token used to pay the fee.\n     */\n    // TODO(#969) Remove once prettier-plugin-solidity can handle the \"override\" keyword\n    // prettier-ignore\n    function payOracleFeesErc20(address erc20Address) external override {\n        IERC20 erc20 = IERC20(erc20Address);\n        uint authorizedAmount = erc20.allowance(msg.sender, address(this));\n        require(authorizedAmount > 0);\n        require(erc20.transferFrom(msg.sender, address(this), authorizedAmount));\n    }\n\n    /**\n     * @notice Computes the regular oracle fees that a contract should pay for a period.\n     * @param startTime defines the beginning time from which the fee is paid.\n     * @param endTime end time until which the fee is paid.\n     * @param pfc \"profit from corruption\", or the maximum amount of margin currency that a\n     * token sponsor could extract from the contract through corrupting the price feed in their favor.\n     * @return regularFee amount owed for the duration from start to end time for the given pfc.\n     * @return latePenalty penalty percentage, if any, for paying the fee after the deadline.\n     */\n    // TODO(#969) Remove once prettier-plugin-solidity can handle the \"override\" keyword\n    // prettier-ignore\n    function computeRegularFee(uint startTime, uint endTime, FixedPoint.Unsigned calldata pfc)\n        external\n        override\n        view\n        returns (FixedPoint.Unsigned memory regularFee, FixedPoint.Unsigned memory latePenalty)\n    {\n        uint timeDiff = endTime.sub(startTime);\n\n        // Multiply by the unscaled `timeDiff` first, to get more accurate results.\n        regularFee = pfc.mul(timeDiff).mul(fixedOracleFeePerSecond);\n        // `weeklyDelayFee` is already scaled up.\n        latePenalty = pfc.mul(weeklyDelayFee.mul(timeDiff.div(SECONDS_PER_WEEK)));\n\n        return (regularFee, latePenalty);\n    }\n\n    /**\n     * @notice Computes the final oracle fees that a contract should pay at settlement.\n     * @param currency token used to pay the final fee.\n     * @return finalFee amount due denominated in units of `currency`.\n     */\n    // TODO(#969) Remove once prettier-plugin-solidity can handle the \"override\" keyword\n    // prettier-ignore\n    function computeFinalFee(address currency) external override view returns (FixedPoint.Unsigned memory finalFee) {\n        finalFee = finalFees[currency];\n    }\n\n    /****************************************\n     *   ADMIN STATE MODIFYING FUNCTIONS    *\n     ****************************************/\n\n    /**\n     * @notice Sets a new oracle fee per second.\n     * @param newOracleFee new fee per second charged to use the oracle.\n     */\n    function setFixedOracleFeePerSecond(FixedPoint.Unsigned memory newOracleFee)\n        public\n        onlyRoleHolder(uint(Roles.Owner))\n    {\n        // Oracle fees at or over 100% don't make sense.\n        require(newOracleFee.isLessThan(1));\n        fixedOracleFeePerSecond = newOracleFee;\n        emit NewFixedOracleFeePerSecond(newOracleFee);\n    }\n\n    /**\n     * @notice Sets a new weekly delay fee.\n     * @param newWeeklyDelayFee fee escalation per week of late fee payment.\n     */\n    function setWeeklyDelayFee(FixedPoint.Unsigned memory newWeeklyDelayFee) public onlyRoleHolder(uint(Roles.Owner)) {\n        weeklyDelayFee = newWeeklyDelayFee;\n    }\n\n    /**\n     * @notice Sets a new final fee for a particular currency.\n     * @param currency defines the token currency used to pay the final fee.\n     * @param finalFee final fee amount.\n     */\n    function setFinalFee(address currency, FixedPoint.Unsigned memory finalFee)\n        public\n        onlyRoleHolder(uint(Roles.Owner))\n    {\n        finalFees[currency] = finalFee;\n    }\n}"
    }
  ]
}