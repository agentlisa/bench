{
  "Title": "[H-01] CBEthCollateral and AnkrStakedEthCollateral \\_underlyingRefPerTok is incorrect",
  "Content": "\n### Lines of Code\n\n<https://github.com/reserve-protocol/protocol/blob/9ee60f142f9f5c1fe8bc50eef915cf33124a534f/contracts/plugins/assets/cbeth/CBETHCollateral.sol#L67-L69><br>\n<https://github.com/reserve-protocol/protocol/blob/9ee60f142f9f5c1fe8bc50eef915cf33124a534f/contracts/plugins/assets/ankr/AnkrStakedEthCollateral.sol#L58-L61>\n\nThe `CBEthCollateral._underlyingRefPerTok()` function just uses `CBEth.exchangeRate()` to get the ref/tok rate. The `CBEth.exchangeRate()` can only get the conversion rate from cbETH to staked ETH2 on the coinbase. However as the docs `https://github.com/reserve-protocol/protocol/blob/9ee60f142f9f5c1fe8bc50eef915cf33124a534f/contracts/2023-07-reserve/protocol/contracts/plugins/assets/cbeth/README.md` the ref unit should be ETH. The staked ETH2 must take a few days to unstake, which leads to a premium between ETH and cbETH.\n\nAnd the `AnkrStakedEthCollateral` and `RethCollateral` has the same problem. According to the ankr docs, unstake eth by Flash unstake have to pay a fee, 0.5% of the unstaked amount. <https://www.ankr.com/docs/liquid-staking/eth/unstake/>\n\n### Impact\n\nThe `_underlyingRefPerTok` will return a higher ref/tok rate than the truth. And the premium is positively correlated with the unstake delay of eth2. When the unstake queue suddenly increases, the attacker can uses cbeth to issue more rtokens. Even if the cbETH has defaulted, the CBEthCollateral will never mark the state as DISABLED because the `CBEth.exchangeRate()` is updated by coinbase manager and it only represents the cbETH / staked eth2 rate instead of the cbETH/ETH rate.\n\n### Proof of Concept\n\nFor example, Now it's about 17819370 block high on the mainnet, and the `CBEth.exchangeRate()`(<https://etherscan.io/token/0xbe9895146f7af43049ca1c1ae358b0541ea49704#readProxyContract#F12>) is 1.045264058480813188, but the chainlink price feed for cbETH/ETH(<https://data.chain.link/ethereum/mainnet/crypto-eth/cbeth-eth>) is 1.0438.\n\n### Recommended Mitigation Steps\n\nUse the `cbETH/ETH` oracle to get the `cbETH/ETH` rate.\n\nOr, the ref unit for the collateral should be the staked eth2.\n\n### Assessed type\n\nContext\n\n**[tbrent (Reserve) commented](https://github.com/code-423n4/2023-07-reserve-findings/issues/23#issuecomment-1670254005):**\n > This feels like a duplicate of [#32](https://github.com/code-423n4/2023-07-reserve-findings/issues/32). The root cause is an incorrect reference unit. The reference unit should be staked eth2, as indicated here. \n\n**[pmckelvy1 (Reserve) confirmed](https://github.com/code-423n4/2023-07-reserve-findings/issues/23#issuecomment-1687102372)**\n\n**[ronnyx2017 (warden) commented](https://github.com/code-423n4/2023-07-reserve-findings/issues/23#issuecomment-1706448165):**\n > This issue and [32](https://github.com/code-423n4/2023-07-reserve-findings/issues/32) explain the misuse of tar unit and ref unit in staked eth related assets from different perspectives. The root cause is same, that 1 staked eth2 != 1 eth. This issue assumes that the ref token and target is all eth, which is referred to in [the docs](https://github.com/reserve-protocol/protocol/blob/9ee60f142f9f5c1fe8bc50eef915cf33124a534f/contracts/2023-07-reserve/protocol/contracts/plugins/assets/cbeth/README.md). So the error should be in the function `_underlyingRefPerTok`. But issue 32 assumes that the ref unit should be staked eth2 and the target unit is eth. So it needs to modify function `targetPerRef`. I also have mentioned this mitigation in the `Recommended Mitigation Steps` section of the current issue:\n> ```\n> Or, the ref unit for the collateral should be the staked eth2.\n> ```\n\n**[cccz (judge) increased severity to High](https://github.com/code-423n4/2023-07-reserve-findings/issues/23#issuecomment-1706659317)**\n\n**[Reserve Mitigated](https://github.com/code-423n4/2023-09-reserve-mitigation#individual-prs):**\n> Fixes units and price calculations in cbETH, rETH, ankrETH collateral plugins.<br>\n> PR: https://github.com/reserve-protocol/protocol/pull/899\n\n**Status**:Â Mitigation confirmed. Full details in reports from  [ronnyx2017](https://github.com/code-423n4/2023-09-reserve-mitigation-findings/issues/20), [bin2chen](https://github.com/code-423n4/2023-09-reserve-mitigation-findings/issues/3) and [RaymondFam](https://github.com/code-423n4/2023-09-reserve-mitigation-findings/issues/2).\n\n***\n\n",
  "Impact": "HIGH",
  "Source": "https://code4rena.com/reports/2023-07-reserve",
  "Code": [
    {
      "filename": "contracts/plugins/assets/cbeth/CBETHCollateral.sol",
      "content": "// SPDX-License-Identifier: BlueOak-1.0.0\npragma solidity 0.8.19;\n\nimport { IERC20Metadata } from \"@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol\";\nimport { _safeWrap } from \"../../../libraries/Fixed.sol\";\nimport \"../AppreciatingFiatCollateral.sol\";\n\ninterface CBEth is IERC20Metadata {\n    function mint(address account, uint256 amount) external returns (bool);\n\n    function updateExchangeRate(uint256 exchangeRate) external;\n\n    function configureMinter(address minter, uint256 minterAllowedAmount) external returns (bool);\n\n    function exchangeRate() external view returns (uint256 _exchangeRate);\n}\n\ncontract CBEthCollateral is AppreciatingFiatCollateral {\n    using OracleLib for AggregatorV3Interface;\n    using FixLib for uint192;\n\n    CBEth public immutable token;\n    AggregatorV3Interface public immutable refPerTokChainlinkFeed;\n    uint48 public immutable refPerTokChainlinkTimeout;\n\n    /// @param config.chainlinkFeed {UoA/ref} price of DAI in USD terms\n    constructor(\n        CollateralConfig memory config,\n        uint192 revenueHiding,\n        AggregatorV3Interface _refPerTokChainlinkFeed,\n        uint48 _refPerTokChainlinkTimeout\n    ) AppreciatingFiatCollateral(config, revenueHiding) {\n        token = CBEth(address(config.erc20));\n\n        refPerTokChainlinkFeed = _refPerTokChainlinkFeed;\n        refPerTokChainlinkTimeout = _refPerTokChainlinkTimeout;\n    }\n\n    /// Can revert, used by other contract functions in order to catch errors\n    /// @return low {UoA/tok} The low price estimate\n    /// @return high {UoA/tok} The high price estimate\n    /// @return pegPrice {target/ref} The actual price observed in the peg\n    function tryPrice()\n        external\n        view\n        override\n        returns (\n            uint192 low,\n            uint192 high,\n            uint192 pegPrice\n        )\n    {\n        // {UoA/tok} = {UoA/ref} * {ref/tok}\n        uint192 p = chainlinkFeed.price(oracleTimeout).mul(\n            refPerTokChainlinkFeed.price(refPerTokChainlinkTimeout)\n        );\n        uint192 err = p.mul(oracleError, CEIL);\n\n        high = p + err;\n        low = p - err;\n        // assert(low <= high); obviously true just by inspection\n\n        pegPrice = targetPerRef(); // {target/ref} ETH/ETH is always 1\n    }\n\n    /// @return {ref/tok} Actual quantity of whole reference units per whole collateral tokens\n    function _underlyingRefPerTok() internal view override returns (uint192) {\n        return _safeWrap(token.exchangeRate());\n    }\n}"
    },
    {
      "filename": "contracts/plugins/assets/ankr/AnkrStakedEthCollateral.sol",
      "content": "// SPDX-License-Identifier: BlueOak-1.0.0\npragma solidity 0.8.19;\n\nimport \"@openzeppelin/contracts/utils/math/Math.sol\";\nimport \"../../../libraries/Fixed.sol\";\nimport \"../AppreciatingFiatCollateral.sol\";\nimport \"../OracleLib.sol\";\nimport \"./vendor/IAnkrETH.sol\";\n\n/**\n * @title Ankr Staked Eth Collateral\n * @notice Collateral plugin for Ankr ankrETH,\n * tok = ankrETH\n * ref = ETH\n * tar = ETH\n * UoA = USD\n */\ncontract AnkrStakedEthCollateral is AppreciatingFiatCollateral {\n    using OracleLib for AggregatorV3Interface;\n    using FixLib for uint192;\n\n    // solhint-disable no-empty-blocks\n    /// @param config.chainlinkFeed Feed units: {UoA/ref}\n    constructor(CollateralConfig memory config, uint192 revenueHiding)\n        AppreciatingFiatCollateral(config, revenueHiding)\n    {}\n\n    // solhint-enable no-empty-blocks\n\n    /// Can revert, used by other contract functions in order to catch errors\n    /// @return low {UoA/tok} The low price estimate\n    /// @return high {UoA/tok} The high price estimate\n    /// @return pegPrice {target/ref} The actual price observed in the peg\n    function tryPrice()\n        external\n        view\n        override\n        returns (\n            uint192 low,\n            uint192 high,\n            uint192 pegPrice\n        )\n    {\n        uint192 pricePerRef = chainlinkFeed.price(oracleTimeout); // {UoA/ref}\n\n        // {UoA/tok} = {UoA/ref} * {ref/tok}\n        uint192 p = pricePerRef.mul(_underlyingRefPerTok());\n        uint192 err = p.mul(oracleError, CEIL);\n\n        low = p - err;\n        high = p + err;\n        // assert(low <= high); obviously true just by inspection\n\n        pegPrice = targetPerRef(); // ETH/ETH\n    }\n\n    /// @return {ref/tok} Quantity of whole reference units per whole collateral tokens\n    function _underlyingRefPerTok() internal view override returns (uint192) {\n        uint256 rate = IAnkrETH(address(erc20)).ratio();\n        return FIX_ONE.div(_safeWrap(rate), FLOOR);\n    }\n}"
    }
  ]
}