{
  "Title": "M-4: outdated variable is not effective to check price feed timeliness",
  "Content": "# Issue M-4: outdated variable is not effective to check price feed timeliness \n\nSource: https://github.com/sherlock-audit/2023-06-arrakis-judging/issues/83 \n\n## Found by \n0x007, 0x52, 0xg0, BenRai, Jeiwan, ast3ros, cergyk, elephant\\_coral, rvierdiiev, vnavascues\n## Summary\n\nIn ChainlinkOraclePivot, it uses one `outdated` variable to check if the two price feeds are outdated. However, this is not effective because the price feeds have different update frequencies.\n\n## Vulnerability Detail\n\nLet's have an example: \n\nIn Polygon mainnet, ChainlinkOraclePivot uses two Chainlink price feeds: MATIC/ETH and ETH/USD.\n \nThe setup can be the same in this test case:\nhttps://github.com/sherlock-audit/2023-06-arrakis/blob/main/v2-manager-templates/test/foundry/ChainLinkOraclePivotWrapper.t.sol#L49-L63\n\nWe can see that \n- priceFeedA: MATIC/ETH price feed has a heartbeat of 86400s (https://data.chain.link/polygon/mainnet/crypto-eth/matic-eth).\n- priceFeedB: ETH/USD price feed has a heartbeat of 27s (https://data.chain.link/polygon/mainnet/crypto-usd/eth-usd).\n\nIn function `_getLatestRoundData`, both price feeds use the same `outdated` variable.\n- If we set the `outdated` variable to 27s, the priceFeedA will revert most of the time since it is too short for the 86400s heartbeat.\n- If we set the `outdated` variable to 86400s, the priceFeedB can have a very outdated value without revert.\n\n```javascript\n        try priceFeedA.latestRoundData() returns (\n            uint80,\n            int256 price,\n            uint256,\n            uint256 updatedAt,\n            uint80\n        ) {\n            require(\n                block.timestamp - updatedAt <= outdated, // solhint-disable-line not-rely-on-time\n                \"ChainLinkOracle: priceFeedA outdated.\"\n            );\n\n            priceA = SafeCast.toUint256(price);\n        } catch {\n            revert(\"ChainLinkOracle: price feed A call failed.\");\n        }\n\n        try priceFeedB.latestRoundData() returns (\n            uint80,\n            int256 price,\n            uint256,\n            uint256 updatedAt,\n            uint80\n        ) {\n            require(\n                block.timestamp - updatedAt <= outdated, // solhint-disable-line not-rely-on-time\n                \"ChainLinkOracle: priceFeedB outdated.\"\n            );\n\n            priceB = SafeCast.toUint256(price);\n        } catch {\n            revert(\"ChainLinkOracle: price feed B call failed.\");\n        }\n```\n\nhttps://github.com/sherlock-audit/2023-06-arrakis/blob/main/v2-manager-templates/contracts/oracles/ChainLinkOraclePivot.sol#L239-L271\n\n## Impact\n\nThe `outdated` variable is not effective to check the timeliness of prices. It can allow stale prices in one price feed or always revert in another price feed.\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-06-arrakis/blob/main/v2-manager-templates/contracts/oracles/ChainLinkOraclePivot.sol#L31\nhttps://github.com/sherlock-audit/2023-06-arrakis/blob/main/v2-manager-templates/contracts/oracles/ChainLinkOraclePivot.sol#L239-L271\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nHaving two `outdated` values for each price feed A and B.\n\n\n\n## Discussion\n\n**Gevarist**\n\noracle price check will always revert for few specific feeds. Should not result in fund loss, we are not considering the issue as medium level.\n\n**ctf-sec**\n\nI think this regular revert impact the rebalance... \n\n#249 describes the issue well as well\n\nrecommend maintaining severity level\n\n**Gevarist**\n\nYes that can impact rebalance but should not result in fund loss.\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/86",
  "Code": [
    {
      "filename": "v2-manager-templates/test/foundry/ChainLinkOraclePivotWrapper.t.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity 0.8.13;\n\nimport \"../utils/TestWrapper.sol\";\nimport \"forge-std/Vm.sol\";\nimport {ChainLinkOracle} from \"contracts/oracles/ChainLinkOracle.sol\";\nimport {\n    ChainLinkOraclePivot,\n    FullMath\n} from \"contracts/oracles/ChainLinkOraclePivot.sol\";\nimport {hundred_percent} from \"contracts/constants/CSimpleManager.sol\";\n\n// solhint-disable-next-line max-states-count\ncontract ChainLinkOraclePivotWrapperTest is TestWrapper {\n    using stdStorage for StdStorage;\n\n    // solhint-disable-next-line no-empty-blocks\n    function setUp() public {}\n\n    // #region 1st case .\n\n    // solhint-disable-next-line function-max-lines\n    function testFirstCase() public {\n        // #region expected oracle.\n\n        address expectedPriceFeed = 0xAB594600376Ec9fD91F8e885dADF0CE036862dE0;\n        uint8 token0Decimals = 18;\n        uint8 token1Decimals = 8;\n\n        uint256 outdated = 100_000;\n        bool isPriceFeedInversed = false;\n\n        ChainLinkOracle expectedOracle = new ChainLinkOracle(\n            token0Decimals,\n            token1Decimals,\n            expectedPriceFeed,\n            address(0),\n            outdated,\n            isPriceFeedInversed\n        );\n\n        uint256 expectedPrice0 = expectedOracle.getPrice0();\n        uint256 expectedPrice1 = expectedOracle.getPrice1();\n\n        // #endregion expected oracle.\n\n        // #region pivot oracle.\n\n        address priceFeed0 = 0x327e23A4855b6F663a28c5161541d69Af8973302;\n        address priceFeed1 = 0xF9680D99D6C9589e2a93a78A04A279e509205945;\n        bool isPriceFeed0Inversed = false;\n        bool isPriceFeed1Inversed = false;\n\n        ChainLinkOraclePivot oraclePivot = new ChainLinkOraclePivot(\n            token0Decimals,\n            token1Decimals,\n            priceFeed0,\n            priceFeed1,\n            address(0),\n            outdated,\n            isPriceFeed0Inversed,\n            isPriceFeed1Inversed\n        );\n\n        uint256 actualPrice0 = oraclePivot.getPrice0();\n        uint256 actualPrice1 = oraclePivot.getPrice1();\n\n        // #endregion pivot oracle.\n\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice0 > actualPrice0\n                    ? expectedPrice0 - actualPrice0\n                    : actualPrice0 - expectedPrice0,\n                hundred_percent,\n                expectedPrice0\n            ),\n            100\n        );\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice1 > actualPrice1\n                    ? expectedPrice1 - actualPrice1\n                    : actualPrice1 - expectedPrice1,\n                hundred_percent,\n                expectedPrice1\n            ),\n            100\n        );\n    }\n\n    // #endregion 1st case.\n\n    // #region 4th case .\n\n    // solhint-disable-next-line function-max-lines\n    function testFourthCase() public {\n        // #region expected oracle.\n\n        address expectedPriceFeed = 0xAB594600376Ec9fD91F8e885dADF0CE036862dE0;\n        uint8 token0Decimals = 8;\n        uint8 token1Decimals = 18;\n\n        uint256 outdated = 100_000;\n        bool isPriceFeedInversed = true;\n\n        ChainLinkOracle expectedOracle = new ChainLinkOracle(\n            token0Decimals,\n            token1Decimals,\n            expectedPriceFeed,\n            address(0),\n            outdated,\n            isPriceFeedInversed\n        );\n\n        uint256 expectedPrice0 = expectedOracle.getPrice0();\n        uint256 expectedPrice1 = expectedOracle.getPrice1();\n\n        // #endregion expected oracle.\n\n        // #region pivot oracle.\n\n        address priceFeed0 = 0xF9680D99D6C9589e2a93a78A04A279e509205945;\n        address priceFeed1 = 0x327e23A4855b6F663a28c5161541d69Af8973302;\n        bool isPriceFeed0Inversed = true;\n        bool isPriceFeed1Inversed = true;\n\n        ChainLinkOraclePivot oraclePivot = new ChainLinkOraclePivot(\n            token0Decimals,\n            token1Decimals,\n            priceFeed0,\n            priceFeed1,\n            address(0),\n            outdated,\n            isPriceFeed0Inversed,\n            isPriceFeed1Inversed\n        );\n\n        uint256 actualPrice0 = oraclePivot.getPrice0();\n        uint256 actualPrice1 = oraclePivot.getPrice1();\n\n        // #endregion pivot oracle.\n\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice0 > actualPrice0\n                    ? expectedPrice0 - actualPrice0\n                    : actualPrice0 - expectedPrice0,\n                hundred_percent,\n                expectedPrice0\n            ),\n            100\n        );\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice1 > actualPrice1\n                    ? expectedPrice1 - actualPrice1\n                    : actualPrice1 - expectedPrice1,\n                hundred_percent,\n                expectedPrice1\n            ),\n            100\n        );\n    }\n\n    // #endregion 4th case.\n\n    // #region 2nd case .\n\n    // solhint-disable-next-line function-max-lines\n    function testSecondCase() public {\n        // #region expected oracle.\n\n        address expectedPriceFeed = 0xefb7e6be8356cCc6827799B6A7348eE674A80EaE;\n        uint8 token0Decimals = 18;\n        uint8 token1Decimals = 8;\n\n        uint256 outdated = 100_000;\n        bool isPriceFeedInversed = true;\n\n        ChainLinkOracle expectedOracle = new ChainLinkOracle(\n            token0Decimals,\n            token1Decimals,\n            expectedPriceFeed,\n            address(0),\n            outdated,\n            isPriceFeedInversed\n        );\n\n        uint256 expectedPrice0 = expectedOracle.getPrice0();\n        uint256 expectedPrice1 = expectedOracle.getPrice1();\n\n        // #endregion expected oracle.\n\n        // #region pivot oracle.\n\n        address priceFeed0 = 0xF9680D99D6C9589e2a93a78A04A279e509205945;\n        address priceFeed1 = 0xfE4A8cc5b5B2366C1B58Bea3858e81843581b2F7;\n        bool isPriceFeed0Inversed = false;\n        bool isPriceFeed1Inversed = true;\n\n        ChainLinkOraclePivot oraclePivot = new ChainLinkOraclePivot(\n            token0Decimals,\n            token1Decimals,\n            priceFeed0,\n            priceFeed1,\n            address(0),\n            outdated,\n            isPriceFeed0Inversed,\n            isPriceFeed1Inversed\n        );\n\n        uint256 actualPrice0 = oraclePivot.getPrice0();\n        uint256 actualPrice1 = oraclePivot.getPrice1();\n\n        // #endregion pivot oracle.\n\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice0 > actualPrice0\n                    ? expectedPrice0 - actualPrice0\n                    : actualPrice0 - expectedPrice0,\n                hundred_percent,\n                expectedPrice0\n            ),\n            100\n        );\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice1 > actualPrice1\n                    ? expectedPrice1 - actualPrice1\n                    : actualPrice1 - expectedPrice1,\n                hundred_percent,\n                expectedPrice1\n            ),\n            100\n        );\n    }\n\n    // #endregion 2nd case.\n\n    // #region 3rd case .\n\n    // solhint-disable-next-line function-max-lines\n    function testThirdCase() public {\n        // #region expected oracle.\n\n        address expectedPriceFeed = 0xF9680D99D6C9589e2a93a78A04A279e509205945;\n        uint8 token0Decimals = 8;\n        uint8 token1Decimals = 18;\n\n        uint256 outdated = 100_000;\n        bool isPriceFeedInversed = true;\n\n        ChainLinkOracle expectedOracle = new ChainLinkOracle(\n            token0Decimals,\n            token1Decimals,\n            expectedPriceFeed,\n            address(0),\n            outdated,\n            isPriceFeedInversed\n        );\n\n        uint256 expectedPrice0 = expectedOracle.getPrice0();\n        uint256 expectedPrice1 = expectedOracle.getPrice1();\n\n        // #endregion expected oracle.\n\n        // #region pivot oracle.\n\n        address priceFeed0 = 0xfE4A8cc5b5B2366C1B58Bea3858e81843581b2F7;\n        address priceFeed1 = 0xefb7e6be8356cCc6827799B6A7348eE674A80EaE;\n        bool isPriceFeed0Inversed = true;\n        bool isPriceFeed1Inversed = false;\n\n        ChainLinkOraclePivot oraclePivot = new ChainLinkOraclePivot(\n            token0Decimals,\n            token1Decimals,\n            priceFeed0,\n            priceFeed1,\n            address(0),\n            outdated,\n            isPriceFeed0Inversed,\n            isPriceFeed1Inversed\n        );\n\n        uint256 actualPrice0 = oraclePivot.getPrice0();\n        uint256 actualPrice1 = oraclePivot.getPrice1();\n\n        // #endregion pivot oracle.\n\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice0 > actualPrice0\n                    ? expectedPrice0 - actualPrice0\n                    : actualPrice0 - expectedPrice0,\n                hundred_percent,\n                expectedPrice0\n            ),\n            100\n        );\n        assertLe(\n            FullMath.mulDiv(\n                expectedPrice1 > actualPrice1\n                    ? expectedPrice1 - actualPrice1\n                    : actualPrice1 - expectedPrice1,\n                hundred_percent,\n                expectedPrice1\n            ),\n            100\n        );\n    }\n\n    // #endregion 3rd case.\n}"
    },
    {
      "filename": "v2-manager-templates/contracts/oracles/ChainLinkOraclePivot.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity 0.8.13;\n\nimport {IOracleWrapper} from \"../interfaces/IOracleWrapper.sol\";\nimport {AggregatorV3Interface} from \"../interfaces/AggregatorV3Interface.sol\";\nimport {Ownable} from \"@openzeppelin/contracts/access/Ownable.sol\";\nimport {FullMath} from \"@arrakisfi/v3-lib-0.8/contracts/FullMath.sol\";\nimport {SafeCast} from \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\n\n/// @title ChainLink Oracle wrapper\ncontract ChainLinkOraclePivot is IOracleWrapper, Ownable {\n    // #region constant variable.\n\n    // solhint-disable-next-line private-vars-leading-underscore\n    uint256 private constant GRACE_PERIOD_TIME = 3600;\n\n    // #endregion constant variable.\n\n    // #region immutable variable.\n\n    uint8 public immutable token0Decimals;\n    uint8 public immutable token1Decimals;\n    AggregatorV3Interface public immutable priceFeedA;\n    AggregatorV3Interface public immutable priceFeedB;\n    AggregatorV3Interface public immutable sequencerUptimeFeed;\n    bool internal immutable _ispriceFeedAInversed;\n    bool internal immutable _ispriceFeedBInversed;\n\n    // #endregion immutable variable.\n\n    uint256 public outdated;\n\n    // #region events.\n\n    event LogSetOutdated(\n        address oracle,\n        uint256 oldOutdated,\n        uint256 newOutdated\n    );\n\n    // #endregion events.\n\n    constructor(\n        uint8 token0Decimals_,\n        uint8 token1Decimals_,\n        address priceFeedA_,\n        address priceFeedB_,\n        address sequencerUptimeFeed_,\n        uint256 outdated_,\n        bool ispriceFeedAInversed_,\n        bool ispriceFeedBInversed_\n    ) {\n        require(priceFeedA_ != address(0) || priceFeedB_ != address(0), \"ZA\");\n        token0Decimals = token0Decimals_;\n        token1Decimals = token1Decimals_;\n        priceFeedA = AggregatorV3Interface(priceFeedA_);\n        priceFeedB = AggregatorV3Interface(priceFeedB_);\n        sequencerUptimeFeed = AggregatorV3Interface(sequencerUptimeFeed_);\n        outdated = outdated_;\n        _ispriceFeedAInversed = ispriceFeedAInversed_;\n        _ispriceFeedBInversed = ispriceFeedBInversed_;\n    }\n\n    /// @notice set outdated value\n    /// @param outdated_ new outdated value\n    function setOutdated(uint256 outdated_) external onlyOwner {\n        uint256 oldOutdated = outdated;\n        outdated = outdated_;\n        emit LogSetOutdated(address(this), oldOutdated, outdated_);\n    }\n\n    /// @notice get Price of token 1 over token 0\n    /// @return price0\n    // solhint-disable-next-line function-max-lines, code-complexity\n    function getPrice0() external view override returns (uint256 price0) {\n        if (address(sequencerUptimeFeed) != address(0)) _checkSequencer();\n\n        (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        ) = _getLatestRoundData();\n\n        // #region 1st case.\n\n        if (!_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    priceA * priceB,\n                    10 ** token1Decimals,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 1st case.\n\n        // #region 2nd case.\n\n        if (_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedADecimals)) * priceB,\n                        10 ** token1Decimals,\n                        priceA\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 2nd case.\n\n        // #region 3rd case.\n\n        if (!_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedBDecimals)) * priceA,\n                        10 ** token1Decimals,\n                        priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 3rd case.\n\n        // #region 4th case.\n\n        if (_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        10 ** (2 * (priceFeedADecimals + priceFeedBDecimals)),\n                        10 ** token1Decimals,\n                        priceA * priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 4th case.\n    }\n\n    /// @notice get Price of token 0 over token 1\n    /// @return price1\n    // solhint-disable-next-line function-max-lines, code-complexity\n    function getPrice1() external view override returns (uint256 price1) {\n        if (address(sequencerUptimeFeed) != address(0)) _checkSequencer();\n\n        (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        ) = _getLatestRoundData();\n\n        // #region 1st case.\n\n        if (!_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        10 ** (2 * (priceFeedADecimals + priceFeedBDecimals)),\n                        10 ** token0Decimals,\n                        priceA * priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 1st case.\n\n        // #region 2nd case.\n\n        if (_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedBDecimals)) * priceA,\n                        10 ** token0Decimals,\n                        priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 2nd case.\n\n        // #region 3rd case.\n\n        if (!_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedADecimals)) * priceB,\n                        10 ** token0Decimals,\n                        priceA\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 3rd case.\n\n        // #region 4th case.\n\n        if (_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    priceA * priceB,\n                    10 ** token0Decimals,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 4th case.\n    }\n\n    // solhint-disable-next-line function-max-lines\n    function _getLatestRoundData()\n        internal\n        view\n        returns (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        )\n    {\n        try priceFeedA.latestRoundData() returns (\n            uint80,\n            int256 price,\n            uint256,\n            uint256 updatedAt,\n            uint80\n        ) {\n            require(\n                block.timestamp - updatedAt <= outdated, // solhint-disable-line not-rely-on-time\n                \"ChainLinkOracle: priceFeedA outdated.\"\n            );\n\n            priceA = SafeCast.toUint256(price);\n        } catch {\n            revert(\"ChainLinkOracle: price feed A call failed.\");\n        }\n\n        try priceFeedB.latestRoundData() returns (\n            uint80,\n            int256 price,\n            uint256,\n            uint256 updatedAt,\n            uint80\n        ) {\n            require(\n                block.timestamp - updatedAt <= outdated, // solhint-disable-line not-rely-on-time\n                \"ChainLinkOracle: priceFeedB outdated.\"\n            );\n\n            priceB = SafeCast.toUint256(price);\n        } catch {\n            revert(\"ChainLinkOracle: price feed B call failed.\");\n        }\n\n        priceFeedADecimals = priceFeedA.decimals();\n        priceFeedBDecimals = priceFeedB.decimals();\n    }\n\n    /// @dev only needed for optimistic L2 chain\n    function _checkSequencer() internal view {\n        (, int256 answer, uint256 startedAt, , ) = sequencerUptimeFeed\n            .latestRoundData();\n\n        require(answer == 0, \"ChainLinkOracle: sequencer down\");\n\n        // Make sure the grace period has passed after the\n        // sequencer is back up.\n        require(\n            block.timestamp - startedAt > GRACE_PERIOD_TIME, // solhint-disable-line not-rely-on-time, max-line-length\n            \"ChainLinkOracle: grace period not over\"\n        );\n    }\n\n    function _getPrice(\n        bool isPriceFeedInversed_,\n        uint8 priceFeedDecimals_,\n        uint8 tokenDecimals_,\n        int256 price_\n    ) internal pure returns (uint256) {\n        if (!isPriceFeedInversed_) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        10 ** (2 * priceFeedDecimals_),\n                        10 ** tokenDecimals_,\n                        SafeCast.toUint256(price_)\n                    ),\n                    1,\n                    10 ** priceFeedDecimals_\n                );\n        }\n        return\n            FullMath.mulDiv(\n                SafeCast.toUint256(price_),\n                10 ** tokenDecimals_,\n                10 ** priceFeedDecimals_\n            );\n    }\n}"
    },
    {
      "filename": "v2-manager-templates/contracts/oracles/ChainLinkOraclePivot.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity 0.8.13;\n\nimport {IOracleWrapper} from \"../interfaces/IOracleWrapper.sol\";\nimport {AggregatorV3Interface} from \"../interfaces/AggregatorV3Interface.sol\";\nimport {Ownable} from \"@openzeppelin/contracts/access/Ownable.sol\";\nimport {FullMath} from \"@arrakisfi/v3-lib-0.8/contracts/FullMath.sol\";\nimport {SafeCast} from \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\n\n/// @title ChainLink Oracle wrapper\ncontract ChainLinkOraclePivot is IOracleWrapper, Ownable {\n    // #region constant variable.\n\n    // solhint-disable-next-line private-vars-leading-underscore\n    uint256 private constant GRACE_PERIOD_TIME = 3600;\n\n    // #endregion constant variable.\n\n    // #region immutable variable.\n\n    uint8 public immutable token0Decimals;\n    uint8 public immutable token1Decimals;\n    AggregatorV3Interface public immutable priceFeedA;\n    AggregatorV3Interface public immutable priceFeedB;\n    AggregatorV3Interface public immutable sequencerUptimeFeed;\n    bool internal immutable _ispriceFeedAInversed;\n    bool internal immutable _ispriceFeedBInversed;\n\n    // #endregion immutable variable.\n\n    uint256 public outdated;\n\n    // #region events.\n\n    event LogSetOutdated(\n        address oracle,\n        uint256 oldOutdated,\n        uint256 newOutdated\n    );\n\n    // #endregion events.\n\n    constructor(\n        uint8 token0Decimals_,\n        uint8 token1Decimals_,\n        address priceFeedA_,\n        address priceFeedB_,\n        address sequencerUptimeFeed_,\n        uint256 outdated_,\n        bool ispriceFeedAInversed_,\n        bool ispriceFeedBInversed_\n    ) {\n        require(priceFeedA_ != address(0) || priceFeedB_ != address(0), \"ZA\");\n        token0Decimals = token0Decimals_;\n        token1Decimals = token1Decimals_;\n        priceFeedA = AggregatorV3Interface(priceFeedA_);\n        priceFeedB = AggregatorV3Interface(priceFeedB_);\n        sequencerUptimeFeed = AggregatorV3Interface(sequencerUptimeFeed_);\n        outdated = outdated_;\n        _ispriceFeedAInversed = ispriceFeedAInversed_;\n        _ispriceFeedBInversed = ispriceFeedBInversed_;\n    }\n\n    /// @notice set outdated value\n    /// @param outdated_ new outdated value\n    function setOutdated(uint256 outdated_) external onlyOwner {\n        uint256 oldOutdated = outdated;\n        outdated = outdated_;\n        emit LogSetOutdated(address(this), oldOutdated, outdated_);\n    }\n\n    /// @notice get Price of token 1 over token 0\n    /// @return price0\n    // solhint-disable-next-line function-max-lines, code-complexity\n    function getPrice0() external view override returns (uint256 price0) {\n        if (address(sequencerUptimeFeed) != address(0)) _checkSequencer();\n\n        (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        ) = _getLatestRoundData();\n\n        // #region 1st case.\n\n        if (!_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    priceA * priceB,\n                    10 ** token1Decimals,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 1st case.\n\n        // #region 2nd case.\n\n        if (_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedADecimals)) * priceB,\n                        10 ** token1Decimals,\n                        priceA\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 2nd case.\n\n        // #region 3rd case.\n\n        if (!_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedBDecimals)) * priceA,\n                        10 ** token1Decimals,\n                        priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 3rd case.\n\n        // #region 4th case.\n\n        if (_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        10 ** (2 * (priceFeedADecimals + priceFeedBDecimals)),\n                        10 ** token1Decimals,\n                        priceA * priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 4th case.\n    }\n\n    /// @notice get Price of token 0 over token 1\n    /// @return price1\n    // solhint-disable-next-line function-max-lines, code-complexity\n    function getPrice1() external view override returns (uint256 price1) {\n        if (address(sequencerUptimeFeed) != address(0)) _checkSequencer();\n\n        (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        ) = _getLatestRoundData();\n\n        // #region 1st case.\n\n        if (!_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        10 ** (2 * (priceFeedADecimals + priceFeedBDecimals)),\n                        10 ** token0Decimals,\n                        priceA * priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 1st case.\n\n        // #region 2nd case.\n\n        if (_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedBDecimals)) * priceA,\n                        10 ** token0Decimals,\n                        priceB\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 2nd case.\n\n        // #region 3rd case.\n\n        if (!_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedADecimals)) * priceB,\n                        10 ** token0Decimals,\n                        priceA\n                    ),\n                    1,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 3rd case.\n\n        // #region 4th case.\n\n        if (_ispriceFeedAInversed && _ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    priceA * priceB,\n                    10 ** token0Decimals,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 4th case.\n    }\n\n    // solhint-disable-next-line function-max-lines\n    function _getLatestRoundData()\n        internal\n        view\n        returns (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        )\n    {\n        try priceFeedA.latestRoundData() returns (\n            uint80,\n            int256 price,\n            uint256,\n            uint256 updatedAt,\n            uint80\n        ) {\n            require(\n                block.timestamp - updatedAt <= outdated, // solhint-disable-line not-rely-on-time\n                \"ChainLinkOracle: priceFeedA outdated.\"\n            );\n\n            priceA = SafeCast.toUint256(price);\n        } catch {\n            revert(\"ChainLinkOracle: price feed A call failed.\");\n        }\n\n        try priceFeedB.latestRoundData() returns (\n            uint80,\n            int256 price,\n            uint256,\n            uint256 updatedAt,\n            uint80\n        ) {\n            require(\n                block.timestamp - updatedAt <= outdated, // solhint-disable-line not-rely-on-time\n                \"ChainLinkOracle: priceFeedB outdated.\"\n            );\n\n            priceB = SafeCast.toUint256(price);\n        } catch {\n            revert(\"ChainLinkOracle: price feed B call failed.\");\n        }\n\n        priceFeedADecimals = priceFeedA.decimals();\n        priceFeedBDecimals = priceFeedB.decimals();\n    }\n\n    /// @dev only needed for optimistic L2 chain\n    function _checkSequencer() internal view {\n        (, int256 answer, uint256 startedAt, , ) = sequencerUptimeFeed\n            .latestRoundData();\n\n        require(answer == 0, \"ChainLinkOracle: sequencer down\");\n\n        // Make sure the grace period has passed after the\n        // sequencer is back up.\n        require(\n            block.timestamp - startedAt > GRACE_PERIOD_TIME, // solhint-disable-line not-rely-on-time, max-line-length\n            \"ChainLinkOracle: grace period not over\"\n        );\n    }\n\n    function _getPrice(\n        bool isPriceFeedInversed_,\n        uint8 priceFeedDecimals_,\n        uint8 tokenDecimals_,\n        int256 price_\n    ) internal pure returns (uint256) {\n        if (!isPriceFeedInversed_) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        10 ** (2 * priceFeedDecimals_),\n                        10 ** tokenDecimals_,\n                        SafeCast.toUint256(price_)\n                    ),\n                    1,\n                    10 ** priceFeedDecimals_\n                );\n        }\n        return\n            FullMath.mulDiv(\n                SafeCast.toUint256(price_),\n                10 ** tokenDecimals_,\n                10 ** priceFeedDecimals_\n            );\n    }\n}"
    },
    {
      "filename": "v2-manager-templates/contracts/oracles/ChainLinkOraclePivot.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity 0.8.13;\n\nimport {IOracleWrapper} from \"../interfaces/IOracleWrapper.sol\";\nimport {AggregatorV3Interface} from \"../interfaces/AggregatorV3Interface.sol\";\nimport {Ownable} from \"@openzeppelin/contracts/access/Ownable.sol\";\nimport {FullMath} from \"@arrakisfi/v3-lib-0.8/contracts/FullMath.sol\";\nimport {SafeCast} from \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\n\n/// @title ChainLink Oracle wrapper\ncontract ChainLinkOraclePivot is IOracleWrapper, Ownable {\n    // #region constant variable.\n\n    // solhint-disable-next-line private-vars-leading-underscore\n    uint256 private constant GRACE_PERIOD_TIME = 3600;\n\n    // #endregion constant variable.\n\n    // #region immutable variable.\n\n    uint8 public immutable token0Decimals;\n    uint8 public immutable token1Decimals;\n    AggregatorV3Interface public immutable priceFeedA;\n    AggregatorV3Interface public immutable priceFeedB;\n    AggregatorV3Interface public immutable sequencerUptimeFeed;\n    bool internal immutable _ispriceFeedAInversed;\n    bool internal immutable _ispriceFeedBInversed;\n\n    // #endregion immutable variable.\n\n    uint256 public outdated;\n\n    // #region events.\n\n    event LogSetOutdated(\n        address oracle,\n        uint256 oldOutdated,\n        uint256 newOutdated\n    );\n\n    // #endregion events.\n\n    constructor(\n        uint8 token0Decimals_,\n        uint8 token1Decimals_,\n        address priceFeedA_,\n        address priceFeedB_,\n        address sequencerUptimeFeed_,\n        uint256 outdated_,\n        bool ispriceFeedAInversed_,\n        bool ispriceFeedBInversed_\n    ) {\n        require(priceFeedA_ != address(0) || priceFeedB_ != address(0), \"ZA\");\n        token0Decimals = token0Decimals_;\n        token1Decimals = token1Decimals_;\n        priceFeedA = AggregatorV3Interface(priceFeedA_);\n        priceFeedB = AggregatorV3Interface(priceFeedB_);\n        sequencerUptimeFeed = AggregatorV3Interface(sequencerUptimeFeed_);\n        outdated = outdated_;\n        _ispriceFeedAInversed = ispriceFeedAInversed_;\n        _ispriceFeedBInversed = ispriceFeedBInversed_;\n    }\n\n    /// @notice set outdated value\n    /// @param outdated_ new outdated value\n    function setOutdated(uint256 outdated_) external onlyOwner {\n        uint256 oldOutdated = outdated;\n        outdated = outdated_;\n        emit LogSetOutdated(address(this), oldOutdated, outdated_);\n    }\n\n    /// @notice get Price of token 1 over token 0\n    /// @return price0\n    // solhint-disable-next-line function-max-lines, code-complexity\n    function getPrice0() external view override returns (uint256 price0) {\n        if (address(sequencerUptimeFeed) != address(0)) _checkSequencer();\n\n        (\n            uint256 priceA,\n            uint256 priceB,\n            uint8 priceFeedADecimals,\n            uint8 priceFeedBDecimals\n        ) = _getLatestRoundData();\n\n        // #region 1st case.\n\n        if (!_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    priceA * priceB,\n                    10 ** token1Decimals,\n                    10 ** (priceFeedADecimals + priceFeedBDecimals)\n                );\n        }\n\n        // #endregion 1st case.\n\n        // #region 2nd case.\n\n        if (_ispriceFeedAInversed && !_ispriceFeedBInversed) {\n            return\n                FullMath.mulDiv(\n                    FullMath.mulDiv(\n                        (10 ** (2 * priceFeedADecimals)) * priceB,\n                        10"
    }
  ]
}