{
  "Title": "[H-04] Price of sfrxEth derivative is calculated incorrectly",
  "Content": "\nIn the [ethPerDerivative()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L111-L117), the calculated `frxAmount` is multiplied by (10 &ast;&ast; 18) and divided by `price_oracle`, but it must be multiplied by `price_oracle` and divided by (10 &ast;&ast; 18).\n\nThe impact is severe as [ethPerDerivative()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L111-L117) function is used in [stake()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/SafEth.sol#L63-L101), one of  two main functions a user will interact with. The value returned by [ethPerDerivative()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L111-L117) affects the calculations of [`mintAmount`](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/SafEth.sol#L98). The incorrect calculation may over or understate the amount of safEth received by the user.\n\n[ethPerDerivative()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L111-L117) is also used in the [withdraw()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L60-L88) function when calculating [`minOut`](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L74). So, incorrect calculation of ethPerDerivative() may increase/decrease slippage. This can cause unexpected losses or function revert. If [withdraw()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L60-L88) function reverts, the function [unstake()](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/SafEth.sol#L108-L129) is unavailable => assets are locked.\n\n### Proof of Concept\n\nWe need to calculate: (10 &ast;&ast; 18) sfrxEth = X Eth.\n\nFor example, we `convertToAssets(10 ** 18)` and get `frxAmount` = 1031226769652703996. `price_oracle` returns 998827832404234820. So, (10 &ast;&ast; 18) frxEth costs 998827832404234820 Eth. Thus, (10 &ast;&ast; 18) sfrxEth costs `frxAmount * price_oracle / 10 ** 18` = 1031226769652703996 &ast; 998827832404234820 / 10 &ast;&ast; 18 Eth (1030017999049431492 Eth).\n\nBut [this function](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L111-L117):\n\n        function ethPerDerivative(uint256 _amount) public view returns (uint256) {\n            uint256 frxAmount = IsFrxEth(SFRX_ETH_ADDRESS).convertToAssets(\n                10 ** 18\n            );\n            return ((10 ** 18 * frxAmount) /\n                IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n        }\n\ncalculates the cost of sfrxEth as ` 10 ** 18 * frxAmount / price_oracle  ` = 10 &ast;&ast; 18 &ast; 1031226769652703996 / 998827832404234820 Eth (1032436958800480269 Eth). The current difference \\~ 0.23% but it can be more/less.\n\n### Recommended Mitigation Steps\n\nChange [these lines](https://github.com/code-423n4/2023-03-asymmetry/blob/main/contracts/SafEth/derivatives/SfrxEth.sol#L115-L116):\n\n            return ((10 ** 18 * frxAmount) /\n                IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n\nto:\n\n            return (frxAmount * IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle() / 10 ** 18);\n\n**[toshiSat (Asymmetry) disputed via duplicate issue `#698`](https://github.com/code-423n4/2023-03-asymmetry-findings/issues/698#issuecomment-1500457335)**\n\n**[Asymmetry mitigated](https://github.com/code-423n4/2023-05-asymmetry-mitigation-contest#mitigations-to-be-reviewed):**\n> To protect against oracle attacks we assume FRX is 1:1 with ETH and revert if the oracle says otherwise since there is no chainlink for FRX.<br>\n\n**Status:** Mitigation confirmed with comments. Full details in reports from [d3e4](https://github.com/code-423n4/2023-05-asymmetry-mitigation-findings/issues/32) and [adriro](https://github.com/code-423n4/2023-05-asymmetry-mitigation-findings/issues/27).\n\n\n\n***\n\n",
  "Impact": "HIGH",
  "Source": "https://code4rena.com/reports/2023-03-asymmetry",
  "Code": [
    {
      "filename": "contracts/SafEth/derivatives/SfrxEth.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"../../interfaces/IDerivative.sol\";\nimport \"../../interfaces/frax/IsFrxEth.sol\";\nimport \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"../../interfaces/curve/IFrxEthEthPool.sol\";\nimport \"../../interfaces/frax/IFrxETHMinter.sol\";\n\n/// @title Derivative contract for sfrxETH\n/// @author Asymmetry Finance\ncontract SfrxEth is IDerivative, Initializable, OwnableUpgradeable {\n    address public constant SFRX_ETH_ADDRESS =\n        0xac3E018457B222d93114458476f3E3416Abbe38F;\n    address public constant FRX_ETH_ADDRESS =\n        0x5E8422345238F34275888049021821E8E08CAa1f;\n    address public constant FRX_ETH_CRV_POOL_ADDRESS =\n        0xa1F8A6807c402E4A15ef4EBa36528A3FED24E577;\n    address public constant FRX_ETH_MINTER_ADDRESS =\n        0xbAFA44EFE7901E04E39Dad13167D089C559c1138;\n\n    uint256 public maxSlippage;\n\n    // As recommended by https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\n    /// @custom:oz-upgrades-unsafe-allow constructor\n    constructor() {\n        _disableInitializers();\n    }\n\n    /**\n        @notice - Function to initialize values for the contracts\n        @dev - This replaces the constructor for upgradeable contracts\n        @param _owner - owner of the contract which handles stake/unstake\n    */\n    function initialize(address _owner) external initializer {\n        _transferOwnership(_owner);\n        maxSlippage = (1 * 10 ** 16); // 1%\n    }\n\n    /**\n        @notice - Return derivative name\n    */\n    function name() public pure returns (string memory) {\n        return \"Frax\";\n    }\n\n    /**\n        @notice - Owner only function to set max slippage for derivative\n    */\n    function setMaxSlippage(uint256 _slippage) external onlyOwner {\n        maxSlippage = _slippage;\n    }\n\n    /**\n        @notice - Owner only function to Convert derivative into ETH\n        @dev - Owner is set to SafEth contract\n        @param _amount - Amount to withdraw\n     */\n    function withdraw(uint256 _amount) external onlyOwner {\n        IsFrxEth(SFRX_ETH_ADDRESS).redeem(\n            _amount,\n            address(this),\n            address(this)\n        );\n        uint256 frxEthBalance = IERC20(FRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        IsFrxEth(FRX_ETH_ADDRESS).approve(\n            FRX_ETH_CRV_POOL_ADDRESS,\n            frxEthBalance\n        );\n\n        uint256 minOut = (((ethPerDerivative(_amount) * _amount) / 10 ** 18) *\n            (10 ** 18 - maxSlippage)) / 10 ** 18;\n\n        IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).exchange(\n            1,\n            0,\n            frxEthBalance,\n            minOut\n        );\n        // solhint-disable-next-line\n        (bool sent, ) = address(msg.sender).call{value: address(this).balance}(\n            \"\"\n        );\n        require(sent, \"Failed to send Ether\");\n    }\n\n    /**\n        @notice - Owner only function to Deposit into derivative\n        @dev - Owner is set to SafEth contract\n     */\n    function deposit() external payable onlyOwner returns (uint256) {\n        IFrxETHMinter frxETHMinterContract = IFrxETHMinter(\n            FRX_ETH_MINTER_ADDRESS\n        );\n        uint256 sfrxBalancePre = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        frxETHMinterContract.submitAndDeposit{value: msg.value}(address(this));\n        uint256 sfrxBalancePost = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        return sfrxBalancePost - sfrxBalancePre;\n    }\n\n    /**\n        @notice - Get price of derivative in terms of ETH\n     */\n    function ethPerDerivative(uint256 _amount) public view returns (uint256) {\n        uint256 frxAmount = IsFrxEth(SFRX_ETH_ADDRESS).convertToAssets(\n            10 ** 18\n        );\n        return ((10 ** 18 * frxAmount) /\n            IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n    }\n\n    /**\n        @notice - Total derivative balance\n     */\n    function balance() public view returns (uint256) {\n        return IERC20(SFRX_ETH_ADDRESS).balanceOf(address(this));\n    }\n\n    receive() external payable {}\n}"
    },
    {
      "filename": "contracts/SafEth/derivatives/SfrxEth.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"../../interfaces/IDerivative.sol\";\nimport \"../../interfaces/frax/IsFrxEth.sol\";\nimport \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"../../interfaces/curve/IFrxEthEthPool.sol\";\nimport \"../../interfaces/frax/IFrxETHMinter.sol\";\n\n/// @title Derivative contract for sfrxETH\n/// @author Asymmetry Finance\ncontract SfrxEth is IDerivative, Initializable, OwnableUpgradeable {\n    address public constant SFRX_ETH_ADDRESS =\n        0xac3E018457B222d93114458476f3E3416Abbe38F;\n    address public constant FRX_ETH_ADDRESS =\n        0x5E8422345238F34275888049021821E8E08CAa1f;\n    address public constant FRX_ETH_CRV_POOL_ADDRESS =\n        0xa1F8A6807c402E4A15ef4EBa36528A3FED24E577;\n    address public constant FRX_ETH_MINTER_ADDRESS =\n        0xbAFA44EFE7901E04E39Dad13167D089C559c1138;\n\n    uint256 public maxSlippage;\n\n    // As recommended by https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\n    /// @custom:oz-upgrades-unsafe-allow constructor\n    constructor() {\n        _disableInitializers();\n    }\n\n    /**\n        @notice - Function to initialize values for the contracts\n        @dev - This replaces the constructor for upgradeable contracts\n        @param _owner - owner of the contract which handles stake/unstake\n    */\n    function initialize(address _owner) external initializer {\n        _transferOwnership(_owner);\n        maxSlippage = (1 * 10 ** 16); // 1%\n    }\n\n    /**\n        @notice - Return derivative name\n    */\n    function name() public pure returns (string memory) {\n        return \"Frax\";\n    }\n\n    /**\n        @notice - Owner only function to set max slippage for derivative\n    */\n    function setMaxSlippage(uint256 _slippage) external onlyOwner {\n        maxSlippage = _slippage;\n    }\n\n    /**\n        @notice - Owner only function to Convert derivative into ETH\n        @dev - Owner is set to SafEth contract\n        @param _amount - Amount to withdraw\n     */\n    function withdraw(uint256 _amount) external onlyOwner {\n        IsFrxEth(SFRX_ETH_ADDRESS).redeem(\n            _amount,\n            address(this),\n            address(this)\n        );\n        uint256 frxEthBalance = IERC20(FRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        IsFrxEth(FRX_ETH_ADDRESS).approve(\n            FRX_ETH_CRV_POOL_ADDRESS,\n            frxEthBalance\n        );\n\n        uint256 minOut = (((ethPerDerivative(_amount) * _amount) / 10 ** 18) *\n            (10 ** 18 - maxSlippage)) / 10 ** 18;\n\n        IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).exchange(\n            1,\n            0,\n            frxEthBalance,\n            minOut\n        );\n        // solhint-disable-next-line\n        (bool sent, ) = address(msg.sender).call{value: address(this).balance}(\n            \"\"\n        );\n        require(sent, \"Failed to send Ether\");\n    }\n\n    /**\n        @notice - Owner only function to Deposit into derivative\n        @dev - Owner is set to SafEth contract\n     */\n    function deposit() external payable onlyOwner returns (uint256) {\n        IFrxETHMinter frxETHMinterContract = IFrxETHMinter(\n            FRX_ETH_MINTER_ADDRESS\n        );\n        uint256 sfrxBalancePre = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        frxETHMinterContract.submitAndDeposit{value: msg.value}(address(this));\n        uint256 sfrxBalancePost = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        return sfrxBalancePost - sfrxBalancePre;\n    }\n\n    /**\n        @notice - Get price of derivative in terms of ETH\n     */\n    function ethPerDerivative(uint256 _amount) public view returns (uint256) {\n        uint256 frxAmount = IsFrxEth(SFRX_ETH_ADDRESS).convertToAssets(\n            10 ** 18\n        );\n        return ((10 ** 18 * frxAmount) /\n            IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n    }\n\n    /**\n        @notice - Total derivative balance\n     */\n    function balance() public view returns (uint256) {\n        return IERC20(SFRX_ETH_ADDRESS).balanceOf(address(this));\n    }\n\n    receive() external payable {}\n}"
    },
    {
      "filename": "contracts/SafEth/derivatives/SfrxEth.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"../../interfaces/IDerivative.sol\";\nimport \"../../interfaces/frax/IsFrxEth.sol\";\nimport \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"../../interfaces/curve/IFrxEthEthPool.sol\";\nimport \"../../interfaces/frax/IFrxETHMinter.sol\";\n\n/// @title Derivative contract for sfrxETH\n/// @author Asymmetry Finance\ncontract SfrxEth is IDerivative, Initializable, OwnableUpgradeable {\n    address public constant SFRX_ETH_ADDRESS =\n        0xac3E018457B222d93114458476f3E3416Abbe38F;\n    address public constant FRX_ETH_ADDRESS =\n        0x5E8422345238F34275888049021821E8E08CAa1f;\n    address public constant FRX_ETH_CRV_POOL_ADDRESS =\n        0xa1F8A6807c402E4A15ef4EBa36528A3FED24E577;\n    address public constant FRX_ETH_MINTER_ADDRESS =\n        0xbAFA44EFE7901E04E39Dad13167D089C559c1138;\n\n    uint256 public maxSlippage;\n\n    // As recommended by https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\n    /// @custom:oz-upgrades-unsafe-allow constructor\n    constructor() {\n        _disableInitializers();\n    }\n\n    /**\n        @notice - Function to initialize values for the contracts\n        @dev - This replaces the constructor for upgradeable contracts\n        @param _owner - owner of the contract which handles stake/unstake\n    */\n    function initialize(address _owner) external initializer {\n        _transferOwnership(_owner);\n        maxSlippage = (1 * 10 ** 16); // 1%\n    }\n\n    /**\n        @notice - Return derivative name\n    */\n    function name() public pure returns (string memory) {\n        return \"Frax\";\n    }\n\n    /**\n        @notice - Owner only function to set max slippage for derivative\n    */\n    function setMaxSlippage(uint256 _slippage) external onlyOwner {\n        maxSlippage = _slippage;\n    }\n\n    /**\n        @notice - Owner only function to Convert derivative into ETH\n        @dev - Owner is set to SafEth contract\n        @param _amount - Amount to withdraw\n     */\n    function withdraw(uint256 _amount) external onlyOwner {\n        IsFrxEth(SFRX_ETH_ADDRESS).redeem(\n            _amount,\n            address(this),\n            address(this)\n        );\n        uint256 frxEthBalance = IERC20(FRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        IsFrxEth(FRX_ETH_ADDRESS).approve(\n            FRX_ETH_CRV_POOL_ADDRESS,\n            frxEthBalance\n        );\n\n        uint256 minOut = (((ethPerDerivative(_amount) * _amount) / 10 ** 18) *\n            (10 ** 18 - maxSlippage)) / 10 ** 18;\n\n        IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).exchange(\n            1,\n            0,\n            frxEthBalance,\n            minOut\n        );\n        // solhint-disable-next-line\n        (bool sent, ) = address(msg.sender).call{value: address(this).balance}(\n            \"\"\n        );\n        require(sent, \"Failed to send Ether\");\n    }\n\n    /**\n        @notice - Owner only function to Deposit into derivative\n        @dev - Owner is set to SafEth contract\n     */\n    function deposit() external payable onlyOwner returns (uint256) {\n        IFrxETHMinter frxETHMinterContract = IFrxETHMinter(\n            FRX_ETH_MINTER_ADDRESS\n        );\n        uint256 sfrxBalancePre = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        frxETHMinterContract.submitAndDeposit{value: msg.value}(address(this));\n        uint256 sfrxBalancePost = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        return sfrxBalancePost - sfrxBalancePre;\n    }\n\n    /**\n        @notice - Get price of derivative in terms of ETH\n     */\n    function ethPerDerivative(uint256 _amount) public view returns (uint256) {\n        uint256 frxAmount = IsFrxEth(SFRX_ETH_ADDRESS).convertToAssets(\n            10 ** 18\n        );\n        return ((10 ** 18 * frxAmount) /\n            IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n    }\n\n    /**\n        @notice - Total derivative balance\n     */\n    function balance() public view returns (uint256) {\n        return IERC20(SFRX_ETH_ADDRESS).balanceOf(address(this));\n    }\n\n    receive() external payable {}\n}"
    },
    {
      "filename": "contracts/SafEth/derivatives/SfrxEth.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"../../interfaces/IDerivative.sol\";\nimport \"../../interfaces/frax/IsFrxEth.sol\";\nimport \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"../../interfaces/curve/IFrxEthEthPool.sol\";\nimport \"../../interfaces/frax/IFrxETHMinter.sol\";\n\n/// @title Derivative contract for sfrxETH\n/// @author Asymmetry Finance\ncontract SfrxEth is IDerivative, Initializable, OwnableUpgradeable {\n    address public constant SFRX_ETH_ADDRESS =\n        0xac3E018457B222d93114458476f3E3416Abbe38F;\n    address public constant FRX_ETH_ADDRESS =\n        0x5E8422345238F34275888049021821E8E08CAa1f;\n    address public constant FRX_ETH_CRV_POOL_ADDRESS =\n        0xa1F8A6807c402E4A15ef4EBa36528A3FED24E577;\n    address public constant FRX_ETH_MINTER_ADDRESS =\n        0xbAFA44EFE7901E04E39Dad13167D089C559c1138;\n\n    uint256 public maxSlippage;\n\n    // As recommended by https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\n    /// @custom:oz-upgrades-unsafe-allow constructor\n    constructor() {\n        _disableInitializers();\n    }\n\n    /**\n        @notice - Function to initialize values for the contracts\n        @dev - This replaces the constructor for upgradeable contracts\n        @param _owner - owner of the contract which handles stake/unstake\n    */\n    function initialize(address _owner) external initializer {\n        _transferOwnership(_owner);\n        maxSlippage = (1 * 10 ** 16); // 1%\n    }\n\n    /**\n        @notice - Return derivative name\n    */\n    function name() public pure returns (string memory) {\n        return \"Frax\";\n    }\n\n    /**\n        @notice - Owner only function to set max slippage for derivative\n    */\n    function setMaxSlippage(uint256 _slippage) external onlyOwner {\n        maxSlippage = _slippage;\n    }\n\n    /**\n        @notice - Owner only function to Convert derivative into ETH\n        @dev - Owner is set to SafEth contract\n        @param _amount - Amount to withdraw\n     */\n    function withdraw(uint256 _amount) external onlyOwner {\n        IsFrxEth(SFRX_ETH_ADDRESS).redeem(\n            _amount,\n            address(this),\n            address(this)\n        );\n        uint256 frxEthBalance = IERC20(FRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        IsFrxEth(FRX_ETH_ADDRESS).approve(\n            FRX_ETH_CRV_POOL_ADDRESS,\n            frxEthBalance\n        );\n\n        uint256 minOut = (((ethPerDerivative(_amount) * _amount) / 10 ** 18) *\n            (10 ** 18 - maxSlippage)) / 10 ** 18;\n\n        IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).exchange(\n            1,\n            0,\n            frxEthBalance,\n            minOut\n        );\n        // solhint-disable-next-line\n        (bool sent, ) = address(msg.sender).call{value: address(this).balance}(\n            \"\"\n        );\n        require(sent, \"Failed to send Ether\");\n    }\n\n    /**\n        @notice - Owner only function to Deposit into derivative\n        @dev - Owner is set to SafEth contract\n     */\n    function deposit() external payable onlyOwner returns (uint256) {\n        IFrxETHMinter frxETHMinterContract = IFrxETHMinter(\n            FRX_ETH_MINTER_ADDRESS\n        );\n        uint256 sfrxBalancePre = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        frxETHMinterContract.submitAndDeposit{value: msg.value}(address(this));\n        uint256 sfrxBalancePost = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        return sfrxBalancePost - sfrxBalancePre;\n    }\n\n    /**\n        @notice - Get price of derivative in terms of ETH\n     */\n    function ethPerDerivative(uint256 _amount) public view returns (uint256) {\n        uint256 frxAmount = IsFrxEth(SFRX_ETH_ADDRESS).convertToAssets(\n            10 ** 18\n        );\n        return ((10 ** 18 * frxAmount) /\n            IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n    }\n\n    /**\n        @notice - Total derivative balance\n     */\n    function balance() public view returns (uint256) {\n        return IERC20(SFRX_ETH_ADDRESS).balanceOf(address(this));\n    }\n\n    receive() external payable {}\n}"
    },
    {
      "filename": "contracts/SafEth/derivatives/SfrxEth.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"../../interfaces/IDerivative.sol\";\nimport \"../../interfaces/frax/IsFrxEth.sol\";\nimport \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"../../interfaces/curve/IFrxEthEthPool.sol\";\nimport \"../../interfaces/frax/IFrxETHMinter.sol\";\n\n/// @title Derivative contract for sfrxETH\n/// @author Asymmetry Finance\ncontract SfrxEth is IDerivative, Initializable, OwnableUpgradeable {\n    address public constant SFRX_ETH_ADDRESS =\n        0xac3E018457B222d93114458476f3E3416Abbe38F;\n    address public constant FRX_ETH_ADDRESS =\n        0x5E8422345238F34275888049021821E8E08CAa1f;\n    address public constant FRX_ETH_CRV_POOL_ADDRESS =\n        0xa1F8A6807c402E4A15ef4EBa36528A3FED24E577;\n    address public constant FRX_ETH_MINTER_ADDRESS =\n        0xbAFA44EFE7901E04E39Dad13167D089C559c1138;\n\n    uint256 public maxSlippage;\n\n    // As recommended by https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\n    /// @custom:oz-upgrades-unsafe-allow constructor\n    constructor() {\n        _disableInitializers();\n    }\n\n    /**\n        @notice - Function to initialize values for the contracts\n        @dev - This replaces the constructor for upgradeable contracts\n        @param _owner - owner of the contract which handles stake/unstake\n    */\n    function initialize(address _owner) external initializer {\n        _transferOwnership(_owner);\n        maxSlippage = (1 * 10 ** 16); // 1%\n    }\n\n    /**\n        @notice - Return derivative name\n    */\n    function name() public pure returns (string memory) {\n        return \"Frax\";\n    }\n\n    /**\n        @notice - Owner only function to set max slippage for derivative\n    */\n    function setMaxSlippage(uint256 _slippage) external onlyOwner {\n        maxSlippage = _slippage;\n    }\n\n    /**\n        @notice - Owner only function to Convert derivative into ETH\n        @dev - Owner is set to SafEth contract\n        @param _amount - Amount to withdraw\n     */\n    function withdraw(uint256 _amount) external onlyOwner {\n        IsFrxEth(SFRX_ETH_ADDRESS).redeem(\n            _amount,\n            address(this),\n            address(this)\n        );\n        uint256 frxEthBalance = IERC20(FRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        IsFrxEth(FRX_ETH_ADDRESS).approve(\n            FRX_ETH_CRV_POOL_ADDRESS,\n            frxEthBalance\n        );\n\n        uint256 minOut = (((ethPerDerivative(_amount) * _amount) / 10 ** 18) *\n            (10 ** 18 - maxSlippage)) / 10 ** 18;\n\n        IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).exchange(\n            1,\n            0,\n            frxEthBalance,\n            minOut\n        );\n        // solhint-disable-next-line\n        (bool sent, ) = address(msg.sender).call{value: address(this).balance}(\n            \"\"\n        );\n        require(sent, \"Failed to send Ether\");\n    }\n\n    /**\n        @notice - Owner only function to Deposit into derivative\n        @dev - Owner is set to SafEth contract\n     */\n    function deposit() external payable onlyOwner returns (uint256) {\n        IFrxETHMinter frxETHMinterContract = IFrxETHMinter(\n            FRX_ETH_MINTER_ADDRESS\n        );\n        uint256 sfrxBalancePre = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        frxETHMinterContract.submitAndDeposit{value: msg.value}(address(this));\n        uint256 sfrxBalancePost = IERC20(SFRX_ETH_ADDRESS).balanceOf(\n            address(this)\n        );\n        return sfrxBalancePost - sfrxBalancePre;\n    }\n\n    /**\n        @notice - Get price of derivative in terms of ETH\n     */\n    function ethPerDerivative(uint256 _amount) public view returns (uint256) {\n        uint256 frxAmount = IsFrxEth(SFRX_ETH_ADDRESS).convertToAssets(\n            10 ** 18\n        );\n        return ((10 ** 18 * frxAmount) /\n            IFrxEthEthPool(FRX_ETH_CRV_POOL_ADDRESS).price_oracle());\n    }\n\n    /**\n        @notice - Total derivative balance\n     */\n    function balance() public view returns (uint256) {\n        return IERC20(SFRX_ETH_ADDRESS).balanceOf(address(this));\n    }\n\n    receive() external payable {}\n}"
    }
  ]
}