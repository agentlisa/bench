{
  "Title": "M-7: Bid submission vulnerable to market parameters changes",
  "Content": "# Issue M-7: Bid submission vulnerable to market parameters changes \n\nSource: https://github.com/sherlock-audit/2023-03-teller-judging/issues/205 \n\n## Found by \nBAHOZ, Fanz, T1MOH, cducrest-brainbot, ck, immeas, jpserrat, juancito, whoismatthewmc1\n## Summary\n\nThe details for the audit state: \n\n> Market owners should NOT be able to race-condition attack borrowers or lenders by changing market settings while bids are being submitted or accepted (while tx are in mempool). Care has been taken to ensure that this is not possible (similar in theory to sandwich attacking but worse as if possible it could cause unexpected and non-consentual interest rate on a loan) and further-auditing of this is welcome.\n\nHowever, there is little protection in place to protect the submitter of a bid from changes in market parameters.\n\n## Vulnerability Detail\n\nIn _submitBid(), certain bid parameters are taken from the `marketRegistry`:\n\n```solidity\n    function _submitBid(...)\n        ...\n        (bid.terms.paymentCycle, bidPaymentCycleType[bidId]) = marketRegistry\n            .getPaymentCycle(_marketplaceId);\n\n        bid.terms.APR = _APR;\n\n        bidDefaultDuration[bidId] = marketRegistry.getPaymentDefaultDuration(\n            _marketplaceId\n        );\n\n        bidExpirationTime[bidId] = marketRegistry.getBidExpirationTime(\n            _marketplaceId\n        );\n\n        bid.paymentType = marketRegistry.getPaymentType(_marketplaceId);\n        \n        bid.terms.paymentCycleAmount = V2Calculations\n            .calculatePaymentCycleAmount(\n                bid.paymentType,\n                bidPaymentCycleType[bidId],\n                _principal,\n                _duration,\n                bid.terms.paymentCycle,\n                _APR\n            );\n        ...\n```\n\nAll the parameters taken from marketRegistry are controlled by the market owner:\nhttps://github.com/sherlock-audit/2023-03-teller/blob/main/teller-protocol-v2/packages/contracts/contracts/MarketRegistry.sol#L487-L511\n\n## Impact\n\nIf market parameters are changed in between the borrower submitting a bid transaction and the transaction being applied, borrower may be subject to changes in `bidDefaultDuration`, `bidExpirationTime`, `paymentType`, `paymentCycle`, `bidPaymentCycleType` and `paymentCycleAmount`.\n\nThat is, the user may be committed to the bid for longer / shorter than expected. They may have a longer / shorter default duration (time for the loan being considered defaulted / eligible for liquidation). They have un-provisioned for payment type and cycle parameters.\n\nI believe most of this will have a medium impact on borrower (mild inconveniences / resolvable by directly repaying the loan) if the market owner is not evil and adapting the parameters reasonably.\n\nAn evil market owner can set the value of `bidDefaultDuration` and `paymentCycle` very low (0) so that the loan will default immediately. It can then accept the bid, make user default immediately, and liquidate the loan to steal the user's collateral. This results in a loss of collateral for the borrower.\n\n## Code Snippet\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nTake every single parameters as input of `_submitBid()` (including fee percents) and compare them to the values in `marketRegistry` to make sure borrower agrees with them, revert if they differ.\n\n\n\n## Discussion\n\n**ethereumdegen**\n\nThe way the protocol was designed, market owners are 'trusted' however we will add a new submitBid method that adds these checks in case we want to support trustless market owners in the future \n\n**ethereumdegen**\n\nGithub PR: [Issue 205 - Harden submitBid from frontrun attacks by market owner](https://github.com/teller-protocol/teller-protocol-v2/pull/83)\n\n**ethereumdegen**\n\nA fix was made but it is not being applied at this time because it would create too drastic of a change to the ABI, the way that contracts interact with submitBid.   Furthermore, at the time, market owners are 'trusted' and so there is not a concern that they will frontrun.  \n\nWhen we do decide to open up the ability for anyone to be a market owner, we will revisit this fix and implement a protection strategy against front running the fees in the way or add a hard-cap to the fee such as 10% in order to not impact the ABI. \n\n**IAm0x52**\n\nSponsor has acknowledged this risk\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/62",
  "Code": [
    {
      "filename": "teller-protocol-v2/packages/contracts/contracts/MarketRegistry.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n// Contracts\nimport \"./EAS/TellerAS.sol\";\nimport \"./EAS/TellerASResolver.sol\";\n\n//must continue to use this so storage slots are not broken\nimport \"@openzeppelin/contracts/proxy/utils/Initializable.sol\";\nimport \"@openzeppelin/contracts/utils/Context.sol\";\n\n// Interfaces\nimport \"./interfaces/IMarketRegistry.sol\";\n\n// Libraries\nimport { EnumerableSet } from \"@openzeppelin/contracts/utils/structs/EnumerableSet.sol\";\nimport { PaymentType } from \"./libraries/V2Calculations.sol\";\n\ncontract MarketRegistry is\n    IMarketRegistry,\n    Initializable,\n    Context,\n    TellerASResolver\n{\n    using EnumerableSet for EnumerableSet.AddressSet;\n\n    /** Constant Variables **/\n\n    uint256 public constant CURRENT_CODE_VERSION = 8;\n\n    /* Storage Variables */\n\n    struct Marketplace {\n        address owner;\n        string metadataURI;\n        uint16 marketplaceFeePercent; // 10000 is 100%\n        bool lenderAttestationRequired;\n        EnumerableSet.AddressSet verifiedLendersForMarket;\n        mapping(address => bytes32) lenderAttestationIds;\n        uint32 paymentCycleDuration; // unix time (seconds)\n        uint32 paymentDefaultDuration; //unix time\n        uint32 bidExpirationTime; //unix time\n        bool borrowerAttestationRequired;\n        EnumerableSet.AddressSet verifiedBorrowersForMarket;\n        mapping(address => bytes32) borrowerAttestationIds;\n        address feeRecipient;\n        PaymentType paymentType;\n        PaymentCycleType paymentCycleType;\n    }\n\n    bytes32 public lenderAttestationSchemaId;\n\n    mapping(uint256 => Marketplace) internal markets;\n    mapping(bytes32 => uint256) internal __uriToId; //DEPRECATED\n    uint256 public marketCount;\n    bytes32 private _attestingSchemaId;\n    bytes32 public borrowerAttestationSchemaId;\n\n    uint256 public version;\n\n    mapping(uint256 => bool) private marketIsClosed;\n\n    TellerAS public tellerAS;\n\n    /* Modifiers */\n\n    modifier ownsMarket(uint256 _marketId) {\n        require(_getMarketOwner(_marketId) == _msgSender(), \"Not the owner\");\n        _;\n    }\n\n    modifier withAttestingSchema(bytes32 schemaId) {\n        _attestingSchemaId = schemaId;\n        _;\n        _attestingSchemaId = bytes32(0);\n    }\n\n    /* Events */\n\n    event MarketCreated(address indexed owner, uint256 marketId);\n    event SetMarketURI(uint256 marketId, string uri);\n    event SetPaymentCycleDuration(uint256 marketId, uint32 duration); // DEPRECATED - used for subgraph reference\n    event SetPaymentCycle(\n        uint256 marketId,\n        PaymentCycleType paymentCycleType,\n        uint32 value\n    );\n    event SetPaymentDefaultDuration(uint256 marketId, uint32 duration);\n    event SetBidExpirationTime(uint256 marketId, uint32 duration);\n    event SetMarketFee(uint256 marketId, uint16 feePct);\n    event LenderAttestation(uint256 marketId, address lender);\n    event BorrowerAttestation(uint256 marketId, address borrower);\n    event LenderRevocation(uint256 marketId, address lender);\n    event BorrowerRevocation(uint256 marketId, address borrower);\n    event MarketClosed(uint256 marketId);\n    event LenderExitMarket(uint256 marketId, address lender);\n    event BorrowerExitMarket(uint256 marketId, address borrower);\n    event SetMarketOwner(uint256 marketId, address newOwner);\n    event SetMarketFeeRecipient(uint256 marketId, address newRecipient);\n    event SetMarketLenderAttestation(uint256 marketId, bool required);\n    event SetMarketBorrowerAttestation(uint256 marketId, bool required);\n    event SetMarketPaymentType(uint256 marketId, PaymentType paymentType);\n\n    /* External Functions */\n\n    function initialize(TellerAS _tellerAS) external initializer {\n        tellerAS = _tellerAS;\n\n        lenderAttestationSchemaId = tellerAS.getASRegistry().register(\n            \"(uint256 marketId, address lenderAddress)\",\n            this\n        );\n        borrowerAttestationSchemaId = tellerAS.getASRegistry().register(\n            \"(uint256 marketId, address borrowerAddress)\",\n            this\n        );\n    }\n\n    /**\n     * @notice Creates a new market.\n     * @param _initialOwner Address who will initially own the market.\n     * @param _paymentCycleDuration Length of time in seconds before a bid's next payment is required to be made.\n     * @param _paymentDefaultDuration Length of time in seconds before a loan is considered in default for non-payment.\n     * @param _bidExpirationTime Length of time in seconds before pending bids expire.\n     * @param _requireLenderAttestation Boolean that indicates if lenders require attestation to join market.\n     * @param _requireBorrowerAttestation Boolean that indicates if borrowers require attestation to join market.\n     * @param _paymentType The payment type for loans in the market.\n     * @param _uri URI string to get metadata details about the market.\n     * @param _paymentCycleType The payment cycle type for loans in the market - Seconds or Monthly\n     * @return marketId_ The market ID of the newly created market.\n     */\n    function createMarket(\n        address _initialOwner,\n        uint32 _paymentCycleDuration,\n        uint32 _paymentDefaultDuration,\n        uint32 _bidExpirationTime,\n        uint16 _feePercent,\n        bool _requireLenderAttestation,\n        bool _requireBorrowerAttestation,\n        PaymentType _paymentType,\n        PaymentCycleType _paymentCycleType,\n        string calldata _uri\n    ) external returns (uint256 marketId_) {\n        marketId_ = _createMarket(\n            _initialOwner,\n            _paymentCycleDuration,\n            _paymentDefaultDuration,\n            _bidExpirationTime,\n            _feePercent,\n            _requireLenderAttestation,\n            _requireBorrowerAttestation,\n            _paymentType,\n            _paymentCycleType,\n            _uri\n        );\n    }\n\n    /**\n     * @notice Creates a new market.\n     * @dev Uses the default EMI payment type.\n     * @param _initialOwner Address who will initially own the market.\n     * @param _paymentCycleDuration Length of time in seconds before a bid's next payment is required to be made.\n     * @param _paymentDefaultDuration Length of time in seconds before a loan is considered in default for non-payment.\n     * @param _bidExpirationTime Length of time in seconds before pending bids expire.\n     * @param _requireLenderAttestation Boolean that indicates if lenders require attestation to join market.\n     * @param _requireBorrowerAttestation Boolean that indicates if borrowers require attestation to join market.\n     * @param _uri URI string to get metadata details about the market.\n     * @return marketId_ The market ID of the newly created market.\n     */\n    function createMarket(\n        address _initialOwner,\n        uint32 _paymentCycleDuration,\n        uint32 _paymentDefaultDuration,\n        uint32 _bidExpirationTime,\n        uint16 _feePercent,\n        bool _requireLenderAttestation,\n        bool _requireBorrowerAttestation,\n        string calldata _uri\n    ) external returns (uint256 marketId_) {\n        marketId_ = _createMarket(\n            _initialOwner,\n            _paymentCycleDuration,\n            _paymentDefaultDuration,\n            _bidExpirationTime,\n            _feePercent,\n            _requireLenderAttestation,\n            _requireBorrowerAttestation,\n            PaymentType.EMI,\n            PaymentCycleType.Seconds,\n            _uri\n        );\n    }\n\n    /**\n     * @notice Creates a new market.\n     * @param _initialOwner Address who will initially own the market.\n     * @param _paymentCycleDuration Length of time in seconds before a bid's next payment is required to be made.\n     * @param _paymentDefaultDuration Length of time in seconds before a loan is considered in default for non-payment.\n     * @param _bidExpirationTime Length of time in seconds before pending bids expire.\n     * @param _requireLenderAttestation Boolean that indicates if lenders require attestation to join market.\n     * @param _requireBorrowerAttestation Boolean that indicates if borrowers require attestation to join market.\n     * @param _paymentType The payment type for loans in the market.\n     * @param _uri URI string to get metadata details about the market.\n     * @param _paymentCycleType The payment cycle type for loans in the market - Seconds or Monthly\n     * @return marketId_ The market ID of the newly created market.\n     */\n    function _createMarket(\n        address _initialOwner,\n        uint32 _paymentCycleDuration,\n        uint32 _paymentDefaultDuration,\n        uint32 _bidExpirationTime,\n        uint16 _feePercent,\n        bool _requireLenderAttestation,\n        bool _requireBorrowerAttestation,\n        PaymentType _paymentType,\n        PaymentCycleType _paymentCycleType,\n        string calldata _uri\n    ) internal returns (uint256 marketId_) {\n        require(_initialOwner != address(0), \"Invalid owner address\");\n        // Increment market ID counter\n        marketId_ = ++marketCount;\n\n        // Set the market owner\n        markets[marketId_].owner = _initialOwner;\n\n        // Initialize market settings\n        _setMarketSettings(\n            marketId_,\n            _paymentCycleDuration,\n            _paymentType,\n            _paymentCycleType,\n            _paymentDefaultDuration,\n            _bidExpirationTime,\n            _feePercent,\n            _requireBorrowerAttestation,\n            _requireLenderAttestation,\n            _uri\n        );\n\n        emit MarketCreated(_initialOwner, marketId_);\n    }\n\n    /**\n     * @notice Closes a market so new bids cannot be added.\n     * @param _marketId The market ID for the market to close.\n     */\n\n    function closeMarket(uint256 _marketId) public ownsMarket(_marketId) {\n        if (!marketIsClosed[_marketId]) {\n            marketIsClosed[_marketId] = true;\n\n            emit MarketClosed(_marketId);\n        }\n    }\n\n    /**\n     * @notice Returns the status of a market being open or closed for new bids.\n     * @param _marketId The market ID for the market to check.\n     */\n    function isMarketClosed(uint256 _marketId)\n        public\n        view\n        override\n        returns (bool)\n    {\n        return marketIsClosed[_marketId];\n    }\n\n    /**\n     * @notice Adds a lender to a market.\n     * @dev See {_attestStakeholder}.\n     */\n    function attestLender(\n        uint256 _marketId,\n        address _lenderAddress,\n        uint256 _expirationTime\n    ) external {\n        _attestStakeholder(_marketId, _lenderAddress, _expirationTime, true);\n    }\n\n    /**\n     * @notice Adds a lender to a market via delegated attestation.\n     * @dev See {_attestStakeholderViaDelegation}.\n     */\n    function attestLender(\n        uint256 _marketId,\n        address _lenderAddress,\n        uint256 _expirationTime,\n        uint8 _v,\n        bytes32 _r,\n        bytes32 _s\n    ) external {\n        _attestStakeholderViaDelegation(\n            _marketId,\n            _lenderAddress,\n            _expirationTime,\n            true,\n            _v,\n            _r,\n            _s\n        );\n    }\n\n    /**\n     * @notice Removes a lender from an market.\n     * @dev See {_revokeStakeholder}.\n     */\n    function revokeLender(uint256 _marketId, address _lenderAddress) external {\n        _revokeStakeholder(_marketId, _lenderAddress, true);\n    }\n\n    /**\n     * @notice Removes a borrower from a market via delegated revocation.\n     * @dev See {_revokeStakeholderViaDelegation}.\n     */\n    function revokeLender(\n        uint256 _marketId,\n        address _lenderAddress,\n        uint8 _v,\n        bytes32 _r,\n        bytes32 _s\n    ) external {\n        _revokeStakeholderViaDelegation(\n            _marketId,\n            _lenderAddress,\n            true,\n            _v,\n            _r,\n            _s\n        );\n    }\n\n    /**\n     * @notice Allows a lender to voluntarily leave a market.\n     * @param _marketId The market ID to leave.\n     */\n    function lenderExitMarket(uint256 _marketId) external {\n        // Remove lender address from market set\n        bool response = markets[_marketId].verifiedLendersForMarket.remove(\n            _msgSender()\n        );\n        if (response) {\n            emit LenderExitMarket(_marketId, _msgSender());\n        }\n    }\n\n    /**\n     * @notice Adds a borrower to a market.\n     * @dev See {_attestStakeholder}.\n     */\n    function attestBorrower(\n        uint256 _marketId,\n        address _borrowerAddress,\n        uint256 _expirationTime\n    ) external {\n        _attestStakeholder(_marketId, _borrowerAddress, _expirationTime, false);\n    }\n\n    /**\n     * @notice Adds a borrower to a market via delegated attestation.\n     * @dev See {_attestStakeholderViaDelegation}.\n     */\n    function attestBorrower(\n        uint256 _marketId,\n        address _borrowerAddress,\n        uint256 _expirationTime,\n        uint8 _v,\n        bytes32 _r,\n        bytes32 _s\n    ) external {\n        _attestStakeholderViaDelegation(\n            _marketId,\n            _borrowerAddress,\n            _expirationTime,\n            false,\n            _v,\n            _r,\n            _s\n        );\n    }\n\n    /**\n     * @notice Removes a borrower from an market.\n     * @dev See {_revokeStakeholder}.\n     */\n    function revokeBorrower(uint256 _marketId, address _borrowerAddress)\n        external\n    {\n        _revokeStakeholder(_marketId, _borrowerAddress, false);\n    }\n\n    /**\n     * @notice Removes a borrower from a market via delegated revocation.\n     * @dev See {_revokeStakeholderViaDelegation}.\n     */\n    function revokeBorrower(\n        uint256 _marketId,\n        address _borrowerAddress,\n        uint8 _v,\n        bytes32 _r,\n        bytes32 _s\n    ) external {\n        _revokeStakeholderViaDelegation(\n            _marketId,\n            _borrowerAddress,\n            false,\n            _v,\n            _r,\n            _s\n        );\n    }\n\n    /**\n     * @notice Allows a borrower to voluntarily leave a market.\n     * @param _marketId The market ID to leave.\n     */\n    function borrowerExitMarket(uint256 _marketId) external {\n        // Remove borrower address from market set\n        bool response = markets[_marketId].verifiedBorrowersForMarket.remove(\n            _msgSender()\n        );\n        if (response) {\n            emit BorrowerExitMarket(_marketId, _msgSender());\n        }\n    }\n\n    /**\n     * @notice Verifies an attestation is valid.\n     * @dev This function must only be called by the `attestLender` function above.\n     * @param recipient Lender's address who is being attested.\n     * @param schema The schema used for the attestation.\n     * @param data Data the must include the market ID and lender's address\n     * @param\n     * @param attestor Market owner's address who signed the attestation.\n     * @return Boolean indicating the attestation was successful.\n     */\n    function resolve(\n        address recipient,\n        bytes calldata schema,\n        bytes calldata data,\n        uint256 /* expirationTime */,\n        address attestor\n    ) external payable override returns (bool) {\n        bytes32 attestationSchemaId = keccak256(\n            abi.encodePacked(schema, address(this))\n        );\n        (uint256 marketId, address lenderAddress) = abi.decode(\n            data,\n            (uint256, address)\n        );\n        return\n            (_attestingSchemaId == attestationSchemaId &&\n                recipient == lenderAddress &&\n                attestor == _getMarketOwner(marketId)) ||\n            attestor == address(this);\n    }\n\n    /**\n     * @notice Transfers ownership of a marketplace.\n     * @param _marketId The ID of a market.\n     * @param _newOwner Address of the new market owner.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function transferMarketOwnership(uint256 _marketId, address _newOwner)\n        public\n        ownsMarket(_marketId)\n    {\n        markets[_marketId].owner = _newOwner;\n        emit SetMarketOwner(_marketId, _newOwner);\n    }\n\n    /**\n     * @notice Updates multiple market settings for a given market.\n     * @param _marketId The ID of a market.\n     * @param _paymentCycleDuration Delinquency duration for new loans\n     * @param _newPaymentType The payment type for the market.\n     * @param _paymentCycleType The payment cycle type for loans in the market - Seconds or Monthly\n     * @param _paymentDefaultDuration Default duration for new loans\n     * @param _bidExpirationTime Duration of time before a bid is considered out of date\n     * @param _metadataURI A URI that points to a market's metadata.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function updateMarketSettings(\n        uint256 _marketId,\n        uint32 _paymentCycleDuration,\n        PaymentType _newPaymentType,\n        PaymentCycleType _paymentCycleType,\n        uint32 _paymentDefaultDuration,\n        uint32 _bidExpirationTime,\n        uint16 _feePercent,\n        bool _borrowerAttestationRequired,\n        bool _lenderAttestationRequired,\n        string calldata _metadataURI\n    ) public ownsMarket(_marketId) {\n        _setMarketSettings(\n            _marketId,\n            _paymentCycleDuration,\n            _newPaymentType,\n            _paymentCycleType,\n            _paymentDefaultDuration,\n            _bidExpirationTime,\n            _feePercent,\n            _borrowerAttestationRequired,\n            _lenderAttestationRequired,\n            _metadataURI\n        );\n    }\n\n    /**\n     * @notice Sets the fee recipient address for a market.\n     * @param _marketId The ID of a market.\n     * @param _recipient Address of the new fee recipient.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function setMarketFeeRecipient(uint256 _marketId, address _recipient)\n        public\n        ownsMarket(_marketId)\n    {\n        markets[_marketId].feeRecipient = _recipient;\n        emit SetMarketFeeRecipient(_marketId, _recipient);\n    }\n\n    /**\n     * @notice Sets the metadata URI for a market.\n     * @param _marketId The ID of a market.\n     * @param _uri A URI that points to a market's metadata.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function setMarketURI(uint256 _marketId, string calldata _uri)\n        public\n        ownsMarket(_marketId)\n    {\n        //We do string comparison by checking the hashes of the strings against one another\n        if (\n            keccak256(abi.encodePacked(_uri)) !=\n            keccak256(abi.encodePacked(markets[_marketId].metadataURI))\n        ) {\n            markets[_marketId].metadataURI = _uri;\n\n            emit SetMarketURI(_marketId, _uri);\n        }\n    }\n\n    /**\n     * @notice Sets the duration of new loans for this market before they turn delinquent.\n     * @notice Changing this value does not change the terms of existing loans for this market.\n     * @param _marketId The ID of a market.\n     * @param _paymentCycleType Cycle type (seconds or monthly)\n     * @param _duration Delinquency duration for new loans\n     */\n    function setPaymentCycle(\n        uint256 _marketId,\n        PaymentCycleType _paymentCycleType,\n        uint32 _duration\n    ) public ownsMarket(_marketId) {\n        require(\n            (_paymentCycleType == PaymentCycleType.Seconds) ||\n                (_paymentCycleType == PaymentCycleType.Monthly &&\n                    _duration == 0),\n            \"monthly payment cycle duration cannot be set\"\n        );\n        Marketplace storage market = markets[_marketId];\n        uint32 duration = _paymentCycleType == PaymentCycleType.Seconds\n            ? _duration\n            : 30 days;\n        if (\n            _paymentCycleType != market.paymentCycleType ||\n            duration != market.paymentCycleDuration\n        ) {\n            markets[_marketId].paymentCycleType = _paymentCycleType;\n            markets[_marketId].paymentCycleDuration = duration;\n\n            emit SetPaymentCycle(_marketId, _paymentCycleType, duration);\n        }\n    }\n\n    /**\n     * @notice Sets the duration of new loans for this market before they turn defaulted.\n     * @notice Changing this value does not change the terms of existing loans for this market.\n     * @param _marketId The ID of a market.\n     * @param _duration Default duration for new loans\n     */\n    function setPaymentDefaultDuration(uint256 _marketId, uint32 _duration)\n        public\n        ownsMarket(_marketId)\n    {\n        if (_duration != markets[_marketId].paymentDefaultDuration) {\n            markets[_marketId].paymentDefaultDuration = _duration;\n\n            emit SetPaymentDefaultDuration(_marketId, _duration);\n        }\n    }\n\n    function setBidExpirationTime(uint256 _marketId, uint32 _duration)\n        public\n        ownsMarket(_marketId)\n    {\n        if (_duration != markets[_marketId].bidExpirationTime) {\n            markets[_marketId].bidExpirationTime = _duration;\n\n            emit SetBidExpirationTime(_marketId, _duration);\n        }\n    }\n\n    /**\n     * @notice Sets the fee for the market.\n     * @param _marketId The ID of a market.\n     * @param _newPercent The percentage fee in basis points.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function setMarketFeePercent(uint256 _marketId, uint16 _newPercent)\n        public\n        ownsMarket(_marketId)\n    {\n        require(_newPercent >= 0 && _newPercent <= 10000, \"invalid percent\");\n        if (_newPercent != markets[_marketId].marketplaceFeePercent) {\n            markets[_marketId].marketplaceFeePercent = _newPercent;\n            emit SetMarketFee(_marketId, _newPercent);\n        }\n    }\n\n    /**\n     * @notice Set the payment type for the market.\n     * @param _marketId The ID of the market.\n     * @param _newPaymentType The payment type for the market.\n     */\n    function setMarketPaymentType(\n        uint256 _marketId,\n        PaymentType _newPaymentType\n    ) public ownsMarket(_marketId) {\n        if (_newPaymentType != markets[_marketId].paymentType) {\n            markets[_marketId].paymentType = _newPaymentType;\n            emit SetMarketPaymentType(_marketId, _newPaymentType);\n        }\n    }\n\n    /**\n     * @notice Enable/disables market whitelist for lenders.\n     * @param _marketId The ID of a market.\n     * @param _required Boolean indicating if the market requires whitelist.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function setLenderAttestationRequired(uint256 _marketId, bool _required)\n        public\n        ownsMarket(_marketId)\n    {\n        if (_required != markets[_marketId].lenderAttestationRequired) {\n            markets[_marketId].lenderAttestationRequired = _required;\n            emit SetMarketLenderAttestation(_marketId, _required);\n        }\n    }\n\n    /**\n     * @notice Enable/disables market whitelist for borrowers.\n     * @param _marketId The ID of a market.\n     * @param _required Boolean indicating if the market requires whitelist.\n     *\n     * Requirements:\n     * - The caller must be the current owner.\n     */\n    function setBorrowerAttestationRequired(uint256 _marketId, bool _required)\n        public\n        ownsMarket(_marketId)\n    {\n        if (_required != markets[_marketId].borrowerAttestationRequired) {\n            markets[_marketId].borrowerAttestationRequired = _required;\n            emit SetMarketBorrowerAttestation(_marketId, _required);\n        }\n    }\n\n    /**\n     * @notice Gets the data associated with a market.\n     * @param _marketId The ID of a market.\n     */\n    function getMarketData(uint256 _marketId)\n        public\n        view\n        returns (\n            address owner,\n            uint32 paymentCycleDuration,\n            uint32 paymentDefaultDuration,\n            uint32 loanExpirationTime,\n            string memory metadataURI,\n            uint16 marketplaceFeePercent,\n            bool lenderAttestationRequired\n        )\n    {\n        return (\n            markets[_marketId].owner,\n            markets[_marketId].paymentCycleDuration,\n            markets[_marketId].paymentDefaultDuration,\n            markets[_marketId].bidExpirationTime,\n            markets[_marketId].metadataURI,\n            markets[_marketId].marketplaceFeePercent,\n            markets[_marketId].lenderAttestationRequired\n        );\n    }\n\n    /**\n     * @notice Gets the attestation requirements for a given market.\n     * @param _marketId The ID of the market.\n     */\n    function getMarketAttestationRequirements(uint256 _marketId)\n        public\n        view\n        returns (\n            bool lenderAttestationRequired,\n            bool borrowerAttestationRequired\n        )\n    {\n        return (\n            markets[_marketId].lenderAttestationRequired,\n            markets[_marketId].borrowerAttestationRequired\n        );\n    }\n\n    /**\n     * @notice Gets the address of a market's owner.\n     * @param _marketId The ID of a market.\n     * @return The address of a market's owner.\n     */\n    function getMarketOwner(uint256 _marketId)\n        public\n        view\n        virtual\n        override\n        returns (address)\n    {\n        return _getMarketOwner(_marketId);\n    }\n\n    /**\n     * @notice Gets the address of a market's owner.\n     * @param _marketId The ID of a market.\n     * @return The address of a market's owner.\n     */\n    function _getMarketOwner(uint256 _marketId)\n        internal\n        view\n        virtual\n        returns (address)\n    {\n        return markets[_marketId].owner;\n    }\n\n    /**\n     * @notice Gets the fee recipient of a market.\n     * @param _marketId The ID of a market.\n     * @return The address of a market's fee recipient.\n     */\n    function getMarketFeeRecipient(uint256 _marketId)\n        public\n        view\n        override\n        returns (address)\n    {\n        address recipient = markets[_marketId].feeRecipient;\n\n        if (recipient == address(0)) {\n            return _getMarketOwner(_marketId);\n        }\n\n        return recipient;\n    }\n\n    /**\n     * @notice Gets the metadata URI of a market.\n     * @param _marketId The ID of a market.\n     * @return URI of a market's metadata.\n     */\n    function getMarketURI(uint256 _marketId)\n        public\n        view\n        override\n        returns (string memory)\n    {\n        return markets[_marketId].metadataURI;\n    }\n\n    /**\n     * @notice Gets the loan delinquent duration of a market.\n     * @param _marketId The ID of a market.\n     * @return Duration of a loan until it is delinquent.\n     * @return The type of payment cycle for loans in the market.\n     */\n    function getPaymentCycle(uint256 _marketId)\n        public\n        view\n        override\n        returns (uint32, PaymentCycleType)\n    {\n        return (\n            markets[_marketId].paymentCycleDuration,\n            markets[_marketId].paymentCycleType\n        );\n    }\n\n    /**\n     * @notice Gets the loan default duration of a market.\n     * @param _marketId The ID of a market.\n     * @return Duration of a loan repayment interval until it is default.\n     */\n    function getPaymentDefaultDuration(uint256 _marketId)\n        public\n        view\n        override\n        returns (uint32)\n    {\n        return markets[_marketId].paymentDefaultDuration;\n    }\n\n    /**\n     * @notice Get the payment type of a market.\n     * @param _marketId the ID of the market.\n     * @return The type of payment for loans in the market.\n     */\n    function getPaymentType(uint256 _marketId)\n        public\n        view\n        override\n        returns (PaymentType)\n    {\n        return markets[_marketId].paymentType;\n    }\n\n    function getBidExpirationTime(uint256 marketId)\n        public\n        view\n        override\n        returns (uint32)\n    {\n        return markets[marketId].bidExpirationTime;\n    }\n\n    /**\n     * @notice Gets the marketplace fee in basis points\n     * @param _marketId The ID of a market.\n     * @return fee in basis points\n     */\n    function getMarketplaceFee(uint256 _marketId)\n        public\n        view\n        override\n        returns (uint16 fee)\n    {\n        return markets[_marketId].marketplaceFeePercent;\n    }\n\n    /**\n     * @notice Checks if a lender has been attested and added to a market.\n     * @param _marketId The ID of a market.\n     * @param _lenderAddress Address to check.\n     * @return isVerified_ Boolean indicating if a lender has been added to a market.\n     * @return uuid_ Bytes32 representing the UUID of the lender.\n     */\n    function isVerifiedLender(uint256 _marketId, address _lenderAddress)\n        public\n        view\n        override\n        returns (bool isVerified_, bytes32 uuid_)\n    {\n        return\n            _isVerified(\n                _lenderAddress,\n                markets[_marketId].lenderAttestationRequired,\n                markets[_marketId].lenderAttestationIds,\n                markets[_marketId].verifiedLendersForMarket\n            );\n    }\n\n    /**\n     * @notice Checks if a borrower has been attested and added to a market.\n     * @param _marketId The ID of a market.\n     * @param _borrowerAddress Address of the borrower to check.\n     * @return isVerified_ Boolean indicating if a borrower has been added to a market.\n     * @return uuid_ Bytes32 representing the UUID of the borrower.\n     */\n    function isVerifiedBorrower(uint256 _marketId, address _borrowerAddress)\n        public\n        view\n        override\n        returns (bool isVerified_, bytes32 uuid_)\n    {\n        return\n            _isVerified(\n                _borrowerAddress,\n                markets[_marketId].borrowerAttestationRequired,\n                markets[_marketId].borrowerAttestationIds,\n                markets[_marketId].verifiedBorrowersForMarket\n            );\n    }\n\n    /**\n     * @notice Gets addresses of all attested lenders.\n     * @param _marketId The ID of a market.\n     * @param _page Page index to start from.\n     * @param _perPage Number of items in a page to return.\n     * @return Array of addresses that have been added to a market.\n     */\n    function getAllVerifiedLendersForMarket(\n        uint256 _marketId,\n        uint256 _page,\n        uint256 _perPage\n    ) public view returns (address[] memory) {\n        EnumerableSet.AddressSet storage set = markets[_marketId]\n            .verifiedLendersForMarket;\n\n        return _getStakeholdersForMarket(set, _page, _perPage);\n    }\n\n    /**\n     * @notice Gets addresses of all attested borrowers.\n     * @param _marketId The ID of the market.\n     * @param _page Page index to start from.\n     * @param _perPage Number of items in a page to return.\n     * @return Array of addresses that have been added to a market.\n     */\n    function getAllVerifiedBorrowersForMarket(\n        uint256 _marketId,\n        uint256 _page,\n        uint256 _perPage\n    ) public view returns (address[] memory) {\n        EnumerableSet.AddressSet storage set = markets[_marketId]\n            .verifiedBorrowersForMarket;\n        return _getStakeholdersForMarket(set, _page, _perPage);\n    }\n\n    /**\n     * @notice Sets multiple market settings for a given market.\n     * @param _marketId The ID of a market.\n     * @param _paymentCycleDuration Delinquency duration for new loans\n     * @param _newPaymentType The payment type for the market.\n     * @param _paymentCycleType The payment cycle type for loans in the market - Seconds or Monthly\n     * @param _paymentDefaultDuration Default duration for new loans\n     * @param _bidExpirationTime Duration of time before a bid is considered out of date\n     * @param _metadataURI A URI that points to a market's metadata.\n     */\n    function _setMarketSettings(\n        uint256 _marketId,\n        uint32 _paymentCycleDuration,\n        PaymentType _newPaymentType,\n        PaymentCycleType _paymentCycleType,\n        uint32 _paymentDefaultDuration,\n        uint32 _bidExpirationTime,\n        uint16 _feePercent,\n        bool _borrowerAttestationRequired,\n        bool _lenderAttestationRequired,\n        string calldata _metadataURI\n    ) internal {\n        setMarketURI(_marketId, _metadataURI);\n        setPaymentDefaultDuration(_marketId, _paymentDefaultDuration);\n        setBidExpirationTime(_marketId, _bidExpirationTime);\n        setMarketFeePercent(_marketId, _feePercent);\n        setLenderAttestationRequired(_marketId, _lenderAttestationRequired);\n        setBorrowerAttestationRequired(_marketId, _borrowerAttestationRequired);\n        setMarketPaymentType(_marketId, _newPaymentType);\n        setPaymentCycle(_marketId, _paymentCycleType, _paymentCycleDuration);\n    }\n\n    /**\n     * @notice Gets addresses of all attested relevant stakeholders.\n     * @param _set The stored set of stakeholders to index from.\n     * @param _page Page index to start from.\n     * @param _perPage"
    }
  ]
}