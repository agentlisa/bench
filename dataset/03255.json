{
  "Title": "The function can be decomposed",
  "Content": "##### Description\nAt the line\nhttps://github.com/lidofinance/anchor-collateral-steth/blob/8d52ce72cb42d48dff1851222e3b624c941ddb30/contracts/RewardsLiquidator.vy#L262-L357\n`liquidate()` function can be decomposed to three internal functions.\n##### Recommendation\nIt is recommended to make three separate internal functions instead of one long function.",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/RewardsLiquidator.vy",
      "content": "# @version 0.3.0\n# @author skozin <info@lido.fi>\n# @licence MIT\nfrom vyper.interfaces import ERC20\n\n\ninterface ERC20Decimals:\n    def decimals() -> uint256: view\n\ninterface ChainlinkAggregatorV3Interface:\n    def decimals() -> uint256: view\n    # (roundId: uint80, answer: int256, startedAt: uint256, updatedAt: uint256, answeredInRound: uint80)\n    def latestRoundData() -> (uint256, int256, uint256, uint256, uint256): view\n\ninterface CurvePool:\n    def exchange(i: int128, j: int128, dx: uint256, min_dy: uint256) -> uint256: payable\n\ninterface CurveMetaPool:\n    def exchange_underlying(i: int128, j: int128, dx: uint256, min_dy: uint256) -> uint256: nonpayable\n\n\nevent SoldStethToUST:\n    steth_amount: uint256\n    eth_amount: uint256\n    usdc_amount: uint256\n    ust_amount: uint256\n    steth_eth_price: uint256\n    eth_usdc_price: uint256\n    usdc_ust_price: uint256\n\nevent AdminChanged:\n    new_admin: address\n\nevent PriceDifferenceChanged:\n    max_steth_eth_price_difference_percent: uint256\n    max_eth_usdc_price_difference_percent: uint256\n    max_usdc_ust_price_difference_percent: uint256\n    max_steth_ust_price_difference_percent: uint256\n\nevent UniswapUSDCPoolFeeChanged:\n    fee: uint256\n\n\nUST_TOKEN: constant(address) = 0xa47c8bf37f92aBed4A126BDA807A7b7498661acD\nUST_TOKEN_DECIMALS: constant(uint256) = 18\nUSDC_TOKEN: constant(address) = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48\nUSDC_TOKEN_DECIMALS: constant(uint256) = 6\nSTETH_TOKEN: constant(address) = 0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84\nSTETH_TOKEN_DECIMALS: constant(uint256) = 18\nWETH_TOKEN: constant(address) = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2\nWETH_TOKEN_DECIMALS: constant(uint256) = 18\n\nCHAINLINK_STETH_ETH_FEED: constant(address) = 0x86392dC19c0b719886221c78AB11eb8Cf5c52812\nCHAINLINK_UST_ETH_FEED: constant(address) = 0xa20623070413d42a5C01Db2c8111640DD7A5A03a\nCHAINLINK_USDC_ETH_FEED: constant(address) = 0x986b5E1e1755e3C2440e960477f25201B0a8bbD4\n\nCURVE_STETH_POOL: constant(address) = 0xDC24316b9AE028F1497c275EB9192a3Ea0f67022\nCURVE_UST_POOL: constant(address) = 0x890f4e345B1dAED0367A877a1612f86A1f86985f\nUNISWAP_ROUTER_V3: constant(address) = 0xE592427A0AEce92De3Edee1F18E0157C05861564\n\nCURVE_ETH_INDEX: constant(uint256) = 0\nCURVE_STETH_INDEX: constant(uint256) = 1\nCURVE_USDC_UNDERLYING_INDEX: constant(uint256) = 2\nCURVE_UST_UNDERLYING_INDEX: constant(uint256) = 0\n\n# An address that is allowed to configure the liquidator settings.\nadmin: public(address)\n\n# An address that is allowed to sell.\nvault: public(address)\n\n# Maximum difference (in percents multiplied by 10**18) between the resulting\n# stETH/ETH price and the stETH/ETH anchor price obtained from the feed.\nmax_steth_eth_price_difference_percent: public(uint256)\n\n# Maximum difference (in percents multiplied by 10**18) between the resulting\n# ETH/USDC price and the ETH/USDC anchor price obtained from the feed.\nmax_eth_usdc_price_difference_percent: public(uint256)\n\n# Maximum difference (in percents multiplied by 10**18) between the resulting\n# USDC/UST price and the USDC/USD anchor price obtained from the feed.\nmax_usdc_ust_price_difference_percent: public(uint256)\n\n# Maximum difference (in percents multiplied by 10**18) between the resulting\n# stETH/UST price and the stETH/USD anchor price obtained from the feed.\nmax_steth_ust_price_difference_percent: public(uint256)\n\n# Uniswap pool fee (required for pool selection)\nuniswap_usdc_pool_fee: public(uint256)\n\n\n@external\ndef __init__(\n    vault: address,\n    admin: address,\n    max_steth_eth_price_difference_percent: uint256,\n    max_eth_usdc_price_difference_percent: uint256,\n    max_usdc_ust_price_difference_percent: uint256,\n    max_steth_ust_price_difference_percent: uint256\n):\n    assert ERC20Decimals(USDC_TOKEN).decimals() == USDC_TOKEN_DECIMALS\n    assert ERC20Decimals(UST_TOKEN).decimals() == UST_TOKEN_DECIMALS\n    assert ERC20Decimals(STETH_TOKEN).decimals() == STETH_TOKEN_DECIMALS\n\n    self.vault = vault\n    self.admin = admin\n    log AdminChanged(self.admin)\n\n    self.uniswap_usdc_pool_fee = 3000 # initially we use a pool with a commission of 0.3%\n\n    log UniswapUSDCPoolFeeChanged(self.uniswap_usdc_pool_fee)\n\n    assert max_steth_eth_price_difference_percent <= 10**18, \"invalid percentage\"\n    assert max_eth_usdc_price_difference_percent <= 10**18, \"invalid percentage\"\n    assert max_usdc_ust_price_difference_percent <= 10**18, \"invalid percentage\"\n    assert max_steth_ust_price_difference_percent <= 10**18, \"invalid percentage\"\n\n    self.max_steth_eth_price_difference_percent = max_steth_eth_price_difference_percent\n    self.max_eth_usdc_price_difference_percent = max_eth_usdc_price_difference_percent\n    self.max_usdc_ust_price_difference_percent = max_usdc_ust_price_difference_percent\n    self.max_steth_ust_price_difference_percent = max_steth_ust_price_difference_percent\n\n    log PriceDifferenceChanged(\n        self.max_steth_eth_price_difference_percent, \n        self.max_eth_usdc_price_difference_percent,\n        self.max_usdc_ust_price_difference_percent,\n        self.max_steth_ust_price_difference_percent\n    )\n\n\n@external\n@payable\ndef __default__():\n    pass\n\n\n@external\ndef change_admin(new_admin: address):\n    assert msg.sender == self.admin, \"unauthorized\"\n    self.admin = new_admin\n    log AdminChanged(self.admin)\n\n\n@external\ndef set_uniswap_usdc_pool_fee(\n    fee: uint256\n):\n    assert msg.sender == self.admin, \"unauthorized\"\n    assert fee > 0, \"invalid uniswap_usdc_pool_fee\"\n\n    self.uniswap_usdc_pool_fee = fee\n\n    log UniswapUSDCPoolFeeChanged(self.uniswap_usdc_pool_fee)\n\n\n@external\ndef configure(\n    max_steth_eth_price_difference_percent: uint256,\n    max_eth_usdc_price_difference_percent: uint256,\n    max_usdc_ust_price_difference_percent: uint256,\n    max_steth_ust_price_difference_percent: uint256\n):\n    assert msg.sender == self.admin, \"unauthorized\"\n    assert max_steth_eth_price_difference_percent <= 10**18, \"invalid percentage\"\n    assert max_eth_usdc_price_difference_percent <= 10**18, \"invalid percentage\"\n    assert max_usdc_ust_price_difference_percent <= 10**18, \"invalid percentage\"\n    assert max_steth_ust_price_difference_percent <= 10**18, \"invalid percentage\"\n\n    self.max_steth_eth_price_difference_percent = max_steth_eth_price_difference_percent\n    self.max_eth_usdc_price_difference_percent = max_eth_usdc_price_difference_percent\n    self.max_usdc_ust_price_difference_percent = max_usdc_ust_price_difference_percent\n    self.max_steth_ust_price_difference_percent = max_steth_ust_price_difference_percent\n\n    log PriceDifferenceChanged(\n        self.max_steth_eth_price_difference_percent, \n        self.max_eth_usdc_price_difference_percent,\n        self.max_usdc_ust_price_difference_percent,\n        self.max_steth_ust_price_difference_percent\n    )\n\n\n@internal\n@view\ndef _get_chainlink_price(chainlink_price_feed: address) -> uint256:\n    price_decimals: uint256 = ChainlinkAggregatorV3Interface(chainlink_price_feed).decimals()\n    assert 0 < price_decimals and price_decimals <= 18\n\n    round_id: uint256 = 0\n    answer: int256 = 0\n    started_at: uint256 = 0\n    updated_at: uint256 = 0\n    answered_in_round: uint256 = 0\n\n    (round_id, answer, started_at, updated_at, answered_in_round) = \\\n        ChainlinkAggregatorV3Interface(chainlink_price_feed).latestRoundData()\n\n    assert updated_at != 0\n    # forced conversion to 18 decimal places\n    return convert(answer, uint256) * (10 ** (18 - price_decimals))\n\n\n@internal\n@view\ndef _get_inverse_rate(price: uint256) -> uint256:\n    return  (10 ** 36) / price  \n\n\n@internal\n@view\ndef _get_chainlink_cross_price(priceA: uint256, priceB: uint256) -> uint256:\n    return (priceA * priceB) / (10 ** 18)\n    \n\n@internal\ndef _uniswap_v3_sell_eth_to_usdc(\n    eth_amount_in: uint256,\n    usdc_amount_out_min: uint256,\n    usdc_recipient: address\n) -> uint256:\n\n    result: Bytes[32] = raw_call(\n        UNISWAP_ROUTER_V3,\n        concat(\n            method_id(\"exactInputSingle((address,address,uint24,address,uint256,uint256,uint256,uint160))\"),\n            convert(WETH_TOKEN, bytes32),\n            convert(USDC_TOKEN, bytes32),\n            convert(self.uniswap_usdc_pool_fee, bytes32), #pool fee\n            convert(usdc_recipient, bytes32), #recipient\n            convert(block.timestamp, bytes32), #deadline\n            convert(eth_amount_in, bytes32),\n            convert(usdc_amount_out_min, bytes32),\n            convert(0, bytes32), #sqrtPriceLimitX96\n        ),\n        value=eth_amount_in,\n        max_outsize=32\n    )\n    return convert(result, uint256)\n\n\n@internal\n@pure\ndef _get_min_amount_out(\n    amount: uint256,\n    price: uint256,\n    max_diff_percent: uint256,\n    decimal_token_in: uint256,\n    decimal_token_out: uint256\n) -> uint256:\n    # = (amount * (10 ** (18 - decimal_token_in)) * price) / 10 ** 18\n    amount_out: uint256 = (amount * price) / (10 ** decimal_token_in)\n\n    min_mult: uint256 = 10**18 - max_diff_percent\n\n    # = ((amount_out * min_mult) / 10**18) / (10 ** (18 - decimal_token_out))\n    return (amount_out * min_mult) / (10 ** (36 - decimal_token_out))\n\n\n# 1) stETH -> ETH (Curve)\n# 2) ETH -> USDC (Uniswap v3)\n# 3) USDC -> UST (Curve)\n@external\ndef liquidate(ust_recipient: address) -> uint256:\n    assert msg.sender == self.vault, \"unauthorized\"\n\n    steth_amount: uint256 = ERC20(STETH_TOKEN).balanceOf(self)\n    assert steth_amount > 0, \"zero stETH balance\"\n\n    # steth -> eth\n    steth_eth_price: uint256 = self._get_chainlink_price(CHAINLINK_STETH_ETH_FEED)\n    min_eth_amount: uint256 = self._get_min_amount_out(\n        steth_amount,\n        steth_eth_price,\n        self.max_steth_eth_price_difference_percent,\n        STETH_TOKEN_DECIMALS,\n        WETH_TOKEN_DECIMALS\n    )\n\n    ERC20(STETH_TOKEN).approve(CURVE_STETH_POOL, steth_amount)\n\n    CurvePool(CURVE_STETH_POOL).exchange(\n        CURVE_STETH_INDEX,\n        CURVE_ETH_INDEX,\n        steth_amount,\n        0 # do not require a minimum amount\n    )\n    eth_amount: uint256 = self.balance\n\n    assert eth_amount >= min_eth_amount, \"insuff. ETH return\"\n\n    # eth -> usdc\n    usdc_eth_price: uint256 = self._get_chainlink_price(CHAINLINK_USDC_ETH_FEED)\n    eth_usdc_price: uint256 = self._get_inverse_rate(usdc_eth_price)\n    min_usdc_amount: uint256 = self._get_min_amount_out(\n        eth_amount,\n        eth_usdc_price,\n        self.max_eth_usdc_price_difference_percent,\n        WETH_TOKEN_DECIMALS,\n        USDC_TOKEN_DECIMALS\n    )\n\n    self._uniswap_v3_sell_eth_to_usdc(\n        eth_amount,\n        0, # do not require a minimum amount\n        self\n    )\n    usdc_amount: uint256 = ERC20(USDC_TOKEN).balanceOf(self)\n\n    assert usdc_amount >= min_usdc_amount, \"insuff. USDC return\"\n\n    # usdc -> ust\n    eth_ust_price: uint256 = self._get_inverse_rate(self._get_chainlink_price(CHAINLINK_UST_ETH_FEED))\n    usdc_ust_price: uint256 = self._get_chainlink_cross_price(usdc_eth_price, eth_ust_price)\n    min_ust_amount: uint256 = self._get_min_amount_out(\n        usdc_amount,\n        usdc_ust_price,\n        self.max_usdc_ust_price_difference_percent,\n        USDC_TOKEN_DECIMALS,\n        UST_TOKEN_DECIMALS\n    )\n\n    ERC20(USDC_TOKEN).approve(CURVE_UST_POOL, usdc_amount)\n\n    CurveMetaPool(CURVE_UST_POOL).exchange_underlying(\n        CURVE_USDC_UNDERLYING_INDEX,\n        CURVE_UST_UNDERLYING_INDEX,\n        usdc_amount,\n        0 # do not require a minimum amount\n    )\n    ust_amount: uint256 = ERC20(UST_TOKEN).balanceOf(self)\n\n    assert ust_amount >= min_ust_amount, \"insuff. UST return\"\n\n    # final overall check\n    steth_ust_price: uint256 = self._get_chainlink_cross_price(steth_eth_price, eth_ust_price)\n    min_ust_amount = self._get_min_amount_out(\n        steth_amount,\n        steth_ust_price,\n        self.max_steth_ust_price_difference_percent,\n        STETH_TOKEN_DECIMALS,\n        UST_TOKEN_DECIMALS\n    )\n\n    assert ust_amount >= min_ust_amount, \"insuff. overall UST return\"\n\n    ERC20(UST_TOKEN).transfer(ust_recipient, ust_amount)\n\n    log SoldStethToUST(\n        steth_amount,\n        eth_amount,\n        usdc_amount,\n        ust_amount,\n        steth_eth_price,\n        eth_usdc_price,\n        usdc_ust_price\n    )\n\n    return ust_amount"
    }
  ]
}