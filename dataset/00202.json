{
  "Title": "M-8: `ZivoeTranches#rewardZVEJuniorDeposit` function miscalculates the reward when the ratio traverses lower/upper bound.",
  "Content": "# Issue M-8: `ZivoeTranches#rewardZVEJuniorDeposit` function miscalculates the reward when the ratio traverses lower/upper bound. \n\nSource: https://github.com/sherlock-audit/2024-03-zivoe-judging/issues/232 \n\nThe protocol has acknowledged this issue.\n\n## Found by \nAMOW, amar, dany.armstrong90\n## Summary\n`ZivoeTranches#rewardZVEJuniorDeposit` function miscalculates the reward when the ratio traverses lower/upper bound.\nThe same issue also exists in the `ZivoeTranches#rewardZVESeniorDeposit` function.\n\n## Vulnerability Detail\n`ZivoeTranches#rewardZVEJuniorDeposit` function is the following.\n```solidity\n    function rewardZVEJuniorDeposit(uint256 deposit) public view returns (uint256 reward) {\n\n        (uint256 seniorSupp, uint256 juniorSupp) = IZivoeGlobals_ZivoeTranches(GBL).adjustedSupplies();\n\n        uint256 avgRate;    // The avg ZVE per stablecoin deposit reward, used for reward calculation.\n\n        uint256 diffRate = maxZVEPerJTTMint - minZVEPerJTTMint;\n\n        uint256 startRatio = juniorSupp * BIPS / seniorSupp;\n        uint256 finalRatio = (juniorSupp + deposit) * BIPS / seniorSupp;\n213:    uint256 avgRatio = (startRatio + finalRatio) / 2;\n\n        if (avgRatio <= lowerRatioIncentiveBIPS) {\n216:        avgRate = maxZVEPerJTTMint;\n        } else if (avgRatio >= upperRatioIncentiveBIPS) {\n218:        avgRate = minZVEPerJTTMint;\n        } else {\n220:        avgRate = maxZVEPerJTTMint - diffRate * (avgRatio - lowerRatioIncentiveBIPS) / (upperRatioIncentiveBIPS - lowerRatioIncentiveBIPS);\n        }\n\n223:    reward = avgRate * deposit / 1 ether;\n\n        // Reduce if ZVE balance < reward.\n        if (IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).balanceOf(address(this)) < reward) {\n            reward = IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).balanceOf(address(this));\n        }\n    }\n```\nHere, let us assume that `lowerRatioIncentiveBIPS = 1000`, `upperRatioIncentiveBIPS = 2500`, `minZVEPerJTTMint = 0`, `maxZVEPerJTTMint = 0.4 * 10 ** 18`, `seniorSupp = 10000`.\n\nLet us consider the case of `juniorSupp = 0` where the ratio traverses the lower bound.\n\nExample 1:\nAssume that the depositor deposit `2000` at a time.\nThen `avgRatio = 1000` holds in `L213`, thus `avgRate = maxZVEPerJTTMint = 0.4 * 10 ** 18` holds in `L216`.\nTherefore `reward = 0.4 * deposit = 800` holds in `L223`.\n\nExample 2:\nAssume that the depositor deposit `1000` twice.\nThen, since `avgRate = 500 < lowerRatioIncentiveBIPS` holds for the first deposit, `avgRate = 0.4 * 10 ** 18` holds in `L216`, thus `reward = 400` holds.\nSince `avgRate = 1500 > lowerRatioIncentiveBIPS` holds for the second deposit, `avgRate = 0.3 * 10 ** 18` holds in `L220`, thus `reward = 300` holds.\nFinally, the total sum of rewards for two deposits are `400 + 300 = 700`.\n\nThis shows that the reward of the case where all assets are deposited at a time is larger than the reward of the case where assets are divided and deposited twice. In this case, the protocol gets loss of funds.\n\nLikewise, in the case where the ratio traverses the upper bound, the reward of one time deposit will be smaller than the reward of two times deposit and thus the depositor gets loss.\n\nThe same issue also exists in the `ZivoeTranches#rewardZVESeniorDeposit` function.\n\n## Impact\nWhen the ratio traverses the lower/upper bound in `ZivoeTranches#rewardZVEJuniorDeposit` and `ZivoeTranches#rewardZVESeniorDeposit` functions, the amount of reward will be larger/smaller than it should be. Thus the depositor or the protocol will get loss of funds.\n\n## Code Snippet\nhttps://github.com/sherlock-audit/2024-03-zivoe/blob/main/zivoe-core-foundry/src/ZivoeTranches.sol#L215-L221\n\n## Tool used\nManual Review\n\n## Recommendation\nModify the functions to calculate the reward dividing into two portion when the ratio traverses the lower/upper bound, which is similar to the case of Example 2.\n\n\n\n## Discussion\n\n**pseudonaut**\n\nYes if the tranche ratio's swing very far out it will allow for calculations of this nature - known, not of concern\n\n**sherlock-admin3**\n\n1 comment(s) were left on this issue during the judging contest.\n\n**panprog** commented:\n> borderline low/medium, while true, the impact is not very large and can be considered protocol's intended choice to simplify the curve. From protocol's standpoint this is simply incentive to deposit and slightly more or less in specific circumstances is not that important.\n\n\n\n**panprog**\n\nDowngrading to Low.\n\nThis is known to developers and I consider this a design decision to simplify the calculations / save gas. The user can be informed about such behaviour and can do multiple or single transaction depending on what's more beneficial. No funds loss from protocol's standpoint (simply slightly different ratio of rewards distribution which doesn't influence anything)\n\n**armormadeofwoe**\n\nContinuing discussion here.  \n[Here is a graph](https://github.com/sherlock-audit/2024-03-zivoe-judging/assets/150850767/1238462a-9cfb-4cf8-b20b-bcc784b6173a) of the juniorReward linear decrease with respect to the min/max reward thresholds. As mentioned in this issue and its' 2 dups - a 2-deposit split where the initial one is crafted to not cross the max threshold will always yield more rewards than going at once. I believe this issue's math paired with a visualization should be sufficient. Let me know your thoughts. \n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/280",
  "Code": [
    {
      "filename": "zivoe-core-foundry/src/ZivoeTranches.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.17;\n\nimport \"./ZivoeLocker.sol\";\n\nimport \"../lib/openzeppelin-contracts/contracts/security/ReentrancyGuard.sol\";\nimport \"../lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\";\nimport \"../lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol\";\nimport \"../lib/openzeppelin-contracts/contracts/token/ERC20/utils/SafeERC20.sol\";\n\ninterface IERC20Mintable_ZivoeTranches {\n    /// @notice Creates ERC20 tokens and assigns them to an address, increasing the total supply.\n    /// @param account The address to send the newly created tokens to.\n    /// @param amount The amount of tokens to create and send.\n    function mint(address account, uint256 amount) external;\n}\n\ninterface IZivoeGlobals_ZivoeTranches {\n    /// @notice Returns the address of the ZivoeDAO contract.\n    function DAO() external view returns (address);\n\n    /// @notice Returns the address of the ZivoeITO contract.\n    function ITO() external view returns (address);\n\n    /// @notice Returns the address of the Timelock contract.\n    function TLC() external view returns (address);\n\n    /// @notice Returns the address of the ZivoeTrancheToken ($zSTT) contract.\n    function zSTT() external view returns (address);\n\n    /// @notice Returns the address of the ZivoeTrancheToken ($zJTT) contract.\n    function zJTT() external view returns (address);\n\n    /// @notice Returns the address of the ZivoeToken contract.\n    function ZVE() external view returns (address);\n\n    /// @notice Returns the address of the Zivoe Laboratory.\n    function ZVL() external view returns (address);\n\n    /// @notice Returns total circulating supply of zSTT and zJTT, accounting for defaults via markdowns.\n    /// @return zSTTSupply zSTT.totalSupply() adjusted for defaults.\n    /// @return zJTTSupply zJTT.totalSupply() adjusted for defaults.\n    function adjustedSupplies() external view returns (uint256 zSTTSupply, uint256 zJTTSupply);\n\n    /// @notice This function will verify if a given stablecoin has been whitelisted for use throughout system.\n    /// @param stablecoin address of the stablecoin to verify acceptance for.\n    function stablecoinWhitelist(address stablecoin) external view returns (bool);\n\n    /// @notice Handles WEI standardization of a given asset amount (i.e. 6 decimal precision => 18 decimal precision).\n    /// @param amount The amount of a given \"asset\".\n    /// @param asset The asset (ERC-20) from which to standardize the amount to WEI.\n    /// @return standardizedAmount The above amount standardized to 18 decimals.\n    function standardize(uint256 amount, address asset) external view returns (uint256 standardizedAmount);\n}\n\n\n\n/// @notice  This contract will facilitate ongoing liquidity provision to Zivoe tranches - Junior, Senior.\n///          This contract will be permissioned by $zJTT and $zSTT to call mint().\n///          This contract will support a whitelist for stablecoins to provide as liquidity.\ncontract ZivoeTranches is ZivoeLocker, ReentrancyGuard {\n\n    using SafeERC20 for IERC20;\n\n    // ---------------------\n    //    State Variables\n    // ---------------------\n\n    address public immutable GBL;   /// @dev The ZivoeGlobals contract.\n\n    /// @dev This ratio represents the maximum size allowed for junior tranche, relative to senior tranche.\n    ///      A value of 2,000 represent 20%, thus junior tranche at maximum can be 20% the size of senior tranche.\n    uint256 public maxTrancheRatioBIPS = 4500;\n\n    /// @dev These two values control the min/max $ZVE minted per stablecoin deposited to ZivoeTranches.\n    uint256 public minZVEPerJTTMint = 0;\n    uint256 public maxZVEPerJTTMint = 0;\n\n    /// @dev Basis points ratio between zJTT.totalSupply():zSTT.totalSupply() for maximum rewards (affects above slope).\n    uint256 public lowerRatioIncentiveBIPS = 1000;\n    uint256 public upperRatioIncentiveBIPS = 3500;\n\n    bool public tranchesUnlocked;   /// @dev Prevents contract from supporting functionality until unlocked.\n    bool public paused;             /// @dev Temporary mechanism for pausing deposits.\n\n    uint256 private constant BIPS = 10000;\n\n\n\n    // -----------------\n    //    Constructor\n    // -----------------\n\n    /// @notice Initializes the ZivoeTranches contract.\n    /// @param _GBL The ZivoeGlobals contract.\n    constructor(address _GBL) { GBL = _GBL; }\n\n\n\n    // ------------\n    //    Events\n    // ------------\n\n    /// @notice Emitted during depositJunior().\n    /// @param  account The account depositing stablecoins to junior tranche.\n    /// @param  asset The stablecoin deposited.\n    /// @param  amount The amount of stablecoins deposited.\n    /// @param  incentives The amount of incentives ($ZVE) distributed.\n    event JuniorDeposit(address indexed account, address indexed asset, uint256 amount, uint256 incentives);\n\n    /// @notice Emitted during depositSenior().\n    /// @param  account The account depositing stablecoins to senior tranche.\n    /// @param  asset The stablecoin deposited.\n    /// @param  amount The amount of stablecoins deposited.\n    /// @param  incentives The amount of incentives ($ZVE) distributed.\n    event SeniorDeposit(address indexed account, address indexed asset, uint256 amount, uint256 incentives);\n\n    /// @notice Emitted during updateLowerRatioIncentiveBIPS().\n    /// @param  oldValue The old value of lowerRatioJTT.\n    /// @param  newValue The new value of lowerRatioJTT.\n    event UpdatedLowerRatioIncentiveBIPS(uint256 oldValue, uint256 newValue);\n\n    /// @notice Emitted during updateMaxTrancheRatio().\n    /// @param  oldValue The old value of maxTrancheRatioBIPS.\n    /// @param  newValue The new value of maxTrancheRatioBIPS.\n    event UpdatedMaxTrancheRatioBIPS(uint256 oldValue, uint256 newValue);\n\n    /// @notice Emitted during updateMaxZVEPerJTTMint().\n    /// @param  oldValue The old value of maxZVEPerJTTMint.\n    /// @param  newValue The new value of maxZVEPerJTTMint.\n    event UpdatedMaxZVEPerJTTMint(uint256 oldValue, uint256 newValue);\n\n    /// @notice Emitted during updateMinZVEPerJTTMint().\n    /// @param  oldValue The old value of minZVEPerJTTMint.\n    /// @param  newValue The new value of minZVEPerJTTMint.\n    event UpdatedMinZVEPerJTTMint(uint256 oldValue, uint256 newValue);\n\n    /// @notice Emitted during updateUpperRatioIncentiveBIPS().\n    /// @param  oldValue The old value of upperRatioJTT.\n    /// @param  newValue The new value of upperRatioJTT.\n    event UpdatedUpperRatioIncentiveBIPS(uint256 oldValue, uint256 newValue);\n\n\n\n    // ---------------\n    //    Functions\n    // ---------------\n\n    modifier notPaused() {\n        require(!paused, \"ZivoeTranches::whenPaused() notPaused\");\n        _;\n    }\n\n    modifier onlyGovernance() {\n        require(\n            _msgSender() == IZivoeGlobals_ZivoeTranches(GBL).TLC(), \n            \"ZivoeTranches::onlyGovernance() _msgSender() != IZivoeGlobals_ZivoeTranches(GBL).TLC()\"\n        );\n        _;\n    }\n\n\n    // ---------------\n    //    Functions\n    // ---------------\n\n    /// @notice Permission for owner to call pushToLocker().\n    function canPush() public override pure returns (bool) { return true; }\n\n    /// @notice Permission for owner to call pullFromLocker().\n    function canPull() public override pure returns (bool) { return true; }\n\n    /// @notice Permission for owner to call pullFromLockerPartial().\n    function canPullPartial() public override pure returns (bool) { return true; }\n\n    /// @notice This pulls capital from the DAO, does any necessary pre-conversions, and escrows ZVE for incentives.\n    /// @param asset The asset to pull from the DAO.\n    /// @param amount The amount of asset to pull from the DAO.\n    /// @param data Accompanying transaction data.\n    function pushToLocker(address asset, uint256 amount, bytes calldata data) external override onlyOwner {\n        require(\n            asset == IZivoeGlobals_ZivoeTranches(GBL).ZVE(), \n            \"ZivoeTranches::pushToLocker() asset != IZivoeGlobals_ZivoeTranches(GBL).ZVE()\"\n        );\n        IERC20(asset).safeTransferFrom(owner(), address(this), amount);\n    }\n\n    /// @notice Checks if stablecoin deposits into the Junior Tranche are open.\n    /// @param  amount The amount to deposit.\n    /// @param  asset The asset (stablecoin) to deposit.\n    /// @return open Will return \"true\" if the deposits into the Junior Tranche are open.\n    function isJuniorOpen(uint256 amount, address asset) public view returns (bool open) {\n        uint256 convertedAmount = IZivoeGlobals_ZivoeTranches(GBL).standardize(amount, asset);\n        (uint256 seniorSupp, uint256 juniorSupp) = IZivoeGlobals_ZivoeTranches(GBL).adjustedSupplies();\n        return convertedAmount + juniorSupp <= seniorSupp * maxTrancheRatioBIPS / BIPS;\n    }\n    \n    /// @notice Returns the total rewards in $ZVE for a certain junior tranche deposit amount.\n    /// @dev Input amount MUST be in WEI (use GBL.standardize(amount, asset)).\n    /// @dev Output amount MUST be in WEI.\n    /// @param deposit The amount supplied to the junior tranche.\n    /// @return reward The rewards in $ZVE to be received.\n    function rewardZVEJuniorDeposit(uint256 deposit) public view returns (uint256 reward) {\n\n        (uint256 seniorSupp, uint256 juniorSupp) = IZivoeGlobals_ZivoeTranches(GBL).adjustedSupplies();\n\n        uint256 avgRate;    // The avg ZVE per stablecoin deposit reward, used for reward calculation.\n\n        uint256 diffRate = maxZVEPerJTTMint - minZVEPerJTTMint;\n\n        uint256 startRatio = juniorSupp * BIPS / seniorSupp;\n        uint256 finalRatio = (juniorSupp + deposit) * BIPS / seniorSupp;\n        uint256 avgRatio = (startRatio + finalRatio) / 2;\n\n        if (avgRatio <= lowerRatioIncentiveBIPS) {\n            avgRate = maxZVEPerJTTMint;\n        } else if (avgRatio >= upperRatioIncentiveBIPS) {\n            avgRate = minZVEPerJTTMint;\n        } else {\n            avgRate = maxZVEPerJTTMint - diffRate * (avgRatio - lowerRatioIncentiveBIPS) / (upperRatioIncentiveBIPS - lowerRatioIncentiveBIPS);\n        }\n\n        reward = avgRate * deposit / 1 ether;\n\n        // Reduce if ZVE balance < reward.\n        if (IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).balanceOf(address(this)) < reward) {\n            reward = IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).balanceOf(address(this));\n        }\n    }\n\n    /// @notice Returns the total rewards in $ZVE for a certain senior tranche deposit amount.\n    /// @dev Input amount MUST be in WEI (use GBL.standardize(amount, asset)).\n    /// @dev Output amount MUST be in WEI.\n    /// @param deposit The amount supplied to the senior tranche.\n    /// @return reward The rewards in $ZVE to be received.\n    function rewardZVESeniorDeposit(uint256 deposit) public view returns (uint256 reward) {\n\n        (uint256 seniorSupp, uint256 juniorSupp) = IZivoeGlobals_ZivoeTranches(GBL).adjustedSupplies();\n\n        uint256 avgRate;    // The avg ZVE per stablecoin deposit reward, used for reward calculation.\n\n        uint256 diffRate = maxZVEPerJTTMint - minZVEPerJTTMint;\n\n        uint256 startRatio = juniorSupp * BIPS / seniorSupp;\n        uint256 finalRatio = juniorSupp * BIPS / (seniorSupp + deposit);\n        uint256 avgRatio = (startRatio + finalRatio) / 2;\n\n        if (avgRatio <= lowerRatioIncentiveBIPS) {\n            avgRate = minZVEPerJTTMint;\n        } else if (avgRatio >= upperRatioIncentiveBIPS) {\n            avgRate = maxZVEPerJTTMint;\n        } else {\n            avgRate = minZVEPerJTTMint + diffRate * (avgRatio - lowerRatioIncentiveBIPS) / (upperRatioIncentiveBIPS - lowerRatioIncentiveBIPS);\n        }\n\n        reward = avgRate * deposit / 1 ether;\n\n        // Reduce if ZVE balance < reward.\n        if (IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).balanceOf(address(this)) < reward) {\n            reward = IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).balanceOf(address(this));\n        }\n    }\n\n    /// @notice Deposit stablecoins into the junior tranche.\n    /// @dev    Mints Zivoe Junior Tranche ($zJTT) tokens in 1:1 ratio.\n    /// @param  amount The amount to deposit.\n    /// @param  asset The asset (stablecoin) to deposit.\n    function depositJunior(uint256 amount, address asset) public notPaused nonReentrant {\n        require(\n            IZivoeGlobals_ZivoeTranches(GBL).stablecoinWhitelist(asset), \n            \"ZivoeTranches::depositJunior() !IZivoeGlobals_ZivoeTranches(GBL).stablecoinWhitelist(asset)\"\n        );\n        require(tranchesUnlocked, \"ZivoeTranches::depositJunior() !tranchesUnlocked\");\n\n        address depositor = _msgSender();\n\n        IERC20(asset).safeTransferFrom(depositor, IZivoeGlobals_ZivoeTranches(GBL).DAO(), amount);\n        \n        uint256 convertedAmount = IZivoeGlobals_ZivoeTranches(GBL).standardize(amount, asset);\n\n        require(isJuniorOpen(amount, asset),\"ZivoeTranches::depositJunior() !isJuniorOpen(amount, asset)\");\n\n        uint256 incentives = rewardZVEJuniorDeposit(convertedAmount);\n        emit JuniorDeposit(depositor, asset, amount, incentives);\n\n        // Ordering important, transfer ZVE rewards prior to minting zJTT() due to totalSupply() changes.\n        IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).safeTransfer(depositor, incentives);\n        IERC20Mintable_ZivoeTranches(IZivoeGlobals_ZivoeTranches(GBL).zJTT()).mint(depositor, convertedAmount);\n    }\n\n    /// @notice Deposit stablecoins into the senior tranche.\n    /// @dev    Mints Zivoe Senior Tranche ($zSTT) tokens in 1:1 ratio.\n    /// @param  amount The amount to deposit.\n    /// @param  asset The asset (stablecoin) to deposit.\n    function depositSenior(uint256 amount, address asset) public notPaused nonReentrant {\n        require(\n            IZivoeGlobals_ZivoeTranches(GBL).stablecoinWhitelist(asset), \n            \"ZivoeTranches::depositSenior() !IZivoeGlobals_ZivoeTranches(GBL).stablecoinWhitelist(asset)\"\n        );\n        require(tranchesUnlocked, \"ZivoeTranches::depositSenior() !tranchesUnlocked\");\n\n        address depositor = _msgSender();\n\n        IERC20(asset).safeTransferFrom(depositor, IZivoeGlobals_ZivoeTranches(GBL).DAO(), amount);\n        \n        uint256 convertedAmount = IZivoeGlobals_ZivoeTranches(GBL).standardize(amount, asset);\n\n        uint256 incentives = rewardZVESeniorDeposit(convertedAmount);\n\n        emit SeniorDeposit(depositor, asset, amount, incentives);\n\n        // Ordering important, transfer ZVE rewards prior to minting zJTT() due to totalSupply() changes.\n        IERC20(IZivoeGlobals_ZivoeTranches(GBL).ZVE()).safeTransfer(depositor, incentives);\n        IERC20Mintable_ZivoeTranches(IZivoeGlobals_ZivoeTranches(GBL).zSTT()).mint(depositor, convertedAmount);\n    }\n\n    /// @notice Deposit stablecoins to both tranches simultaneously\n    /// @param amountSenior The amount to deposit to senior tranche\n    /// @param assetSenior The asset to deposit to senior tranche\n    /// @param amountJunior The amount to deposit to senior tranche\n    /// @param assetJunior The asset to deposit to senior tranche\n    function depositBoth(uint256 amountSenior, address assetSenior, uint256 amountJunior, address assetJunior) external {\n        depositSenior(amountSenior, assetSenior);\n        depositJunior(amountJunior, assetJunior);\n    }\n\n    /// @notice Pauses or unpauses the contract, enabling or disabling depositJunior() and depositSenior().\n    function switchPause() external {\n        require(\n            _msgSender() == IZivoeGlobals_ZivoeTranches(GBL).ZVL(), \n            \"ZivoeTranches::switchPause() _msgSender() != IZivoeGlobals_ZivoeTranches(GBL).ZVL()\"\n        );\n        paused = !paused;\n    }\n\n    /// @notice Updates the lower ratio between tranches for minting incentivization model.\n    /// @dev    A value of 1,000 represents 10%, indicating that maximum $ZVE incentives are offered for\n    ///         minting $zJTT (Junior Tranche Tokens) when the actual tranche ratio is <=10%.\n    ///         Likewise, due to inverse relationship between incentives for $zJTT and $zSTT minting,\n    ///         a value of 1,000 represents 10%, indicating that minimum $ZVE incentives are offered for\n    ///         minting $zSTT (Senior Tranche Tokens) when the actual tranche ratio is <=10% \n    /// @param  _lowerRatioIncentiveBIPS The lower ratio to incentivize minting.\n    function updateLowerRatioIncentiveBIPS(uint256 _lowerRatioIncentiveBIPS) external onlyGovernance {\n        require(\n            _lowerRatioIncentiveBIPS >= 1000, \n            \"ZivoeTranches::updateLowerRatioIncentiveBIPS() _lowerRatioIncentiveBIPS < 1000\")\n        ;\n        require(\n            _lowerRatioIncentiveBIPS < upperRatioIncentiveBIPS, \n            \"ZivoeTranches::updateLowerRatioIncentiveBIPS() _lowerRatioIncentiveBIPS >= upperRatioIncentiveBIPS\"\n        );\n        emit UpdatedLowerRatioIncentiveBIPS(lowerRatioIncentiveBIPS, _lowerRatioIncentiveBIPS);\n        lowerRatioIncentiveBIPS = _lowerRatioIncentiveBIPS; \n    }\n\n    /// @notice Updates the maximum size of junior tranche, relative to senior tranche.\n    /// @dev    A value of 2,000 represents 20% (basis points), meaning the junior tranche \n    ///         at maximum can be 20% the size of senior tranche.\n    /// @param  ratio The new ratio value.\n    function updateMaxTrancheRatio(uint256 ratio) external onlyGovernance {\n        require(ratio <= 4500, \"ZivoeTranches::updateMaxTrancheRatio() ratio > 4500\");\n        emit UpdatedMaxTrancheRatioBIPS(maxTrancheRatioBIPS, ratio);\n        maxTrancheRatioBIPS = ratio;\n    }\n\n    /// @notice Updates the maximum $ZVE minted per stablecoin deposited to ZivoeTranches.\n    /// @param  max Maximum $ZVE minted per stablecoin.\n    function updateMaxZVEPerJTTMint(uint256 max) external onlyGovernance {\n        require(minZVEPerJTTMint < max, \"ZivoeTranches::updateMaxZVEPerJTTMint() minZVEPerJTTMint >= max\");\n        require(max < 0.5 * 10**18, \"ZivoeTranches::updateMaxZVEPerJTTMint() max >= 0.5 * 10**18\");\n        emit UpdatedMaxZVEPerJTTMint(maxZVEPerJTTMint, max);\n        maxZVEPerJTTMint = max; \n    }\n\n    /// @notice Updates the minimum $ZVE minted per stablecoin deposited to ZivoeTranches.\n    /// @param  min Minimum $ZVE minted per stablecoin.\n    function updateMinZVEPerJTTMint(uint256 min) external onlyGovernance {\n        require(min < maxZVEPerJTTMint, \"ZivoeTranches::updateMinZVEPerJTTMint() min >= maxZVEPerJTTMint\");\n        emit UpdatedMinZVEPerJTTMint(minZVEPerJTTMint, min);\n        minZVEPerJTTMint = min;\n    }\n\n    /// @notice Updates the upper ratio between tranches for minting incentivization model.\n    /// @dev    A value of 2,000 represents 20%, indicating that minimum $ZVE incentives are offered for\n    ///         minting $zJTT (Junior Tranche Tokens) when the actual tranche ratio is >= 20%.\n    ///         Likewise, due to inverse relationship between incentives for $zJTT and $zSTT minting,\n    ///         a value of 2,000 represents 20%, indicating that maximum $ZVE incentives are offered for\n    ///         minting $zSTT (Senior Tranche Tokens) when the actual tranche ratio is >= 20%.\n    /// @param  _upperRatioIncentiveBIPS The upper ratio to incentivize minting.\n    function updateUpperRatioIncentiveBIPS(uint256 _upperRatioIncentiveBIPS) external onlyGovernance {\n        require(\n            lowerRatioIncentiveBIPS < _upperRatioIncentiveBIPS, \n            \"ZivoeTranches::updateUpperRatioIncentiveBIPS() lowerRatioIncentiveBIPS >= _upperRatioIncentiveBIPS\"\n        );\n        require(\n            _upperRatioIncentiveBIPS <= 2500, \n            \"ZivoeTranches::updateUpperRatioIncentiveBIPS() _upperRatioIncentiveBIPS > 2500\"\n        );\n        emit UpdatedUpperRatioIncentiveBIPS(upperRatioIncentiveBIPS, _upperRatioIncentiveBIPS);\n        upperRatioIncentiveBIPS = _upperRatioIncentiveBIPS; \n    }\n\n    /// @notice Unlocks this contract for distributions, sets some initial variables.\n    function unlock() external {\n        require(\n            _msgSender() == IZivoeGlobals_ZivoeTranches(GBL).ITO(), \n            \"ZivoeTranches::unlock() _msgSender() != IZivoeGlobals_ZivoeTranches(GBL).ITO()\"\n        );\n        tranchesUnlocked = true;\n    }\n\n}"
    }
  ]
}