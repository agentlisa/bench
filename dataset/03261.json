{
  "Title": "[L02] Inconsistent reentrancy guard",
  "Content": "The [`Optimism_ParentMessenger`](https://github.com/UMAprotocol/protocol/blob/0c4cea3c3d5e48da6f8984b8ba3afdfea4ce47cc/packages/core/contracts/cross-chain-oracle/chain-adapters/Optimism_ParentMessenger.sol#L15) and [`Arbitrum_ParentMessenger`](https://github.com/UMAprotocol/protocol/blob/0c4cea3c3d5e48da6f8984b8ba3afdfea4ce47cc/packages/core/contracts/cross-chain-oracle/chain-adapters/Arbitrum_ParentMessenger.sol#L14) contracts inconsistently apply the `nonReentrant` modifier. Consider including it on all public functions.\n\n\n**Update:** *Fixed as of commit [`6275c39`](https://github.com/UMAprotocol/protocol/pull/3677/commits/6275c39948bdac6ada64e60c1d706b8591ef7c4e) in [PR3677](https://github.com/UMAprotocol/protocol/pull/3677).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "packages/core/contracts/cross-chain-oracle/chain-adapters/Optimism_ParentMessenger.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-only\npragma solidity ^0.8.0;\n\n// This should be replaced with a \"real\" import when Optimism release their new contract versions.\nimport \"@eth-optimism/contracts/libraries/bridge/CrossDomainEnabled.sol\";\nimport \"../interfaces/ParentMessengerInterface.sol\";\nimport \"../interfaces/ParentMessengerConsumerInterface.sol\";\nimport \"./ParentMessengerBase.sol\";\nimport \"../../common/implementation/Lockable.sol\";\n\n/**\n * @notice Sends cross chain messages from Ethereum L1 to Optimism L2 network.\n * @dev This contract is ownable and should be owned by the DVM governor.\n */\ncontract Optimism_ParentMessenger is CrossDomainEnabled, ParentMessengerInterface, ParentMessengerBase, Lockable {\n    event SetDefaultGasLimit(uint32 newDefaultGasLimit);\n    event MessageSentToChild(bytes data, address indexed targetSpoke, uint32 gasLimit, address indexed childMessenger);\n    event MessageReceivedFromChild(bytes data, address indexed childMessenger, address indexed targetHub);\n\n    uint32 public defaultGasLimit = 5_000_000;\n\n    /**\n     * @notice Construct the Optimism_ParentMessenger contract.\n     * @param _crossDomainMessenger The address of the Optimism cross domain messenger contract.\n     * @param _childChainId The chain id of the Optimism L2 network this messenger should connect to.\n     **/\n    constructor(address _crossDomainMessenger, uint256 _childChainId)\n        CrossDomainEnabled(_crossDomainMessenger)\n        ParentMessengerBase(_childChainId)\n    {}\n\n    /**\n     * @notice Changes the default gas limit that is sent along with transactions to Optimism.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newDefaultGasLimit the new L2 gas limit to be set.\n     */\n    function setDefaultGasLimit(uint32 newDefaultGasLimit) public onlyOwner nonReentrant() {\n        defaultGasLimit = newDefaultGasLimit;\n        emit SetDefaultGasLimit(newDefaultGasLimit);\n    }\n\n    /**\n     * @notice Changes the address of the oracle spoke on L2 via the child messenger.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newOracleSpoke the new oracle spoke address set on L2.\n     */\n    function setChildOracleSpoke(address newOracleSpoke) public onlyOwner {\n        bytes memory dataSentToChild = abi.encodeWithSignature(\"setOracleSpoke(address)\", newOracleSpoke);\n        sendCrossDomainMessage(childMessenger, defaultGasLimit, dataSentToChild);\n        emit MessageSentToChild(dataSentToChild, address(0), defaultGasLimit, childMessenger);\n    }\n\n    /**\n     * @notice Changes the address of the parent messenger on L2 via the child messenger.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newParentMessenger the new parent messenger contract to be set on L2.\n     */\n    function setChildParentMessenger(address newParentMessenger) public onlyOwner {\n        bytes memory dataSentToChild = abi.encodeWithSignature(\"setParentMessenger(address)\", newParentMessenger);\n        sendCrossDomainMessage(childMessenger, defaultGasLimit, dataSentToChild);\n        emit MessageSentToChild(dataSentToChild, address(0), defaultGasLimit, childMessenger);\n    }\n\n    /**\n     * @notice Changes the Optimism_ChildMessenger default gas limit on L2 via the child messenger.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newDefaultGasLimit the new default gas limit set on L2.\n     */\n    function setChildDefaultGasLimit(uint32 newDefaultGasLimit) public onlyOwner {\n        bytes memory dataSentToChild = abi.encodeWithSignature(\"setDefaultGasLimit(uint32)\", newDefaultGasLimit);\n        sendCrossDomainMessage(childMessenger, defaultGasLimit, dataSentToChild);\n        emit MessageSentToChild(dataSentToChild, address(0), defaultGasLimit, childMessenger);\n    }\n\n    /**\n     * @notice Sends a message to the child messenger via the canonical message bridge.\n     * @dev The caller must be the either the OracleHub or the GovernorHub. This is to send either a\n     * price or initiate a governance action to the OracleSpoke or GovernorSpoke on the child network.\n     * @dev The recipient of this message is the child messenger. The messenger must implement processMessageFromParent\n     * which then forwards the data to the target either the OracleSpoke or the governorSpoke depending on the caller.\n     * @param data data message sent to the child messenger. Should be an encoded function call or packed data.\n     */\n    function sendMessageToChild(bytes memory data) public override onlyHubContract() nonReentrant() {\n        address target = msg.sender == oracleHub ? oracleSpoke : governorSpoke;\n        bytes memory dataSentToChild =\n            abi.encodeWithSignature(\"processMessageFromCrossChainParent(bytes,address)\", data, target);\n        sendCrossDomainMessage(childMessenger, defaultGasLimit, dataSentToChild);\n        emit MessageSentToChild(dataSentToChild, target, defaultGasLimit, childMessenger);\n    }\n\n    /**\n     * @notice Process a received message from the child messenger via the canonical message bridge.\n     * @dev The caller must be the the child messenger, sent over the canonical message bridge.\n     * @dev Note that only the OracleHub can receive messages from the child messenger. Therefore we can always forward\n     * these messages to this contract. The OracleHub must implement processMessageFromChild to handle this message.\n     * @param data data message sent from the child messenger. Should be an encoded function call or packed data.\n     */\n    function processMessageFromCrossChainChild(bytes memory data)\n        public\n        onlyFromCrossDomainAccount(childMessenger)\n        nonReentrant()\n    {\n        ParentMessengerConsumerInterface(oracleHub).processMessageFromChild(childChainId, data);\n        emit MessageReceivedFromChild(data, childMessenger, oracleHub);\n    }\n}"
    }
  ]
}