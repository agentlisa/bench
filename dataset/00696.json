{
  "Title": "Missing Tests",
  "Content": "The upgrade to the new version of `keccak256` lacks several tests that could significantly enhance the quality of the codebase. Consider adding the following tests to ensure the correctness of the upgrade process:\n\n\n* A test for the upgrade process using the new version of `keccak256`. The current upgrade process does not test transitioning from one `keccak256` version to another. Instead, it [acquires the current `keccak256` version](https://github.com/matter-labs/era-system-contracts/blob/217e115a91348c6a4dafde19a9777613e782e747/test/Keccak256.spec.ts#L23), changes it to a reverting contract, and then changes it back to the current version.\n* A `keccak256` unit test to verify the correctness of generated hashes. Consider implementing fuzz testing for this purpose.\n\n\n***Update:** Resolved in [pull request #58](https://github.com/matter-labs/era-system-contracts/pull/58) at commit [a4dc0d9](https://github.com/matter-labs/era-system-contracts/pull/58/commits/a4dc0d95225764056e0cbb2f3edaf636c98fbad2).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "test/Keccak256.spec.ts",
      "content": "import { CONTRACT_DEPLOYER_ADDRESS, hashBytecode } from 'zksync-web3/build/src/utils';\nimport { KeccakTest, KeccakTest__factory } from '../typechain-types';\nimport { KECCAK256_CONTRACT_ADDRESS } from './shared/constants';\nimport { getCode, getWallets, loadArtifact, publishBytecode, setCode } from './shared/utils';\nimport { ethers } from 'hardhat';\n\ndescribe('Keccak256 tests', function () {\n    let keccakTest: KeccakTest;\n\n    let correctKeccakCodeHash: string;\n    let alwaysRevertCodeHash: string;\n\n    // Kernel space address, needed to enable mimicCall\n    const KECCAK_TEST_ADDRESS = '0x0000000000000000000000000000000000009000';\n\n    before(async () => {\n        await setCode(\n            KECCAK_TEST_ADDRESS,\n            (await loadArtifact('KeccakTest')).bytecode\n        );\n\n        keccakTest = KeccakTest__factory.connect(KECCAK_TEST_ADDRESS,  getWallets()[0]);\n        const correctKeccakCode = await getCode(KECCAK256_CONTRACT_ADDRESS);\n\n        // The test node might use outdated contracts\n        const correctContractDeployerCode = (await loadArtifact('ContractDeployer')).bytecode;\n        await setCode(CONTRACT_DEPLOYER_ADDRESS, correctContractDeployerCode);\n\n        const emptyContractCode = (await loadArtifact('AlwaysRevert')).bytecode;\n        \n        await publishBytecode(correctKeccakCode);\n        await publishBytecode(emptyContractCode);\n\n        correctKeccakCodeHash = ethers.utils.hexlify(hashBytecode(correctKeccakCode));\n        alwaysRevertCodeHash = ethers.utils.hexlify(hashBytecode(emptyContractCode));\n    });\n\n    it('zero pointer test', async () => {\n        await keccakTest.zeroPointerTest()\n    });\n\n    it('keccak upgrade test', async() => {\n        const deployerInterfact = new ethers.utils.Interface((await loadArtifact('ContractDeployer')).abi);\n\n        const eraseInput = deployerInterfact.encodeFunctionData('forceDeployKeccak256', [\n            alwaysRevertCodeHash\n        ]);\n\n        const upgradeInput = deployerInterfact.encodeFunctionData('forceDeployKeccak256', [\n            correctKeccakCodeHash\n        ]);\n\n        await keccakTest.keccakUpgradeTest(\n            eraseInput,\n            upgradeInput\n        );\n    })\n});"
    }
  ]
}