{
  "Title": "[L-06] `act()` in `ActionLib.sol` doesn't check if the target publication is a mirror",
  "Content": "\nAccording to the [Referral System Rules](https://github.com/code-423n4/2023-07-lens/tree/main#referral-system-rules), mirrors cannot be a target publication. However, the [`act()`](https://github.com/code-423n4/2023-07-lens/blob/main/contracts/libraries/ActionLib.sol#L13-L63) function does not ensure that the target publication is not a mirror.\n\nThis is currently unexploitable as mirrors cannot be initialized with action modules, therefore the [`_isActionEnabled`](https://github.com/code-423n4/2023-07-lens/blob/main/contracts/libraries/ActionLib.sol#L31-L38) check will always revert when called with a mirror. However, this could potentially become exploitable if an attacker finds a way to corrupt the `enabledActionModulesBitmap` of a mirror publication.\n\n### Recommendation\n\nConsider validating that the target publication is not a mirror in [`act()`](https://github.com/code-423n4/2023-07-lens/blob/main/contracts/libraries/ActionLib.sol#L13-L63).\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2023-07-lens",
  "Code": [
    {
      "filename": "contracts/libraries/ActionLib.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.15;\n\nimport {Types} from 'contracts/libraries/constants/Types.sol';\nimport {StorageLib} from 'contracts/libraries/StorageLib.sol';\nimport {ValidationLib} from 'contracts/libraries/ValidationLib.sol';\nimport {IPublicationActionModule} from 'contracts/interfaces/IPublicationActionModule.sol';\nimport {Errors} from 'contracts/libraries/constants/Errors.sol';\nimport {Events} from 'contracts/libraries/constants/Events.sol';\n\nlibrary ActionLib {\n    function act(\n        Types.PublicationActionParams calldata publicationActionParams,\n        address transactionExecutor,\n        address actorProfileOwner\n    ) external returns (bytes memory) {\n        ValidationLib.validateNotBlocked({\n            profile: publicationActionParams.actorProfileId,\n            byProfile: publicationActionParams.publicationActedProfileId\n        });\n\n        Types.Publication storage _actedOnPublication = StorageLib.getPublication(\n            publicationActionParams.publicationActedProfileId,\n            publicationActionParams.publicationActedId\n        );\n\n        address actionModuleAddress = publicationActionParams.actionModuleAddress;\n        uint256 actionModuleId = StorageLib.actionModuleWhitelistData()[actionModuleAddress].id;\n\n        if (!_isActionEnabled(_actedOnPublication, actionModuleId)) {\n            // This will also revert for:\n            //   - Non-existent action modules\n            //   - Non-existent publications\n            //   - Legacy V1 publications\n            // Because the storage will be empty.\n            revert Errors.ActionNotAllowed();\n        }\n\n        Types.PublicationType[] memory referrerPubTypes = ValidationLib.validateReferrersAndGetReferrersPubTypes(\n            publicationActionParams.referrerProfileIds,\n            publicationActionParams.referrerPubIds,\n            publicationActionParams.publicationActedProfileId,\n            publicationActionParams.publicationActedId\n        );\n\n        bytes memory actionModuleReturnData = IPublicationActionModule(actionModuleAddress).processPublicationAction(\n            Types.ProcessActionParams({\n                publicationActedProfileId: publicationActionParams.publicationActedProfileId,\n                publicationActedId: publicationActionParams.publicationActedId,\n                actorProfileId: publicationActionParams.actorProfileId,\n                actorProfileOwner: actorProfileOwner,\n                transactionExecutor: transactionExecutor,\n                referrerProfileIds: publicationActionParams.referrerProfileIds,\n                referrerPubIds: publicationActionParams.referrerPubIds,\n                referrerPubTypes: referrerPubTypes,\n                actionModuleData: publicationActionParams.actionModuleData\n            })\n        );\n        emit Events.Acted(publicationActionParams, actionModuleReturnData, block.timestamp);\n\n        return actionModuleReturnData;\n    }\n\n    function _isActionEnabled(Types.Publication storage _publication, uint256 actionModuleId)\n        private\n        view\n        returns (bool)\n    {\n        if (actionModuleId == 0) {\n            return false;\n        }\n        uint256 actionModuleIdBitmapMask = 1 << (actionModuleId - 1);\n        return actionModuleIdBitmapMask & _publication.enabledActionModulesBitmap != 0;\n    }\n}"
    },
    {
      "filename": "contracts/libraries/ActionLib.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.15;\n\nimport {Types} from 'contracts/libraries/constants/Types.sol';\nimport {StorageLib} from 'contracts/libraries/StorageLib.sol';\nimport {ValidationLib} from 'contracts/libraries/ValidationLib.sol';\nimport {IPublicationActionModule} from 'contracts/interfaces/IPublicationActionModule.sol';\nimport {Errors} from 'contracts/libraries/constants/Errors.sol';\nimport {Events} from 'contracts/libraries/constants/Events.sol';\n\nlibrary ActionLib {\n    function act(\n        Types.PublicationActionParams calldata publicationActionParams,\n        address transactionExecutor,\n        address actorProfileOwner\n    ) external returns (bytes memory) {\n        ValidationLib.validateNotBlocked({\n            profile: publicationActionParams.actorProfileId,\n            byProfile: publicationActionParams.publicationActedProfileId\n        });\n\n        Types.Publication storage _actedOnPublication = StorageLib.getPublication(\n            publicationActionParams.publicationActedProfileId,\n            publicationActionParams.publicationActedId\n        );\n\n        address actionModuleAddress = publicationActionParams.actionModuleAddress;\n        uint256 actionModuleId = StorageLib.actionModuleWhitelistData()[actionModuleAddress].id;\n\n        if (!_isActionEnabled(_actedOnPublication, actionModuleId)) {\n            // This will also revert for:\n            //   - Non-existent action modules\n            //   - Non-existent publications\n            //   - Legacy V1 publications\n            // Because the storage will be empty.\n            revert Errors.ActionNotAllowed();\n        }\n\n        Types.PublicationType[] memory referrerPubTypes = ValidationLib.validateReferrersAndGetReferrersPubTypes(\n            publicationActionParams.referrerProfileIds,\n            publicationActionParams.referrerPubIds,\n            publicationActionParams.publicationActedProfileId,\n            publicationActionParams.publicationActedId\n        );\n\n        bytes memory actionModuleReturnData = IPublicationActionModule(actionModuleAddress).processPublicationAction(\n            Types.ProcessActionParams({\n                publicationActedProfileId: publicationActionParams.publicationActedProfileId,\n                publicationActedId: publicationActionParams.publicationActedId,\n                actorProfileId: publicationActionParams.actorProfileId,\n                actorProfileOwner: actorProfileOwner,\n                transactionExecutor: transactionExecutor,\n                referrerProfileIds: publicationActionParams.referrerProfileIds,\n                referrerPubIds: publicationActionParams.referrerPubIds,\n                referrerPubTypes: referrerPubTypes,\n                actionModuleData: publicationActionParams.actionModuleData\n            })\n        );\n        emit Events.Acted(publicationActionParams, actionModuleReturnData, block.timestamp);\n\n        return actionModuleReturnData;\n    }\n\n    function _isActionEnabled(Types.Publication storage _publication, uint256 actionModuleId)\n        private\n        view\n        returns (bool)\n    {\n        if (actionModuleId == 0) {\n            return false;\n        }\n        uint256 actionModuleIdBitmapMask = 1 << (actionModuleId - 1);\n        return actionModuleIdBitmapMask & _publication.enabledActionModulesBitmap != 0;\n    }\n}"
    }
  ]
}