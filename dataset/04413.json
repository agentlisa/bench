{
  "Title": "[P1-L11] Proxy delegation logic can be simplified",
  "Content": "###### Low\n\n\nComponent: [`policy`](https://github.com/BeamNetwork/currency/tree/af3428020545e3f3ae2f3567b94e1fbc5e5bdb4c/contracts/policy)\n\n\nThe [fallback](https://github.com/BeamNetwork/beam-bootstrap-chain/blob/96beab1c5cfd41310bfba733ab7216426caf4a38/contracts/ForwardProxy.sol#L20) function in charge of the delegation process for the proxy can be simplified. It is not necessary to use the [free memory pointer](https://github.com/BeamNetwork/beam-bootstrap-chain/blob/96beab1c5cfd41310bfba733ab7216426caf4a38/contracts/ForwardProxy.sol#L23), and [`returndatasize`](https://github.com/BeamNetwork/beam-bootstrap-chain/blob/96beab1c5cfd41310bfba733ab7216426caf4a38/contracts/ForwardProxy.sol#L26) can be saved to a variable instead of calling it twice. Also, the [result of](https://github.com/BeamNetwork/beam-bootstrap-chain/blob/96beab1c5cfd41310bfba733ab7216426caf4a38/contracts/ForwardProxy.sol#L25) [`delegatecall`](https://github.com/BeamNetwork/beam-bootstrap-chain/blob/96beab1c5cfd41310bfba733ab7216426caf4a38/contracts/ForwardProxy.sol#L25) can be checked after the `returndatacopy` to avoid the duplicated statement.\n\n\nBecause this code is hard to understand and Solidity does not check its safety, it is a good idea to make it as short and clear as possible.\n\n\nConsider refactoring the assembly block. See the [OpenZeppelin SDK delegate implementation](https://github.com/zeppelinos/zos/blob/7b2ed4a7ddb4ed0b84035ff4c55f7e54e80cfd40/packages/lib/contracts/upgradeability/Proxy.sol#L31) as an example of a thoroughly tested alternative.\n\n\n***Update:*** *Partially fixed. The* [*proxy implementation*](https://github.com/BeamNetwork/currency/blob/af3428020545e3f3ae2f3567b94e1fbc5e5bdb4c/contracts/proxy/ForwardProxy.sol#L42) *no longer uses the free memory pointer. Ecoâ€™s statement for this issue:*\n\n\n\n> The current implementation minimizes gas overhead, which was an important design consideration for us.\n> \n> \n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "packages/lib/contracts/upgradeability/Proxy.sol",
      "content": "pragma solidity ^0.4.24;\n\n/**\n * @title Proxy\n * @dev Implements delegation of calls to other contracts, with proper\n * forwarding of return values and bubbling of failures.\n * It defines a fallback function that delegates all calls to the address\n * returned by the abstract _implementation() internal function.\n */\ncontract Proxy {\n  /**\n   * @dev Fallback function.\n   * Implemented entirely in `_fallback`.\n   */\n  function () payable external {\n    _fallback();\n  }\n\n  /**\n   * @return The Address of the implementation.\n   */\n  function _implementation() internal view returns (address);\n\n  /**\n   * @dev Delegates execution to an implementation contract.\n   * This is a low level function that doesn't return to its internal call site.\n   * It will return to the external caller whatever the implementation returns.\n   * @param implementation Address to delegate.\n   */\n  function _delegate(address implementation) internal {\n    assembly {\n      // Copy msg.data. We take full control of memory in this inline assembly\n      // block because it will not return to Solidity code. We overwrite the\n      // Solidity scratch pad at memory position 0.\n      calldatacopy(0, 0, calldatasize)\n\n      // Call the implementation.\n      // out and outsize are 0 because we don't know the size yet.\n      let result := delegatecall(gas, implementation, 0, calldatasize, 0, 0)\n\n      // Copy the returned data.\n      returndatacopy(0, 0, returndatasize)\n\n      switch result\n      // delegatecall returns 0 on error.\n      case 0 { revert(0, returndatasize) }\n      default { return(0, returndatasize) }\n    }\n  }\n\n  /**\n   * @dev Function that is run as the first thing in the fallback function.\n   * Can be redefined in derived contracts to add functionality.\n   * Redefinitions must call super._willFallback().\n   */\n  function _willFallback() internal {\n  }\n\n  /**\n   * @dev fallback implementation.\n   * Extracted to enable manual triggering.\n   */\n  function _fallback() internal {\n    _willFallback();\n    _delegate(_implementation());\n  }\n}"
    }
  ]
}