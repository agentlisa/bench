{
  "Title": "[H-04] Strategist can fail to withdraw asset token from a private vault",
  "Content": "\n<https://github.com/AstariaXYZ/astaria-gpl/blob/main/src/ERC4626RouterBase.sol#L41-L52><br>\n<https://github.com/code-423n4/2023-01-astaria/blob/main/src/Vault.sol#L70-L73>\n\nCalling the `AstariaRouter.withdraw` function calls the following `ERC4626RouterBase.withdraw` function; however, calling `ERC4626RouterBase.withdraw` function for a private vault reverts because the `Vault` contract does not have an `approve` function. Directly calling the `Vault.withdraw` function for a private vault can also revert since the `Vault` contract does not have a way to set the allowance for itself to transfer the asset token, which can cause many ERC20 tokens' `transferFrom` function calls to revert when deducting the transfer amount from the allowance. Hence, after depositing some of the asset token in a private vault, the strategist can fail to withdraw this asset token from this private vault and lose this deposit.\n\n<https://github.com/AstariaXYZ/astaria-gpl/blob/main/src/ERC4626RouterBase.sol#L41-L52>\n\n```solidity\n  function withdraw(\n    IERC4626 vault,\n    address to,\n    uint256 amount,\n    uint256 maxSharesOut\n  ) public payable virtual override returns (uint256 sharesOut) {\n\n    ERC20(address(vault)).safeApprove(address(vault), amount);\n    if ((sharesOut = vault.withdraw(amount, to, msg.sender)) > maxSharesOut) {\n      revert MaxSharesError();\n    }\n  }\n```\n\n<https://github.com/code-423n4/2023-01-astaria/blob/main/src/Vault.sol#L70-L73>\n\n```solidity\n  function withdraw(uint256 amount) external {\n    require(msg.sender == owner());\n    ERC20(asset()).safeTransferFrom(address(this), msg.sender, amount);\n  }\n```\n\n### Proof of Concept\n\nPlease add the following test in `src\\test\\AstariaTest.t.sol`. This test will pass to demonstrate the described scenario.\n\n```solidity\n  function testPrivateVaultStrategistIsUnableToWithdraw() public {\n    uint256 amountToLend = 50 ether;\n    vm.deal(strategistOne, amountToLend);\n\n    address privateVault = _createPrivateVault({\n      strategist: strategistOne,\n      delegate: strategistTwo\n    });\n\n    vm.startPrank(strategistOne);\n\n    WETH9.deposit{value: amountToLend}();\n    WETH9.approve(privateVault, amountToLend);\n\n    // strategistOne deposits 50 ether WETH to privateVault\n    Vault(privateVault).deposit(amountToLend, strategistOne);\n\n    // calling router's withdraw function for withdrawing assets from privateVault reverts\n    vm.expectRevert(bytes(\"APPROVE_FAILED\"));\n    ASTARIA_ROUTER.withdraw(\n      IERC4626(privateVault),\n      strategistOne,\n      amountToLend,\n      type(uint256).max\n    );\n\n    // directly withdrawing various asset amounts from privateVault also fails\n    vm.expectRevert(bytes(\"TRANSFER_FROM_FAILED\"));\n    Vault(privateVault).withdraw(amountToLend);\n\n    vm.expectRevert(bytes(\"TRANSFER_FROM_FAILED\"));\n    Vault(privateVault).withdraw(1);\n\n    vm.stopPrank();\n  }\n```\n\n### Tools Used\n\nVSCode\n\n### Recommended Mitigation Steps\n\n<https://github.com/code-423n4/2023-01-astaria/blob/main/src/Vault.sol#L72> can be updated to the following code.\n\n```solidity\n    ERC20(asset()).safeTransfer(msg.sender, amount);\n```\n\n**[SantiagoGregory (Astaria) confirmed](https://github.com/code-423n4/2023-01-astaria-findings/issues/489)**\n\n\n\n***\n\n",
  "Impact": "HIGH",
  "Source": "https://code4rena.com/reports/2023-01-astaria",
  "Code": [
    {
      "filename": "src/Vault.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\n\n/**                                                     \n*  █████╗ ███████╗████████╗ █████╗ ██████╗ ██╗ █████╗ \n* ██╔══██╗██╔════╝╚══██╔══╝██╔══██╗██╔══██╗██║██╔══██╗\n* ███████║███████╗   ██║   ███████║██████╔╝██║███████║\n* ██╔══██║╚════██║   ██║   ██╔══██║██╔══██╗██║██╔══██║\n* ██║  ██║███████║   ██║   ██║  ██║██║  ██║██║██║  ██║\n* ╚═╝  ╚═╝╚══════╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝\n*\n* Astaria Labs, Inc\n*/\n\npragma solidity =0.8.17;\n\nimport {ERC20} from \"solmate/tokens/ERC20.sol\";\nimport {SafeTransferLib} from \"solmate/utils/SafeTransferLib.sol\";\n\nimport {IERC165} from \"core/interfaces/IERC165.sol\";\nimport {VaultImplementation} from \"core/VaultImplementation.sol\";\n\n/**\n * @title Vault\n */\ncontract Vault is VaultImplementation {\n  using SafeTransferLib for ERC20;\n\n  function name()\n    public\n    view\n    virtual\n    override(VaultImplementation)\n    returns (string memory)\n  {\n    return string(abi.encodePacked(\"AST-Vault-\", ERC20(asset()).symbol()));\n  }\n\n  function symbol()\n    public\n    view\n    virtual\n    override(VaultImplementation)\n    returns (string memory)\n  {\n    return\n      string(abi.encodePacked(\"AST-V\", owner(), \"-\", ERC20(asset()).symbol()));\n  }\n\n  function supportsInterface(bytes4)\n    public\n    pure\n    virtual\n    override(IERC165)\n    returns (bool)\n  {\n    return false;\n  }\n\n  function deposit(uint256 amount, address receiver)\n    public\n    virtual\n    returns (uint256)\n  {\n    VIData storage s = _loadVISlot();\n    require(s.allowList[msg.sender] && receiver == owner());\n    ERC20(asset()).safeTransferFrom(msg.sender, address(this), amount);\n    return amount;\n  }\n\n  function withdraw(uint256 amount) external {\n    require(msg.sender == owner());\n    ERC20(asset()).safeTransferFrom(address(this), msg.sender, amount);\n  }\n\n  function disableAllowList() external pure override(VaultImplementation) {\n    //invalid action allowlist must be enabled for private vaults\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n\n  function enableAllowList() external pure override(VaultImplementation) {\n    //invalid action allowlist must be enabled for private vaults\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n\n  function modifyAllowList(address, bool)\n    external\n    pure\n    override(VaultImplementation)\n  {\n    //invalid action private vautls can only be the owner or strategist\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n}"
    },
    {
      "filename": "src/Vault.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\n\n/**                                                     \n*  █████╗ ███████╗████████╗ █████╗ ██████╗ ██╗ █████╗ \n* ██╔══██╗██╔════╝╚══██╔══╝██╔══██╗██╔══██╗██║██╔══██╗\n* ███████║███████╗   ██║   ███████║██████╔╝██║███████║\n* ██╔══██║╚════██║   ██║   ██╔══██║██╔══██╗██║██╔══██║\n* ██║  ██║███████║   ██║   ██║  ██║██║  ██║██║██║  ██║\n* ╚═╝  ╚═╝╚══════╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝\n*\n* Astaria Labs, Inc\n*/\n\npragma solidity =0.8.17;\n\nimport {ERC20} from \"solmate/tokens/ERC20.sol\";\nimport {SafeTransferLib} from \"solmate/utils/SafeTransferLib.sol\";\n\nimport {IERC165} from \"core/interfaces/IERC165.sol\";\nimport {VaultImplementation} from \"core/VaultImplementation.sol\";\n\n/**\n * @title Vault\n */\ncontract Vault is VaultImplementation {\n  using SafeTransferLib for ERC20;\n\n  function name()\n    public\n    view\n    virtual\n    override(VaultImplementation)\n    returns (string memory)\n  {\n    return string(abi.encodePacked(\"AST-Vault-\", ERC20(asset()).symbol()));\n  }\n\n  function symbol()\n    public\n    view\n    virtual\n    override(VaultImplementation)\n    returns (string memory)\n  {\n    return\n      string(abi.encodePacked(\"AST-V\", owner(), \"-\", ERC20(asset()).symbol()));\n  }\n\n  function supportsInterface(bytes4)\n    public\n    pure\n    virtual\n    override(IERC165)\n    returns (bool)\n  {\n    return false;\n  }\n\n  function deposit(uint256 amount, address receiver)\n    public\n    virtual\n    returns (uint256)\n  {\n    VIData storage s = _loadVISlot();\n    require(s.allowList[msg.sender] && receiver == owner());\n    ERC20(asset()).safeTransferFrom(msg.sender, address(this), amount);\n    return amount;\n  }\n\n  function withdraw(uint256 amount) external {\n    require(msg.sender == owner());\n    ERC20(asset()).safeTransferFrom(address(this), msg.sender, amount);\n  }\n\n  function disableAllowList() external pure override(VaultImplementation) {\n    //invalid action allowlist must be enabled for private vaults\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n\n  function enableAllowList() external pure override(VaultImplementation) {\n    //invalid action allowlist must be enabled for private vaults\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n\n  function modifyAllowList(address, bool)\n    external\n    pure\n    override(VaultImplementation)\n  {\n    //invalid action private vautls can only be the owner or strategist\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n}"
    },
    {
      "filename": "src/Vault.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\n\n/**                                                     \n*  █████╗ ███████╗████████╗ █████╗ ██████╗ ██╗ █████╗ \n* ██╔══██╗██╔════╝╚══██╔══╝██╔══██╗██╔══██╗██║██╔══██╗\n* ███████║███████╗   ██║   ███████║██████╔╝██║███████║\n* ██╔══██║╚════██║   ██║   ██╔══██║██╔══██╗██║██╔══██║\n* ██║  ██║███████║   ██║   ██║  ██║██║  ██║██║██║  ██║\n* ╚═╝  ╚═╝╚══════╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝\n*\n* Astaria Labs, Inc\n*/\n\npragma solidity =0.8.17;\n\nimport {ERC20} from \"solmate/tokens/ERC20.sol\";\nimport {SafeTransferLib} from \"solmate/utils/SafeTransferLib.sol\";\n\nimport {IERC165} from \"core/interfaces/IERC165.sol\";\nimport {VaultImplementation} from \"core/VaultImplementation.sol\";\n\n/**\n * @title Vault\n */\ncontract Vault is VaultImplementation {\n  using SafeTransferLib for ERC20;\n\n  function name()\n    public\n    view\n    virtual\n    override(VaultImplementation)\n    returns (string memory)\n  {\n    return string(abi.encodePacked(\"AST-Vault-\", ERC20(asset()).symbol()));\n  }\n\n  function symbol()\n    public\n    view\n    virtual\n    override(VaultImplementation)\n    returns (string memory)\n  {\n    return\n      string(abi.encodePacked(\"AST-V\", owner(), \"-\", ERC20(asset()).symbol()));\n  }\n\n  function supportsInterface(bytes4)\n    public\n    pure\n    virtual\n    override(IERC165)\n    returns (bool)\n  {\n    return false;\n  }\n\n  function deposit(uint256 amount, address receiver)\n    public\n    virtual\n    returns (uint256)\n  {\n    VIData storage s = _loadVISlot();\n    require(s.allowList[msg.sender] && receiver == owner());\n    ERC20(asset()).safeTransferFrom(msg.sender, address(this), amount);\n    return amount;\n  }\n\n  function withdraw(uint256 amount) external {\n    require(msg.sender == owner());\n    ERC20(asset()).safeTransferFrom(address(this), msg.sender, amount);\n  }\n\n  function disableAllowList() external pure override(VaultImplementation) {\n    //invalid action allowlist must be enabled for private vaults\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n\n  function enableAllowList() external pure override(VaultImplementation) {\n    //invalid action allowlist must be enabled for private vaults\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n\n  function modifyAllowList(address, bool)\n    external\n    pure\n    override(VaultImplementation)\n  {\n    //invalid action private vautls can only be the owner or strategist\n    revert InvalidRequest(InvalidRequestReason.NO_AUTHORITY);\n  }\n}"
    }
  ]
}