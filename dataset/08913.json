{
  "Title": "[M-02] VE3DRewardPool.sol is incompatible with Bal/veBal",
  "Content": "_Submitted by 0x52_\n\n`getReward` will become completely unusable if bal is added as an support asset.\n\n### Proof of Concept\n\nveBal is not staked bal, it is staked 80-20 bal/eth LP. Rewards from gauges are paid in bal NOT 80-20 bal/eth LP. All rewards to this address will be received as bal. If the contract tries to deposit bal directly it will fail, causing getReward to always revert if bal is a supported asset (as all documentation conveys that it will be).\n\n### Recommended Mitigation Steps\n\nExclude veBal/Bal as a supported asset or create a special wrapper for Bal that adds the Bal as one sided liquidity then stakes the LP.\n\n**[solvetony (veToken Finance) disputed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/53#issuecomment-1156605217):**\n > Out of the scope, Balancer. But we need to consider this, once we start working on these.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/53#issuecomment-1189659591):**\n > The finding shows how the code cannot support veBAL.\n> \n> In the specific case of veBAL, the deposit token is 80/20 BAL but the reward is BAL, meaning the function will eventually revert.\n> \n> This is conditional on the token being the BAL token, which means the finding cannot be of High Severity (conditional on configuration).\n> \n> The sponsor claims that Balancer will not be used, and that may be the case, however the [README for the contest](https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/README.md#L20) does include BAL and for that reason I think the finding is Valid and of Medium Severity.\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/contests/2022-05-vetoken-finance-contest",
  "Code": [
    {
      "filename": "README.md",
      "content": "# veToken Finance contest details\n- $71,250 USDT main award pot\n- $3,750 USDT gas optimization award pot\n- Join [C4 Discord](https://discord.gg/code4rena) to register\n- Submit findings [using the C4 form](https://code4rena.com/contests/2022-05-vetoken-finance-contest/submit)\n- [Read our guidelines for more details](https://docs.code4rena.com/roles/wardens)\n- Starts May 26, 2022 20:00 UTC\n- Ends June 2, 2022 19:59 UTC\n\n## About veToken Finance\n\nveToken Finance is an forked version of the convex yield protocol that targets all ve-model projects \n\n## veToken-contracts\n\n##### keywords\n- veAsset projects: the projects which protocols interact with in order to let users get maximum yield from them (Curve, Pickle, Ribbon, Idle, Angle, Balancer)\n- veAsset token: the main token of the veAsset project (crv, pickle, rbn, idle, angle, bal)\n- veToken: governance token issued by veToken Finance ($VE3D)\n- ve3Token: tokenized veAsset token created by veToken finance (ve3CRV, ve3Dill, ve3RBN, ve3IDLE, ve3ANGLE, ve3BAL) \n\n## Contracts Of Interest\n- VeAssetDepositor\n  - this contract allows users to lock their veAsset token like crv, pickle, ribbon...etc \n  - users get VE3Token in exchange\n  - users can stake VE3Token in the base reward pool\n  - the veAsset token deposited to the contract , will be transferred to external locking contract (voting escrow) of each veAsset project by VoterProxy contract \n  - the user who calls the lock function will get some incentives to cover the gas cost \n  - platform gets a reward (fee token) for locking veAsset from veAsset projects from their fee distro contract \n  - for each veAsset project, there will be a dedicated VeAssetDepositor contract deployed.\n   \n- Booster\n  - this contract allows users to deposit lp tokens getting from veAsset projects\n  - users get another new token in exchange (token name is concatenated from lp token name + \"veToken Deposit\")\n  - users can stake the new token in the base reward pool \n  - the lp token deposited to the contract, will be transferred to external gauges of each veAsset project by VoterProxy contract \n  - platform gets rewards (as veAsset token) for depositing lp token to gauges \n  - the user who calls the function for collecting the rewards from gauges, will get some incentives to cover the gas cost \n  - the rewards (veAsset token) collected from gauges are distributed 20% max among caller, lock reward pool, ve3d token staker pool , fee platform and ve3d token locking pool , 80% is distributed to reward pools of lp tokens\n  - for each veAsset project, there will be a dedicated Booster contract deployed.\n\n- BaseRewardPool\n  - this contract allows users to stake their VE3Token which they get when depositing their veAsset token in VeAssetDepositor contract\n  - this contract also allows users to stake the new token they get in exchange when depositing lp token to the Booster contract. For each new token representing a lp pool, a new instance of this contract will be created by reward factory contract.\n  - for reward pool of VE3token , it collects a portion (configurable) of veAsset token collected from gauges + fee token collected from fee distro contract as extra reward \n  - for reward pool of lp token, it collects no less than 80% of veAsset token collected from gauges   \n  - there are extra pools which added to the reward pool for extra reward tokens collected from veAsset project\n  - when a user claims rewards , a certain amount of veToken will be minted based on formula  \n  - it is one contract instance for each veAsset project , and one for each lp token\n\n- VE3DRewardPool   \n  - this contract allows users to stake veToken token \n  - it gets a portion (configurable) of veAsset token collected from gauges for all projects \n  - when a user claim s rewards , the contract will lock his veAsset rewards in VeAssetDepositor contract and mint him VE3Tokens with option to stake them in base reward pool\n  - There is only one contract for the platform\n \n- VoterProxy\n  - this contract handles all deposits into VotingEscrow and into the gauges. This is the address that has the voting power.\n\n- veTokenMinter\n  - This contract handles addional rewards when user claim veAsset rewards (PICKLE, CURVE, etc)  \n  \n## Flow chart\n\n![VeToken Flow for audit](https://user-images.githubusercontent.com/77819086/170293893-6ae4d27f-b21d-42a9-be16-6f2f610191d1.png)\n\n### For ve-model token stakes  (vePickle, veAngle etc)\nve3Token is tokenized for veAsset. And locked veAsset kept in projects’s VotingEscrow .  ve3Token can be obtained by deposit veAsset (Angle, PICKLE, etc) to Depositor.  And user can stake ve3Token through base reward pool to get rewards.   \n\n \n### For liquidity providers\n\nLP tokens are received for depositing assets into veAsset farming pools or liquidity pools ( eg: Deposit liquidity into the angle pool without staking in the angle gauge) . And LP Token then deposited to Booster contracts and receives TOKEN (VE3DlpToken). And this TOKEN can stake into the BaseRewardPool in order to receive boosted rewards. Once deposited in the Booster. The LP tokens will be sent through VoterProxy which then deposits into their corresponding gauges.\n\nRewards can be harvested by calling earmarkRewards and earmarkFees on the Booster contract for a specific pool. This then calls claimVeAsset\n (claims Fees), claimRewards (claims any additional reward tokens registered for the gauge) and claimFees (claims pool fees from the fee distro). The caller of earmarkRewards and earmarkFees is paid an incentive to do so.\n\n\n### Voting\n\nEach voting proxy has the voting power for corresponding projects. And it delegates to veToken Fiannce DAO and vote through projects’ snapshot. Voting hashes are set on the VoterProxy through Booster with EIP-1271 signatures \n\n\n## Class diagram\n\n\n\n![Vetoekn-Finance-CD-Main Contracts](https://user-images.githubusercontent.com/77819086/170214459-c6857ac3-1199-4872-b876-60a65fbd25be.svg)\n![Vetoekn-Finance-CD-Reward Contracts](https://user-images.githubusercontent.com/77819086/170215780-a9e9b605-492a-4a04-8069-cea2413b2e98.svg)\n![Vetoekn-Finance-CD-Factory](https://user-images.githubusercontent.com/77819086/170216085-2856ddd9-97ef-4e3b-9cca-994bd63e25e5.svg)\n\n# Running tests\n\n### set up\n\n`npm ci`\n\n`truffle compile`\n\n`set up config keys in secret.json based on secret-copy.json`\n\n### deploy idle\n\n`npm run idle_network`\n\n`npm run deploy-basic-contract && npm run deploy-local-idle`\n\n### deploy angle\n\n`npm run angle_network`\n\n`npm run deploy-basic-contract && npm run deploy-local-angle`\n\n\n### test all\n\n`npm run test-no-deploy`\n\n> **Note:** all deployed addresses will be in contracts.json file"
    }
  ]
}