{
  "Title": "[G-05] Forgo internal function to save 1 `STATICCALL`",
  "Content": "The `_context` internal function performs two external calls and returns both of the return values from those calls. Certain functions invoke `_context` but only use the return value from the first external call, thus performing an unnecessary extra external call. We can forgo using the internal function and instead only perform our desired external call to save 1 `STATICCALL (100 gas)`.\n\nTotal Instances: `4`\n\nEstimated Gas Saved: `4 * 100 = 400`\n\nhttps://github.com/code-423n4/2023-06-llama/blob/main/src/llama-scripts/LlamaGovernanceScript.sol#L111-L115\n\n### Only perform `address(this).LLAMA_CORE()` to save 1 `STATICCALL`\n```solidity\nFile: src/llama-scripts/LlamaGovernanceScript.sol\n111:  function createNewStrategiesAndSetRoleHolders(\n112:    CreateStrategies calldata _createStrategies,\n113:    RoleHolderData[] calldata _setRoleHolders\n114:  ) external onlyDelegateCall {\n115:    (LlamaCore core,) = _context(); // @audit: return value from `core.policy()` is not being used\n```\n```diff\ndiff --git a/src/llama-scripts/LlamaGovernanceScript.sol b/src/llama-scripts/LlamaGovernanceScript.sol\nindex 820872e..f886bf7 100644\n--- a/src/llama-scripts/LlamaGovernanceScript.sol\n+++ b/src/llama-scripts/LlamaGovernanceScript.sol\n@@ -112,7 +112,7 @@ contract LlamaGovernanceScript is LlamaBaseScript {\n     CreateStrategies calldata _createStrategies,\n     RoleHolderData[] calldata _setRoleHolders\n   ) external onlyDelegateCall {\n-    (LlamaCore core,) = _context();\n+    LlamaCore core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n     core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n     setRoleHolders(_setRoleHolders);\n   }\n```\n\nhttps://github.com/code-423n4/2023-06-llama/blob/main/src/llama-scripts/LlamaGovernanceScript.sol#L120-L125\n\n### Only perform `address(this).LLAMA_CORE()` to save 1 `STATICCALL` \n```solidity\nFile: src/llama-scripts/LlamaGovernanceScript.sol\n120:  function createNewStrategiesAndInitializeRolesAndSetRoleHolders(\n121:    CreateStrategies calldata _createStrategies,\n122:    RoleDescription[] calldata description,\n123:    RoleHolderData[] calldata _setRoleHolders\n124:  ) external onlyDelegateCall {\n125:    (LlamaCore core,) = _context(); // @audit: return value from `core.policy()` is not being used\n```\n```diff\ndiff --git a/src/llama-scripts/LlamaGovernanceScript.sol b/src/llama-scripts/LlamaGovernanceScript.sol\nindex 820872e..f886bf7 100644\n--- a/src/llama-scripts/LlamaGovernanceScript.sol\n+++ b/src/llama-scripts/LlamaGovernanceScript.sol\n@@ -122,7 +122,7 @@ contract LlamaGovernanceScript is LlamaBaseScript {\n     RoleDescription[] calldata description,\n     RoleHolderData[] calldata _setRoleHolders\n   ) external onlyDelegateCall {\n-    (LlamaCore core,) = _context();\n+    LlamaCore core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n     core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n     initializeRoles(description);\n     setRoleHolders(_setRoleHolders);\n```\n\nhttps://github.com/code-423n4/2023-06-llama/blob/main/src/llama-scripts/LlamaGovernanceScript.sol#L131-L135\n\n### Only perform `address(this).LLAMA_CORE()` to save 1 `STATICCALL`\n```solidity\nFile: src/llama-scripts/LlamaGovernanceScript.sol\n131:  function createNewStrategiesAndSetRolePermissions(\n132:    CreateStrategies calldata _createStrategies,\n133:    RolePermissionData[] calldata _setRolePermissions\n134:  ) external onlyDelegateCall {\n135:    (LlamaCore core,) = _context(); // @audit: return value from `core.policy()` is not being used\n```\n```diff\ndiff --git a/src/llama-scripts/LlamaGovernanceScript.sol b/src/llama-scripts/LlamaGovernanceScript.sol\nindex 820872e..f886bf7 100644\n--- a/src/llama-scripts/LlamaGovernanceScript.sol\n+++ b/src/llama-scripts/LlamaGovernanceScript.sol\n@@ -132,7 +132,7 @@ contract LlamaGovernanceScript is LlamaBaseScript {\n     CreateStrategies calldata _createStrategies,\n     RolePermissionData[] calldata _setRolePermissions\n   ) external onlyDelegateCall {\n-    (LlamaCore core,) = _context();\n+    LlamaCore core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n     core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n     setRolePermissions(_setRolePermissions);\n   }\n```\n\nhttps://github.com/code-423n4/2023-06-llama/blob/main/src/llama-scripts/LlamaGovernanceScript.sol#L140-L146\n\n### Only perform `address(this).LLAMA_CORE()` to save 1 `STATICCALL` \n```solidity\nFile: src/llama-scripts/LlamaGovernanceScript.sol\n140:  function createNewStrategiesAndNewRolesAndSetRoleHoldersAndSetRolePermissions(\n141:    CreateStrategies calldata _createStrategies,\n142:    RoleDescription[] calldata description,\n143:    RoleHolderData[] calldata _setRoleHolders,\n144:    RolePermissionData[] calldata _setRolePermissions\n145:  ) external onlyDelegateCall {\n146:    (LlamaCore core,) = _context(); // @audit: return value from `core.policy()` is not being used\n```\n```diff\ndiff --git a/src/llama-scripts/LlamaGovernanceScript.sol b/src/llama-scripts/LlamaGovernanceScript.sol\nindex 820872e..f886bf7 100644\n--- a/src/llama-scripts/LlamaGovernanceScript.sol\n+++ b/src/llama-scripts/LlamaGovernanceScript.sol\n@@ -143,7 +143,7 @@ contract LlamaGovernanceScript is LlamaBaseScript {\n     RoleHolderData[] calldata _setRoleHolders,\n     RolePermissionData[] calldata _setRolePermissions\n   ) external onlyDelegateCall {\n-    (LlamaCore core,) = _context();\n+    LlamaCore core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n     core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n     initializeRoles(description);\n     setRoleHolders(_setRoleHolders);\n```\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/reports/2023-06-llama",
  "Code": [
    {
      "filename": "src/llama-scripts/LlamaGovernanceScript.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.19;\n\nimport {LlamaBaseScript} from \"src/llama-scripts/LlamaBaseScript.sol\";\nimport {ILlamaStrategy} from \"src/interfaces/ILlamaStrategy.sol\";\nimport {LlamaCore} from \"src/LlamaCore.sol\";\nimport {LlamaExecutor} from \"src/LlamaExecutor.sol\";\nimport {LlamaPolicy} from \"src/LlamaPolicy.sol\";\nimport {LlamaUtils} from \"src/lib/LlamaUtils.sol\";\nimport {RoleHolderData, RolePermissionData} from \"src/lib/Structs.sol\";\nimport {RoleDescription} from \"src/lib/UDVTs.sol\";\n\n/// @title Llama Governance Script\n/// @author Llama (devsdosomething@llama.xyz)\n/// @notice A script that allows users to aggregate common calls on the core and policy contracts.\n/// @notice How to use this script:\n///   - The `aggregate` method is for ignoring all the functions in the contract and crafting your own payload. This\n///     method only allows `LlamaCore` and `LlamaExecutor` as targets.\n///   - The \"Batch Policy Functions\" section has public methods that (1) can be called directly as part of an action,\n///     and (2) are also used by methods in the \"Common Aggregate Calls\" section.\n///   - The \"Common Aggregate Calls\" section has external methods for common batch actions.\ncontract LlamaGovernanceScript is LlamaBaseScript {\n  // ==========================\n  // ========= Structs ========\n  // ==========================\n\n  /// @dev Struct for holding data for the `updateRoleDescription` method in `LlamaPolicy`.\n  struct UpdateRoleDescription {\n    uint8 role; // Role to update.\n    RoleDescription description; // New role description.\n  }\n\n  /// @dev Struct for holding data for the `createStrategies` method in `LlamaCore`.\n  struct CreateStrategies {\n    ILlamaStrategy llamaStrategyLogic; // Logic contract for the strategies.\n    bytes[] strategies; // Array of configurations to initialize new strategies with.\n  }\n\n  // ========================\n  // ======== Errors ========\n  // ========================\n\n  /// @dev The call did not succeed.\n  /// @param index Index of the arbitrary function being called.\n  /// @param revertData Data returned by the called function.\n  error CallReverted(uint256 index, bytes revertData);\n\n  /// @dev The provided arrays do not have the same length.\n  error MismatchedArrayLengths();\n\n  /// @dev The target address is neither the `LlamaCore` nor the `LlamaPolicy`.\n  /// @param target The target address provided.\n  error UnauthorizedTarget(address target);\n\n  // =======================================\n  // ======== Arbitrary Aggregation ========\n  // =======================================\n\n  /// @notice This method should be assigned carefully, since it allows for arbitrary calls to be made within the\n  /// context of `LlamaCore` since this script will be delegatecalled. It is safer to permission out the functions below\n  /// as needed than to permission the aggregate function itself.\n  function aggregate(address[] calldata targets, bytes[] calldata data)\n    external\n    onlyDelegateCall\n    returns (bytes[] memory returnData)\n  {\n    if (targets.length != data.length) revert MismatchedArrayLengths();\n    (LlamaCore core, LlamaPolicy policy) = _context();\n    uint256 length = data.length;\n    returnData = new bytes[](length);\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      bool addressIsCore = targets[i] == address(core);\n      bool addressIsPolicy = targets[i] == address(policy);\n      if (!addressIsCore && !addressIsPolicy) revert UnauthorizedTarget(targets[i]);\n      (bool success, bytes memory response) = targets[i].call(data[i]);\n      if (!success) revert CallReverted(i, response);\n      returnData[i] = response;\n    }\n  }\n\n  // ========================================\n  // ======== Common Aggregate Calls ========\n  // ========================================\n\n  function initializeRolesAndSetRoleHolders(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function initializeRolesAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function initializeRolesAndSetRoleHoldersAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function createNewStrategiesAndSetRoleHolders(\n    CreateStrategies calldata _createStrategies,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function createNewStrategiesAndInitializeRolesAndSetRoleHolders(\n    CreateStrategies calldata _createStrategies,\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function createNewStrategiesAndSetRolePermissions(\n    CreateStrategies calldata _createStrategies,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function createNewStrategiesAndNewRolesAndSetRoleHoldersAndSetRolePermissions(\n    CreateStrategies calldata _createStrategies,\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function revokePoliciesAndUpdateRoleDescriptions(\n    address[] calldata _revokePolicies,\n    UpdateRoleDescription[] calldata _updateRoleDescriptions\n  ) external onlyDelegateCall {\n    revokePolicies(_revokePolicies);\n    updateRoleDescriptions(_updateRoleDescriptions);\n  }\n\n  function revokePoliciesAndUpdateRoleDescriptionsAndSetRoleHolders(\n    address[] calldata _revokePolicies,\n    UpdateRoleDescription[] calldata _updateRoleDescriptions,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    revokePolicies(_revokePolicies);\n    updateRoleDescriptions(_updateRoleDescriptions);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  // ========================================\n  // ======== Batch Policy Functions ========\n  // ========================================\n\n  function initializeRoles(RoleDescription[] calldata description) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = description.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.initializeRole(description[i]);\n    }\n  }\n\n  function setRoleHolders(RoleHolderData[] calldata _setRoleHolders) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = _setRoleHolders.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.setRoleHolder(\n        _setRoleHolders[i].role,\n        _setRoleHolders[i].policyholder,\n        _setRoleHolders[i].quantity,\n        _setRoleHolders[i].expiration\n      );\n    }\n  }\n\n  function setRolePermissions(RolePermissionData[] calldata _setRolePermissions) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = _setRolePermissions.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.setRolePermission(\n        _setRolePermissions[i].role, _setRolePermissions[i].permissionId, _setRolePermissions[i].hasPermission\n      );\n    }\n  }\n\n  /// @notice if the roles array is empty, it will revoke all roles iteratively. Pass all roles in as an array otherwise\n  /// if the policyholder has too many roles.\n  function revokePolicies(address[] calldata _revokePolicies) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    for (uint256 i = 0; i < _revokePolicies.length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.revokePolicy(_revokePolicies[i]);\n    }\n  }\n\n  function updateRoleDescriptions(UpdateRoleDescription[] calldata roleDescriptions) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    for (uint256 i = 0; i < roleDescriptions.length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.updateRoleDescription(roleDescriptions[i].role, roleDescriptions[i].description);\n    }\n  }\n\n  function _context() internal view returns (LlamaCore core, LlamaPolicy policy) {\n    core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n    policy = LlamaPolicy(core.policy());\n  }\n}"
    },
    {
      "filename": "src/llama-scripts/LlamaGovernanceScript.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.19;\n\nimport {LlamaBaseScript} from \"src/llama-scripts/LlamaBaseScript.sol\";\nimport {ILlamaStrategy} from \"src/interfaces/ILlamaStrategy.sol\";\nimport {LlamaCore} from \"src/LlamaCore.sol\";\nimport {LlamaExecutor} from \"src/LlamaExecutor.sol\";\nimport {LlamaPolicy} from \"src/LlamaPolicy.sol\";\nimport {LlamaUtils} from \"src/lib/LlamaUtils.sol\";\nimport {RoleHolderData, RolePermissionData} from \"src/lib/Structs.sol\";\nimport {RoleDescription} from \"src/lib/UDVTs.sol\";\n\n/// @title Llama Governance Script\n/// @author Llama (devsdosomething@llama.xyz)\n/// @notice A script that allows users to aggregate common calls on the core and policy contracts.\n/// @notice How to use this script:\n///   - The `aggregate` method is for ignoring all the functions in the contract and crafting your own payload. This\n///     method only allows `LlamaCore` and `LlamaExecutor` as targets.\n///   - The \"Batch Policy Functions\" section has public methods that (1) can be called directly as part of an action,\n///     and (2) are also used by methods in the \"Common Aggregate Calls\" section.\n///   - The \"Common Aggregate Calls\" section has external methods for common batch actions.\ncontract LlamaGovernanceScript is LlamaBaseScript {\n  // ==========================\n  // ========= Structs ========\n  // ==========================\n\n  /// @dev Struct for holding data for the `updateRoleDescription` method in `LlamaPolicy`.\n  struct UpdateRoleDescription {\n    uint8 role; // Role to update.\n    RoleDescription description; // New role description.\n  }\n\n  /// @dev Struct for holding data for the `createStrategies` method in `LlamaCore`.\n  struct CreateStrategies {\n    ILlamaStrategy llamaStrategyLogic; // Logic contract for the strategies.\n    bytes[] strategies; // Array of configurations to initialize new strategies with.\n  }\n\n  // ========================\n  // ======== Errors ========\n  // ========================\n\n  /// @dev The call did not succeed.\n  /// @param index Index of the arbitrary function being called.\n  /// @param revertData Data returned by the called function.\n  error CallReverted(uint256 index, bytes revertData);\n\n  /// @dev The provided arrays do not have the same length.\n  error MismatchedArrayLengths();\n\n  /// @dev The target address is neither the `LlamaCore` nor the `LlamaPolicy`.\n  /// @param target The target address provided.\n  error UnauthorizedTarget(address target);\n\n  // =======================================\n  // ======== Arbitrary Aggregation ========\n  // =======================================\n\n  /// @notice This method should be assigned carefully, since it allows for arbitrary calls to be made within the\n  /// context of `LlamaCore` since this script will be delegatecalled. It is safer to permission out the functions below\n  /// as needed than to permission the aggregate function itself.\n  function aggregate(address[] calldata targets, bytes[] calldata data)\n    external\n    onlyDelegateCall\n    returns (bytes[] memory returnData)\n  {\n    if (targets.length != data.length) revert MismatchedArrayLengths();\n    (LlamaCore core, LlamaPolicy policy) = _context();\n    uint256 length = data.length;\n    returnData = new bytes[](length);\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      bool addressIsCore = targets[i] == address(core);\n      bool addressIsPolicy = targets[i] == address(policy);\n      if (!addressIsCore && !addressIsPolicy) revert UnauthorizedTarget(targets[i]);\n      (bool success, bytes memory response) = targets[i].call(data[i]);\n      if (!success) revert CallReverted(i, response);\n      returnData[i] = response;\n    }\n  }\n\n  // ========================================\n  // ======== Common Aggregate Calls ========\n  // ========================================\n\n  function initializeRolesAndSetRoleHolders(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function initializeRolesAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function initializeRolesAndSetRoleHoldersAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function createNewStrategiesAndSetRoleHolders(\n    CreateStrategies calldata _createStrategies,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function createNewStrategiesAndInitializeRolesAndSetRoleHolders(\n    CreateStrategies calldata _createStrategies,\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function createNewStrategiesAndSetRolePermissions(\n    CreateStrategies calldata _createStrategies,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function createNewStrategiesAndNewRolesAndSetRoleHoldersAndSetRolePermissions(\n    CreateStrategies calldata _createStrategies,\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function revokePoliciesAndUpdateRoleDescriptions(\n    address[] calldata _revokePolicies,\n    UpdateRoleDescription[] calldata _updateRoleDescriptions\n  ) external onlyDelegateCall {\n    revokePolicies(_revokePolicies);\n    updateRoleDescriptions(_updateRoleDescriptions);\n  }\n\n  function revokePoliciesAndUpdateRoleDescriptionsAndSetRoleHolders(\n    address[] calldata _revokePolicies,\n    UpdateRoleDescription[] calldata _updateRoleDescriptions,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    revokePolicies(_revokePolicies);\n    updateRoleDescriptions(_updateRoleDescriptions);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  // ========================================\n  // ======== Batch Policy Functions ========\n  // ========================================\n\n  function initializeRoles(RoleDescription[] calldata description) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = description.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.initializeRole(description[i]);\n    }\n  }\n\n  function setRoleHolders(RoleHolderData[] calldata _setRoleHolders) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = _setRoleHolders.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.setRoleHolder(\n        _setRoleHolders[i].role,\n        _setRoleHolders[i].policyholder,\n        _setRoleHolders[i].quantity,\n        _setRoleHolders[i].expiration\n      );\n    }\n  }\n\n  function setRolePermissions(RolePermissionData[] calldata _setRolePermissions) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = _setRolePermissions.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.setRolePermission(\n        _setRolePermissions[i].role, _setRolePermissions[i].permissionId, _setRolePermissions[i].hasPermission\n      );\n    }\n  }\n\n  /// @notice if the roles array is empty, it will revoke all roles iteratively. Pass all roles in as an array otherwise\n  /// if the policyholder has too many roles.\n  function revokePolicies(address[] calldata _revokePolicies) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    for (uint256 i = 0; i < _revokePolicies.length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.revokePolicy(_revokePolicies[i]);\n    }\n  }\n\n  function updateRoleDescriptions(UpdateRoleDescription[] calldata roleDescriptions) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    for (uint256 i = 0; i < roleDescriptions.length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.updateRoleDescription(roleDescriptions[i].role, roleDescriptions[i].description);\n    }\n  }\n\n  function _context() internal view returns (LlamaCore core, LlamaPolicy policy) {\n    core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n    policy = LlamaPolicy(core.policy());\n  }\n}"
    },
    {
      "filename": "src/llama-scripts/LlamaGovernanceScript.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.19;\n\nimport {LlamaBaseScript} from \"src/llama-scripts/LlamaBaseScript.sol\";\nimport {ILlamaStrategy} from \"src/interfaces/ILlamaStrategy.sol\";\nimport {LlamaCore} from \"src/LlamaCore.sol\";\nimport {LlamaExecutor} from \"src/LlamaExecutor.sol\";\nimport {LlamaPolicy} from \"src/LlamaPolicy.sol\";\nimport {LlamaUtils} from \"src/lib/LlamaUtils.sol\";\nimport {RoleHolderData, RolePermissionData} from \"src/lib/Structs.sol\";\nimport {RoleDescription} from \"src/lib/UDVTs.sol\";\n\n/// @title Llama Governance Script\n/// @author Llama (devsdosomething@llama.xyz)\n/// @notice A script that allows users to aggregate common calls on the core and policy contracts.\n/// @notice How to use this script:\n///   - The `aggregate` method is for ignoring all the functions in the contract and crafting your own payload. This\n///     method only allows `LlamaCore` and `LlamaExecutor` as targets.\n///   - The \"Batch Policy Functions\" section has public methods that (1) can be called directly as part of an action,\n///     and (2) are also used by methods in the \"Common Aggregate Calls\" section.\n///   - The \"Common Aggregate Calls\" section has external methods for common batch actions.\ncontract LlamaGovernanceScript is LlamaBaseScript {\n  // ==========================\n  // ========= Structs ========\n  // ==========================\n\n  /// @dev Struct for holding data for the `updateRoleDescription` method in `LlamaPolicy`.\n  struct UpdateRoleDescription {\n    uint8 role; // Role to update.\n    RoleDescription description; // New role description.\n  }\n\n  /// @dev Struct for holding data for the `createStrategies` method in `LlamaCore`.\n  struct CreateStrategies {\n    ILlamaStrategy llamaStrategyLogic; // Logic contract for the strategies.\n    bytes[] strategies; // Array of configurations to initialize new strategies with.\n  }\n\n  // ========================\n  // ======== Errors ========\n  // ========================\n\n  /// @dev The call did not succeed.\n  /// @param index Index of the arbitrary function being called.\n  /// @param revertData Data returned by the called function.\n  error CallReverted(uint256 index, bytes revertData);\n\n  /// @dev The provided arrays do not have the same length.\n  error MismatchedArrayLengths();\n\n  /// @dev The target address is neither the `LlamaCore` nor the `LlamaPolicy`.\n  /// @param target The target address provided.\n  error UnauthorizedTarget(address target);\n\n  // =======================================\n  // ======== Arbitrary Aggregation ========\n  // =======================================\n\n  /// @notice This method should be assigned carefully, since it allows for arbitrary calls to be made within the\n  /// context of `LlamaCore` since this script will be delegatecalled. It is safer to permission out the functions below\n  /// as needed than to permission the aggregate function itself.\n  function aggregate(address[] calldata targets, bytes[] calldata data)\n    external\n    onlyDelegateCall\n    returns (bytes[] memory returnData)\n  {\n    if (targets.length != data.length) revert MismatchedArrayLengths();\n    (LlamaCore core, LlamaPolicy policy) = _context();\n    uint256 length = data.length;\n    returnData = new bytes[](length);\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      bool addressIsCore = targets[i] == address(core);\n      bool addressIsPolicy = targets[i] == address(policy);\n      if (!addressIsCore && !addressIsPolicy) revert UnauthorizedTarget(targets[i]);\n      (bool success, bytes memory response) = targets[i].call(data[i]);\n      if (!success) revert CallReverted(i, response);\n      returnData[i] = response;\n    }\n  }\n\n  // ========================================\n  // ======== Common Aggregate Calls ========\n  // ========================================\n\n  function initializeRolesAndSetRoleHolders(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function initializeRolesAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function initializeRolesAndSetRoleHoldersAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function createNewStrategiesAndSetRoleHolders(\n    CreateStrategies calldata _createStrategies,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function createNewStrategiesAndInitializeRolesAndSetRoleHolders(\n    CreateStrategies calldata _createStrategies,\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function createNewStrategiesAndSetRolePermissions(\n    CreateStrategies calldata _createStrategies,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function createNewStrategiesAndNewRolesAndSetRoleHoldersAndSetRolePermissions(\n    CreateStrategies calldata _createStrategies,\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    (LlamaCore core,) = _context();\n    core.createStrategies(_createStrategies.llamaStrategyLogic, _createStrategies.strategies);\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function revokePoliciesAndUpdateRoleDescriptions(\n    address[] calldata _revokePolicies,\n    UpdateRoleDescription[] calldata _updateRoleDescriptions\n  ) external onlyDelegateCall {\n    revokePolicies(_revokePolicies);\n    updateRoleDescriptions(_updateRoleDescriptions);\n  }\n\n  function revokePoliciesAndUpdateRoleDescriptionsAndSetRoleHolders(\n    address[] calldata _revokePolicies,\n    UpdateRoleDescription[] calldata _updateRoleDescriptions,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    revokePolicies(_revokePolicies);\n    updateRoleDescriptions(_updateRoleDescriptions);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  // ========================================\n  // ======== Batch Policy Functions ========\n  // ========================================\n\n  function initializeRoles(RoleDescription[] calldata description) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = description.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.initializeRole(description[i]);\n    }\n  }\n\n  function setRoleHolders(RoleHolderData[] calldata _setRoleHolders) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = _setRoleHolders.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.setRoleHolder(\n        _setRoleHolders[i].role,\n        _setRoleHolders[i].policyholder,\n        _setRoleHolders[i].quantity,\n        _setRoleHolders[i].expiration\n      );\n    }\n  }\n\n  function setRolePermissions(RolePermissionData[] calldata _setRolePermissions) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    uint256 length = _setRolePermissions.length;\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.setRolePermission(\n        _setRolePermissions[i].role, _setRolePermissions[i].permissionId, _setRolePermissions[i].hasPermission\n      );\n    }\n  }\n\n  /// @notice if the roles array is empty, it will revoke all roles iteratively. Pass all roles in as an array otherwise\n  /// if the policyholder has too many roles.\n  function revokePolicies(address[] calldata _revokePolicies) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    for (uint256 i = 0; i < _revokePolicies.length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.revokePolicy(_revokePolicies[i]);\n    }\n  }\n\n  function updateRoleDescriptions(UpdateRoleDescription[] calldata roleDescriptions) public onlyDelegateCall {\n    (, LlamaPolicy policy) = _context();\n    for (uint256 i = 0; i < roleDescriptions.length; i = LlamaUtils.uncheckedIncrement(i)) {\n      policy.updateRoleDescription(roleDescriptions[i].role, roleDescriptions[i].description);\n    }\n  }\n\n  function _context() internal view returns (LlamaCore core, LlamaPolicy policy) {\n    core = LlamaCore(LlamaExecutor(address(this)).LLAMA_CORE());\n    policy = LlamaPolicy(core.policy());\n  }\n}"
    },
    {
      "filename": "src/llama-scripts/LlamaGovernanceScript.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.19;\n\nimport {LlamaBaseScript} from \"src/llama-scripts/LlamaBaseScript.sol\";\nimport {ILlamaStrategy} from \"src/interfaces/ILlamaStrategy.sol\";\nimport {LlamaCore} from \"src/LlamaCore.sol\";\nimport {LlamaExecutor} from \"src/LlamaExecutor.sol\";\nimport {LlamaPolicy} from \"src/LlamaPolicy.sol\";\nimport {LlamaUtils} from \"src/lib/LlamaUtils.sol\";\nimport {RoleHolderData, RolePermissionData} from \"src/lib/Structs.sol\";\nimport {RoleDescription} from \"src/lib/UDVTs.sol\";\n\n/// @title Llama Governance Script\n/// @author Llama (devsdosomething@llama.xyz)\n/// @notice A script that allows users to aggregate common calls on the core and policy contracts.\n/// @notice How to use this script:\n///   - The `aggregate` method is for ignoring all the functions in the contract and crafting your own payload. This\n///     method only allows `LlamaCore` and `LlamaExecutor` as targets.\n///   - The \"Batch Policy Functions\" section has public methods that (1) can be called directly as part of an action,\n///     and (2) are also used by methods in the \"Common Aggregate Calls\" section.\n///   - The \"Common Aggregate Calls\" section has external methods for common batch actions.\ncontract LlamaGovernanceScript is LlamaBaseScript {\n  // ==========================\n  // ========= Structs ========\n  // ==========================\n\n  /// @dev Struct for holding data for the `updateRoleDescription` method in `LlamaPolicy`.\n  struct UpdateRoleDescription {\n    uint8 role; // Role to update.\n    RoleDescription description; // New role description.\n  }\n\n  /// @dev Struct for holding data for the `createStrategies` method in `LlamaCore`.\n  struct CreateStrategies {\n    ILlamaStrategy llamaStrategyLogic; // Logic contract for the strategies.\n    bytes[] strategies; // Array of configurations to initialize new strategies with.\n  }\n\n  // ========================\n  // ======== Errors ========\n  // ========================\n\n  /// @dev The call did not succeed.\n  /// @param index Index of the arbitrary function being called.\n  /// @param revertData Data returned by the called function.\n  error CallReverted(uint256 index, bytes revertData);\n\n  /// @dev The provided arrays do not have the same length.\n  error MismatchedArrayLengths();\n\n  /// @dev The target address is neither the `LlamaCore` nor the `LlamaPolicy`.\n  /// @param target The target address provided.\n  error UnauthorizedTarget(address target);\n\n  // =======================================\n  // ======== Arbitrary Aggregation ========\n  // =======================================\n\n  /// @notice This method should be assigned carefully, since it allows for arbitrary calls to be made within the\n  /// context of `LlamaCore` since this script will be delegatecalled. It is safer to permission out the functions below\n  /// as needed than to permission the aggregate function itself.\n  function aggregate(address[] calldata targets, bytes[] calldata data)\n    external\n    onlyDelegateCall\n    returns (bytes[] memory returnData)\n  {\n    if (targets.length != data.length) revert MismatchedArrayLengths();\n    (LlamaCore core, LlamaPolicy policy) = _context();\n    uint256 length = data.length;\n    returnData = new bytes[](length);\n    for (uint256 i = 0; i < length; i = LlamaUtils.uncheckedIncrement(i)) {\n      bool addressIsCore = targets[i] == address(core);\n      bool addressIsPolicy = targets[i] == address(policy);\n      if (!addressIsCore && !addressIsPolicy) revert UnauthorizedTarget(targets[i]);\n      (bool success, bytes memory response) = targets[i].call(data[i]);\n      if (!success) revert CallReverted(i, response);\n      returnData[i] = response;\n    }\n  }\n\n  // ========================================\n  // ======== Common Aggregate Calls ========\n  // ========================================\n\n  function initializeRolesAndSetRoleHolders(\n    RoleDescription[] calldata description,\n    RoleHolderData[] calldata _setRoleHolders\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRoleHolders(_setRoleHolders);\n  }\n\n  function initializeRolesAndSetRolePermissions(\n    RoleDescription[] calldata description,\n    RolePermissionData[] calldata _setRolePermissions\n  ) external onlyDelegateCall {\n    initializeRoles(description);\n    setRolePermissions(_setRolePermissions);\n  }\n\n  function initializeRolesAndSetRoleHold"
    }
  ]
}