{
  "Title": "Logic contracts initialization allowed",
  "Content": "The [`Configurator`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/Configurator.sol) contract has an initializable function that is meant to be called by the proxy. However, nothing prevents users from directly calling the [`initialize`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/Configurator.sol#L46) function on the contract implementation. If someone does so, the state of the implementation would be initialized to some meaningful value.\n\n\nWe suggest adding a constructor that sets the version to an incredibly high number so that any attempt to call the implementation at the initialize function would revert with an [`AlreadyInitialized`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/Configurator.sol#L40) error or even a specific one to signal that initializing the implementation is prohibited.\n\n\nLeaving an implementation contract not initialized is generally an insecure pattern to follow. In this case, it might lead to a situation where an attacker can take control over the implementation contract by passing himself as `governor` and try to mislead users toward malicious contracts. This is not a security issue on its own but we strongly suggest avoiding such scenarios in all implementation contracts.\n\n\nAs a source of inspiration, [here](https://forum.openzeppelin.com/t/what-does-disableinitializers-function-mean/28730) there’s an example of how the scenario can be avoided in general situations.\n\n\n**Update**: *Fixed in commit [79f59e5](https://github.com/compound-finance/comet/commit/79f59e599ac13a3a85f39f427d389a08af1570df).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/Configurator.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity 0.8.13;\n\nimport \"./CometFactory.sol\";\nimport \"./CometConfiguration.sol\";\nimport \"./ConfiguratorStorage.sol\";\n\ncontract Configurator is ConfiguratorStorage {\n\n    /** Custom events **/\n\n    event AddAsset(AssetConfig assetConfig);\n    event CometDeployed(address newComet);\n    event GovernorTransferred(address oldGovernor, address newGovernor);\n    event SetFactory(address oldFactory, address newFactory);\n    event SetGovernor(address oldGovernor, address newGovernor);\n    event SetPauseGuardian(address oldPauseGuardian, address newPauseGuardian);\n    event SetBaseTokenPriceFeed(address oldBaseTokenPriceFeed, address newBaseTokenPriceFeed);\n    event SetExtensionDelegate(address oldExt, address newExt);\n    event SetKink(uint64 oldKink, uint64 newKink);\n    event SetPerYearInterestRateSlopeLow(uint64 oldIRSlopeLow, uint64 newIRSlopeLow);\n    event SetPerYearInterestRateSlopeHigh(uint64 oldIRSlopeHigh, uint64 newIRSlopeHigh);\n    event SetPerYearInterestRateBase(uint64 oldIRBase, uint64 newIRBase);\n    event SetReserveRate(uint64 oldReserveRate, uint64 newReserveRate);\n    event SetStoreFrontPriceFactor(uint64 oldStoreFrontPriceFactor, uint64 newStoreFrontPriceFactor);\n    event SetBaseTrackingSupplySpeed(uint64 oldBaseTrackingSupplySpeed, uint64 newBaseTrackingSupplySpeed);\n    event SetBaseTrackingBorrowSpeed(uint64 oldBaseTrackingBorrowSpeed, uint64 newBaseTrackingBorrowSpeed);\n    event SetBaseMinForRewards(uint104 oldBaseMinForRewards, uint104 newBaseMinForRewards);\n    event SetBaseBorrowMin(uint104 oldBaseBorrowMin, uint104 newBaseBorrowMin);\n    event SetTargetReserves(uint104 oldTargetReserves, uint104 newTargetReserves);\n    event UpdateAsset(AssetConfig oldAssetConfig, AssetConfig newAssetConfig);\n    event UpdateAssetPriceFeed(address indexed asset, address oldPriceFeed, address newPriceFeed);\n    event UpdateAssetBorrowCollateralFactor(address indexed asset, uint64 oldBorrowCF, uint64 newBorrowCF);\n    event UpdateAssetLiquidateCollateralFactor(address indexed asset, uint64 oldLiquidateCF, uint64 newLiquidateCF);\n    event UpdateAssetLiquidationFactor(address indexed asset, uint64 oldLiquidationFactor, uint64 newLiquidationFactor);\n    event UpdateAssetSupplyCap(address indexed asset, uint128 oldSupplyCap, uint128 newSupplyCap);\n\n    /** Custom errors **/\n\n    error AlreadyInitialized();\n    error AssetDoesNotExist();\n    error InvalidAddress();\n    error Unauthorized();\n\n    /// @notice Initializes the storage for Configurator\n    function initialize(address _governor, address _factory, Configuration calldata _config) public {\n        if (version != 0) revert AlreadyInitialized();\n        if (_governor == address(0)) revert InvalidAddress();\n        if (_factory == address(0)) revert InvalidAddress();\n\n        governor = _governor;\n        factory = _factory;\n        configuratorParams = _config;\n        version = 1;\n    }\n\n    /// @notice Sets the factory for Configurator\n    /// @dev only callable by governor\n    function setFactory(address newFactory) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldFactory = factory;\n        factory = newFactory;\n        emit SetFactory(oldFactory, newFactory);\n    }\n\n    /** Setters for Comet-related configuration **/\n    /**\n    * The following configuration parameters do not have setters:\n    *   - BaseToken\n    *   - TrackingIndexScale\n    */\n\n    /// @dev only callable by governor\n    function setGovernor(address newGovernor) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldGovernor = configuratorParams.governor;\n        configuratorParams.governor = newGovernor;\n        emit SetGovernor(oldGovernor, newGovernor);\n    }\n\n    /// @dev only callable by governor\n    function setPauseGuardian(address newPauseGuardian) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldPauseGuardian = configuratorParams.pauseGuardian;\n        configuratorParams.pauseGuardian = newPauseGuardian;\n        emit SetPauseGuardian(oldPauseGuardian, newPauseGuardian);\n    }\n\n    /// @dev only callable by governor\n    function setBaseTokenPriceFeed(address newBaseTokenPriceFeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldBaseTokenPriceFeed = configuratorParams.baseTokenPriceFeed;\n        configuratorParams.baseTokenPriceFeed = newBaseTokenPriceFeed;\n        emit SetBaseTokenPriceFeed(oldBaseTokenPriceFeed, newBaseTokenPriceFeed);\n    }\n\n    /// @dev only callable by governor\n    function setExtensionDelegate(address newExtensionDelegate) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldExtensionDelegate = configuratorParams.extensionDelegate;\n        configuratorParams.extensionDelegate = newExtensionDelegate;\n        emit SetExtensionDelegate(oldExtensionDelegate, newExtensionDelegate);\n    }\n\n    /// @dev only callable by governor\n    function setKink(uint64 newKink) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldKink = configuratorParams.kink;\n        configuratorParams.kink = newKink;\n        emit SetKink(oldKink, newKink);\n    }\n\n    /// @dev only callable by governor\n    function setPerYearInterestRateSlopeLow(uint64 newSlope) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldSlope = configuratorParams.perYearInterestRateSlopeLow;\n        configuratorParams.perYearInterestRateSlopeLow = newSlope;\n        emit SetPerYearInterestRateSlopeLow(oldSlope, newSlope);\n    }\n\n    /// @dev only callable by governor\n    function setPerYearInterestRateSlopeHigh(uint64 newSlope) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldSlope = configuratorParams.perYearInterestRateSlopeHigh;\n        configuratorParams.perYearInterestRateSlopeHigh = newSlope;\n        emit SetPerYearInterestRateSlopeHigh(oldSlope, newSlope);\n    }\n\n    /// @dev only callable by governor\n    function setPerYearInterestRateBase(uint64 newBase) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldBase = configuratorParams.perYearInterestRateBase;\n        configuratorParams.perYearInterestRateBase = newBase;\n        emit SetPerYearInterestRateBase(oldBase, newBase);\n    }\n\n    /// @dev only callable by governor\n    function setReserveRate(uint64 newReserveRate) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldReserveRate = configuratorParams.reserveRate;\n        configuratorParams.reserveRate = newReserveRate;\n        emit SetReserveRate(oldReserveRate, newReserveRate);\n    }\n\n    /// @dev only callable by governor\n    function setStoreFrontPriceFactor(uint64 newStoreFrontPriceFactor) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldStoreFrontPriceFactor = configuratorParams.storeFrontPriceFactor;\n        configuratorParams.storeFrontPriceFactor = newStoreFrontPriceFactor;\n        emit SetStoreFrontPriceFactor(oldStoreFrontPriceFactor, newStoreFrontPriceFactor);\n    }\n\n    /// @dev only callable by governor\n    function setBaseTrackingSupplySpeed(uint64 newBaseTrackingSupplySpeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldBaseTrackingSupplySpeed = configuratorParams.baseTrackingSupplySpeed;\n        configuratorParams.baseTrackingSupplySpeed = newBaseTrackingSupplySpeed;\n        emit SetBaseTrackingSupplySpeed(oldBaseTrackingSupplySpeed, newBaseTrackingSupplySpeed);\n    }\n\n    /// @dev only callable by governor\n    function setBaseTrackingBorrowSpeed(uint64 newBaseTrackingBorrowSpeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldBaseTrackingBorrowSpeed = configuratorParams.baseTrackingBorrowSpeed;\n        configuratorParams.baseTrackingBorrowSpeed = newBaseTrackingBorrowSpeed;\n        emit SetBaseTrackingBorrowSpeed(oldBaseTrackingBorrowSpeed, newBaseTrackingBorrowSpeed);\n    }\n\n    /// @dev only callable by governor\n    function setBaseMinForRewards(uint104 newBaseMinForRewards) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint104 oldBaseMinForRewards = configuratorParams.baseMinForRewards;\n        configuratorParams.baseMinForRewards = newBaseMinForRewards;\n        emit SetBaseMinForRewards(oldBaseMinForRewards, newBaseMinForRewards);\n    }\n\n    /// @dev only callable by governor\n    function setBaseBorrowMin(uint104 newBaseBorrowMin) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint104 oldBaseBorrowMin = configuratorParams.baseBorrowMin;\n        configuratorParams.baseBorrowMin = newBaseBorrowMin;\n        emit SetBaseBorrowMin(oldBaseBorrowMin, newBaseBorrowMin);\n    }\n\n    /// @dev only callable by governor\n    function setTargetReserves(uint104 newTargetReserves) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint104 oldTargetReserves = configuratorParams.targetReserves;\n        configuratorParams.targetReserves = newTargetReserves;\n        emit SetTargetReserves(oldTargetReserves, newTargetReserves);\n    }\n\n    /// @dev only callable by governor\n    function addAsset(AssetConfig calldata assetConfig) external {\n        if (msg.sender != governor) revert Unauthorized();\n        configuratorParams.assetConfigs.push(assetConfig);\n        emit AddAsset(assetConfig);\n    }\n\n    /// @dev only callable by governor\n    function updateAsset(AssetConfig calldata newAssetConfig) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(newAssetConfig.asset);\n        AssetConfig memory oldAssetConfig = configuratorParams.assetConfigs[assetIndex];\n        configuratorParams.assetConfigs[assetIndex] = newAssetConfig;\n        emit UpdateAsset(oldAssetConfig, newAssetConfig);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetPriceFeed(address asset, address newPriceFeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        address oldPriceFeed = configuratorParams.assetConfigs[assetIndex].priceFeed;\n        configuratorParams.assetConfigs[assetIndex].priceFeed = newPriceFeed;\n        emit UpdateAssetPriceFeed(asset, oldPriceFeed, newPriceFeed);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetBorrowCollateralFactor(address asset, uint64 newBorrowCF) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint64 oldBorrowCF = configuratorParams.assetConfigs[assetIndex].borrowCollateralFactor;\n        configuratorParams.assetConfigs[assetIndex].borrowCollateralFactor = newBorrowCF;\n        emit UpdateAssetBorrowCollateralFactor(asset, oldBorrowCF, newBorrowCF);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetLiquidateCollateralFactor(address asset, uint64 newLiquidateCF) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint64 oldLiquidateCF = configuratorParams.assetConfigs[assetIndex].liquidateCollateralFactor;\n        configuratorParams.assetConfigs[assetIndex].liquidateCollateralFactor = newLiquidateCF;\n        emit UpdateAssetLiquidateCollateralFactor(asset, oldLiquidateCF, newLiquidateCF);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetLiquidationFactor(address asset, uint64 newLiquidationFactor) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint64 oldLiquidationFactor = configuratorParams.assetConfigs[assetIndex].liquidationFactor;\n        configuratorParams.assetConfigs[assetIndex].liquidationFactor = newLiquidationFactor;\n        emit UpdateAssetLiquidationFactor(asset, oldLiquidationFactor, newLiquidationFactor);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetSupplyCap(address asset, uint128 newSupplyCap) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint128 oldSupplyCap = configuratorParams.assetConfigs[assetIndex].supplyCap;\n        configuratorParams.assetConfigs[assetIndex].supplyCap = newSupplyCap;\n        emit UpdateAssetSupplyCap(asset, oldSupplyCap, newSupplyCap);\n    }\n\n    /// @dev Determine index of asset that matches given address\n    function getAssetIndex(address asset) internal view returns (uint) {\n        AssetConfig[] memory assetConfigs = configuratorParams.assetConfigs;\n        uint numAssets = assetConfigs.length;\n        for (uint i = 0; i < numAssets; i++) {\n            if (assetConfigs[i].asset == asset) {\n                return i;\n            }\n        }\n        revert AssetDoesNotExist();\n    }\n\n    /** End of setters for Comet-related configuration **/\n\n    /// @notice Gets the configuration params\n    function getConfiguration() external view returns (Configuration memory) {\n        return configuratorParams;\n    }\n\n    /// @notice Deploy a new version of the Comet implementation.\n    /// @dev callable by anyone\n    function deploy() external returns (address) {\n        address newComet = CometFactory(factory).clone(configuratorParams);\n        emit CometDeployed(newComet);\n        return newComet;\n    }\n\n    /// @notice Transfers the governor rights to a new address\n    /// @dev only callable by governor\n    function transferGovernor(address newGovernor) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldGovernor = governor;\n        governor = newGovernor;\n        emit GovernorTransferred(oldGovernor, newGovernor);\n    }\n}"
    }
  ]
}