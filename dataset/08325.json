{
  "Title": "[M-03] System will not work anymore after EIP-4758",
  "Content": "_Submitted by Lambda, also found by Chom_\n\n[DepositReceiver.sol#L25](https://github.com/code-423n4/2022-07-axelar/blob/a46fa61e73dd0f3469c0263bc6818e682d62fb5f/contracts/deposit-service/DepositReceiver.sol#L25)<br>\n\nAfter [EIP-4758](https://eips.ethereum.org/EIPS/eip-4758), the `SELFDESTRUCT` op code will no longer be available. According to the EIP, \"The only use that breaks is where a contract is re-created at the same address using CREATE2 (after a SELFDESTRUCT)\". Axelar is exactly such an application, the current deposit system will no longer work.\n\n### Recommended Mitigation Steps\n\nTo avoid that Axelar simply stops working one day, the architecture should be changed. Instead of generating addresses for every user, the user could directly interact with the deposit service and the deposit service would need to keep track of funds and provide refunds directly.\n\n**[re1ro (Axelar) commented](https://github.com/code-423n4/2022-07-axelar-findings/issues/20#issuecomment-1205926507):**\n > Very good spot. We will address this.\n\n**[re1ro (Axelar) acknowledged](https://github.com/code-423n4/2022-07-axelar-findings/issues/20)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-07-axelar-findings/issues/20#issuecomment-1236399840):**\n > The warden has shown a plausible upgrade path for Ethereum that will remove the `SELFDESTRUCT` opcode, bricking the `DepositReceiver` functionality.\n> \n> If the fork was in place today, the code would be broken, and the finding should be of high severity.\n> \n> Because the fork is not in place, and no clear timeline is defined for \"The Purge\", I think Medium Severity to be correct.\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2022-07-axelar",
  "Code": [
    {
      "filename": "contracts/deposit-service/DepositReceiver.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity 0.8.9;\n\nimport { IAxelarDepositService } from '../interfaces/IAxelarDepositService.sol';\n\ncontract DepositReceiver {\n    constructor(bytes memory delegateData) {\n        // Reading the implementation of the AxelarDepositService\n        // and delegating the call back to it\n        // solhint-disable-next-line avoid-low-level-calls\n        (bool success, ) = IAxelarDepositService(msg.sender).receiverImplementation().delegatecall(delegateData);\n\n        // if not success revert with the original revert data\n        if (!success) {\n            // solhint-disable-next-line no-inline-assembly\n            assembly {\n                let ptr := mload(0x40)\n                let size := returndatasize()\n                returndatacopy(ptr, 0, size)\n                revert(ptr, size)\n            }\n        }\n\n        selfdestruct(payable(msg.sender));\n    }\n\n    // solhint-disable-next-line no-empty-blocks\n    receive() external payable {}\n}"
    }
  ]
}