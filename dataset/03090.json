{
  "Title": "Everyone can deploy new Comet instances",
  "Content": "Each [`Comet`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/Comet.sol) contract implementation that the protocol might decide to create is meant to be deployed in the [`Configurator`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/Configurator.sol) contract.\n\n\nThis contract is an intermediate logic to bootstrap the entire protocol configuration and then apply it to a newly deployed `Comet` contract.\n\n\nTo do this, the `Configurator` makes use of a [`CometFactory`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/CometFactory.sol) contract which has a [`clone`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/CometFactory.sol#L8) function whose sole role is to create a new `Comet` contract and return its address.\n\n\nWhenever all protocol parameters are set, the [`deploy`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/Configurator.sol#L281) function in the `Configurator` contract is called. This function calls the [`clone`](https://github.com/compound-finance/comet/blob/0f1221967149115f50a09681eea9580879ee7720/contracts/CometFactory.sol#L8) function in the factory and emits an event to signal that a new `Comet` is ready with the configuration set so far.\n\n\nThe `deploy` and `clone` functions are both public callable functions, so anyone can, at any moment, generate the `Comet` instance either in the factory, passing arbitrary configurations, or either through the `Configurator` with the configuration set until that moment.\n\n\nIs not clear why those functions are public as there is no benefit for users to call them. Moreover, leaving open the door for anyone to deploy instances of `Comet` with arbitrary configuration or emitting arbitrary events through the `Configurator` is a concern to take into account as it might be misused by malicious actors trying to create pishing-like attacks.\n\n\nConsider restricting access to those functions and let them be called only by the governor or consider properly documenting such a design decision, raising awareness over the way it might be misused.\n\n\n**Update**: *Not fixed. The team acknowledge the issue and in their words: “We considered making `Configurator.deploy()` a governor-only function, however it would require adding a storage slot and complicating the Configurator which does not seem worth the tradeoff. It also doesn’t make sense to change `CometFactory.clone()` to be governor-only as the `CometFactory` is a stateless contract. We note for future reference that there isn’t a great way to get a list of official Comet instances from on-chain, however the canonical repository does have a list (`roots.json`) for each chain, which seems sufficient until a better solution is established.”*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/Configurator.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity 0.8.13;\n\nimport \"./CometFactory.sol\";\nimport \"./CometConfiguration.sol\";\nimport \"./ConfiguratorStorage.sol\";\n\ncontract Configurator is ConfiguratorStorage {\n\n    /** Custom events **/\n\n    event AddAsset(AssetConfig assetConfig);\n    event CometDeployed(address newComet);\n    event GovernorTransferred(address oldGovernor, address newGovernor);\n    event SetFactory(address oldFactory, address newFactory);\n    event SetGovernor(address oldGovernor, address newGovernor);\n    event SetPauseGuardian(address oldPauseGuardian, address newPauseGuardian);\n    event SetBaseTokenPriceFeed(address oldBaseTokenPriceFeed, address newBaseTokenPriceFeed);\n    event SetExtensionDelegate(address oldExt, address newExt);\n    event SetKink(uint64 oldKink, uint64 newKink);\n    event SetPerYearInterestRateSlopeLow(uint64 oldIRSlopeLow, uint64 newIRSlopeLow);\n    event SetPerYearInterestRateSlopeHigh(uint64 oldIRSlopeHigh, uint64 newIRSlopeHigh);\n    event SetPerYearInterestRateBase(uint64 oldIRBase, uint64 newIRBase);\n    event SetReserveRate(uint64 oldReserveRate, uint64 newReserveRate);\n    event SetStoreFrontPriceFactor(uint64 oldStoreFrontPriceFactor, uint64 newStoreFrontPriceFactor);\n    event SetBaseTrackingSupplySpeed(uint64 oldBaseTrackingSupplySpeed, uint64 newBaseTrackingSupplySpeed);\n    event SetBaseTrackingBorrowSpeed(uint64 oldBaseTrackingBorrowSpeed, uint64 newBaseTrackingBorrowSpeed);\n    event SetBaseMinForRewards(uint104 oldBaseMinForRewards, uint104 newBaseMinForRewards);\n    event SetBaseBorrowMin(uint104 oldBaseBorrowMin, uint104 newBaseBorrowMin);\n    event SetTargetReserves(uint104 oldTargetReserves, uint104 newTargetReserves);\n    event UpdateAsset(AssetConfig oldAssetConfig, AssetConfig newAssetConfig);\n    event UpdateAssetPriceFeed(address indexed asset, address oldPriceFeed, address newPriceFeed);\n    event UpdateAssetBorrowCollateralFactor(address indexed asset, uint64 oldBorrowCF, uint64 newBorrowCF);\n    event UpdateAssetLiquidateCollateralFactor(address indexed asset, uint64 oldLiquidateCF, uint64 newLiquidateCF);\n    event UpdateAssetLiquidationFactor(address indexed asset, uint64 oldLiquidationFactor, uint64 newLiquidationFactor);\n    event UpdateAssetSupplyCap(address indexed asset, uint128 oldSupplyCap, uint128 newSupplyCap);\n\n    /** Custom errors **/\n\n    error AlreadyInitialized();\n    error AssetDoesNotExist();\n    error InvalidAddress();\n    error Unauthorized();\n\n    /// @notice Initializes the storage for Configurator\n    function initialize(address _governor, address _factory, Configuration calldata _config) public {\n        if (version != 0) revert AlreadyInitialized();\n        if (_governor == address(0)) revert InvalidAddress();\n        if (_factory == address(0)) revert InvalidAddress();\n\n        governor = _governor;\n        factory = _factory;\n        configuratorParams = _config;\n        version = 1;\n    }\n\n    /// @notice Sets the factory for Configurator\n    /// @dev only callable by governor\n    function setFactory(address newFactory) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldFactory = factory;\n        factory = newFactory;\n        emit SetFactory(oldFactory, newFactory);\n    }\n\n    /** Setters for Comet-related configuration **/\n    /**\n    * The following configuration parameters do not have setters:\n    *   - BaseToken\n    *   - TrackingIndexScale\n    */\n\n    /// @dev only callable by governor\n    function setGovernor(address newGovernor) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldGovernor = configuratorParams.governor;\n        configuratorParams.governor = newGovernor;\n        emit SetGovernor(oldGovernor, newGovernor);\n    }\n\n    /// @dev only callable by governor\n    function setPauseGuardian(address newPauseGuardian) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldPauseGuardian = configuratorParams.pauseGuardian;\n        configuratorParams.pauseGuardian = newPauseGuardian;\n        emit SetPauseGuardian(oldPauseGuardian, newPauseGuardian);\n    }\n\n    /// @dev only callable by governor\n    function setBaseTokenPriceFeed(address newBaseTokenPriceFeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldBaseTokenPriceFeed = configuratorParams.baseTokenPriceFeed;\n        configuratorParams.baseTokenPriceFeed = newBaseTokenPriceFeed;\n        emit SetBaseTokenPriceFeed(oldBaseTokenPriceFeed, newBaseTokenPriceFeed);\n    }\n\n    /// @dev only callable by governor\n    function setExtensionDelegate(address newExtensionDelegate) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldExtensionDelegate = configuratorParams.extensionDelegate;\n        configuratorParams.extensionDelegate = newExtensionDelegate;\n        emit SetExtensionDelegate(oldExtensionDelegate, newExtensionDelegate);\n    }\n\n    /// @dev only callable by governor\n    function setKink(uint64 newKink) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldKink = configuratorParams.kink;\n        configuratorParams.kink = newKink;\n        emit SetKink(oldKink, newKink);\n    }\n\n    /// @dev only callable by governor\n    function setPerYearInterestRateSlopeLow(uint64 newSlope) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldSlope = configuratorParams.perYearInterestRateSlopeLow;\n        configuratorParams.perYearInterestRateSlopeLow = newSlope;\n        emit SetPerYearInterestRateSlopeLow(oldSlope, newSlope);\n    }\n\n    /// @dev only callable by governor\n    function setPerYearInterestRateSlopeHigh(uint64 newSlope) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldSlope = configuratorParams.perYearInterestRateSlopeHigh;\n        configuratorParams.perYearInterestRateSlopeHigh = newSlope;\n        emit SetPerYearInterestRateSlopeHigh(oldSlope, newSlope);\n    }\n\n    /// @dev only callable by governor\n    function setPerYearInterestRateBase(uint64 newBase) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldBase = configuratorParams.perYearInterestRateBase;\n        configuratorParams.perYearInterestRateBase = newBase;\n        emit SetPerYearInterestRateBase(oldBase, newBase);\n    }\n\n    /// @dev only callable by governor\n    function setReserveRate(uint64 newReserveRate) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldReserveRate = configuratorParams.reserveRate;\n        configuratorParams.reserveRate = newReserveRate;\n        emit SetReserveRate(oldReserveRate, newReserveRate);\n    }\n\n    /// @dev only callable by governor\n    function setStoreFrontPriceFactor(uint64 newStoreFrontPriceFactor) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldStoreFrontPriceFactor = configuratorParams.storeFrontPriceFactor;\n        configuratorParams.storeFrontPriceFactor = newStoreFrontPriceFactor;\n        emit SetStoreFrontPriceFactor(oldStoreFrontPriceFactor, newStoreFrontPriceFactor);\n    }\n\n    /// @dev only callable by governor\n    function setBaseTrackingSupplySpeed(uint64 newBaseTrackingSupplySpeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldBaseTrackingSupplySpeed = configuratorParams.baseTrackingSupplySpeed;\n        configuratorParams.baseTrackingSupplySpeed = newBaseTrackingSupplySpeed;\n        emit SetBaseTrackingSupplySpeed(oldBaseTrackingSupplySpeed, newBaseTrackingSupplySpeed);\n    }\n\n    /// @dev only callable by governor\n    function setBaseTrackingBorrowSpeed(uint64 newBaseTrackingBorrowSpeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint64 oldBaseTrackingBorrowSpeed = configuratorParams.baseTrackingBorrowSpeed;\n        configuratorParams.baseTrackingBorrowSpeed = newBaseTrackingBorrowSpeed;\n        emit SetBaseTrackingBorrowSpeed(oldBaseTrackingBorrowSpeed, newBaseTrackingBorrowSpeed);\n    }\n\n    /// @dev only callable by governor\n    function setBaseMinForRewards(uint104 newBaseMinForRewards) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint104 oldBaseMinForRewards = configuratorParams.baseMinForRewards;\n        configuratorParams.baseMinForRewards = newBaseMinForRewards;\n        emit SetBaseMinForRewards(oldBaseMinForRewards, newBaseMinForRewards);\n    }\n\n    /// @dev only callable by governor\n    function setBaseBorrowMin(uint104 newBaseBorrowMin) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint104 oldBaseBorrowMin = configuratorParams.baseBorrowMin;\n        configuratorParams.baseBorrowMin = newBaseBorrowMin;\n        emit SetBaseBorrowMin(oldBaseBorrowMin, newBaseBorrowMin);\n    }\n\n    /// @dev only callable by governor\n    function setTargetReserves(uint104 newTargetReserves) external {\n        if (msg.sender != governor) revert Unauthorized();\n        uint104 oldTargetReserves = configuratorParams.targetReserves;\n        configuratorParams.targetReserves = newTargetReserves;\n        emit SetTargetReserves(oldTargetReserves, newTargetReserves);\n    }\n\n    /// @dev only callable by governor\n    function addAsset(AssetConfig calldata assetConfig) external {\n        if (msg.sender != governor) revert Unauthorized();\n        configuratorParams.assetConfigs.push(assetConfig);\n        emit AddAsset(assetConfig);\n    }\n\n    /// @dev only callable by governor\n    function updateAsset(AssetConfig calldata newAssetConfig) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(newAssetConfig.asset);\n        AssetConfig memory oldAssetConfig = configuratorParams.assetConfigs[assetIndex];\n        configuratorParams.assetConfigs[assetIndex] = newAssetConfig;\n        emit UpdateAsset(oldAssetConfig, newAssetConfig);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetPriceFeed(address asset, address newPriceFeed) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        address oldPriceFeed = configuratorParams.assetConfigs[assetIndex].priceFeed;\n        configuratorParams.assetConfigs[assetIndex].priceFeed = newPriceFeed;\n        emit UpdateAssetPriceFeed(asset, oldPriceFeed, newPriceFeed);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetBorrowCollateralFactor(address asset, uint64 newBorrowCF) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint64 oldBorrowCF = configuratorParams.assetConfigs[assetIndex].borrowCollateralFactor;\n        configuratorParams.assetConfigs[assetIndex].borrowCollateralFactor = newBorrowCF;\n        emit UpdateAssetBorrowCollateralFactor(asset, oldBorrowCF, newBorrowCF);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetLiquidateCollateralFactor(address asset, uint64 newLiquidateCF) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint64 oldLiquidateCF = configuratorParams.assetConfigs[assetIndex].liquidateCollateralFactor;\n        configuratorParams.assetConfigs[assetIndex].liquidateCollateralFactor = newLiquidateCF;\n        emit UpdateAssetLiquidateCollateralFactor(asset, oldLiquidateCF, newLiquidateCF);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetLiquidationFactor(address asset, uint64 newLiquidationFactor) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint64 oldLiquidationFactor = configuratorParams.assetConfigs[assetIndex].liquidationFactor;\n        configuratorParams.assetConfigs[assetIndex].liquidationFactor = newLiquidationFactor;\n        emit UpdateAssetLiquidationFactor(asset, oldLiquidationFactor, newLiquidationFactor);\n    }\n\n    /// @dev only callable by governor\n    function updateAssetSupplyCap(address asset, uint128 newSupplyCap) external {\n        if (msg.sender != governor) revert Unauthorized();\n\n        uint assetIndex = getAssetIndex(asset);\n        uint128 oldSupplyCap = configuratorParams.assetConfigs[assetIndex].supplyCap;\n        configuratorParams.assetConfigs[assetIndex].supplyCap = newSupplyCap;\n        emit UpdateAssetSupplyCap(asset, oldSupplyCap, newSupplyCap);\n    }\n\n    /// @dev Determine index of asset that matches given address\n    function getAssetIndex(address asset) internal view returns (uint) {\n        AssetConfig[] memory assetConfigs = configuratorParams.assetConfigs;\n        uint numAssets = assetConfigs.length;\n        for (uint i = 0; i < numAssets; i++) {\n            if (assetConfigs[i].asset == asset) {\n                return i;\n            }\n        }\n        revert AssetDoesNotExist();\n    }\n\n    /** End of setters for Comet-related configuration **/\n\n    /// @notice Gets the configuration params\n    function getConfiguration() external view returns (Configuration memory) {\n        return configuratorParams;\n    }\n\n    /// @notice Deploy a new version of the Comet implementation.\n    /// @dev callable by anyone\n    function deploy() external returns (address) {\n        address newComet = CometFactory(factory).clone(configuratorParams);\n        emit CometDeployed(newComet);\n        return newComet;\n    }\n\n    /// @notice Transfers the governor rights to a new address\n    /// @dev only callable by governor\n    function transferGovernor(address newGovernor) external {\n        if (msg.sender != governor) revert Unauthorized();\n        address oldGovernor = governor;\n        governor = newGovernor;\n        emit GovernorTransferred(oldGovernor, newGovernor);\n    }\n}"
    }
  ]
}