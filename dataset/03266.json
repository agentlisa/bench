{
  "Title": "[L07] Invalid refund address",
  "Content": "The refund L2 address of the `Arbitrum_ParentMessenger` [is initialized](https://github.com/UMAprotocol/protocol/blob/0c4cea3c3d5e48da6f8984b8ba3afdfea4ce47cc/packages/core/contracts/cross-chain-oracle/chain-adapters/Arbitrum_ParentMessenger.sol#L65) to the contract owner, which should be the L1 Governor. Similarly, the `setRefundL2Address` [has a comment](https://github.com/UMAprotocol/protocol/blob/0c4cea3c3d5e48da6f8984b8ba3afdfea4ce47cc/packages/core/contracts/cross-chain-oracle/chain-adapters/Arbitrum_ParentMessenger.sol#L71) stating it should be set to the governor. However, when passing messages over the bridge, this value is [set as the L2 user](https://github.com/UMAprotocol/protocol/blob/0c4cea3c3d5e48da6f8984b8ba3afdfea4ce47cc/packages/core/contracts/cross-chain-oracle/chain-adapters/Arbitrum_ParentMessenger.sol#L200), which is the address on Arbitrum that receives excess funds after the ticket is resolved. Since the L1 governor address will not be accessible on Arbitrum, any funds sent to this address will be lost.\n\n\nConsider setting it to a valid L2 address.\n\n\n**Update:** *Fixed as of commit [`b3f2dd1`](https://github.com/UMAprotocol/protocol/pull/3687/commits/b3f2dd1768b1d731462730d9dc00eba09c59cbfb) in [PR3687](https://github.com/UMAprotocol/protocol/pull/3687).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "packages/core/contracts/cross-chain-oracle/chain-adapters/Arbitrum_ParentMessenger.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-only\npragma solidity ^0.8.0;\n\nimport \"../../insured-bridge/avm/Arbitrum_CrossDomainEnabled.sol\";\nimport \"../interfaces/ParentMessengerInterface.sol\";\nimport \"../interfaces/ParentMessengerConsumerInterface.sol\";\nimport \"./ParentMessengerBase.sol\";\nimport \"../../common/implementation/Lockable.sol\";\n\n/**\n * @notice Sends cross chain messages from Ethereum L1 to Arbitrum L2 network.\n * @dev This contract is ownable and should be owned by the DVM governor.\n */\ncontract Arbitrum_ParentMessenger is\n    Arbitrum_CrossDomainEnabled,\n    ParentMessengerInterface,\n    ParentMessengerBase,\n    Lockable\n{\n    event SetDefaultGasLimit(uint32 newDefaultGasLimit);\n    event SetDefaultMaxSubmissionCost(uint256 newMaxSubmissionCost);\n    event SetDefaultGasPrice(uint256 newDefaultGasPrice);\n    event SetRefundL2Address(address newRefundL2Address);\n    event MessageSentToChild(\n        bytes data,\n        address indexed targetSpoke,\n        uint256 l1CallValue,\n        uint32 gasLimit,\n        uint256 gasPrice,\n        uint256 maxSubmissionCost,\n        address refundL2Address,\n        address indexed childMessenger,\n        uint256 sequenceNumber\n    );\n    event MessageReceivedFromChild(bytes data, address indexed childMessenger, address indexed targetHub);\n\n    // TODO: Can these default values be determined dynamically via L1 Arbitrum system contracts?\n\n    // Gas limit for immediate L2 execution attempt (can be estimated via NodeInterface.estimateRetryableTicket).\n    // NodeInterface precompile interface exists at L2 address 0x00000000000000000000000000000000000000C8\n    uint32 public defaultGasLimit = 5_000_000;\n\n    // Amount of ETH allocated to pay for the base submission fee. The base submission fee is a parameter unique to\n    // retryable transactions; the user is charged the base submission fee to cover the storage costs of keeping their\n    // ticketâ€™s calldata in the retry buffer. (current base submission fee is queryable via\n    // ArbRetryableTx.getSubmissionPrice). ArbRetryableTicket precompile interface exists at L2 address\n    // 0x000000000000000000000000000000000000006E.\n    uint256 public defaultMaxSubmissionCost = 0.1e18;\n\n    // L2 Gas price bid for immediate L2 execution attempt (queryable via standard eth*gasPrice RPC)\n    uint256 public defaultGasPrice = 10e9; // 10 gWei\n\n    // This address on L2 receives extra ETH that is left over after relaying a message via the inbox.\n    address public refundL2Address;\n\n    /**\n     * @notice Construct the Optimism_ParentMessenger contract.\n     * @param _inbox Contract that sends generalized messages to the Arbitrum chain.\n     * @param _childChainId The chain id of the Optimism L2 network this messenger should connect to.\n     **/\n    constructor(address _inbox, uint256 _childChainId)\n        Arbitrum_CrossDomainEnabled(_inbox)\n        ParentMessengerBase(_childChainId)\n    {\n        refundL2Address = owner();\n    }\n\n    /**\n     * @notice Changes the refund address on L2 that receives excess gas or the full msg.value if the retryable\n     * ticket reverts.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newRefundl2Address the new refund address to set.\n     */\n    function setRefundL2Address(address newRefundl2Address) public onlyOwner nonReentrant() {\n        refundL2Address = newRefundl2Address;\n        emit SetRefundL2Address(refundL2Address);\n    }\n\n    /**\n     * @notice Changes the default gas limit that is sent along with transactions to Arbitrum.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newDefaultGasLimit the new L2 gas limit to be set.\n     */\n    function setDefaultGasLimit(uint32 newDefaultGasLimit) public onlyOwner nonReentrant() {\n        defaultGasLimit = newDefaultGasLimit;\n        emit SetDefaultGasLimit(newDefaultGasLimit);\n    }\n\n    /**\n     * @notice Changes the default gas price that is sent along with transactions to Arbitrum.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newDefaultGasPrice the new L2 gas price to be set.\n     */\n    function setDefaultGasPrice(uint256 newDefaultGasPrice) public onlyOwner nonReentrant() {\n        defaultGasPrice = newDefaultGasPrice;\n        emit SetDefaultGasPrice(newDefaultGasPrice);\n    }\n\n    /**\n     * @notice Changes the default max submission cost that is sent along with transactions to Arbitrum.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @param newDefaultMaxSubmissionCost the new L2 max submission cost to be set.\n     */\n    function setDefaultMaxSubmissionCost(uint256 newDefaultMaxSubmissionCost) public onlyOwner nonReentrant() {\n        defaultMaxSubmissionCost = newDefaultMaxSubmissionCost;\n        emit SetDefaultMaxSubmissionCost(newDefaultMaxSubmissionCost);\n    }\n\n    /**\n     * @notice Changes the address of the oracle spoke on L2 via the child messenger.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @dev This function will only succeed if this contract has enough ETH to cover the approximate L1 call value.\n     * @param newOracleSpoke the new oracle spoke address set on L2.\n     */\n    function setChildOracleSpoke(address newOracleSpoke) public onlyOwner {\n        bytes memory dataSentToChild = abi.encodeWithSignature(\"setOracleSpoke(address)\", newOracleSpoke);\n        _sendMessageToChild(dataSentToChild, childMessenger);\n    }\n\n    /**\n     * @notice Changes the address of the parent messenger on L2 via the child messenger.\n     * @dev The caller of this function must be the owner. This should be set to the DVM governor.\n     * @dev This function will only succeed if this contract has enough ETH to cover the approximate L1 call value.\n     * @param newParentMessenger the new parent messenger contract to be set on L2.\n     */\n    function setChildParentMessenger(address newParentMessenger) public onlyOwner {\n        bytes memory dataSentToChild = abi.encodeWithSignature(\"setParentMessenger(address)\", newParentMessenger);\n        _sendMessageToChild(dataSentToChild, childMessenger);\n    }\n\n    /**\n     * @notice Sends a message to the child messenger via the canonical message bridge.\n     * @dev The caller must be the either the OracleHub or the GovernorHub. This is to send either a\n     * price or initiate a governance action to the OracleSpoke or GovernorSpoke on the child network.\n     * @dev The recipient of this message is the child messenger. The messenger must implement processMessageFromParent\n     * which then forwards the data to the target either the OracleSpoke or the governorSpoke depending on the caller.\n     * @dev This function will only succeed if this contract has enough ETH to cover the approximate L1 call value.\n     * @param data data message sent to the child messenger. Should be an encoded function call or packed data.\n     */\n    function sendMessageToChild(bytes memory data) external override onlyHubContract() nonReentrant() {\n        address target = msg.sender == oracleHub ? oracleSpoke : governorSpoke;\n        bytes memory dataSentToChild =\n            abi.encodeWithSignature(\"processMessageFromCrossChainParent(bytes,address)\", data, target);\n        _sendMessageToChild(dataSentToChild, target);\n    }\n\n    /**\n     * @notice Process a received message from the child messenger via the canonical message bridge.\n     * @dev The caller must be the the child messenger, sent over the canonical message bridge.\n     * @dev Note that only the OracleHub can receive messages from the child messenger. Therefore we can always forward\n     * these messages to this contract. The OracleHub must implement processMessageFromChild to handle this message.\n     * @param data data message sent from the child messenger. Should be an encoded function call or packed data.\n     */\n    function processMessageFromCrossChainChild(bytes memory data)\n        public\n        onlyFromCrossDomainAccount(childMessenger)\n        nonReentrant()\n    {\n        ParentMessengerConsumerInterface(oracleHub).processMessageFromChild(childChainId, data);\n        emit MessageReceivedFromChild(data, childMessenger, oracleHub);\n    }\n\n    /**\n     * @notice This function is expected to be queried by Hub contracts that need to determine how much ETH\n     * to include in msg.value when calling `sendMessageToChild`.\n     * @return Amount of msg.value to include to send cross-chain message.\n     */\n    function getL1CallValue()\n        public\n        view\n        override(ParentMessengerBase, ParentMessengerInterface)\n        nonReentrantView()\n        returns (uint256)\n    {\n        return _getL1CallValue();\n    }\n\n    // We need to allow this contract to receive ETH, so that it can include some msg.value amount on external calls\n    // to the `sendMessageToChild` function. We shouldn't expect the owner of this contract to send\n    // ETH because the owner is intended to be a contract (e.g. the Governor) and we don't want to change the\n    // Governor interface.\n    fallback() external payable {}\n\n    // Used to determine how much ETH to include in msg.value when calling admin functions like\n    // `setChildParentMessenger` and sending messages across the bridge.\n    function _getL1CallValue() internal view returns (uint256) {\n        // This could overflow if these values are set too high, but since they are configurable by trusted owner\n        // we won't catch this case.\n        return defaultMaxSubmissionCost + defaultGasPrice * defaultGasLimit;\n    }\n\n    // This function will only succeed if this contract has enough ETH to cover the approximate L1 call value.\n    function _sendMessageToChild(bytes memory data, address target) internal {\n        uint256 requiredL1CallValue = _getL1CallValue();\n        require(address(this).balance >= requiredL1CallValue, \"Insufficient ETH balance\");\n\n        uint256 seqNumber =\n            sendTxToL2NoAliassing(\n                childMessenger,\n                refundL2Address,\n                requiredL1CallValue,\n                defaultMaxSubmissionCost,\n                defaultGasLimit,\n                defaultGasPrice,\n                data\n            );\n        emit MessageSentToChild(\n            data,\n            target,\n            requiredL1CallValue,\n            defaultGasLimit,\n            defaultGasPrice,\n            defaultMaxSubmissionCost,\n            refundL2Address,\n            childMessenger,\n            seqNumber\n        );\n    }\n}"
    }
  ]
}