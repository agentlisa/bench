{
  "Title": "[M-19] Rewards are not accounted for properly in NTokenApeStaking contracts, limiting user's collateral",
  "Content": "\n<https://github.com/code-423n4/2022-11-paraspace/blob/c6820a279c64a299a783955749fdc977de8f0449/paraspace-core/contracts/protocol/tokenization/libraries/ApeStakingLogic.sol#L253>\n\nApeStakingLogic.sol implements the logic for staking ape coins through the NTokenApeStaking NFT.\n\n`getTokenIdStakingAmount()` is an important function which returns the entire stake amount mapping for a specific BAYC / MAYC NFT.\n\n    function getTokenIdStakingAmount(\n        uint256 poolId,\n        ApeCoinStaking _apeCoinStaking,\n        uint256 tokenId\n    ) public view returns (uint256) {\n        (uint256 apeStakedAmount, ) = _apeCoinStaking.nftPosition(\n            poolId,\n            tokenId\n        );\n        uint256 apeReward = _apeCoinStaking.pendingRewards(\n            poolId,\n            address(this),\n            tokenId\n        );\n        (uint256 bakcTokenId, bool isPaired) = _apeCoinStaking.mainToBakc(\n            poolId,\n            tokenId\n        );\n        if (isPaired) {\n            (uint256 bakcStakedAmount, ) = _apeCoinStaking.nftPosition(\n                BAKC_POOL_ID,\n                bakcTokenId\n            );\n            apeStakedAmount += bakcStakedAmount;\n        }\n        return apeStakedAmount + apeReward;\n    }\n\nWe can see that the total returned amount is the staked amount through the direct NFT, plus rewards for the direct NFT, plus the staked amount of the BAKC token paired to the direct NFT. However, the calculation does not include the pendingRewards for the BAKC staked amount, which accrues over time as well.\n\nAs a result, getTokenIdStakingAmount() returns a value lower than the correct user balance. This function is used in PTokenSApe.sol's balanceOf function, as this type of PToken is supposed to reflect the user's current balance in ape staking.\n\nWhen user unstakes their ape tokens through executeUnstakePositionAndRepay, they will receive their fair share of rewards.It will call ApeCoinStaking's \\_withdrawPairNft which will claim rewards also for BAKC tokens. However, because balanceOf() shows a lower value, the rewards not count as collateral for user's debt, which is a major issue for lending platforms.\n\n### Impact\n\nRewards are not accounted for properly in NTokenApeStaking contracts, limiting user's collateral.\n\n### Recommended Mitigation Steps\n\nBalance calculation should include pendingRewards from BAKC tokens if they exist.\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2022-11-paraspace",
  "Code": [
    {
      "filename": "paraspace-core/contracts/protocol/tokenization/libraries/ApeStakingLogic.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity 0.8.10;\nimport {ApeCoinStaking} from \"../../../dependencies/yoga-labs/ApeCoinStaking.sol\";\nimport {IERC721} from \"../../../dependencies/openzeppelin/contracts/IERC721.sol\";\nimport {SafeERC20} from \"../../../dependencies/openzeppelin/contracts/SafeERC20.sol\";\nimport {IERC20} from \"../../../dependencies/openzeppelin/contracts/IERC20.sol\";\nimport \"../../../interfaces/IPool.sol\";\nimport {DataTypes} from \"../../libraries/types/DataTypes.sol\";\nimport {PercentageMath} from \"../../libraries/math/PercentageMath.sol\";\nimport {Math} from \"../../../dependencies/openzeppelin/contracts/Math.sol\";\nimport \"./MintableERC721Logic.sol\";\n\n/**\n * @title ApeStakingLogic library\n *\n * @notice Implements the base logic for ApeStaking\n */\nlibrary ApeStakingLogic {\n    using SafeERC20 for IERC20;\n    using PercentageMath for uint256;\n\n    uint256 constant BAYC_POOL_ID = 1;\n    uint256 constant MAYC_POOL_ID = 2;\n    uint256 constant BAKC_POOL_ID = 3;\n\n    struct APEStakingParameter {\n        uint256 unstakeIncentive;\n    }\n    event UnstakeApeIncentiveUpdated(uint256 oldValue, uint256 newValue);\n\n    /**\n     * @notice withdraw Ape coin staking position from ApeCoinStaking\n     * @param _apeCoinStaking ApeCoinStaking contract address\n     * @param poolId identify whether BAYC or MAYC paired with BAKC\n     * @param _nftPairs Array of Paired BAYC/MAYC NFT's with staked amounts\n     * @param _apeRecipient the receiver of ape coin\n     */\n    function withdrawBAKC(\n        ApeCoinStaking _apeCoinStaking,\n        uint256 poolId,\n        ApeCoinStaking.PairNftWithAmount[] memory _nftPairs,\n        address _apeRecipient\n    ) external {\n        ApeCoinStaking.PairNftWithAmount[]\n            memory _otherPairs = new ApeCoinStaking.PairNftWithAmount[](0);\n\n        if (poolId == BAYC_POOL_ID) {\n            _apeCoinStaking.withdrawBAKC(_nftPairs, _otherPairs);\n        } else {\n            _apeCoinStaking.withdrawBAKC(_otherPairs, _nftPairs);\n        }\n\n        uint256 balance = _apeCoinStaking.apeCoin().balanceOf(address(this));\n\n        _apeCoinStaking.apeCoin().safeTransfer(_apeRecipient, balance);\n    }\n\n    /**\n     * @notice undate incentive percentage for unstakePositionAndRepay\n     * @param stakingParameter storage for Ape staking\n     * @param incentive new incentive percentage\n     */\n    function executeSetUnstakeApeIncentive(\n        APEStakingParameter storage stakingParameter,\n        uint256 incentive\n    ) external {\n        require(\n            incentive < PercentageMath.HALF_PERCENTAGE_FACTOR,\n            \"Value Too High\"\n        );\n        uint256 oldValue = stakingParameter.unstakeIncentive;\n        require(oldValue != incentive, \"Same Value\");\n        stakingParameter.unstakeIncentive = incentive;\n        emit UnstakeApeIncentiveUpdated(oldValue, incentive);\n    }\n\n    struct UnstakeAndRepayParams {\n        IPool POOL;\n        ApeCoinStaking _apeCoinStaking;\n        address _underlyingAsset;\n        uint256 poolId;\n        uint256 tokenId;\n        address incentiveReceiver;\n    }\n\n    /**\n     * @notice Unstake Ape coin staking position and repay user debt\n     * @param _owners The state of ownership for nToken\n     * @param stakingParameter storage for Ape staking\n     * @param params The additional parameters needed to execute this function\n     */\n    function executeUnstakePositionAndRepay(\n        mapping(uint256 => address) storage _owners,\n        APEStakingParameter storage stakingParameter,\n        UnstakeAndRepayParams memory params\n    ) external {\n        address positionOwner = _owners[params.tokenId];\n        IERC20 _apeCoin = params._apeCoinStaking.apeCoin();\n        uint256 balanceBefore = _apeCoin.balanceOf(address(this));\n\n        //1 unstake all position\n        {\n            //1.1 unstake Main pool position\n            (uint256 stakedAmount, ) = params._apeCoinStaking.nftPosition(\n                params.poolId,\n                params.tokenId\n            );\n            if (stakedAmount > 0) {\n                ApeCoinStaking.SingleNft[]\n                    memory nfts = new ApeCoinStaking.SingleNft[](1);\n                nfts[0].tokenId = params.tokenId;\n                nfts[0].amount = stakedAmount;\n                if (params.poolId == BAYC_POOL_ID) {\n                    params._apeCoinStaking.withdrawBAYC(nfts, address(this));\n                } else {\n                    params._apeCoinStaking.withdrawMAYC(nfts, address(this));\n                }\n            }\n            //1.2 unstake bakc pool position\n            (uint256 bakcTokenId, bool isPaired) = params\n                ._apeCoinStaking\n                .mainToBakc(params.poolId, params.tokenId);\n            if (isPaired) {\n                (stakedAmount, ) = params._apeCoinStaking.nftPosition(\n                    BAKC_POOL_ID,\n                    bakcTokenId\n                );\n                if (stakedAmount > 0) {\n                    ApeCoinStaking.PairNftWithAmount[]\n                        memory _nftPairs = new ApeCoinStaking.PairNftWithAmount[](\n                            1\n                        );\n                    _nftPairs[0].mainTokenId = params.tokenId;\n                    _nftPairs[0].bakcTokenId = bakcTokenId;\n                    _nftPairs[0].amount = stakedAmount;\n                    ApeCoinStaking.PairNftWithAmount[]\n                        memory _otherPairs = new ApeCoinStaking.PairNftWithAmount[](\n                            0\n                        );\n\n                    if (params.poolId == BAYC_POOL_ID) {\n                        params._apeCoinStaking.withdrawBAKC(\n                            _nftPairs,\n                            _otherPairs\n                        );\n                    } else {\n                        params._apeCoinStaking.withdrawBAKC(\n                            _otherPairs,\n                            _nftPairs\n                        );\n                    }\n                }\n            }\n        }\n\n        uint256 unstakedAmount = _apeCoin.balanceOf(address(this)) -\n            balanceBefore;\n        if (unstakedAmount == 0) {\n            return;\n        }\n        //2 send incentive to caller\n        if (params.incentiveReceiver != address(0)) {\n            uint256 unstakeIncentive = stakingParameter.unstakeIncentive;\n            if (unstakeIncentive > 0) {\n                uint256 incentiveAmount = unstakedAmount.percentMul(\n                    unstakeIncentive\n                );\n                _apeCoin.safeTransfer(\n                    params.incentiveReceiver,\n                    incentiveAmount\n                );\n                unstakedAmount = unstakedAmount - incentiveAmount;\n            }\n        }\n\n        //3 repay and supply\n        DataTypes.ReserveData memory apeCoinData = params.POOL.getReserveData(\n            address(_apeCoin)\n        );\n        uint256 repayAmount = IERC20(apeCoinData.variableDebtTokenAddress)\n            .balanceOf(positionOwner);\n        if (repayAmount > 0) {\n            repayAmount = Math.min(repayAmount, unstakedAmount);\n        }\n        uint256 supplyAmount = unstakedAmount - repayAmount;\n\n        params.POOL.repayAndSupply(\n            params._underlyingAsset,\n            address(_apeCoin),\n            positionOwner,\n            repayAmount,\n            supplyAmount\n        );\n    }\n\n    /**\n     * @notice get user total ape staking position\n     * @param userState The user state of nToken\n     * @param ownedTokens The ownership mapping state of nNtoken\n     * @param user User address\n     * @param poolId identify whether BAYC pool or MAYC pool\n     * @param _apeCoinStaking ApeCoinStaking contract address\n     */\n    function getUserTotalStakingAmount(\n        mapping(address => UserState) storage userState,\n        mapping(address => mapping(uint256 => uint256)) storage ownedTokens,\n        address user,\n        uint256 poolId,\n        ApeCoinStaking _apeCoinStaking\n    ) external view returns (uint256) {\n        uint256 totalBalance = uint256(userState[user].balance);\n        uint256 totalAmount;\n        for (uint256 index = 0; index < totalBalance; index++) {\n            uint256 tokenId = ownedTokens[user][index];\n            totalAmount += getTokenIdStakingAmount(\n                poolId,\n                _apeCoinStaking,\n                tokenId\n            );\n        }\n\n        return totalAmount;\n    }\n\n    /**\n     * @notice get ape staking position for a tokenId\n     * @param poolId identify whether BAYC pool or MAYC pool\n     * @param _apeCoinStaking ApeCoinStaking contract address\n     * @param tokenId specified the tokenId for the position\n     */\n    function getTokenIdStakingAmount(\n        uint256 poolId,\n        ApeCoinStaking _apeCoinStaking,\n        uint256 tokenId\n    ) public view returns (uint256) {\n        (uint256 apeStakedAmount, ) = _apeCoinStaking.nftPosition(\n            poolId,\n            tokenId\n        );\n\n        uint256 apeReward = _apeCoinStaking.pendingRewards(\n            poolId,\n            address(this),\n            tokenId\n        );\n\n        (uint256 bakcTokenId, bool isPaired) = _apeCoinStaking.mainToBakc(\n            poolId,\n            tokenId\n        );\n\n        if (isPaired) {\n            (uint256 bakcStakedAmount, ) = _apeCoinStaking.nftPosition(\n                BAKC_POOL_ID,\n                bakcTokenId\n            );\n            apeStakedAmount += bakcStakedAmount;\n        }\n\n        return apeStakedAmount + apeReward;\n    }\n}"
    }
  ]
}