{
  "Title": "[M-02] SendValueWithFallbackWithdraw: withdrawFor function may fail to withdraw ether recorded in pendingWithdrawals",
  "Content": "# Lines of code\n\nhttps://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/SendValueWithFallbackWithdraw.sol#L37-L77\n\n\n# Vulnerability details\n\n## Impact\nThe NFTMarketFees contract and the NFTMarketReserveAuction contract use the _sendValueWithFallbackWithdraw function to send ether to FoundationTreasury, CreatorRecipients, Seller, Bidder.\nWhen the receiver fails to receive due to some reasons (exceeding the gas limit or the receiver contract cannot receive ether), it will record the ether to be sent in the pendingWithdrawals variable. \n```\n  function _sendValueWithFallbackWithdraw(\n    address payable user,\n    uint256 amount,\n    uint256 gasLimit\n  ) internal {\n    if (amount == 0) {\n      return;\n    }\n    // Cap the gas to prevent consuming all available gas to block a tx from completing successfully\n    // solhint-disable-next-line avoid-low-level-calls\n    (bool success, ) = user.call{ value: amount, gas: gasLimit }(\"\");\n    if (!success) {\n      // Record failed sends for a withdrawal later\n      // Transfers could fail if sent to a multisig with non-trivial receiver logic\n      unchecked {\n        pendingWithdrawals[user] += amount;\n      }\n      emit WithdrawPending(user, amount);\n    }\n  }\n```\nThe user can then withdraw ether via the withdraw or withdrawFor functions.\n```\n  function withdraw() external {\n    withdrawFor(payable(msg.sender));\n  }\n  function withdrawFor(address payable user) public nonReentrant {\n    uint256 amount = pendingWithdrawals[user];\n    if (amount == 0) {\n      revert SendValueWithFallbackWithdraw_No_Funds_Available();\n    }\n    pendingWithdrawals[user] = 0;\n    user.sendValue(amount);\n    emit Withdrawal(user, amount);\n  }\n```\nHowever, the withdrawFor function can only send ether to the address recorded in pendingWithdrawals. When the recipient is a contract that cannot receive ether, these ethers will be locked in the contract and cannot be withdrawn.\n## Proof of Concept\nhttps://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/SendValueWithFallbackWithdraw.sol#L37-L77\n## Tools Used\nNone\n## Recommended Mitigation Steps\nAdd the withdrawTo function as follows:\n\n```\n  function withdrawTo(address payable to) public nonReentrant {\n    uint256 amount = pendingWithdrawals[msg.sneder];\n    if (amount == 0) {\n      revert SendValueWithFallbackWithdraw_No_Funds_Available();\n    }\n    pendingWithdrawals[msg.sneder] = 0;\n    to.sendValue(amount);\n    emit Withdrawal(msg.sneder, amount);\n  }\n```\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/contests/2022-02-foundation-contest",
  "Code": [
    {
      "filename": "contracts/mixins/SendValueWithFallbackWithdraw.sol",
      "content": "// SPDX-License-Identifier: MIT OR Apache-2.0\n\npragma solidity ^0.8.0;\n\nimport \"@openzeppelin/contracts-upgradeable/utils/AddressUpgradeable.sol\";\nimport \"@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol\";\n\nerror SendValueWithFallbackWithdraw_No_Funds_Available();\n\n/**\n * @title A mixin for sending ETH with a fallback withdraw mechanism.\n * @notice Attempt to send ETH and if the transfer fails or runs out of gas, store the balance\n * for future withdrawal instead.\n */\nabstract contract SendValueWithFallbackWithdraw is ReentrancyGuardUpgradeable {\n  using AddressUpgradeable for address payable;\n\n  /// @dev Tracks the amount of ETH that is stored in escrow for future withdrawal.\n  mapping(address => uint256) private pendingWithdrawals;\n\n  /**\n   * @notice Emitted when an attempt to send ETH fails or runs out of gas and the value is stored in escrow instead.\n   * @param user The account which has escrowed ETH to withdraw.\n   * @param amount The amount of ETH which has been added to the user's escrow balance.\n   */\n  event WithdrawPending(address indexed user, uint256 amount);\n  /**\n   * @notice Emitted when escrowed funds are withdrawn.\n   * @param user The account which has withdrawn ETH.\n   * @param amount The amount of ETH which has been withdrawn.\n   */\n  event Withdrawal(address indexed user, uint256 amount);\n\n  /**\n   * @notice Allows a user to manually withdraw funds which originally failed to transfer to themselves.\n   */\n  function withdraw() external {\n    withdrawFor(payable(msg.sender));\n  }\n\n  /**\n   * @notice Allows anyone to manually trigger a withdrawal of funds which originally failed to transfer for a user.\n   * @param user The account which has escrowed ETH to withdraw.\n   */\n  function withdrawFor(address payable user) public nonReentrant {\n    uint256 amount = pendingWithdrawals[user];\n    if (amount == 0) {\n      revert SendValueWithFallbackWithdraw_No_Funds_Available();\n    }\n    pendingWithdrawals[user] = 0;\n    user.sendValue(amount);\n    emit Withdrawal(user, amount);\n  }\n\n  /**\n   * @dev Attempt to send a user or contract ETH and if it fails store the amount owned for later withdrawal.\n   */\n  function _sendValueWithFallbackWithdraw(\n    address payable user,\n    uint256 amount,\n    uint256 gasLimit\n  ) internal {\n    if (amount == 0) {\n      return;\n    }\n    // Cap the gas to prevent consuming all available gas to block a tx from completing successfully\n    // solhint-disable-next-line avoid-low-level-calls\n    (bool success, ) = user.call{ value: amount, gas: gasLimit }(\"\");\n    if (!success) {\n      // Record failed sends for a withdrawal later\n      // Transfers could fail if sent to a multisig with non-trivial receiver logic\n      unchecked {\n        pendingWithdrawals[user] += amount;\n      }\n      emit WithdrawPending(user, amount);\n    }\n  }\n\n  /**\n   * @notice Returns how much funds are available for manual withdraw due to failed transfers.\n   * @param user The account to check the escrowed balance of.\n   * @return balance The amount of funds which are available for withdrawal for the given user.\n   */\n  function getPendingWithdrawal(address user) external view returns (uint256 balance) {\n    return pendingWithdrawals[user];\n  }\n\n  /**\n   * @notice This empty reserved space is put in place to allow future versions to add new\n   * variables without shifting down storage in the inheritance chain.\n   * See https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps\n   */\n  uint256[499] private __gap;\n}"
    }
  ]
}