{
  "Title": "[L-03] - On transaction hooks arenâ€™t controlled by the lender",
  "Content": "Contrary to the docs [which state](https://github.com/code-423n4/2024-01-renft/blob/main/docs/hooks.md#:~:text=When%20signing%20a%20rental%20order%2C%20the%20lender%20can%20decide%20to%20include%20an%20array%20of%20Hook%20structs%20along%20with%20it.%20These%20are%20bespoke%20restrictions%20or%20added%20functionality%20that%20can%20be%20applied%20to%20the%20rented%20token%20within%20the%20wallet.) that the hooks are controlled by the lender - in reality all active on-transaction hooks run regardless of what the lender has specified in the order.\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2024-01-renft",
  "Code": [
    {
      "filename": "docs/hooks.md",
      "content": "## Rental Hooks\n\n### Overview\n\nWhen signing a rental order, the lender can decide to include an array of `Hook`\nstructs along with it. These are bespoke restrictions or added functionality\nthat can be applied to the rented token within the wallet. This protocol allows\nfor flexibility in how these hooks are implemented and what they restrict. A\ncommon use-case for a hook is to prevent a call to a specific function selector\non a contract when renting a particular token ID from an ERC721/ERC1155\ncollection.\n\n### Adding a Hook\n\nAdding a hook contract to the protocol is an admin-permissioned action on the [Guard Policy](https://github.com/re-nft/smart-contracts/blob/main/src/policies/Guard.sol) which is done via:\n\n`updateHookStatus()` which enables a hook for use within the protocol.\n\n`updateHookPath()` which specifies the contract which the rental wallet\ninteracts with that will activate the hook.\n\n### Specifying hooks as a lender\n\nWhen creating a rental, a `OrderMetadata` struct will be added to the order\nwhich specifies extra parameters to pass along with the rentals:\n\n```\nstruct OrderMetadata {\n    // the type of order being created\n    OrderType orderType;\n    // the duration of the rental in seconds\n    uint256 rentDuration;\n    // the hooks that will act as middleware for the items in the order\n    Hook[] hooks;\n    // any extra data to be emitted upon order fulfillment\n    bytes emittedExtraData;\n}\n```\n\nHooks can be added here to specify the unique functionality placed upon tokens\nin the order. Only hooks which have been enabled by the admin will be valid when\npassed to the `address target` field.\n\n```\nstruct Hook {\n    // the hook contract to target\n    address target;\n    // index of the item in the order to apply the hook to\n    uint256 itemIndex;\n    // any extra data that the hook will need. This will most likely\n    // be some type of bitmap scheme\n    bytes extraData;\n}\n```\n\n### Routing a call to the proper hook\n\nAfter a renter has successfully rented an ERC721/ERC1155, the [Guard Policy](https://github.com/re-nft/smart-contracts/blob/main/src/policies/Guard.sol)\n will be invoked each time a transaction originates from the wallet. The\ncontract will check its mapping for any hooks in the path of the interacting\naddress.\n\nIf a hook exists, the control flow will be handed over to the hook contract for\nfurther processing.\n\nIf no hook address was found, the rental guard contract contains basic\nrestrictions that prevents the usage of ERC721/ERC1155 state-changing functions.\n\n### Implementing a hook\n\nExample implementations of hooks can be found for [restricted selectors](https://github.com/re-nft/smart-contracts/tree/3ddd32455a849c3c6dc3c3aad7a33a6c9b44c291/src/examples/restricted-selector), [revenue share](https://github.com/re-nft/smart-contracts/tree/3ddd32455a849c3c6dc3c3aad7a33a6c9b44c291/src/examples/revenue-share), and [whitelisted fulfillment](https://github.com/re-nft/smart-contracts/tree/3ddd32455a849c3c6dc3c3aad7a33a6c9b44c291/src/examples/whitelisted-fulfillment).\n\nPer each erc721 `GameToken` ID, this hook uses a bitmap which tracks any\nfunction selectors that are restricted for that token ID only. Bitmaps allow\nsupport for up to 256 function selectors on a single contract.\n\nUsing a `token ID -> bitmap` mapping allows the property that 2 or more tokens\nfrom the same collection can be restricted in different ways based on how their\nlenders defined the permissions.\n\n### Extending a hook\n\nHooks are extendable. An allowlisted hook for a collection can be expanded even\nfurther to allow for multiple child hooks that are routed to based on logic\ndefined in the parent hook. This pattern enables granular control flow of the\ntransaction execution for any requirements or restrictions that a rental may\nhave."
    }
  ]
}