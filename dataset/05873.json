{
  "Title": "[L-10] Contracts can be re-deployed in `rUSDY` factory",
  "Content": "\nhttps://github.com/code-423n4/2023-09-ondo/blob/main/contracts/usdy/rUSDYFactory.sol#L75\n\nThe `rUSDY` contract can be redeployed by the guardian by calling `deployrUSDY()` in the `rUSDYFactory` contract. This will deploy a new set of contracts and overwrite the storage variables that link to the contract.\n\nIt is recommended to add a check to avoid redeployment once contracts have been deployed.\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2023-09-ondo",
  "Code": [
    {
      "filename": "contracts/usdy/rUSDYFactory.sol",
      "content": "/**SPDX-License-Identifier: BUSL-1.1\n\n      ▄▄█████████▄\n   ╓██▀└ ,╓▄▄▄, '▀██▄\n  ██▀ ▄██▀▀╙╙▀▀██▄ └██µ           ,,       ,,      ,     ,,,            ,,,\n ██ ,██¬ ▄████▄  ▀█▄ ╙█▄      ▄███▀▀███▄   ███▄    ██  ███▀▀▀███▄    ▄███▀▀███,\n██  ██ ╒█▀'   ╙█▌ ╙█▌ ██     ▐██      ███  █████,  ██  ██▌    └██▌  ██▌     └██▌\n██ ▐█▌ ██      ╟█  █▌ ╟█     ██▌      ▐██  ██ └███ ██  ██▌     ╟██ j██       ╟██\n╟█  ██ ╙██    ▄█▀ ▐█▌ ██     ╙██      ██▌  ██   ╙████  ██▌    ▄██▀  ██▌     ,██▀\n ██ \"██, ╙▀▀███████████⌐      ╙████████▀   ██     ╙██  ███████▀▀     ╙███████▀`\n  ██▄ ╙▀██▄▄▄▄▄,,,                ¬─                                    '─¬\n   ╙▀██▄ '╙╙╙▀▀▀▀▀▀▀▀\n      ╙▀▀██████R⌐\n\n */\npragma solidity 0.8.16;\n\n// Proxy admin contract used in OZ upgrades plugin\nimport \"contracts/external/openzeppelin/contracts/proxy/ProxyAdmin.sol\";\nimport \"contracts/Proxy.sol\";\nimport \"contracts/usdy/rUSDY.sol\";\nimport \"contracts/interfaces/IMulticall.sol\";\n\n/**\n * @title rUSDYFactory\n * @author Ondo Finance\n * @notice This contract serves as a Factory for the upgradable rUSDY token contract.\n *         Upon calling `deployrUSDY` the `guardian` address (set in constructor) will\n *         deploy the following:\n *         1) rUSDY - The implementation contract, ERC20 contract with the initializer disabled\n *         2) ProxyAdmin - OZ ProxyAdmin contract, used to upgrade the proxy instance.\n *                         @notice Owner is set to `guardian` address.\n *         3) TransparentUpgradeableProxy - OZ, proxy contract. Admin is set to `address(proxyAdmin)`.\n *                                          `_logic' is set to `address(rUSDY)`.\n *\n *         Following the above mentioned deployment, the address of the rUSDYFactory contract will:\n *         i) Grant the `DEFAULT_ADMIN_ROLE` & PAUSER_ROLE to the `guardian` address\n *         ii) Revoke the `MINTER_ROLE`, `PAUSER_ROLE` & `DEFAULT_ADMIN_ROLE` from address(this).\n *         iii) Transfer ownership of the ProxyAdmin to that of the `guardian` address.\n *\n * @notice `guardian` address in constructor is a msig.\n */\ncontract rUSDYFactory is IMulticall {\n  bytes32 public constant DEFAULT_ADMIN_ROLE = bytes32(0);\n\n  address internal immutable guardian;\n  rUSDY public rUSDYImplementation;\n  ProxyAdmin public rUSDYProxyAdmin;\n  TokenProxy public rUSDYProxy;\n\n  constructor(address _guardian) {\n    guardian = _guardian;\n  }\n\n  /**\n   * @dev This function will deploy an upgradable instance of rUSDY\n   *\n   * @param blocklist     The address of the blocklist\n   * @param allowlist     The address of the allowlist\n   * @param sanctionsList The address of the sanctions list\n   * @param usdy          The address of USDY\n   *\n   * @return address The address of the proxy contract.\n   * @return address The address of the proxyAdmin contract.\n   * @return address The address of the implementation contract.\n   *\n   * @notice 1) Will automatically revoke all deployer roles granted to\n   *            address(this).\n   *         2) Will grant DEFAULT_ADMIN & PAUSER_ROLE(S) to `guardian`\n   *            address specified in constructor.\n   *         3) Will transfer ownership of the proxyAdmin to guardian\n   *            address.\n   *\n   */\n  function deployrUSDY(\n    address blocklist,\n    address allowlist,\n    address sanctionsList,\n    address usdy,\n    address oracle\n  ) external onlyGuardian returns (address, address, address) {\n    rUSDYImplementation = new rUSDY();\n    rUSDYProxyAdmin = new ProxyAdmin();\n    rUSDYProxy = new TokenProxy(\n      address(rUSDYImplementation),\n      address(rUSDYProxyAdmin),\n      \"\"\n    );\n    rUSDY rUSDYProxied = rUSDY(address(rUSDYProxy));\n    rUSDYProxied.initialize(\n      blocklist,\n      allowlist,\n      sanctionsList,\n      usdy,\n      guardian,\n      oracle\n    );\n\n    rUSDYProxyAdmin.transferOwnership(guardian);\n    assert(rUSDYProxyAdmin.owner() == guardian);\n    emit rUSDYDeployed(\n      address(rUSDYProxy),\n      address(rUSDYProxyAdmin),\n      address(rUSDYImplementation),\n      \"Ondo Rebasing U.S. Dollar Yield\",\n      \"rUSDY\"\n    );\n    return (\n      address(rUSDYProxy),\n      address(rUSDYProxyAdmin),\n      address(rUSDYImplementation)\n    );\n  }\n\n  /**\n   * @notice Allows for arbitrary batched calls\n   *\n   * @dev All external calls made through this function will\n   *      msg.sender == contract address\n   *\n   * @param exCallData Struct consisting of\n   *       1) target - contract to call\n   *       2) data - data to call target with\n   *       3) value - eth value to call target with\n   */\n  function multiexcall(\n    ExCallData[] calldata exCallData\n  ) external payable override onlyGuardian returns (bytes[] memory results) {\n    results = new bytes[](exCallData.length);\n    for (uint256 i = 0; i < exCallData.length; ++i) {\n      (bool success, bytes memory ret) = address(exCallData[i].target).call{\n        value: exCallData[i].value\n      }(exCallData[i].data);\n      require(success, \"Call Failed\");\n      results[i] = ret;\n    }\n  }\n\n  /**\n   * @dev Event emitted when upgradable rUSDY is deployed\n   *\n   * @param proxy             The address for the proxy contract\n   * @param proxyAdmin        The address for the proxy admin contract\n   * @param implementation    The address for the implementation contract\n   */\n  event rUSDYDeployed(\n    address proxy,\n    address proxyAdmin,\n    address implementation,\n    string name,\n    string ticker\n  );\n\n  modifier onlyGuardian() {\n    require(msg.sender == guardian, \"rUSDYFactory: You are not the Guardian\");\n    _;\n  }\n}"
    }
  ]
}