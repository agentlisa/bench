{
  "Title": "M-9: LP tokens cannot be valued because ICHI cannot be priced by oracle, causing all new open positions to revert",
  "Content": "# Issue M-9: LP tokens cannot be valued because ICHI cannot be priced by oracle, causing all new open positions to revert \n\nSource: https://github.com/sherlock-audit/2023-02-blueberry-judging/issues/152 \n\n## Found by \nobront\n\n## Summary\n\nIn order to value ICHI LP tokens, the oracle uses the Fair LP Pricing technique, which uses the prices of both individual tokens, along with the quantities, to calculate the LP token value. However, this process requires the underlying token prices to be accessible by the oracle. Both Chainlink and Band do not support the ICHI token, so the function will fail, causing all new positions using the IchiVaultSpell to revert.\n\n## Vulnerability Detail\n\nWhen a new Ichi position is opened, the ICHI LP tokens are posted as collateral. Their value is assessed using the `IchiLpOracle#getPrice()` function:\n\n```solidity\nfunction getPrice(address token) external view override returns (uint256) {\n    IICHIVault vault = IICHIVault(token);\n    uint256 totalSupply = vault.totalSupply();\n    if (totalSupply == 0) return 0;\n\n    address token0 = vault.token0();\n    address token1 = vault.token1();\n\n    (uint256 r0, uint256 r1) = vault.getTotalAmounts();\n    uint256 px0 = base.getPrice(address(token0));\n    uint256 px1 = base.getPrice(address(token1));\n    uint256 t0Decimal = IERC20Metadata(token0).decimals();\n    uint256 t1Decimal = IERC20Metadata(token1).decimals();\n\n    uint256 totalReserve = (r0 * px0) /\n        10**t0Decimal +\n        (r1 * px1) /\n        10**t1Decimal;\n\n    return (totalReserve * 1e18) / totalSupply;\n}\n```\nThis function uses the \"Fair LP Pricing\" formula, made famous by Alpha Homora. To simplify, this uses an oracle to get the prices of both underlying tokens, and then calculates the LP price based on these values and the reserves.\n\nHowever, this process requires that we have a functioning oracle for the underlying tokens. However, [Chainlink](https://data.chain.link/) and [Band](https://data.bandprotocol.com/) both do not support the ICHI token (see the links for their comprehensive lists of data feeds). As a result, the call to `base.getPrice(token0)` will fail.\n\nAll prices are calculated in the `isLiquidatable()` check at the end of the `execute()` function. As a result, any attempt to open a new ICHI position and post the LP tokens as collateral (which happens in both `openPosition()` and `openPositionFarm()`) will revert.\n\n## Impact\n\nAll new positions opened using the `IchiVaultSpell`  will revert when they attempt to look up the LP token price, rendering the protocol useless.\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-02-blueberry/blob/main/contracts/oracle/IchiLpOracle.sol#L19-L39\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nThere will need to be an alternate form of oracle that can price the ICHI token. The best way to accomplish this is likely to use a TWAP of the price on an AMM.\n\n## Discussion\n\n**Gornutz**\n\nThere is additional oracles for assets not supported by chainlink or band but just not in scope of this specific audit.\n\n**hrishibhat**\n\nBased on the context there are no implementations for getting the price of the ICHI token. Considering this a valid issue. \n\n\n**SergeKireev**\n\nEscalate for 31 USDC\n\nImpact stated is medium, since positions cannot be opened and no funds are at risk.\nThe high severity definition as stated per Sherlock docs:\n\n>This vulnerability would result in a material loss of funds and the cost of the attack is low (relative to the amount of funds lost). The attack path is possible with reasonable assumptions that mimic on-chain conditions. The vulnerability must be something that is not considered an acceptable risk by a reasonable protocol team.\n\n**sherlock-admin**\n\n > Escalate for 31 USDC\n> \n> Impact stated is medium, since positions cannot be opened and no funds are at risk.\n> The high severity definition as stated per Sherlock docs:\n> \n> >This vulnerability would result in a material loss of funds and the cost of the attack is low (relative to the amount of funds lost). The attack path is possible with reasonable assumptions that mimic on-chain conditions. The vulnerability must be something that is not considered an acceptable risk by a reasonable protocol team.\n\nYou've created a valid escalation for 31 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\nTo change the amount you've staked on this escalation: Edit your comment **(do not create a new comment)**.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**hrishibhat**\n\nEscalation accepted\n\nThis is a valid medium\nAlso Given that this is an issue only for the Ichi tokens and impact is only unable to open positions.\n\n**sherlock-admin**\n\n> Escalation accepted\n> \n> This is a valid medium\n> Also Given that this is an issue only for the Ichi tokens and impact is only unable to open positions.\n\nThis issue's escalations have been accepted!\n\nContestants' payouts and scores will be updated according to the changes made on this issue.\n\n\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/41",
  "Code": [
    {
      "filename": "contracts/oracle/IchiLpOracle.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity 0.8.16;\n\nimport '@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol';\n\nimport './UsingBaseOracle.sol';\nimport '../interfaces/IBaseOracle.sol';\nimport '../interfaces/ichi/IICHIVault.sol';\n\ncontract IchiLpOracle is UsingBaseOracle, IBaseOracle {\n    constructor(IBaseOracle _base) UsingBaseOracle(_base) {}\n\n    /**\n     * @notice Return lp token price in USD, with 18 decimals of precision.\n     * @param token The underlying token address for which to get the price.\n     * @return Price in USD\n     */\n    function getPrice(address token) external view override returns (uint256) {\n        IICHIVault vault = IICHIVault(token);\n        uint256 totalSupply = vault.totalSupply();\n        if (totalSupply == 0) return 0;\n\n        address token0 = vault.token0();\n        address token1 = vault.token1();\n\n        (uint256 r0, uint256 r1) = vault.getTotalAmounts();\n        uint256 px0 = base.getPrice(address(token0));\n        uint256 px1 = base.getPrice(address(token1));\n        uint256 t0Decimal = IERC20Metadata(token0).decimals();\n        uint256 t1Decimal = IERC20Metadata(token1).decimals();\n\n        uint256 totalReserve = (r0 * px0) /\n            10**t0Decimal +\n            (r1 * px1) /\n            10**t1Decimal;\n\n        return (totalReserve * 1e18) / totalSupply;\n    }\n}"
    }
  ]
}