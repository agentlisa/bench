{
  "Title": "[FIXED] `Calldata` location can be used for function parameters in multiple contracts and interfaces",
  "Content": "##### Location\nFile | Location | Line\n--- | --- | ---\n[AllowedTokensRegistry.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedTokensRegistry.sol#L42 \"/contracts/AllowedTokensRegistry.sol\") | contract `AllowedTokensRegistry` > `constructor` | 42\n[AllowedRecipientsFactory.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsFactory.sol#L58 \"/contracts/AllowedRecipientsFactory.sol\") | contract `AllowedRecipientsFactory` > function `deployAllowedRecipientsRegistry` | 58\n[AllowedRecipientsFactory.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsFactory.sol#L87 \"/contracts/AllowedRecipientsFactory.sol\") | contract `AllowedRecipientsFactory` > function `deployAllowedTokensRegistry` | 87\n[AllowedRecipientsBuilder.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L37 \"/contracts/AllowedRecipientsBuilder.sol\") | interface `IAllowedRecipientsFactory` > function `deployAllowedRecipientsRegistry` | 37\n[AllowedRecipientsBuilder.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L46 \"/contracts/AllowedRecipientsBuilder.sol\") | interface `IAllowedRecipientsFactory` > function `deployAllowedTokensRegistry` | 46\n[AllowedRecipientsBuilder.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L101 \"/contracts/AllowedRecipientsBuilder.sol\") | contract `AllowedRecipientsBuilder` > function `deployAllowedRecipientsRegistry` | 101\n[AllowedRecipientsBuilder.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L193 \"/contracts/AllowedRecipientsBuilder.sol\") | contract `AllowedRecipientsBuilder` > function `deployAllowedTokensRegistry` | 193\n[AllowedRecipientsBuilder.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L259 \"/contracts/AllowedRecipientsBuilder.sol\") | contract `AllowedRecipientsBuilder` > function `deployFullSetup` | 259\n[AllowedRecipientsBuilder.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L279 \"/contracts/AllowedRecipientsBuilder.sol\") | contract `AllowedRecipientsBuilder` > function `deploySingleRecipientTopUpOnlySetup` | 279\n[TopUpAllowedRecipients.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L75 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\") | contract `TopUpAllowedRecipients` > function `createEVMScript` | 75\n[TopUpAllowedRecipients.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L110 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\") | contract `TopUpAllowedRecipients` > function `decodeEVMScriptCallData` | 110\n[TopUpAllowedRecipients.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L122 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\") | contract `TopUpAllowedRecipients` > function `_validateEVMScriptCallData` | 122\n[TopUpAllowedRecipients.sol](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L144 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\") | contract `TopUpAllowedRecipients` > function `_decodeEVMScriptCallData` | 144\n\n##### Description\nIn the [constructor](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedTokensRegistry.sol#L42 \"/contracts/AllowedTokensRegistry.sol\") of the `AllowedTokensRegistry` contract, in the functions\n- [`deployAllowedRecipientsRegistry`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L37)\n- [`deployAllowedTokensRegistry`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L46)\n\nof the `IAllowedRecipientsFactory` interface,\n- [`deployAllowedRecipientsRegistry`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsFactory.sol#L58)\n- [`deployAllowedTokensRegistry`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsFactory.sol#L87)\n\nof the `AllowedRecipientsFactory` contract,\n- [`deployAllowedRecipientsRegistry`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L101)\n- [`deployAllowedTokensRegistry`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L193)\n- [`deployFullSetup`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L259)\n- [`deploySingleRecipientTopUpOnlySetup`](https://github.com/lidofinance/easy-track/blob/425f4a254ceb2be389f669580b9dc76618e92756/contracts/AllowedRecipientsBuilder.sol#L279)\n\nof the `AllowedRecipientsBuilder` contract,\n- [`createEVMScript`](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L75 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\"),\n- [`decodeEVMScriptCallData`](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L110 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\"),\n- [`_validateEVMScriptCallData`](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L122 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\"),\n- [`_decodeEVMScriptCallData`](https://github.com/lidofinance/easy-track/tree/425f4a254ceb2be389f669580b9dc76618e92756/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol#L144 \"/contracts/EVMScriptFactories/TopUpAllowedRecipients.sol\")\n\nof the `TopUpAllowedRecipients` contract the function arguments are unnecessarily kept in memory, which can lead to inefficient gas usage.\n##### Recommendation\nWe recommend changing the function arguments from `memory` to `calldata`, unless the code explicitly requires the argument to be in memory and modifies it. This will result in more efficient gas usage and improve the overall performance of the contract.\n##### Update\nFixed in the commit [`3b718ad094ed54da1d7e216c03b38b856dcac7a6`](https://github.com/lidofinance/easy-track/commit/3b718ad094ed54da1d7e216c03b38b856dcac7a6).\n###### Lido's response\nFixed everything, except:\n1) `constructor` in `AllowedTokensRegistry`. Data location must be `storage` or `memory` for constructor parameter in solidity 0.8.4. \"Calldata is a non-modifiable, non-persistent area where function arguments are stored\" (https://docs.soliditylang.org/en/v0.8.4/types.html#data-location)\n2) `deployAllowedRecipientsRegistry` in `AllowedRecipientsBuilder`. This function is used from `deploySingleRecipientTopUpOnlySetup` with memory parameters what creates invalid implicit conversion.\n3) `_validateEVMScriptCallData` in `TopUpAllowedRecipients`. This function is private and used only from `createEVMScript` with memory parameters.",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/AllowedRecipientsBuilder.sol",
      "content": "// SPDX-FileCopyrightText: 2022 Lido <info@lido.fi>\n// SPDX-License-Identifier: GPL-3.0\n\npragma solidity ^0.8.4;\n\nimport \"./interfaces/IAllowedRecipientsRegistry.sol\";\nimport \"./interfaces/IAllowedTokensRegistry.sol\";\nimport \"./interfaces/IEasyTrack.sol\";\n\ninterface ITopUpAllowedRecipients {\n    function token() external view returns (address);\n\n    function finance() external view returns (address);\n\n    function easyTrack() external view returns (IEasyTrack);\n\n    function trustedCaller() external view returns (address);\n\n    function allowedRecipientsRegistry() external view returns (address);\n\n    function allowedTokensRegistry() external view returns (address);\n}\n\ninterface IAddAllowedRecipient {\n    function trustedCaller() external view returns (address);\n\n    function allowedRecipientsRegistry() external view returns (address);\n}\n\ninterface IRemoveAllowedRecipient {\n    function trustedCaller() external view returns (address);\n\n    function allowedRecipientsRegistry() external view returns (address);\n}\n\ninterface IAllowedRecipientsFactory {\n    function deployAllowedRecipientsRegistry(\n        address _admin,\n        address[] memory _addRecipientToAllowedListRoleHolders,\n        address[] memory _removeRecipientFromAllowedListRoleHolders,\n        address[] memory _setLimitParametersRoleHolders,\n        address[] memory _updateSpentAmountRoleHolders,\n        address bokkyPooBahsDateTimeContract\n    ) external returns (IAllowedRecipientsRegistry);\n\n    function deployAllowedTokensRegistry(\n        address _defaultAdmin,\n        address[] memory _addTokensToAllowedListRoleHolders,\n        address[] memory _removeTokensFromAllowedListRoleHolders\n    ) external returns (IAllowedTokensRegistry registry);\n\n    function deployTopUpAllowedRecipients(\n        address _trustedCaller,\n        address _allowedRecipientsRegistry,\n        address _allowedTokensRegistry,\n        address _finance,\n        address _easyTrack\n    ) external returns (ITopUpAllowedRecipients topUpAllowedRecipients);\n\n    function deployAddAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        external\n        returns (IAddAllowedRecipient);\n\n    function deployRemoveAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        external\n        returns (IRemoveAllowedRecipient);\n}\n\ncontract AllowedRecipientsBuilder {\n    IEasyTrack public immutable easyTrack;\n    address public immutable finance;\n    address public immutable evmScriptExecutor;\n    address public immutable admin;\n    address public immutable bokkyPooBahsDateTimeContract;\n    IAllowedRecipientsFactory public immutable factory;\n\n    bytes32 public constant ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE = keccak256(\"ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE\");\n    bytes32 public constant REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE =\n        keccak256(\"REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE\");\n    bytes32 public constant ADD_TOKEN_TO_ALLOWED_LIST_ROLE = keccak256(\"ADD_TOKEN_TO_ALLOWED_LIST_ROLE\");\n    bytes32 public constant REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE = keccak256(\"REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE\");\n    bytes32 public constant DEFAULT_ADMIN_ROLE = 0x00;\n    bytes32 public constant SET_PARAMETERS_ROLE = keccak256(\"SET_PARAMETERS_ROLE\");\n    bytes32 public constant UPDATE_SPENT_AMOUNT_ROLE = keccak256(\"UPDATE_SPENT_AMOUNT_ROLE\");\n\n    constructor(\n        IAllowedRecipientsFactory _factory,\n        address _admin,\n        IEasyTrack _easytrack,\n        address _finance,\n        address _bokkyPooBahsDateTimeContract\n    ) {\n        factory = _factory;\n        evmScriptExecutor = _easytrack.evmScriptExecutor();\n        admin = _admin;\n        easyTrack = _easytrack;\n        finance = _finance;\n        bokkyPooBahsDateTimeContract = _bokkyPooBahsDateTimeContract;\n    }\n\n    function deployAllowedRecipientsRegistry(\n        uint256 _limit,\n        uint256 _periodDurationMonths,\n        address[] memory _recipients,\n        string[] memory _titles,\n        uint256 _spentAmount,\n        bool _grantRightsToEVMScriptExecutor\n    ) public returns (IAllowedRecipientsRegistry registry) {\n        require(_recipients.length == _titles.length, \"Recipients data length mismatch\");\n        require(_spentAmount <= _limit, \"_spentAmount must be lower or equal to limit\");\n\n        address[] memory addRecipientToAllowedListRoleHolders = new address[](\n            _grantRightsToEVMScriptExecutor ? 3 : 2\n        );\n        addRecipientToAllowedListRoleHolders[0] = admin;\n        addRecipientToAllowedListRoleHolders[1] = address(this);\n        if (_grantRightsToEVMScriptExecutor) {\n            addRecipientToAllowedListRoleHolders[2] = evmScriptExecutor;\n        }\n        address[] memory removeRecipientFromAllowedListRoleHolders = new address[](\n            _grantRightsToEVMScriptExecutor ? 2 : 1\n        );\n        removeRecipientFromAllowedListRoleHolders[0] = admin;\n        if (_grantRightsToEVMScriptExecutor) {\n            removeRecipientFromAllowedListRoleHolders[1] = evmScriptExecutor;\n        }\n        address[] memory setLimitParametersRoleHolders = new address[](2);\n        setLimitParametersRoleHolders[0] = admin;\n        setLimitParametersRoleHolders[1] = address(this);\n        address[] memory updateSpentAmountRoleHolders = new address[](3);\n        updateSpentAmountRoleHolders[0] = admin;\n        updateSpentAmountRoleHolders[1] = evmScriptExecutor;\n        updateSpentAmountRoleHolders[2] = address(this);\n\n        registry = factory.deployAllowedRecipientsRegistry(\n            admin,\n            addRecipientToAllowedListRoleHolders,\n            removeRecipientFromAllowedListRoleHolders,\n            setLimitParametersRoleHolders,\n            updateSpentAmountRoleHolders,\n            bokkyPooBahsDateTimeContract\n        );\n\n        assert(registry.bokkyPooBahsDateTimeContract() == bokkyPooBahsDateTimeContract);\n\n        for (uint256 i = 0; i < _recipients.length; i++) {\n            registry.addRecipient(_recipients[i], _titles[i]);\n        }\n        registry.renounceRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, address(this));\n\n        assert(registry.getAllowedRecipients().length == _recipients.length);\n\n        for (uint256 i = 0; i < _recipients.length; i++) {\n            assert(registry.isRecipientAllowed(_recipients[i]));\n        }\n\n        registry.setLimitParameters(_limit, _periodDurationMonths);\n        registry.renounceRole(SET_PARAMETERS_ROLE, address(this));\n\n        (uint256 registryLimit, uint256 registryPeriodDuration) = registry.getLimitParameters();\n        assert(registryLimit == _limit);\n        assert(registryPeriodDuration == _periodDurationMonths);\n\n        registry.updateSpentAmount(_spentAmount);\n        registry.renounceRole(UPDATE_SPENT_AMOUNT_ROLE, address(this));\n\n        assert(registry.spendableBalance() == _limit - _spentAmount);\n\n        assert(registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(SET_PARAMETERS_ROLE, admin));\n        assert(registry.hasRole(UPDATE_SPENT_AMOUNT_ROLE, admin));\n        assert(registry.hasRole(DEFAULT_ADMIN_ROLE, admin));\n\n        if (_grantRightsToEVMScriptExecutor) {\n            assert(registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, evmScriptExecutor));\n            assert(registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, evmScriptExecutor));\n        } else {\n            assert(!registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, evmScriptExecutor));\n            assert(!registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, evmScriptExecutor));\n        }\n        assert(registry.hasRole(UPDATE_SPENT_AMOUNT_ROLE, evmScriptExecutor));\n        assert(!registry.hasRole(SET_PARAMETERS_ROLE, evmScriptExecutor));\n        assert(!registry.hasRole(DEFAULT_ADMIN_ROLE, evmScriptExecutor));\n\n        assert(!registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(SET_PARAMETERS_ROLE, address(this)));\n        assert(!registry.hasRole(UPDATE_SPENT_AMOUNT_ROLE, address(this)));\n        assert(!registry.hasRole(DEFAULT_ADMIN_ROLE, address(this)));\n    }\n\n    function deployAllowedTokensRegistry(address[] memory _tokens) public returns (IAllowedTokensRegistry registry) {\n        address[] memory addTokenRoleHolders = new address[](2);\n        address[] memory removeTokenRoleHolders = new address[](1);\n\n        addTokenRoleHolders[0] = admin;\n        addTokenRoleHolders[1] = address(this);\n\n        removeTokenRoleHolders[0] = admin;\n\n        registry = factory.deployAllowedTokensRegistry(admin, addTokenRoleHolders, removeTokenRoleHolders);\n\n        for (uint256 i = 0; i < _tokens.length; i++) {\n            registry.addToken(_tokens[i]);\n        }\n\n        registry.renounceRole(ADD_TOKEN_TO_ALLOWED_LIST_ROLE, address(this));\n\n        for (uint256 i = 0; i < _tokens.length; i++) {\n            assert(registry.isTokenAllowed(_tokens[i]));\n        }\n\n        assert(registry.hasRole(ADD_TOKEN_TO_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(DEFAULT_ADMIN_ROLE, admin));\n\n        assert(!registry.hasRole(ADD_TOKEN_TO_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(DEFAULT_ADMIN_ROLE, address(this)));\n    }\n\n    function deployTopUpAllowedRecipients(\n        address _trustedCaller,\n        address _allowedRecipientsRegistry,\n        address _allowedTokensRegistry\n    ) public returns (ITopUpAllowedRecipients topUpAllowedRecipients) {\n        topUpAllowedRecipients = factory.deployTopUpAllowedRecipients(\n            _trustedCaller, _allowedRecipientsRegistry, _allowedTokensRegistry, finance, address(easyTrack)\n        );\n\n        assert(topUpAllowedRecipients.finance() == finance);\n        assert(topUpAllowedRecipients.easyTrack() == easyTrack);\n        assert(topUpAllowedRecipients.trustedCaller() == _trustedCaller);\n        assert(address(topUpAllowedRecipients.allowedRecipientsRegistry()) == _allowedRecipientsRegistry);\n        assert(address(topUpAllowedRecipients.allowedTokensRegistry()) == _allowedTokensRegistry);\n    }\n\n    function deployAddAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        public\n        returns (IAddAllowedRecipient addAllowedRecipient)\n    {\n        addAllowedRecipient = factory.deployAddAllowedRecipient(_trustedCaller, _allowedRecipientsRegistry);\n\n        assert(addAllowedRecipient.trustedCaller() == _trustedCaller);\n        assert(address(addAllowedRecipient.allowedRecipientsRegistry()) == _allowedRecipientsRegistry);\n    }\n\n    function deployRemoveAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        public\n        returns (IRemoveAllowedRecipient removeAllowedRecipient)\n    {\n        removeAllowedRecipient = factory.deployRemoveAllowedRecipient(_trustedCaller, _allowedRecipientsRegistry);\n\n        assert(removeAllowedRecipient.trustedCaller() == _trustedCaller);\n        assert(address(removeAllowedRecipient.allowedRecipientsRegistry()) == _allowedRecipientsRegistry);\n    }\n\n    function deployFullSetup(\n        address _trustedCaller,\n        uint256 _limit,\n        uint256 _periodDurationMonths,\n        address[] memory _tokens,\n        address[] memory _recipients,\n        string[] memory _titles,\n        uint256 _spentAmount\n    ) public {\n        IAllowedRecipientsRegistry allowedRecipientsRegistry =\n            deployAllowedRecipientsRegistry(_limit, _periodDurationMonths, _recipients, _titles, _spentAmount, true);\n        IAllowedTokensRegistry allowedTokensRegistry = deployAllowedTokensRegistry(_tokens);\n\n        deployTopUpAllowedRecipients(_trustedCaller, address(allowedRecipientsRegistry), address(allowedTokensRegistry));\n\n        deployAddAllowedRecipient(_trustedCaller, address(allowedRecipientsRegistry));\n\n        deployRemoveAllowedRecipient(_trustedCaller, address(allowedRecipientsRegistry));\n    }\n\n    function deploySingleRecipientTopUpOnlySetup(\n        address _recipient,\n        string memory _title,\n        address[] memory _tokens,\n        uint256 _limit,\n        uint256 _periodDurationMonths,\n        uint256 _spentAmount\n    ) public {\n        address[] memory recipients = new address[](1);\n        recipients[0] = _recipient;\n\n        string[] memory titles = new string[](1);\n        titles[0] = _title;\n\n        IAllowedRecipientsRegistry allowedRecipientsRegistry =\n            deployAllowedRecipientsRegistry(_limit, _periodDurationMonths, recipients, titles, _spentAmount, false);\n        IAllowedTokensRegistry allowedTokensRegistry = deployAllowedTokensRegistry(_tokens);\n\n        deployTopUpAllowedRecipients(_recipient, address(allowedRecipientsRegistry), address(allowedTokensRegistry));\n    }\n}"
    },
    {
      "filename": "contracts/AllowedRecipientsBuilder.sol",
      "content": "// SPDX-FileCopyrightText: 2022 Lido <info@lido.fi>\n// SPDX-License-Identifier: GPL-3.0\n\npragma solidity ^0.8.4;\n\nimport \"./interfaces/IAllowedRecipientsRegistry.sol\";\nimport \"./interfaces/IAllowedTokensRegistry.sol\";\nimport \"./interfaces/IEasyTrack.sol\";\n\ninterface ITopUpAllowedRecipients {\n    function token() external view returns (address);\n\n    function finance() external view returns (address);\n\n    function easyTrack() external view returns (IEasyTrack);\n\n    function trustedCaller() external view returns (address);\n\n    function allowedRecipientsRegistry() external view returns (address);\n\n    function allowedTokensRegistry() external view returns (address);\n}\n\ninterface IAddAllowedRecipient {\n    function trustedCaller() external view returns (address);\n\n    function allowedRecipientsRegistry() external view returns (address);\n}\n\ninterface IRemoveAllowedRecipient {\n    function trustedCaller() external view returns (address);\n\n    function allowedRecipientsRegistry() external view returns (address);\n}\n\ninterface IAllowedRecipientsFactory {\n    function deployAllowedRecipientsRegistry(\n        address _admin,\n        address[] memory _addRecipientToAllowedListRoleHolders,\n        address[] memory _removeRecipientFromAllowedListRoleHolders,\n        address[] memory _setLimitParametersRoleHolders,\n        address[] memory _updateSpentAmountRoleHolders,\n        address bokkyPooBahsDateTimeContract\n    ) external returns (IAllowedRecipientsRegistry);\n\n    function deployAllowedTokensRegistry(\n        address _defaultAdmin,\n        address[] memory _addTokensToAllowedListRoleHolders,\n        address[] memory _removeTokensFromAllowedListRoleHolders\n    ) external returns (IAllowedTokensRegistry registry);\n\n    function deployTopUpAllowedRecipients(\n        address _trustedCaller,\n        address _allowedRecipientsRegistry,\n        address _allowedTokensRegistry,\n        address _finance,\n        address _easyTrack\n    ) external returns (ITopUpAllowedRecipients topUpAllowedRecipients);\n\n    function deployAddAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        external\n        returns (IAddAllowedRecipient);\n\n    function deployRemoveAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        external\n        returns (IRemoveAllowedRecipient);\n}\n\ncontract AllowedRecipientsBuilder {\n    IEasyTrack public immutable easyTrack;\n    address public immutable finance;\n    address public immutable evmScriptExecutor;\n    address public immutable admin;\n    address public immutable bokkyPooBahsDateTimeContract;\n    IAllowedRecipientsFactory public immutable factory;\n\n    bytes32 public constant ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE = keccak256(\"ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE\");\n    bytes32 public constant REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE =\n        keccak256(\"REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE\");\n    bytes32 public constant ADD_TOKEN_TO_ALLOWED_LIST_ROLE = keccak256(\"ADD_TOKEN_TO_ALLOWED_LIST_ROLE\");\n    bytes32 public constant REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE = keccak256(\"REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE\");\n    bytes32 public constant DEFAULT_ADMIN_ROLE = 0x00;\n    bytes32 public constant SET_PARAMETERS_ROLE = keccak256(\"SET_PARAMETERS_ROLE\");\n    bytes32 public constant UPDATE_SPENT_AMOUNT_ROLE = keccak256(\"UPDATE_SPENT_AMOUNT_ROLE\");\n\n    constructor(\n        IAllowedRecipientsFactory _factory,\n        address _admin,\n        IEasyTrack _easytrack,\n        address _finance,\n        address _bokkyPooBahsDateTimeContract\n    ) {\n        factory = _factory;\n        evmScriptExecutor = _easytrack.evmScriptExecutor();\n        admin = _admin;\n        easyTrack = _easytrack;\n        finance = _finance;\n        bokkyPooBahsDateTimeContract = _bokkyPooBahsDateTimeContract;\n    }\n\n    function deployAllowedRecipientsRegistry(\n        uint256 _limit,\n        uint256 _periodDurationMonths,\n        address[] memory _recipients,\n        string[] memory _titles,\n        uint256 _spentAmount,\n        bool _grantRightsToEVMScriptExecutor\n    ) public returns (IAllowedRecipientsRegistry registry) {\n        require(_recipients.length == _titles.length, \"Recipients data length mismatch\");\n        require(_spentAmount <= _limit, \"_spentAmount must be lower or equal to limit\");\n\n        address[] memory addRecipientToAllowedListRoleHolders = new address[](\n            _grantRightsToEVMScriptExecutor ? 3 : 2\n        );\n        addRecipientToAllowedListRoleHolders[0] = admin;\n        addRecipientToAllowedListRoleHolders[1] = address(this);\n        if (_grantRightsToEVMScriptExecutor) {\n            addRecipientToAllowedListRoleHolders[2] = evmScriptExecutor;\n        }\n        address[] memory removeRecipientFromAllowedListRoleHolders = new address[](\n            _grantRightsToEVMScriptExecutor ? 2 : 1\n        );\n        removeRecipientFromAllowedListRoleHolders[0] = admin;\n        if (_grantRightsToEVMScriptExecutor) {\n            removeRecipientFromAllowedListRoleHolders[1] = evmScriptExecutor;\n        }\n        address[] memory setLimitParametersRoleHolders = new address[](2);\n        setLimitParametersRoleHolders[0] = admin;\n        setLimitParametersRoleHolders[1] = address(this);\n        address[] memory updateSpentAmountRoleHolders = new address[](3);\n        updateSpentAmountRoleHolders[0] = admin;\n        updateSpentAmountRoleHolders[1] = evmScriptExecutor;\n        updateSpentAmountRoleHolders[2] = address(this);\n\n        registry = factory.deployAllowedRecipientsRegistry(\n            admin,\n            addRecipientToAllowedListRoleHolders,\n            removeRecipientFromAllowedListRoleHolders,\n            setLimitParametersRoleHolders,\n            updateSpentAmountRoleHolders,\n            bokkyPooBahsDateTimeContract\n        );\n\n        assert(registry.bokkyPooBahsDateTimeContract() == bokkyPooBahsDateTimeContract);\n\n        for (uint256 i = 0; i < _recipients.length; i++) {\n            registry.addRecipient(_recipients[i], _titles[i]);\n        }\n        registry.renounceRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, address(this));\n\n        assert(registry.getAllowedRecipients().length == _recipients.length);\n\n        for (uint256 i = 0; i < _recipients.length; i++) {\n            assert(registry.isRecipientAllowed(_recipients[i]));\n        }\n\n        registry.setLimitParameters(_limit, _periodDurationMonths);\n        registry.renounceRole(SET_PARAMETERS_ROLE, address(this));\n\n        (uint256 registryLimit, uint256 registryPeriodDuration) = registry.getLimitParameters();\n        assert(registryLimit == _limit);\n        assert(registryPeriodDuration == _periodDurationMonths);\n\n        registry.updateSpentAmount(_spentAmount);\n        registry.renounceRole(UPDATE_SPENT_AMOUNT_ROLE, address(this));\n\n        assert(registry.spendableBalance() == _limit - _spentAmount);\n\n        assert(registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(SET_PARAMETERS_ROLE, admin));\n        assert(registry.hasRole(UPDATE_SPENT_AMOUNT_ROLE, admin));\n        assert(registry.hasRole(DEFAULT_ADMIN_ROLE, admin));\n\n        if (_grantRightsToEVMScriptExecutor) {\n            assert(registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, evmScriptExecutor));\n            assert(registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, evmScriptExecutor));\n        } else {\n            assert(!registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, evmScriptExecutor));\n            assert(!registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, evmScriptExecutor));\n        }\n        assert(registry.hasRole(UPDATE_SPENT_AMOUNT_ROLE, evmScriptExecutor));\n        assert(!registry.hasRole(SET_PARAMETERS_ROLE, evmScriptExecutor));\n        assert(!registry.hasRole(DEFAULT_ADMIN_ROLE, evmScriptExecutor));\n\n        assert(!registry.hasRole(ADD_RECIPIENT_TO_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(REMOVE_RECIPIENT_FROM_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(SET_PARAMETERS_ROLE, address(this)));\n        assert(!registry.hasRole(UPDATE_SPENT_AMOUNT_ROLE, address(this)));\n        assert(!registry.hasRole(DEFAULT_ADMIN_ROLE, address(this)));\n    }\n\n    function deployAllowedTokensRegistry(address[] memory _tokens) public returns (IAllowedTokensRegistry registry) {\n        address[] memory addTokenRoleHolders = new address[](2);\n        address[] memory removeTokenRoleHolders = new address[](1);\n\n        addTokenRoleHolders[0] = admin;\n        addTokenRoleHolders[1] = address(this);\n\n        removeTokenRoleHolders[0] = admin;\n\n        registry = factory.deployAllowedTokensRegistry(admin, addTokenRoleHolders, removeTokenRoleHolders);\n\n        for (uint256 i = 0; i < _tokens.length; i++) {\n            registry.addToken(_tokens[i]);\n        }\n\n        registry.renounceRole(ADD_TOKEN_TO_ALLOWED_LIST_ROLE, address(this));\n\n        for (uint256 i = 0; i < _tokens.length; i++) {\n            assert(registry.isTokenAllowed(_tokens[i]));\n        }\n\n        assert(registry.hasRole(ADD_TOKEN_TO_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE, admin));\n        assert(registry.hasRole(DEFAULT_ADMIN_ROLE, admin));\n\n        assert(!registry.hasRole(ADD_TOKEN_TO_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(REMOVE_TOKEN_FROM_ALLOWED_LIST_ROLE, address(this)));\n        assert(!registry.hasRole(DEFAULT_ADMIN_ROLE, address(this)));\n    }\n\n    function deployTopUpAllowedRecipients(\n        address _trustedCaller,\n        address _allowedRecipientsRegistry,\n        address _allowedTokensRegistry\n    ) public returns (ITopUpAllowedRecipients topUpAllowedRecipients) {\n        topUpAllowedRecipients = factory.deployTopUpAllowedRecipients(\n            _trustedCaller, _allowedRecipientsRegistry, _allowedTokensRegistry, finance, address(easyTrack)\n        );\n\n        assert(topUpAllowedRecipients.finance() == finance);\n        assert(topUpAllowedRecipients.easyTrack() == easyTrack);\n        assert(topUpAllowedRecipients.trustedCaller() == _trustedCaller);\n        assert(address(topUpAllowedRecipients.allowedRecipientsRegistry()) == _allowedRecipientsRegistry);\n        assert(address(topUpAllowedRecipients.allowedTokensRegistry()) == _allowedTokensRegistry);\n    }\n\n    function deployAddAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        public\n        returns (IAddAllowedRecipient addAllowedRecipient)\n    {\n        addAllowedRecipient = factory.deployAddAllowedRecipient(_trustedCaller, _allowedRecipientsRegistry);\n\n        assert(addAllowedRecipient.trustedCaller() == _trustedCaller);\n        assert(address(addAllowedRecipient.allowedRecipientsRegistry()) == _allowedRecipientsRegistry);\n    }\n\n    function deployRemoveAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        public\n        returns (IRemoveAllowedRecipient removeAllowedRecipient)\n    {\n        removeAllowedRecipient = factory.deployRemoveAllowedRecipient(_trustedCaller, _allowedRecipientsRegistry);\n\n        assert(removeAllowedRecipient.trustedCaller() == _trustedCaller);\n        assert(address(removeAllowedRecipient.allowedRecipientsRegistry()) == _allowedRecipientsRegistry);\n    }\n\n    function deployFullSetup(\n        address _trustedCaller,\n        uint256 _limit,\n        uint256 _periodDurationMonths,\n        address[] memory _tokens,\n        address[] memory _recipients,\n        string[] memory _titles,\n        uint256 _spentAmount\n    ) public {\n        IAllowedRecipientsRegistry allowedRecipientsRegistry =\n            deployAllowedRecipientsRegistry(_limit, _periodDurationMonths, _recipients, _titles, _spentAmount, true);\n        IAllowedTokensRegistry allowedTokensRegistry = deployAllowedTokensRegistry(_tokens);\n\n        deployTopUpAllowedRecipients(_trustedCaller, address(allowedRecipientsRegistry), address(allowedTokensRegistry));\n\n        deployAddAllowedRecipient(_trustedCaller, address(allowedRecipientsRegistry));\n\n        deployRemoveAllowedRecipient(_trustedCaller, address(allowedRecipientsRegistry));\n    }\n\n    function deploySingleRecipientTopUpOnlySetup(\n        address _recipient,\n        string memory _title,\n        address[] memory _tokens,\n        uint256 _limit,\n        uint256 _periodDurationMonths,\n        uint256 _spentAmount\n    ) public {\n        address[] memory recipients = new address[](1);\n        recipients[0] = _recipient;\n\n        string[] memory titles = new string[](1);\n        titles[0] = _title;\n\n        IAllowedRecipientsRegistry allowedRecipientsRegistry =\n            deployAllowedRecipientsRegistry(_limit, _periodDurationMonths, recipients, titles, _spentAmount, false);\n        IAllowedTokensRegistry allowedTokensRegistry = deployAllowedTokensRegistry(_tokens);\n\n        deployTopUpAllowedRecipients(_recipient, address(allowedRecipientsRegistry), address(allowedTokensRegistry));\n    }\n}"
    },
    {
      "filename": "contracts/AllowedRecipientsFactory.sol",
      "content": "// SPDX-FileCopyrightText: 2022 Lido <info@lido.fi>\n// SPDX-License-Identifier: GPL-3.0\n\npragma solidity ^0.8.4;\n\nimport \"./EVMScriptFactories/AddAllowedRecipient.sol\";\nimport \"./EVMScriptFactories/RemoveAllowedRecipient.sol\";\nimport \"./EVMScriptFactories/TopUpAllowedRecipients.sol\";\nimport \"./AllowedRecipientsRegistry.sol\";\nimport \"./AllowedTokensRegistry.sol\";\n\n/// @author bulbozaur\n/// @notice Factory for Allowed Recipient Easy Track contracts\ncontract AllowedRecipientsFactory {\n    event AllowedRecipientsRegistryDeployed(\n        address indexed creator,\n        address indexed allowedRecipientsRegistry,\n        address _defaultAdmin,\n        address[] addRecipientToAllowedListRoleHolders,\n        address[] removeRecipientFromAllowedListRoleHolders,\n        address[] setLimitParametersRoleHolders,\n        address[] updateSpentAmountRoleHolders,\n        IBokkyPooBahsDateTimeContract bokkyPooBahsDateTimeContract\n    );\n\n    event AllowedTokensRegistryDeployed(\n        address indexed creator,\n        address indexed allowedTokensRegistry,\n        address _defaultAdmin,\n        address[] addTokenToAllowedListRoleHolders,\n        address[] removeTokenFromAllowedListRoleHolders\n    );\n\n    event TopUpAllowedRecipientsDeployed(\n        address indexed creator,\n        address indexed topUpAllowedRecipients,\n        address trustedCaller,\n        address allowedRecipientsRegistry,\n        address allowedTokenssRegistry,\n        address finance,\n        address easyTrack\n    );\n\n    event AddAllowedRecipientDeployed(\n        address indexed creator,\n        address indexed addAllowedRecipient,\n        address trustedCaller,\n        address allowedRecipientsRegistry\n    );\n\n    event RemoveAllowedRecipientDeployed(\n        address indexed creator,\n        address indexed removeAllowedRecipient,\n        address trustedCaller,\n        address allowedRecipientsRegistry\n    );\n\n    function deployAllowedRecipientsRegistry(\n        address _defaultAdmin,\n        address[] memory _addRecipientToAllowedListRoleHolders,\n        address[] memory _removeRecipientFromAllowedListRoleHolders,\n        address[] memory _setLimitParametersRoleHolders,\n        address[] memory _updateSpentAmountRoleHolders,\n        IBokkyPooBahsDateTimeContract _bokkyPooBahsDateTimeContract\n    ) public returns (AllowedRecipientsRegistry registry) {\n        registry = new AllowedRecipientsRegistry(\n            _defaultAdmin,\n            _addRecipientToAllowedListRoleHolders,\n            _removeRecipientFromAllowedListRoleHolders,\n            _setLimitParametersRoleHolders,\n            _updateSpentAmountRoleHolders,\n            _bokkyPooBahsDateTimeContract\n        );\n\n        emit AllowedRecipientsRegistryDeployed(\n            msg.sender,\n            address(registry),\n            _defaultAdmin,\n            _addRecipientToAllowedListRoleHolders,\n            _removeRecipientFromAllowedListRoleHolders,\n            _setLimitParametersRoleHolders,\n            _updateSpentAmountRoleHolders,\n            _bokkyPooBahsDateTimeContract\n        );\n    }\n\n    function deployAllowedTokensRegistry(\n        address _defaultAdmin,\n        address[] memory _addTokensToAllowedListRoleHolders,\n        address[] memory _removeTokensFromAllowedListRoleHolders\n    ) public returns (AllowedTokensRegistry registry) {\n        registry = new AllowedTokensRegistry(\n            _defaultAdmin,\n            _addTokensToAllowedListRoleHolders,\n            _removeTokensFromAllowedListRoleHolders\n        );\n\n        emit AllowedTokensRegistryDeployed(\n            msg.sender,\n            address(registry),\n            _defaultAdmin,\n            _addTokensToAllowedListRoleHolders,\n            _removeTokensFromAllowedListRoleHolders\n        );\n    }\n\n    function deployTopUpAllowedRecipients(\n        address _trustedCaller,\n        address _allowedRecipientsRegistry,\n        address _allowedTokensRegistry,\n        address _finance,\n        address _easyTrack\n    ) public returns (TopUpAllowedRecipients topUpAllowedRecipients) {\n        topUpAllowedRecipients = new TopUpAllowedRecipients(\n            _trustedCaller,\n            _allowedRecipientsRegistry,\n            _allowedTokensRegistry,\n            _finance,\n            _easyTrack\n        );\n\n        emit TopUpAllowedRecipientsDeployed(\n            msg.sender,\n            address(topUpAllowedRecipients),\n            _trustedCaller,\n            _allowedRecipientsRegistry,\n            _allowedTokensRegistry,\n            _finance,\n            _easyTrack\n        );\n\n        return topUpAllowedRecipients;\n    }\n\n    function deployAddAllowedRecipient(address _trustedCaller, address _allowedRecipientsRegistry)\n        public\n        returns (AddAllowedRecipient addAllowedRecipient)\n    {\n        addAllowedRecipient = new AddAllowedRecipient(_trustedCaller, _allowedRecipientsRegistry);\n\n        emit AddAllowedRecipientDeployed(\n            msg.sender,\n            address(addAllowedRecipient),\n            _trustedCaller,\n            _allowedRecipientsRegistry\n        );\n    }\n\n    function deployRemoveAllowedRecipient(\n        address _trustedCaller,\n        address _allowedRecipientsRegistry\n    ) public returns (RemoveAllowedRecipient removeAllowedRecipient) {\n        removeAllowedRecipient = new RemoveAllowedRecipient(\n            _trustedCaller,\n            _allowedRecipientsRegistry\n        );\n\n        emit RemoveAllowedRecipientDeployed(\n            msg.sender,\n            address(removeAllowedRecipient),\n            _trustedCaller,\n            _allowedRecipientsRegistry\n        );\n    }\n}"
    },
    {
      "filename": "contracts/AllowedRecipientsFactory.sol",
      "content": "// SPDX-FileCopyrightText: 2022 Lido <info@lido.fi>\n// SPDX-License-Identifier: GPL-3.0\n\npragma solidity ^0.8.4;\n\nimport \"./EVMScriptFactories/AddAllowedRecipient.sol\";\nimport \"./EVMScriptFactories/RemoveAllowedRecipient.sol\";\nimport \"./EVMScriptFactories/TopUpAllowedRecipients.sol\";\nimport \"./AllowedRecipientsRegistry.sol\";\nimport \"./AllowedTokensRegistry.sol\";\n\n/// @author bulbozaur\n/// @notice Factory for Allowed Recipient Easy Track contracts\ncontract AllowedRecipientsFactory {\n    event AllowedRecipientsRegistryDeployed(\n        address indexed creator,\n        address indexed allowedRecipientsRegistry,\n        address _defaultAdmin,\n        address[] addRecipientToAllowedListRoleHolders,\n        address[] removeRecipientFromAllowedListRoleHolders,\n        address[] setLimitParametersRoleHolders,\n        address[] updateSpentAmountRoleHolders,\n        IBokkyPooBahsDateTimeContract bokkyPooBahsDateTimeContract\n    );\n\n    event AllowedTokensRegi"
    }
  ]
}