{
  "Title": "Flash Fee Burned Instead of Sent to a Beneficiary",
  "Content": "The [`flashloan` function](https://github.com/Brushfam/openbrush-contracts/blob/553347354de6d0ead6a335ba4c197bdd01fb2d12/contracts/src/token/psp22/extensions/flashmint.rs#L63) within the `FlashLenderImpl` trait is responsible for sending the flash-minted tokens to the flash receiver and [calculating the fee that the borrower must pay](https://github.com/Brushfam/openbrush-contracts/blob/553347354de6d0ead6a335ba4c197bdd01fb2d12/contracts/src/token/psp22/extensions/flashmint.rs#L70). However, despite the fee being used for calculations, the `FlashLender` implementation never sends it to a flash fee receiver. Instead, it [burns the fee](https://github.com/Brushfam/openbrush-contracts/blob/553347354de6d0ead6a335ba4c197bdd01fb2d12/contracts/src/token/psp22/extensions/flashmint.rs#L79) without an apparent reason.\n\n\nConsider defining a `flash_fee_receiver` function that returns the `AccountId` of the fee beneficiary, and subsequently sends the fee amount to that account. Alternatively, consider documenting the rationale behind burning the fees if there is a specific reason for this approach.\n\n\n***Update:** Resolved in [pull request #157](https://github.com/Brushfam/openbrush-contracts/pull/157) at commit [dcf5843](https://github.com/Brushfam/openbrush-contracts/pull/157/commits/dcf584302a41680528c83adf21e38c8ffadb182c).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/src/token/psp22/extensions/flashmint.rs",
      "content": "// Copyright (c) 2012-2022 Supercolony\n//\n// Permission is hereby granted, free of charge, to any person obtaining\n// a copy of this software and associated documentation files (the\"Software\"),\n// to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to\n// permit persons to whom the Software is furnished to do so, subject to\n// the following conditions:\n//\n// The above copyright notice and this permission notice shall be\n// included in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\npub use crate::{\n    psp22,\n    psp22::extensions::flashmint,\n    traits::{\n        flashloan::*,\n        psp22::*,\n    },\n};\npub use flashmint::Internal as _;\nuse ink::{\n    env::CallFlags,\n    prelude::vec::Vec,\n};\nuse openbrush::traits::{\n    AccountId,\n    Balance,\n    Storage,\n    String,\n};\npub use psp22::{\n    Internal as _,\n    InternalImpl as _,\n    PSP22Impl,\n};\n\npub trait FlashLenderImpl: Storage<psp22::Data> + psp22::Internal + PSP22 + Internal {\n    fn max_flashloan(&mut self, token: AccountId) -> Balance {\n        if token == Self::env().account_id() {\n            Balance::MAX - self.total_supply()\n        } else {\n            0\n        }\n    }\n\n    fn flash_fee(&self, token: AccountId, amount: Balance) -> Result<Balance, FlashLenderError> {\n        if token != Self::env().account_id() {\n            return Err(FlashLenderError::WrongTokenAddress)\n        }\n        Ok(self._get_fee(amount))\n    }\n\n    fn flashloan(\n        &mut self,\n        receiver_account: AccountId,\n        token: AccountId,\n        amount: Balance,\n        data: Vec<u8>,\n    ) -> Result<(), FlashLenderError> {\n        let fee = self.flash_fee(token, amount)?;\n        self._mint_to(receiver_account, amount)?;\n        Internal::_on_flashloan(self, receiver_account, token, fee, amount, data)?;\n        let this = Self::env().account_id();\n        let current_allowance = self.allowance(receiver_account, this);\n        if current_allowance < amount + fee {\n            return Err(FlashLenderError::AllowanceDoesNotAllowRefund)\n        }\n        psp22::Internal::_approve_from_to(self, receiver_account, this, current_allowance - amount - fee)?;\n        psp22::Internal::_burn_from(self, receiver_account, amount + fee)?;\n        Ok(())\n    }\n}\n\npub trait Internal {\n    fn _get_fee(&self, _amount: Balance) -> Balance;\n\n    fn _on_flashloan(\n        &mut self,\n        receiver_account: AccountId,\n        token: AccountId,\n        fee: Balance,\n        amount: Balance,\n        data: Vec<u8>,\n    ) -> Result<(), FlashLenderError>;\n}\n\npub trait InternalImpl: Storage<psp22::Data> + Internal {\n    fn _get_fee(&self, _amount: Balance) -> Balance {\n        0\n    }\n\n    fn _on_flashloan(\n        &mut self,\n        receiver_account: AccountId,\n        token: AccountId,\n        fee: Balance,\n        amount: Balance,\n        data: Vec<u8>,\n    ) -> Result<(), FlashLenderError> {\n        let builder =\n            FlashBorrowerRef::on_flashloan_builder(&receiver_account, Self::env().caller(), token, amount, fee, data)\n                .call_flags(CallFlags::default().set_allow_reentry(true));\n        let result = match builder.try_invoke() {\n            Ok(Ok(Ok(_))) => Ok(()),\n            Ok(Ok(Err(FlashBorrowerError::FlashloanRejected(message)))) => {\n                Err(FlashLenderError::BorrowerRejected(message))\n            }\n            // Means unknown method\n            Ok(Err(ink::LangError::CouldNotReadInput)) => Ok(()),\n            // `NotCallable` means that the receiver is not a contract.\n            Err(ink::env::Error::NotCallable) => Ok(()),\n            _ => {\n                Err(FlashLenderError::BorrowerRejected(String::from(\n                    \"Error while performing the `on_flashloan`\",\n                )))\n            }\n        };\n\n        result\n    }\n}"
    }
  ]
}