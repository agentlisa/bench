{
  "Title": "[H02] Not following the Checks-Effects-Interactions pattern",
  "Content": "**Update:** *Fixed in [pull request #63](https://github.com/endaoment/endaoment-contracts/pull/63).*\n\n\nThe [`finalizeGrant`](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Fund.sol#L119) function of the `Fund` contract is setting the `grant.complete` storage variable [after a token `transfer`](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Fund.sol#L133).\n\n\n[Solidity recommends the usage of the Check-Effects-Interaction Pattern](https://solidity.readthedocs.io/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern) to avoid potential security issues, such as reentrancy.\n\n\nThe `finalizeGrant` function can be used to conduct a reentrancy attack, where the [`token transfer in line 129`](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Fund.sol#L129) can call back again the same function, sending to the `admin` multiple times an amount of `fee`, [before setting the `grant` as completed](https://github.com/endaoment/endaoment-contracts/blob/f60aa253d3d869ad6460877f23e6092acb313add/contracts/Fund.sol#L133).\n\n\nIn this way the `grant.recipient` can receive less than expected and the contract funds can be drained unexpectedly leading to an unwanted loss of funds.\n\n\nConsider always following the “Check-Effects-Interactions” pattern, thus modifying the contract’s state before making any external call to other contracts.\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/Fund.sol",
      "content": "// SPDX-License-Identifier: BSD 3-Clause\n\npragma solidity ^0.6.10;\n\nimport \"./Administratable.sol\";\nimport \"./OrgFactory.sol\";\n\n// FUND CONTRACT\n/**\n * @title Fund\n * @author rheeger\n * @notice Fund is a contract that serves as an on-chain US Donor-Advised Fund.\n * It holds the proceeds of gifted cryptocurrency as ERC20 tokens, \n * and allows for the manager to submit Grant reccomendations to the contract. \n * The EndaomentAdmin can then chose to approve the Grant reccomendation, triggering\n * a SafeMath transfer of a 1% fee to the EndaomentAdmin and the remainder to the \n * recipient Org contract.\n */\ncontract Fund is Administratable {\n    using SafeMath for uint256;\n\n// ========== STATE VARIABLES ==========\n    struct Grant {\n        string description;\n        uint value;\n        address recipient;\n        bool complete;\n    }\n\n    address public manager;\n    address public admin;\n    mapping(address => bool) public contributors;\n    Grant[] public grants;\n    uint public totalContributors;\n\n// ========== CONSTRUCTOR ==========\n    /**\n    * @notice Create new Fund\n    * @param creator Address of the Fund's Primary Advisor\n    * @param adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    constructor (address creator, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.FUND_FACTORY){\n        require(creator != address(0));\n        manager = creator;\n    }\n\n// ========== Admin Management ==========\n    /**\n    * @notice Restricts method access to fund's manager\n    */\n    modifier restricted() {\n      require(msg.sender == manager);\n      _;\n    }\n\n// ========== Fund Management & Info ==========\n    /**\n    * @notice Change Fund Primary Advisor\n    * @param  newManager The address of the new PrimaryAdvisor.\n    * @param  adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    function changeManager (address newManager, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        manager = newManager;\n    }\n\n    /**\n    * @notice Checks recipient of a Grant is an address created by the OrgFactory \n    * @param  recipient The address of the Grant recipient.\n    * @param  orgFactoryContractAddress Address of the OrgFactory contract.\n    */\n    function checkRecipient(address recipient, address orgFactoryContractAddress) public view returns (bool) {\n        OrgFactory x = OrgFactory ( orgFactoryContractAddress );\n\n        return x.getAllowedOrg(recipient);\n    }\n\n    /**\n    * @notice Returns summary of details about the fund [tokenBalance, ethBlance, number of grants, managerAddress]. \n    * @param  tokenAddress The token address of the stablecoin being used by the web-server.\n    */\n    function getSummary(address tokenAddress) public view returns (uint, uint, uint, address) {\n        ERC20 t = ERC20(tokenAddress);\n        uint bal = t.balanceOf(address(this));\n\n        return (\n            bal,\n            address(this).balance,\n            grants.length,\n            manager\n        );\n    }\n\n    /**\n    * @notice Create new Grant Reccomendation\n    * @param  description The address of the Owner.\n    * @param  value The value of the grant in base units.\n    * @param  recipient The address of the recieving organization's contract.\n    * @param  orgFactoryContractAddress Address of the orgFactory Contract.\n    */\n    function createGrant(string memory description, uint256 value, address recipient, address orgFactoryContractAddress) public restricted {\n        require(checkRecipient(recipient, orgFactoryContractAddress) == true);\n\n        Grant memory newGrant = Grant({\n            description: description,\n            value: value,\n            recipient: recipient,\n            complete: false\n        });\n\n        grants.push(newGrant);\n    }\n\n    /**\n    * @notice Approve Grant Reccomendation\n    * @param  index This Grant's index position\n    * @param  tokenAddress The stablecoin's token address.\n    * @param  adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    function finalizeGrant(uint index, address tokenAddress, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ACCOUNTANT){\n        EndaomentAdmin endaomentAdmin = EndaomentAdmin(adminContractAddress);\n        admin = endaomentAdmin.getRoleAddress(IEndaomentAdmin.Role.ADMIN);\n        Grant storage grant = grants[index];\n        require(grant.complete == false);\n        ERC20 t = ERC20(tokenAddress);\n\n        //Process fees:\n        uint256 fee = (grant.value)/100;\n        uint256 finalGrant = (grant.value * 99)/100;\n        t.transfer(admin, fee);\n\n        t.transfer(grant.recipient, finalGrant);\n\n        grant.complete = true;\n    }\n\n    /**\n    * @notice Returns total number of grants submitted to the fund. \n    */\n    function getGrantsCount() public view returns (uint) {\n        return grants.length;\n    }\n}"
    },
    {
      "filename": "contracts/Fund.sol",
      "content": "// SPDX-License-Identifier: BSD 3-Clause\n\npragma solidity ^0.6.10;\n\nimport \"./Administratable.sol\";\nimport \"./OrgFactory.sol\";\n\n// FUND CONTRACT\n/**\n * @title Fund\n * @author rheeger\n * @notice Fund is a contract that serves as an on-chain US Donor-Advised Fund.\n * It holds the proceeds of gifted cryptocurrency as ERC20 tokens, \n * and allows for the manager to submit Grant reccomendations to the contract. \n * The EndaomentAdmin can then chose to approve the Grant reccomendation, triggering\n * a SafeMath transfer of a 1% fee to the EndaomentAdmin and the remainder to the \n * recipient Org contract.\n */\ncontract Fund is Administratable {\n    using SafeMath for uint256;\n\n// ========== STATE VARIABLES ==========\n    struct Grant {\n        string description;\n        uint value;\n        address recipient;\n        bool complete;\n    }\n\n    address public manager;\n    address public admin;\n    mapping(address => bool) public contributors;\n    Grant[] public grants;\n    uint public totalContributors;\n\n// ========== CONSTRUCTOR ==========\n    /**\n    * @notice Create new Fund\n    * @param creator Address of the Fund's Primary Advisor\n    * @param adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    constructor (address creator, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.FUND_FACTORY){\n        require(creator != address(0));\n        manager = creator;\n    }\n\n// ========== Admin Management ==========\n    /**\n    * @notice Restricts method access to fund's manager\n    */\n    modifier restricted() {\n      require(msg.sender == manager);\n      _;\n    }\n\n// ========== Fund Management & Info ==========\n    /**\n    * @notice Change Fund Primary Advisor\n    * @param  newManager The address of the new PrimaryAdvisor.\n    * @param  adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    function changeManager (address newManager, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.REVIEWER){\n        manager = newManager;\n    }\n\n    /**\n    * @notice Checks recipient of a Grant is an address created by the OrgFactory \n    * @param  recipient The address of the Grant recipient.\n    * @param  orgFactoryContractAddress Address of the OrgFactory contract.\n    */\n    function checkRecipient(address recipient, address orgFactoryContractAddress) public view returns (bool) {\n        OrgFactory x = OrgFactory ( orgFactoryContractAddress );\n\n        return x.getAllowedOrg(recipient);\n    }\n\n    /**\n    * @notice Returns summary of details about the fund [tokenBalance, ethBlance, number of grants, managerAddress]. \n    * @param  tokenAddress The token address of the stablecoin being used by the web-server.\n    */\n    function getSummary(address tokenAddress) public view returns (uint, uint, uint, address) {\n        ERC20 t = ERC20(tokenAddress);\n        uint bal = t.balanceOf(address(this));\n\n        return (\n            bal,\n            address(this).balance,\n            grants.length,\n            manager\n        );\n    }\n\n    /**\n    * @notice Create new Grant Reccomendation\n    * @param  description The address of the Owner.\n    * @param  value The value of the grant in base units.\n    * @param  recipient The address of the recieving organization's contract.\n    * @param  orgFactoryContractAddress Address of the orgFactory Contract.\n    */\n    function createGrant(string memory description, uint256 value, address recipient, address orgFactoryContractAddress) public restricted {\n        require(checkRecipient(recipient, orgFactoryContractAddress) == true);\n\n        Grant memory newGrant = Grant({\n            description: description,\n            value: value,\n            recipient: recipient,\n            complete: false\n        });\n\n        grants.push(newGrant);\n    }\n\n    /**\n    * @notice Approve Grant Reccomendation\n    * @param  index This Grant's index position\n    * @param  tokenAddress The stablecoin's token address.\n    * @param  adminContractAddress Address of the EndaomentAdmin contract.\n    */\n    function finalizeGrant(uint index, address tokenAddress, address adminContractAddress) public onlyAdminOrRole(adminContractAddress, IEndaomentAdmin.Role.ACCOUNTANT){\n        EndaomentAdmin endaomentAdmin = EndaomentAdmin(adminContractAddress);\n        admin = endaomentAdmin.getRoleAddress(IEndaomentAdmin.Role.ADMIN);\n        Grant storage grant = grants[index];\n        require(grant.complete == false);\n        ERC20 t = ERC20(tokenAddress);\n\n        //Process fees:\n        uint256 fee = (grant.value)/100;\n        uint256 finalGrant = (grant.value * 99)/100;\n        t.transfer(admin, fee);\n\n        t.transfer(grant.recipient, finalGrant);\n\n        grant.complete = true;\n    }\n\n    /**\n    * @notice Returns total number of grants submitted to the fund. \n    */\n    function getGrantsCount() public view returns (uint) {\n        return grants.length;\n    }\n}"
    }
  ]
}