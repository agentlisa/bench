{
  "Title": "M-12: chainlinkAdaptor uses the same heartbeat for both feeds which is highly dangerous",
  "Content": "# Issue M-12: chainlinkAdaptor uses the same heartbeat for both feeds which is highly dangerous \n\nSource: https://github.com/sherlock-audit/2023-04-jojo-judging/issues/449 \n\n## Found by \n0x52, ast3ros\n## Summary\nchainlinkAdaptor uses the same heartbeat for both feeds when checking if the data feed is fresh. The issue with this is that the [USDC/USD](https://data.chain.link/ethereum/mainnet/stablecoins/usdc-usd) oracle has a 24 hour heartbeat, whereas the [average](https://data.chain.link/ethereum/mainnet/crypto-usd/eth-usd) has a heartbeat of 1 hour. Since they use the same heartbeat the heartbeat needs to be slower of the two or else the contract would be nonfunctional most of the time. The issue is that it would allow the consumption of potentially very stale data from the non-USDC feed.\n\n## Vulnerability Detail\n\nSee summary\n\n## Impact\n\nEither near constant downtime or insufficient staleness checks\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-04-jojo/blob/main/smart-contract-EVM/contracts/adaptor/chainlinkAdaptor.sol#L43-L55\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nUse two separate heartbeat periods\n\n\n\n## Discussion\n\n**JoscelynFarr**\n\nThe contract are trying to get the latest price in here:https://github.com/sherlock-audit/2023-04-jojo/blob/main/smart-contract-EVM/contracts/adaptor/chainlinkAdaptor.sol#LL47C1-L47C1\n\nAnd the heartbeat is trying to prevent chainlink stop updating. It is the same as chainlink's heartbeat.\nhttps://docs.chain.link/data-feeds/price-feeds/addresses/?network=arbitrum#Arbitrum%20Mainnet\n\n**iamjakethehuman**\n\nEscalate for 10 USDC\nI don’t think the sponsor properly understood the issue. On Arbitrum, as well as pretty much any other network, different token pairs have different heartbeats. If the oracle gets the latest price for two pairs with different heartbeats, using the same heartbeat variable for validation would cause either one of the following:\n1. Oracle will be down (will revert) most of the time.\n2. Oracle will allow for stale prices\n\nWhen validating prices for two different token pairs, two different heartbeats must be used.\n\n**sherlock-admin**\n\n > Escalate for 10 USDC\n> I don’t think the sponsor properly understood the issue. On Arbitrum, as well as pretty much any other network, different token pairs have different heartbeats. If the oracle gets the latest price for two pairs with different heartbeats, using the same heartbeat variable for validation would cause either one of the following:\n> 1. Oracle will be down (will revert) most of the time.\n> 2. Oracle will allow for stale prices\n> \n> When validating prices for two different token pairs, two different heartbeats must be used.\n\nYou've created a valid escalation for 10 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**JoscelynFarr**\n\nhttps://github.com/JOJOexchange/smart-contract-EVM/commit/c4270e0dc4da0db56173e39d8b6318e47999a07d\nhttps://github.com/JOJOexchange/JUSDV1/commit/f1699ae81e81eb190914d1c2ae491a825389daac\nfix \n\n**hrishibhat**\n\nResult:\nMedium\nHas duplicates\nGiven that the code uses the same heartbeat to validate both assets, when both assets can have different heartbeats, considering this issue a valid medium\n\nSponsor comment:\n> got it, we will accept this issue\n\n\n**sherlock-admin**\n\nEscalations have been resolved successfully!\n\nEscalation status:\n- [iamjakethehuman](https://github.com/sherlock-audit/2023-04-jojo-judging/issues/449/#issuecomment-1568436039): accepted\n\n**IAm0x52**\n\nFix looks good. Contract now uses separate heartbeats for asset and USDC\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/70",
  "Code": [
    {
      "filename": "smart-contract-EVM/contracts/adaptor/chainlinkAdaptor.sol",
      "content": "/*\n    Copyright 2022 JOJO Exchange\n    SPDX-License-Identifier: BUSL-1.1\n*/\n\npragma solidity 0.8.9;\n\nimport \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\n\ninterface IChainlink {\n    function latestRoundData()\n        external\n        view\n        returns (\n            uint80 roundId,\n            int256 answer,\n            uint256 startedAt,\n            uint256 updatedAt,\n            uint80 answeredInRound\n        );\n\n    function latestAnswer() external view returns (int256 answer);\n}\n\ncontract ChainlinkExpandAdaptor {\n    address public immutable chainlink;\n    uint256 public immutable decimalsCorrection;\n    uint256 public immutable heartbeatInterval;\n    address public immutable USDCSource;\n\n    constructor(\n        address _chainlink,\n        uint256 _decimalsCorrection,\n        uint256 _heartbeatInterval,\n        address _USDCSource\n    ) {\n        chainlink = _chainlink;\n        decimalsCorrection = 10**_decimalsCorrection;\n        heartbeatInterval = _heartbeatInterval;\n        USDCSource = _USDCSource;\n    }\n\n    function getMarkPrice() external view returns (uint256 price) {\n        int256 rawPrice;\n        uint256 updatedAt;\n        (, rawPrice, , updatedAt, ) = IChainlink(chainlink).latestRoundData();\n        (, int256 USDCPrice,, uint256 USDCUpdatedAt,) = IChainlink(USDCSource).latestRoundData();\n        require(\n            block.timestamp - updatedAt <= heartbeatInterval,\n            \"ORACLE_HEARTBEAT_FAILED\"\n        );\n        require(block.timestamp - USDCUpdatedAt <= heartbeatInterval, \"USDC_ORACLE_HEARTBEAT_FAILED\");\n        uint256 tokenPrice = (SafeCast.toUint256(rawPrice) * 1e8) / SafeCast.toUint256(USDCPrice);\n        return tokenPrice * 1e18 / decimalsCorrection;\n    }\n}"
    },
    {
      "filename": "smart-contract-EVM/contracts/adaptor/chainlinkAdaptor.sol",
      "content": "/*\n    Copyright 2022 JOJO Exchange\n    SPDX-License-Identifier: BUSL-1.1\n*/\n\npragma solidity 0.8.9;\n\nimport \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\n\ninterface IChainlink {\n    function latestRoundData()\n        external\n        view\n        returns (\n            uint80 roundId,\n            int256 answer,\n            uint256 startedAt,\n            uint256 updatedAt,\n            uint80 answeredInRound\n        );\n\n    function latestAnswer() external view returns (int256 answer);\n}\n\ncontract ChainlinkExpandAdaptor {\n    address public immutable chainlink;\n    uint256 public immutable decimalsCorrection;\n    uint256 public immutable heartbeatInterval;\n    address public immutable USDCSource;\n\n    constructor(\n        address _chainlink,\n        uint256 _decimalsCorrection,\n        uint256 _heartbeatInterval,\n        address _USDCSource\n    ) {\n        chainlink = _chainlink;\n        decimalsCorrection = 10**_decimalsCorrection;\n        heartbeatInterval = _heartbeatInterval;\n        USDCSource = _USDCSource;\n    }\n\n    function getMarkPrice() external view returns (uint256 price) {\n        int256 rawPrice;\n        uint256 updatedAt;\n        (, rawPrice, , updatedAt, ) = IChainlink(chainlink).latestRoundData();\n        (, int256 USDCPrice,, uint256 USDCUpdatedAt,) = IChainlink(USDCSource).latestRoundData();\n        require(\n            block.timestamp - updatedAt <= heartbeatInterval,\n            \"ORACLE_HEARTBEAT_FAILED\"\n        );\n        require(block.timestamp - USDCUpdatedAt <= heartbeatInterval, \"USDC_ORACLE_HEARTBEAT_FAILED\");\n        uint256 tokenPrice = (SafeCast.toUint256(rawPrice) * 1e8) / SafeCast.toUint256(USDCPrice);\n        return tokenPrice * 1e18 / decimalsCorrection;\n    }\n}"
    }
  ]
}