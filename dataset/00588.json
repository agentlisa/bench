{
  "Title": "Mixed-up error messages in collateral assertions",
  "Content": "##### Description\nAssert messages in the `updateCollateralBalance` and `receive` functions are mixed-up (swapped).\n\n```\nrequire(collateralAddress != address(0),\n    \"ActivePool: collateral must be ETH\");\n```\n\n```\nrequire(collateralAddress == address(0),\n    \"ActivePool: collateral must be ERC20 token\");\n```\n\nAlthough assertions are correct and generate revert() at proper conditions, the error messages are incorrect. It may cause an inaccurate diagnosis of the smart contract failures.\n\nThis issue appears at:\n- [ActivePool](https://github.com/Threshold-USD/dev/blob/800c6c19e44628dfda3cecaea6eedcb498bf0bf3/packages/contracts/contracts/ActivePool.sol#L151-161)\n- [CollSurplusPool](https://github.com/Threshold-USD/dev/blob/800c6c19e44628dfda3cecaea6eedcb498bf0bf3/packages/contracts/contracts/CollSurplusPool.sol#L117-125)\n- [DefaultPool](https://github.com/Threshold-USD/dev/blob/800c6c19e44628dfda3cecaea6eedcb498bf0bf3/packages/contracts/contracts/DefaultPool.sol#L113-122).\n\n##### Recommendation\nIt is recommended to use error messages corresponding to the actual error.\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "packages/contracts/contracts/ActivePool.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.17;\n\nimport \"./Dependencies/IERC20.sol\";\nimport './Interfaces/IActivePool.sol';\nimport './Interfaces/ICollSurplusPool.sol';\nimport './Interfaces/IDefaultPool.sol';\nimport './Interfaces/IStabilityPool.sol';\nimport \"./Dependencies/Ownable.sol\";\nimport \"./Dependencies/CheckContract.sol\";\n// import \"./Dependencies/console.sol\";\nimport \"./Dependencies/SendCollateral.sol\";\n\n/*\n * The Active Pool holds the collateral and THUSD debt (but not THUSD tokens) for all active troves.\n *\n * When a trove is liquidated, it's collateral and THUSD debt are transferred from the Active Pool, to either the\n * Stability Pool, the Default Pool, or both, depending on the liquidation conditions.\n *\n */\ncontract ActivePool is Ownable, CheckContract, SendCollateral, IActivePool {\n\n    string constant public NAME = \"ActivePool\";\n\n    address public defaultPoolAddress;\n    address public borrowerOperationsAddress;\n    address public collateralAddress;\n    address public collSurplusPoolAddress;\n    address public stabilityPoolAddress;\n    address public troveManagerAddress;\n    uint256 internal collateral;  // deposited collateral tracker\n    uint256 internal THUSDDebt;\n\n    // --- Contract setters ---\n\n    function setAddresses(\n        address _borrowerOperationsAddress,\n        address _troveManagerAddress,\n        address _stabilityPoolAddress,\n        address _defaultPoolAddress,\n        address _collSurplusPoolAddress,\n        address _collateralAddress\n    )\n        external\n        onlyOwner\n    {\n        checkContract(_borrowerOperationsAddress);\n        checkContract(_troveManagerAddress);\n        checkContract(_stabilityPoolAddress);\n        checkContract(_defaultPoolAddress);\n        checkContract(_collSurplusPoolAddress);\n        if (_collateralAddress != address(0)) {\n            checkContract(_collateralAddress);\n        }\n\n        borrowerOperationsAddress = _borrowerOperationsAddress;\n        troveManagerAddress = _troveManagerAddress;\n        stabilityPoolAddress = _stabilityPoolAddress;\n        defaultPoolAddress = _defaultPoolAddress;\n        collateralAddress = _collateralAddress;\n        collSurplusPoolAddress = _collSurplusPoolAddress;\n\n        emit BorrowerOperationsAddressChanged(_borrowerOperationsAddress);\n        emit TroveManagerAddressChanged(_troveManagerAddress);\n        emit StabilityPoolAddressChanged(_stabilityPoolAddress);\n        emit DefaultPoolAddressChanged(_defaultPoolAddress);\n        emit CollateralAddressChanged(_collateralAddress);\n        emit CollSurplusPoolAddressChanged(_collSurplusPoolAddress);\n\n        _renounceOwnership();\n    }\n\n    // --- Getters for public variables. Required by IPool interface ---\n\n    /*\n    * Returns the collateral state variable.\n    *\n    * Not necessarily equal to the the contract's raw collateral balance - collateral can be forcibly sent to contracts.\n    */\n    function getCollateralBalance() external view override returns (uint) {\n        return collateral;\n    }\n\n    function getTHUSDDebt() external view override returns (uint) {\n        return THUSDDebt;\n    }\n\n    // --- Pool functionality ---\n\n    function sendCollateral(address _account, uint256 _amount) external override {\n        _requireCallerIsBOorTroveMorSP();\n        collateral -= _amount;\n        emit ActivePoolCollateralBalanceUpdated(collateral);\n        emit CollateralSent(_account, _amount);\n\n        sendCollateral(IERC20(collateralAddress), _account, _amount);\n        if (collateralAddress == address(0)) {\n            return;\n        }\n        if (_account == defaultPoolAddress) {\n            IDefaultPool(_account).updateCollateralBalance(_amount);\n        }\n        if (_account == collSurplusPoolAddress) {\n            ICollSurplusPool(_account).updateCollateralBalance(_amount);\n        }\n        if (_account == stabilityPoolAddress) {\n            IStabilityPool(_account).updateCollateralBalance(_amount);\n        }\n    }\n\n    function increaseTHUSDDebt(uint256 _amount) external override {\n        _requireCallerIsBOorTroveM();\n        THUSDDebt += _amount;\n        emit ActivePoolTHUSDDebtUpdated(THUSDDebt);\n    }\n\n    function decreaseTHUSDDebt(uint256 _amount) external override {\n        _requireCallerIsBOorTroveMorSP();\n        THUSDDebt -= _amount;\n        emit ActivePoolTHUSDDebtUpdated(THUSDDebt);\n    }\n\n    // --- 'require' functions ---\n\n    function _requireCallerIsBorrowerOperationsOrDefaultPool() internal view {\n        require(\n            msg.sender == borrowerOperationsAddress ||\n            msg.sender == defaultPoolAddress,\n            \"ActivePool: Caller is neither BO nor Default Pool\");\n    }\n\n    function _requireCallerIsBOorTroveMorSP() internal view {\n        require(\n            msg.sender == borrowerOperationsAddress ||\n            msg.sender == troveManagerAddress ||\n            msg.sender == stabilityPoolAddress,\n            \"ActivePool: Caller is neither BorrowerOperations nor TroveManager nor StabilityPool\");\n    }\n\n    function _requireCallerIsBOorTroveM() internal view {\n        require(\n            msg.sender == borrowerOperationsAddress ||\n            msg.sender == troveManagerAddress,\n            \"ActivePool: Caller is neither BorrowerOperations nor TroveManager\");\n    }\n\n    // When ERC20 token collateral is received this function needs to be called\n    function updateCollateralBalance(uint256 _amount) external override {\n        _requireCallerIsBorrowerOperationsOrDefaultPool();\n        require(collateralAddress != address(0), \"ActivePool: collateral must be ETH\");\n        collateral += _amount;\n        emit ActivePoolCollateralBalanceUpdated(collateral);\n  \t}\n\n    // --- Fallback function ---\n\n    // This executes when the contract recieves ETH\n    receive() external payable {\n        _requireCallerIsBorrowerOperationsOrDefaultPool();\n        require(collateralAddress == address(0), \"ActivePool: collateral must be ERC20 token\");\n        collateral += msg.value;\n        emit ActivePoolCollateralBalanceUpdated(collateral);\n    }\n}"
    },
    {
      "filename": "packages/contracts/contracts/CollSurplusPool.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.17;\n\nimport \"./Dependencies/IERC20.sol\";\nimport \"./Interfaces/ICollSurplusPool.sol\";\nimport \"./Dependencies/Ownable.sol\";\nimport \"./Dependencies/CheckContract.sol\";\nimport \"./Dependencies/console.sol\";\nimport \"./Dependencies/SendCollateral.sol\";\n\n\ncontract CollSurplusPool is Ownable, CheckContract, SendCollateral, ICollSurplusPool {\n\n    string constant public NAME = \"CollSurplusPool\";\n\n    address public activePoolAddress;\n    address public borrowerOperationsAddress;\n    address public collateralAddress;\n    address public troveManagerAddress;\n\n    // deposited collateral tracker\n    uint256 internal collateral;\n    // Collateral surplus claimable by trove owners\n    mapping (address => uint) internal balances;\n\n    // --- Contract setters ---\n\n    function setAddresses(\n        address _borrowerOperationsAddress,\n        address _troveManagerAddress,\n        address _activePoolAddress,\n        address _collateralAddress\n    )\n        external\n        override\n        onlyOwner\n    {\n        checkContract(_borrowerOperationsAddress);\n        checkContract(_troveManagerAddress);\n        checkContract(_activePoolAddress);\n        if (_collateralAddress != address(0)) {\n            checkContract(_collateralAddress);\n        }\n\n        borrowerOperationsAddress = _borrowerOperationsAddress;\n        troveManagerAddress = _troveManagerAddress;\n        activePoolAddress = _activePoolAddress;\n        collateralAddress = _collateralAddress;\n\n        emit BorrowerOperationsAddressChanged(_borrowerOperationsAddress);\n        emit TroveManagerAddressChanged(_troveManagerAddress);\n        emit ActivePoolAddressChanged(_activePoolAddress);\n        emit CollateralAddressChanged(_collateralAddress);\n\n        _renounceOwnership();\n    }\n\n    /* Returns the collateral state variable at ActivePool address.\n       Not necessarily equal to the raw collateral balance - collateral can be forcibly sent to contracts. */\n    function getCollateralBalance() external view override returns (uint) {\n        return collateral;\n    }\n\n    function getCollateral(address _account) external view override returns (uint) {\n        return balances[_account];\n    }\n\n    // --- Pool functionality ---\n\n    function accountSurplus(address _account, uint256 _amount) external override {\n        _requireCallerIsTroveManager();\n\n        uint256 newAmount = balances[_account] + _amount;\n        balances[_account] = newAmount;\n\n        emit CollBalanceUpdated(_account, newAmount);\n    }\n\n    function claimColl(address _account) external override {\n        _requireCallerIsBorrowerOperations();\n        uint256 claimableColl = balances[_account];\n        require(claimableColl > 0, \"CollSurplusPool: No collateral available to claim\");\n\n        balances[_account] = 0;\n        emit CollBalanceUpdated(_account, 0);\n\n        collateral -= claimableColl;\n        emit CollateralSent(_account, claimableColl);\n\n        sendCollateral(IERC20(collateralAddress), _account, claimableColl);\n    }\n\n    // --- 'require' functions ---\n\n    function _requireCallerIsBorrowerOperations() internal view {\n        require(\n            msg.sender == borrowerOperationsAddress,\n            \"CollSurplusPool: Caller is not Borrower Operations\");\n    }\n\n    function _requireCallerIsTroveManager() internal view {\n        require(\n            msg.sender == troveManagerAddress,\n            \"CollSurplusPool: Caller is not TroveManager\");\n    }\n\n    function _requireCallerIsActivePool() internal view {\n        require(\n            msg.sender == activePoolAddress,\n            \"CollSurplusPool: Caller is not Active Pool\");\n    }\n\n    // When ERC20 token collateral is received this function needs to be called\n    function updateCollateralBalance(uint256 _amount) external override {\n        _requireCallerIsActivePool();\n        require(collateralAddress != address(0), \"CollSurplusPool: collateral must be ETH\");\n        collateral += _amount;\n  \t}\n\n    // --- Fallback function ---\n\n    receive() external payable {\n        _requireCallerIsActivePool();\n        require(collateralAddress == address(0), \"CollSurplusPool: collateral must be ERC20 token\");\n        collateral += msg.value;\n    }\n}"
    },
    {
      "filename": "packages/contracts/contracts/DefaultPool.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.17;\n\nimport \"./Dependencies/IERC20.sol\";\nimport './Interfaces/IDefaultPool.sol';\nimport './Interfaces/IActivePool.sol';\nimport \"./Dependencies/Ownable.sol\";\nimport \"./Dependencies/CheckContract.sol\";\nimport \"./Dependencies/console.sol\";\nimport \"./Dependencies/SendCollateral.sol\";\n\n/*\n * The Default Pool holds the collateral and THUSD debt (but not THUSD tokens) from liquidations that have been redistributed\n * to active troves but not yet \"applied\", i.e. not yet recorded on a recipient active trove's struct.\n *\n * When a trove makes an operation that applies its pending collateral and THUSD debt, its pending collateral and THUSD debt is moved\n * from the Default Pool to the Active Pool.\n */\ncontract DefaultPool is Ownable, CheckContract, SendCollateral, IDefaultPool {\n\n    string constant public NAME = \"DefaultPool\";\n\n    address public activePoolAddress;\n    address public collateralAddress;\n    address public troveManagerAddress;\n    uint256 internal collateral;  // deposited collateral tracker\n    uint256 internal THUSDDebt;  // debt\n\n    // --- Dependency setters ---\n\n    function setAddresses(\n        address _troveManagerAddress,\n        address _activePoolAddress,\n        address _collateralAddress\n    )\n        external\n        onlyOwner\n    {\n        checkContract(_troveManagerAddress);\n        checkContract(_activePoolAddress);\n        if (_collateralAddress != address(0)) {\n            checkContract(_collateralAddress);\n        }\n\n        troveManagerAddress = _troveManagerAddress;\n        activePoolAddress = _activePoolAddress;\n        collateralAddress = _collateralAddress;\n\n        emit TroveManagerAddressChanged(_troveManagerAddress);\n        emit ActivePoolAddressChanged(_activePoolAddress);\n        emit CollateralAddressChanged(_collateralAddress);\n\n        _renounceOwnership();\n    }\n\n    // --- Getters for public variables. Required by IPool interface ---\n\n    /*\n    * Returns the collateral state variable.\n    *\n    * Not necessarily equal to the the contract's raw collateral balance - collateral can be forcibly sent to contracts.\n    */\n    function getCollateralBalance() external view override returns (uint) {\n        return collateral;\n    }\n\n    function getTHUSDDebt() external view override returns (uint) {\n        return THUSDDebt;\n    }\n\n    // --- Pool functionality ---\n\n    function sendCollateralToActivePool(uint256 _amount) external override {\n        _requireCallerIsTroveManager();\n        address activePool = activePoolAddress; // cache to save an SLOAD\n        collateral -= _amount;\n        emit DefaultPoolCollateralBalanceUpdated(collateral);\n        emit CollateralSent(activePool, _amount);\n\n        sendCollateral(IERC20(collateralAddress), activePool, _amount);\n        if (collateralAddress == address(0)) {\n            return;\n        } \n        IActivePool(activePool).updateCollateralBalance(_amount);\n    }\n\n    function increaseTHUSDDebt(uint256 _amount) external override {\n        _requireCallerIsTroveManager();\n        THUSDDebt += _amount;\n        emit DefaultPoolTHUSDDebtUpdated(THUSDDebt);\n    }\n\n    function decreaseTHUSDDebt(uint256 _amount) external override {\n        _requireCallerIsTroveManager();\n        THUSDDebt -= _amount;\n        emit DefaultPoolTHUSDDebtUpdated(THUSDDebt);\n    }\n\n    // --- 'require' functions ---\n\n    function _requireCallerIsActivePool() internal view {\n        require(msg.sender == activePoolAddress, \"DefaultPool: Caller is not the ActivePool\");\n    }\n\n    function _requireCallerIsTroveManager() internal view {\n        require(msg.sender == troveManagerAddress, \"DefaultPool: Caller is not the TroveManager\");\n    }\n\n    // When ERC20 token collateral is received this function needs to be called\n    function updateCollateralBalance(uint256 _amount) external override {\n        _requireCallerIsActivePool();\n        require(collateralAddress != address(0), \"DefaultPool: collateral must be ETH\");\n        collateral += _amount;\n        emit DefaultPoolCollateralBalanceUpdated(collateral);\n  \t}\n\n    // --- Fallback function ---\n\n    receive() external payable {\n        _requireCallerIsActivePool();\n        require(collateralAddress == address(0), \"DefaultPool: collateral must be ERC20 token\");\n        collateral += msg.value;\n        emit DefaultPoolCollateralBalanceUpdated(collateral);\n    }\n}"
    }
  ]
}