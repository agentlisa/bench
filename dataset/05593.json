{
  "Title": "[G-02] Avoid making external calls if we don't have to",
  "Content": "\nhttps://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L175-L181\n```solidity\nFile: /src/contracts/AccountingEngine.sol\n175:  function auctionDebt() external returns (uint256 _id) {\n176:    if (_params.debtAuctionBidSize == 0) revert AccEng_DebtAuctionDisabled();\n\n178:    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n179:    uint256 _debtBalance = safeEngine.debtBalance(address(this));\n\n181:    if (_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance)) revert AccEng_InsufficientDebt();\n```\nThe if statement on the line 182 only depends on the variable `_debtBalance` and therefore we do not need to load `_coinBalance` before performing the check. \nIn case of a revert on the if check, the gas used to do the external call `safeEngine.coinBalance(address(this));` would be wasted. We can minimize this cost by performing the check earlier as shown below.\n\n```diff\ndiff --git a/src/contracts/AccountingEngine.sol b/src/contracts/AccountingEngine.sol\nindex 0f96326..1735f93 100644\n--- a/src/contracts/AccountingEngine.sol\n+++ b/src/contracts/AccountingEngine.sol\n@@ -175,10 +175,10 @@ contract AccountingEngine is Authorizable, Modifiable, Disableable, IAccountingE\n   function auctionDebt() external returns (uint256 _id) {\n     if (_params.debtAuctionBidSize == 0) revert AccEng_DebtAuctionDisabled();\n\n-    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n     uint256 _debtBalance = safeEngine.debtBalance(address(this));\n-\n     if (_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance)) revert AccEng_InsufficientDebt();\n+\n+    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n\n     (_coinBalance, _debtBalance) = _settleDebt(_coinBalance, _debtBalance, _coinBalance);\n     totalOnAuctionDebt += _params.debtAuctionBidSize;\n```\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/reports/2023-10-opendollar",
  "Code": [
    {
      "filename": "src/contracts/AccountingEngine.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0\npragma solidity 0.8.19;\n\nimport {IAccountingEngine} from '@interfaces/IAccountingEngine.sol';\nimport {IDebtAuctionHouse} from '@interfaces/IDebtAuctionHouse.sol';\nimport {ISurplusAuctionHouse} from '@interfaces/ISurplusAuctionHouse.sol';\nimport {ISAFEEngine} from '@interfaces/ISAFEEngine.sol';\n\nimport {Authorizable, IAuthorizable} from '@contracts/utils/Authorizable.sol';\nimport {Disableable} from '@contracts/utils/Disableable.sol';\nimport {Modifiable} from '@contracts/utils/Modifiable.sol';\n\nimport {Encoding} from '@libraries/Encoding.sol';\nimport {Math, WAD} from '@libraries/Math.sol';\nimport {Assertions} from '@libraries/Assertions.sol';\n\n/**\n * @title  AccountingEngine\n * @notice This contract is responsible for handling protocol surplus and debt\n * @notice It allows the system to auction surplus and debt, as well as transfer surplus\n * @dev    This is a system contract, therefore it is not meant to be used by users directly\n */\ncontract AccountingEngine is Authorizable, Modifiable, Disableable, IAccountingEngine {\n  using Encoding for bytes;\n  using Assertions for address;\n  using Math for uint256;\n\n  uint256 internal constant ONE_HUNDRED_WAD = 100 * WAD;\n\n  // --- Auth ---\n\n  /**\n   * @notice Overriding method allows new authorizations only if the contract is enabled\n   * @param  _account The account to authorize\n   * @inheritdoc IAuthorizable\n   */\n  function addAuthorization(address _account) external override(Authorizable, IAuthorizable) isAuthorized whenEnabled {\n    _addAuthorization(_account);\n  }\n\n  // --- Registry ---\n\n  /// @inheritdoc IAccountingEngine\n  ISAFEEngine public safeEngine;\n  /// @inheritdoc IAccountingEngine\n  ISurplusAuctionHouse public surplusAuctionHouse;\n  /// @inheritdoc IAccountingEngine\n  IDebtAuctionHouse public debtAuctionHouse;\n  /// @inheritdoc IAccountingEngine\n  address public postSettlementSurplusDrain;\n  /// @inheritdoc IAccountingEngine\n  address public extraSurplusReceiver;\n\n  // --- Params ---\n\n  /// @inheritdoc IAccountingEngine\n  // solhint-disable-next-line private-vars-leading-underscore\n  AccountingEngineParams public _params;\n\n  /// @inheritdoc IAccountingEngine\n  function params() external view returns (AccountingEngineParams memory _accEngineParams) {\n    return _params;\n  }\n\n  // --- Data ---\n\n  /// @inheritdoc IAccountingEngine\n  mapping(uint256 _timestamp => uint256 _rad) public debtQueue;\n  /// @inheritdoc IAccountingEngine\n  uint256 public /* RAD */ totalOnAuctionDebt;\n  /// @inheritdoc IAccountingEngine\n  uint256 public /* RAD */ totalQueuedDebt;\n  /// @inheritdoc IAccountingEngine\n  uint256 public lastSurplusTime;\n  /// @inheritdoc IAccountingEngine\n  uint256 public disableTimestamp;\n\n  // --- Init ---\n\n  /**\n   * @param  _safeEngine Address of the SAFEEngine\n   * @param  _surplusAuctionHouse Address of the SurplusAuctionHouse\n   * @param  _debtAuctionHouse Address of the DebtAuctionHouse\n   * @param  _accEngineParams Initial valid AccountingEngine parameters struct\n   */\n  constructor(\n    address _safeEngine,\n    address _surplusAuctionHouse,\n    address _debtAuctionHouse,\n    AccountingEngineParams memory _accEngineParams\n  ) Authorizable(msg.sender) validParams {\n    safeEngine = ISAFEEngine(_safeEngine.assertNonNull());\n    _setSurplusAuctionHouse(_surplusAuctionHouse);\n    debtAuctionHouse = IDebtAuctionHouse(_debtAuctionHouse);\n\n    lastSurplusTime = block.timestamp;\n\n    _params = _accEngineParams;\n  }\n\n  // --- Getters ---\n\n  /// @inheritdoc IAccountingEngine\n  function unqueuedUnauctionedDebt() external view returns (uint256 __unqueuedUnauctionedDebt) {\n    return _unqueuedUnauctionedDebt(safeEngine.debtBalance(address(this)));\n  }\n\n  function _unqueuedUnauctionedDebt(uint256 _debtBalance) internal view returns (uint256 __unqueuedUnauctionedDebt) {\n    return (_debtBalance - totalQueuedDebt) - totalOnAuctionDebt;\n  }\n\n  // --- Debt Queueing ---\n\n  /// @inheritdoc IAccountingEngine\n  function pushDebtToQueue(uint256 _debtBlock) external isAuthorized {\n    debtQueue[block.timestamp] = debtQueue[block.timestamp] + _debtBlock;\n    totalQueuedDebt = totalQueuedDebt + _debtBlock;\n\n    emit PushDebtToQueue(block.timestamp, _debtBlock);\n  }\n\n  /// @inheritdoc IAccountingEngine\n  function popDebtFromQueue(uint256 _debtBlockTimestamp) external {\n    if (block.timestamp < _debtBlockTimestamp + _params.popDebtDelay) revert AccEng_PopDebtCooldown();\n\n    uint256 _debtBlock = debtQueue[_debtBlockTimestamp];\n\n    if (_debtBlock == 0) revert AccEng_NullAmount();\n\n    totalQueuedDebt = totalQueuedDebt - _debtBlock;\n    debtQueue[_debtBlockTimestamp] = 0;\n\n    emit PopDebtFromQueue(_debtBlockTimestamp, _debtBlock);\n  }\n\n  // Debt settlement\n\n  /// @inheritdoc IAccountingEngine\n  function settleDebt(uint256 _rad) external {\n    _settleDebt(safeEngine.coinBalance(address(this)), safeEngine.debtBalance(address(this)), _rad);\n  }\n\n  function _settleDebt(\n    uint256 _coinBalance,\n    uint256 _debtBalance,\n    uint256 _rad\n  ) internal returns (uint256 _newCoinBalance, uint256 _newDebtBalance) {\n    if (_rad > _coinBalance) revert AccEng_InsufficientSurplus();\n    if (_rad > _unqueuedUnauctionedDebt(_debtBalance)) revert AccEng_InsufficientDebt();\n\n    safeEngine.settleDebt(_rad);\n    _newCoinBalance = _coinBalance - _rad;\n    _newDebtBalance = _debtBalance - _rad;\n\n    emit SettleDebt(_rad, _newCoinBalance, _newDebtBalance);\n  }\n\n  /// @inheritdoc IAccountingEngine\n  function cancelAuctionedDebtWithSurplus(uint256 _rad) external {\n    if (_rad > totalOnAuctionDebt) revert AccEng_InsufficientDebt();\n\n    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n\n    if (_rad > _coinBalance) revert AccEng_InsufficientSurplus();\n\n    safeEngine.settleDebt(_rad);\n    totalOnAuctionDebt -= _rad;\n\n    emit CancelDebt(_rad, _coinBalance - _rad, safeEngine.debtBalance(address(this)));\n  }\n\n  // Debt auction\n\n  /// @inheritdoc IAccountingEngine\n  function auctionDebt() external returns (uint256 _id) {\n    if (_params.debtAuctionBidSize == 0) revert AccEng_DebtAuctionDisabled();\n\n    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n    uint256 _debtBalance = safeEngine.debtBalance(address(this));\n\n    if (_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance)) revert AccEng_InsufficientDebt();\n\n    (_coinBalance, _debtBalance) = _settleDebt(_coinBalance, _debtBalance, _coinBalance);\n    totalOnAuctionDebt += _params.debtAuctionBidSize;\n\n    _id = debtAuctionHouse.startAuction({\n      _incomeReceiver: address(this),\n      _amountToSell: _params.debtAuctionMintedTokens,\n      _initialBid: _params.debtAuctionBidSize\n    });\n\n    emit AuctionDebt(_id, _params.debtAuctionMintedTokens, _params.debtAuctionBidSize);\n  }\n\n  // Surplus auction\n\n  /// @inheritdoc IAccountingEngine\n  function auctionSurplus() external returns (uint256 _id) {\n    if(_params.surplusTransferPercentage > WAD) revert AccEng_surplusTransferPercentOverLimit();\n    if (_params.surplusAmount == 0) revert AccEng_NullAmount();\n    if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();\n    if (block.timestamp < lastSurplusTime + _params.surplusDelay) revert AccEng_SurplusCooldown();\n\n    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n    uint256 _debtBalance = safeEngine.debtBalance(address(this));\n    (_coinBalance, _debtBalance) = _settleDebt(_coinBalance, _debtBalance, _unqueuedUnauctionedDebt(_debtBalance));\n\n    if (_coinBalance < _debtBalance + _params.surplusAmount + _params.surplusBuffer) {\n      revert AccEng_InsufficientSurplus();\n    }\n\n    // auction surplus percentage\n    if (_params.surplusTransferPercentage < ONE_HUNDRED_WAD) {\n      _id = surplusAuctionHouse.startAuction({\n        _amountToSell: _params.surplusAmount.wmul(ONE_HUNDRED_WAD - _params.surplusTransferPercentage),\n        _initialBid: 0\n      });\n\n      lastSurplusTime = block.timestamp;\n      emit AuctionSurplus(_id, 0, _params.surplusAmount.wmul(ONE_HUNDRED_WAD - _params.surplusTransferPercentage));\n    }\n\n    // transfer surplus percentage\n    if (_params.surplusTransferPercentage > 0) {\n      if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();\n\n      safeEngine.transferInternalCoins({\n        _source: address(this),\n        _destination: extraSurplusReceiver,\n        _rad: _params.surplusAmount.wmul(_params.surplusTransferPercentage)\n      });\n\n      lastSurplusTime = block.timestamp;\n      emit TransferSurplus(extraSurplusReceiver, _params.surplusAmount.wmul(_params.surplusTransferPercentage));\n    }\n  }\n\n  // --- Shutdown ---\n\n  /**\n   * @notice Runtime to be run when the contract is disabled (normally triggered by GlobalSettlement)\n   * @dev When it's being disabled, the contract will record the current timestamp. Afterwards,\n   *      the contract tries to settle as much debt as possible (if there's any) with any surplus that's\n   *      left in the AccountingEngine\n   * @inheritdoc Disableable\n   */\n  function _onContractDisable() internal override {\n    totalQueuedDebt = 0;\n    totalOnAuctionDebt = 0;\n    disableTimestamp = block.timestamp;\n\n    surplusAuctionHouse.disableContract();\n    debtAuctionHouse.disableContract();\n\n    uint256 _debtToSettle = Math.min(safeEngine.coinBalance(address(this)), safeEngine.debtBalance(address(this)));\n    safeEngine.settleDebt(_debtToSettle);\n  }\n\n  /// @inheritdoc IAccountingEngine\n  function transferPostSettlementSurplus() external whenDisabled {\n    if (address(postSettlementSurplusDrain) == address(0)) revert AccEng_NullSurplusReceiver();\n    if (block.timestamp < disableTimestamp + _params.disableCooldown) revert AccEng_PostSettlementCooldown();\n\n    uint256 _coinBalance = safeEngine.coinBalance(address(this));\n    uint256 _debtBalance = safeEngine.debtBalance(address(this));\n    uint256 _debtToSettle = Math.min(_coinBalance, _debtBalance);\n    (_coinBalance,) = _settleDebt(_coinBalance, _debtBalance, _debtToSettle);\n\n    if (_coinBalance > 0) {\n      safeEngine.transferInternalCoins({\n        _source: address(this),\n        _destination: postSettlementSurplusDrain,\n        _rad: _coinBalance\n      });\n\n      emit TransferSurplus(postSettlementSurplusDrain, _coinBalance);\n    }\n  }\n\n  // --- Administration ---\n\n  /// @inheritdoc Modifiable\n  function _modifyParameters(bytes32 _param, bytes memory _data) internal override {\n    uint256 _uint256 = _data.toUint256();\n    address _address = _data.toAddress();\n\n    // params\n    if (_param == 'surplusTransferPercentage') _params.surplusTransferPercentage = _uint256;\n    else if (_param == 'surplusDelay') _params.surplusDelay = _uint256;\n    else if (_param == 'popDebtDelay') _params.popDebtDelay = _uint256;\n    else if (_param == 'disableCooldown') _params.disableCooldown = _uint256;\n    else if (_param == 'surplusAmount') _params.surplusAmount = _uint256;\n    else if (_param == 'debtAuctionBidSize') _params.debtAuctionBidSize = _uint256;\n    else if (_param == 'debtAuctionMintedTokens') _params.debtAuctionMintedTokens = _uint256;\n    else if (_param == 'surplusBuffer') _params.surplusBuffer = _uint256;\n    // registry\n    else if (_param == 'surplusAuctionHouse') _setSurplusAuctionHouse(_address);\n    else if (_param == 'debtAuctionHouse') debtAuctionHouse = IDebtAuctionHouse(_address);\n    else if (_param == 'postSettlementSurplusDrain') postSettlementSurplusDrain = _address;\n    else if (_param == 'extraSurplusReceiver') extraSurplusReceiver = _address;\n    else revert UnrecognizedParam();\n  }\n\n  /// @dev Set the surplus auction house, deny permissions on the old one and approve on the new one\n  function _setSurplusAuctionHouse(address _surplusAuctionHouse) internal {\n    if (address(surplusAuctionHouse) != address(0)) {\n      safeEngine.denySAFEModification(address(surplusAuctionHouse));\n    }\n    surplusAuctionHouse = ISurplusAuctionHouse(_surplusAuctionHouse);\n    safeEngine.approveSAFEModification(_surplusAuctionHouse);\n  }\n\n  /// @inheritdoc Modifiable\n  function _validateParameters() internal view override {\n    address(surplusAuctionHouse).assertNonNull();\n    address(debtAuctionHouse).assertNonNull();\n  }\n}"
    }
  ]
}