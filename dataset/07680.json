{
  "Title": "[L-01] Potential DOS in Contract Inheriting ",
  "Content": "<h2 id=\"l-01-potential-dos-in-contract-inheriting-uupsupgradeablesol\" style=\"position:relative;\"><a href=\"#l-01-potential-dos-in-contract-inheriting-uupsupgradeablesol\" aria-label=\"l 01 potential dos in contract inheriting uupsupgradeablesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Potential DOS in Contract Inheriting <code>UUPSUpgradeable.sol</code></h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/scripts/deploy.ts#L18\">https://github.com/code-423n4/2022-11-non-fungible/blob/main/scripts/deploy.ts#L18</a></p>\n<p>The scripts/ folder outlines a number of deployment scripts used by the team. Some of the contracts deployed utilise the ERC1967 upgradeable proxy standard. </p>\n<p>This standard involves first deploying an implementation contract and later a proxy contract which uses the implementation contract as its logic. When users make calls to the proxy contract, the proxy contract will delegate call to the underlying implementation contract. </p>\n<p><code>Exchange.sol</code> implement an <code>initialize()</code> function which aims to replace the role of the <code>constructor()</code> when deploying proxy contracts</p>\n<p><code>Exchange.sol</code> inherits <code>UUPSUpgradeable.sol</code>. It is important that the contract is deployed and initialized in the same transaction to avoid any malicious frontrunning. <code>Exchange.sol</code> may potentially have <code>initialized</code> variable be false, and if this happens, the malicious attacker would take over the control.</p>\n<p>it would be worthwhile to ensure the proxy contract is deployed and initialized in the same transaction, or ensure the <code>initialize()</code> function is callable only by the deployer of the proxy contract. This could be set in the proxy contracts <code>constructor()</code></p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewbox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As a result, a malicious attacker could monitor the Ethereum blockchain for bytecode that matches the  contract and frontrun the initialize() transaction to gain ownership of the contract. This can be repeated as a Denial Of Service (DOS) type of attack, effectively preventing  contract deployment, leading to unrecoverable gas expenses.</p>\n<p>Add a control that makes <code>initialize()</code> only call the Deployer Contract;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">DEPLOYER_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotDeployer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t}</span></span></span></code></pre>\n<p>In another solution; Using the LibRLP library, which makes it possible to pre-calculate Foundryâ€™s contract deploy addresses, and deploy simultaneously using the Atomic transaction feature of Foundry and EVM.</p>\n<p><a href=\"https://twitter.com/transmissions11/status/1518507047943245824?s=20&amp;t=-SgkBERLJqFRHn7392GrbA\">https://twitter.com/transmissions11/status/1518507047943245824?s=20&amp;t=-SgkBERLJqFRHn7392GrbA</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">\"forge-std/Script.sol\"</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">LibRLP</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">\"../../test/utils/LibRLP.sol\"</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DeployBase</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Script</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">run</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startBroadcast</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk3\">// Precomputed contract addresses, based on contract deploy nonces.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk3\">// tx.origin is the address who will actually broadcast the contract creations below.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BlurExchangeAddewss</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibRLP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyaddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibRLP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">) );</span></span></span></code></pre>\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/contests/2022-11-non-fungible-trading-contest",
  "Code": [
    {
      "filename": "scripts/deploy.ts",
      "content": "import { Contract } from 'ethers';\nimport hre from 'hardhat';\nimport { getAddress, getContract, updateAddresses } from './utils';\nimport { deploy, waitForTx, task } from '../web3-utils';\n\nasync function deployPart1(): Promise<{\n  executionDelegate: Contract;\n}> {\n  const executionDelegate = await deploy('ExecutionDelegate');\n  await waitForTx(\n    executionDelegate.approveContract(\n      '0x000000000000ad05ccc4f10045630fb830b95127',\n    ),\n  );\n  return { executionDelegate };\n}\n\nasync function deployPart2(exchangeName = 'Exchange'): Promise<{\n  exchangeImpl: Contract;\n  policyManager: Contract;\n  merkleVerifier: Contract;\n}> {\n  const policyManager = await deploy('PolicyManager');\n\n  const merkleVerifier = await deploy('MerkleVerifier', []);\n  const exchangeImpl = await deploy(\n    exchangeName,\n    [],\n    { libraries: { MerkleVerifier: merkleVerifier.address } },\n    'ExchangeImpl',\n  );\n  return { exchangeImpl, policyManager, merkleVerifier };\n}\n\nasync function deployPart3(\n  executionDelegate: Contract,\n  policyManagerAddress: string,\n  oracleAddress: string,\n  blockRange: number,\n  exchangeImplAddress: string,\n): Promise<{\n  exchangeProxy: Contract;\n}> {\n  const initializeInterface = new hre.ethers.utils.Interface([\n    'function initialize(address, address, address, uint256)',\n  ]);\n  const initialize = initializeInterface.encodeFunctionData('initialize', [\n    executionDelegate.address, // _executionDelegate\n    policyManagerAddress, // _policyManager\n    oracleAddress, // _oracle\n    blockRange, // _blockRange\n  ]);\n  const exchangeProxy = await deploy(\n    'ERC1967Proxy',\n    [exchangeImplAddress, initialize],\n    {},\n    'Exchange',\n  );\n  return { exchangeProxy };\n}\n\nexport async function deployPool(): Promise<Contract> {\n  const poolImpl = await deploy('Pool', [], {}, 'PoolImpl');\n  const poolProxy = await deploy(\n    'ERC1967Proxy',\n    [poolImpl.address, '0x'],\n    {},\n    'Pool',\n  );\n  const pool = new hre.ethers.Contract(\n    poolProxy.address,\n    poolImpl.interface,\n    poolProxy.signer,\n  );\n  return pool;\n}\n\nexport async function approveMatchingPolicy(\n  policyManager: Contract,\n  matchingPolicy: Contract,\n) {\n  await waitForTx(policyManager.addPolicy(matchingPolicy.address));\n}\n\nexport async function deployFull(\n  oracleAddress: string,\n  blockRange: number,\n  exchangeName = 'Exchange',\n): Promise<{\n  exchange: Contract;\n  executionDelegate: Contract;\n  policyManager: Contract;\n  merkleVerifier: Contract;\n  matchingPolicies: Record<string, Contract>;\n}> {\n  const { executionDelegate } = await deployPart1();\n  const { exchangeImpl, policyManager, merkleVerifier } = await deployPart2(\n    exchangeName,\n  );\n  const { exchangeProxy } = await deployPart3(\n    executionDelegate,\n    policyManager.address,\n    oracleAddress,\n    blockRange,\n    exchangeImpl.address,\n  );\n  await waitForTx(executionDelegate.approveContract(exchangeProxy.address));\n  const StandardPolicyERC721 = await deploy('StandardPolicyERC721');\n  await approveMatchingPolicy(policyManager, StandardPolicyERC721);\n\n  const matchingPolicies = { StandardPolicyERC721 };\n\n  const exchange = new hre.ethers.Contract(\n    exchangeProxy.address,\n    exchangeImpl.interface,\n    exchangeImpl.signer,\n  );\n\n  return {\n    exchange,\n    executionDelegate,\n    policyManager,\n    merkleVerifier,\n    matchingPolicies,\n  };\n}\n\nexport async function upgrade(\n  exchange: Contract,\n  executionDelegateAddress: string,\n  merkleVerifierAddress: string,\n  exchangeName = 'Exchange',\n): Promise<{ exchange: Contract }> {\n  const exchangeImpl = await deploy(\n    exchangeName,\n    [],\n    { libraries: { MerkleVerifier: merkleVerifierAddress } },\n    'ExchangeImpl',\n  );\n  const initializeInterface = new hre.ethers.utils.Interface([\n    'function updateDomainSeparator()',\n  ]);\n  const initialize = initializeInterface.encodeFunctionData('updateDomainSeparator', []);\n  await waitForTx(exchange.upgradeToAndCall(exchangeImpl.address, initialize));\n\n  return {\n    exchange: new hre.ethers.Contract(\n      exchange.address,\n      exchangeImpl.interface,\n      exchangeImpl.signer,\n    ),\n  };\n}\n\ntask('deploy-pool', 'Deploy Pool').setAction(async () => {\n  await deployPool();\n  updateAddresses(['Pool', 'PoolImpl']);\n});\n\ntask('deploy-matching-policy', 'Deploy MatchingPolicy')\n  .addParam('matchingPolicy', 'MatchingPolicy to deploy')\n  .setAction(\n    async ({\n      matchingPolicy: matchingPolicyName,\n    }: {\n      matchingPolicy: string;\n    }) => {\n      console.log(`Deploying matching policy ${matchingPolicyName}`);\n\n      await deploy(matchingPolicyName);\n\n      updateAddresses([matchingPolicyName]);\n    },\n  );\n\ntask('approve-matching-policy', 'Approve MatchingPolicy')\n  .addParam('matchingPolicy', 'MatchingPolicy to approve')\n  .setAction(\n    async ({\n      matchingPolicy: matchingPolicyName,\n    }: {\n      matchingPolicy: string;\n    }) => {\n      console.log(`Deploying matching policy ${matchingPolicyName}`);\n\n      const policyManager = await getContract('PolicyManager');\n      const matchingPolicy = await getContract(matchingPolicyName);\n      await approveMatchingPolicy(policyManager, matchingPolicy);\n\n      updateAddresses([matchingPolicyName]);\n    },\n  );\n\ntask('deploy', 'Deploy')\n  .addOptionalParam('part', 'Deployment part to execute')\n  .setAction(async ({ part }: { part: string | undefined }) => {\n    switch (part) {\n      case '1':\n        await deployPart1();\n        updateAddresses(['ExecutionDelegate']);\n        break;\n      case '2':\n        await deployPart2();\n        updateAddresses([\n          'PolicyManager',\n          'MerkleVerifier',\n          'ExchangeImpl',\n        ]);\n        break;\n      case '3':\n        const executionDelegate = await getContract('ExecutionDelegate');\n        const policyManagerAddress = getAddress('PolicyManager');\n        const exchangeImplAddress = getAddress('ExchangeImpl');\n        await deployPart3(\n          executionDelegate,\n          policyManagerAddress,\n          '0x0000000000000000000000000000000000000000',\n          0,\n          exchangeImplAddress,\n        );\n        updateAddresses(['Exchange']);\n        break;\n      case 'upgrade':\n        const executionDelegateAddress = getAddress('ExecutionDelegate');\n        const merkleVerifierAddress = getAddress('MerkleVerifier');\n        const exchange = await getContract('Exchange');\n        await upgrade(\n          exchange,\n          executionDelegateAddress,\n          merkleVerifierAddress,\n        );\n        updateAddresses(['ExchangeImpl']);\n        break;\n      default:\n        await deployFull('0x0000000000000000000000000000000000000000', 0);\n        updateAddresses();\n    }\n  });\n\ntask('manual', '').setAction(async () => {\n  const wallet = new hre.ethers.Wallet(\n    '0x3110107685f7ff268a51451973c1725282b3b0d9ee57373f8652286cdaf72f6b',\n  );\n  const data = '0x608060405260405161078138038061078183398101604081905261002291610333565b61004d60017f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbd610401565b60008051602061073a8339815191521461006957610069610422565b6100758282600061007c565b5050610487565b610085836100b2565b6000825111806100925750805b156100ad576100ab83836100f260201b6100291760201c565b505b505050565b6100bb81610120565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6060610117838360405180606001604052806027815260200161075a602791396101e0565b90505b92915050565b610133816102b760201b6100551760201c565b61019a5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b60648201526084015b60405180910390fd5b806101bf60008051602061073a83398151915260001b6102bd60201b61005b1760201c565b80546001600160a01b0319166001600160a01b039290921691909117905550565b6060833b61023f5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f6044820152651b9d1c9858dd60d21b6064820152608401610191565b600080856001600160a01b03168560405161025a9190610438565b600060405180830381855af49150503d8060008114610295576040519150601f19603f3d011682016040523d82523d6000602084013e61029a565b606091505b5090925090506102ab8282866102c0565b925050505b9392505050565b3b151590565b90565b606083156102cf5750816102b0565b8251156102df5782518084602001fd5b8160405162461bcd60e51b81526004016101919190610454565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561032a578181015183820152602001610312565b50506000910152565b6000806040838503121561034657600080fd5b82516001600160a01b038116811461035d57600080fd5b60208401519092506001600160401b038082111561037a57600080fd5b818501915085601f83011261038e57600080fd5b8151818111156103a0576103a06102f9565b604051601f8201601f19908116603f011681019083821181831017156103c8576103c86102f9565b816040528281528860208487010111156103e157600080fd5b6103f283602083016020880161030f565b80955050505050509250929050565b8181038181111561011a57634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052600160045260246000fd5b6000825161044a81846020870161030f565b9190910192915050565b602081526000825180602084015261047381604085016020870161030f565b601f01601f19169190910160400192915050565b6102a4806104966000396000f3fe60806040523661001357610011610017565b005b6100115b61002761002261005e565b6100a3565b565b606061004e8383604051806060016040528060278152602001610271602791396100c7565b9392505050565b3b151590565b90565b600061009e7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5473ffffffffffffffffffffffffffffffffffffffff1690565b905090565b3660008037600080366000845af43d6000803e8080156100c2573d6000f35b3d6000fd5b6060833b6101425760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f60448201527f6e7472616374000000000000000000000000000000000000000000000000000060648201526084015b60405180910390fd5b6000808573ffffffffffffffffffffffffffffffffffffffff168560405161016a9190610221565b600060405180830381855af49150503d80600081146101a5576040519150601f19603f3d011682016040523d82523d6000602084013e6101aa565b606091505b50915091506101ba8282866101c4565b9695505050505050565b606083156101d357508161004e565b8251156101e35782518084602001fd5b8160405162461bcd60e51b8152600401610139919061023d565b60005b83811015610218578181015183820152602001610200565b50506000910152565b600082516102338184602087016101fd565b9190910192915050565b602081526000825180602084015261025c8160408501602087016101fd565b601f01601f1916919091016040019291505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a164736f6c6343000811000a360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564000000000000000000000000031aa05da8bf778dfc36d8d25ca68cbb2fc447c600000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000084cf756fdf00000000000000000000000000000000000111abe46ff893f3b2fdf1f759a8a80000000000000000000000003a35a3102b5c6bd1e4d3237248be071ef53c83310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000';\n  const tx = {\n    data,\n    chainId: 1,\n    nonce: 0,\n    gasLimit: 690263,\n    gasPrice: 38478203942,\n  };\n  const signedTx = await wallet.signTransaction(tx);\n  await hre.ethers.provider.sendTransaction(signedTx);\n});"
    }
  ]
}