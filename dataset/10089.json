{
  "Title": "[M-01] Anyone can call `closeLoan()` to close the loan",
  "Content": "_Submitted by WatchPug_\n\n[`MapleLoan.sol` L56-L63](https://github.com/maple-labs/loan/blob/9684bcef06481e493d060974b1777a4517c4e792/contracts/MapleLoan.sol#L56-L63)\n\n```solidity\nfunction closeLoan(uint256 amount_) external override returns (uint256 principal_, uint256 interest_) {\n    // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n    require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:CL:TRANSFER_FROM_FAILED\");\n\n    ( principal_, interest_ ) = _closeLoan();\n\n    emit LoanClosed(principal_, interest_);\n}\n```\n\nBased on the context, we believe that the `closeLoan()` should only be called by the `borrower`. However, the current implementation allows anyone to call `closeLoan()` anytime after `fundLoan()`.\n\nIf there is no `earlyFee`, this enables a griefing attack, causing the `borrower` and `lender` to abandon this contract and redo everything which costs more gas.\n\nIf a platform fee exits, the lender will also suffer fund loss from the platform fee charged in `fundLoan()`.\n\n##### Recommendation\n\nChange to:\n\n```solidity\nfunction closeLoan(uint256 amount_) external override returns (uint256 principal_, uint256 interest_) {\n    // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n    require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:CL:TRANSFER_FROM_FAILED\");\n\n    require(msg.sender == _borrower, \"ML:DF:NOT_BORROWER\");\n\n    ( principal_, interest_ ) = _closeLoan();\n\n    emit LoanClosed(principal_, interest_);\n}\n```\n\n**[deluca-mike (Maple) confirmed](https://github.com/code-423n4/2021-12-maple-findings/issues/46#issuecomment-989556034):**\n\n**[pauliax (judge) commented](https://github.com/code-423n4/2021-12-maple-findings/issues/46#issuecomment-997429287):**\n > Great find, missing authorization.\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2021-12-maple",
  "Code": [
    {
      "filename": "contracts/MapleLoan.sol",
      "content": "// SPDX-License-Identifier: AGPL-3.0-or-later\npragma solidity ^0.8.7;\n\nimport { IERC20 }             from \"../modules/erc20/src/interfaces/IERC20.sol\";\nimport { IMapleProxyFactory } from \"../modules/maple-proxy-factory/contracts/interfaces/IMapleProxyFactory.sol\";\n\nimport { ERC20Helper } from \"../modules/erc20-helper/src/ERC20Helper.sol\";\n\nimport { IMapleLoan } from \"./interfaces/IMapleLoan.sol\";\nimport { IMapleGlobalsLike } from \"./interfaces/Interfaces.sol\";\n\nimport { MapleLoanInternals } from \"./MapleLoanInternals.sol\";\n\n/// @title MapleLoan implements a primitive loan with additional functionality, and is intended to be proxied.\ncontract MapleLoan is IMapleLoan, MapleLoanInternals {\n\n    modifier whenProtocolNotPaused() {\n        require(!isProtocolPaused(), \"ML:PROTOCOL_PAUSED\");\n        _;\n    }\n\n    /********************************/\n    /*** Administrative Functions ***/\n    /********************************/\n\n    function migrate(address migrator_, bytes calldata arguments_) external override {\n        require(msg.sender == _factory(),        \"ML:M:NOT_FACTORY\");\n        require(_migrate(migrator_, arguments_), \"ML:M:FAILED\");\n    }\n\n    function setImplementation(address newImplementation_) external override {\n        require(msg.sender == _factory(),               \"ML:SI:NOT_FACTORY\");\n        require(_setImplementation(newImplementation_), \"ML:SI:FAILED\");\n    }\n\n    function upgrade(uint256 toVersion_, bytes calldata arguments_) external override {\n        require(msg.sender == _borrower, \"ML:U:NOT_BORROWER\");\n\n        emit Upgraded(toVersion_, arguments_);\n\n        IMapleProxyFactory(_factory()).upgradeInstance(toVersion_, arguments_);\n    }\n\n    /************************/\n    /*** Borrow Functions ***/\n    /************************/\n\n    function acceptBorrower() external override {\n        require(msg.sender == _pendingBorrower, \"ML:AB:NOT_PENDING_BORROWER\");\n\n        _pendingBorrower = address(0);\n\n        emit BorrowerAccepted(_borrower = msg.sender);\n    }\n\n    function closeLoan(uint256 amount_) external override returns (uint256 principal_, uint256 interest_) {\n        // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n        require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:CL:TRANSFER_FROM_FAILED\");\n\n        ( principal_, interest_ ) = _closeLoan();\n\n        emit LoanClosed(principal_, interest_);\n    }\n\n    function drawdownFunds(uint256 amount_, address destination_) external override whenProtocolNotPaused returns (uint256 collateralPosted_) {\n        require(msg.sender == _borrower, \"ML:DF:NOT_BORROWER\");\n\n        emit FundsDrawnDown(amount_, destination_);\n\n        // Post additional collateral required to facilitate this drawdown, if needed.\n        uint256 additionalCollateralRequired = getAdditionalCollateralRequiredFor(amount_);\n\n        if (additionalCollateralRequired > uint256(0)) {\n            // Determine collateral currently unaccounted for.\n            uint256 unaccountedCollateral = _getUnaccountedAmount(_collateralAsset);\n\n            // Post required collateral, specifying then amount lacking as the optional amount to be transferred from.\n            collateralPosted_ = postCollateral(\n                additionalCollateralRequired > unaccountedCollateral ? additionalCollateralRequired - unaccountedCollateral : uint256(0)\n            );\n        }\n\n        _drawdownFunds(amount_, destination_);\n    }\n\n    function makePayment(uint256 amount_) external override returns (uint256 principal_, uint256 interest_) {\n        // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n        require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:MP:TRANSFER_FROM_FAILED\");\n\n        ( principal_, interest_ ) = _makePayment();\n\n        emit PaymentMade(principal_, interest_);\n    }\n\n    function postCollateral(uint256 amount_) public override whenProtocolNotPaused returns (uint256 collateralPosted_) {\n        // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n        require(\n            amount_ == uint256(0) || ERC20Helper.transferFrom(_collateralAsset, msg.sender, address(this), amount_),\n            \"ML:PC:TRANSFER_FROM_FAILED\"\n        );\n\n        emit CollateralPosted(collateralPosted_ = _postCollateral());\n    }\n\n    function proposeNewTerms(address refinancer_, bytes[] calldata calls_) external override whenProtocolNotPaused {\n        require(msg.sender == _borrower, \"ML:PNT:NOT_BORROWER\");\n\n        emit NewTermsProposed(_proposeNewTerms(refinancer_, calls_), refinancer_, calls_);\n    }\n\n    function removeCollateral(uint256 amount_, address destination_) external override whenProtocolNotPaused {\n        require(msg.sender == _borrower, \"ML:RC:NOT_BORROWER\");\n\n        emit CollateralRemoved(amount_, destination_);\n\n        _removeCollateral(amount_, destination_);\n    }\n\n    function returnFunds(uint256 amount_) public override whenProtocolNotPaused returns (uint256 fundsReturned_) {\n        // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n        require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:RF:TRANSFER_FROM_FAILED\");\n\n        emit FundsReturned(fundsReturned_ = _returnFunds());\n    }\n\n    function setPendingBorrower(address pendingBorrower_) external override {\n        require(msg.sender == _borrower, \"ML:SPB:NOT_BORROWER\");\n\n        emit PendingBorrowerSet(_pendingBorrower = pendingBorrower_);\n    }\n\n    /**********************/\n    /*** Lend Functions ***/\n    /**********************/\n\n    function acceptLender() external override {\n        require(msg.sender == _pendingLender, \"ML:AL:NOT_PENDING_LENDER\");\n\n        _pendingLender = address(0);\n\n        emit LenderAccepted(_lender = msg.sender);\n    }\n\n    function acceptNewTerms(address refinancer_, bytes[] calldata calls_, uint256 amount_) external override whenProtocolNotPaused {\n        require(msg.sender == _lender, \"ML:ANT:NOT_LENDER\");\n\n        // The amount specified is an optional amount to be transfer from the caller, as a convenience for EOAs.\n        require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:ACT:TRANSFER_FROM_FAILED\");\n\n        emit NewTermsAccepted(_acceptNewTerms(refinancer_, calls_), refinancer_, calls_);\n\n        uint256 extra = _getUnaccountedAmount(_fundsAsset);\n\n        // NOTE: This block ensures unaccounted funds (pre-existing or due to over-funding) gets redirected to the lender.\n        if (extra > uint256(0)) {\n            emit FundsRedirected(extra, _lender);\n            require(ERC20Helper.transfer(_fundsAsset, _lender, extra), \"ML:ANT:TRANSFER_FAILED\");\n        }\n    }\n\n    function claimFunds(uint256 amount_, address destination_) external override whenProtocolNotPaused {\n        require(msg.sender == _lender, \"ML:CF:NOT_LENDER\");\n\n        emit FundsClaimed(amount_, destination_);\n\n        _claimFunds(amount_, destination_);\n    }\n\n    function fundLoan(address lender_, uint256 amount_) external override whenProtocolNotPaused returns (uint256 fundsLent_) {\n        // The amount specified is an optional amount to be transferred from the caller, as a convenience for EOAs.\n        require(amount_ == uint256(0) || ERC20Helper.transferFrom(_fundsAsset, msg.sender, address(this), amount_), \"ML:FL:TRANSFER_FROM_FAILED\");\n\n        // If the loan is not active, fund it.\n        if (_nextPaymentDueDate == uint256(0)) {\n            emit Funded(lender_, fundsLent_ = _fundLoan(lender_), _nextPaymentDueDate);\n        }\n\n        uint256 extra = _getUnaccountedAmount(_fundsAsset);\n\n        // NOTE: This block is not only a stopgap solution to allow a LiquidityLockerV1 to send funds to a DebtLocker, while maintaining PoolV1 accounting,\n        //       but also ensures unaccounted funds (pre-existing or due to over-funding) gets redirected to the lender.\n        if (extra > uint256(0)) {\n            emit FundsRedirected(extra, _lender);\n            require(ERC20Helper.transfer(_fundsAsset, _lender, extra), \"ML:FL:TRANSFER_FAILED\");\n        }\n    }\n\n    function repossess(address destination_) external override whenProtocolNotPaused returns (uint256 collateralRepossessed_, uint256 fundsRepossessed_) {\n        require(msg.sender == _lender, \"ML:R:NOT_LENDER\");\n\n        ( collateralRepossessed_, fundsRepossessed_ ) = _repossess(destination_);\n\n        emit Repossessed(collateralRepossessed_, fundsRepossessed_, destination_);\n    }\n\n    function setPendingLender(address pendingLender_) external override {\n        require(msg.sender == _lender, \"ML:SPL:NOT_LENDER\");\n\n        emit PendingLenderSet(_pendingLender = pendingLender_);\n    }\n\n    /*******************************/\n    /*** Miscellaneous Functions ***/\n    /*******************************/\n\n    function skim(address token_, address destination_) external override whenProtocolNotPaused returns (uint256 skimmed_) {\n        require((msg.sender == _borrower) || (msg.sender == _lender),    \"L:S:NO_AUTH\");\n        require((token_ != _fundsAsset) && (token_ != _collateralAsset), \"L:S:INVALID_TOKEN\");\n\n        emit Skimmed(token_, skimmed_ = IERC20(token_).balanceOf(address(this)), destination_);\n\n        require(ERC20Helper.transfer(token_, destination_, skimmed_), \"L:S:TRANSFER_FAILED\");\n    }\n\n    /**********************/\n    /*** View Functions ***/\n    /**********************/\n\n    function getAdditionalCollateralRequiredFor(uint256 drawdown_) public view override returns (uint256 collateral_) {\n        // Determine the collateral needed in the contract for a reduced drawable funds amount.\n        uint256 collateralNeeded = _getCollateralRequiredFor(_principal, _drawableFunds - drawdown_, _principalRequested, _collateralRequired);\n\n        return collateralNeeded > _collateral ? collateralNeeded - _collateral : uint256(0);\n    }\n\n    function getEarlyPaymentBreakdown() external view override returns (uint256 principal_, uint256 interest_) {\n        ( principal_, interest_ ) = _getEarlyPaymentBreakdown();\n    }\n\n    function getNextPaymentBreakdown() external view override returns (uint256 principal_, uint256 interest_) {\n        ( principal_, interest_ ) = _getNextPaymentBreakdown();\n    }\n\n    function isProtocolPaused() public view override returns (bool paused_) {\n        return IMapleGlobalsLike(IMapleProxyFactory(_factory()).mapleGlobals()).protocolPaused();\n    }\n\n    /****************************/\n    /*** State View Functions ***/\n    /****************************/\n\n    function borrower() external view override returns (address borrower_) {\n        return _borrower;\n    }\n\n    function claimableFunds() external view override returns (uint256 claimableFunds_) {\n        return _claimableFunds;\n    }\n\n    function collateral() external view override returns (uint256 collateral_) {\n        return _collateral;\n    }\n\n    function collateralAsset() external view override returns (address collateralAsset_) {\n        return _collateralAsset;\n    }\n\n    function collateralRequired() external view override returns (uint256 collateralRequired_) {\n        return _collateralRequired;\n    }\n\n    function drawableFunds() external view override returns (uint256 drawableFunds_) {\n        return _drawableFunds;\n    }\n\n    function earlyFeeRate() external view override returns (uint256 earlyFeeRate_) {\n        return _earlyFeeRate;\n    }\n\n    function endingPrincipal() external view override returns (uint256 endingPrincipal_) {\n        return _endingPrincipal;\n    }\n\n    function excessCollateral() external view override returns (uint256 excessCollateral_) {\n        uint256 collateralNeeded = _getCollateralRequiredFor(_principal, _drawableFunds, _principalRequested, _collateralRequired);\n\n        return _collateral > collateralNeeded ? _collateral - collateralNeeded : uint256(0);\n    }\n\n    function factory() external view override returns (address factory_) {\n        return _factory();\n    }\n\n    function fundsAsset() external view override returns (address fundsAsset_) {\n        return _fundsAsset;\n    }\n\n    function gracePeriod() external view override returns (uint256 gracePeriod_) {\n        return _gracePeriod;\n    }\n\n    function implementation() external view override returns (address implementation_) {\n        return _implementation();\n    }\n\n    function interestRate() external view override returns (uint256 interestRate_) {\n        return _interestRate;\n    }\n\n    function lateFeeRate() external view override returns (uint256 lateFeeRate_) {\n        return _lateFeeRate;\n    }\n\n    function lateInterestPremium() external view override returns (uint256 lateInterestPremium_) {\n        return _lateInterestPremium;\n    }\n\n    function lender() external view override returns (address lender_) {\n        return _lender;\n    }\n\n    function nextPaymentDueDate() external view override returns (uint256 nextPaymentDueDate_) {\n        return _nextPaymentDueDate;\n    }\n\n    function paymentInterval() external view override returns (uint256 paymentInterval_) {\n        return _paymentInterval;\n    }\n\n    function paymentsRemaining() external view override returns (uint256 paymentsRemaining_) {\n        return _paymentsRemaining;\n    }\n\n    function pendingBorrower() external view override returns (address pendingBorrower_) {\n        return _pendingBorrower;\n    }\n\n    function pendingLender() external view override returns (address pendingLender_) {\n        return _pendingLender;\n    }\n\n    function principalRequested() external view override returns (uint256 principalRequested_) {\n        return _principalRequested;\n    }\n\n    function principal() external view override returns (uint256 principal_) {\n        return _principal;\n    }\n\n    // NOTE: This is needed for `fundLoan` call from PoolV1.\n    function superFactory() external view override returns (address superFactory_) {\n        return _factory();\n    }\n\n}"
    }
  ]
}