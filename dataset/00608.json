{
  "Title": "Namespace Balance Transfer Value Can Be Lost",
  "Content": "The `BalanceTransferSystem` is used to send a namespace's accounted ETH value to either another namespace or to an address. However, [balances can be sent](https://github.com/latticexyz/mud/blob/12a9eb1afb18a7f7cb43d774cabb2d5af7c74e6b/packages/world/src/modules/core/implementations/BalanceTransferSystem.sol#L30) to a non-existent namespace. This could occur due to human error and would likely lead to a loss of funds. Although the non-existent namespace could be registered afterwards, any other user could front-run this registration to get control over the funds.\n\n\nConsider checking whether the recipient namespace exists before proceeding with the transaction.\n\n\n***Update:** Resolved in [pull request #2095](https://github.com/latticexyz/mud/pull/2095).*\n\n\n",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "packages/world/src/modules/core/implementations/BalanceTransferSystem.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity >=0.8.21;\n\nimport { ResourceId, ResourceIdInstance } from \"@latticexyz/store/src/ResourceId.sol\";\n\nimport { System } from \"../../../System.sol\";\nimport { revertWithBytes } from \"../../../revertWithBytes.sol\";\nimport { WorldResourceIdLib, WorldResourceIdInstance } from \"../../../WorldResourceId.sol\";\nimport { AccessControl } from \"../../../AccessControl.sol\";\nimport { RESOURCE_NAMESPACE } from \"../../../worldResourceTypes.sol\";\nimport { IWorldErrors } from \"../../../IWorldErrors.sol\";\n\nimport { Balances } from \"../../../codegen/tables/Balances.sol\";\n\n/**\n * @title Balance Transfer System\n * @dev A system contract that facilitates balance transfers in the World and outside of the World.\n */\ncontract BalanceTransferSystem is System, IWorldErrors {\n  using ResourceIdInstance for ResourceId;\n  using WorldResourceIdInstance for ResourceId;\n\n  /**\n   * @notice Transfer balance to another namespace in the World.\n   * @dev Requires the caller to have access to the source namespace and ensures the destination namespace type is valid.\n   * @param fromNamespaceId The source namespace from which the balance will be deducted.\n   * @param toNamespaceId The target namespace where the balance will be added.\n   * @param amount The amount to transfer.\n   */\n  function transferBalanceToNamespace(\n    ResourceId fromNamespaceId,\n    ResourceId toNamespaceId,\n    uint256 amount\n  ) public virtual {\n    // Require the target ID to be a namespace ID\n    if (toNamespaceId.getType() != RESOURCE_NAMESPACE) {\n      revert World_InvalidResourceType(RESOURCE_NAMESPACE, toNamespaceId, toNamespaceId.toString());\n    }\n\n    // Require caller to have access to the namespace\n    AccessControl.requireAccess(fromNamespaceId, _msgSender());\n\n    // Get current namespace balance\n    uint256 balance = Balances._get(fromNamespaceId);\n\n    // Require the balance balance to be greater or equal to the amount to transfer\n    if (amount > balance) revert World_InsufficientBalance(balance, amount);\n\n    // Update the balances\n    Balances._set(fromNamespaceId, balance - amount);\n    Balances._set(toNamespaceId, Balances._get(toNamespaceId) + amount);\n  }\n\n  /**\n   * @notice Transfer balance out of the World to a specific address.\n   * @dev Requires the caller to have access to the source namespace and ensures sufficient balance before transfer.\n   * @param fromNamespaceId The source namespace from which the balance will be deducted.\n   * @param toAddress The target address where the balance will be sent.\n   * @param amount The amount to transfer.\n   */\n  function transferBalanceToAddress(ResourceId fromNamespaceId, address toAddress, uint256 amount) public virtual {\n    // Require caller to have access to the namespace\n    AccessControl.requireAccess(fromNamespaceId, _msgSender());\n\n    // Get current namespace balance\n    uint256 balance = Balances._get(fromNamespaceId);\n\n    // Require the balance balance to be greater or equal to the amount to transfer\n    if (amount > balance) revert World_InsufficientBalance(balance, amount);\n\n    // Update the balances\n    Balances._set(fromNamespaceId, balance - amount);\n\n    // Transfer the balance to the given address, revert on failure\n    (bool success, bytes memory data) = payable(toAddress).call{ value: amount }(\"\");\n    if (!success) revertWithBytes(data);\n  }\n}"
    }
  ]
}