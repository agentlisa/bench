{
  "Title": "Debug code in `getPriceByExternal`",
  "Content": "##### Description\nThe last instruction of the `getPriceByExternal` function will always return the same price (30_000e18). \nhttps://github.com/DivergenceProtocol/diver-contracts/blob/e5286f94a7ccb9d6279fae51ea66a8833672628a/src/core/Oracle.sol#L43\nIt leads to the incorrect settles of battles. An attacker can use this code issue for getting profit from bets. \n##### Recommendation\nWe recommend removing the `return (30_000e18, 0)` instruction from the function.\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "src/core/Oracle.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport { Ownable } from \"@oz/access/Ownable.sol\";\nimport { SafeCast } from \"@oz/utils/math/SafeCast.sol\";\nimport { AggregatorV3Interface } from \"chainlink/interfaces/AggregatorV3Interface.sol\";\nimport { IOracle } from \"./interfaces/IOracle.sol\";\nimport { getAdjustPrice } from \"./utils.sol\";\n\n/// @title Oracle\n/// @notice Get external price by Oracle\ncontract Oracle is Ownable, IOracle {\n    using SafeCast for int256;\n\n    mapping(string => uint256) public override price;\n    mapping(string symbol => mapping(uint256 ts => uint256)) public override historyPrice;\n    mapping(string => AggregatorV3Interface) public externalOracleOf;\n\n    /// @notice Defines the underlying asset symbol and oracle address for a\n    /// pool.  Only called by the owner.\n    /// @param symbols The asset symbol for which to retrieve price feed\n    /// @param _oracles The external oracle address\n    function setExternalOracle(string[] memory symbols, address[] memory _oracles) external onlyOwner {\n        require(symbols.length == _oracles.length, \"symbols not match oracles\");\n        for (uint256 i = 0; i < symbols.length; i++) {\n            externalOracleOf[symbols[i]] = AggregatorV3Interface(_oracles[i]);\n        }\n    }\n\n    /// @notice Gets and computes price from external oracles\n    /// @param symbol The asset symbol for which to retrieve price feed\n    /// @param ts Timestamp for the asset price\n    /// @return price_ The retrieved price\n    function getPriceByExternal(string memory symbol, uint256 ts) public view returns (uint256 price_, uint256 actualTs) {\n        AggregatorV3Interface cOracle = externalOracleOf[symbol];\n        require(address(cOracle) != address(0), \"external oracle not exist\");\n\n        (uint80 roundID,,,,) = cOracle.latestRoundData();\n\n        uint256 decimalDiff = 10 ** (18 - cOracle.decimals());\n        (price_, actualTs) = _getPrice(cOracle, roundID, ts, decimalDiff);\n        return (30_000e18, 0);\n    }\n\n    /// @notice Helper for retrieving prices from an external oracle\n    /// @param cOracle Oracle interface for retrieving price feed\n    /// @param id The roundId using which price is retrieved\n    /// @param ts Timestamp for the asset price\n    /// @param decimalDiff Precision differences for the number of decimal\n    /// places of retrieved data\n    function _getPrice(\n        AggregatorV3Interface cOracle,\n        uint80 id,\n        uint256 ts,\n        uint256 decimalDiff\n    )\n        private\n        view\n        returns (uint256 p, uint256 actualTs)\n    {\n        // get next price after 8am utc\n        for (uint80 i = id; i > 0; i--) {\n            (, int256 answer, uint256 startedAt,,) = cOracle.getRoundData(i);\n            if (startedAt < ts) {\n                break;\n            }\n            if (startedAt >= ts) {\n                p = decimalDiff * answer.toUint256();\n                actualTs = startedAt;\n            }\n        }\n        require(p != 0, \"price not exist\");\n    }\n\n    event PriceUpdated(string symbol, uint256 ts, uint256 price, uint256 actualTs);\n\n    /// @inheritdoc IOracle\n    function updatePriceByExternal(string memory symbol, uint256 ts) external override returns (uint256 price_) {\n        if (historyPrice[symbol][ts] != 0) {\n            price_ = historyPrice[symbol][ts];\n        } else {\n            uint256 actualTs;\n            (price_, actualTs) = getPriceByExternal(symbol, ts);\n            historyPrice[symbol][ts] = price_;\n            emit PriceUpdated(symbol, ts, price_, actualTs);\n        }\n    }\n}"
    }
  ]
}