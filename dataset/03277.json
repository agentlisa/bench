{
  "Title": "Incorrect usage of function returned value",
  "Content": "##### Description\nVault's withdraw function returns amount of tokens which was transferred, not shares:\nhttps://github.com/Gearbox-protocol/gearbox-contracts/blob/0ac33ba87212ce056ac6b6357ad74161d417158a/contracts/adapters/YearnV2.sol#L145\n##### Recommendation\nWe recommend to change function code.",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/adapters/YearnV2.sol",
      "content": "// SPDX-License-Identifier: MIT\n// Gearbox. Generalized leverage protocol that allows to take leverage and then use it across other DeFi protocols and platforms in a composable way.\n// (c) Gearbox.fi, 2021\npragma solidity ^0.7.4;\n\nimport {ERC20} from \"@openzeppelin/contracts/token/ERC20/ERC20.sol\";\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\n\nimport {ICreditFilter} from \"../interfaces/ICreditFilter.sol\";\nimport {ICreditManager} from \"../interfaces/ICreditManager.sol\";\nimport {IYVault} from \"../integrations/yearn/IYVault.sol\";\n\nimport {CreditAccount} from \"../credit/CreditAccount.sol\";\nimport {CreditManager} from \"../credit/CreditManager.sol\";\n\nimport {Constants} from \"../libraries/helpers/Constants.sol\";\nimport {Errors} from \"../libraries/helpers/Errors.sol\";\n\nimport \"hardhat/console.sol\";\n\n/// @title Yearn adapter\ncontract YearnAdapter is IYVault {\n    using SafeMath for uint256;\n\n    address public yVault;\n    address public override token;\n\n    ICreditManager public creditManager;\n    ICreditFilter public creditFilter;\n\n    /// @dev Constructor\n    /// @param _creditManager Address Credit manager\n    /// @param _yVault Address of yVault\n    constructor(address _creditManager, address _yVault) {\n        creditManager = ICreditManager(_creditManager);\n        creditFilter = ICreditFilter(creditManager.creditFilter());\n\n        yVault = _yVault;\n\n        // Check that we have token connected with this yearn pool\n        token = IYVault(yVault).token();\n        creditFilter.revertIfTokenNotAllowed(token);\n    }\n\n    /// @dev Deposit credit account tokens to Yearn\n    /// @param amount in tokens\n    function deposit(uint256 amount, address)\n        external\n        override\n        returns (uint256)\n    {\n        // bytes4(0xb6b55f25) = deposit\n        return _deposit(abi.encodeWithSelector(bytes4(0xb6b55f25), amount));\n    }\n\n    /// @dev Deposit credit account tokens to Yearn\n    /// @param amount in tokens\n    function deposit(uint256 amount) external override returns (uint256) {\n        // bytes4(0xb6b55f25) = deposit\n        return _deposit(abi.encodeWithSelector(bytes4(0xb6b55f25), amount));\n    }\n\n    /// @dev Deposit credit account tokens to Yearn\n    function deposit() external override returns (uint256) {\n        // bytes4(0xb6b55f25) = deposit\n        return\n            _deposit(\n                abi.encodeWithSelector(bytes4(0xb6b55f25), Constants.MAX_INT)\n            );\n    }\n\n    function _deposit(bytes memory data) internal returns (uint256 shares) {\n        address creditAccount = creditManager.getCreditAccountOrRevert(\n            msg.sender\n        );\n\n        creditManager.provideCreditAccountAllowance(\n            creditAccount,\n            yVault,\n            token\n        );\n\n        uint256 balanceBefore = ERC20(token).balanceOf(creditAccount);\n\n        shares = abi.decode(\n            creditManager.executeOrder(msg.sender, yVault, data),\n            (uint256)\n        );\n\n        creditFilter.checkCollateralChange(\n            creditAccount,\n            token,\n            yVault,\n            balanceBefore.sub(ERC20(token).balanceOf(creditAccount)),\n            shares\n        );\n    }\n\n    function withdraw() external override returns (uint256) {\n        return withdraw(Constants.MAX_INT, address(0), 1);\n    }\n\n    function withdraw(uint256 maxShares) external override returns (uint256) {\n        return withdraw(maxShares, address(0), 1);\n    }\n\n    function withdraw(uint256 maxShares, address recipient)\n        external\n        override\n        returns (uint256)\n    {\n        return withdraw(maxShares, recipient, 1);\n    }\n\n    /// @dev Withdraw yVaults from credit account\n    /// @param maxShares How many shares to try and redeem for tokens, defaults to all.\n    //  @param recipient The address to issue the shares in this Vault to. Defaults to the caller's address.\n    //  @param maxLoss The maximum acceptable loss to sustain on withdrawal. Defaults to 0.01%.\n    //                 If a loss is specified, up to that amount of shares may be burnt to cover losses on withdrawal.\n    //  @return The quantity of tokens redeemed for `_shares`.\n    function withdraw(\n        uint256 maxShares,\n        address,\n        uint256 maxLoss\n    ) public override returns (uint256 shares) {\n        address creditAccount = creditManager.getCreditAccountOrRevert(\n            msg.sender\n        );\n\n        creditManager.provideCreditAccountAllowance(\n            creditAccount,\n            yVault,\n            token\n        );\n\n        bytes memory data = abi.encodeWithSelector(\n            bytes4(0x2e1a7d4d), //\"withdraw(uint256,address,uint256)\",\n            maxShares,\n            creditAccount,\n            maxLoss\n        );\n\n        uint256 balance = ERC20(token).balanceOf(creditAccount);\n\n        shares = abi.decode(\n            creditManager.executeOrder(msg.sender, yVault, data),\n            (uint256)\n        );\n\n        creditFilter.checkCollateralChange(\n            creditAccount,\n            yVault,\n            token,\n            shares,\n            ERC20(token).balanceOf(creditAccount).sub(balance)\n        );\n    }\n\n    function pricePerShare() external view override returns (uint256) {\n        return IYVault(yVault).pricePerShare();\n    }\n\n    function name() external view override returns (string memory) {\n        return IYVault(yVault).name();\n    }\n\n    function symbol() external view override returns (string memory) {\n        return IYVault(yVault).symbol();\n    }\n\n    function decimals() external view override returns (uint256) {\n        return IYVault(yVault).decimals();\n    }\n\n    function allowance(address owner, address spender)\n        external\n        view\n        override\n        returns (uint256)\n    {\n        return IYVault(yVault).allowance(owner, spender);\n    }\n\n    function approve(address, uint256) external pure override returns (bool) {\n        return true;\n    }\n\n    function balanceOf(address account)\n        external\n        view\n        override\n        returns (uint256)\n    {\n        return IYVault(yVault).balanceOf(account);\n    }\n\n    function totalSupply() external view override returns (uint256) {\n        return IYVault(yVault).totalSupply();\n    }\n\n    function transfer(address, uint256) external pure override returns (bool) {\n        revert(Errors.NOT_IMPLEMENTED);\n    }\n\n    function transferFrom(\n        address,\n        address,\n        uint256\n    ) external pure override returns (bool) {\n        revert(Errors.NOT_IMPLEMENTED);\n    }\n}"
    }
  ]
}