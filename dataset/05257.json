{
  "Title": "[M-29] Incorrect calculation to check remaining ratio after reward in StableConfig.sol",
  "Content": "\n<https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/StableConfig.sol#L51-L54> \n\n><https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/StableConfig.sol#L127-L130>\n\n[changeMinimumCollateralRatioPercent()](https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/StableConfig.sol#L127-L130) allows the owner to change the `minimumCollateralRatioPercent` while the [changeRewardPercentForCallingLiquidation()](https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/StableConfig.sol#L51-L54) function allows to change the `rewardPercentForCallingLiquidation`. <br>\nThe protocol aims to maintain a remaining ratio of `105%` as is evident by the comments in these 2 functions:\n\n```js\n// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n```\n\nand\n\n```js\n// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n```\n\nThat is, if borrow amount is `100`, after the calls to any of these two functions, there should be at least `105` collateral remaining which will act as buffer against market volatility.<br>\nThe current calculation however is incorrect and there is really no direct relationship (*in the way the developer assumes*) between the `rewardPercentForCallingLiquidation` and `minimumCollateralRatioPercent`. Consider this:\n\n*   `minimumCollateralRatioPercent` of 110% means that for a borrow amount of `200`, collateral should not go below `220`. This is 110% ***of 200***.\n*   However, `rewardPercentForCallingLiquidation` of 5% is calculated on the ***collateral amount*** and NOT the borrowed amount as is evident in the comments too [here](https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/StableConfig.sol#L18) and [here](https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/CollateralAndLiquidity.sol#L156). So the liquidator will receive `5% of 220` (*let's assume boundary values for rounded calculations*) which is `11`.\n*   The remaining amount would be `220 - 11 = 209` which is `104.5%` of the borrowed amount. This is less than the 105% the protocol was aiming for. In fact, this figure of `104.5%` goes down further to `103.5%` when `rewardPercentForCallingLiquidation = 5%` and `minimumCollateralRatioPercent = 115%` which is much lower than protocol's buffer target. Not being aware of this risk can cause unexpected loss of funds.\n\nA table outlining the real buffer upper limit values is provided below. Another table showing the actual desirable gap in values is also provided so that the buffer always is above 105%. <br>\n\nStraightaway, it can be seen that the current default protocol values of 5% and 110% give a buffer of less than 105% and hence either the `minimumCollateralRatioPercent` needs to have a lower limit of `111` instead of 110, or there should be agreement to the fact that `103.5%` is an acceptable `remainingRatio` figure under the current scheme of things.\n\n### Proof of Concept\n\nAll figures expressed as ***% of borrowed amount*** i.e. `104.5` means `100` was borrowed. <br>\n\nCurrent Implementation:\n\n| rewardPercentForCallingLiquidation | minimumCollateralRatioPercent | ***Actual*** price fluctuation upper limit (instead of the expected 105%) |\n| :--------------------------------: | :---------------------------: | :-----------------------------------------------------------------------: |\n|                  5                 |              110              |                                   104.5                                   |\n|                  6                 |              111              |                                   104.34                                  |\n|                  7                 |              112              |                                   104.16                                  |\n|                  8                 |              113              |                                   103.96                                  |\n|                  9                 |              114              |                                   103.74                                  |\n|                 10                 |              115              |                                   103.5                                   |\n\n<br>\n\nDesired figures for maintaining an upper limit of `>= 105%` of borrowed amount:\n\n| rewardPercentForCallingLiquidation | ***Desired*** minimumCollateralRatioPercent | ***Resultant*** price fluctuation upper limit |\n| :--------------------------------: | :-----------------------------------------: | :-------------------------------------------: |\n|                  5                 |                     111                     |                     105.45                    |\n|                  6                 |                     112                     |                     105.28                    |\n|                  7                 |                     113                     |                     105.09                    |\n|                  8                 |                     115                     |                     105.8                     |\n|                  9                 |                     116                     |                     105.56                    |\n|                 10                 |                     117                     |                     105.3                     |\n\n### Recommended Mitigation Steps\n\nAssuming that the protocol wants to calculate an actual 105% `remainingRatio`, changes along these lines need to be made. Please note that you may have to additionally make sure rounding errors & precision loss do not creep in. These suggestions point towards a general direction:<br>\nUpdate the two functions:\n\n```diff\n\tfunction changeRewardPercentForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n\t\t\t// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n+           uint256 afterIncrease = rewardPercentForCallingLiquidation + 1;\n+           uint256 remainingRatio = minimumCollateralRatioPercent - minimumCollateralRatioPercent * afterIncrease / 100;\n-\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - rewardPercentForCallingLiquidation - 1;\n\n-           if (remainingRatioAfterReward >= 105 && rewardPercentForCallingLiquidation < 10)\n+           if (remainingRatio >= 105 && rewardPercentForCallingLiquidation < 10)\n                rewardPercentForCallingLiquidation += 1;\n            }\n        else\n            {\n            if (rewardPercentForCallingLiquidation > 5)\n                rewardPercentForCallingLiquidation -= 1;\n            }\n\n\t\temit RewardPercentForCallingLiquidationChanged(rewardPercentForCallingLiquidation);\n        }\n```\n\nand\n\n```diff\n\tfunction changeMinimumCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralRatioPercent < 120)\n                minimumCollateralRatioPercent += 1;\n            }\n        else\n            {\n\t\t\t// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n+           uint256 afterDecrease = minimumCollateralRatioPercent - 1;\n+           uint256 remainingRatio = afterDecrease - afterDecrease * rewardPercentForCallingLiquidation / 100;            \n-\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - 1 - rewardPercentForCallingLiquidation;\n\n-           if (remainingRatioAfterReward >= 105 && minimumCollateralRatioPercent > 110)\n+           if (remainingRatio >= 105 && minimumCollateralRatioPercent > 111)\n                minimumCollateralRatioPercent -= 1;\n            }\n\n\t\temit MinimumCollateralRatioPercentChanged(minimumCollateralRatioPercent);\n        }\n```\n\nAlso [L39](https://github.com/code-423n4/2024-01-salty/blob/main/src/stable/StableConfig.sol#L39):\n\n```diff\n- 39:     uint256 public minimumCollateralRatioPercent = 110;\n+ 39:     uint256 public minimumCollateralRatioPercent = 111;\n```\n\n**[Picodes (Judge) commented](https://github.com/code-423n4/2024-01-salty-findings/issues/118#issuecomment-1956884139):**\n > This report shows how an invariant of the protocol is broken so Medium severity seems appropriate.\n\n**[othernet-global (Salty.IO) acknowledged and commented](https://github.com/code-423n4/2024-01-salty-findings/issues/118#issuecomment-1960691761):**\n > The stablecoin framework: /stablecoin, /price_feed, WBTC/WETH collateral, PriceAggregator, price feeds and USDS have been removed:\n\n> https://github.com/othernet-global/salty-io/commit/88b7fd1f3f5e037a155424a85275efd79f3e9bf9\n\n**Status:** Mitigation confirmed. Full details in reports from [zzebra83](https://github.com/code-423n4/2024-03-saltyio-mitigation-findings/issues/111), [0xpiken](https://github.com/code-423n4/2024-03-saltyio-mitigation-findings/issues/90), and [t0x1c](https://github.com/code-423n4/2024-03-saltyio-mitigation-findings/issues/26).\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2024-01-salty",
  "Code": [
    {
      "filename": "src/stable/StableConfig.sol",
      "content": "// SPDX-License-Identifier: BUSL 1.1\npragma solidity =0.8.22;\n\nimport \"openzeppelin-contracts/contracts/access/Ownable.sol\";\nimport \"./interfaces/IStableConfig.sol\";\n\n\n// Contract owned by the DAO with parameters modifiable only by the DAO\ncontract StableConfig is IStableConfig, Ownable\n    {\n    event RewardPercentForCallingLiquidationChanged(uint256 newRewardPercent);\n    event MaxRewardValueForCallingLiquidationChanged(uint256 newMaxRewardValue);\n    event MinimumCollateralValueForBorrowingChanged(uint256 newMinimumCollateralValue);\n    event InitialCollateralRatioPercentChanged(uint256 newInitialCollateralRatioPercent);\n    event MinimumCollateralRatioPercentChanged(uint256 newMinimumCollateralRatioPercent);\n    event PercentArbitrageProfitsForStablePOLChanged(uint256 newPercentArbitrageProfits);\n\n\t// The reward (in collateraLP) that a user receives for instigating the liquidation process - as a percentage of the amount of collateralLP that is liquidated.\n\t// Range: 5 to 10 with an adjustment of 1\n    uint256 public rewardPercentForCallingLiquidation = 5;\n\n\t// The maximum reward value (in USD) that a user receives for instigating the liquidation process.\n\t// Range: 100 to 1000 with an adjustment of 100 ether\n    uint256 public maxRewardValueForCallingLiquidation = 500 ether;\n\n\t// The minimum USD value of collateral - to borrow an initial amount of USDS.\n\t// This is to help prevent saturation of the contract with small amounts of positions and to ensure that liquidating the position yields non-trivial rewards\n\t// Range: 1000 to 5000 with an adjustment of 500 ether\n    uint256 public minimumCollateralValueForBorrowing = 2500 ether;\n\n    // the initial maximum collateral / borrowed USDS ratio.\n    // Defaults to 2.0x so that staking $1000 worth of BTC/ETH LP would allow you to borrow $500 of USDS\n    // Range: 150 to 300 with an adjustment of 25\n    uint256 public initialCollateralRatioPercent = 200;\n\n\t// The minimum ratio of collateral / borrowed USDS below which positions can be liquidated\n\t// and the user losing their collateral (and keeping the borrowed USDS)\n\t// Range: 110 to 120 with an adjustment of 1\n\tuint256 public minimumCollateralRatioPercent = 110;\n\n\t// The percent of arbitrage profits that are used to form USDS/DAI Protocol Owned Liquidity.\n\t// The liquidity generates yield for the DAO and can be liquidated in the event of undercollateralized liquidations.\n\t// Range: 1 to 10 with an adjustment of 1\n\tuint256 public percentArbitrageProfitsForStablePOL = 5;\n\n\n\tfunction changeRewardPercentForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n\t\t\t// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - rewardPercentForCallingLiquidation - 1;\n\n            if (remainingRatioAfterReward >= 105 && rewardPercentForCallingLiquidation < 10)\n                rewardPercentForCallingLiquidation += 1;\n            }\n        else\n            {\n            if (rewardPercentForCallingLiquidation > 5)\n                rewardPercentForCallingLiquidation -= 1;\n            }\n\n\t\temit RewardPercentForCallingLiquidationChanged(rewardPercentForCallingLiquidation);\n        }\n\n\n\tfunction changeMaxRewardValueForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (maxRewardValueForCallingLiquidation < 1000 ether)\n                maxRewardValueForCallingLiquidation += 100 ether;\n            }\n        else\n            {\n            if (maxRewardValueForCallingLiquidation > 100 ether)\n                maxRewardValueForCallingLiquidation -= 100 ether;\n            }\n\n\t\temit MaxRewardValueForCallingLiquidationChanged(maxRewardValueForCallingLiquidation);\n        }\n\n\n\tfunction changeMinimumCollateralValueForBorrowing(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralValueForBorrowing < 5000 ether)\n                minimumCollateralValueForBorrowing += 500 ether;\n            }\n        else\n            {\n            if (minimumCollateralValueForBorrowing > 1000 ether)\n                minimumCollateralValueForBorrowing -= 500 ether;\n            }\n\n\t\temit MinimumCollateralValueForBorrowingChanged(minimumCollateralValueForBorrowing);\n        }\n\n\n\tfunction changeInitialCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (initialCollateralRatioPercent < 300)\n                initialCollateralRatioPercent += 25;\n            }\n        else\n            {\n            if (initialCollateralRatioPercent > 150)\n                initialCollateralRatioPercent -= 25;\n            }\n\n\t\temit InitialCollateralRatioPercentChanged(initialCollateralRatioPercent);\n        }\n\n\n\tfunction changeMinimumCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralRatioPercent < 120)\n                minimumCollateralRatioPercent += 1;\n            }\n        else\n            {\n\t\t\t// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - 1 - rewardPercentForCallingLiquidation;\n\n            if (remainingRatioAfterReward >= 105 && minimumCollateralRatioPercent > 110)\n                minimumCollateralRatioPercent -= 1;\n            }\n\n\t\temit MinimumCollateralRatioPercentChanged(minimumCollateralRatioPercent);\n        }\n\n\n\tfunction changePercentArbitrageProfitsForStablePOL(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (percentArbitrageProfitsForStablePOL < 10)\n                percentArbitrageProfitsForStablePOL += 1;\n            }\n        else\n            {\n            if (percentArbitrageProfitsForStablePOL > 1)\n                percentArbitrageProfitsForStablePOL -= 1;\n            }\n\n\t\temit PercentArbitrageProfitsForStablePOLChanged(percentArbitrageProfitsForStablePOL);\n        }\n\t}"
    },
    {
      "filename": "src/stable/StableConfig.sol",
      "content": "// SPDX-License-Identifier: BUSL 1.1\npragma solidity =0.8.22;\n\nimport \"openzeppelin-contracts/contracts/access/Ownable.sol\";\nimport \"./interfaces/IStableConfig.sol\";\n\n\n// Contract owned by the DAO with parameters modifiable only by the DAO\ncontract StableConfig is IStableConfig, Ownable\n    {\n    event RewardPercentForCallingLiquidationChanged(uint256 newRewardPercent);\n    event MaxRewardValueForCallingLiquidationChanged(uint256 newMaxRewardValue);\n    event MinimumCollateralValueForBorrowingChanged(uint256 newMinimumCollateralValue);\n    event InitialCollateralRatioPercentChanged(uint256 newInitialCollateralRatioPercent);\n    event MinimumCollateralRatioPercentChanged(uint256 newMinimumCollateralRatioPercent);\n    event PercentArbitrageProfitsForStablePOLChanged(uint256 newPercentArbitrageProfits);\n\n\t// The reward (in collateraLP) that a user receives for instigating the liquidation process - as a percentage of the amount of collateralLP that is liquidated.\n\t// Range: 5 to 10 with an adjustment of 1\n    uint256 public rewardPercentForCallingLiquidation = 5;\n\n\t// The maximum reward value (in USD) that a user receives for instigating the liquidation process.\n\t// Range: 100 to 1000 with an adjustment of 100 ether\n    uint256 public maxRewardValueForCallingLiquidation = 500 ether;\n\n\t// The minimum USD value of collateral - to borrow an initial amount of USDS.\n\t// This is to help prevent saturation of the contract with small amounts of positions and to ensure that liquidating the position yields non-trivial rewards\n\t// Range: 1000 to 5000 with an adjustment of 500 ether\n    uint256 public minimumCollateralValueForBorrowing = 2500 ether;\n\n    // the initial maximum collateral / borrowed USDS ratio.\n    // Defaults to 2.0x so that staking $1000 worth of BTC/ETH LP would allow you to borrow $500 of USDS\n    // Range: 150 to 300 with an adjustment of 25\n    uint256 public initialCollateralRatioPercent = 200;\n\n\t// The minimum ratio of collateral / borrowed USDS below which positions can be liquidated\n\t// and the user losing their collateral (and keeping the borrowed USDS)\n\t// Range: 110 to 120 with an adjustment of 1\n\tuint256 public minimumCollateralRatioPercent = 110;\n\n\t// The percent of arbitrage profits that are used to form USDS/DAI Protocol Owned Liquidity.\n\t// The liquidity generates yield for the DAO and can be liquidated in the event of undercollateralized liquidations.\n\t// Range: 1 to 10 with an adjustment of 1\n\tuint256 public percentArbitrageProfitsForStablePOL = 5;\n\n\n\tfunction changeRewardPercentForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n\t\t\t// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - rewardPercentForCallingLiquidation - 1;\n\n            if (remainingRatioAfterReward >= 105 && rewardPercentForCallingLiquidation < 10)\n                rewardPercentForCallingLiquidation += 1;\n            }\n        else\n            {\n            if (rewardPercentForCallingLiquidation > 5)\n                rewardPercentForCallingLiquidation -= 1;\n            }\n\n\t\temit RewardPercentForCallingLiquidationChanged(rewardPercentForCallingLiquidation);\n        }\n\n\n\tfunction changeMaxRewardValueForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (maxRewardValueForCallingLiquidation < 1000 ether)\n                maxRewardValueForCallingLiquidation += 100 ether;\n            }\n        else\n            {\n            if (maxRewardValueForCallingLiquidation > 100 ether)\n                maxRewardValueForCallingLiquidation -= 100 ether;\n            }\n\n\t\temit MaxRewardValueForCallingLiquidationChanged(maxRewardValueForCallingLiquidation);\n        }\n\n\n\tfunction changeMinimumCollateralValueForBorrowing(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralValueForBorrowing < 5000 ether)\n                minimumCollateralValueForBorrowing += 500 ether;\n            }\n        else\n            {\n            if (minimumCollateralValueForBorrowing > 1000 ether)\n                minimumCollateralValueForBorrowing -= 500 ether;\n            }\n\n\t\temit MinimumCollateralValueForBorrowingChanged(minimumCollateralValueForBorrowing);\n        }\n\n\n\tfunction changeInitialCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (initialCollateralRatioPercent < 300)\n                initialCollateralRatioPercent += 25;\n            }\n        else\n            {\n            if (initialCollateralRatioPercent > 150)\n                initialCollateralRatioPercent -= 25;\n            }\n\n\t\temit InitialCollateralRatioPercentChanged(initialCollateralRatioPercent);\n        }\n\n\n\tfunction changeMinimumCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralRatioPercent < 120)\n                minimumCollateralRatioPercent += 1;\n            }\n        else\n            {\n\t\t\t// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - 1 - rewardPercentForCallingLiquidation;\n\n            if (remainingRatioAfterReward >= 105 && minimumCollateralRatioPercent > 110)\n                minimumCollateralRatioPercent -= 1;\n            }\n\n\t\temit MinimumCollateralRatioPercentChanged(minimumCollateralRatioPercent);\n        }\n\n\n\tfunction changePercentArbitrageProfitsForStablePOL(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (percentArbitrageProfitsForStablePOL < 10)\n                percentArbitrageProfitsForStablePOL += 1;\n            }\n        else\n            {\n            if (percentArbitrageProfitsForStablePOL > 1)\n                percentArbitrageProfitsForStablePOL -= 1;\n            }\n\n\t\temit PercentArbitrageProfitsForStablePOLChanged(percentArbitrageProfitsForStablePOL);\n        }\n\t}"
    },
    {
      "filename": "src/stable/StableConfig.sol",
      "content": "// SPDX-License-Identifier: BUSL 1.1\npragma solidity =0.8.22;\n\nimport \"openzeppelin-contracts/contracts/access/Ownable.sol\";\nimport \"./interfaces/IStableConfig.sol\";\n\n\n// Contract owned by the DAO with parameters modifiable only by the DAO\ncontract StableConfig is IStableConfig, Ownable\n    {\n    event RewardPercentForCallingLiquidationChanged(uint256 newRewardPercent);\n    event MaxRewardValueForCallingLiquidationChanged(uint256 newMaxRewardValue);\n    event MinimumCollateralValueForBorrowingChanged(uint256 newMinimumCollateralValue);\n    event InitialCollateralRatioPercentChanged(uint256 newInitialCollateralRatioPercent);\n    event MinimumCollateralRatioPercentChanged(uint256 newMinimumCollateralRatioPercent);\n    event PercentArbitrageProfitsForStablePOLChanged(uint256 newPercentArbitrageProfits);\n\n\t// The reward (in collateraLP) that a user receives for instigating the liquidation process - as a percentage of the amount of collateralLP that is liquidated.\n\t// Range: 5 to 10 with an adjustment of 1\n    uint256 public rewardPercentForCallingLiquidation = 5;\n\n\t// The maximum reward value (in USD) that a user receives for instigating the liquidation process.\n\t// Range: 100 to 1000 with an adjustment of 100 ether\n    uint256 public maxRewardValueForCallingLiquidation = 500 ether;\n\n\t// The minimum USD value of collateral - to borrow an initial amount of USDS.\n\t// This is to help prevent saturation of the contract with small amounts of positions and to ensure that liquidating the position yields non-trivial rewards\n\t// Range: 1000 to 5000 with an adjustment of 500 ether\n    uint256 public minimumCollateralValueForBorrowing = 2500 ether;\n\n    // the initial maximum collateral / borrowed USDS ratio.\n    // Defaults to 2.0x so that staking $1000 worth of BTC/ETH LP would allow you to borrow $500 of USDS\n    // Range: 150 to 300 with an adjustment of 25\n    uint256 public initialCollateralRatioPercent = 200;\n\n\t// The minimum ratio of collateral / borrowed USDS below which positions can be liquidated\n\t// and the user losing their collateral (and keeping the borrowed USDS)\n\t// Range: 110 to 120 with an adjustment of 1\n\tuint256 public minimumCollateralRatioPercent = 110;\n\n\t// The percent of arbitrage profits that are used to form USDS/DAI Protocol Owned Liquidity.\n\t// The liquidity generates yield for the DAO and can be liquidated in the event of undercollateralized liquidations.\n\t// Range: 1 to 10 with an adjustment of 1\n\tuint256 public percentArbitrageProfitsForStablePOL = 5;\n\n\n\tfunction changeRewardPercentForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n\t\t\t// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - rewardPercentForCallingLiquidation - 1;\n\n            if (remainingRatioAfterReward >= 105 && rewardPercentForCallingLiquidation < 10)\n                rewardPercentForCallingLiquidation += 1;\n            }\n        else\n            {\n            if (rewardPercentForCallingLiquidation > 5)\n                rewardPercentForCallingLiquidation -= 1;\n            }\n\n\t\temit RewardPercentForCallingLiquidationChanged(rewardPercentForCallingLiquidation);\n        }\n\n\n\tfunction changeMaxRewardValueForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (maxRewardValueForCallingLiquidation < 1000 ether)\n                maxRewardValueForCallingLiquidation += 100 ether;\n            }\n        else\n            {\n            if (maxRewardValueForCallingLiquidation > 100 ether)\n                maxRewardValueForCallingLiquidation -= 100 ether;\n            }\n\n\t\temit MaxRewardValueForCallingLiquidationChanged(maxRewardValueForCallingLiquidation);\n        }\n\n\n\tfunction changeMinimumCollateralValueForBorrowing(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralValueForBorrowing < 5000 ether)\n                minimumCollateralValueForBorrowing += 500 ether;\n            }\n        else\n            {\n            if (minimumCollateralValueForBorrowing > 1000 ether)\n                minimumCollateralValueForBorrowing -= 500 ether;\n            }\n\n\t\temit MinimumCollateralValueForBorrowingChanged(minimumCollateralValueForBorrowing);\n        }\n\n\n\tfunction changeInitialCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (initialCollateralRatioPercent < 300)\n                initialCollateralRatioPercent += 25;\n            }\n        else\n            {\n            if (initialCollateralRatioPercent > 150)\n                initialCollateralRatioPercent -= 25;\n            }\n\n\t\temit InitialCollateralRatioPercentChanged(initialCollateralRatioPercent);\n        }\n\n\n\tfunction changeMinimumCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralRatioPercent < 120)\n                minimumCollateralRatioPercent += 1;\n            }\n        else\n            {\n\t\t\t// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - 1 - rewardPercentForCallingLiquidation;\n\n            if (remainingRatioAfterReward >= 105 && minimumCollateralRatioPercent > 110)\n                minimumCollateralRatioPercent -= 1;\n            }\n\n\t\temit MinimumCollateralRatioPercentChanged(minimumCollateralRatioPercent);\n        }\n\n\n\tfunction changePercentArbitrageProfitsForStablePOL(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (percentArbitrageProfitsForStablePOL < 10)\n                percentArbitrageProfitsForStablePOL += 1;\n            }\n        else\n            {\n            if (percentArbitrageProfitsForStablePOL > 1)\n                percentArbitrageProfitsForStablePOL -= 1;\n            }\n\n\t\temit PercentArbitrageProfitsForStablePOLChanged(percentArbitrageProfitsForStablePOL);\n        }\n\t}"
    },
    {
      "filename": "src/stable/StableConfig.sol",
      "content": "// SPDX-License-Identifier: BUSL 1.1\npragma solidity =0.8.22;\n\nimport \"openzeppelin-contracts/contracts/access/Ownable.sol\";\nimport \"./interfaces/IStableConfig.sol\";\n\n\n// Contract owned by the DAO with parameters modifiable only by the DAO\ncontract StableConfig is IStableConfig, Ownable\n    {\n    event RewardPercentForCallingLiquidationChanged(uint256 newRewardPercent);\n    event MaxRewardValueForCallingLiquidationChanged(uint256 newMaxRewardValue);\n    event MinimumCollateralValueForBorrowingChanged(uint256 newMinimumCollateralValue);\n    event InitialCollateralRatioPercentChanged(uint256 newInitialCollateralRatioPercent);\n    event MinimumCollateralRatioPercentChanged(uint256 newMinimumCollateralRatioPercent);\n    event PercentArbitrageProfitsForStablePOLChanged(uint256 newPercentArbitrageProfits);\n\n\t// The reward (in collateraLP) that a user receives for instigating the liquidation process - as a percentage of the amount of collateralLP that is liquidated.\n\t// Range: 5 to 10 with an adjustment of 1\n    uint256 public rewardPercentForCallingLiquidation = 5;\n\n\t// The maximum reward value (in USD) that a user receives for instigating the liquidation process.\n\t// Range: 100 to 1000 with an adjustment of 100 ether\n    uint256 public maxRewardValueForCallingLiquidation = 500 ether;\n\n\t// The minimum USD value of collateral - to borrow an initial amount of USDS.\n\t// This is to help prevent saturation of the contract with small amounts of positions and to ensure that liquidating the position yields non-trivial rewards\n\t// Range: 1000 to 5000 with an adjustment of 500 ether\n    uint256 public minimumCollateralValueForBorrowing = 2500 ether;\n\n    // the initial maximum collateral / borrowed USDS ratio.\n    // Defaults to 2.0x so that staking $1000 worth of BTC/ETH LP would allow you to borrow $500 of USDS\n    // Range: 150 to 300 with an adjustment of 25\n    uint256 public initialCollateralRatioPercent = 200;\n\n\t// The minimum ratio of collateral / borrowed USDS below which positions can be liquidated\n\t// and the user losing their collateral (and keeping the borrowed USDS)\n\t// Range: 110 to 120 with an adjustment of 1\n\tuint256 public minimumCollateralRatioPercent = 110;\n\n\t// The percent of arbitrage profits that are used to form USDS/DAI Protocol Owned Liquidity.\n\t// The liquidity generates yield for the DAO and can be liquidated in the event of undercollateralized liquidations.\n\t// Range: 1 to 10 with an adjustment of 1\n\tuint256 public percentArbitrageProfitsForStablePOL = 5;\n\n\n\tfunction changeRewardPercentForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n\t\t\t// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - rewardPercentForCallingLiquidation - 1;\n\n            if (remainingRatioAfterReward >= 105 && rewardPercentForCallingLiquidation < 10)\n                rewardPercentForCallingLiquidation += 1;\n            }\n        else\n            {\n            if (rewardPercentForCallingLiquidation > 5)\n                rewardPercentForCallingLiquidation -= 1;\n            }\n\n\t\temit RewardPercentForCallingLiquidationChanged(rewardPercentForCallingLiquidation);\n        }\n\n\n\tfunction changeMaxRewardValueForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (maxRewardValueForCallingLiquidation < 1000 ether)\n                maxRewardValueForCallingLiquidation += 100 ether;\n            }\n        else\n            {\n            if (maxRewardValueForCallingLiquidation > 100 ether)\n                maxRewardValueForCallingLiquidation -= 100 ether;\n            }\n\n\t\temit MaxRewardValueForCallingLiquidationChanged(maxRewardValueForCallingLiquidation);\n        }\n\n\n\tfunction changeMinimumCollateralValueForBorrowing(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralValueForBorrowing < 5000 ether)\n                minimumCollateralValueForBorrowing += 500 ether;\n            }\n        else\n            {\n            if (minimumCollateralValueForBorrowing > 1000 ether)\n                minimumCollateralValueForBorrowing -= 500 ether;\n            }\n\n\t\temit MinimumCollateralValueForBorrowingChanged(minimumCollateralValueForBorrowing);\n        }\n\n\n\tfunction changeInitialCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (initialCollateralRatioPercent < 300)\n                initialCollateralRatioPercent += 25;\n            }\n        else\n            {\n            if (initialCollateralRatioPercent > 150)\n                initialCollateralRatioPercent -= 25;\n            }\n\n\t\temit InitialCollateralRatioPercentChanged(initialCollateralRatioPercent);\n        }\n\n\n\tfunction changeMinimumCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralRatioPercent < 120)\n                minimumCollateralRatioPercent += 1;\n            }\n        else\n            {\n\t\t\t// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - 1 - rewardPercentForCallingLiquidation;\n\n            if (remainingRatioAfterReward >= 105 && minimumCollateralRatioPercent > 110)\n                minimumCollateralRatioPercent -= 1;\n            }\n\n\t\temit MinimumCollateralRatioPercentChanged(minimumCollateralRatioPercent);\n        }\n\n\n\tfunction changePercentArbitrageProfitsForStablePOL(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (percentArbitrageProfitsForStablePOL < 10)\n                percentArbitrageProfitsForStablePOL += 1;\n            }\n        else\n            {\n            if (percentArbitrageProfitsForStablePOL > 1)\n                percentArbitrageProfitsForStablePOL -= 1;\n            }\n\n\t\temit PercentArbitrageProfitsForStablePOLChanged(percentArbitrageProfitsForStablePOL);\n        }\n\t}"
    },
    {
      "filename": "src/stable/StableConfig.sol",
      "content": "// SPDX-License-Identifier: BUSL 1.1\npragma solidity =0.8.22;\n\nimport \"openzeppelin-contracts/contracts/access/Ownable.sol\";\nimport \"./interfaces/IStableConfig.sol\";\n\n\n// Contract owned by the DAO with parameters modifiable only by the DAO\ncontract StableConfig is IStableConfig, Ownable\n    {\n    event RewardPercentForCallingLiquidationChanged(uint256 newRewardPercent);\n    event MaxRewardValueForCallingLiquidationChanged(uint256 newMaxRewardValue);\n    event MinimumCollateralValueForBorrowingChanged(uint256 newMinimumCollateralValue);\n    event InitialCollateralRatioPercentChanged(uint256 newInitialCollateralRatioPercent);\n    event MinimumCollateralRatioPercentChanged(uint256 newMinimumCollateralRatioPercent);\n    event PercentArbitrageProfitsForStablePOLChanged(uint256 newPercentArbitrageProfits);\n\n\t// The reward (in collateraLP) that a user receives for instigating the liquidation process - as a percentage of the amount of collateralLP that is liquidated.\n\t// Range: 5 to 10 with an adjustment of 1\n    uint256 public rewardPercentForCallingLiquidation = 5;\n\n\t// The maximum reward value (in USD) that a user receives for instigating the liquidation process.\n\t// Range: 100 to 1000 with an adjustment of 100 ether\n    uint256 public maxRewardValueForCallingLiquidation = 500 ether;\n\n\t// The minimum USD value of collateral - to borrow an initial amount of USDS.\n\t// This is to help prevent saturation of the contract with small amounts of positions and to ensure that liquidating the position yields non-trivial rewards\n\t// Range: 1000 to 5000 with an adjustment of 500 ether\n    uint256 public minimumCollateralValueForBorrowing = 2500 ether;\n\n    // the initial maximum collateral / borrowed USDS ratio.\n    // Defaults to 2.0x so that staking $1000 worth of BTC/ETH LP would allow you to borrow $500 of USDS\n    // Range: 150 to 300 with an adjustment of 25\n    uint256 public initialCollateralRatioPercent = 200;\n\n\t// The minimum ratio of collateral / borrowed USDS below which positions can be liquidated\n\t// and the user losing their collateral (and keeping the borrowed USDS)\n\t// Range: 110 to 120 with an adjustment of 1\n\tuint256 public minimumCollateralRatioPercent = 110;\n\n\t// The percent of arbitrage profits that are used to form USDS/DAI Protocol Owned Liquidity.\n\t// The liquidity generates yield for the DAO and can be liquidated in the event of undercollateralized liquidations.\n\t// Range: 1 to 10 with an adjustment of 1\n\tuint256 public percentArbitrageProfitsForStablePOL = 5;\n\n\n\tfunction changeRewardPercentForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n\t\t\t// Don't increase rewardPercentForCallingLiquidation if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - rewardPercentForCallingLiquidation - 1;\n\n            if (remainingRatioAfterReward >= 105 && rewardPercentForCallingLiquidation < 10)\n                rewardPercentForCallingLiquidation += 1;\n            }\n        else\n            {\n            if (rewardPercentForCallingLiquidation > 5)\n                rewardPercentForCallingLiquidation -= 1;\n            }\n\n\t\temit RewardPercentForCallingLiquidationChanged(rewardPercentForCallingLiquidation);\n        }\n\n\n\tfunction changeMaxRewardValueForCallingLiquidation(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (maxRewardValueForCallingLiquidation < 1000 ether)\n                maxRewardValueForCallingLiquidation += 100 ether;\n            }\n        else\n            {\n            if (maxRewardValueForCallingLiquidation > 100 ether)\n                maxRewardValueForCallingLiquidation -= 100 ether;\n            }\n\n\t\temit MaxRewardValueForCallingLiquidationChanged(maxRewardValueForCallingLiquidation);\n        }\n\n\n\tfunction changeMinimumCollateralValueForBorrowing(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralValueForBorrowing < 5000 ether)\n                minimumCollateralValueForBorrowing += 500 ether;\n            }\n        else\n            {\n            if (minimumCollateralValueForBorrowing > 1000 ether)\n                minimumCollateralValueForBorrowing -= 500 ether;\n            }\n\n\t\temit MinimumCollateralValueForBorrowingChanged(minimumCollateralValueForBorrowing);\n        }\n\n\n\tfunction changeInitialCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (initialCollateralRatioPercent < 300)\n                initialCollateralRatioPercent += 25;\n            }\n        else\n            {\n            if (initialCollateralRatioPercent > 150)\n                initialCollateralRatioPercent -= 25;\n            }\n\n\t\temit InitialCollateralRatioPercentChanged(initialCollateralRatioPercent);\n        }\n\n\n\tfunction changeMinimumCollateralRatioPercent(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (minimumCollateralRatioPercent < 120)\n                minimumCollateralRatioPercent += 1;\n            }\n        else\n            {\n\t\t\t// Don't decrease the minimumCollateralRatioPercent if the remainingRatio after the rewards would be less than 105% - to ensure that the position will be liquidatable for more than the originally borrowed USDS amount (assume reasonable market volatility)\n\t\t\tuint256 remainingRatioAfterReward = minimumCollateralRatioPercent - 1 - rewardPercentForCallingLiquidation;\n\n            if (remainingRatioAfterReward >= 105 && minimumCollateralRatioPercent > 110)\n                minimumCollateralRatioPercent -= 1;\n            }\n\n\t\temit MinimumCollateralRatioPercentChanged(minimumCollateralRatioPercent);\n        }\n\n\n\tfunction changePercentArbitrageProfitsForStablePOL(bool increase) external onlyOwner\n        {\n        if (increase)\n            {\n            if (percentArbitrageProfitsForStablePOL < 10)\n                percentArbitrageProfitsForStablePOL += 1;\n            }\n        else\n            {\n            if (percentArbitrageProfitsForStablePOL > 1)\n                percentArbitrageProfitsForStablePOL -= 1;\n            }\n\n\t\temit PercentArbitrageProfitsForStablePOLChanged(percentArbitrageProfitsForStablePOL);\n        }\n\t}"
    }
  ]
}