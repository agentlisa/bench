{
  "Title": "M-5: Swapper mechanism cannot incentivize ETH-WETH swaps without risking owner funds",
  "Content": "# Issue M-5: Swapper mechanism cannot incentivize ETH-WETH swaps without risking owner funds \n\nSource: https://github.com/sherlock-audit/2023-04-splits-judging/issues/60 \n\n## Found by \nobront\n\n## Summary\n\n## Vulnerability Detail\n\nWhen `flash()` is called on the Swapper contract, pairs of tokens are passed in consisting of (a) a base token, which is currently held by the contract and (b) a quote token, which is the `$tokenToBeneficiary` that the owner would like to receive.\n\nThese pairs are passed to the oracle to get the quoted value of each of them:\n```solidity\namountsToBeneficiary = $oracle.getQuoteAmounts(quoteParams_);\n```\nThe `UniV3OracleImpl.sol` contract returns a quote per pair of tokens. However, since Uniswap pools only consist of WETH (not ETH) and are ordered by token address, it performs two conversions first: `_convert()` converts ETH to WETH for both base and quote tokens, and `_sort()` orders the pairs by token address.\n\n```solidity\nConvertedQuotePair memory cqp = quoteParams_.quotePair._convert(_convertToken);\nSortedConvertedQuotePair memory scqp = cqp._sort();\n```\nThe oracle goes on to check for pair overrides, and gets the `scaledOfferFactor` for the pair being quoted:\n```solidity\nPairOverride memory po = _getPairOverride(scqp);\nif (po.scaledOfferFactor == 0) {\n    po.scaledOfferFactor = $defaultScaledOfferFactor;\n}\n```\nThe `scaledOfferFactor` is the discount being offered through the Swapper to perform the swap. The assumption is that this will be set to a moderate amount (approximately 5%) to incentivize bots to perform the swaps, but will be overridden with a value of ~0% for the same tokens, to ensure that bots aren't paid for swaps they don't need to perform.\n\nThe problem is that these overrides are set on the `scqp` (sorted, converted tokens), not the actual token addresses. For this reason, ETH and WETH are considered identical in terms of overrides.\n\nTherefore, Swapper owners who want to be paid out in ETH (ie where `$tokenToBeneficiary = ETH`) have two options:\n\n1) They can set the WETH-WETH override to 0%, which successfully stops bots from earning a fee on ETH-ETH trades, but will not provide any incentive for bots to swap WETH in the swapper into ETH. This makes the Swapper useless for WETH.\n\n2) They can keep the WETH-WETH pair at the original ~5%, which will incentivize WETH-ETH swaps, but will also pay 5% to bots for doing nothing when they take ETH out of the contract and return ETH. This makes the Swapper waste user funds.\n\nThe same issues exist going in the other direction, when `$tokenToBeneficiary = WETH`.\n\n## Impact\n\nUsers who want to be paid out in ETH or WETH will be forced to either (a) have the Swapper not function properly for a key pair or (b) pay bots to perform useless actions.\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-04-splits/blob/main/splits-oracle/src/UniV3OracleImpl.sol#L248-L260\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nThe `scaledOfferFactor` (along with its overrides) should be stored on the Swapper, not on the Oracle. \n\nIn order to keep the system modular and logically organized, the Oracle should always return the accurate price for the `scqp`. Then, it is the job of the Swapper to determine what discount is offered for which asset.\n\nThis will allow values to be stored in the actual `base` and `quote` assets being used, and not in their converted, sorted counterparts.\n\n\n\n## Discussion\n\n**zobront**\n\nFixed in https://github.com/0xSplits/splits-swapper/pull/4/files by replacing the `_convertToken` function used by the Swapper to be the identity function, leaving ETH as ETH instead of converting to WETH.\n\n**jacksanford1**\n\nConfirming that Splits meant for this fix (4) to link to this issue (60):\nhttps://github.com/0xSplits/splits-swapper/pull/4#issue-1696988978\n\n**securitygrid**\n\nEscalate for 10 USDC\nI also noticed this issue. I didn't submit it because I thought the swapper owner would go bankrupt if he allowed such trading pairs with a discount. ***This is misconfiguration***. In README.MD:\nQ: Please list any known issues/acceptable risks that should not result in a valid finding.\n  ***user misconfiguration***; swapper#flash callers are expected to be sophisticated (aka will check if a given txn reverts, will use flashbots rpc to avoid FR & owner-griefing, etc)\nSo, this is not a valid H/M.\n\n\n**sherlock-admin**\n\n > Escalate for 10 USDC\n> I also noticed this issue. I didn't submit it because I thought the swapper owner would go bankrupt if he allowed such trading pairs with a discount. ***This is misconfiguration***. In README.MD:\n> Q: Please list any known issues/acceptable risks that should not result in a valid finding.\n>   ***user misconfiguration***; swapper#flash callers are expected to be sophisticated (aka will check if a given txn reverts, will use flashbots rpc to avoid FR & owner-griefing, etc)\n> So, this is not a valid H/M.\n> \n\nYou've created a valid escalation for 10 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**hrishibhat**\n\nEscalation rejected\n\nValid medium\nThis is not a user misconfiguration, the issue here is that the pair overrides do not work as the system intended for ETH-WETH swaps regardless of the user input. So the complexity of the user does not matter here but is about the absent configuration for a pair. \n\n\n**sherlock-admin**\n\n> Escalation rejected\n> \n> Valid medium\n> This is not a user misconfiguration, the issue here is that the pair overrides do not work as the system intended for ETH-WETH swaps regardless of the user input. So the complexity of the user does not matter here but is about the absent configuration for a pair. \n> \n\nThis issue's escalations have been rejected!\n\nWatsons who escalated this issue will have their escalation amount deducted from their next payout.\n\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/65",
  "Code": [
    {
      "filename": "splits-oracle/src/UniV3OracleImpl.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0-or-later\npragma solidity ^0.8.17;\n\nimport {IUniswapV3Factory} from \"v3-core/interfaces/IUniswapV3Factory.sol\";\nimport {OracleLibrary} from \"v3-periphery/libraries/OracleLibrary.sol\";\nimport {TokenUtils} from \"splits-utils/TokenUtils.sol\";\n\nimport {OracleImpl} from \"./OracleImpl.sol\";\nimport {QuotePair, ConvertedQuotePair, SortedConvertedQuotePair} from \"./utils/QuotePair.sol\";\n\n/// @title UniV3 Oracle Implementation\n/// @author 0xSplits\n/// @notice A clone-implementation of an oracle using UniswapV3 TWAP\ncontract UniV3OracleImpl is OracleImpl {\n    /// -----------------------------------------------------------------------\n    /// libraries\n    /// -----------------------------------------------------------------------\n\n    using TokenUtils for address;\n\n    /// -----------------------------------------------------------------------\n    /// errors\n    /// -----------------------------------------------------------------------\n\n    error Pool_DoesNotExist();\n\n    /// -----------------------------------------------------------------------\n    /// structs\n    /// -----------------------------------------------------------------------\n\n    struct InitParams {\n        address owner;\n        bool paused;\n        uint24 defaultFee;\n        uint32 defaultPeriod;\n        uint32 defaultScaledOfferFactor;\n        SetPairOverrideParams[] pairOverrides;\n    }\n\n    struct SetPairOverrideParams {\n        QuotePair quotePair;\n        PairOverride pairOverride;\n    }\n\n    struct PairOverride {\n        uint24 fee;\n        uint32 period;\n        uint32 scaledOfferFactor;\n    }\n\n    /// -----------------------------------------------------------------------\n    /// events\n    /// -----------------------------------------------------------------------\n\n    event SetDefaultFee(uint24 defaultFee);\n    event SetDefaultPeriod(uint32 defaultPeriod);\n    event SetDefaultScaledOfferFactor(uint32 defaultScaledOfferFactor);\n    event SetPairOverrides(SetPairOverrideParams[] params);\n\n    /// -----------------------------------------------------------------------\n    /// storage\n    /// -----------------------------------------------------------------------\n\n    /// -----------------------------------------------------------------------\n    /// storage - constants & immutables\n    /// -----------------------------------------------------------------------\n\n    /// @dev percentages measured in hundredths of basis points\n    uint32 internal constant PERCENTAGE_SCALE = 100_00_00; // = 100%\n\n    address public immutable uniV3OracleFactory;\n    IUniswapV3Factory public immutable uniswapV3Factory;\n    address public immutable weth9;\n\n    /// -----------------------------------------------------------------------\n    /// storage - mutables\n    /// -----------------------------------------------------------------------\n\n    /// slot 0 - 0 byte free\n\n    /// OwnableImpl storage\n    /// address internal $owner;\n    /// 20 bytes\n\n    /// PausableImpl storage\n    /// bool internal $paused;\n    /// 1 byte\n\n    /// default uniswap pool fee\n    /// @dev PERCENTAGE_SCALE = 1e6 = 100_00_00 = 100%;\n    /// fee = 30_00 = 0.3% is the uniswap default\n    /// unless overriden, getQuoteAmounts will revert if a non-permitted pool fee is used\n    /// 3 bytes\n    uint24 internal $defaultFee;\n\n    /// default twap period\n    /// @dev unless overriden, getQuoteAmounts will revert if zero\n    /// 4 bytes\n    uint32 internal $defaultPeriod;\n\n    /// default price scaling factor\n    /// @dev PERCENTAGE_SCALE = 1e6 = 100_00_00 = 100% = no discount or premium\n    /// 99_00_00 = 99% = 1% discount to oracle; 101_00_00 = 101% = 1% premium to oracle\n    /// 4 bytes\n    uint32 internal $defaultScaledOfferFactor;\n\n    /// slot 1 - 0 bytes free\n\n    /// overrides for specific quote pairs\n    /// 32 bytes\n    mapping(address => mapping(address => PairOverride)) internal $_pairOverrides;\n\n    /// -----------------------------------------------------------------------\n    /// constructor & initializer\n    /// -----------------------------------------------------------------------\n\n    constructor(IUniswapV3Factory uniswapV3Factory_, address weth9_) {\n        uniV3OracleFactory = msg.sender;\n        uniswapV3Factory = uniswapV3Factory_;\n        weth9 = weth9_;\n    }\n\n    function initializer(InitParams calldata params_) external {\n        // only uniV3OracleFactory may call `initializer`\n        if (msg.sender != uniV3OracleFactory) revert Unauthorized();\n\n        __initOwnable(params_.owner);\n        $paused = params_.paused;\n        $defaultFee = params_.defaultFee;\n        $defaultPeriod = params_.defaultPeriod;\n        $defaultScaledOfferFactor = params_.defaultScaledOfferFactor;\n\n        _setPairOverrides(params_.pairOverrides);\n    }\n\n    /// -----------------------------------------------------------------------\n    /// functions\n    /// -----------------------------------------------------------------------\n\n    /// -----------------------------------------------------------------------\n    /// functions - public & external\n    /// -----------------------------------------------------------------------\n\n    /// -----------------------------------------------------------------------\n    /// functions - public & external - onlyOwner\n    /// -----------------------------------------------------------------------\n\n    /// set defaultFee\n    function setDefaultFee(uint24 defaultFee_) external onlyOwner {\n        $defaultFee = defaultFee_;\n        emit SetDefaultFee(defaultFee_);\n    }\n\n    /// set defaultPeriod\n    function setDefaultPeriod(uint32 defaultPeriod_) external onlyOwner {\n        $defaultPeriod = defaultPeriod_;\n        emit SetDefaultPeriod(defaultPeriod_);\n    }\n\n    /// set defaultScaledOfferFactor\n    function setDefaultScaledOfferFactor(uint32 defaultScaledOfferFactor_) external onlyOwner {\n        $defaultScaledOfferFactor = defaultScaledOfferFactor_;\n        emit SetDefaultScaledOfferFactor(defaultScaledOfferFactor_);\n    }\n\n    /// set pair overrides\n    function setPairOverrides(SetPairOverrideParams[] calldata params_) external onlyOwner {\n        _setPairOverrides(params_);\n        emit SetPairOverrides(params_);\n    }\n\n    /// -----------------------------------------------------------------------\n    /// functions - public & external - view\n    /// -----------------------------------------------------------------------\n\n    function defaultFee() external view returns (uint24) {\n        return $defaultFee;\n    }\n\n    function defaultPeriod() external view returns (uint32) {\n        return $defaultPeriod;\n    }\n\n    function defaultScaledOfferFactor() external view returns (uint32) {\n        return $defaultScaledOfferFactor;\n    }\n\n    /// get pair override for an array of quote pairs\n    function getPairOverrides(QuotePair[] calldata quotePairs_)\n        external\n        view\n        returns (PairOverride[] memory pairOverrides)\n    {\n        uint256 length = quotePairs_.length;\n        pairOverrides = new PairOverride[](length);\n        for (uint256 i; i < length;) {\n            pairOverrides[i] = _getPairOverride(quotePairs_[i]);\n            unchecked {\n                ++i;\n            }\n        }\n    }\n\n    /// get amounts for an array of quotes\n    function getQuoteAmounts(QuoteParams[] calldata quoteParams_)\n        external\n        view\n        override\n        pausable\n        returns (uint256[] memory quoteAmounts)\n    {\n        uint256 length = quoteParams_.length;\n        quoteAmounts = new uint256[](length);\n        for (uint256 i; i < length;) {\n            quoteAmounts[i] = _getQuoteAmount(quoteParams_[i]);\n            unchecked {\n                ++i;\n            }\n        }\n    }\n\n    /// -----------------------------------------------------------------------\n    /// functions - private & internal\n    /// -----------------------------------------------------------------------\n\n    /// set pair overrides\n    function _setPairOverrides(SetPairOverrideParams[] calldata params_) internal {\n        uint256 length = params_.length;\n        for (uint256 i; i < length;) {\n            _setPairOverride(params_[i]);\n            unchecked {\n                ++i;\n            }\n        }\n    }\n\n    /// set pair override\n    function _setPairOverride(SetPairOverrideParams calldata params_) internal {\n        SortedConvertedQuotePair memory scqp = _convertAndSortQuotePair(params_.quotePair);\n        $_pairOverrides[scqp.cToken0][scqp.cToken1] = params_.pairOverride;\n    }\n\n    /// -----------------------------------------------------------------------\n    /// functions - private & internal - views\n    /// -----------------------------------------------------------------------\n\n    /// get quote amount for a trade\n    function _getQuoteAmount(QuoteParams calldata quoteParams_) internal view returns (uint256) {\n        ConvertedQuotePair memory cqp = quoteParams_.quotePair._convert(_convertToken);\n        SortedConvertedQuotePair memory scqp = cqp._sort();\n\n        PairOverride memory po = _getPairOverride(scqp);\n        if (po.scaledOfferFactor == 0) {\n            po.scaledOfferFactor = $defaultScaledOfferFactor;\n        }\n\n        // skip oracle if converted tokens are equal\n        if (cqp.cBase == cqp.cQuote) {\n            return quoteParams_.baseAmount * po.scaledOfferFactor / PERCENTAGE_SCALE;\n        }\n\n        if (po.fee == 0) {\n            po.fee = $defaultFee;\n        }\n        if (po.period == 0) {\n            po.period = $defaultPeriod;\n        }\n\n        address pool = uniswapV3Factory.getPool(scqp.cToken0, scqp.cToken1, po.fee);\n        if (pool == address(0)) {\n            revert Pool_DoesNotExist();\n        }\n\n        // reverts if period is zero or > oldest observation\n        (int24 arithmeticMeanTick,) = OracleLibrary.consult({pool: pool, secondsAgo: po.period});\n\n        uint256 unscaledAmountToBeneficiary = OracleLibrary.getQuoteAtTick({\n            tick: arithmeticMeanTick,\n            baseAmount: quoteParams_.baseAmount,\n            baseToken: cqp.cBase,\n            quoteToken: cqp.cQuote\n        });\n\n        return unscaledAmountToBeneficiary * po.scaledOfferFactor / PERCENTAGE_SCALE;\n    }\n\n    /// get pair override\n    function _getPairOverride(QuotePair calldata quotePair_) internal view returns (PairOverride memory) {\n        return _getPairOverride(_convertAndSortQuotePair(quotePair_));\n    }\n\n    /// get pair overrides\n    function _getPairOverride(SortedConvertedQuotePair memory scqp_) internal view returns (PairOverride memory) {\n        return $_pairOverrides[scqp_.cToken0][scqp_.cToken1];\n    }\n\n    /// convert & sort tokens into canonical order\n    function _convertAndSortQuotePair(QuotePair calldata quotePair_)\n        internal\n        view\n        returns (SortedConvertedQuotePair memory)\n    {\n        return quotePair_._convert(_convertToken)._sort();\n    }\n\n    /// convert eth (0x0) to weth\n    function _convertToken(address token_) internal view returns (address) {\n        return token_._isETH() ? weth9 : token_;\n    }\n}"
    }
  ]
}