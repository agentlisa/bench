{
  "Title": "H-6: Keepers will suffer significant losses due to miss compensation for L1 rollup fees",
  "Content": "# Issue H-6: Keepers will suffer significant losses due to miss compensation for L1 rollup fees \n\nSource: https://github.com/sherlock-audit/2023-07-perennial-judging/issues/91 \n\n## Found by \nKingNFT\nWhile keepers submits transactions to L2 EVM chains, they need to pay both L2 execution fee and L1 rollup fee. Actually, L1 fees are much higher than L2 fees. In many case, L2 fees can be practically negligible. The current implementation only compensate and incentive keepers based on L2 gas consumption, keepers will suffer significant losses.\n\n## Vulnerability Detail\nAs shown of ````keep()```` modifier (L40-57), only L2  execution fee are compensated.\n```solidity\nFile: perennial-v2\\packages\\perennial-oracle\\contracts\\pyth\\PythOracle.sol\n124:     function commitRequested(uint256 versionIndex, bytes calldata updateData)\n125:         public\n126:         payable\n127:         keep(KEEPER_REWARD_PREMIUM, KEEPER_BUFFER, \"\")\n128:     {\n...\n157:     }\n\nFile: perennial-v2\\packages\\perennial-extensions\\contracts\\MultiInvoker.sol\n359:     function _executeOrder(\n360:         address account,\n361:         IMarket market,\n362:         uint256 nonce\n363:     ) internal keep (\n364:         UFixed18Lib.from(keeperMultiplier),\n365:         GAS_BUFFER,\n366:         abi.encode(account, market, orders(account, market, nonce).fee)\n367:     ) {\n...\n384:     }\n\n\nFile: root\\contracts\\attribute\\Kept.sol\n40:     modifier keep(UFixed18 multiplier, uint256 buffer, bytes memory data) {\n41:         uint256 startGas = gasleft();\n42: \n43:         _;\n44: \n45:         uint256 gasUsed = startGas - gasleft();\n46:         UFixed18 keeperFee = UFixed18Lib.from(gasUsed)\n47:             .mul(multiplier)\n48:             .add(UFixed18Lib.from(buffer))\n49:             .mul(_etherPrice())\n50:             .mul(UFixed18.wrap(block.basefee));\n51: \n52:         _raiseKeeperFee(keeperFee, data);\n53: \n54:         keeperToken().push(msg.sender, keeperFee);\n55: \n56:         emit KeeperCall(msg.sender, gasUsed, multiplier, buffer, keeperFee);\n57:     }\n\n```\n\nTakes a random selected transaction at the writing time\nhttps://optimistic.etherscan.io/tx/0xbb8e68e21c92acf4171fb6041b758b55acc3c559ec4595ed1129d534d90de995\n\nWe can find the L1 fee is much expensive than L2 fee.\n```solidity\nL2 fee = 0.06 Gwei * 113,449 ~= 6,806 Gwei\nL1 fee = 0.00006565634612417 ETH ~= 65656 Gwei\nL1 / L2 = 964%\n```\n\nTypically, L1 fees are dynamic and determined by the calldata length and smoothed Ethereum gas prices. To submit Pyth oracle price, the ````VAA```` calldata will be 1700+ bytes, keepers need to pay much L1 rollup fee.\n\nhttps://github.com/sherlock-audit/2023-07-perennial/blob/main/perennial-v2/packages/perennial-oracle/test/integration/pyth/PythOracle.test.ts#L34\n\n## Impact\nNo enough incentive for keeper to submit oracle price and execute orders, the system will not work.\n\n## Code Snippet\nhttps://github.com/sherlock-audit/2023-07-perennial/blob/main/root/contracts/attribute/Kept.sol#L40\n\n## Tool used\n\nManual Review\n\n## Recommendation\nCompensating  L1 rollup fee, here are some reference:\nhttps://docs.arbitrum.io/arbos/l1-pricing\nhttps://community.optimism.io/docs/developers/build/transaction-fees/#the-l1-data-fee\n\n\n\n## Discussion\n\n**sherlock-admin**\n\n1 comment(s) were left on this issue during the judging contest.\n\n**__141345__** commented:\n> m\n\n\n\n**arjun-io**\n\nThe `Kept` helper supports a buffer amount which can be used for this use case.\n\n**ydspa**\n\nEscalate\n\nUsing ````Kept```` buffer can't solve this problem, as the ratio of ````L1GasPrice / L2GasPrice```` changes in every block and can vary with a extreme wide range.\nLet's say \n```solidity\nCurrentL1GasPrice = 20 Gwei // it refers to smoothed recent Ethereum gas price provided by L2 system contract\nCurretnL2GasPrice = 2 Gwei   // it refers to block.basefee\nL1RollupGas = 40,000\nL1RollupFee = L1RollupGas * CurrentL1GasPrice  = 40,000 * 20 = 800,000 Gwei\n```\nTo compensate L1 rollup fee, we should set\n```solidity\nbuffer = L1RollupFee / CurrentL2GasPrice = 800,000 / 2 = 400,000\n```\nto make \n```solidity\nL1Compensation = buffer *  CurrentL2GasPrice = 400,000 * 2 = 800,000 = L1RollupFee \n```\n\nsome time later, i.e. 1 hour, gas prices change to\n```solidity\nNewL1GasPrice = 40 Gwei\nNewL2GasPrice = 0.01 Gwei \n```\nwe can see the ````L1Compensation```` will be far less than ````L1RollupFee````, keepers suffer losses\n```solidity\nL1RollupFee = L1RollupGas * CurrentL1GasPrice = 40, 000 * 40 = 1,600,000 Gwei\nL1Compensation = buffer * CurretnL2GasPrice = 400, 000 * 0.01 = 4,000 Gwei\n```\nIn contrast, if gas prices change to\n```solidity\nNewL1GasPrice = 10 Gwei\nNewL2GasPrice = 2 Gwei\n```\nthen, the ````L1Compensation```` is larger than ````L1RollupFee````, keepers earn extra profit.\n```solidity\nL1RollupFee = L1RollupGas * CurrentL1GasPrice = 40,000 * 10 = 400,000 Gwei\nL1Compensation= buffer * CurretnL2GasPrice = 400,000 * 2 = 800,000 Gwei\n```\n\nTherefore, regardless of how we set ````buffer````, as it's a fixed value, sometimes keepers suffer losses, and other times keepers earn extra profit.\n\nDuring periods that keepers suffer losses, they are likely to stop working and  the system is blocked.\nAnd other periods , the protocol suffer losses.\n\nAbout the severity:\n(1) As the users' orders will be held until keepers become profitable, the waiting time may be short as some minutes, may be long as some hours, or even some days. Users' financial losses are foreseeable.\n(2) while keepers earn extra profit, proper ratio of ````L1GasPrice / L2GasPrice```` and ````block.basefee```` could make ````keeperReward > settlementFee````, then a new attack vector become feasible，keepers can set ````1 wei```` orders by self to drain fund from protocol, as ````self.fee ~= 0, profit ~= keeperReward  - self.keeper = keeperReward  - settlementFee````\n```solidity\nFile: perennial-v2\\packages\\perennial\\contracts\\types\\Order.sol\n50:     function registerFee(\n51:         Order memory self,\n52:         OracleVersion memory latestVersion,\n53:         MarketParameter memory marketParameter,\n54:         RiskParameter memory riskParameter\n55:     ) internal pure {\n...\n64:         self.fee = self.maker.abs().mul(latestVersion.price.abs()).mul(UFixed6Lib.from(makerFee))\n65:             .add(self.long.abs().add(self.short.abs()).mul(latestVersion.price.abs()).mul(UFixed6Lib.from(takerFee)));\n66: \n67:         self.keeper = isEmpty(self) ? UFixed6Lib.ZERO : marketParameter.settlementFee;\n68:     }\n\n```\n\nTo sum up, I think it's high, not medium\n\n\n\n\n\n\n**sherlock-admin2**\n\n > Escalate\n> \n> Using ````Kept```` buffer can't solve this problem, as the ratio of ````L1GasPrice / L2GasPrice```` changes in every block and can vary with a extreme wide range.\n> Let's say \n> ```solidity\n> CurrentL1GasPrice = 20 Gwei // it refers to smoothed recent Ethereum gas price provided by L2 system contract\n> CurretnL2GasPrice = 2 Gwei   // it refers to block.basefee\n> L1RollupGas = 40,000\n> L1RollupFee = L1RollupGas * CurrentL1GasPrice  = 40,000 * 20 = 800,000 Gwei\n> ```\n> To compensate L1 rollup fee, we should set\n> ```solidity\n> buffer = L1RollupFee / CurrentL2GasPrice = 800,000 / 2 = 400,000\n> ```\n> to make \n> ```solidity\n> L1Compensation = buffer *  CurrentL2GasPrice = 400,000 * 2 = 800,000 = L1RollupFee \n> ```\n> \n> some time later, i.e. 1 hour, gas prices change to\n> ```solidity\n> NewL1GasPrice = 40 Gwei\n> NewL2GasPrice = 0.01 Gwei \n> ```\n> we can see the ````L1Compensation```` will be far less than ````L1RollupFee````, keepers suffer losses\n> ```solidity\n> L1RollupFee = L1RollupGas * CurrentL1GasPrice = 40, 000 * 40 = 1,600,000 Gwei\n> L1Compensation = buffer * CurretnL2GasPrice = 400, 000 * 0.01 = 4,000 Gwei\n> ```\n> In contrast, if gas prices change to\n> ```solidity\n> NewL1GasPrice = 10 Gwei\n> NewL2GasPrice = 2 Gwei\n> ```\n> then, the ````L1Compensation```` is larger than ````L1RollupFee````, keepers earn extra profit.\n> ```solidity\n> L1RollupFee = L1RollupGas * CurrentL1GasPrice = 40,000 * 10 = 400,000 Gwei\n> L1Compensation= buffer * CurretnL2GasPrice = 400,000 * 2 = 800,000 Gwei\n> ```\n> \n> Therefore, regardless of how we set ````buffer````, as it's a fixed value, sometimes keepers suffer losses, and other times keepers earn extra profit.\n> \n> During periods that keepers suffer losses, they are likely to stop working and  the system is blocked.\n> And other periods , the protocol suffer losses.\n> \n> About the severity:\n> (1) As the users' orders will be held until keepers become profitable, the waiting time may be short as some minutes, may be long as some hours, or even some days. Users' financial losses are foreseeable.\n> (2) while keepers earn extra profit, proper ratio of ````L1GasPrice / L2GasPrice```` and ````block.basefee```` could make ````keeperReward > settlementFee````, then a new attack vector become feasible，keepers can set ````1 wei```` orders by self to drain fund from protocol, as ````self.fee ~= 0, profit ~= keeperReward  - self.keeper = keeperReward  - settlementFee````\n> ```solidity\n> File: perennial-v2\\packages\\perennial\\contracts\\types\\Order.sol\n> 50:     function registerFee(\n> 51:         Order memory self,\n> 52:         OracleVersion memory latestVersion,\n> 53:         MarketParameter memory marketParameter,\n> 54:         RiskParameter memory riskParameter\n> 55:     ) internal pure {\n> ...\n> 64:         self.fee = self.maker.abs().mul(latestVersion.price.abs()).mul(UFixed6Lib.from(makerFee))\n> 65:             .add(self.long.abs().add(self.short.abs()).mul(latestVersion.price.abs()).mul(UFixed6Lib.from(takerFee)));\n> 66: \n> 67:         self.keeper = isEmpty(self) ? UFixed6Lib.ZERO : marketParameter.settlementFee;\n> 68:     }\n> \n> ```\n> \n> To sum up, I think it's high, not medium\n> \n> \n> \n> \n> \n\nYou've created a valid escalation!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**arjun-io**\n\nThanks for the thorough explanation on why a buffer won't work. We agree that we should modify the Kept function to estimate L1 gas costs, thanks for the report!\n\n**141345**\n\nThe severity of medium seems more appropriate.\n\nBecause according to sherlock's HM [criteria](https://docs.sherlock.xyz/audits/judging/judging):\n\n> Medium: \n> viable scenario (even if unlikely) that could cause the protocol to enter a state where a material amount of funds can be lost.\n> The attack path is possible with assumptions that either mimic on-chain conditions or reflect conditions that have a reasonable chance of becoming true in the future.\n> \n> High: \n> This vulnerability would result in a material loss of funds, and the cost of the attack is low.\n\nHere the imbalanced L1/L2 gas fee would not be too frequent. Most of the time, the buffer will be good to compensate for the keeper. The described loss will incur when all the special conditions are met, and the fixed buffer is not enough to cover the keeper's cost. \n\n\n**arjun-io**\n\nFixed\nUpdate Kept for L2s: https://github.com/equilibria-xyz/root/pull/74 and https://github.com/equilibria-xyz/root/pull/76\nUpdate Pyth Oracle for L2: https://github.com/equilibria-xyz/perennial-v2/pull/85\n\n**hrishibhat**\n\n@ydspa tend to agree with this comment:\nhttps://github.com/sherlock-audit/2023-07-perennial-judging/issues/91#issuecomment-1697458799\nA valid medium\n\n**ydspa**\n\n> @ydspa tend to agree with this comment: [#91 (comment)](https://github.com/sherlock-audit/2023-07-perennial-judging/issues/91#issuecomment-1697458799) A valid medium\n\nI think the conclusion of ````Here the imbalanced L1/L2 gas fee would not be too frequent```` is not correct, the ratio of ````L1GasPrice / L2GasPrice```` vary frequently in a very wide range. The following table shows 3 typical ````2-hours```` range of ````Ethereum VS Optimistic```` gas price in the past two weeks. We can see the ````Ratio```` can vary from ````e1```` to as large as ````e9````.\n\n| DateTime         | L1GasPrice  | L2GasPrice(Base) | Ratio(L1/L2) | Link                                                                                                          |\n|------------------|-------------|------------------|--------------|---------------------------------------------------------------------------------------------------------------|\n| 2023-08-27 02:00 | 13.19 Gwei  | 55 wei           | 2.40e8       | [link](https://optimistic.etherscan.io/tx/0x94c22266f7bed99aaf56d59bb5c85d5df407093bb4019afcface0f4ae3e077d0) |\n| 2023-08-27 02:30 | 16.20 Gwei  | 56 wei           | 2.30e8       | [link](https://optimistic.etherscan.io/tx/0xb785f2e3b5afeb27192bb29194ba5a254f612259bcc70762e70c0719b0bd4d22) |\n| 2023-08-27 03:00 | 14.95 Gwei  | 58 wei           | 2.58e8       | [link](https://optimistic.etherscan.io/tx/0x04ee0e14e6c5668cee166a1751078e52adbf02d0e0b73888f44bb4b1f227676d) |\n| 2023-08-27 03:30 | 15.55 Gwei  | 53 wei           | 2.93e8       | [link](https://optimistic.etherscan.io/tx/0xb120d5e8ba8c8db5c961b6537bdd8250662f60672124c52384351011ae3cab63) |\n| 2023-08-27 04:00 | 21.53 Gwei  | 51 wei           | 4.06e8       | [link](https://optimistic.etherscan.io/tx/0x1831b4ad38f9115da5baebe4592362098d50c7eefc6d3383dfc3d59da972e55e) |\n|                  |             |                  |              |                                                                                                               |\n|                  |             |                  |              |                                                                                                               |\n| 2023-08-22 02:00 | 46.41 Gwei  | 66 wei           | 0.7e9        | [link](https://optimistic.etherscan.io/tx/0x9c87ef7883b884e242d33d169b115638dea368ed7af78e7ab507f339e1b30b08) |\n| 2023-08-22 02:30 | 121.65 Gwei | 53 wei           | 2.30e9       | [link](https://optimistic.etherscan.io/tx/0x11b822ff0d6f5af9cac86be3c1a840e264312ec32c7e23135dfdb063685ee385) |\n| 2023-08-22 03:00 | 89.76 Gwei  | 52 wei           | 1.73e9       | [link](https://optimistic.etherscan.io/tx/0xbf67f40586cf3a96a4ff2d91d6b845206d4e896c87b015a2a4c76f636894a8f9) |\n| 2023-08-22 03:30 | 68.45 Gwei  | 51 wei           | 1.34e9       | [link](https://optimistic.etherscan.io/tx/0xc497778722064404a4cc4c97477af8b8de407cc39e5234714c2b6fc57bc49d39) |\n| 2023-08-22 04:00 | 42.59 Gwei  | 100 wei          | 0.43e9       | [link](https://optimistic.etherscan.io/tx/0xe8f04f5fd0b8056fee402238c0c65124123c195fb3fa03930e9e0037c03ffccc) |\n|                  |             |                  |              |                                                                                                               |\n|                  |             |                  |              |                                                                                                               |\n| 2023-08-17 10:00 | 229.22 Gwei | 3.36 Gwei        | 6.82e1       | [link](https://optimistic.etherscan.io/tx/0xd1e8e288dc216bb620797152bd70d5d1d7b75687f12981f394442d7b5c18951b) |\n| 2023-08-17 10:30 | 121.38 Gwei | 0.30 Gwei        | 4.05e2       | [link](https://optimistic.etherscan.io/tx/0x83f8f13109bf06f7be67c22988aa4018ff19e6e517d723019672b724be4c112a) |\n| 2023-08-17 11:00 | 138.89 Gwei | 1.64 Gwei        | 8.47e1       | [link](https://optimistic.etherscan.io/tx/0x496658d5f8952e8fbfb87296458258bf13e6a3b3aaae3b0ad84754b31a21f767) |\n| 2023-08-17 11:30 | 61.60 Gwei  | 0.1 Gwei         | 6.16e2       | [link](https://optimistic.etherscan.io/tx/0x733babe7bceb4dbaaed6e3ef0acd8d9b0628d6c93365996a111fe0192042d4a0) |\n| 2023-08-17 12:00 | 36.84 Gwei  | 0.0058 Gwei      | 6.35e3       | [link](https://optimistic.etherscan.io/tx/0x7eface13f838d72a43d807b97bbd444bbe71bba75ef8dcc061ec5bff27cd3d30) |\n|                  |             |                  |              |                                                                                                               |\n\nIt will cause users' orders been held up to some hours in 2 ways:\nLet's say we set ````buffer```` according ````Ratio = 2e8```` and plus up to ````100%```` intended reward for keepers, which means the system can only work well while ````Ratio```` is during ````(2e8, 4e8)````.\nSo, in ````2023-08-27 02:00 ~ 04:00```` the system works, but in most cases, the system doesn't work such as\n(1) in ````2023-08-22 02:00 ~ 04:00````, the ````Ratio```` is too high, keepers would suffer loss which might lead them to stop pushing price and users' orders are held.\n(2) in ````2023-08-17 10:00 ~ 12:00````, the ````Ratio```` is too low, keepers earn too much reward, which will trigger the following protection, then no new price can be pushed to chain, all users' orders are held entirely.\n```solidity\nFile: packages\\perennial-oracle\\contracts\\OracleFactory.sol\n93:     function claim(UFixed6 amount) external {\n94:         if (amount.gt(maxClaim)) revert OracleFactoryClaimTooLargeError();\n...\n97:     }\n\n```\n\nTo be emphasized:\n1. Regardless of how we set ````buffer````, it can only work in a extreme narrow ````Ratio```` range as compared to ````(e1, e9)````.\n2. Just in the past 2 weeks, we can easily find more examples like the above ones that would block users' orders for up to 2 hours. It's almost ````100%```` sure this bug would be repeatedly triggered during the long lifetime of the protocol.\n3. As a perpetual exchange APP, users' orders are held up to some hours, especially in the above ````case (2)````, the service is stopped entirely, users' financial losses are foreseeable, the impact is high. \n\nHence, the issue is with both ````high```` probability of occurrence and ````high```` impact, undoubtedly should be a ````high```` issue.\n\n**141345**\n\nYes the fee ratio could vary across a wide span. Extreme high L1 gas fee is intermittent, and will repeat.\nHowever, the protocol can set some fix buffer at 90% percentile of the L1/L2 fee ratio (maybe at e8 level), then the loss will only emerge in some certain scenarios.\n\nStill seems medium due to conditional loss.\n\n**ydspa**\n\n> Yes the fee ratio could vary across a wide span. Extreme high L1 gas fee is intermittent, and will repeat. However, the protocol can set some fix buffer at 90% percentile of the L1/L2 fee ratio (maybe at e8 level), then the loss will only emerge in some certain scenarios.\n> \n> Still seems medium due to conditional loss.\n\n(1）I'm convinced that you can't find a ````buffer```` that works at 90% percentile, it is even hard to work at 50%, you can set buffer with a fixed Ratio plus some intended reward such as 100% (in perennial testcase, it's only 50%), then verify data in the past 1 year\n\n(2) conditional loss of ````1 %```` probability  VS ````99%```` probability are not the same thing, i think the later should be treated as ````unconditional ````.\n\n\n\n\n**141345**\n\nEven the distribution is Pareto distribution (power law), percentile still works. 50%, 90% can be found.\n\n**ydspa**\n\n> Even the distribution is Pareto distribution (power law), percentile still works. 50%, 90% can be found.\n\nGive your specific parameters please\n\n**141345**\n\n> you can't find a `buffer` that works at 90% percentile, it is even hard to work at 50%\n\npercentile always can be found, such as medium number(50%).\n\nOn the opposite, mean value could be hard to find, those extreme high gas fee can make mean not converge.\n\n\n\n\n**ydspa**\n\nMore proof: if we set buffer according ````e8```` level as recommended above, then we can find lots of examples the actual ````Ratio```` falls below ````e6```` which keepers would earn too much rewards (10,000% level) to trigger system protection to block price submission.\n\nThe instances are all from the past one month, and sample interval is 1 hour, that's mean, averagely speaking, the system will be blocked for about 127 hours (5+ days) in one month if we set buffer according ````e8```` level.\n```solidity\nindex  blockHeight\n0 108995426\n1 108952226\n2 108865826\n3 108864026\n4 108862226\n5 108860426\n6 108822626\n7 108820826\n8 108819026\n9 108817226\n10 108815426\n11 108813626\n12 108811826\n13 108810026\n14 108808226\n15 108806426\n16 108804626\n17 108802826\n18 108801026\n19 108799226\n20 108604826\n21 108570626\n22 108504026\n23 108471626\n24 108376226\n25 108360026\n26 108358226\n27 108356426\n28 108345626\n29 108318626\n30 108311426\n31 108309626\n32 108298826\n33 108297026\n34 108295226\n35 108293426\n36 108291626\n37 108289826\n38 108288026\n39 108286226\n40 108284426\n41 108268226\n42 108266426\n43 108264626\n44 108262826\n45 108261026\n46 108259226\n47 108257426\n48 108255626\n49 108253826\n50 108252026\n51 108250226\n52 108248426\n53 108246626\n54 108244826\n55 108243026\n56 108241226\n57 108239426\n58 108237626\n59 108235826\n60 108234026\n61 108232226\n62 108230426\n63 108223226\n64 108221426\n65 108219626\n66 108217826\n67 108216026\n68 108214226\n69 108212426\n70 108210626\n71 108208826\n72 108207026\n73 108205226\n74 108203426\n75 108201626\n76 108079226\n77 107958626\n78 107953226\n79 107951426\n80 107949626\n81 107947826\n82 107946026\n83 107944226\n84 107942426\n85 107940626\n86 107938826\n87 107937026\n88 107935226\n89 107933426\n90 107931626\n91 107929826\n92 107928026\n93 107926226\n94 107924426\n95 107922626\n96 107920826\n97 107919026\n98 107917226\n99 107915426\n100 107913626\n101 107911826\n102 107910026\n103 107908226\n104 107906426\n105 107904626\n106 107902826\n107 107901026\n108 107870426\n109 107780426\n110 107778626\n111 107776826\n112 107775026\n113 107773226\n114 107771426\n115 107769626\n116 107767826\n117 107742626\n118 107740826\n119 107739026\n120 107737226\n121 107735426\n122 107733626\n123 107731826\n124 107730026\n125 107728226\n126 107726426\n```\n\n\n**141345**\n\nThe main point is, there is some parameter, considering the trade off, can balance the loss and overpayment. e8 is just an example. \n\n\n\n**ydspa**\n\n> The main point is, there is some parameter, considering the trade off, can balance the loss and overpayment. e8 is just an example.\n\nWhat my meaning is the parameter doesn't exist at all, mathematically speaking, ````L1Price```` and ````L2Price```` are ````enough independent````, we can't calculate the following result by only ````L2Price````\n```solidity\nOptimism Transaction Fee = [ Fee Scalar * L1 Gas Price * (Calldata + Fixed Overhead) ] + [ L2 Gas Price * L2 Gas Used ]\n```\nreference: https://dune.com/haddis3/optimism-fee-calculator\n\nThis is why no matter we set ````buffer```` according ````e1````, ````e2````, ..., ````e9```` or any other value, the issue would be repeatedly triggered. So, actually it's a ````unconditional```` issue.\n\n**ydspa**\n\n> > you can't find a `buffer` that works at 90% percentile, it is even hard to work at 50%\n> \n> percentile always can be found, such as medium number(50%).\n> \n> On the opposite, mean value could be hard to find, those extreme high gas fee can make mean not converge.\n\nHere is a mistake in thoughts,  set ````buffer```` according the number of 90% percentile, not means the setting will work from 0% percentile to 90% percentile, actually it might only work for ````(85%, 95%)````.\n\n\n\n**141345**\n\n0.001, 0.02, 0.3, 4, 5, 6, 7, 8, 9, 10000.\n\nFor this skewed distribution, 90% percentile is 9.\nWhy only work for around 9?\n\n**ydspa**\n\n> 0.001, 0.02, 0.3, 4, 5, 6, 7, 8, 9, 10000.\n> \n> For this skewed distribution, 90% percentile is 9. Why only work for around 9?\nLet's say, at ````e9````, keeper get $1, then at ````e8```` it becomes $10, at ````e7```` it would be $100...\n\n\n\n**141345**\n\n> repeatedly triggered\n\nMy understanding, something like, it could be triggered 10-20% of the time in a certain time span, such as 1 month, 1 week. \n\nIt still falls into the category with condition:\nPer [criteria](https://docs.sherlock.xyz/audits/judging/judging)\n> The attack path is possible with assumptions that either mimic on-chain conditions or reflect conditions that have a reasonable chance of becoming true in the future.\n\n\n\n**ydspa**\n\n> \n\nMy understanding about the probability of issue occurrence, which i learned when i work for other audit firms, are like this:\n\nIf the issue will occur even ````once```` with ````high probability````  in a reasonable period such as 3 months, then it's high probability.\n\nIt's far away from the thought that only if a issue will keep occurring in most the time, let's say, in 2 of the 3 months, then it's high probability.\n\nSo, in my opinion, if a issue might occur hundred times a month, it's obviously a ````high probability````. And with ````high probability```` and ````high impact```` issue, we mark it as ````high````.\n\n**Actually, we can think the situation much more simple:**\n\n````If an exchange's service would be suspended randomly sum up to average 7 days per month, is it critical, high or medium?````\n\nI will choose critical though Sherlock doesn't have this level.\n\n**hrishibhat**\n\nResult:\nHigh\nUnique\nAfter considering further points raised by Watson given the frequency of the condition mentioned in the example above. The impact is not just about the loss for the keeper but also keepers not submitting txs and executing orders. This can be looked at as a severe issue overall. Considering this issue a valid high. \n\n\n**sherlock-admin2**\n\nEscalations have been resolved successfully!\n\nEscalation status:\n- [ydspa](https://github.com/sherlock-audit/2023-07-perennial-judging/issues/91/#issuecomment-1693709652): accepted\n\n",
  "Impact": "HIGH",
  "Source": "https://app.sherlock.xyz/audits/contests/106",
  "Code": [
    {
      "filename": "perennial-v2/packages/perennial-oracle/test/integration/pyth/PythOracle.test.ts",
      "content": "import { SignerWithAddress } from '@nomiclabs/hardhat-ethers/signers'\nimport { expect } from 'chai'\nimport { utils } from 'ethers'\nimport HRE from 'hardhat'\nimport { time } from '../../../../common/testutil'\nimport { impersonateWithBalance } from '../../../../common/testutil/impersonate'\nimport { currentBlockTimestamp } from '../../../../common/testutil/time'\nimport {\n  IERC20Metadata,\n  IERC20Metadata__factory,\n  Oracle,\n  Oracle__factory,\n  OracleFactory,\n  OracleFactory__factory,\n  PythFactory,\n  PythFactory__factory,\n  PythOracle,\n  PythOracle__factory,\n} from '../../../types/generated'\nimport { parse6decimal } from '../../../../common/testutil/types'\n\nconst { config, ethers } = HRE\n\nconst PYTH_ADDRESS = '0x4305FB66699C3B2702D4d05CF36551390A4c69C6'\nconst PYTH_ETH_USD_PRICE_FEED = '0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace'\nconst DSU_ADDRESS = '0x605D26FBd5be761089281d5cec2Ce86eeA667109'\nconst CHAINLINK_ETH_USD_FEED = '0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419'\nconst DSU_HOLDER = '0x2d264EBDb6632A06A1726193D4d37FeF1E5dbDcd'\n\nconst STARTING_TIME = 1686198973\n\n// This VAA has timestamp 1686198987 (STARTING_TIME + 14)\nconst VAA =\n  '0x01000000030d0046d9570837d4d2cfcc50fd3346bf18df10179011a1e125e27467bb47bc26f8ce194ed59b48793f4dec9dc919f2e22d43e33fe6ac263980da08f502b894e0fe6f00026a8d75df8f46b144e48ebf6bd6a63267e90dafe353021bbecb9909b0bef0434e56f696870e41ce16b9b8b40c22548815c5fe157915cd08366cb439c5eb51029001040c1775df612c74d4e18da4daa0f42b8953d92340aadf757b6b6ee1e549d1ddfe0115628a360168a23a05684afa5389dd75c431eb5228aaa528de450aae38a50f01084aeacdb58103612ab202ac887d53dc14cd10c4e7d788f95685e0944fb919f8ec64b5cdaa4ede600a9f89ed9aaa3be86facac6ede2ed08760101f6c5c23ce6b29010a2847bd95a0dd2d14302ee732f8f3547ea7e1bfcc9f258ab07d33ca9c62fc837621e8a7dcdb41b06db6f8e768e7e5510f3954029fcdf6e8f3d6b4072da73b51ae010b3a693388722a579f8e7ce44bceb0fac79a4dffbd1076b99a79c55286cc2cf28f2feda95aaf1823f6da2922d9f675619931107bd0538e9dbd53025463a95f2b7b010c732680bb2ba4843b67ba4c493d29cbfe737729cb872aec4ac9b8d83eb0fec898556d02bdeae8995870dc6e75187feacc9b9f714ddd9d97ba5a5abbe07d8884f2010debe8a41fe1715b27fbf2aba19e9564bb4e0bde1fc29412c69347950d216a201130e301f43a5aeec8e7464c9839a114e22efe65d49128b4908b9fa618476cc519010e33495ea1a8df32bc3e7e6f353a4d0371e8d5538e33e354e56784e2877f3765ef5e774abb0c50973686f8236adf5979225ff6f6c68ed942197f40c4fed59331bc010fead2505d4be9161ab5a8da9ed0718afd1ddf0b7905db57997a1ed4741d9d326840e193b84e115eba6256ed910e12e10f68c4563b6abaae211eaac5c0416d1f9601108eddcab6c9952dc0da91900a35821ef75818a5f3898721fd05ff708597c19d5e573f2b63674989365ca9fee0dd660566afaec135230d978e66ee4106c263b124011164788fde3bcf11e6773308a3732a0f0bd73b6876789c2b01f2bbaf84473be6ec2b7a3884d117adc625cbf48710c238d9c122a5f64f283685d9c66f3656d79d4d001247f246ba17092100f8bfc1e93822ad3d07561697ac90d4ebf3d371fce17e399246b18f85b52f74157240cdf16da4bde72146cf0cb976c39a2d6958d7b55773f70064815acc00000000001af8cd23c2ab91237730770bbea08d61005cdda0984348f3f6eecb559638c0bba0000000001b8413740150325748000300010001020005009d04028fba493a357ecde648d51375a445ce1cb9681da1ea11e562b53522a5d3877f981f906d7cfe93f618804f1de89e0199ead306edc022d3230b3e8305f391b00000002aa3fa23ae00000000117b5092fffffff80000002a9cdd1528000000000f4ab712010000000a0000000c0000000064815acc0000000064815acb0000000064815acb0000002aa3fa23ae00000000117b50920000000064815acbe6c020c1a15366b779a8c870e065023657c88c82b82d58a9fe856896a4034b0415ecddd26d49e1a8f1de9376ebebc03916ede873447c1255d2d5891b92ce57170000002c5ffd594000000000086bfba4fffffff80000002c55aaa600000000000a73c7010100000007000000080000000064815acc0000000064815acb0000000064815acb0000002c5ffd594000000000086bfba40000000064815acbc67940be40e0cc7ffaa1acb08ee3fab30955a197da1ec297ab133d4d43d86ee6ff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace0000002acc544cc90000000006747a77fffffff80000002ac4a4eba8000000000456d9f30100000017000000200000000064815acc0000000064815acb0000000064815acb0000002acc544cc90000000006747a770000000064815acb8d7c0971128e8a4764e757dedb32243ed799571706af3a68ab6a75479ea524ff846ae1bdb6300b817cee5fdee2a6da192775030db5615b94a465f53bd40850b50000002ac880a3200000000010e67139fffffff80000002abc130ec0000000001b3bcc6401000000090000000a0000000064815acc0000000064815acb0000000064815acb0000002ac880a3200000000010e671390000000064815acb543b71a4c292744d3fcf814a2ccda6f7c00f283d457f83aa73c41e9defae034ba0255134973f4fdf2f8f7808354274a3b1ebc6ee438be898d045e8b56ba1fe1300000000000000000000000000000000fffffff8000000000000000000000000000000000000000000000000080000000064815acc0000000064815aca0000000000000000000000000000000000000000000000000000000000000000'\n\n// This VAA has timestamp 1686198989 (STARTING_TIME + 16)\nconst OTHER_VAA =\n  '0x01000000030d00a87bb4f45a7ba5924b7f528f1563dcc3be57a88e75b77ea58c5e492e768b71ce36fc3f0c5399afd2c53bd9b6ae02dee259b1d85d511d9ea1cee3a3ba8a2f9b1e010200369aebb31fcedfc625307802472f751fd030d1386e23d65a31ab6445fca14819fdc142b80a81e5d3d6977b888338a17e6e757d83062e03df2383b04d3693fe01041acc2688a58c12b4b7ace5796f763c9be31ad70e7bb6b98ccacd5c3ee188511634da6bcb92c5e3c99174d0c1f04c0b0fc9ff22d0a4ba721231f0fbf1439734710006fa15d2b248896c629b5ad8f5be1d367f3eda33f86fe5eaf239fcf5c924fa99eb65fa3a9ccb028ada60a14d83537c9760aa87845de8bf0274d56d4501da39099c000a881c1f94bed5fda4b492606be77b8a1d215b1cefa6a76553214015152828b504735e9cdff068c1c2f16a15c98da2f030f4806d95cda06676bde86a5b2322d402010bf01b66ee9fde5e18892de416b05b3aeaa2b9e7cf4b88a81ebe327881c9ae79a52c6bf6fa0a9a05e095f5b1eb1b2e0510b6654f328da598f059a5075e6da266ef000c66e366f97cb5b6479398c4a90ed3a084558a9b653ef263015a46b4628caa2f1c066173e63c99f1e72fc9fd2e8778580df72ebef36e7bab6ceda71927aa543ae8000d26b1ac6eddf58d4a206558b423b1f6b4c2aa79eef7c9a4a112aacd0f12f3f6f616782ef53f4c5128954835d7c9fa7e8f3a999c1bc4a206e44459bab2f4a97762000ee75540ac332dde0b2396608d8afd45475b25c9a38c19e4a761b601e7419ba049566b0b4a43add83a4873a955ed1a575944ed18cb84af53dde08c90a3e20cb741010f05e8754cdb035a819162f897bfd692652a8959ad9a276901dcde0547d6b45af33395695e8089fe727903b365d54c4db48f79b9c4832245e87f14cbf18daaa05a0010e43cfa7d5f358c054452fa1f769bb2e0b3aca50675af9a37b23bceb894b747020bc045c853bb11be810fc26a3198cd45bdb56f3103b6e4f63cb065118c641d840011adfddcc762849d28586c211cf696a22700a2e509dc8e66d3a83c3532d847967e16c42379ecb0705c85fcf4e98abea9288336366bd7076fab3e3a1a231e16262e0112822e96a61fe31459fd98e6718ac1bc776ee8f0eba68b8e6afbf334e582c692d808b768c91eb03f7329e1680f4224447e47b4da3f1eff401aa71eb6be927f18600164815ace00000000001af8cd23c2ab91237730770bbea08d61005cdda0984348f3f6eecb559638c0bba0000000001b8413a60150325748000300010001020005009d04028fba493a357ecde648d51375a445ce1cb9681da1ea11e562b53522a5d3877f981f906d7cfe93f618804f1de89e0199ead306edc022d3230b3e8305f391b00000002aa3d3fd2d0000000011a17713fffffff80000002a9cde49c0000000000f4b14df010000000a0000000c0000000064815ace0000000064815ace0000000064815acd0000002aa3d3fd2d0000000011a177130000000064815acce6c020c1a15366b779a8c870e065023657c88c82b82d58a9fe856896a4034b0415ecddd26d49e1a8f1de9376ebebc03916ede873447c1255d2d5891b92ce57170000002c5ffd594000000000086bfba4fffffff80000002c55acc4f8000000000a7364600100000007000000080000000064815ace0000000064815acd0000000064815acd0000002c5ffd594000000000086bfba40000000064815acdc67940be40e0cc7ffaa1acb08ee3fab30955a197da1ec297ab133d4d43d86ee6ff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace0000002acc918fe7000000000618b2d9fffffff80000002ac4a5d9f00000000004570ac20100000017000000200000000064815ace0000000064815acd0000000064815acd0000002acc7758c0000000000632ea000000000064815acd8d7c0971128e8a4764e757dedb32243ed799571706af3a68ab6a75479ea524ff846ae1bdb6300b817cee5fdee2a6da192775030db5615b94a465f53bd40850b50000002ac880a3200000000010e67139fffffff80000002abc15b288000000001b39428201000000090000000a0000000064815ace0000000064815acd0000000064815acd0000002ac880a3200000000010e671390000000064815acd543b71a4c292744d3fcf814a2ccda6f7c00f283d457f83aa73c41e9defae034ba0255134973f4fdf2f8f7808354274a3b1ebc6ee438be898d045e8b56ba1fe1300000000000000000000000000000000fffffff8000000000000000000000000000000000000000000000000080000000064815ace0000000064815ace0000000000000000000000000000000000000000000000000000000000000000'\n\n// This VAA has timestamp 1686199046 (STARTING_TIME + 73)\nconst VAA_AFTER_EXPIRATION =\n  '0x01000000030d00bfb661157be7ad89a7e9c0f814fd991111260a063da76b9d6feceb23805d293031cae0d90acedc6272261b2b342d8528026bc2c4ca2bee14d2a9c37f54f5ff430101182784762cbbb5b288b9bce0e4809130ff6d0c32e54a43b83ca3df9429fb5f1c6954520ee536def601e4ae2cc96904d6255fe3b0a2680b04002a6215f8b7d05f0102c5e5bb34bc0e0a29050d528add872a84fb0dedfd87a7b212751efad4db9fdb8a268d6d652edd42977b45efa4b113cf64ba2cd574f8421829bf488b70c7708e5401048525c3dbe7e9982e73b57d1fb25f844ca89d5b0b70081331b494a7539bafd4081d58ef70e60b45e1aba5abf2aabfcb8e6ed5f98f0500e9f2bdd49828b4998b72010640c2b4fe8b742460244bb8727e73be77cde68e138793f35b5e4a0ceb244b9b583f2676c1b62bc00757f310fc15d7f89ddabe0ff2cfcf069e6a88fa557fe0abee0109c73d8eb1b3dcafda9b63cb3567aaa6ed5d08f945143087ce08b010d98985f2e372405c189b13e34dc263bdbf2e65907703daaf0c7952f8282c5e6f173dc7ed93010a99d8e194e2b3e7541a3321d1f130ef43cfeca479d35450fe2fdfb830c983b6152c61aa15a625bd25159202b8819dd49ac772af9403a1839897fce2629513aa1c000b7d28b5197c734b97beaa120bfe60347ddfc0daa0201435ec157cab6fe3f606fd573dbd0adf70c087b65f7ac3c8a635248d0a2af594ddf3ca8efc22aa68472b9c010d6cb1d8e21dc3496c271217a6881a7c0e7889f4d1ce28bcf41a6239c8231b25d33e08aaf3101baedb6967deb7c3463575d3985c7df414180c6b9c1a432afabb25010eb63ac25e0e08b961c4fe09a40d151a9cdefcc6dcd0b9e515e39a51538d9d56002c31a034f0fa2c7074a0b49bd9664085fda7576b88fac9c4d9bfd4e78dcf04f7010f8ac4211c75d9b3b3dd6561ca78a6d0e5b48978999622550e2ee8c96349cbe1a15297d9821a636e7243035a8109c0e1e8837f685fd8a543551d861b8d206bcd7100118f9cebf15e664f2d61fcdfb513f73063c98631cea238441193f3c530978c762e2dbbb34cb506339acf0e307dba791163e423777f7a6630041fa194ec361b519a011226603dae57d5f0830366bc2de410bca394104448bcbd265786d1778906a20a71413e7789c1e023f0e9aa801c1c3ea88577c01484747030cc14e019f96b3b4b8c0064815b0600000000001af8cd23c2ab91237730770bbea08d61005cdda0984348f3f6eecb559638c0bba0000000001b84185b0150325748000300010001020005009d04028fba493a357ecde648d51375a445ce1cb9681da1ea11e562b53522a5d3877f981f906d7cfe93f618804f1de89e0199ead306edc022d3230b3e8305f391b00000002aa3a2542c000000000cff29d4fffffff80000002a9cfc4970000000000f4fed45010000000a0000000c0000000064815b060000000064815b060000000064815b050000002aa0efd01e000000000f1906450000000064815b05e6c020c1a15366b779a8c870e065023657c88c82b82d58a9fe856896a4034b0415ecddd26d49e1a8f1de9376ebebc03916ede873447c1255d2d5891b92ce57170000002c59c2ce20000000000929ebaafffffff80000002c55dbcff0000000000a6b691c0100000007000000080000000064815b060000000064815b060000000064815b050000002c59c2ce20000000000929ebaa0000000064815b05c67940be40e0cc7ffaa1acb08ee3fab30955a197da1ec297ab133d4d43d86ee6ff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace0000002ac7759bc000000000052b5730fffffff80000002ac4bd9810000000000459d2670100000017000000200000000064815b060000000064815b060000000064815b050000002ac7759bc00000000003a9eecc0000000064815b058d7c0971128e8a4764e757dedb32243ed799571706af3a68ab6a75479ea524ff846ae1bdb6300b817cee5fdee2a6da192775030db5615b94a465f53bd40850b50000002ac114eb000000000011e1b38ffffffff80000002abc59e390000000001aefec2201000000090000000a0000000064815b060000000064815b050000000064815b050000002ac114eb000000000011e1b38f0000000064815b05543b71a4c292744d3fcf814a2ccda6f7c00f283d457f83aa73c41e9defae034ba0255134973f4fdf2f8f7808354274a3b1ebc6ee438be898d045e8b56ba1fe1300000000000000000000000000000000fffffff8000000000000000000000000000000000000000000000000080000000064815b060000000064815b020000000000000000000000000000000000000000000000000000000000000000'\n\n// This VAA has timestamp 1686199146 (STARTING_TIME + 173)\nconst VAA_WAY_AFTER_EXPIRATION =\n  '0x01000000030d00759894dd446d5bbb720d73f32fea0c728cfecc474369fd46de94c1ee3d4f6a326eafdaa907c8b4c2fd027d7047af501103f513d9ed7cbde0a404516c7fa866c80001a2c0276919ba58edea3f3f395fbeaac7a8c3e0a8688f9e5d5c925396b503e90b4e652bd85e8672878a0960ff65515226651f12ad49721a0665f0bb2e5c28fb0c0102dde9e7d36aaef1a7528bed0f95f7d52d6ca33169afee85604669115454b90bbf36eb6de59decdcc4517cdb849efaef0626c83b318efbdf34b5373fd9e2a7c7f6000479d697d129cd515036eb19dfc17e08dd6628073204f5177042636682f9c268350abb39ee46dd119dd3dca48324f43bd72e8be84afa6ccde91c5d7d76ef7dd56e010ac6c6d3d4d7ed37747282478a628a7208e45aa609323ee54af0ab974755e3bdcc1e0fc45de741a3f629591a8f465e99de5b0670943bb1e74e7661d668fae491a5010b13f2c4cd06b86ad65495ab9b16b1ba8605a4a30207ab65a36a7e207f576983c50b3a06351c4acacac5d0b6c6491a575bc265ce4f58cd882fa2df4e1179730830000cfb174a0ce4426bff92f9b98387ec915f2f799ede09e75ccf916ddfa2e6b9da162fdc215ee99b02885468c23a36e66e2ce4265d222e0435cdc464239406021605010dc6e6437bd2395449d08890ee69b20451ae2b8b9ef33d5589c031d00164a824aa749dc420f1d7404441c79be128bf5cab830404b6efa2210d1a823a18479bf342000eeebc6b5b1ae0d9bec0b78e629b8548bcc37ec455bb99f6d2d312c37bbccc043716860daa6c998614ca9d67a3a6336b5da352d7dfd4b99a44034df0e4c8d90bd7000f363aa0eaa28bf27f5e7faab756500a57fb5a2b2eceea02b574586d12b73504fc035f863a497d8a3ed23e2383ca05272df7f1dd01989fc0113b9aef9eeef371990010ad23fcf0262170cb429491de2d34e2591733eee440d4067657e233a5c83dcf647d1b8c9bccd06bde731bad3726957d067422ff327f71cab36402e8f677268cf100119f33cd0d885b9ae579753c8c24b2f2a322053588c1e0b081eaa51341f7bda7df252330808b0d3a042da1a4cc45a6627cf61127cc153dfd47f7197cf97ef52c7f0112ac663714bf20c6d0dcbd53f7cb816b3dd3d730301605a0e710241c663e0023933b64337001cb6faad9c1f7b368af993a7004dace776de4400c2e27dfd33cb83f0064815b6a00000000001af8cd23c2ab91237730770bbea08d61005cdda0984348f3f6eecb559638c0bba0000000001b8420db0150325748000300010001020005009d04028fba493a357ecde648d51375a445ce1cb9681da1ea11e562b53522a5d3877f981f906d7cfe93f618804f1de89e0199ead306edc022d3230b3e8305f391b00000002aa2158047000000000df3561dfffffff80000002a9d293958000000000f470500010000000a0000000c0000000064815b6a0000000064815b6a0000000064815b690000002aa2063e07000000000e02985d0000000064815b69e6c020c1a15366b779a8c870e065023657c88c82b82d58a9fe856896a4034b0415ecddd26d49e1a8f1de9376ebebc03916ede873447c1255d2d5891b92ce57170000002c59e152a00000000009c186cafffffff80000002c56052dc8000000000a631ce80100000007000000080000000064815b6a0000000064815b6a0000000064815b690000002c59e152a00000000009c186ca0000000064815b69c67940be40e0cc7ffaa1acb08ee3fab30955a197da1ec297ab133d4d43d86ee6ff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace0000002ac802c09000000000060e60dbfffffff80000002ac4d3008800000000045ee4460100000018000000200000000064815b6a0000000064815b6a0000000064815b690000002ac802c09000000000060e60db0000000064815b698d7c0971128e8a4764e757dedb32243ed799571706af3a68ab6a75479ea524ff846ae1bdb6300b817cee5fdee2a6da192775030db5615b94a465f53bd40850b50000002abfdc1ce0000000001a634b48fffffff80000002abc79db28000000001abdd5ca01000000090000000a0000000064815b6a0000000064815b6a0000000064815b690000002abfdc1ce0000000001a634b480000000064815b69543b71a4c292744d3fcf814a2ccda6f7c00f283d457f83aa73c41e9defae034ba0255134973f4fdf2f8f7808354274a3b1ebc6ee438be898d045e8b56ba1fe1300000000000000000000000000000000fffffff8000000000000000000000000000000000000000000000000080000000064815b6a0000000064815b690000000000000000000000000000000000000000000000000000000000000000'\n\ndescribe('PythOracle', () => {\n  let owner: SignerWithAddress\n  let user: SignerWithAddress\n  let oracle: Oracle\n  let pythOracle: PythOracle\n  let pythOracleFactory: PythFactory\n  let oracleFactory: OracleFactory\n  let dsu: IERC20Metadata\n  let oracleSigner: SignerWithAddress\n\n  beforeEach(async () => {\n    await time.reset()\n    ;[owner, user] = await ethers.getSigners()\n\n    dsu = IERC20Metadata__factory.connect(DSU_ADDRESS, owner)\n\n    const oracleImpl = await new Oracle__factory(owner).deploy()\n    oracleFactory = await new OracleFactory__factory(owner).deploy(oracleImpl.address)\n    await oracleFactory.initialize(dsu.address)\n    await oracleFactory.updateMaxClaim(parse6decimal('10'))\n\n    const pythOracleImpl = await new PythOracle__factory(owner).deploy(PYTH_ADDRESS)\n    pythOracleFactory = await new PythFactory__factory(owner).deploy(\n      pythOracleImpl.address,\n      CHAINLINK_ETH_USD_FEED,\n      dsu.address,\n    )\n    await pythOracleFactory.initialize(oracleFactory.address)\n    await oracleFactory.register(pythOracleFactory.address)\n    await pythOracleFactory.authorize(oracleFactory.address)\n\n    pythOracle = PythOracle__factory.connect(await pythOracleFactory.callStatic.create(PYTH_ETH_USD_PRICE_FEED), owner)\n    await pythOracleFactory.create(PYTH_ETH_USD_PRICE_FEED)\n\n    oracle = Oracle__factory.connect(\n      await oracleFactory.callStatic.create(PYTH_ETH_USD_PRICE_FEED, pythOracleFactory.address),\n      owner,\n    )\n    await oracleFactory.create(PYTH_ETH_USD_PRICE_FEED, pythOracleFactory.address)\n\n    oracleSigner = await impersonateWithBalance(oracle.address, utils.parseEther('10'))\n\n    const dsuHolder = await impersonateWithBalance(DSU_HOLDER, utils.parseEther('10'))\n    await dsu.connect(dsuHolder).transfer(oracleFactory.address, utils.parseEther('100000'))\n\n    await time.increaseTo(STARTING_TIME - 1)\n    // block.timestamp of the next call will be STARTING_TIME (1686198973)\n  })\n\n  describe('#initialize', async () => {\n    it('only initializes with a valid priceId', async () => {\n      const invalidPriceId = '0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0acd'\n      const oracle = await new PythOracle__factory(owner).deploy(PYTH_ADDRESS)\n      await expect(oracle.initialize(invalidPriceId, CHAINLINK_ETH_USD_FEED, dsu.address))\n        .to.be.revertedWithCustomError(oracle, 'PythOracleInvalidPriceIdError')\n        .withArgs(invalidPriceId)\n    })\n  })\n\n  describe('#commitRequested', async () => {\n    it('commits successfully and incentivizes the keeper', async () => {\n      const originalDSUBalance = await dsu.callStatic.balanceOf(user.address)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      // Base fee isn't working properly in coverage, so we need to set it manually\n      await ethers.provider.send('hardhat_setNextBlockBaseFeePerGas', ['0x5F5E100'])\n      await pythOracle.connect(user).commitRequested(0, VAA, {\n        value: 1,\n        maxFeePerGas: 100000000,\n      })\n      const newDSUBalance = await dsu.callStatic.balanceOf(user.address)\n\n      expect(newDSUBalance.sub(originalDSUBalance)).to.be.within(\n        ethers.utils.parseEther('0.10'),\n        utils.parseEther('0.11'),\n      )\n    })\n\n    it('does not allow committing versions with out of order VAA publish times', async () => {\n      await time.increase(1)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(oracleSigner).request(user.address)\n\n      await pythOracle.connect(user).commitRequested(0, OTHER_VAA, {\n        value: 1,\n      })\n\n      await expect(\n        pythOracle.connect(user).commitRequested(1, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleNonIncreasingPublishTimes')\n    })\n\n    it('fails to commit if update fee is not provided', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await expect(pythOracle.connect(user).commitRequested(0, VAA)).to.revertedWithoutReason()\n    })\n\n    it('does not commit a version that has already been committed', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commitRequested(0, VAA, {\n        value: 1,\n      })\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await expect(\n        pythOracle.connect(user).commitRequested(0, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleVersionIndexTooLowError')\n    })\n\n    it('cannot commit if no version has been requested', async () => {\n      await expect(\n        pythOracle.connect(user).commitRequested(0, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleNoNewVersionToCommitError')\n    })\n\n    it('rejects invalid update data', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await expect(\n        pythOracle.connect(user).commitRequested(0, '0x00', {\n          value: 1,\n        }),\n      ).to.reverted\n    })\n\n    it('does not skip a version if the grace period has not expired', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await expect(\n        pythOracle.connect(user).commitRequested(1, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleGracePeriodHasNotExpiredError')\n    })\n\n    it('does not skip a version if the update is valid for the previous version', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await time.increase(100)\n      await expect(\n        pythOracle.connect(user).commitRequested(1, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleUpdateValidForPreviousVersionError')\n    })\n\n    it('skips a version if the grace period has expired', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await time.increase(59)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commitRequested(1, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n    })\n\n    it('does not allow committing a version earlier than the latest committed version', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await time.increase(59)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commitRequested(1, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await expect(\n        pythOracle.connect(user).commitRequested(0, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleVersionIndexTooLowError')\n    })\n  })\n\n  describe('#commit', async () => {\n    it('commits unincentivized if there are no requested or committed versions, does not incentivize keeper, updates latest', async () => {\n      const originalDSUBalance = await dsu.callStatic.balanceOf(user.address)\n      await pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n        value: 1,\n      })\n      const version = await pythOracle.connect(user).at(STARTING_TIME)\n      expect(version.valid).to.be.true\n      expect(version.price).to.equal('18381670317700000000000000')\n\n      // Didn't incentivize keeper\n      const newDSUBalance = await dsu.callStatic.balanceOf(user.address)\n      expect(newDSUBalance.sub(originalDSUBalance)).to.equal(0)\n\n      const latestVersion = await pythOracle.connect(user).latest()\n      expect(latestVersion).to.deep.equal(version)\n    })\n\n    it('fails to commit if update fee is not provided', async () => {\n      await expect(pythOracle.connect(user).commit(STARTING_TIME, VAA)).to.revertedWithoutReason()\n    })\n\n    it('can commit if there are requested versions but no committed versions', async () => {\n      await time.increase(30)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n        value: 1,\n      })\n    })\n\n    it('can commit if there are committed versions but no requested versions', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n        value: 1,\n      })\n      await pythOracle.connect(user).commit(STARTING_TIME + 60, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n    })\n\n    it('can commit if there are committed versions and requested versions', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commit(STARTING_TIME, VAA, { value: 1 })\n      await time.increaseTo(1686199133)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      const secondRequestedVersion = await currentBlockTimestamp()\n      const nonRequestedOracleVersion = STARTING_TIME + 60\n      await pythOracle.connect(user).commit(nonRequestedOracleVersion, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n      expect((await pythOracle.connect(user).latest()).timestamp).to.equal(nonRequestedOracleVersion)\n\n      await pythOracle.connect(user).commit(secondRequestedVersion, VAA_WAY_AFTER_EXPIRATION, {\n        value: 1,\n      })\n      expect((await pythOracle.connect(user).latest()).timestamp).to.equal(secondRequestedVersion)\n    })\n\n    it('cannot commit invalid VAAs for the oracle version', async () => {\n      await expect(\n        pythOracle.connect(user).commit(STARTING_TIME - 60, VAA, {\n          value: 1,\n        }),\n      ).to.reverted\n    })\n\n    it('must be more recent than the most recently committed version', async () => {\n      await time.increase(60)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commit(STARTING_TIME + 60, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n\n      await expect(\n        pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleVersionTooOldError')\n    })\n\n    it('tries to commitRequested if more recent than the next requested version to commit', async () => {\n      const originalDSUBalance = await dsu.callStatic.balanceOf(user.address)\n      await pythOracle.connect(oracleSigner).request(user.address)\n      // Base fee isn't working properly in coverage, so we need to set it manually\n      await ethers.provider.send('hardhat_setNextBlockBaseFeePerGas', ['0x5F5E100'])\n      await pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n        value: 1,\n        gasPrice: 100000000,\n      })\n      const newDSUBalance = await dsu.callStatic.balanceOf(user.address)\n\n      expect(newDSUBalance.sub(originalDSUBalance)).to.be.within(\n        ethers.utils.parseEther('0.10'),\n        ethers.utils.parseEther('0.11'),\n      )\n    })\n\n    it('can commit multiple non-requested versions, as long as they are in order', async () => {\n      await pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n        value: 1,\n      })\n      await pythOracle.connect(user).commit(STARTING_TIME + 60, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n    })\n\n    it('fails to commit non-requested version out of order', async () => {\n      await pythOracle.connect(user).commit(STARTING_TIME + 60, VAA_AFTER_EXPIRATION, {\n        value: 1,\n      })\n\n      await expect(\n        pythOracle.connect(user).commit(STARTING_TIME, VAA, {\n          value: 1,\n        }),\n      ).to.revertedWithCustomError(pythOracle, 'PythOracleVersionTooOldError')\n    })\n  })\n\n  describe('#status', async () => {\n    it('returns the correct versions', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commitRequested(0, VAA, {\n        value: 1,\n      })\n      const [latestVersion, currentVersion] = await pythOracle.status()\n      expect(latestVersion.valid).to.be.true\n      expect(latestVersion.price).to.equal('18381670317700000000000000')\n      expect(currentVersion).to.equal(await currentBlockTimestamp())\n    })\n\n    it('returns empty versions if no version has ever been committed', async () => {\n      const [latestVersion, currentVersion] = await pythOracle.status()\n      expect(currentVersion).to.equal(await currentBlockTimestamp())\n      expect(latestVersion.timestamp).to.equal(0)\n      expect(latestVersion.price).to.equal(0)\n      expect(latestVersion.valid).to.be.false\n    })\n  })\n\n  describe('#request', async () => {\n    it('can request a version', async () => {\n      // No requested versions\n      await expect(pythOracle.callStatic.versionList(0)).to.be.reverted\n      await pythOracle.connect(oracleSigner).request(user.address)\n      // Now there is exactly one requested version\n      expect(await pythOracle.callStatic.versionList(0)).to.equal(STARTING_TIME)\n      await expect(pythOracle.callStatic.versionList(1)).to.be.reverted\n    })\n\n    it('does not allow unauthorized users to request', async () => {\n      await expect(pythOracle.connect(user).request(user.address)).to.be.reverted\n    })\n  })\n\n  describe('#latest', async () => {\n    it('returns the latest version', async () => {\n      await pythOracle.connect(oracleSigner).request(user.address)\n      await pythOracle.connect(user).commitRequested(0, VAA, {\n        value: 1,\n      })\n      const latestVersion = await pythOracle.connect(user).latest()\n      expect(latestVersion.valid).to.be.true\n      expect(latestVersion.price).to.equal('18381670317700000000000000')\n    })\n\n    it('returns empty version if no version has ever been committed', async () => {\n      const latestVersion = await pythOracle.connect(user).latest()\n      expect(latestVersion.timestamp).to.equal(0)\n      expect(latestVersion.price).to.equal(0)\n      expect(latestVersion.valid).to.be.false\n    })\n  })\n\n  describe('#current', async () => {\n    it('returns the current timestamp', async () => {\n      expect(await pythOracle.connect(user).current()).to.equal(await currentBlockTimestamp())\n    })\n\n    it('returns the current timestamp w/ granularity == 0', async () => {\n      await expect(pythOracleFactory.connect(owner).updateGranularity(0)).to.be.revertedWithCustomError(\n        pythOracleFactory,\n        'PythFactoryInvalidGranularityError',\n      )\n    })\n\n    it('returns the current timestamp w/ granularity > MAX', async () => {\n      await expect(pythOracleFactory.connect(owner).updateGranularity(3601)).to.be.revertedWithCustomError(\n        pythOracleFactory,\n        'PythFactoryInvalidGranularityError',\n      )\n      await expect(pythOracleFactory.connect(owner).updateGranularity(3600)).to.be.not.reverted\n    })\n\n    it('returns the current timestamp w/ fresh granularity > 1', async () => {\n      await pythOracleFactory.connect(owner).updateGranularity(10)\n\n      const granularity = await pythOracleFactory.granularity()\n      expect(granularity.latestGranularity).to.equal(1)\n      expect(granularity.currentGranularity).to.equal(10)\n      expect(granularity.effectiveAfter).to.equal(await currentBlockTimestamp())\n\n      expect(await pythOracle.connect(user).current()).to.equal(await currentBlockTimestamp())\n    })\n\n    it('returns the current timestamp w/ settled granularity > 1', async () => {\n      const granularity = await pythOracleFactory.granularity()\n      expect(granularity.latestGranularity).to.equal(0)\n      expect(granularity.currentGranularity).to.equal(1)\n      expect(granularity.effectiveAfter).to.equal(0)\n\n      await pythOracleFactory.connect(owner).updateGranularity(10)\n\n      const granularity2 = await pythOracleFactory.granularity()\n      expect(granularity2.latestGranularity).to.equal(1)\n      expect(granularity2.currentGranularity).to.equal(10)\n      expect(granularity2.effectiveAfter).to.equal(await currentBlockTimestamp())\n\n      await time.increase(1)\n\n      expect(await pythOracle.connect(user).current()).to.equal(Math.ceil((await currentBlockTimestamp()) / 10) * 10)\n    })\n\n    it('returns the current timestamp w/ fresh + fresh granularity > 1', async () => {\n      await pythOracleFactory.connect(owner).updateGranularity(10)\n      // hardhat automatically moves 1 second ahead so we have to do this twice\n      await pythOracleFactory.connect(owner).updateGranularity(100)\n      await expect(pythOracleFactory.connect(owner).updateGranularity(1000)).to.be.revertedWithCustomError(\n        pythOracleFactory,\n        'PythFactoryInvalidGranularityError',\n      )\n    })\n\n    it('returns the current timestamp w/ settled + fresh granularity > 1', async () => {\n      await pythOracleFactory.connect(owner).updateGranularity(10)\n      await time.increase(1)\n\n      await pythOracleFactory.connect(owner).updateGranularity(100)\n      const granularity = await pythOracleFactory.granularity()\n      expect(granularity.latestGranularity).to.equal(10)\n      expect(granularity.currentGranularity).to.equal(100)\n      expect(granularity.effectiveAfter).to.equal(Math.ceil((await currentBlockTimestamp()) / 10) * 10)\n\n      expect(await pythOracle.connect(user).current()).to.equal(Math.ceil((await currentBlockTimestamp()) / 10) * 10)\n    })\n\n    it('returns the current timestamp w/ settled + settled granularity > 1', async () => {\n      await pythOracleFactory.connect(owner).updateGranularit"
    }
  ]
}