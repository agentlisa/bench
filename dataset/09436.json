{
  "Title": "[L-03] Unbounded loops with external calls",
  "Content": "\nThe interface and the function should require a start index and a lenght, so that the index composition can be fetched in batches without running out of gas. If there are thousands of index components (e.g. like the Wilshire 5000 index), the function may revert\n\n1.  File: contracts/BaseIndex.sol (lines [75-81](https://github.com/code-423n4/2022-04-phuture/blob/594459d0865fb6603ba388b53f3f01648f5bb6fb/contracts/BaseIndex.sol#L75-L81))\n\n```solidity\n    function anatomy() external view override returns (address[] memory _assets, uint8[] memory _weights) {\n        _assets = assets.values();\n        _weights = new uint8[](_assets.length);\n        for (uint i; i < _assets.length; ++i) {\n            _weights[i] = weightOf[_assets[i]];\n        }\n    }\n```\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/contests/2022-04-phuture-finance-contest",
  "Code": [
    {
      "filename": "contracts/BaseIndex.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\n\npragma solidity >=0.8.7;\n\nimport \"@openzeppelin/contracts/access/IAccessControl.sol\";\nimport \"@openzeppelin/contracts/security/ReentrancyGuard.sol\";\nimport \"@openzeppelin/contracts/utils/introspection/ERC165Checker.sol\";\n\nimport \"./libraries/IndexLibrary.sol\";\n\nimport \"./interfaces/IIndex.sol\";\nimport \"./interfaces/IIndexLogic.sol\";\nimport \"./interfaces/IIndexFactory.sol\";\nimport \"./interfaces/IPhuturePriceOracle.sol\";\n\nimport \"./PhutureIndex.sol\";\n\n/// @title Base index\n/// @notice Contains common logic for all indices\nabstract contract BaseIndex is PhutureIndex, ReentrancyGuard, IIndex {\n    using ERC165Checker for address;\n    using EnumerableSet for EnumerableSet.AddressSet;\n\n    /// @notice Role allows configure index related data/components\n    bytes32 internal constant INDEX_MANAGER_ROLE = keccak256(\"INDEX_MANAGER_ROLE\");\n\n    /// @notice Checks if msg.sender has the given role's permission\n    modifier onlyRole(bytes32 role) {\n        require(IAccessControl(registry).hasRole(role, msg.sender), \"GovernableIndex: FORBIDDEN\");\n        _;\n    }\n\n    constructor(address _factory) {\n        require(_factory.supportsInterface(type(IIndexFactory).interfaceId), \"BaseIndex: INTERFACE\");\n\n        factory = _factory;\n        lastTransferTime = block.timestamp;\n        registry = IIndexFactory(_factory).registry();\n        vTokenFactory = IIndexFactory(_factory).vTokenFactory();\n    }\n\n    /// @inheritdoc IIndex\n    function mint(address _recipient) external override nonReentrant {\n        (bool success, bytes memory data) = IIndexRegistry(registry).indexLogic().delegatecall(\n            abi.encodeWithSelector(IIndexLogic.mint.selector, _recipient)\n        );\n        if (!success) {\n            if (data.length == 0) {\n                revert(\"BaseIndex: MINT_FAILED\");\n            } else {\n                assembly {\n                    revert(add(32, data), mload(data))\n                }\n            }\n        }\n    }\n\n    /// @inheritdoc IIndex\n    function burn(address _recipient) external override nonReentrant {\n        (bool success, bytes memory data) = IIndexRegistry(registry).indexLogic().delegatecall(\n            abi.encodeWithSelector(IIndexLogic.burn.selector, _recipient)\n        );\n        if (!success) {\n            if (data.length == 0) {\n                revert(\"BaseIndex: BURN_FAILED\");\n            } else {\n                assembly {\n                    revert(add(32, data), mload(data))\n                }\n            }\n        }\n    }\n\n    /// @inheritdoc IIndex\n    function anatomy() external view override returns (address[] memory _assets, uint8[] memory _weights) {\n        _assets = assets.values();\n        _weights = new uint8[](_assets.length);\n        for (uint i; i < _assets.length; ++i) {\n            _weights[i] = weightOf[_assets[i]];\n        }\n    }\n\n    /// @inheritdoc IIndex\n    function inactiveAnatomy() external view override returns (address[] memory _assets) {\n        _assets = inactiveAssets.values();\n    }\n\n    /// @inheritdoc ERC165\n    function supportsInterface(bytes4 _interfaceId) public view virtual override returns (bool) {\n        return _interfaceId == type(IIndex).interfaceId || super.supportsInterface(_interfaceId);\n    }\n}"
    }
  ]
}