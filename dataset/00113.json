{
  "Title": "Incorrect handling of decimals in `LibLockedUnderlying::getPercentLockedUnderlying` results in an incorrect value being returned, affecting the temperature and Bean to maxLP gaugePoint per BDV ratio updates in each subsequent call to `SeasonFacet::gm` when `unripe asset supply < 10M`",
  "Content": "**Description:** Due to the Barn Raise and the associated Beans underlying Unripe assets, the number of tradable Beans does not equal the total Bean supply. Within the calculation of L2SR, the term \"locked liquidity\" refers to the portion of liquidity in the BEAN:ETH WELL that cannot be retrieved through chopping until the corresponding Fertilizer is paid.\n\nThe exchange ratio for the corresponding underlying asset can be summarized in the following formula:\n\n$$\\frac{Paid Fertilizer}{Minted Fertilizer} \\times \\frac{totalUnderlying(urAsset)}{supply(urAsset)}$$\n\nThe second factor indicates the amount of the underlying asset backing each unripe asset, while the first indicates the distribution of the underlying asset based on the ratio of Fertilizer that is already paid.\n\nWhen a user chops an unripe asset, it is burned in exchange for a penalized amount of the underlying asset. The remaining underlying asset is now shared among the remaining unripe asset holders, meaning that if another user tries to chop the same amount of unripe asset at a given recapitalization rate, they will receive a greater amount of underlying asset.\n\nFor instance, assume that:\n* 50% of the minted Fertilizer is paid\n* A current supply of 70M\n* An underlying amount of 22M\n\nIf Alice chops 1M unripe tokens:\n$$1,000,000 \\times 0.50 \\times \\frac{22,000,000}{70,000,000} =$$\n$$1,000,000 \\times 0.50 \\times 0.31428 =$$\n$$1,000,000 \\times 0.50 \\times 0.31428 =$$\n$$1,000,000 \\times 0.15714285 = $$\n$$157,142.85$$\n\nIf Bob then chops the same amount of tokens:\n$$1,000,000 \\times 0.50 \\times \\frac{22,000,000-157,142.85}{70,000,000 - 1,000,000} =$$\n$$1,000,000 \\times 0.50 \\times \\frac{21,842,857.15}{69,000,000} =$$\n$$1,000,000 \\times 0.50 \\times \\frac{21,842,857.15}{69,000,000} =$$\n$$1,000,000 \\times 0.50 \\times 0.3165 =$$\n$$158,281.57$$\n\nGiven that the assumption of chopping the total unripe asset supply in one step is highly unlikely, the Beanstalk Farms team decided to perform an off-chain regression based on the average unripe asset per unripe asset holder. This yields an approximation for the percentage locked underlying token per asset based on the current unripe asset supply. An on-chain look-up table is used to retrieve the values of this regression; however, the issue with its implementation lies in its failure to account for unripe token decimals when compared with the inline conditional supply constants [`1_000_000`](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/libraries/LibLockedUnderlying.sol#L61), [`5_000_000`](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/libraries/LibLockedUnderlying.sol#L62), and [`10_000_000`](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/libraries/LibLockedUnderlying.sol#L63) as the intervals on which the iterative simulation was performed. Given these constants are not a fixed-point representation of the numbers they are intended to represent, [comparison](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/libraries/LibLockedUnderlying.sol#L286) with the [6-decimal supply](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/libraries/LibLockedUnderlying.sol#L60) will be incorrect.\n\n**Impact:** Given that unripe assets have 6 decimals, `LibLockedUnderlying::getPercentLockedUnderlying` will tend to execute [this conditional branch](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/libraries/LibLockedUnderlying.sol#L63-L173), producing an incorrect calculation of locked underlying whenever the supply of the unripe asset is below 10M.\n\nIn the given scenario, this error would cascade into an incorrect calculation of L2SR, affecting how the temperature and Bean to maxLP gaugePoint per BDV ratio should be updated in the call to [`Weather::calcCaseIdandUpdate`](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/beanstalk/sun/SeasonFacet/Weather.sol#L68) within [`SeasonFacet::gm`](https://github.com/BeanstalkFarms/Beanstalk/blob/dfb418d185cd93eef08168ccaffe9de86bc1f062/protocol/contracts/beanstalk/sun/SeasonFacet/SeasonFacet.sol#L51).\n\n**Proof of Concept:** A differential test (see Appendix A) was written to demonstrate this issue based on CSV provided by the Beanstalk Farms team. Modifications to the CSV include:\n* Adding headers: recapPercentage, urSupply, lockedPercentage\n* Generate a CSV without whitespaces\n* Round the first column to 3 decimals\n* For the third column, delete `e18` and round values to 18 decimals\n\n**Recommended Mitigation:** Scale each inline constant that is compared against the unripe supply by 6 decimals.\n\nFor similar cases in the future, differential testing between the expected and actual outputs is effective in catching bugs of this type which rely on pre-computed off-chain values.",
  "Impact": "MEDIUM",
  "Source": "",
  "Code": [
    {
      "filename": "protocol/contracts/libraries/LibLockedUnderlying.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity =0.7.6;\npragma experimental ABIEncoderV2;\n\nimport {IERC20} from \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\nimport {AppStorage, LibAppStorage} from \"./LibAppStorage.sol\";\n\n/**\n * @title LibLockedUnderlying\n * @author Brendan\n * @notice Library to calculate the number of Underlying Tokens that would be locked if all of\n * the Unripe Tokens are Chopped.\n */\nlibrary LibLockedUnderlying {\n    using SafeMath for uint256;\n\n    /**\n     * @notice Return the amount of Underlying Tokens that would be locked if all of the Unripe Tokens\n     * were chopped.\n     */\n    function getLockedUnderlying(\n        address unripeToken,\n        uint256 recapPercentPaid\n    ) external view returns (uint256 lockedUnderlying) {\n        AppStorage storage s = LibAppStorage.diamondStorage();\n        return\n            s\n                .u[unripeToken]\n                .balanceOfUnderlying\n                .mul(getPercentLockedUnderlying(unripeToken, recapPercentPaid))\n                .div(1e18);\n    }\n\n    /**\n     * @notice Return the % of Underlying Tokens that would be locked if all of the Unripe Tokens\n     * were chopped.\n     * @param unripeToken The address of the Unripe Token\n     * @param recapPercentPaid The % of Sprouts that have been Rinsed or are Rinsable.\n     * Should have 6 decimal precision.\n     *\n     * @dev Solves the below equation for N_{⌈U/i⌉}:\n     * N_{t+1} = N_t - i * R * N_t / (U - i * t)\n     * where:\n     *  - N_t is the number of Underlying Tokens at step t\n     *  - U is the starting number of Unripe Tokens\n     *  - R is the % of Sprouts that are Rinsable or Rinsed\n     *  - i is the number of Unripe Beans that are chopped at each step. i ~= 46,659 is used as this is aboutr\n     *    the average Unripe Beans held per Farmer with a non-zero balance.\n     *\n     * The equation is solved by using a lookup table of N_{⌈U/i⌉} values for different values of\n     * U and R (The solution is independent of N) as solving iteratively is too computationally\n     * expensive and there is no more efficient way to solve the equation.\n     */\n    function getPercentLockedUnderlying(\n        address unripeToken,\n        uint256 recapPercentPaid\n    ) private view returns (uint256 percentLockedUnderlying) {\n        uint256 unripeSupply = IERC20(unripeToken).totalSupply();\n        if (unripeSupply < 1_000_000) return 0; // If < 1,000,000 Assume all supply is unlocked.\n        if (unripeSupply > 5_000_000) {\n            if (unripeSupply > 10_000_000) {\n                if (recapPercentPaid > 0.1e6) {\n                    if (recapPercentPaid > 0.21e6) {\n                        if (recapPercentPaid > 0.38e6) {\n                            if (recapPercentPaid > 0.45e6) {\n                                return 0.000106800755371506e18; // 90,000,000, 0.9\n                            } else {\n                                return 0.019890729697455534e18; // 90,000,000, 0.45\n                            }\n                        } else if (recapPercentPaid > 0.29e6) {\n                            if (recapPercentPaid > 0.33e6) {\n                                return 0.038002726385307994e18; // 90,000,000 0.38\n                            } else {\n                                return 0.05969915165233464e18; // 90,000,000 0.33\n                            }\n                        } else if (recapPercentPaid > 0.25e6) {\n                            if (recapPercentPaid > 0.27e6) {\n                                return 0.08520038853809475e18; // 90,000,000 0.29\n                            } else {\n                                return 0.10160827712172482e18; // 90,000,000 0.27\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.23e6) {\n                                return 0.1210446758987509e18; // 90,000,000 0.25\n                            } else {\n                                return 0.14404919400935834e18; // 90,000,000 0.23\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.17e6) {\n                            if (recapPercentPaid > 0.19e6) {\n                                return 0.17125472579906187e18; // 90,000,000, 0.21\n                            } else {\n                                return 0.2034031571094802e18; // 90,000,000, 0.19\n                            }\n                        } else if (recapPercentPaid > 0.14e6) {\n                            if (recapPercentPaid > 0.15e6) {\n                                return 0.24136365460186238e18; // 90,000,000 0.17\n                            } else {\n                                return 0.2861539540121635e18; // 90,000,000 0.15\n                            }\n                        } else if (recapPercentPaid > 0.12e6) {\n                            if (recapPercentPaid > 0.13e6) {\n                                return 0.3114749615435798e18; // 90,000,000 0.14\n                            } else {\n                                return 0.3389651289211062e18; // 90,000,000 0.13\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.11e6) {\n                                return 0.3688051484970447e18; // 90,000,000 0.12\n                            } else {\n                                return 0.4011903974987394e18; // 90,000,000 0.11\n                            }\n                        }\n                    }\n                } else {\n                    if (recapPercentPaid > 0.04e6) {\n                        if (recapPercentPaid > 0.08e6) {\n                            if (recapPercentPaid > 0.09e6) {\n                                return 0.4363321054081788e18; // 90,000,000, 0.1\n                            } else {\n                                return 0.4744586123058411e18; // 90,000,000, 0.09\n                            }\n                        } else if (recapPercentPaid > 0.06e6) {\n                            if (recapPercentPaid > 0.07e6) {\n                                return 0.5158167251384363e18; // 90,000,000 0.08\n                            } else {\n                                return 0.560673179393784e18; // 90,000,000 0.07\n                            }\n                        } else if (recapPercentPaid > 0.05e6) {\n                            if (recapPercentPaid > 0.055e6) {\n                                return 0.6093162142284054e18; // 90,000,000 0.06\n                            } else {\n                                return 0.6351540690346162e18; // 90,000,000 0.055\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.045e6) {\n                                return 0.6620572696973799e18; // 90,000,000 0.05\n                            } else {\n                                return 0.6900686713435757e18; // 90,000,000 0.045\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.03e6) {\n                            if (recapPercentPaid > 0.035e6) {\n                                return 0.7192328153846157e18; // 90,000,000, 0.04\n                            } else {\n                                return 0.7495959945573412e18; // 90,000,000, 0.035\n                            }\n                        } else if (recapPercentPaid > 0.02e6) {\n                            if (recapPercentPaid > 0.025e6) {\n                                return 0.7812063204281795e18; // 90,000,000 0.03\n                            } else {\n                                return 0.8141137934523504e18; // 90,000,000 0.025\n                            }\n                        } else if (recapPercentPaid > 0.01e6) {\n                            if (recapPercentPaid > 0.015e6) {\n                                return 0.8483703756831885e18; // 90,000,000 0.02\n                            } else {\n                                return 0.8840300662301638e18; // 90,000,000 0.015\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.005e6) {\n                                return 0.921148979567821e18; // 90,000,000 0.01\n                            } else {\n                                return 0.9597854268015467e18; // 90,000,000 0.005\n                            }\n                        }\n                    }\n                }\n            } else {\n                // > 5,000,000\n                if (recapPercentPaid > 0.1e6) {\n                    if (recapPercentPaid > 0.21e6) {\n                        if (recapPercentPaid > 0.38e6) {\n                            if (recapPercentPaid > 0.45e6) {\n                                return 0.000340444522821781e18; // 10,000,000, 0.9\n                            } else {\n                                return 0.04023093970853808e18; // 10,000,000, 0.45\n                            }\n                        } else if (recapPercentPaid > 0.29e6) {\n                            if (recapPercentPaid > 0.33e6) {\n                                return 0.06954881077191022e18; // 10,000,000 0.38\n                            } else {\n                                return 0.10145116013499655e18; // 10,000,000 0.33\n                            }\n                        } else if (recapPercentPaid > 0.25e6) {\n                            if (recapPercentPaid > 0.27e6) {\n                                return 0.13625887314323348e18; // 10,000,000 0.29\n                            } else {\n                                return 0.15757224609763754e18; // 10,000,000 0.27\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.23e6) {\n                                return 0.18197183407669726e18; // 10,000,000 0.25\n                            } else {\n                                return 0.20987581330872107e18; // 10,000,000 0.23\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.17e6) {\n                            if (recapPercentPaid > 0.19e6) {\n                                return 0.24175584233885106e18; // 10,000,000, 0.21\n                            } else {\n                                return 0.27814356260741413e18; // 10,000,000, 0.19\n                            }\n                        } else if (recapPercentPaid > 0.14e6) {\n                            if (recapPercentPaid > 0.15e6) {\n                                return 0.3196378540296301e18; // 10,000,000 0.17\n                            } else {\n                                return 0.36691292973511136e18; // 10,000,000 0.15\n                            }\n                        } else if (recapPercentPaid > 0.1e6) {\n                            if (recapPercentPaid > 0.13e6) {\n                                return 0.3929517529835418e18; // 10,000,000 0.14\n                            } else {\n                                return 0.4207273631610372e18; // 10,000,000 0.13\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.11e6) {\n                                return 0.450349413795883e18; // 10,000,000 0.12\n                            } else {\n                                return 0.4819341506654745e18; // 10,000,000 0.11\n                            }\n                        }\n                    }\n                } else {\n                    if (recapPercentPaid > 0.04e6) {\n                        if (recapPercentPaid > 0.08e6) {\n                            if (recapPercentPaid > 0.09e6) {\n                                return 0.5156047910307769e18; // 10,000,000, 0.1\n                            } else {\n                                return 0.551491923831086e18; // 10,000,000, 0.09\n                            }\n                        } else if (recapPercentPaid > 0.06e6) {\n                            if (recapPercentPaid > 0.07e6) {\n                                return 0.5897339319558434e18; // 10,000,000 0.08\n                            } else {\n                                return 0.6304774377677631e18; // 10,000,000 0.07\n                            }\n                        } else if (recapPercentPaid > 0.05e6) {\n                            if (recapPercentPaid > 0.055e6) {\n                                return 0.6738777731119263e18; // 10,000,000 0.06\n                            } else {\n                                return 0.6966252960203008e18; // 10,000,000 0.055\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.045e6) {\n                                return 0.7200994751088836e18; // 10,000,000 0.05\n                            } else {\n                                return 0.7443224016328813e18; // 10,000,000 0.045\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.03e6) {\n                            if (recapPercentPaid > 0.035e6) {\n                                return 0.7693168090963867e18; // 10,000,000, 0.04\n                            } else {\n                                return 0.7951060911805916e18; // 10,000,000, 0.035\n                            }\n                        } else if (recapPercentPaid > 0.02e6) {\n                            if (recapPercentPaid > 0.025e6) {\n                                return 0.8217143201541763e18; // 10,000,000 0.03\n                            } else {\n                                return 0.8491662657783823e18; // 10,000,000 0.025\n                            }\n                        } else if (recapPercentPaid > 0.01e6) {\n                            if (recapPercentPaid > 0.015e6) {\n                                return 0.8774874147196358e18; // 10,000,000 0.02\n                            } else {\n                                return 0.9067039904828691e18; // 10,000,000 0.015\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.005e6) {\n                                return 0.9368429738790524e18; // 10,000,000 0.01\n                            } else {\n                                return 0.9679321240407666e18; // 10,000,000 0.005\n                            }\n                        }\n                    }\n                }\n            }\n        } else {\n            if (unripeSupply > 1_000_000) {\n                if (recapPercentPaid > 0.1e6) {\n                    if (recapPercentPaid > 0.21e6) {\n                        if (recapPercentPaid > 0.38e6) {\n                            if (recapPercentPaid > 0.45e6) {\n                                return 0.000946395082480844e18; // 3,000,000, 0.9\n                            } else {\n                                return 0.06786242725985348e18; // 3,000,000, 0.45\n                            }\n                        } else if (recapPercentPaid > 0.29e6) {\n                            if (recapPercentPaid > 0.33e6) {\n                                return 0.10822315472628707e18; // 3,000,000 0.38\n                            } else {\n                                return 0.14899524306327216e18; // 3,000,000 0.33\n                            }\n                        } else if (recapPercentPaid > 0.25e6) {\n                            if (recapPercentPaid > 0.27e6) {\n                                return 0.1910488239684135e18; // 3,000,000 0.29\n                            } else {\n                                return 0.215863137234529e18; // 3,000,000 0.27\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.23e6) {\n                                return 0.243564628757033e18; // 3,000,000 0.25\n                            } else {\n                                return 0.2744582675491247e18; // 3,000,000 0.23\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.17e6) {\n                            if (recapPercentPaid > 0.19e6) {\n                                return 0.3088786047254358e18; // 3,000,000, 0.21\n                            } else {\n                                return 0.3471924328319608e18; // 3,000,000, 0.19\n                            }\n                        } else if (recapPercentPaid > 0.14e6) {\n                            if (recapPercentPaid > 0.15e6) {\n                                return 0.38980166833777796e18; // 3,000,000 0.17\n                            } else {\n                                return 0.4371464748698771e18; // 3,000,000 0.15\n                            }\n                        } else if (recapPercentPaid > 0.12e6) {\n                            if (recapPercentPaid > 0.13e6) {\n                                return 0.46274355346663876e18; // 3,000,000 0.14\n                            } else {\n                                return 0.4897086460787351e18; // 3,000,000 0.13\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.11e6) {\n                                return 0.518109082463349e18; // 3,000,000 0.12\n                            } else {\n                                return 0.5480152684204499e18; // 3,000,000 0.11\n                            }\n                        }\n                    }\n                } else {\n                    if (recapPercentPaid > 0.04e6) {\n                        if (recapPercentPaid > 0.08e6) {\n                            if (recapPercentPaid > 0.09e6) {\n                                return 0.5795008171102514e18; // 3,000,000, 0.1\n                            } else {\n                                return 0.6126426856374751e18; // 3,000,000, 0.09\n                            }\n                        } else if (recapPercentPaid > 0.06e6) {\n                            if (recapPercentPaid > 0.07e6) {\n                                return 0.6475213171017626e18; // 3,000,000 0.08\n                            } else {\n                                return 0.6842207883207123e18; // 3,000,000 0.07\n                            }\n                        } else if (recapPercentPaid > 0.05e6) {\n                            if (recapPercentPaid > 0.055e6) {\n                                return 0.7228289634394097e18; // 3,000,000 0.06\n                            } else {\n                                return 0.742877347280416e18; // 3,000,000 0.055\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.045e6) {\n                                return 0.7634376536479606e18; // 3,000,000 0.05\n                            } else {\n                                return 0.784522002909275e18; // 3,000,000 0.045\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.03e6) {\n                            if (recapPercentPaid > 0.035e6) {\n                                return 0.8061427832364296e18; // 3,000,000, 0.04\n                            } else {\n                                return 0.8283126561589187e18; // 3,000,000, 0.035\n                            }\n                        } else if (recapPercentPaid > 0.02e6) {\n                            if (recapPercentPaid > 0.025e6) {\n                                return 0.8510445622247672e18; // 3,000,000 0.03\n                            } else {\n                                return 0.8743517267721741e18; // 3,000,000 0.025\n                            }\n                        } else if (recapPercentPaid > 0.01e6) {\n                            if (recapPercentPaid > 0.015e6) {\n                                return 0.8982476658137254e18; // 3,000,000 0.02\n                            } else {\n                                return 0.9227461920352636e18; // 3,000,000 0.015\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.005e6) {\n                                return 0.9478614209115208e18; // 3,000,000 0.01\n                            } else {\n                                return 0.9736077769406731e18; // 3,000,000 0.005\n                            }\n                        }\n                    }\n                }\n            } else {\n                if (recapPercentPaid > 0.1e6) {\n                    if (recapPercentPaid > 0.21e6) {\n                        if (recapPercentPaid > 0.38e6) {\n                            if (recapPercentPaid > 0.45e6) {\n                                return 0.003360632002379016e18; // 1,000,000, 0.9\n                            } else {\n                                return 0.12071031956650236e18; // 1,000,000, 0.45\n                            }\n                        } else if (recapPercentPaid > 0.29e6) {\n                            if (recapPercentPaid > 0.33e6) {\n                                return 0.1752990554517151e18; // 1,000,000 0.38\n                            } else {\n                                return 0.22598948369141458e18; // 1,000,000 0.33\n                            }\n                        } else if (recapPercentPaid > 0.25e6) {\n                            if (recapPercentPaid > 0.27e6) {\n                                return 0.27509697387157794e18; // 1,000,000 0.29\n                            } else {\n                                return 0.3029091410266461e18; // 1,000,000 0.27\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.23e6) {\n                                return 0.33311222196618273e18; // 1,000,000 0.25\n                            } else {\n                                return 0.36588364748950297e18; // 1,000,000 0.23\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.17e6) {\n                            if (recapPercentPaid > 0.19e6) {\n                                return 0.40141235983370593e18; // 1,000,000, 0.21\n                            } else {\n                                return 0.43989947169522015e18; // 1,000,000, 0.19\n                            }\n                        } else if (recapPercentPaid > 0.14e6) {\n                            if (recapPercentPaid > 0.15e6) {\n                                return 0.4815589587559236e18; // 1,000,000 0.17\n                            } else {\n                                return 0.5266183872325827e18; // 1,000,000 0.15\n                            }\n                        } else if (recapPercentPaid > 0.12e6) {\n                            if (recapPercentPaid > 0.13e6) {\n                                return 0.5504980973828455e18; // 1,000,000 0.14\n                            } else {\n                                return 0.5753196780298556e18; // 1,000,000 0.13\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.11e6) {\n                                return 0.6011157438454372e18; // 1,000,000 0.12\n                            } else {\n                                return 0.6279199091408495e18; // 1,000,000 0.11\n                            }\n                        }\n                    }\n                } else {\n                    if (recapPercentPaid > 0.04e6) {\n                        if (recapPercentPaid > 0.08e6) {\n                            if (recapPercentPaid > 0.09e6) {\n                                return 0.6557668151543954e18; // 1,000,000, 0.1\n                            } else {\n                                return 0.6846921580052533e18; // 1,000,000, 0.09\n                            }\n                        } else if (recapPercentPaid > 0.06e6) {\n                            if (recapPercentPaid > 0.07e6) {\n                                return 0.7147327173281093e18; // 1,000,000 0.08\n                            } else {\n                                return 0.745926385603471e18; // 1,000,000 0.07\n                            }\n                        } else if (recapPercentPaid > 0.05e6) {\n                            if (recapPercentPaid > 0.055e6) {\n                                return 0.7783121981988174e18; // 1,000,000 0.06\n                            } else {\n                                return 0.7949646772335068e18; // 1,000,000 0.055\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.045e6) {\n                                return 0.8119303641360465e18; // 1,000,000 0.05\n                            } else {\n                                return 0.8292144735871585e18; // 1,000,000 0.045\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.03e6) {\n                            if (recapPercentPaid > 0.035e6) {\n                                return 0.8468222976009872e18; // 1,000,000, 0.04\n                            } else {\n                                return 0.8647592065514869e18; // 1,000,000, 0.035\n                            }\n                        } else if (recapPercentPaid > 0.02e6) {\n                            if (recapPercentPaid > 0.025e6) {\n                                return 0.8830306502110374e18; // 1,000,000 0.03\n                            } else {\n                                return 0.9016421588014247e18; // 1,000,000 0.025\n                            }\n                        } else if (recapPercentPaid > 0.01e6) {\n                            if (recapPercentPaid > 0.015e6) {\n                                return 0.9205993440573136e18; // 1,000,000 0.02\n                            } else {\n                                return 0.9399079003023474e18; // 1,000,000 0.015\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.005e6) {\n                                return 0.959573605538012e18; // 1,000,000 0.01\n                            } else {\n                                return 0.9796023225453983e18; // 1,000,000 0.005\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}"
    },
    {
      "filename": "protocol/contracts/libraries/LibLockedUnderlying.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity =0.7.6;\npragma experimental ABIEncoderV2;\n\nimport {IERC20} from \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport {SafeMath} from \"@openzeppelin/contracts/math/SafeMath.sol\";\nimport {AppStorage, LibAppStorage} from \"./LibAppStorage.sol\";\n\n/**\n * @title LibLockedUnderlying\n * @author Brendan\n * @notice Library to calculate the number of Underlying Tokens that would be locked if all of\n * the Unripe Tokens are Chopped.\n */\nlibrary LibLockedUnderlying {\n    using SafeMath for uint256;\n\n    /**\n     * @notice Return the amount of Underlying Tokens that would be locked if all of the Unripe Tokens\n     * were chopped.\n     */\n    function getLockedUnderlying(\n        address unripeToken,\n        uint256 recapPercentPaid\n    ) external view returns (uint256 lockedUnderlying) {\n        AppStorage storage s = LibAppStorage.diamondStorage();\n        return\n            s\n                .u[unripeToken]\n                .balanceOfUnderlying\n                .mul(getPercentLockedUnderlying(unripeToken, recapPercentPaid))\n                .div(1e18);\n    }\n\n    /**\n     * @notice Return the % of Underlying Tokens that would be locked if all of the Unripe Tokens\n     * were chopped.\n     * @param unripeToken The address of the Unripe Token\n     * @param recapPercentPaid The % of Sprouts that have been Rinsed or are Rinsable.\n     * Should have 6 decimal precision.\n     *\n     * @dev Solves the below equation for N_{⌈U/i⌉}:\n     * N_{t+1} = N_t - i * R * N_t / (U - i * t)\n     * where:\n     *  - N_t is the number of Underlying Tokens at step t\n     *  - U is the starting number of Unripe Tokens\n     *  - R is the % of Sprouts that are Rinsable or Rinsed\n     *  - i is the number of Unripe Beans that are chopped at each step. i ~= 46,659 is used as this is aboutr\n     *    the average Unripe Beans held per Farmer with a non-zero balance.\n     *\n     * The equation is solved by using a lookup table of N_{⌈U/i⌉} values for different values of\n     * U and R (The solution is independent of N) as solving iteratively is too computationally\n     * expensive and there is no more efficient way to solve the equation.\n     */\n    function getPercentLockedUnderlying(\n        address unripeToken,\n        uint256 recapPercentPaid\n    ) private view returns (uint256 percentLockedUnderlying) {\n        uint256 unripeSupply = IERC20(unripeToken).totalSupply();\n        if (unripeSupply < 1_000_000) return 0; // If < 1,000,000 Assume all supply is unlocked.\n        if (unripeSupply > 5_000_000) {\n            if (unripeSupply > 10_000_000) {\n                if (recapPercentPaid > 0.1e6) {\n                    if (recapPercentPaid > 0.21e6) {\n                        if (recapPercentPaid > 0.38e6) {\n                            if (recapPercentPaid > 0.45e6) {\n                                return 0.000106800755371506e18; // 90,000,000, 0.9\n                            } else {\n                                return 0.019890729697455534e18; // 90,000,000, 0.45\n                            }\n                        } else if (recapPercentPaid > 0.29e6) {\n                            if (recapPercentPaid > 0.33e6) {\n                                return 0.038002726385307994e18; // 90,000,000 0.38\n                            } else {\n                                return 0.05969915165233464e18; // 90,000,000 0.33\n                            }\n                        } else if (recapPercentPaid > 0.25e6) {\n                            if (recapPercentPaid > 0.27e6) {\n                                return 0.08520038853809475e18; // 90,000,000 0.29\n                            } else {\n                                return 0.10160827712172482e18; // 90,000,000 0.27\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.23e6) {\n                                return 0.1210446758987509e18; // 90,000,000 0.25\n                            } else {\n                                return 0.14404919400935834e18; // 90,000,000 0.23\n                            }\n                        }\n                    } else {\n                        if (recapPercentPaid > 0.17e6) {\n                            if (recapPercentPaid > 0.19e6) {\n                                return 0.17125472579906187e18; // 90,000,000, 0.21\n                            } else {\n                                return 0.2034031571094802e18; // 90,000,000, 0.19\n                            }\n                        } else if (recapPercentPaid > 0.14e6) {\n                            if (recapPercentPaid > 0.15e6) {\n                                return 0.24136365460186238e18; // 90,000,000 0.17\n                            } else {\n                                return 0.2861539540121635e18; // 90,000,000 0.15\n                            }\n                        } else if (recapPercentPaid > 0.12e6) {\n                            if (recapPercentPaid > 0.13e6) {\n                                return 0.3114749615435798e18; // 90,000,000 0.14\n                            } else {\n                                return 0.3389651289211062e18; // 90,000,000 0.13\n                            }\n                        } else {\n                            if (recapPercentPaid > 0.11e6) {\n                                return 0.3688051484970447e18; // 90,000,000 0.12\n                            } else {\n                                return 0.4011903974987394e18; // 90,000,000 0.11\n                            }\n                        }\n                    }\n                } else {\n                    if (recapPercentPaid > 0.04e6) {\n                        if (recapPercentPaid > 0.08e6) {\n                            if (recapPercentPaid > 0.09e6) {\n                                return 0.4363321054081788e18; // 90,000,000, 0.1\n                            } else {\n                                return 0.4744586123058411e18; // 90,000,000, 0.09\n                            }\n                        } else if (recapPercentPaid > 0.06e6) {\n                            if (recapPercentPaid > 0.07e6) {\n                                ret"
    }
  ]
}