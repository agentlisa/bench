{
  "Title": "M-3: Clubs can mint +1 players more than maxGenerationId",
  "Content": "# Issue M-3: Clubs can mint +1 players more than maxGenerationId \n\nSource: https://github.com/sherlock-audit/2023-04-footium-judging/issues/152 \n\n## Found by \nPhantasmagoria, Sulpiride, alexzoid, descharre, juancito, mstpr-brainbot, ni8mare, santipu\\_, shaka\n## Summary\nAs stated in doc here\n<img width=\"1007\" alt=\"image\" src=\"https://user-images.githubusercontent.com/120012681/236145880-57018bcf-d25d-4c4f-a3f0-b8bfcdc4f57a.png\">\nInitially clubs should be able to mint 10 players. However, clubs can always mint +1 players more than `maxGenerationId` \n## Vulnerability Detail\nAn off-by-one error is existed in academy contract when checking the generation ID while minting players. The code currently allows clubs to mint up to `maxGenerationId + 1` players, which is inconsistent with the documentation. If clubs send generation IDs in the following sequence: 0-1-2-3-4-5-6-7-8-9-10, all of these numbers will be valid, and the club will be able to mint `maxGenerationId + 1 ` players instead of the intended `maxGenerationId`\n\n## Impact\nSince this is not intended behaviour according to the protocol docs, I'll label it as high.\n## Code Snippet\nhttps://github.com/sherlock-audit/2023-04-footium/blob/main/footium-eth-shareable/contracts/FootiumAcademy.sol#L186-L188\nhere code checks whether the generation id is higher than maxGeneration or not, and it can be equal to maxGeneration.\n## Tool used\n\nManual Review\n\n## Recommendation\nUse `generationId >= _maxGenerationId` or do not count the \"0\" index\n\n\n\n## Discussion\n\n**logiclogue**\n\nMarked as 'Will Fix'. I believe the solution here is instead to update the documentation to say \"At game launch this value will be 9\". Because the documentation as far as I'm aware is correct in that it says `maxGenerationId` is the maximum generation ID, it's just that it does not represent the total players per cohort, which was the assumption with the default value being 10.\n\n**dugdaniels**\n\nEscalate for 10 USDC\n\nThis should be considered Low/Informational.\n\nThe variable is named `maxGenerationId`. As the name implies (and as noted in the docs), it is the maximum integer ID that can be used to mint. A `maxGenerationID` of `10` therefore means that you can mint a player with an ID of `10`. The sponsor confirmed that this is working as intended and that only the documentation needs to be clarified. \n\nFurthermore, to imply that a `maxGenerationId` of `10` should actually enforce a max id of `9` is illogical.\n\nUltimately, it's a configuration variable and the sponsor is updating the documentation to reflect the value that will be set to at launch. A documentation update should only be considered as informational. There is no exploit here.\n\n\n**sherlock-admin**\n\n > Escalate for 10 USDC\n> \n> This should be considered Low/Informational.\n> \n> The variable is named `maxGenerationId`. As the name implies (and as noted in the docs), it is the maximum integer ID that can be used to mint. A `maxGenerationID` of `10` therefore means that you can mint a player with an ID of `10`. The sponsor confirmed that this is working as intended and that only the documentation needs to be clarified. \n> \n> Furthermore, to imply that a `maxGenerationId` of `10` should actually enforce a max id of `9` is illogical.\n> \n> Ultimately, it's a configuration variable and the sponsor is updating the documentation to reflect the value that will be set to at launch. A documentation update should only be considered as informational. There is no exploit here.\n> \n\nYou've created a valid escalation for 10 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**NishithPat**\n\nEscalate for 10 USDC\nDisagree with the sponsor's comment saying that the documentation is right and that `maxGenerationId` is \"the maximum generation ID, it's just that it does not represent the total players per cohort\" or \"it is the maximum integer ID that can be used to mint\".\n\nThe [docs](https://github.com/sherlock-audit/2023-04-footium/blob/main/footium-eth-shareable/contracts/technical-docs/FootiumAcademy.md) say that `maxGenerationId` is \"the number of players that can be minted per cohort\". Check the definition of [`maxGenerationId`](https://github.com/sherlock-audit/2023-04-footium/blob/11736f3f7f7efa88cb99ee98b04b85a46621347c/footium-eth-shareable/contracts/technical-docs/FootiumAcademy.md?plain=1#LL24C12-L24C71) in the doc. \n\nThen going by the docs, if `maxGenerationId` is the number of players that can be minted per cohort, then the contract does indeed allow `maxGenerationId` + 1 player to be minted. In that case, the issue should be valid.\n\n**sherlock-admin**\n\n > Escalate for 10 USDC\n> Disagree with the sponsor's comment saying that the documentation is right and that `maxGenerationId` is \"the maximum generation ID, it's just that it does not represent the total players per cohort\" or \"it is the maximum integer ID that can be used to mint\".\n> \n> The [docs](https://github.com/sherlock-audit/2023-04-footium/blob/main/footium-eth-shareable/contracts/technical-docs/FootiumAcademy.md) say that `maxGenerationId` is \"the number of players that can be minted per cohort\". Check the definition of [`maxGenerationId`](https://github.com/sherlock-audit/2023-04-footium/blob/11736f3f7f7efa88cb99ee98b04b85a46621347c/footium-eth-shareable/contracts/technical-docs/FootiumAcademy.md?plain=1#LL24C12-L24C71) in the doc. \n> \n> Then going by the docs, if `maxGenerationId` is the number of players that can be minted per cohort, then the contract does indeed allow `maxGenerationId` + 1 player to be minted. In that case, the issue should be valid.\n\nYou've created a valid escalation for 10 USDC!\n\nTo remove the escalation from consideration: Delete your comment.\n\nYou may delete or edit your escalation comment anytime before the 48-hour escalation window closes. After that, the escalation becomes final.\n\n**logiclogue**\n\nSponsor here, agreed with @NishithPat . My original statement is incorrect, the documentation should be updated to remove the statement \"the number of players that can be minted per cohort\". Their suggestion is correct\n\n**ctf-sec**\n\nBased on the comments above, [NishithPat](https://github.com/NishithPat) escalation is valid\n\n**hrishibhat**\n\nEscalation accepted\n\nValid medium\nAccepting @NishithPat's escalation\nGiven that the issue correctly identifies the flaw in the code as against what the documentation says it's supposed to do, this is a valid issue. \n\n**sherlock-admin**\n\n> Escalation accepted\n> \n> Valid medium\n> Accepting @NishithPat's escalation\n> Given that the issue correctly identifies the flaw in the code as against what the documentation says it's supposed to do, this is a valid issue. \n\n    This issue's escalations have been accepted!\n\n    Contestants' payouts and scores will be updated according to the changes made on this issue.\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/71",
  "Code": [
    {
      "filename": "footium-eth-shareable/contracts/FootiumAcademy.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.16;\n\nimport {MerkleProofUpgradeable} from \"@openzeppelin/contracts-upgradeable/utils/cryptography/MerkleProofUpgradeable.sol\";\nimport {OwnableUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol\";\nimport {PausableUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol\";\nimport {ReentrancyGuardUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol\";\nimport {IFootiumPlayer} from \"./interfaces/IFootiumPlayer.sol\";\nimport {IFootiumClub} from \"./interfaces/IFootiumClub.sol\";\nimport \"./common/Errors.sol\";\n\ntype SeasonID is uint256;\n\nerror GenerationIDTooHigh(uint256 generationId, uint256 maxGenerationId);\nerror PlayerAlreadyRedeemed(uint256 generationId);\nerror ClubNotInDivision(uint256 clubId, uint256 divisionTier);\nerror PlayerTooOld(uint256 currentSeasonId);\nerror PlayerTooYoung(SeasonID seasonId);\nerror InvalidSeasonId(SeasonID seasonId);\n\n/**\n * @title Footium Football Academy\n * @notice An NFT football academy.\n */\ncontract FootiumAcademy is\n    PausableUpgradeable,\n    ReentrancyGuardUpgradeable,\n    OwnableUpgradeable\n{\n    /* Storage */\n    IFootiumPlayer private _footiumPlayer;\n    IFootiumClub private _footiumClub;\n    address private _prizeDistributorAddress;\n    uint256 private _maxGenerationId;\n    uint256 public currentSeasonId;\n    uint256 public academyMinAge;\n    uint256 public academyMaxAge;\n\n    bytes32 private _clubDivsMerkleRoot;\n\n    mapping(SeasonID => mapping(uint256 => mapping(uint256 => bool)))\n        private redeemed;\n\n    mapping(uint256 => uint256) public divisionToFee; //Maps a divisionTier to a fee\n\n    /* Events */\n\n    event ChangedMaxGenerationId(uint256 indexed maxGenerationId);\n    event ChangedCurrentSeasonId(uint256 indexed currentSeasonId);\n    event AcademyPlayerMinted(\n        SeasonID indexed seasonId,\n        uint256 indexed clubId,\n        uint256 indexed generationId,\n        uint256 playerId\n    );\n    event ChangedClubDivsMerkleRoot(bytes32 merkleRoot);\n    event ChangedDivisionFees(uint256[] fees);\n\n    /**\n     * @dev Initializes the FootiumAcademy contract.\n     * @param footiumPlayer Footium Players contract address.\n     * @param footiumClub Footium Clubs contract address.\n     * @param prizeDistributorAddress FootiumPrizeDistributor contract address.\n     * @param maxGenerationId The maximum integer generationId can be.\n     * @param fees Division fees.\n     */\n    function initialize(\n        IFootiumPlayer footiumPlayer,\n        IFootiumClub footiumClub,\n        address prizeDistributorAddress,\n        uint256 maxGenerationId,\n        uint256[] memory fees\n    ) external initializer {\n        __Pausable_init();\n        __ReentrancyGuard_init();\n        __Ownable_init();\n\n        _footiumPlayer = footiumPlayer;\n        _footiumClub = footiumClub;\n        _prizeDistributorAddress = prizeDistributorAddress;\n        currentSeasonId = 1;\n        academyMinAge = 18;\n        academyMaxAge = 20;\n\n        setDivisionFees(fees);\n        changeMaxGenerationId(maxGenerationId);\n    }\n\n    /**\n     * @notice Changes the `_maxGenerationId` storage variable.\n     * @param maxGenerationId The new value for the `maxGenerationId` storage variable.\n     * @dev Only owner address allowed.\n     */\n    function changeMaxGenerationId(uint256 maxGenerationId) public onlyOwner {\n        _maxGenerationId = maxGenerationId;\n        emit ChangedMaxGenerationId(_maxGenerationId);\n    }\n\n    /**\n     * @notice Changes the `_clubDivsMerkleRoot` variable.\n     * @param _merkleRoot is the value for the `_clubDivsMerkleRoot` variable.\n     * @dev Only owner address allowed.\n     */\n    function setClubDivsMerkleRoot(bytes32 _merkleRoot) external onlyOwner {\n        _clubDivsMerkleRoot = _merkleRoot;\n\n        emit ChangedClubDivsMerkleRoot(_clubDivsMerkleRoot);\n    }\n\n    /**\n     * @notice Updates division fees.\n     * @param _fees an array of division fees to be set.\n     * @dev Only owner address allowed.\n     */\n    function setDivisionFees(uint256[] memory _fees) public onlyOwner {\n        uint256 max = _fees.length;\n\n        for (uint256 i = 0; i < max; ) {\n            uint256 fee = _fees[i];\n            divisionToFee[i + 1] = fee;\n\n            unchecked {\n                i++;\n            }\n        }\n\n        emit ChangedDivisionFees(_fees);\n    }\n\n    /**\n     * @notice Changes the `currentSeasonId` storage variable.\n     * @param _newSeasonId The new value for the `currentSeasonId` storage variable.\n     * @dev Only owner address allowed\n     */\n    function changeCurrentSeasonId(uint256 _newSeasonId) external onlyOwner {\n        currentSeasonId = _newSeasonId;\n\n        emit ChangedCurrentSeasonId(currentSeasonId);\n    }\n\n    /**\n     * @notice Unpause the contract\n     * @dev Only owner address allowed.\n     */\n    function activateContract() external onlyOwner {\n        _unpause();\n    }\n\n    /**\n     * @notice Pause the contract\n     * @dev Only owner address allowed.\n     */\n    function pauseContract() external onlyOwner {\n        _pause();\n    }\n\n    /**\n     * @notice Mint players corresponding to `generationIds` from the `seasonId` cohort.\n     * @param seasonId The season cohort to mint players from.\n     * @param clubId The ID of the club to receive the players.\n     * @param divisionTier The tier of the division.\n     * @param generationIds The unique identifier of each player within the season cohort.\n     * @param divisionProof Sibling hashes on the branch from the leaf to the division root of the merkel tree.\n     * @dev Only the owner can mint players to their club.\n     */\n    function mintPlayers(\n        SeasonID seasonId,\n        uint256 clubId,\n        uint256 divisionTier,\n        uint256[] calldata generationIds,\n        bytes32[] calldata divisionProof\n    ) external payable whenNotPaused nonReentrant {\n        uint256 totalFee = _validateMintingParams(\n            seasonId,\n            clubId,\n            divisionTier,\n            generationIds,\n            divisionProof\n        );\n\n        uint256 generationId;\n\n        for (uint256 i = 0; i < generationIds.length; ) {\n            generationId = generationIds[i];\n\n            if (generationId > _maxGenerationId) {\n                revert GenerationIDTooHigh(generationId, _maxGenerationId);\n            }\n\n            if (redeemed[seasonId][clubId][generationId]) {\n                revert PlayerAlreadyRedeemed(generationId);\n            }\n\n            redeemed[seasonId][clubId][generationId] = true;\n\n            uint256 playerId = _footiumPlayer.safeMint(\n                _footiumClub.clubToEscrow(clubId)\n            );\n\n            emit AcademyPlayerMinted(seasonId, clubId, generationId, playerId);\n\n            unchecked {\n                i++;\n            }\n        }\n\n        // forward total fee to the prize distributor contract\n        (bool sent, ) = _prizeDistributorAddress.call{value: totalFee}(\"\");\n        if (!sent) {\n            revert FailedToSendETH(totalFee);\n        }\n    }\n\n    /**\n     * @notice Transfers contract available ether balance to the contact owner address\n     * @dev Only owner address allowed\n     */\n    function withdraw() external onlyOwner {\n        uint256 balance = address(this).balance;\n        if (balance > 0) {\n            (bool sent, ) = payable(owner()).call{value: balance}(\"\");\n            if (!sent) {\n                revert FailedToSendETH(balance);\n            }\n        }\n    }\n\n    function _validateMintingParams(\n        SeasonID seasonId,\n        uint256 clubId,\n        uint256 divisionTier,\n        uint256[] calldata generationIds,\n        bytes32[] calldata divisionProof\n    ) private returns (uint256) {\n        if (\n            !MerkleProofUpgradeable.verify(\n                divisionProof,\n                _clubDivsMerkleRoot,\n                keccak256(abi.encodePacked(clubId, divisionTier))\n            )\n        ) {\n            revert ClubNotInDivision(clubId, divisionTier);\n        }\n\n        if (msg.sender != _footiumClub.ownerOf(clubId)) {\n            revert NotClubOwner(clubId, msg.sender);\n        }\n\n        if (SeasonID.unwrap(seasonId) <= 0) {\n            revert InvalidSeasonId(seasonId);\n        }\n\n        if (SeasonID.unwrap(seasonId) > currentSeasonId) {\n            revert PlayerTooYoung(seasonId);\n        }\n\n        uint256 playerCount = generationIds.length;\n        uint256 totalFee = playerCount * divisionToFee[divisionTier];\n        if (msg.value < totalFee) {\n            revert IncorrectETHAmount(msg.value);\n        }\n\n        uint256 maxSeasonId = SeasonID.unwrap(seasonId) +\n            academyMaxAge -\n            academyMinAge;\n\n        if (maxSeasonId < currentSeasonId) {\n            revert PlayerTooOld(currentSeasonId);\n        }\n\n        return totalFee;\n    }\n}"
    }
  ]
}