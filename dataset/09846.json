{
  "Title": "[G-05] community contract :: execute function",
  "Content": "\nFunction: execute\n\nContract: <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L35>\n\nRecommendation:\nSince both function require governance, governance check can be placed in execute instead of placing individually in UpdateConfig and Spend as done in <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/vesting/src/contract.rs>\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/contests/2022-02-anchor-contest",
  "Code": [
    {
      "filename": "contracts/anchor-token-contracts/contracts/community/src/contract.rs",
      "content": "#[cfg(not(feature = \"library\"))]\nuse cosmwasm_std::entry_point;\n\nuse crate::state::{read_config, store_config, Config};\n\nuse cosmwasm_std::{\n    to_binary, Binary, CosmosMsg, Deps, DepsMut, Env, MessageInfo, Response, StdError, StdResult,\n    Uint128, WasmMsg,\n};\n\nuse anchor_token::community::{ConfigResponse, ExecuteMsg, InstantiateMsg, MigrateMsg, QueryMsg};\n\nuse cw20::Cw20ExecuteMsg;\n\n#[cfg_attr(not(feature = \"library\"), entry_point)]\npub fn instantiate(\n    deps: DepsMut,\n    _env: Env,\n    _info: MessageInfo,\n    msg: InstantiateMsg,\n) -> StdResult<Response> {\n    store_config(\n        deps.storage,\n        &Config {\n            gov_contract: deps.api.addr_canonicalize(&msg.gov_contract)?,\n            anchor_token: deps.api.addr_canonicalize(&msg.anchor_token)?,\n            spend_limit: msg.spend_limit,\n        },\n    )?;\n\n    Ok(Response::default())\n}\n\n#[cfg_attr(not(feature = \"library\"), entry_point)]\npub fn execute(\n    deps: DepsMut,\n    _env: Env,\n    info: MessageInfo,\n    msg: ExecuteMsg,\n) -> StdResult<Response> {\n    match msg {\n        ExecuteMsg::UpdateConfig { spend_limit } => update_config(deps, info, spend_limit),\n        ExecuteMsg::Spend { recipient, amount } => spend(deps, info, recipient, amount),\n    }\n}\n\npub fn update_config(\n    deps: DepsMut,\n    info: MessageInfo,\n    spend_limit: Option<Uint128>,\n) -> StdResult<Response> {\n    let mut config: Config = read_config(deps.storage)?;\n    if config.gov_contract != deps.api.addr_canonicalize(info.sender.as_str())? {\n        return Err(StdError::generic_err(\"unauthorized\"));\n    }\n\n    if let Some(spend_limit) = spend_limit {\n        config.spend_limit = spend_limit;\n    }\n\n    store_config(deps.storage, &config)?;\n\n    Ok(Response::new().add_attributes(vec![(\"action\", \"update_config\")]))\n}\n\n/// Spend\n/// Owner can execute spend operation to send\n/// `amount` of ANC token to `recipient` for community purpose\npub fn spend(\n    deps: DepsMut,\n    info: MessageInfo,\n    recipient: String,\n    amount: Uint128,\n) -> StdResult<Response> {\n    let config: Config = read_config(deps.storage)?;\n    if config.gov_contract != deps.api.addr_canonicalize(info.sender.as_str())? {\n        return Err(StdError::generic_err(\"unauthorized\"));\n    }\n\n    if config.spend_limit < amount {\n        return Err(StdError::generic_err(\"Cannot spend more than spend_limit\"));\n    }\n\n    let anchor_token = deps.api.addr_humanize(&config.anchor_token)?.to_string();\n    Ok(Response::new()\n        .add_messages(vec![CosmosMsg::Wasm(WasmMsg::Execute {\n            contract_addr: anchor_token,\n            funds: vec![],\n            msg: to_binary(&Cw20ExecuteMsg::Transfer {\n                recipient: recipient.clone(),\n                amount,\n            })?,\n        })])\n        .add_attributes(vec![\n            (\"action\", \"spend\"),\n            (\"recipient\", recipient.as_str()),\n            (\"amount\", &amount.to_string()),\n        ]))\n}\n\n#[cfg_attr(not(feature = \"library\"), entry_point)]\npub fn query(deps: Deps, _env: Env, msg: QueryMsg) -> StdResult<Binary> {\n    match msg {\n        QueryMsg::Config {} => to_binary(&query_config(deps)?),\n    }\n}\n\npub fn query_config(deps: Deps) -> StdResult<ConfigResponse> {\n    let state = read_config(deps.storage)?;\n    let resp = ConfigResponse {\n        gov_contract: deps.api.addr_humanize(&state.gov_contract)?.to_string(),\n        anchor_token: deps.api.addr_humanize(&state.anchor_token)?.to_string(),\n        spend_limit: state.spend_limit,\n    };\n\n    Ok(resp)\n}\n\n#[cfg_attr(not(feature = \"library\"), entry_point)]\npub fn migrate(_deps: DepsMut, _env: Env, _msg: MigrateMsg) -> StdResult<Response> {\n    Ok(Response::default())\n}"
    }
  ]
}