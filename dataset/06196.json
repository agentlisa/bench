{
  "Title": "[M-08] An attacker can front-run `deployVault` to deploy at the same address",
  "Content": "\nVaults are created from the factory via `CREATE1`. An attacker can front-run `deployVault` to deploy at the same address, but with different config. If the deployed chain reorg, a different vault might also be deployed at the same address.\n\n### Proof of Concept\n\n<https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L67-L78>\n\n1.  Bob setup a bot to monitor the `mempool` when PT deploys a new vault.\n2.  Bob's bot saw a deployment by PT at `0x1234` and fires a tx to deposit immediately.\n3.  Alice front-runs PT's deployment by deploying a malicious vault at `0x1234`.\n4.  Bob's transaction ended up deposited into Alice's malicious vault.\n\n### Recommended Mitigation Steps\n\nUse `CREATE2` and the vault config as salt.\n\n### Assessed type\n\nMEV\n\n**[asselstine (PoolTogether) disputed and commented](https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416#issuecomment-1644728305):**\n > The Vault address is a derivative of the (sender address, nonce).  I don't see how this scenario is possible?\n\n**[Picodes (judge) commented](https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416#issuecomment-1666992892):**\n > @asselstine - exactly. Here, it only depends on the nonce of the factory; so in case of reorg, someone could \"override\" a vault deployment and all following transactions would still be executed.\n\n**[PoolTogether mitigated](https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs):**\n> Used `CREATE2` for `VaultFactory`.<br>\n> PR: https://github.com/GenerationSoftware/pt-v5-vault/pull/25\n\n**Status**: Mitigation confirmed. Full details in reports from [dirk\\_y](https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/14), [rvierdiiev](https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/48) and [0xStalin](https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/82).\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-07-pooltogether",
  "Code": [
    {
      "filename": "src/VaultFactory.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.17;\n\nimport { IERC20, IERC4626 } from \"openzeppelin/token/ERC20/extensions/ERC4626.sol\";\n\nimport { LiquidationPair } from \"v5-liquidator/LiquidationPair.sol\";\nimport { PrizePool } from \"v5-prize-pool/PrizePool.sol\";\nimport { TwabController } from \"v5-twab-controller/TwabController.sol\";\n\nimport { Vault } from \"./Vault.sol\";\n\n/**\n * @title  PoolTogether V5 Vault Factory\n * @author PoolTogether Inc Team, Generation Software Team\n * @notice Factory contract for deploying new vaults using a standard underlying ERC4626 yield vault.\n */\ncontract VaultFactory {\n  /* ============ Events ============ */\n\n  /**\n   * @notice Emitted when a new Vault has been deployed by this factory.\n   * @param vault Address of the vault that was deployed\n   * @param vaultFactory Address of the VaultFactory that deployed `vault`\n   */\n  event NewFactoryVault(Vault indexed vault, VaultFactory indexed vaultFactory);\n\n  /* ============ Variables ============ */\n\n  /// @notice List of all vaults deployed by this factory.\n  Vault[] public allVaults;\n\n  /**\n   * @notice Mapping to verify if a Vault has been deployed via this factory.\n   * @dev Vault address => boolean\n   */\n  mapping(Vault => bool) public deployedVaults;\n\n  /* ============ External Functions ============ */\n\n  /**\n   * @notice Deploy a new vault\n   * @dev `claimer` can be set to address zero if none is available yet.\n   * @param _asset Address of the underlying asset used by the vault\n   * @param _name Name of the ERC20 share minted by the vault\n   * @param _symbol Symbol of the ERC20 share minted by the vault\n   * @param _twabController Address of the TwabController used to keep track of balances\n   * @param _yieldVault Address of the ERC4626 vault in which assets are deposited to generate yield\n   * @param _prizePool Address of the PrizePool that computes prizes\n   * @param _claimer Address of the claimer\n   * @param _yieldFeeRecipient Address of the yield fee recipient\n   * @param _yieldFeePercentage Yield fee percentage\n   * @param _owner Address that will gain ownership of this contract\n   * @return address Address of the newly deployed Vault\n   */\n  function deployVault(\n    IERC20 _asset,\n    string memory _name,\n    string memory _symbol,\n    TwabController _twabController,\n    IERC4626 _yieldVault,\n    PrizePool _prizePool,\n    address _claimer,\n    address _yieldFeeRecipient,\n    uint256 _yieldFeePercentage,\n    address _owner\n  ) external returns (address) {\n    Vault _vault = new Vault(\n      _asset,\n      _name,\n      _symbol,\n      _twabController,\n      _yieldVault,\n      _prizePool,\n      _claimer,\n      _yieldFeeRecipient,\n      _yieldFeePercentage,\n      _owner\n    );\n\n    allVaults.push(_vault);\n    deployedVaults[_vault] = true;\n\n    emit NewFactoryVault(_vault, VaultFactory(address(this)));\n\n    return address(_vault);\n  }\n\n  /**\n   * @notice Total number of vaults deployed by this factory.\n   * @return uint256 Number of vaults deployed by this factory.\n   */\n  function totalVaults() external view returns (uint256) {\n    return allVaults.length;\n  }\n}"
    }
  ]
}