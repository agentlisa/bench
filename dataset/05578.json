{
  "Title": "[M-10] Due to extremely short `votingDelay` and `votingPeriod`, governance is practically impossible",
  "Content": "\n<https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/gov/ODGovernor.sol#L41> \n\n<https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/gov/ODGovernor.sol#L31-L41>\n\nIt is practically impossible for enough users to vote within a voting period of 4 seconds from the voting start time.\n\n### Proof of Concept\n\nThe problem lies in the `votingDelay` and `votingPeriod` that are set in the ODGovernor.sol this way.\n\n    contract ODGovernor is\n      Governor,\n      GovernorSettings,\n      GovernorCompatibilityBravo,\n      GovernorVotes,\n      GovernorVotesQuorumFraction,\n      GovernorTimelockControl\n    {\n    ...\n    constructor(\n        address _token,\n        TimelockController _timelock\n      )\n        Governor('ODGovernor')//@audit larger voting delay gives users the time to unstake tokens if necessary.\n        GovernorSettings(1, 15, 0)//@audit voting period 15blocks too small and no function to update. quorum will never be reached.\n        GovernorVotes(IVotes(_token))\n        GovernorVotesQuorumFraction(3)\n        GovernorTimelockControl(_timelock)\n      {}//@audit votingPeriod: how long does a proposal remain open to votes.\n    ...\n    }\n\nIn the constructor above the GovernorSettings constructor is used to set the votingDelay and votingPeriod.\n\n```solidity\nGovernorSettings(initialVotingDelay, initialVotingPeriod, initialProposalThreshold) measured in blocks\nGovernorSettings(1, 15, 0)\n```\n\nThe voting delay and voting period are measured in blocks. Since this project is built \\`specifically for Arbitrum, we will consider Arbitrum particularly to set this values.\n\n*   The average `blocktime` on `arbitrum` is `0.26 seconds`.\n*   so setting 1 voting delay in the code above implies that there is just 0.26 seconds delay from proposal to voting start time.\n*   And setting `15` voting period above implies that users have just 15 &ast; 0.26 = `3.9 seconds` to cast their vote.\n\nIt will be more practical to set atleast 1 day voting delay and atleast 1 week voting period as set in OZ governance examples.<br>\nTo convert these times to blocks on Arbitrum based on 0.26 secs avg blocktime:<br>\n1 day = 86400 / 0.26 = \\~332, 308 blocks per day<br>\nSo 1 week will be 332, 308 &ast; 7 = 2,326,156 blocks per week.\n\nSo it will be more practical for GovernorSettings parameters to be set this way:\n\n```solidity\n//votingDelay = 1day and votingPeriod = 1week.\nGovernorSettings(332308, 2326156, 0); //particulary for Arbitrum based on block numbers.\n```\n\nCalculation reference from OZ docs: <https://docs.openzeppelin.com/contracts/4.x/governance#governor>\n\nIn the inherited OZ's Governor.sol, the voting delay and voting period are used to set each proposal's voting start time and deadline in the propose function this way.\n\n    function propose(\n            address[] memory targets,\n            uint256[] memory values,\n            bytes[] memory calldatas,\n            string memory description\n        ) public virtual override returns (uint256) {\n    ...\n     ProposalCore storage proposal = _proposals[proposalId];\n     require(proposal.voteStart.isUnset(), \"Governor: proposal already exists\");\n    uint64 snapshot = block.number.toUint64() + votingDelay().toUint64();//@audit voting delay.\n            uint64 deadline = snapshot + votingPeriod().toUint64();\n\n            proposal.voteStart.setDeadline(snapshot);\n            proposal.voteEnd.setDeadline(deadline);\n    ...\n    }\n\n### Tools Used\n\nOpenzeppelin Governance docs, OZ's smart contract wizard. \n\n<https://docs.openzeppelin.com/contracts/4.x/governance#governor>\n\n### Recommended Mitigation Steps\n\n*   Short term: Use Oz's examples but do your calculations based on Arbitrum block time:\n\n```\n\n    GovernorSettings(332308, 2326156, 0); //particulary for Arbitrum based on block numbers.\n```\n\nOZ's wizard example: <https://wizard.openzeppelin.com/#governor>\n\n*   Long term: Use latest Oz's from 4.9 and above that have time based voting instead of block number. read here: <https://docs.openzeppelin.com/contracts/4.x/governance#disclaimer>\n\n**[MiloTruck (Judge) commented](https://github.com/code-423n4/2023-10-opendollar-findings/issues/202#issuecomment-1790189096):**\n > The warden has demonstrated how the configured values for `GovernorSettings` are far too small for any effective governance to take place, since users only have ~4 seconds to cast votes. Therefore, all governor-related functionality in the `Vault721` contract will be unaccessible.\n> \n> Since this only impacts setter functions and does not affect the protocol's core functionality, I believe medium severity is appropriate.\n\n**[pi0neerpat (OpenDollar) commented](https://github.com/code-423n4/2023-10-opendollar-findings/issues/202#issuecomment-1805209209):**\n > The governance settings currently set are for testing, not production; however, finding is valid as this was not explicitly stated before the audit. Additionally, recommendation for both short and long-term solutions is appreciated.\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-10-opendollar",
  "Code": [
    {
      "filename": "src/contracts/gov/ODGovernor.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0\npragma solidity 0.8.19;\n\nimport {IVotes} from '@openzeppelin/governance/utils/IVotes.sol';\nimport {IERC165} from '@openzeppelin/utils/introspection/IERC165.sol';\nimport {IGovernor} from '@openzeppelin/governance/IGovernor.sol';\n\nimport {TimelockController} from '@openzeppelin/governance/TimelockController.sol';\n\nimport {Governor} from '@openzeppelin/governance/Governor.sol';\nimport {GovernorSettings} from '@openzeppelin/governance/extensions/GovernorSettings.sol';\nimport {GovernorCompatibilityBravo} from '@openzeppelin/governance/compatibility/GovernorCompatibilityBravo.sol';\nimport {GovernorVotes} from '@openzeppelin/governance/extensions/GovernorVotes.sol';\nimport {GovernorVotesQuorumFraction} from '@openzeppelin/governance/extensions/GovernorVotesQuorumFraction.sol';\nimport {GovernorTimelockControl} from '@openzeppelin/governance/extensions/GovernorTimelockControl.sol';\n\ncontract ODGovernor is\n  Governor,\n  GovernorSettings,\n  GovernorCompatibilityBravo,\n  GovernorVotes,\n  GovernorVotesQuorumFraction,\n  GovernorTimelockControl\n{\n  /**\n   *\n   * @param _token is protocolToken (Open Dollar Governance, ODG)\n   * @param _timelock grace period to allow rage quit between proposal success and execution\n   *\n   * Governor(name)\n   * GovernorSettings(initialVotingDelay, initialVotingPeriod, initialProposalThreshold) measured in blocks\n   * GovernorVotes(protocolToken)\n   * GovernorVotesQuorumFraction(percentage-to-pass-quorum)\n   * GovernorTimelockControl(timelock-contract)\n   */\n  constructor(\n    address _token,\n    TimelockController _timelock\n  )\n    Governor('ODGovernor')\n    GovernorSettings(1, 15, 0)\n    GovernorVotes(IVotes(_token))\n    GovernorVotesQuorumFraction(3)\n    GovernorTimelockControl(_timelock)\n  {}\n\n  /**\n   * @dev - below are required override functions -\n   *\n   * inherit: GovernorSettings\n   */\n  function votingDelay() public view override(IGovernor, GovernorSettings) returns (uint256) {\n    return super.votingDelay();\n  }\n\n  /**\n   * inherit: GovernorSettings\n   */\n  function votingPeriod() public view override(IGovernor, GovernorSettings) returns (uint256) {\n    return super.votingPeriod();\n  }\n\n  /**\n   * inherit: GovernorVotesQuorumFraction\n   */\n  function quorum(uint256 blockNumber) public view override(IGovernor, GovernorVotesQuorumFraction) returns (uint256) {\n    return super.quorum(blockNumber);\n  }\n\n  /**\n   * inherit: Governor, GovernorTimelockControl\n   */\n  function state(uint256 proposalId)\n    public\n    view\n    override(Governor, IGovernor, GovernorTimelockControl)\n    returns (ProposalState)\n  {\n    return super.state(proposalId);\n  }\n\n  /**\n   * inherit: Governor, GovernorCompatibilityBravo\n   */\n  function propose(\n    address[] memory targets,\n    uint256[] memory values,\n    bytes[] memory calldatas,\n    string memory description\n  ) public override(Governor, GovernorCompatibilityBravo, IGovernor) returns (uint256) {\n    return super.propose(targets, values, calldatas, description);\n  }\n\n  /**\n   * inherit: Governor, GovernorSettings\n   */\n  function proposalThreshold() public view override(Governor, GovernorSettings) returns (uint256) {\n    return super.proposalThreshold();\n  }\n\n  /**\n   * inherit: Governor, GovernorTimelockControl\n   */\n  function _execute(\n    uint256 proposalId,\n    address[] memory targets,\n    uint256[] memory values,\n    bytes[] memory calldatas,\n    bytes32 descriptionHash\n  ) internal override(Governor, GovernorTimelockControl) {\n    super._execute(proposalId, targets, values, calldatas, descriptionHash);\n  }\n\n  /**\n   * inherit: Governor, GovernorTimelockControl\n   */\n  function _cancel(\n    address[] memory targets,\n    uint256[] memory values,\n    bytes[] memory calldatas,\n    bytes32 descriptionHash\n  ) internal override(Governor, GovernorTimelockControl) returns (uint256) {\n    return super._cancel(targets, values, calldatas, descriptionHash);\n  }\n\n  /**\n   * inherit: Governor, GovernorTimelockControl\n   */\n  function _executor() internal view override(Governor, GovernorTimelockControl) returns (address) {\n    return super._executor();\n  }\n\n  /**\n   * inherit: Governor, GovernorTimelockControl\n   */\n  function supportsInterface(bytes4 interfaceId)\n    public\n    view\n    override(Governor, IERC165, GovernorTimelockControl)\n    returns (bool)\n  {\n    return super.supportsInterface(interfaceId);\n  }\n}"
    }
  ]
}