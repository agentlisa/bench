{
  "Title": "[M-06] `BaseBranchRouter._transferAndApproveToken` may revert in some cases",
  "Content": "\nIn [the bot-report.md for [M-04] Return values of `approve()` not checked](https://github.com/code-423n4/2023-09-maia/blob/main/bot-report.md), it describes that \"by not checking the return value, operations that should have marked as failed, may potentially go through without actually approving anything\", but the following contents of this submission is different.\n\nIf the token's `approve` does not return a value, like [USDT](https://etherscan.io/token/0xdac17f958d2ee523a2206206994597c13d831ec7#code#L199), then `ERC20(_token).approve` will revert. Because ERC20 comes from solmate/tokens/ERC20.sol, its `approve` is defined as `function approve(address spender, uint256 amount) public virtual returns (bool)` where the return value is bool type with a size of 1 byte. The bytecode compiled by the solidity compiler from `ERC20(_token).approve` will check whether the return size is 1 byte. If not, revert will occur.\n\nThis will cause all functions calling `_transferAndApproveToken` to revert. This includes [callOutAndBridge](https://github.com/code-423n4/2023-09-maia/blob/main/src/BaseBranchRouter.sol#L88) and [callOutAndBridgeMultiple](https://github.com/code-423n4/2023-09-maia/blob/main/src/BaseBranchRouter.sol#L104).\n\n### Proof of Concept\n\n```solidity\nFile: src\\BaseBranchRouter.sol\n160:     function _transferAndApproveToken(address _hToken, address _token, uint256 _amount, uint256 _deposit) internal {\n......\n173:         if (_deposit > 0) {\n174:             _token.safeTransferFrom(msg.sender, address(this), _deposit);\n175:->           ERC20(_token).approve(_localPortAddress, _deposit);\n176:         }\n177:     }\n```\n\nL175, the compiled code of `ERC20(_token).approve(_localPortAddress, _deposit)` is similar to the following:\n\n```solidity\n(bool ret, bytes data) = _token.call(abi.encodeWithSignature(\"approve(address,uint256)\", _localPortAddress, _deposit);\nif (ret) {\n     if (data.length != 1) // since usdt.approve has no return value, so data.length = 0\n     {\n            revert;\n     }\n     return abi.decode(data, (bool));\n} else {\n     revert;\n}\n```\n\nCopy the coded POC below to one project from Foundry and run `forge test -vvv` to prove this issue:\n\n```solidity\n// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.10;\n\nimport \"forge-std/Test.sol\";\nimport \"solmate/tokens/ERC20.sol\";\nimport {SafeTransferLib} from \"solmate/utils/SafeTransferLib.sol\";\n\ninterface CheatCodes {\n    function prank(address) external;\n    function createSelectFork(string calldata,uint256) external returns(uint256);\n}\n\ninterface IUSDT {\n    function approve(address, uint256) external;\n}\n\ncontract ContractTest is DSTest{\n\n    address USDT = 0xdAC17F958D2ee523a2206206994597C13D831ec7;\n    CheatCodes cheats = CheatCodes(0x7109709ECfa91a80626fF3989D68f67F5b1DD12D);\n\n    function setUp() public {\n        cheats.createSelectFork(\"https://rpc.ankr.com/eth\", 18283438);\n    }\n\n    function test() public {\n        address user = address(0x12399543949349);\n        cheats.prank(user);\n        ERC20(USDT).approve(address(0x1111111111), 1000e6);\n    }\n\n    function testOkByIUSDT() public {\n        address user = address(0x12399543949349);\n        cheats.prank(user);\n        IUSDT(USDT).approve(address(0x1111111111), 1000e6);\n    }\n\n    function testOkBySafeApprove() public {\n        address user = address(0x12399543949349);\n        cheats.prank(user);\n        SafeTransferLib.safeApprove(ERC20(USDT), address(0x1111111111), 1000e6);\n    }\n}\n\n/**output\nRunning 3 tests for src/test/usdtApprove.sol:ContractTest\n[FAIL. Reason: EvmError: Revert] test() (gas: 37109)\nTraces:\n  [37109] ContractTest::test()\n    ├─ [0] VM::prank(0x0000000000000000000000000012399543949349)\n    │   └─ ← ()\n    ├─ [26953] 0xdAC17F958D2ee523a2206206994597C13D831ec7::approve(0x0000000000000000000000000000001111111111, 1000000000)\n    │   ├─ emit Approval(owner: 0x0000000000000000000000000012399543949349, spender: 0x0000000000000000000000000000001111111111, value: 1000000000)  \n    │   └─ ← ()\n    └─ ← \"EvmError: Revert\"\n\n[PASS] testOkByIUSDT() (gas: 37113)\n[PASS] testOkBySafeApprove() (gas: 36988)\nTest result: FAILED. 2 passed; 1 failed; finished in 489.70ms\n**/\n```\n\n### Recommended Mitigation Steps\n\nUse `safeApprove` from solady/utils/SafeTransferLib.sol.\n\n```\nFile: src\\BaseBranchRouter.sol\n160:     function _transferAndApproveToken(address _hToken, address _token, uint256 _amount, uint256 _deposit) internal {\n......\n173:         if (_deposit > 0) {\n174:             _token.safeTransferFrom(msg.sender, address(this), _deposit);\n175:-            ERC20(_token).approve(_localPortAddress, _deposit);\n175:+            ERC20(_token).safeApprove(_localPortAddress, _deposit);\n176:         }\n177:     }\n```\n\n### Assessed type\n\nDoS\n\n**[alcueca (judge) commented](https://github.com/code-423n4/2023-09-maia-findings/issues/520#issuecomment-1774000730):**\n > Out of Scope - USDT reverts because it needs to approve to zero first, which is also in the [bot report](https://github.com/code-423n4/2023-09-maia/blob/main/bot-report.md#l15-approvesafeapprove-may-revert-if-the-current-approval-is-not-zero).\n\n\n**[nobody2018 (warden) commented](https://github.com/code-423n4/2023-09-maia-findings/issues/520#issuecomment-1786406283):**\n > The issue described in this report is **not** about approving to zero first, **but** the difference between `usdt.approve` and `ERC20.approve` signatures:<br>\n> 1. `usdt.approve` is defined as follows:<br>\n> `function approve(address _spender, uint _value) public;`<br>\n> 2. `ERC20.approve` is defined as follows:<br>\n> `function approve(address spender, uint256 amount) public virtual returns (bool);`\n>\n> This will lead to different opcodes compiled by the compiler. When checking the length of the return data, `usdt.approve` requires the length of the return data to be 0, while `ERC20.approve` requires the length of the return data to be 1. Therefore, tx always reverts.\n>\n> The POC of this report is to prove this issue, not approve to zero first.\n\n**[alcueca (judge) commented](https://github.com/code-423n4/2023-09-maia-findings/issues/520#issuecomment-1792128386):**\n > Note that while this deviation from the standard only happens on the mainnet variant of USDT, and [not on the Arbitrum one](https://arbiscan.io/address/0xf31e1ae27e7cd057c1d6795a5a083e0453d39b50#code), it is likely that the protocol would be extended with branches to mainnet. Non-adherence to the ERC20 standard in the case of mainnet USDT can't be considered a poisoned token, and therefore the Medium severity is sustained.\n\n\n**[0xBugsy (Maia) commented](https://github.com/code-423n4/2023-09-maia-findings/issues/520#issuecomment-1807197653):**\n > Addressed [here](https://github.com/Maia-DAO/2023-09-maia-remediations/commit/cbdd6e25ce9c4190282eb6ebf8f3c1425d1236aa).\n\n**[0xBugsy (Maia) confirmed](https://github.com/code-423n4/2023-09-maia-findings/issues/520#issuecomment-1829649027)**\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-09-maia",
  "Code": [
    {
      "filename": "src/BaseBranchRouter.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport {Ownable} from \"solady/auth/Ownable.sol\";\nimport {SafeTransferLib} from \"solady/utils/SafeTransferLib.sol\";\n\nimport {ERC20} from \"solmate/tokens/ERC20.sol\";\n\nimport {IBranchRouter} from \"./interfaces/IBranchRouter.sol\";\n\nimport {\n    IBranchBridgeAgent as IBridgeAgent,\n    GasParams,\n    Deposit,\n    DepositInput,\n    DepositParams,\n    DepositMultipleInput,\n    DepositMultipleParams,\n    SettlementParams,\n    SettlementMultipleParams\n} from \"./interfaces/IBranchBridgeAgent.sol\";\n\n/// @title Base Branch Router Contract\n/// @author MaiaDAO\ncontract BaseBranchRouter is IBranchRouter, Ownable {\n    using SafeTransferLib for address;\n\n    /*///////////////////////////////////////////////////////////////\n                    BASE BRANCH ROUTER STATE\n    //////////////////////////////////////////////////////////////*/\n\n    /// @inheritdoc IBranchRouter\n    address public localPortAddress;\n\n    /// @inheritdoc IBranchRouter\n    address public override localBridgeAgentAddress;\n\n    /// @inheritdoc IBranchRouter\n    address public override bridgeAgentExecutorAddress;\n\n    /// @notice Re-entrancy lock modifier state.\n    uint256 internal _unlocked = 1;\n\n    /*///////////////////////////////////////////////////////////////\n                            CONSTRUCTOR\n    //////////////////////////////////////////////////////////////*/\n\n    constructor() {\n        _initializeOwner(msg.sender);\n    }\n\n    /*///////////////////////////////////////////////////////////////\n                    INITIALIZATION FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /**\n     * @notice Initializes the Base Branch Router.\n     * @param _localBridgeAgentAddress The address of the local Bridge Agent.\n     */\n    function initialize(address _localBridgeAgentAddress) external onlyOwner {\n        require(_localBridgeAgentAddress != address(0), \"Bridge Agent address cannot be 0\");\n        localBridgeAgentAddress = _localBridgeAgentAddress;\n        localPortAddress = IBridgeAgent(_localBridgeAgentAddress).localPortAddress();\n        bridgeAgentExecutorAddress = IBridgeAgent(_localBridgeAgentAddress).bridgeAgentExecutorAddress();\n        \n        renounceOwnership();\n    }\n\n    /*///////////////////////////////////////////////////////////////\n                        VIEW FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /// @inheritdoc IBranchRouter\n    function getDepositEntry(uint32 _depositNonce) external view override returns (Deposit memory) {\n        return IBridgeAgent(localBridgeAgentAddress).getDepositEntry(_depositNonce);\n    }\n\n    /*///////////////////////////////////////////////////////////////\n                        EXTERNAL FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /// @inheritdoc IBranchRouter\n    function callOut(bytes calldata _params, GasParams calldata _gParams) external payable override lock {\n        IBridgeAgent(localBridgeAgentAddress).callOut{value: msg.value}(payable(msg.sender), _params, _gParams);\n    }\n\n    /// @inheritdoc IBranchRouter\n    function callOutAndBridge(bytes calldata _params, DepositInput calldata _dParams, GasParams calldata _gParams)\n        external\n        payable\n        override\n        lock\n    {\n        //Transfer tokens to this contract.\n        _transferAndApproveToken(_dParams.hToken, _dParams.token, _dParams.amount, _dParams.deposit);\n\n        //Perform call to bridge agent.\n        IBridgeAgent(localBridgeAgentAddress).callOutAndBridge{value: msg.value}(\n            payable(msg.sender), _params, _dParams, _gParams\n        );\n    }\n\n    /// @inheritdoc IBranchRouter\n    function callOutAndBridgeMultiple(\n        bytes calldata _params,\n        DepositMultipleInput calldata _dParams,\n        GasParams calldata _gParams\n    ) external payable override lock {\n        //Transfer tokens to this contract.\n        _transferAndApproveMultipleTokens(_dParams.hTokens, _dParams.tokens, _dParams.amounts, _dParams.deposits);\n\n        //Perform call to bridge agent.\n        IBridgeAgent(localBridgeAgentAddress).callOutAndBridgeMultiple{value: msg.value}(\n            payable(msg.sender), _params, _dParams, _gParams\n        );\n    }\n\n    /*///////////////////////////////////////////////////////////////\n                BRIDGE AGENT EXECUTOR EXTERNAL FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /// @inheritdoc IBranchRouter\n    function executeNoSettlement(bytes calldata) external payable virtual override requiresAgentExecutor {\n        revert UnrecognizedFunctionId();\n    }\n\n    /// @inheritdoc IBranchRouter\n    function executeSettlement(bytes calldata, SettlementParams memory)\n        external\n        payable\n        virtual\n        override\n        requiresAgentExecutor\n    {\n        revert UnrecognizedFunctionId();\n    }\n\n    /// @inheritdoc IBranchRouter\n    function executeSettlementMultiple(bytes calldata, SettlementMultipleParams memory)\n        external\n        payable\n        virtual\n        override\n        requiresAgentExecutor\n    {\n        revert UnrecognizedFunctionId();\n    }\n\n    /*///////////////////////////////////////////////////////////////\n                            INTERNAL FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /**\n     * @notice Internal function to transfer token into a contract.\n     *   @param _hToken The address of the hToken.\n     *   @param _token The address of the token.\n     *   @param _amount The amount of the hToken.\n     *   @param _deposit The amount of the token.\n     */\n    function _transferAndApproveToken(address _hToken, address _token, uint256 _amount, uint256 _deposit) internal {\n        // Cache local port address\n        address _localPortAddress = localPortAddress;\n\n        // Check if the local branch tokens are being spent\n        if (_amount - _deposit > 0) {\n            unchecked {\n                _hToken.safeTransferFrom(msg.sender, address(this), _amount - _deposit);\n                ERC20(_hToken).approve(_localPortAddress, _amount - _deposit);\n            }\n        }\n\n        // Check if the underlying tokens are being spent\n        if (_deposit > 0) {\n            _token.safeTransferFrom(msg.sender, address(this), _deposit);\n            ERC20(_token).approve(_localPortAddress, _deposit);\n        }\n    }\n\n    /**\n     * @notice Internal function to transfer multiple tokens into a contract.\n     *   @param _hTokens The addresses of the hTokens.\n     *   @param _tokens The addresses of the tokens.\n     *   @param _amounts The amounts of the hTokens.\n     *   @param _deposits The amounts of the tokens.\n     */\n    function _transferAndApproveMultipleTokens(\n        address[] memory _hTokens,\n        address[] memory _tokens,\n        uint256[] memory _amounts,\n        uint256[] memory _deposits\n    ) internal {\n        for (uint256 i = 0; i < _hTokens.length;) {\n            _transferAndApproveToken(_hTokens[i], _tokens[i], _amounts[i], _deposits[i]);\n\n            unchecked {\n                ++i;\n            }\n        }\n    }\n\n    /*///////////////////////////////////////////////////////////////\n                                MODIFIERS\n    //////////////////////////////////////////////////////////////*/\n\n    /// @notice Modifier that verifies msg sender is the Bridge Agent Executor.\n    modifier requiresAgentExecutor() {\n        if (msg.sender != bridgeAgentExecutorAddress) revert UnrecognizedBridgeAgentExecutor();\n        _;\n    }\n\n    /// @notice Modifier for a simple re-entrancy check.\n    modifier lock() {\n        require(_unlocked == 1);\n        _unlocked = 2;\n        _;\n        _unlocked = 1;\n    }\n}"
    },
    {
      "filename": "bot-report.md",
      "content": "**Note:** There is a section for disputed findings below the usual findings sections\r\n\r\n## Summary\r\n\r\n### Medium Risk Issues\r\n\r\n| |Issue|Instances|\r\n|-|:-|:-:|\r\n| [[M&#x2011;01](#m01-unchecked-return-value-of-low-level-calldelegatecall)] | Unchecked return value of low-level `call()`/`delegatecall()` | 3 | \r\n| [[M&#x2011;02](#m02-use-of-transferfrom-rather-than-safetransferfrom-for-nfts-in-will-lead-to-the-loss-of-nfts)] | Use of `transferFrom()` rather than `safeTransferFrom()` for NFTs in will lead to the loss of NFTs | 1 | \r\n| [[M&#x2011;03](#m03-the-owner-is-a-single-point-of-failure-and-a-centralization-risk)] | The `owner` is a single point of failure and a centralization risk | 38 | \r\n| [[M&#x2011;04](#m04-return-values-of-approve-not-checked)] | Return values of `approve()` not checked | 1 | \r\n\r\nTotal: 43 instances over 4 issues\r\n\r\n### Low Risk Issues\r\n\r\n| |Issue|Instances|\r\n|-|:-|:-:|\r\n| [[L&#x2011;01](#l01-addstrategytoken-does-note-remove-old-entries-before-adding-new-ones)] | `addStrategyToken()` does note remove old entries before adding new ones | 2 | \r\n| [[L&#x2011;02](#l02-unsafe-downcast)] | Unsafe downcast | 8 | \r\n| [[L&#x2011;03](#l03-array-lengths-not-checked)] | Array lengths not checked | 1 | \r\n| [[L&#x2011;04](#l04-receivepayable-fallback-function-does-not-authorize-requests)] | `receive()`/`payable fallback()` function does not authorize requests | 3 | \r\n| [[L&#x2011;05](#l05-safeapprove-is-deprecated)] | `safeApprove()` is deprecated | 2 | \r\n| [[L&#x2011;06](#l06-use-ownable2step-rather-than-ownable)] | Use `Ownable2Step` rather than `Ownable` | 12 | \r\n| [[L&#x2011;07](#l07-empty-receivefallback-function)] | Empty `receive()`/`fallback()` function | 3 | \r\n| [[L&#x2011;08](#l08-external-calls-in-an-un-bounded-for-loop-may-result-in-a-dos)] | External calls in an un-bounded `for-`loop may result in a DOS | 4 | \r\n| [[L&#x2011;09](#l09-consider-implementing-two-step-procedure-for-updating-protocol-addresses)] | Consider implementing two-step procedure for updating protocol addresses | 10 | \r\n| [[L&#x2011;10](#l10-name-is-not-a-part-of-the-erc-20-standard)] | `name()` is not a part of the ERC-20 standard | 5 | \r\n| [[L&#x2011;11](#l11-symbol-is-not-a-part-of-the-erc-20-standard)] | `symbol()` is not a part of the ERC-20 standard | 5 | \r\n| [[L&#x2011;12](#l12-decimals-is-not-a-part-of-the-erc-20-standard)] | `decimals()` is not a part of the ERC-20 standard | 4 | \r\n| [[L&#x2011;13](#l13-safetransferlib-does-not-ensure-that-the-token-contract-exists)] | `SafeTransferLib` does not ensure that the token contract exists | 2 | \r\n| [[L&#x2011;14](#l14-functions-calling-contractsaddresses-with-transfer-hooks-are-missing-reentrancy-guards)] | Functions calling contracts/addresses with transfer hooks are missing reentrancy guards | 1 | \r\n| [[L&#x2011;15](#l15-approvesafeapprove-may-revert-if-the-current-approval-is-not-zero)] | `approve()`/`safeApprove()` may revert if the current approval is not zero | 3 | \r\n| [[L&#x2011;16](#l16-external-call-recipient-may-consume-all-transaction-gas)] | External call recipient may consume all transaction gas | 8 | \r\n| [[L&#x2011;17](#l17-missing-contract-existence-checks-before-low-level-calls)] | Missing contract-existence checks before low-level calls | 4 | \r\n| [[L&#x2011;18](#l18-code-does-not-follow-the-best-practice-of-check-effects-interaction)] | Code does not follow the best practice of check-effects-interaction | 43 | \r\n| [[L&#x2011;19](#l19-missing-checks-for-address0x0-in-the-constructorinitializer)] | Missing checks for `address(0x0)` in the constructor/initializer | 7 | \r\n| [[L&#x2011;20](#l20-missing-checks-for-address0x0-when-updating-address-state-variables)] | Missing checks for `address(0x0)` when updating `address` state variables | 1 | \r\n| [[L&#x2011;21](#l21-state-variables-not-capped-at-reasonable-values)] | State variables not capped at reasonable values | 2 | \r\n| [[L&#x2011;22](#l22-tokens-may-be-minted-to-address0x0)] | Tokens may be minted to `address(0x0)` | 2 | \r\n| [[L&#x2011;23](#l23-initialization-can-be-front-run)] | Initialization can be front-run | 8 | \r\n\r\nTotal: 140 instances over 23 issues\r\n\r\n### Non-critical Issues\r\n\r\n| |Issue|Instances|\r\n|-|:-|:-:|\r\n| [[N&#x2011;01](#n01-public-functions-not-called-by-the-contract-should-be-declared-external-instead)] | `public` functions not called by the contract should be declared `external` instead | 6 | \r\n| [[N&#x2011;02](#n02-event-is-not-properly-indexed)] | Event is not properly `indexed` | 1 | \r\n| [[N&#x2011;03](#n03-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function)] | Duplicated `require()`/`revert()` checks should be refactored to a modifier or function | 12 | \r\n| [[N&#x2011;04](#n04-common-functions-should-be-refactored-to-a-common-base-contract)] | Common functions should be refactored to a common base contract | 1 | \r\n| [[N&#x2011;05](#n05-import-declarations-should-import-specific-identifiers-rather-than-the-whole-file)] | Import declarations should import specific identifiers, rather than the whole file | 1 | \r\n| [[N&#x2011;06](#n06-events-that-mark-critical-parameter-changes-should-contain-both-the-old-and-the-new-value)] | Events that mark critical parameter changes should contain both the old and the new value | 6 | \r\n| [[N&#x2011;07](#n07-constant-redefined-elsewhere)] | Constant redefined elsewhere | 25 | \r\n| [[N&#x2011;08](#n08-inconsistent-spacing-in-comments)] | Inconsistent spacing in comments | 145 | \r\n| [[N&#x2011;09](#n09-lines-are-too-long)] | Lines are too long | 32 | \r\n| [[N&#x2011;10](#n10-long-functions-should-be-refactored-into-multiple-smaller-functions)] | Long functions should be refactored into multiple, smaller, functions | 13 | \r\n| [[N&#x2011;11](#n11-inconsistent-method-of-specifying-a-floating-pragma)] | Inconsistent method of specifying a floating pragma | 3 | \r\n| [[N&#x2011;12](#n12-using--without-specifying-an-upper-bound-is-unsafe)] | Using `>`/`>=` without specifying an upper bound is unsafe | 3 | \r\n| [[N&#x2011;13](#n13-typos)] | Typos | 37 | \r\n| [[N&#x2011;14](#n14-file-is-missing-natspec)] | File is missing NatSpec | 3 | \r\n| [[N&#x2011;15](#n15-function-definition-modifier-order-does-not-follow-solidity-style-guide)] | Function definition modifier order does not follow Solidity style guide | 2 | \r\n| [[N&#x2011;16](#n16-assembly-blocks-should-have-extensive-comments)] | Assembly blocks should have extensive comments | 1 | \r\n| [[N&#x2011;17](#n17-visibility-should-be-set-explicitly-rather-than-defaulting-to-internal)] | Visibility should be set explicitly rather than defaulting to `internal` | 3 | \r\n| [[N&#x2011;18](#n18-function-ordering-does-not-follow-the-solidity-style-guide)] | Function ordering does not follow the Solidity style guide | 11 | \r\n| [[N&#x2011;19](#n19-contract-does-not-follow-the-solidity-style-guides-suggested-layout-ordering)] | Contract does not follow the Solidity style guide's suggested layout ordering | 15 | \r\n| [[N&#x2011;20](#n20-add-inline-comments-for-unnamed-variables)] | Add inline comments for unnamed variables | 18 | \r\n| [[N&#x2011;21](#n21-invalid-natspec-comment-style)] | Invalid NatSpec comment style | 67 | \r\n| [[N&#x2011;22](#n22-contracts-should-have-full-test-coverage)] | Contracts should have full test coverage | 1 | \r\n| [[N&#x2011;23](#n23-large-or-complicated-code-bases-should-implement-invariant-tests)] | Large or complicated code bases should implement invariant tests | 1 | \r\n| [[N&#x2011;24](#n24-consider-adding-formal-verification-proofs)] | Consider adding formal verification proofs | 1 | \r\n| [[N&#x2011;25](#n25-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-for-readability)] | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, for readability | 3 | \r\n| [[N&#x2011;26](#n26-custom-errors-should-be-used-rather-than-revertrequire)] | Custom errors should be used rather than `revert()`/`require()` | 54 | \r\n| [[N&#x2011;27](#n27-use-abiencodecall-instead-of-abiencodewithsignatureabiencodewithselector)] | Use `abi.encodeCall()` instead of `abi.encodeWithSignature()`/`abi.encodeWithSelector()` | 12 | \r\n| [[N&#x2011;28](#n28-style-guide-non-externalpublic-variable-names-should-begin-with-an-underscore)] | Style guide: Non-`external`/`public` variable names should begin with an underscore | 23 | \r\n| [[N&#x2011;29](#n29-variable-names-for-immutables-should-use-constant_case)] | Variable names for `immutable`s should use CONSTANT_CASE | 39 | \r\n| [[N&#x2011;30](#n30-array-indicies-should-be-referenced-via-enums-rather-than-via-numeric-literals)] | Array indicies should be referenced via `enum`s rather than via numeric literals | 66 | \r\n| [[N&#x2011;31](#n31-consider-using-named-mappings)] | Consider using named mappings | 40 | \r\n| [[N&#x2011;32](#n32-use-of-override-is-unnecessary)] | Use of `override` is unnecessary | 117 | \r\n| [[N&#x2011;33](#n33-consider-using-descriptive-constants-when-passing-zero-as-a-function-argument)] | Consider using descriptive `constant`s when passing zero as a function argument | 4 | \r\n| [[N&#x2011;34](#n34-variables-need-not-be-initialized-to-zero)] | Variables need not be initialized to zero | 17 | \r\n| [[N&#x2011;35](#n35-requirerevert-statements-should-have-descriptive-reason-strings)] | `require()`/`revert()` statements should have descriptive reason strings | 13 | \r\n| [[N&#x2011;36](#n36-contractslibraries-should-each-be-defined-in-separate-files)] | Contracts/libraries should each be defined in separate files | 4 | \r\n| [[N&#x2011;37](#n37-contract-uses-both-requirerevert-as-well-as-custom-errors)] | Contract uses both `require()`/`revert()` as well as custom errors | 10 | \r\n| [[N&#x2011;38](#n38-contract-doesnt-handle-all-nft-types)] | Contract doesn't handle all NFT types | 2 | \r\n| [[N&#x2011;39](#n39-style-guide-non-externalpublic-function-names-should-begin-with-an-underscore)] | Style guide: Non-`external`/`public` function names should begin with an underscore | 2 | \r\n| [[N&#x2011;40](#n40-constants-should-be-defined-rather-than-using-magic-numbers)] | `constant`s should be defined rather than using magic numbers | 125 | \r\n| [[N&#x2011;41](#n41-events-are-missing-sender-information)] | Events are missing sender information | 27 | \r\n| [[N&#x2011;42](#n42-consider-adding-a-blockdeny-list)] | Consider adding a block/deny-list | 12 | \r\n| [[N&#x2011;43](#n43-consider-using-safetransferlibsafetransfereth-or-addresssendvalue-for-clearer-semantic-meaning)] | Consider using `SafeTransferLib.safeTransferETH()` or `Address.sendValue()` for clearer semantic meaning | 3 | \r\n| [[N&#x2011;44](#n44-unused-import)] | Unused import | 15 | \r\n| [[N&#x2011;45](#n45-array-is-pushed-but-not-poped)] | Array is `push()`ed but not `pop()`ed | 12 | \r\n| [[N&#x2011;46](#n46-unused-struct-definition)] | Unused `struct` definition | 1 | \r\n| [[N&#x2011;47](#n47-unused-error-definition)] | Unused `error` definition | 7 | \r\n| [[N&#x2011;48](#n48-natspec-contract-declarations-should-have-natspec-descriptions)] | NatSpec: Contract declarations should have NatSpec descriptions | 4 | \r\n| [[N&#x2011;49](#n49-natspec-contract-declarations-should-have-notice-tags)] | NatSpec: Contract declarations should have `@notice` tags | 4 | \r\n| [[N&#x2011;50](#n50-natspec-error-declarations-should-have-natspec-descriptions)] | NatSpec: Error declarations should have NatSpec descriptions | 90 | \r\n| [[N&#x2011;51](#n51-natspec-event-declarations-should-have-natspec-descriptions)] | NatSpec: Event declarations should have NatSpec descriptions | 28 | \r\n| [[N&#x2011;52](#n52-natspec-state-variable-declarations-should-have-natspec-descriptions)] | NatSpec: State variable declarations should have NatSpec descriptions | 22 | \r\n| [[N&#x2011;53](#n53-natspec-function-declarations-should-have-natspec-descriptions)] | NatSpec: Function declarations should have NatSpec descriptions | 37 | \r\n| [[N&#x2011;54](#n54-natspec-function-declarations-should-have-notice-tags)] | NatSpec: Function declarations should have `@notice` tags | 37 | \r\n| [[N&#x2011;55](#n55-constants-in-comparisons-should-appear-on-the-left-side)] | Constants in comparisons should appear on the left side | 62 | \r\n| [[N&#x2011;56](#n56-custom-error-has-no-error-details)] | Custom error has no error details | 90 | \r\n| [[N&#x2011;57](#n57-natspec-contract-declarations-should-have-author-tags)] | NatSpec: Contract declarations should have `@author` tags | 9 | \r\n| [[N&#x2011;58](#n58-natspec-contract-declarations-should-have-dev-tags)] | NatSpec: Contract declarations should have `@dev` tags | 34 | \r\n| [[N&#x2011;59](#n59-natspec-contract-declarations-should-have-title-tags)] | NatSpec: Contract declarations should have `@title` tags | 4 | \r\n| [[N&#x2011;60](#n60-empty-function-body)] | Empty function body | 1 | \r\n| [[N&#x2011;61](#n61-use-bytesconcat-on-bytes-instead-of-abiencodepacked-for-clearer-semantic-meaning)] | Use `bytes.concat()` on bytes instead of `abi.encodePacked()` for clearer semantic meaning | 14 | \r\n| [[N&#x2011;62](#n62-if-statement-can-be-converted-to-a-ternary)] | `if`-statement can be converted to a ternary | 2 | \r\n| [[N&#x2011;63](#n63-overflows-in-unchecked-blocks)] | Overflows in unchecked blocks | 15 | \r\n| [[N&#x2011;64](#n64-consider-splitting-long-calculations)] | Consider splitting long calculations | 8 | \r\n| [[N&#x2011;65](#n65-contract-should-expose-an-interface)] | Contract should expose an `interface` | 47 | \r\n| [[N&#x2011;66](#n66-else-block-not-required)] | `else`-block not required | 2 | \r\n| [[N&#x2011;67](#n67-missing-event-and-or-timelock-for-critical-parameter-change)] | Missing event and or timelock for critical parameter change | 1 | \r\n| [[N&#x2011;68](#n68-setters-should-prevent-re-setting-of-the-same-value)] | Setters should prevent re-setting of the same value | 11 | \r\n| [[N&#x2011;69](#n69-polymorphic-functions-make-security-audits-more-time-consuming-and-error-prone)] | Polymorphic functions make security audits more time-consuming and error-prone | 6 | \r\n| [[N&#x2011;70](#n70-imports-could-be-organized-more-systematically)] | Imports could be organized more systematically | 4 | \r\n| [[N&#x2011;71](#n71-use-the-latest-solidity-prior-to-0820-if-on-l2s-for-deployment)] | Use the latest solidity (prior to 0.8.20 if on L2s) for deployment | 23 | \r\n| [[N&#x2011;72](#n72-consider-moving-msgsender-checks-to-a-common-authorization-modifier)] | Consider moving `msg.sender` checks to a common authorization `modifier` | 7 | \r\n| [[N&#x2011;73](#n73-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones)] | Non-library/interface files should use fixed compiler versions, not floating ones | 23 | \r\n| [[N&#x2011;74](#n74-consider-adding-emergency-stop-functionality)] | Consider adding emergency-stop functionality | 13 | \r\n| [[N&#x2011;75](#n75-natspec-function-return-is-missing)] | NatSpec: Function `@return` is missing | 46 | \r\n| [[N&#x2011;76](#n76-natspec-function-param-is-missing)] | NatSpec: Function `@param` is missing | 111 | \r\n| [[N&#x2011;77](#n77-consider-bounding-input-array-length)] | Consider bounding input array length | 7 | \r\n| [[N&#x2011;78](#n78-named-imports-of-parent-contracts-are-missing)] | Named imports of parent contracts are missing | 1 | \r\n| [[N&#x2011;79](#n79-complex-casting)] | Complex casting | 59 | \r\n| [[N&#x2011;80](#n80-events-may-be-emitted-out-of-order-due-to-reentrancy)] | Events may be emitted out of order due to reentrancy | 7 | \r\n| [[N&#x2011;81](#n81-non-assembly-method-available)] | Non-assembly method available | 1 | \r\n| [[N&#x2011;82](#n82-missing-checks-constructorinitializer-assignments)] | Missing checks constructor/initializer assignments | 9 | \r\n\r\nTotal: 1855 instances over 82 issues\r\n\r\n### Gas Optimizations\r\n\r\n| |Issue|Instances|Total Gas Saved|\r\n|-|:-|:-:|:-:|\r\n| [[G&#x2011;01](#g01-enable-ir-based-code-generation)] | Enable IR-based code generation | 1 |  - |\r\n| [[G&#x2011;02](#g02-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate)] | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate | 5 |  - |\r\n| [[G&#x2011;03](#g03-state-variables-only-set-in-the-constructor-should-be-declared-immutable)] | State variables only set in the constructor should be declared `immutable` | 3 |  6291 |\r\n| [[G&#x2011;04](#g04-avoid-contract-existence-checks-by-using-low-level-calls)] | Avoid contract existence checks by using low-level calls | 52 |  5200 |\r\n| [[G&#x2011;05](#g05-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage)] | State variables should be cached in stack variables rather than re-reading them from storage | 1 |  97 |\r\n| [[G&#x2011;06](#g06-internal-functions-only-called-once-can-be-inlined-to-save-gas)] | `internal` functions only called once can be inlined to save gas | 14 |  280 |\r\n| [[G&#x2011;07](#g07-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-looparray)] | `<array>.length` should not be looked up in every loop of a `for`-loop | 8 |  24 |\r\n| [[G&#x2011;08](#g08-requirerevert-strings-longer-than-32-bytes-cost-extra-gas)] | `require()`/`revert()` strings longer than 32 bytes cost extra gas | 22 |  66 |\r\n| [[G&#x2011;09](#g09-optimize-names-to-save-gas)] | Optimize names to save gas | 24 |  528 |\r\n| [[G&#x2011;10](#g10-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too)] | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too) | 1 |  5 |\r\n| [[G&#x2011;11](#g11-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead)] | Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead | 21 |  462 |\r\n| [[G&#x2011;12](#g12-using-private-rather-than-public-for-constants-saves-gas)] | Using `private` rather than `public` for constants, saves gas | 12 |  - |\r\n| [[G&#x2011;13](#g13-inverting-the-condition-of-an-if-else-statement-wastes-gas)] | Inverting the condition of an `if`-`else`-statement wastes gas | 1 |  - |\r\n| [[G&#x2011;14](#g14-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function)] | `require()` or `revert()` statements that check input arguments should be at the top of the function | 11 |  - |\r\n| [[G&#x2011;15](#g15-use-custom-errors-rather-than-revertrequire-strings-to-save-gas)] | Use custom errors rather than `revert()`/`require()` strings to save gas | 49 |  - |\r\n| [[G&#x2011;16](#g16-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable)] | Functions guaranteed to revert when called by normal users can be marked `payable` | 21 |  441 |\r\n| [[G&#x2011;17](#g17-constructors-can-be-marked-payable)] | Constructors can be marked `payable` | 22 |  462 |\r\n| [[G&#x2011;18](#g18-reduce-gas-usage-by-moving-to-solidity-0819-or-later)] | Reduce gas usage by moving to Solidity 0.8.19 or later | 44 |  - |\r\n| [[G&#x2011;19](#g19--costs-less-gas-than-)] | `>=` costs less gas than `>` | 33 |  99 |\r\n| [[G&#x2011;20](#g20-nesting-if-statements-is-cheaper-than-using-)] | Nesting `if`-statements is cheaper than using `&&` | 1 |  6 |\r\n| [[G&#x2011;21](#g21-use-assembly-to-emit-events-in-order-to-save-gas)] | Use assembly to emit events, in order to save gas | 19 |  722 |\r\n| [[G&#x2011;22](#g22-use--for-mappings)] | Use `+=` for `mapping`s | 5 |  200 |\r\n| [[G&#x2011;23](#g23-using-bools-for-storage-incurs-overhead)] | Using `bool`s for storage incurs overhead | 13 |  1300 |\r\n| [[G&#x2011;24](#g24-use-uint2561uint2562-instead-of-truefalse-to-save-gas-for-changes)] | Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes | 13 |  222300 |\r\n| [[G&#x2011;25](#g25-simple-checks-for-zero-can-be-done-using-assembly-to-save-gas)] | Simple checks for zero can be done using assembly to save gas | 25 |  150 |\r\n| [[G&#x2011;26](#g26-avoid-updating-storage-when-the-value-hasnt-changed)] | Avoid updating storage when the value hasn't changed | 11 |  8800 |\r\n| [[G&#x2011;27](#g27-unchecked---can-be-used-on-the-division-of-two-uints-in-order-to-save-gas)] | `unchecked {}`  can be used on the division of two `uint`s in order to save gas | 1 |  20 |\r\n| [[G&#x2011;28](#g28-using-this-to-access-functions-results-in-an-external-call-wasting-gas)] | Using `this` to access functions results in an external call, wasting gas | 2 |  200 |\r\n| [[G&#x2011;29](#g29-use-assembly-for-small-keccak256-hashes-in-order-to-save-gas)] | Use assembly for small keccak256 hashes, in order to save gas | 1 |  80 |\r\n| [[G&#x2011;30](#g30-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas)] | Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas | 23 |  2760 |\r\n| [[G&#x2011;31](#g31-avoid-transferring-amounts-of-zero-in-order-to-save-gas)] | Avoid transferring amounts of zero in order to save gas | 10 |  1000 |\r\n| [[G&#x2011;32](#g32-avoid-fetching-a-low-level-calls-return-data-by-using-assembly)] | Avoid fetching a low-level call's return data by using assembly | 9 |  1431 |\r\n\r\nTotal: 478 instances over 32 issues with **252924 gas** saved\r\n\r\nGas totals are estimates based on data from the Ethereum Yellowpaper. The estimates use the lower bounds of ranges and count two iterations of each `for`-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions. The table above as well as its gas numbers do not include any of the excluded findings.\r\n\r\n### Disputed Issues\r\n\r\nThe issues below may be reported by other bots/wardens, but can be penalized/ignored since either the rule or the specified instances are invalid\r\n\r\n| |Issue|Instances|\r\n|-|:-|:-:|\r\n| [[D&#x2011;01](#d01-unchecked-return-value-of-low-level-calldelegatecall)] | ~~Unchecked return value of low-level `call()`/`delegatecall()`~~ | 9 | \r\n| [[D&#x2011;02](#d02-return-values-of-approve-not-checked)] | ~~Return values of `approve()` not checked~~ | 1 | \r\n| [[D&#x2011;03](#d03-unsafe-downcast)] | ~~Unsafe downcast~~ | 5 | \r\n| [[D&#x2011;04](#d04-loss-of-precision)] | ~~Loss of precision~~ | 1 | \r\n| [[D&#x2011;05](#d05-solidity-version-0820-may-not-work-on-other-chains-due-to-push0)] | ~~Solidity version 0.8.20 may not work on other chains due to `PUSH0`~~ | 44 | \r\n| [[D&#x2011;06](#d06-approvesafeapprove-may-revert-if-the-current-approval-is-not-zero)] | ~~`approve()`/`safeApprove()` may revert if the current approval is not zero~~ | 1 | \r\n| [[D&#x2011;07](#d07-missing-contract-existence-checks-before-low-level-calls)] | ~~Missing contract-existence checks before low-level calls~~ | 27 | \r\n| [[D&#x2011;08](#d08-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function-to-save-gas)] | ~~Duplicated require()/revert() checks should be refactored to a modifier Or function to save gas~~ | 12 | \r\n| [[D&#x2011;09](#d09-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function)] | ~~Duplicated `require()`/`revert()` checks should be refactored to a modifier or function~~ | 56 | \r\n| [[D&#x2011;10](#d10-spdx-identifier-should-be-the-in-the-first-line-of-a-solidity-file)] | ~~SPDX identifier should be the in the first line of a solidity file~~ | 44 | \r\n| [[D&#x2011;11](#d11-overly-complicated-arithmetic)] | ~~Overly complicated arithmetic~~ | 18 | \r\n| [[D&#x2011;12](#d12-prefer-double-quotes-for-string-quoting)] | ~~Prefer double quotes for string quoting~~ | 3 | \r\n| [[D&#x2011;13](#d13-public-functions-not-used-internally-can-be-marked-as-external-to-save-gas)] | ~~Public functions not used internally can be marked as external to save gas~~ | 6 | \r\n| [[D&#x2011;14](#d14-require--revert-statements-should-have-descriptive-reason-strings)] | ~~`require()` / `revert()` statements should have descriptive reason strings~~ | 155 | \r\n| [[D&#x2011;15](#d15-solmates-safetransferlib-doesnt-check-whether-the-erc20-contract-exists)] | ~~Solmate's SafeTransferLib doesn't check whether the ERC20 contract exists~~ | 3 | \r\n| [[D&#x2011;16](#d16-natspec-contract-declarations-should-have-notice-tags)] | ~~NatSpec: Contract declarations should have `@notice` tags~~ | 44 | \r\n| [[D&#x2011;17](#d17-event-names-should-use-camelcase)] | ~~Event names should use CamelCase~~ | 28 | \r\n| [[D&#x2011;18](#d18-unnecessary-look-up-in-if-condition)] | ~~Unnecessary look up in if condition~~ | 3 | \r\n| [[D&#x2011;19](#d19-natspec-function-declarations-should-have-notice-tags)] | ~~NatSpec: Function declarations should have `@notice` tags~~ | 305 | \r\n| [[D&#x2011;20](#d20-timestamp-may-be-manipulation)] | ~~Timestamp may be manipulation~~ | 2 | \r\n| [[D&#x2011;21](#d21-using-bitmap-to-store-bool-states-can-save-gas)] | ~~Using bitmap to store bool states can save gas~~ | 10 | \r\n| [[D&#x2011;22](#d22-all-interfaces-used-within-a-project-should-be-imported)] | ~~All interfaces used within a project should be imported~~ | 21 | \r\n| ["
    }
  ]
}