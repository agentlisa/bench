{
  "Title": "[G-06] Structs can be packed into fewer storage slots",
  "Content": "\nEach slot saved can avoid an extra Gsset (20000 gas) for the first setting of the struct and subsequent reads as well, as writes have smaller gas savings.\n\n```solidity\nFile:   src/governance/GovernorBravoInterfaces.sol\n105    struct Proposal {\n        /// @notice Unique id for looking up a proposal\n        uint256 id;\n        /// @notice Creator of the proposal\n        address proposer;\n        /// @notice The timestamp that the proposal will be available for execution, set once the vote succeeds\n        uint256 eta;\n        /// @notice the ordered list of target addresses for calls to be made\n        address[] targets;\n        /// @notice The ordered list of values (i.e. msg.value) to be passed to the calls to be made\n        uint256[] values;\n        /// @notice The ordered list of function signatures to be called\n        string[] signatures;\n        /// @notice The ordered list of calldata to be passed to each call\n        bytes[] calldatas;\n        /// @notice The block at which voting begins: holders must delegate their votes prior to this block\n        uint256 startBlock;\n        /// @notice The block at which voting ends: votes must be cast prior to this block\n        uint256 endBlock;\n        /// @notice Current number of votes in favor of this proposal\n        uint256 forVotes;\n        /// @notice Current number of votes in opposition to this proposal\n        uint256 againstVotes;\n        /// @notice Current number of votes for abstaining for this proposal\n        uint256 abstainVotes;\n        /// @notice Flag marking whether the proposal has been canceled\n        bool canceled;\n        /// @notice Flag marking whether the proposal has been executed\n        bool executed;\n        /// @notice Receipts of ballots for the entire set of voters\n        mapping(address => Receipt) receipts;\n    }\n```\n\nhttps://github.com/code-423n4/2023-05-maia/blob/main/src/governance/GovernorBravoInterfaces.sol#L105-L136\n\n```solidity\nFile: /src/ulysses-omnichain/interfaces/IBranchBridgeAgent.sol\n26    struct DepositInput {\n    //Deposit Info\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n\n\n44   struct DepositParams {\n    //Deposit Info\n    uint32 depositNonce; //Deposit nonce.\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n    uint128 depositedGas; //BRanch chain gas token amount sent with request.\n}\n```\n\nhttps://github.com/code-423n4/2023-05-maia/blob/main/src/ulysses-omnichain/interfaces/IBranchBridgeAgent.sol#L26\n\n```solidity\nFile: /src/ulysses-omnichain/interfaces/IRootBridgeAgent.sol\n31    struct Settlement {\n    uint24 toChain; //Destination chain for interaction.\n    uint128 gasToBridgeOut; //Gas owed to user\n    address owner; //Owner of the settlement\n    address recipient; //Recipient of the settlement.\n    SettlementStatus status; //Status of the settlement\n    address[] hTokens; //Input Local hTokens Addresses.\n    address[] tokens; //Input Native / underlying Token Addresses.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n    bytes callData; //Call data for settlement\n}\n63    struct DepositParams {\n    //Deposit Info\n    uint32 depositNonce; //Deposit nonce.\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n73  struct DepositMultipleParams {\n    //Deposit Info\n    uint8 numberOfAssets; //Number of assets to deposit.\n    uint32 depositNonce; //Deposit nonce.\n    address[] hTokens; //Input Local hTokens Address.\n    address[] tokens; //Input Native / underlying Token Address.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n```\n\nhttps://github.com/code-423n4/2023-05-maia/blob/main/src/ulysses-omnichain/interfaces/IRootBridgeAgent.sol#L31\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/reports/2023-05-maia",
  "Code": [
    {
      "filename": "src/governance/GovernorBravoInterfaces.sol",
      "content": "// SPDX-License-Identifier: BSD-3-Clause\npragma solidity ^0.8.10;\n\ncontract GovernorBravoEvents {\n    /// @notice An event emitted when a new proposal is created\n    event ProposalCreated(\n        uint256 id,\n        address proposer,\n        address[] targets,\n        uint256[] values,\n        string[] signatures,\n        bytes[] calldatas,\n        uint256 startBlock,\n        uint256 endBlock,\n        string description\n    );\n\n    /// @notice An event emitted when a vote has been cast on a proposal\n    /// @param voter The address which casted a vote\n    /// @param proposalId The proposal id which was voted on\n    /// @param support Support value for the vote. 0=against, 1=for, 2=abstain\n    /// @param votes Number of votes which were cast by the voter\n    /// @param reason The reason given for the vote by the voter\n    event VoteCast(address indexed voter, uint256 proposalId, uint8 support, uint256 votes, string reason);\n\n    /// @notice An event emitted when a proposal has been canceled\n    event ProposalCanceled(uint256 id);\n\n    /// @notice An event emitted when a proposal has been queued in the Timelock\n    event ProposalQueued(uint256 id, uint256 eta);\n\n    /// @notice An event emitted when a proposal has been executed in the Timelock\n    event ProposalExecuted(uint256 id);\n\n    /// @notice An event emitted when the voting delay is set\n    event VotingDelaySet(uint256 oldVotingDelay, uint256 newVotingDelay);\n\n    /// @notice An event emitted when the voting period is set\n    event VotingPeriodSet(uint256 oldVotingPeriod, uint256 newVotingPeriod);\n\n    /// @notice Emitted when implementation is changed\n    event NewImplementation(address oldImplementation, address newImplementation);\n\n    /// @notice Emitted when proposal threshold is set\n    event ProposalThresholdSet(uint256 oldProposalThreshold, uint256 newProposalThreshold);\n\n    /// @notice Emitted when pendingAdmin is changed\n    event NewPendingAdmin(address oldPendingAdmin, address newPendingAdmin);\n\n    /// @notice Emitted when pendingAdmin is accepted, which means admin is updated\n    event NewAdmin(address oldAdmin, address newAdmin);\n\n    /// @notice Emitted when whitelist account expiration is set\n    event WhitelistAccountExpirationSet(address account, uint256 expiration);\n\n    /// @notice Emitted when the whitelistGuardian is set\n    event WhitelistGuardianSet(address oldGuardian, address newGuardian);\n}\n\ncontract GovernorBravoDelegatorStorage {\n    /// @notice Administrator for this contract\n    address public admin;\n\n    /// @notice Pending administrator for this contract\n    address public pendingAdmin;\n\n    /// @notice Active brains of Governor\n    address public implementation;\n}\n\n/**\n * @title Storage for Governor Bravo Delegate\n * @notice For future upgrades, do not change GovernorBravoDelegateStorageV1. Create a new\n * contract which implements GovernorBravoDelegateStorageV1 and following the naming convention\n * GovernorBravoDelegateStorageVX.\n */\ncontract GovernorBravoDelegateStorageV1 is GovernorBravoDelegatorStorage {\n    /// @notice The delay before voting on a proposal may take place, once proposed, in blocks\n    uint256 public votingDelay;\n\n    /// @notice The duration of voting on a proposal, in blocks\n    uint256 public votingPeriod;\n\n    /// @notice The number of votes required in order for a voter to become a proposer\n    uint256 public proposalThreshold;\n\n    /// @notice Initial proposal id set at become\n    uint256 public initialProposalId;\n\n    /// @notice The total number of proposals\n    uint256 public proposalCount;\n\n    /// @notice The address of the Maia Ecosystem Protocol Timelock\n    TimelockInterface public timelock;\n\n    /// @notice The address of the Maia Ecosystem governance token\n    GovTokenInterface public govToken;\n\n    /// @notice The official record of all proposals ever proposed\n    mapping(uint256 => Proposal) public proposals;\n\n    /// @notice The latest proposal for each proposer\n    mapping(address => uint256) public latestProposalIds;\n\n    struct Proposal {\n        /// @notice Unique id for looking up a proposal\n        uint256 id;\n        /// @notice Creator of the proposal\n        address proposer;\n        /// @notice The timestamp that the proposal will be available for execution, set once the vote succeeds\n        uint256 eta;\n        /// @notice the ordered list of target addresses for calls to be made\n        address[] targets;\n        /// @notice The ordered list of values (i.e. msg.value) to be passed to the calls to be made\n        uint256[] values;\n        /// @notice The ordered list of function signatures to be called\n        string[] signatures;\n        /// @notice The ordered list of calldata to be passed to each call\n        bytes[] calldatas;\n        /// @notice The block at which voting begins: holders must delegate their votes prior to this block\n        uint256 startBlock;\n        /// @notice The block at which voting ends: votes must be cast prior to this block\n        uint256 endBlock;\n        /// @notice Current number of votes in favor of this proposal\n        uint256 forVotes;\n        /// @notice Current number of votes in opposition to this proposal\n        uint256 againstVotes;\n        /// @notice Current number of votes for abstaining for this proposal\n        uint256 abstainVotes;\n        /// @notice Flag marking whether the proposal has been canceled\n        bool canceled;\n        /// @notice Flag marking whether the proposal has been executed\n        bool executed;\n        /// @notice Receipts of ballots for the entire set of voters\n        mapping(address => Receipt) receipts;\n    }\n\n    /// @notice Ballot receipt record for a voter\n    struct Receipt {\n        /// @notice Whether or not a vote has been cast\n        bool hasVoted;\n        /// @notice Whether or not the voter supports the proposal or abstains\n        uint8 support;\n        /// @notice The number of votes the voter had, which were cast\n        uint96 votes;\n    }\n\n    /// @notice Possible states that a proposal may be in\n    enum ProposalState {\n        Pending,\n        Active,\n        Canceled,\n        Defeated,\n        Succeeded,\n        Queued,\n        Expired,\n        Executed\n    }\n}\n\ncontract GovernorBravoDelegateStorageV2 is GovernorBravoDelegateStorageV1 {\n    /// @notice Stores the expiration of account whitelist status as a timestamp\n    mapping(address => uint256) public whitelistAccountExpirations;\n\n    /// @notice Address which manages whitelisted proposals and whitelist accounts\n    address public whitelistGuardian;\n}\n\ninterface TimelockInterface {\n    function delay() external view returns (uint256);\n    function GRACE_PERIOD() external view returns (uint256);\n    function acceptAdmin() external;\n    function queuedTransactions(bytes32 hash) external view returns (bool);\n    function queueTransaction(\n        address target,\n        uint256 value,\n        string calldata signature,\n        bytes calldata data,\n        uint256 eta\n    ) external returns (bytes32);\n    function cancelTransaction(\n        address target,\n        uint256 value,\n        string calldata signature,\n        bytes calldata data,\n        uint256 eta\n    ) external;\n    function executeTransaction(\n        address target,\n        uint256 value,\n        string calldata signature,\n        bytes calldata data,\n        uint256 eta\n    ) external payable returns (bytes memory);\n}\n\ninterface GovTokenInterface {\n    function getPriorVotes(address account, uint256 blockNumber) external view returns (uint96);\n\n    function totalSupply() external view returns (uint256);\n}\n\ninterface GovernorAlpha {\n    /// @notice The total number of proposals\n    function proposalCount() external returns (uint256);\n}"
    },
    {
      "filename": "src/ulysses-omnichain/interfaces/IBranchBridgeAgent.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport {IApp} from \"./IApp.sol\";\n\nstruct UserFeeInfo {\n    uint256 depositedGas;\n    uint256 feesOwed;\n}\n\nenum DepositStatus {\n    Success,\n    Failed\n}\n\nstruct Deposit {\n    uint128 depositedGas;\n    address owner;\n    DepositStatus status;\n    address[] hTokens;\n    address[] tokens;\n    uint256[] amounts;\n    uint256[] deposits;\n}\n\nstruct DepositInput {\n    //Deposit Info\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n\nstruct DepositMultipleInput {\n    //Deposit Info\n    address[] hTokens; //Input Local hTokens Address.\n    address[] tokens; //Input Native / underlying Token Address.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n\nstruct DepositParams {\n    //Deposit Info\n    uint32 depositNonce; //Deposit nonce.\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n    uint128 depositedGas; //BRanch chain gas token amount sent with request.\n}\n\nstruct DepositMultipleParams {\n    //Deposit Info\n    uint8 numberOfAssets; //Number of assets to deposit.\n    uint32 depositNonce; //Deposit nonce.\n    address[] hTokens; //Input Local hTokens Address.\n    address[] tokens; //Input Native / underlying Token Address.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n    uint128 depositedGas; //BRanch chain gas token amount sent with request.\n}\n\nstruct SettlementParams {\n    uint32 settlementNonce;\n    address recipient;\n    address hToken;\n    address token;\n    uint256 amount;\n    uint256 deposit;\n}\n\nstruct SettlementMultipleParams {\n    uint8 numberOfAssets; //Number of assets to deposit.\n    address recipient;\n    uint32 settlementNonce;\n    address[] hTokens;\n    address[] tokens;\n    uint256[] amounts;\n    uint256[] deposits;\n}\n\n/**\n * @title  Branch Bridge Agent Contract\n * @author MaiaDAO\n * @notice Contract for deployment in Branch Chains of Omnichain System, responible for\n *         interfacing with Users and Routers acting as a middleman to access Anycall cross-chain\n *         messaging and  requesting / depositing  assets in the Branch Chain's Ports.\n * @dev    Bridge Agents allow for the encapsulation of business logic as well as the standardize\n *         cross-chain communication, allowing for the creation of custom Routers to perform\n *         actions as a response to remote user requests. This contract for deployment in the Branch\n *         Chains of the Ulysses Omnichain Liquidity System.\n *         This contract manages gas spenditure calling `_replenishingGas` after each remote initiated\n *         execution, as well as requests tokens clearances and tx execution to the `BranchBridgeAgentExecutor`.\n *         Remote execution is \"sandboxed\" in 3 different nestings:\n *         - 1: Anycall Messaging Layer will revert execution if by the end of the call the\n *              balance in the executionBudget AnycallConfig contract for the Branch Bridge Agent\n *              being called is inferior to the executionGasSpent, throwing the error `no enough budget`.\n *         - 2: The `BranchBridgeAgent` will trigger a revert all state changes if by the end of the remote initiated call\n *              Router interaction the userDepositedGas < executionGasSpent. This is done by calling the `_forceRevert()`\n *              internal function clearing all executionBudget from the AnycallConfig contract forcing the error `no enough budget`.\n *         - 3: The `BranchBridgeAgentExecutor` is in charge of requesting token deposits for each remote interaction as well\n *              as performing the Router calls, if any of the calls initiated by the Router lead to an invlaid state change\n *              both the token deposit clearances as well as the external interactions will be reverted. Yet executionGas\n *              will still be credited by the `BranchBridgeAgent`.\n *\n *         Func IDs for calling these functions through messaging layer:\n *\n *         BRANCH BRIDGE AGENT SETTLEMENT FLAGS\n *         --------------------------------------\n *         ID           | DESCRIPTION\n *         -------------+------------------------\n *         0x00         | Call to Branch without Settlement.\n *         0x01         | Call to Branch with Settlement.\n *         0x02         | Call to Branch with Settlement of Multiple Tokens.\n *\n *         Encoding Scheme for different Root Bridge Agent Deposit Flags:\n *\n *           - ht = hToken\n *           - t = Token\n *           - A = Amount\n *           - D = Destination\n *           - b = bytes\n *           - n = number of assets\n *           ________________________________________________________________________________________________________________________________\n *          |            Flag               |           Deposit Info           |             Token Info             |   DATA   |  Gas Info   |\n *          |           1 byte              |            4-25 bytes            |        (105 or 128) * n bytes      |   ---\t   |  16 bytes   |\n *          |                               |                                  |            hT - t - A - D          |          |             |\n *          |_______________________________|__________________________________|____________________________________|__________|_____________|\n *          | callOut = 0x0                 |  20b(recipient) + 4b(nonce)      |            -------------           |   ---\t   |     dep     |\n *          | callOutSingle = 0x1           |  20b(recipient) + 4b(nonce)      |         20b + 20b + 32b + 32b      |   ---\t   |     16b     |\n *          | callOutMulti = 0x2            |  1b(n) + 20b(recipient) + 4b     |   \t     32b + 32b + 32b + 32b      |   ---\t   |     16b     |\n *          |_______________________________|__________________________________|____________________________________|__________|_____________|\n *\n *          Contract Remote Interaction Flow:\n *\n *          BranchBridgeAgent.anyExecute**() -> BridgeAgentExecutor.execute**() -> Router.anyExecute**() -> BridgeAgentExecutor (txExecuted) -> BranchBridgeAgent (replenishedGas)\n *\n *\n */\ninterface IBranchBridgeAgent is IApp {\n    /**\n     * @notice External function to return the Branch Bridge Agent Executor Address.\n     */\n    function bridgeAgentExecutorAddress() external view returns (address);\n\n    /**\n     * @dev External function that returns a given deposit entry.\n     *     @param _depositNonce Identifier for user deposit.\n     *\n     */\n    function getDepositEntry(uint32 _depositNonce) external view returns (Deposit memory);\n\n    /*///////////////////////////////////////////////////////////////\n                        EXTERNAL FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router without token deposit.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param remoteExecutionGas gas allocated for remote branch execution.\n     *   @dev DEPOSIT ID: 1 (Call without deposit)\n     *\n     */\n    function callOut(bytes calldata params, uint128 remoteExecutionGas) external payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router while depositing a single asset.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param dParams additional token deposit parameters.\n     *   @param remoteExecutionGas gas allocated for remote branch execution.\n     *   @dev DEPOSIT ID: 2 (Call with single deposit)\n     *\n     */\n    function callOutAndBridge(bytes calldata params, DepositInput memory dParams, uint128 remoteExecutionGas)\n        external\n        payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router while depositing two or more assets.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param dParams additional token deposit parameters.\n     *   @param remoteExecutionGas gas allocated for remote branch execution.\n     *   @dev DEPOSIT ID: 3 (Call with multiple deposit)\n     *\n     */\n    function callOutAndBridgeMultiple(\n        bytes calldata params,\n        DepositMultipleInput memory dParams,\n        uint128 remoteExecutionGas\n    ) external payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router without token deposit with msg.sender information.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param remoteExecutionGas gas allocated for remote branch execution.\n     *   @dev DEPOSIT ID: 4 (Call without deposit and verified sender)\n     *\n     */\n    function callOutSigned(bytes calldata params, uint128 remoteExecutionGas) external payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router while depositing a single asset msg.sender.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param dParams additional token deposit parameters.\n     *   @param remoteExecutionGas gas allocated for remote branch execution.\n     *   @dev DEPOSIT ID: 5 (Call with single deposit and verified sender)\n     *\n     */\n    function callOutSignedAndBridge(bytes calldata params, DepositInput memory dParams, uint128 remoteExecutionGas)\n        external\n        payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router while depositing two or more assets with msg.sender.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param dParams additional token deposit parameters.\n     *   @param remoteExecutionGas gas allocated for remote branch execution.\n     *   @dev DEPOSIT ID: 6 (Call with multiple deposit and verified sender)\n     *\n     */\n    function callOutSignedAndBridgeMultiple(\n        bytes calldata params,\n        DepositMultipleInput memory dParams,\n        uint128 remoteExecutionGas\n    ) external payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Environment retrying a failed deposit that hasn't been executed yet.\n     *     @param _isSigned Flag to indicate if the deposit was signed.\n     *     @param _depositNonce Identifier for user deposit.\n     *     @param _params parameters to execute on the root chain router.\n     *     @param _remoteExecutionGas gas allocated for remote branch execution.\n     *     @param _toChain Destination chain for interaction.\n     */\n    function retryDeposit(\n        bool _isSigned,\n        uint32 _depositNonce,\n        bytes calldata _params,\n        uint128 _remoteExecutionGas,\n        uint24 _toChain\n    ) external payable;\n\n    /**\n     * @notice External function to retry a failed Settlement entry on the root chain.\n     *     @param _settlementNonce Identifier for user settlement.\n     *     @param _gasToBoostSettlement Amount of gas to boost settlement.\n     *     @dev DEPOSIT ID: 7\n     *\n     */\n    function retrySettlement(uint32 _settlementNonce, uint128 _gasToBoostSettlement) external payable;\n\n    /**\n     * @notice External function to request tokens back to branch chain after a failed omnichain environment interaction.\n     *     @param _depositNonce Identifier for user deposit to retrieve.\n     *     @dev DEPOSIT ID: 8\n     *\n     */\n    function retrieveDeposit(uint32 _depositNonce) external payable;\n\n    /**\n     * @notice External function to retry a failed Deposit entry on this branch chain.\n     *     @param _depositNonce Identifier for user deposit.\n     *\n     */\n    function redeemDeposit(uint32 _depositNonce) external;\n\n    /**\n     * @notice Function to request balance clearance from a Port to a given user.\n     *     @param _recipient token receiver.\n     *     @param _hToken  local hToken addresse to clear balance for.\n     *     @param _token  native / underlying token addresse to clear balance for.\n     *     @param _amount amounts of hToken to clear balance for.\n     *     @param _deposit amount of native / underlying tokens to clear balance for.\n     *\n     */\n    function clearToken(address _recipient, address _hToken, address _token, uint256 _amount, uint256 _deposit)\n        external;\n\n    /**\n     * @notice Function to request balance clearance from a Port to a given address.\n     *     @param _sParams encode packed multiple settlement info.\n     *\n     */\n    function clearTokens(bytes calldata _sParams, address _recipient)\n        external\n        returns (SettlementMultipleParams memory);\n\n    /*///////////////////////////////////////////////////////////////\n                        BRANCH ROUTER FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /**\n     * @notice Internal function performs call to AnycallProxy Contract for cross-chain messaging.\n     *   @param params calldata for omnichain execution.\n     *   @param depositor address of user depositing assets.\n     *   @param gasToBridgeOut gas allocated for the cross-chain call.\n     *   @param remoteExecutionGas gas allocated for omnichain execution.\n     *   @dev DEPOSIT ID: 0 (System Call / Response)\n     *   @dev 0x00 flag allows for identifying system emitted request/responses.\n     *\n     */\n    function performSystemCallOut(\n        address depositor,\n        bytes memory params,\n        uint128 gasToBridgeOut,\n        uint128 remoteExecutionGas\n    ) external payable;\n\n    /**\n     * @notice Internal function performs call to AnycallProxy Contract for cross-chain messaging.\n     *   @param depositor address of user depositing assets.\n     *   @param params calldata for omnichain execution.\n     *   @param depositor address of user depositing assets.\n     *   @param gasToBridgeOut gas allocated for the cross-chain call.\n     *   @param remoteExecutionGas gas allocated for omnichain execution.\n     *   @dev DEPOSIT ID: 1 (Call without Deposit)\n     *\n     */\n    function performCallOut(address depositor, bytes memory params, uint128 gasToBridgeOut, uint128 remoteExecutionGas)\n        external\n        payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router while depositing a single asset.\n     *   @param depositor address of user depositing assets.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param dParams additional token deposit parameters.\n     *   @param gasToBridgeOut gas allocated for the cross-chain call.\n     *   @param remoteExecutionGas gas allocated for omnichain execution.\n     *   @dev DEPOSIT ID: 2 (Call with single asset Deposit)\n     *\n     */\n    function performCallOutAndBridge(\n        address depositor,\n        bytes calldata params,\n        DepositInput memory dParams,\n        uint128 gasToBridgeOut,\n        uint128 remoteExecutionGas\n    ) external payable;\n\n    /**\n     * @notice Function to perform a call to the Root Omnichain Router while depositing two or more assets.\n     *   @param depositor address of user depositing assets.\n     *   @param params enconded parameters to execute on the root chain router.\n     *   @param dParams additional token deposit parameters.\n     *   @param gasToBridgeOut gas allocated for the cross-chain call.\n     *   @param remoteExecutionGas gas allocated for omnichain execution.\n     *   @dev DEPOSIT ID: 3 (Call with multiple deposit)\n     *\n     */\n    function performCallOutAndBridgeMultiple(\n        address depositor,\n        bytes calldata params,\n        DepositMultipleInput memory dParams,\n        uint128 gasToBridgeOut,\n        uint128 remoteExecutionGas\n    ) external payable;\n\n    /*///////////////////////////////////////////////////////////////\n                        ANYCALL FUNCTIONS\n    //////////////////////////////////////////////////////////////*/\n\n    /**\n     * @notice Function to force revert when a remote action does not have enough gas or is being retried after having been previously executed.\n     */\n    function forceRevert() external;\n\n    /**\n     * @notice Function to deposit gas for use by the Branch Bridge Agent.\n     */\n    function depositGasAnycallConfig() external payable;\n\n    /*///////////////////////////////////////////////////////////////\n                        EVENTS\n    //////////////////////////////////////////////////////////////*/\n\n    event LogCallin(bytes1 selector, bytes data, uint256 fromChainId);\n    event LogCallout(bytes1 selector, bytes data, uint256, uint256 toChainId);\n    event LogCalloutFail(bytes1 selector, bytes data, uint256 toChainId);\n\n    /*///////////////////////////////////////////////////////////////\n                                ERRORS\n    //////////////////////////////////////////////////////////////*/\n\n    error AnycallUnauthorizedCaller();\n    error AlreadyExecutedTransaction();\n\n    error InvalidInput();\n    error InvalidChain();\n    error InsufficientGas();\n\n    error NotDepositOwner();\n    error DepositRedeemUnavailable();\n\n    error UnrecognizedCallerNotRouter();\n    error UnrecognizedBridgeAgentExecutor();\n}"
    },
    {
      "filename": "src/ulysses-omnichain/interfaces/IRootBridgeAgent.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport {IApp} from \"./IApp.sol\";\n\n/*///////////////////////////////////////////////////////////////\n                            STRUCTS\n//////////////////////////////////////////////////////////////*/\n\nstruct SwapCallbackData {\n    address tokenIn; //Token being sold\n}\n\nstruct UserFeeInfo {\n    uint128 depositedGas; //Gas deposited by user\n    uint128 gasToBridgeOut; //Gas to be sent to bridge\n}\n\nstruct GasPoolInfo {\n    //zeroForOne when swapping gas from branch chain into root chain gas\n    bool zeroForOneOnInflow;\n    uint24 priceImpactPercentage; //Price impact percentage\n    address poolAddress; //Uniswap V3 Pool Address\n}\n\nenum SettlementStatus {\n    Success, //Settlement was successful\n    Failed //Settlement failed\n}\n\nstruct Settlement {\n    uint24 toChain; //Destination chain for interaction.\n    uint128 gasToBridgeOut; //Gas owed to user\n    address owner; //Owner of the settlement\n    address recipient; //Recipient of the settlement.\n    SettlementStatus status; //Status of the settlement\n    address[] hTokens; //Input Local hTokens Addresses.\n    address[] tokens; //Input Native / underlying Token Addresses.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n    bytes callData; //Call data for settlement\n}\n\nstruct SettlementParams {\n    uint32 settlementNonce; //Settlement nonce.\n    address recipient; //Recipient of the settlement.\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n}\n\nstruct SettlementMultipleParams {\n    uint8 numberOfAssets; //Number of assets to deposit.\n    uint32 settlementNonce; //Settlement nonce.\n    address recipient; //Recipient of the settlement.\n    address[] hTokens; //Input Local hTokens Addresses.\n    address[] tokens; //Input Native / underlying Token Addresses.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n}\n\nstruct DepositParams {\n    //Deposit Info\n    uint32 depositNonce; //Deposit nonce.\n    address hToken; //Input Local hTokens Address.\n    address token; //Input Native / underlying Token Address.\n    uint256 amount; //Amount of Local hTokens deposited for interaction.\n    uint256 deposit; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n\nstruct DepositMultipleParams {\n    //Deposit Info\n    uint8 numberOfAssets; //Number of assets to deposit.\n    uint32 depositNonce; //Deposit nonce.\n    address[] hTokens; //Input Local hTokens Address.\n    address[] tokens; //Input Native / underlying Token Address.\n    uint256[] amounts; //Amount of Local hTokens deposited for interaction.\n    uint256[] deposits; //Amount of native tokens deposited for interaction.\n    uint24 toChain; //Destination chain for interaction.\n}\n\n/**\n * @title  Root Bridge Agent Contract\n * @author MaiaDAO\n * @notice Contract responsible for interfacing with Users and Routers acting as a middleman to\n *         access Anycall cross-chain messaging and Port communication for asset management.\n * @dev    Bridge Agents allow for the encapsulation of business logic as well as the standardize\n *         cross-chain communication, allowing for the creation of custom Routers to perform\n *         actions as a response to remote user requests. This contract is for deployment in the Root\n *         Chain Omnichain Environment based on Arbitrum.\n *         This contract manages gas spenditure calling `_replenishingGas` after each remote initiated\n *         execution, as well as requests tokens clearances and tx execution from the `RootBridgeAgentExecutor`.\n *         Remote execution is \"sandboxed\" in 3 different nestings:\n *         - 1: Anycall Messaging Layer will revert execution if by the end of the call the\n *              balance in the executionBudget AnycallConfig contract to the Root Bridge Agent\n *              being called is inferior to the  executionGasSpent, throwing the error `no enough budget`.\n *         - 2: The `RootBridgeAgent` will trigger a revert all state changes if by the end of the remote initiated call\n *              Router interaction the userDepositedGas < executionGasSpent. This is done by calling the `_forceRevert()`\n *              internal function clearing all executionBudget from the AnycallConfig contract forcing the error `no enough budget`.\n *         - 3: The `RootBridgeAgentExecutor` is in charge of requesting token deposits for each remote interaction as well\n *              as performing the Router calls, if any of the calls initiated by the Router lead to an invlaid state change\n *              both the token deposit clearances as well as the external interactions will be reverted. Yet executionGas\n *              will still be credited by the `RootBridgeAgent`.\n *\n *          Func IDs for calling these  functions through messaging layer:\n *\n *          ROOT BRIDGE AGENT DEPOSIT FLAGS\n *          --------------------------------------\n *          ID           | DESCRIPTION\n *          -------------+------------------------\n *          0x00         | Branch Router Response.\n *          0x01         | Call to Root Router without Deposit.\n *          0x02         | Call to Root Router with Deposit.\n *          0x03         | Call to Root Router with Deposit of Multiple Tokens.\n *          0x04         | Call to Root Router without Deposit + singned message.\n *          0x05         | Call to Root Router with Deposit + singned message.\n *          0x06         | Call to Root Router with Deposit of Multiple Tokens + singned message.\n *          0x07         | Call to `retrySettlement()´. (retries sending a settlement + calldata for branch execution with new gas)\n *          0x08         | Call to `clearDeposit()´. (clears a deposit that has not been executed yet triggering `anyFallback`)\n *\n *\n *          Encoding Scheme for different Root Bridge Agent Deposit Flags:\n *\n *           - ht = hToken\n *           - t = Token\n *           - A = Amount\n *           - D = Destination\n *           - C = ChainId\n *           - b = bytes\n *           - n = number of assets\n *           ___________________________________________________________________________________________________________________________\n *          |            Flag               |        Deposit Info        |             Token Info             |   DATA   |  Gas Info   |\n *          |           1 byte              |         4-25 bytes         |     3 + (105 or 128) * n bytes     |   ---\t |  32 bytes   |\n *          |                               |                            |          hT - t - A - D - C        |          |             |\n *          |_______________________________|________"
    }
  ]
}