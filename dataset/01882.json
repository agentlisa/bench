{
  "Title": "H-4: The price from `StableOracleDAI` is returned with the incorrect number of decimals",
  "Content": "# Issue H-4: The price from `StableOracleDAI` is returned with the incorrect number of decimals \n\nSource: https://github.com/sherlock-audit/2023-05-USSD-judging/issues/236 \n\n## Found by \n0xStalin, 0xeix, 0xlmanini, Bahurum, Brenzee, Dug, G-Security, PNS, Proxy, SanketKogekar, T1MOH, Vagner, WATCHPUG, ast3ros, ctf\\_sec, immeas, juancito, kutugu, n33k, peanuts, pengun, qbs, qpzm, saidam017, sam\\_gmk, sashik\\_eth, twicek\n## Summary\n\nThe price returned from the `getPriceUSD` function of the `StableOracleDAI` is scaled up by `1e10`, which results in 28 decimals instead of the intended 18.\n\n## Vulnerability Detail\n\nIn `StableOracleDAI` the `getPriceUSD` function is defined as follows...\n\n```solidity\n    function getPriceUSD() external view override returns (uint256) {\n        address[] memory pools = new address[](1);\n        pools[0] = 0x60594a405d53811d3BC4766596EFD80fd545A270;\n        uint256 DAIWethPrice = DAIEthOracle.quoteSpecificPoolsWithTimePeriod(\n            1000000000000000000, // 1 Eth\n            0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2, // WETH (base token)\n            0x6B175474E89094C44Da98b954EedeAC495271d0F, // DAI (quote token)\n            pools, // DAI/WETH pool uni v3\n            600 // period\n        );\n\n        uint256 wethPriceUSD = ethOracle.getPriceUSD();\n\n        // chainlink price data is 8 decimals for WETH/USD, so multiply by 10 decimals to get 18 decimal fractional\n        //(uint80 roundID, int256 price, uint256 startedAt, uint256 timeStamp, uint80 answeredInRound) = priceFeedDAIETH.latestRoundData();\n        (, int256 price,,,) = priceFeedDAIETH.latestRoundData();\n\n        return (wethPriceUSD * 1e18) / ((DAIWethPrice + uint256(price) * 1e10) / 2);\n    }\n```\n\nThe assumption is made that the `DAIWethPrice` is 8 decimals, and is therefore multiplied by `1e10` in the return statement to scale it up to 18 decimals. \n\nThe _other_ price feeds used in the protocol are indeed received with decimals, however, the Chainlink DAI/ETH price feed returns a value with 18 decimals as can be seen on their site.\n\nhttps://docs.chain.link/data-feeds/price-feeds/addresses\n\n## Impact\n\nThis means that the price returned from the `getPriceUSD` function is scaled up by `1e10`, which results in 28 decimals instead of the intended 18, drastically overvaluing the DAI/USD price.\n\nThis will result in the USSD token price being a tiny fraction of what it is intended to be. Instead of being pegged to $1, it will be pegged to $0.0000000001, completely defeating the purpose of the protocol.\n\nFor example, if a user calls `USSD.mintForToken`, supplying DAI, they'll be able to mint `1e10` times more USSD than intended.\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-05-USSD/blob/main/ussd-contracts/contracts/oracles/StableOracleDAI.sol#L33-L53\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nRemove the `* 1e10` from the return statement.\n\n```diff\n-   return (wethPriceUSD * 1e18) / ((DAIWethPrice + uint256(price) * 1e10) / 2);\n+   return (wethPriceUSD * 1e18) / (DAIWethPrice + uint256(price) / 2);\n```\n\n",
  "Impact": "HIGH",
  "Source": "https://app.sherlock.xyz/audits/contests/82",
  "Code": [
    {
      "filename": "ussd-contracts/contracts/oracles/StableOracleDAI.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.6;\n\nimport \"@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol\";\nimport \"./UniswapV3StaticOracle.sol\";\n\nimport \"../interfaces/IStableOracle.sol\";\nimport \"../interfaces/IStaticOracle.sol\";\n\n/*\n    Oracle for DAI using WETH/DAI UniV3 pools (this could also use several DEX pools)\n    \n    curve DAI 3pool 0xbebc44782c7db0a1a60cb6fe97d0b483032ff1c7 (400m TVL) -- to other stables\n    curve tricrypto2 0xd51a44d3fae010294c616388b506acda1bfaae46 (200m TVL) -- to ETH, to BTC\n    uniswap DAI/ETH 0x60594a405d53811d3bc4766596efd80fd545a270 (200m TVL) -- to ETH\n    0x773616e4d11a78f511299002da57a0a94577f1f4 Chainlink DAI/ETH feed\n*/\ncontract StableOracleDAI is IStableOracle {\n    AggregatorV3Interface priceFeedDAIETH;\n    IStaticOracle DAIEthOracle;\n    IStableOracle ethOracle;\n\n    constructor() {\n        priceFeedDAIETH = AggregatorV3Interface(\n            0x773616E4d11A78F511299002da57A0a94577F1f4\n        );\n        DAIEthOracle = IStaticOracle(\n            0x982152A6C7f732Ec7C9EA998dDD9Ebde00Dfa16e\n        );\n        ethOracle = IStableOracle(0x0000000000000000000000000000000000000000); // TODO: WETH oracle price\n    }\n\n    function getPriceUSD() external view override returns (uint256) {\n        address[] memory pools = new address[](1);\n        pools[0] = 0x60594a405d53811d3BC4766596EFD80fd545A270;\n        uint256 DAIWethPrice = DAIEthOracle.quoteSpecificPoolsWithTimePeriod(\n            1000000000000000000, // 1 Eth\n            0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2, // WETH (base token)\n            0x6B175474E89094C44Da98b954EedeAC495271d0F, // DAI (quote token)\n            pools, // DAI/WETH pool uni v3\n            600 // period\n        );\n\n        uint256 wethPriceUSD = ethOracle.getPriceUSD();\n\n        // chainlink price data is 8 decimals for WETH/USD, so multiply by 10 decimals to get 18 decimal fractional\n        //(uint80 roundID, int256 price, uint256 startedAt, uint256 timeStamp, uint80 answeredInRound) = priceFeedDAIETH.latestRoundData();\n        (, int256 price, , , ) = priceFeedDAIETH.latestRoundData();\n\n        return\n            (wethPriceUSD * 1e18) /\n            ((DAIWethPrice + uint256(price) * 1e10) / 2);\n    }\n}"
    }
  ]
}