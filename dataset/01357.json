{
  "Title": "Duplicated logic in `Silo::_plant` when resetting the delta roots for an account",
  "Content": "When executing`Silo::_plant`, the delta roots of the account must be [reset to zero](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/beanstalk/silo/SiloFacet/Silo.sol#L111); otherwise, `SiloExit::_balanceOfEarnedBeans` will return an incorrect amount of beans. This logic is currently [repeated](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/beanstalk/silo/SiloFacet/Silo.sol#L127) after calling `LibTokenSilo::addDepositToAccount`, within which the delta roots of an account is not accessed, and so the redundant reassignment can be removed.\n\n```diff\n        // Silo::_plant\n        s.a[account].deltaRoots = 0; // must be 0'd, as calling balanceOfEarnedBeans would give a invalid amount of beans.\n        if (beans == 0) return (0,stemTip);\n\n        // Reduce the Silo's supply of Earned Beans.\n        // SafeCast unnecessary because beans is <= s.earnedBeans.\n        s.earnedBeans = s.earnedBeans.sub(uint128(beans));\n\n        // Deposit Earned Beans if there are any. Note that 1 Bean = 1 BDV.\n        LibTokenSilo.addDepositToAccount(\n            account,\n            C.BEAN,\n            stemTip,\n            beans, // amount\n            beans, // bdv\n            LibTokenSilo.Transfer.emitTransferSingle\n        );\n-       s.a[account].deltaRoots = 0; // must be 0'd, as calling balanceOfEarnedBeans would give a invalid amount of beans.\n```",
  "Impact": "GAS",
  "Source": "",
  "Code": [
    {
      "filename": "protocol/contracts/beanstalk/silo/SiloFacet/Silo.sol",
      "content": "/**\n * SPDX-License-Identifier: MIT\n **/\n\npragma solidity =0.7.6;\npragma abicoder v2;\n\nimport \"@openzeppelin/contracts/token/ERC20/SafeERC20.sol\";\nimport \"./SiloExit.sol\";\n\n/**\n * @title Silo\n * @author Publius, Pizzaman1337, Brean\n * @notice Provides utility functions for claiming Silo rewards, including:\n *\n * - Grown Stalk (see \"Mow\")\n * - Earned Beans, Earned Stalk (see \"Plant\")\n * - 3CRV earned during a Flood (see \"Flood\")\n *\n * For backwards compatibility, a Flood is sometimes referred to by its old name\n * \"Season of Plenty\".\n */\n \ncontract Silo is SiloExit {\n    using SafeMath for uint256;\n    using SafeERC20 for IERC20;\n    using LibSafeMath128 for uint128;\n\n    //////////////////////// EVENTS ////////////////////////    \n\n    /**\n     * @notice Emitted when the deposit associated with the Earned Beans of\n     * `account` are Planted.\n     * @param account Owns the Earned Beans\n     * @param beans The amount of Earned Beans claimed by `account`.\n     */\n    event Plant(\n        address indexed account,\n        uint256 beans\n    );\n\n    /**\n     * @notice Emitted when 3CRV paid to `account` during a Flood is Claimed.\n     * @param account Owns and receives the assets paid during a Flood.\n     * @param plenty The amount of 3CRV claimed by `account`. This is the amount\n     * that `account` has been paid since their last {ClaimPlenty}.\n     * \n     * @dev Flood was previously called a \"Season of Plenty\". For backwards\n     * compatibility, the event has not been changed. For more information on \n     * Flood, see: {Weather.sop}.\n     */\n    event ClaimPlenty(\n        address indexed account,\n        uint256 plenty\n    );\n\n\n    /**\n     * @notice Emitted when `account` gains or loses Stalk.\n     * @param account The account that gained or lost Stalk.\n     * @param delta The change in Stalk.\n     * @param deltaRoots The change in Roots.\n     *   \n     * @dev {StalkBalanceChanged} should be emitted anytime a Deposit is added, removed or transferred AND\n     * anytime an account Mows Grown Stalk.\n     * @dev BIP-24 included a one-time re-emission of {SeedsBalanceChanged} for accounts that had\n     * executed a Deposit transfer between the Replant and BIP-24 execution. For more, see:\n     * [BIP-24](https://github.com/BeanstalkFarms/Beanstalk-Governance-Proposals/blob/master/bip/bip-24-fungible-bdv-support.md)\n     * [Event-24-Event-Emission](https://github.com/BeanstalkFarms/Event-24-Event-Emission)\n     */\n    event StalkBalanceChanged(\n        address indexed account,\n        int256 delta,\n        int256 deltaRoots\n    );\n\n    //////////////////////// INTERNAL: MOW ////////////////////////\n\n    /**\n     * @dev Claims the Grown Stalk for `msg.sender`. Requires token address to mow.\n     */\n    modifier mowSender(address token) {\n        LibSilo._mow(msg.sender, token);\n        _;\n    }\n\n    //////////////////////// INTERNAL: PLANT ////////////////////////\n\n    /**\n     * @dev Plants the Plantable BDV of `account` associated with its Earned\n     * Beans.\n     * \n     * For more info on Planting, see: {SiloFacet-plant}\n     */\n     \n    function _plant(address account) internal returns (uint256 beans, int96 stemTip) {\n        // Need to Mow for `account` before we calculate the balance of \n        // Earned Beans.\n        \n        // per the zero withdraw update, planting is handled differently \n        // depending whether or not the user plants during the vesting period of beanstalk. \n        // during the vesting period, the earned beans are not issued to the user.\n        // thus, the roots calculated for a given user is different. \n        // This is handled by the super mow function, which stores the difference in roots.\n        LibSilo._mow(account, C.BEAN);\n        uint256 accountStalk = s.a[account].s.stalk;\n\n        // Calculate balance of Earned Beans.\n        beans = _balanceOfEarnedBeans(account, accountStalk);\n        stemTip = LibTokenSilo.stemTipForToken(C.BEAN);\n        s.a[account].deltaRoots = 0; // must be 0'd, as calling balanceOfEarnedBeans would give a invalid amount of beans. \n        if (beans == 0) return (0,stemTip);\n        \n        // Reduce the Silo's supply of Earned Beans.\n        // SafeCast unnecessary because beans is <= s.earnedBeans.\n        s.earnedBeans = s.earnedBeans.sub(uint128(beans));\n        \n        // Deposit Earned Beans if there are any. Note that 1 Bean = 1 BDV.\n        LibTokenSilo.addDepositToAccount(\n            account,\n            C.BEAN,\n            stemTip,\n            beans, // amount\n            beans, // bdv\n            LibTokenSilo.Transfer.emitTransferSingle\n        );\n        s.a[account].deltaRoots = 0; // must be 0'd, as calling balanceOfEarnedBeans would give a invalid amount of beans. \n\n        // Earned Stalk associated with Earned Beans generate more Earned Beans automatically (i.e., auto compounding).\n        // Earned Stalk are minted when Earned Beans are minted during Sunrise. See {Sun.sol:rewardToSilo} for details.\n        // Similarly, `account` does not receive additional Roots from Earned Stalk during a Plant.\n        // The following lines allocate Earned Stalk that has already been minted to `account`.\n        // Constant is used here rather than s.ss[BEAN].stalkIssuedPerBdv\n        // for gas savings.\n        uint256 stalk = beans.mul(C.STALK_PER_BEAN);\n        s.a[account].s.stalk = accountStalk.add(stalk);\n\n\n        emit StalkBalanceChanged(account, int256(stalk), 0);\n        emit Plant(account, beans);\n    }\n\n    //////////////////////// INTERNAL: SEASON OF PLENTY ////////////////////////\n\n    /**\n     * @dev Gas optimization: An account can call `{SiloFacet:claimPlenty}` even\n     * if `s.a[account].sop.plenty == 0`. This would emit a ClaimPlenty event\n     * with an amount of 0.\n     */\n    function _claimPlenty(address account) internal {\n        // Plenty is earned in the form of 3Crv.\n        uint256 plenty = s.a[account].sop.plenty;\n        C.threeCrv().safeTransfer(account, plenty);\n        delete s.a[account].sop.plenty;\n\n        emit ClaimPlenty(account, plenty);\n    }\n}"
    }
  ]
}