{
  "Title": "[03] Changing addresses sizes from 20 to 32 bytes could break some parts of the system",
  "Content": "\nIn [ImmutableSimulator, line 20](https://github.com/code-423n4/2023-10-zksync/blob/72f5f16ed4ba94c7689fe38fcb0b7d27d2a3f135/code/system-contracts/contracts/ImmutableSimulator.sol#L20), it says `@notice that address uses uint256 type to leave the option to introduce 32-bytes address space in future` which is a pretty bad idea as:\n\n- It breaks compatibility with the EVM and **MANY** other chains (if not all).\n- Your own code casts `address` to `uint160` pretty often. Changing the size of the `address` type may lead to collisions or losing information with addresses whose value is higher than `type(uint160).max`.\n\n",
  "Impact": "LOW",
  "Source": "https://code4rena.com/reports/2023-10-zksync",
  "Code": [
    {
      "filename": "code/system-contracts/contracts/ImmutableSimulator.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport \"./interfaces/IImmutableSimulator.sol\";\nimport {DEPLOYER_SYSTEM_CONTRACT} from \"./Constants.sol\";\n\n/**\n * @author Matter Labs\n * @custom:security-contact security@matterlabs.dev\n * @notice System smart contract that simulates the behavior of immutable variables in Solidity.\n * @dev The contract stores the immutable variables created during deployment by other contracts on his storage.\n * @dev This simulator is needed so that smart contracts with the same Solidity code but different\n * constructor parameters have the same bytecode.\n * @dev The users are not expected to call this contract directly, only indirectly via the compiler simulations\n * for the immutable variables in Solidity.\n */\ncontract ImmutableSimulator is IImmutableSimulator {\n    /// @dev mapping (contract address) => (index of immutable variable) => value\n    /// @notice that address uses `uint256` type to leave the option to introduce 32-byte address space in future.\n    mapping(uint256 => mapping(uint256 => bytes32)) internal immutableDataStorage;\n\n    /// @notice Method that returns the immutable with a certain index for a user.\n    /// @param _dest The address which the immutable belongs to.\n    /// @param _index The index of the immutable.\n    /// @return The value of the immutables.\n    function getImmutable(address _dest, uint256 _index) external view override returns (bytes32) {\n        return immutableDataStorage[uint256(uint160(_dest))][_index];\n    }\n\n    /// @notice Method used by the contract deployer to store the immutables for an account\n    /// @param _dest The address which to store the immutables for.\n    /// @param _immutables The list of the immutables.\n    function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {\n        require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), \"Callable only by the deployer system contract\");\n        unchecked {\n            uint256 immutablesLength = _immutables.length;\n            for (uint256 i = 0; i < immutablesLength; ++i) {\n                uint256 index = _immutables[i].index;\n                bytes32 value = _immutables[i].value;\n                immutableDataStorage[uint256(uint160(_dest))][index] = value;\n            }\n        }\n    }\n}"
    }
  ]
}