{
  "Title": "M-6: getAccountPrimeDebtBalance() always return 0",
  "Content": "# Issue M-6: getAccountPrimeDebtBalance() always return 0 \n\nSource: https://github.com/sherlock-audit/2023-03-notional-judging/issues/173 \n\n## Found by \nbin2chen\n## Summary\nSpelling errors that result in `getAccountPrimeDebtBalance()` Always return 0\n\n## Vulnerability Detail\n\n`getAccountPrimeDebtBalance()` use for Show current debt\n\n```solidity\n    function getAccountPrimeDebtBalance(uint16 currencyId, address account) external view override returns (\n        int256 debtBalance\n    ) {\n        mapping(address => mapping(uint256 => BalanceStorage)) storage store = LibStorage.getBalanceStorage();\n        BalanceStorage storage balanceStorage = store[account][currencyId];\n        int256 cashBalance = balanceStorage.cashBalance;\n\n        // Only return cash balances less than zero\n        debtBalance = cashBalance < 0 ? debtBalance : 0;   //<------@audit wrong, Always return 0\n    }\n```\n\nIn the above code we can see that due to a spelling error,  `debtBalance` always ==0 \nshould use `debtBalance = cashBalance < 0 ? cashBalance : 0;`\n\n## Impact\n\n`getAccountPrimeDebtBalance()` is the external method to check the debt\n  If a third party integrates with notional protocol, this method will be used to determine whether the user has debt or not and handle it accordingly, which may lead to serious errors in the third party's business\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-03-notional/blob/main/contracts-v2/contracts/external/Views.sol#L496\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\n```solidity\n    function getAccountPrimeDebtBalance(uint16 currencyId, address account) external view override returns (\n        int256 debtBalance\n    ) {\n        mapping(address => mapping(uint256 => BalanceStorage)) storage store = LibStorage.getBalanceStorage();\n        BalanceStorage storage balanceStorage = store[account][currencyId];\n        int256 cashBalance = balanceStorage.cashBalance;\n\n        // Only return cash balances less than zero\n-       debtBalance = cashBalance < 0 ? debtBalance : 0;\n+       debtBalance = cashBalance < 0 ? cashBalance : 0;\n    }\n```\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/59",
  "Code": [
    {
      "filename": "contracts-v2/contracts/external/Views.sol",
      "content": "// SPDX-License-Identifier: GPL-3.0-only\npragma solidity =0.7.6;\npragma abicoder v2;\n\nimport {\n    PrimeRate,\n    ETHRate,\n    Token,\n    CashGroupParameters,\n    MarketParameters,\n    BalanceState,\n    AccountContext,\n    nTokenPortfolio,\n    ETHRateStorage,\n    AssetRateStorage,\n    CashGroupSettings,\n    InterestRateParameters,\n    PrimeCashFactors,\n    PortfolioAsset,\n    AccountBalance,\n    BalanceStorage,\n    Deprecated_AssetRateParameters,\n    RebalancingContextStorage\n} from \"../global/Types.sol\";\nimport {SafeUint256} from \"../math/SafeUint256.sol\";\nimport {SafeInt256} from \"../math/SafeInt256.sol\";\nimport {LibStorage} from \"../global/LibStorage.sol\";\nimport {StorageLayoutV2} from \"../global/StorageLayoutV2.sol\";\nimport {Deployments} from \"../global/Deployments.sol\";\nimport {Constants} from \"../global/Constants.sol\";\n\nimport {ExchangeRate} from \"../internal/valuation/ExchangeRate.sol\";\nimport {CashGroup} from \"../internal/markets/CashGroup.sol\";\nimport {Market} from \"../internal/markets/Market.sol\";\nimport {InterestRateCurve} from \"../internal/markets/InterestRateCurve.sol\";\nimport {DeprecatedAssetRate} from \"../internal/markets/DeprecatedAssetRate.sol\";\nimport {nTokenHandler} from \"../internal/nToken/nTokenHandler.sol\";\nimport {nTokenSupply} from \"../internal/nToken/nTokenSupply.sol\";\nimport {PrimeRateLib} from \"../internal/pCash/PrimeRateLib.sol\";\nimport {PrimeCashExchangeRate} from \"../internal/pCash/PrimeCashExchangeRate.sol\";\nimport {TokenHandler} from \"../internal/balances/TokenHandler.sol\";\nimport {BalanceHandler} from \"../internal/balances/BalanceHandler.sol\";\nimport {PortfolioHandler} from \"../internal/portfolio/PortfolioHandler.sol\";\nimport {BitmapAssetsHandler} from \"../internal/portfolio/BitmapAssetsHandler.sol\";\nimport {AccountContextHandler} from \"../internal/AccountContextHandler.sol\";\n\nimport {NotionalViews} from \"../../interfaces/notional/NotionalViews.sol\";\nimport {FreeCollateralExternal} from \"./FreeCollateralExternal.sol\";\nimport {MigrateIncentives} from \"./MigrateIncentives.sol\";\n\ncontract Views is StorageLayoutV2, NotionalViews {\n    using CashGroup for CashGroupParameters;\n    using TokenHandler for Token;\n    using Market for MarketParameters;\n    using PrimeRateLib for PrimeRate;\n    using SafeInt256 for int256;\n    using SafeUint256 for uint256;\n    using BalanceHandler for BalanceState;\n    using nTokenHandler for nTokenPortfolio;\n    using AccountContextHandler for AccountContext;\n\n    function _checkValidCurrency(uint16 currencyId) internal view {\n        require(0 < currencyId && currencyId <= maxCurrencyId, \"Invalid currency id\");\n    }\n\n    /** Governance Parameter Getters **/\n\n    /// @notice Returns the current maximum currency id\n    function getMaxCurrencyId() external view override returns (uint16) {\n        return maxCurrencyId;\n    }\n\n    /// @notice Returns a currency id, a zero means that it is not listed.\n    function getCurrencyId(address tokenAddress)\n        external\n        view\n        override\n        returns (uint16 currencyId)\n    {\n        currencyId = tokenAddressToCurrencyId[tokenAddress];\n        require(currencyId != 0, \"Token not listed\");\n    }\n\n    /// @notice Returns the asset token and underlying token related to a given currency id. If underlying\n    /// token is not set then will return the zero address\n    function getCurrency(uint16 currencyId)\n        external\n        view\n        override\n        returns (Token memory assetToken, Token memory underlyingToken)\n    {\n        _checkValidCurrency(currencyId);\n        assetToken = TokenHandler.getDeprecatedAssetToken(currencyId);\n        underlyingToken = TokenHandler.getUnderlyingToken(currencyId);\n    }\n\n    /// @notice Returns the ETH and Asset rates for a currency as stored, useful for viewing how they are configured\n    function getRateStorage(uint16 currencyId)\n        external\n        view\n        override\n        returns (ETHRateStorage memory ethRate, AssetRateStorage memory assetRate)\n    {\n        _checkValidCurrency(currencyId);\n        mapping(uint256 => ETHRateStorage) storage ethStore = LibStorage.getExchangeRateStorage();\n        mapping(uint256 => AssetRateStorage) storage assetStore = LibStorage.getAssetRateStorage_deprecated();\n        ethRate = ethStore[currencyId];\n        assetRate = assetStore[currencyId];\n    }\n\n    /// @notice Returns a currency and its corresponding asset rate and ETH exchange rates. Note that this does not recalculate\n    /// cToken interest rates, it only retrieves the latest stored rate.\n    function getCurrencyAndRates(uint16 currencyId)\n        external\n        view\n        override\n        returns (\n            Token memory assetToken,\n            Token memory underlyingToken,\n            ETHRate memory ethRate,\n            Deprecated_AssetRateParameters memory assetRate\n        )\n    {\n        _checkValidCurrency(currencyId);\n        assetToken = TokenHandler.getDeprecatedAssetToken(currencyId);\n        underlyingToken = TokenHandler.getUnderlyingToken(currencyId);\n        ethRate = ExchangeRate.buildExchangeRate(currencyId);\n        assetRate = DeprecatedAssetRate.getAdaptedAssetRate(currencyId);\n    }\n\n    /// @notice Returns cash group settings for a currency\n    function getCashGroup(uint16 currencyId)\n        external\n        view\n        override\n        returns (CashGroupSettings memory)\n    {\n        _checkValidCurrency(currencyId);\n        return CashGroup.deserializeCashGroupStorage(currencyId);\n    }\n\n    /// @notice Returns the cash group along with the asset rate for convenience.\n    function getCashGroupAndAssetRate(uint16 currencyId)\n        external\n        view\n        override\n        returns (CashGroupSettings memory cashGroup, Deprecated_AssetRateParameters memory assetRate)\n    {\n        _checkValidCurrency(currencyId);\n        cashGroup = CashGroup.deserializeCashGroupStorage(currencyId);\n        assetRate = DeprecatedAssetRate.getAdaptedAssetRate(currencyId);\n    }\n\n    /// @notice Returns market initialization parameters for a given currency\n    function getInitializationParameters(uint16 currencyId)\n        external view override returns (\n            int256[] memory deprecated_annualizedAnchorRates,\n            int256[] memory proportions\n        ) {\n        _checkValidCurrency(currencyId);\n        uint256 maxMarketIndex = CashGroup.getMaxMarketIndex(currencyId);\n        proportions = nTokenHandler.getInitializationParameters(\n            currencyId,\n            maxMarketIndex\n        );\n    }\n\n    /// @notice Returns nToken deposit parameters for a given currency\n    function getDepositParameters(uint16 currencyId)\n        external\n        view\n        override\n        returns (int256[] memory depositShares, int256[] memory leverageThresholds)\n    {\n        _checkValidCurrency(currencyId);\n        uint256 maxMarketIndex = CashGroup.getMaxMarketIndex(currencyId);\n        (depositShares, leverageThresholds) = nTokenHandler.getDepositParameters(\n            currencyId,\n            maxMarketIndex\n        );\n    }\n\n    function getInterestRateCurve(uint16 currencyId) external view override returns (\n        InterestRateParameters[] memory nextInterestRateCurve,\n        InterestRateParameters[] memory activeInterestRateCurve\n    ) {\n        _checkValidCurrency(currencyId);\n        uint256 maxMarketIndex = CashGroup.getMaxMarketIndex(currencyId);\n        // If no markets are listed, just exit\n        if (maxMarketIndex == 0) return (nextInterestRateCurve, activeInterestRateCurve);\n\n        nextInterestRateCurve = new InterestRateParameters[](maxMarketIndex);\n        activeInterestRateCurve = new InterestRateParameters[](maxMarketIndex);\n\n        for (uint256 i = 1; i <= maxMarketIndex; i++) {\n            nextInterestRateCurve[i - 1] = InterestRateCurve\n                .getNextInterestRateParameters(currencyId, i);\n            activeInterestRateCurve[i - 1] = InterestRateCurve\n                .getActiveInterestRateParameters(currencyId, i);\n        }\n    }\n\n    /// @notice Returns nToken address for a given currency\n    function nTokenAddress(uint16 currencyId) external view override returns (address) {\n        _checkValidCurrency(currencyId);\n        address nToken = nTokenHandler.nTokenAddress(currencyId);\n        require(nToken != address(0), \"No nToken for currency\");\n        return nToken;\n    }\n\n    /// @notice Returns pCash address for a given currency\n    function pCashAddress(uint16 currencyId) external view override returns (address) {\n        _checkValidCurrency(currencyId);\n        return PrimeCashExchangeRate.getCashProxyAddress(currencyId);\n    }\n\n    function pDebtAddress(uint16 currencyId) external view override returns (address) {\n        _checkValidCurrency(currencyId);\n        return PrimeCashExchangeRate.getDebtProxyAddress(currencyId);\n    }\n\n    /// @notice Returns address of the NOTE token\n    function getNoteToken() external pure override returns (address) {\n        return Deployments.NOTE_TOKEN_ADDRESS;\n    }\n\n    /// @notice Returns current ownership status of the contract\n    /// @return owner is the current owner of the Notional system\n    /// @return pendingOwner can claim ownership from the owner\n    function getOwnershipStatus() external view override returns (address, address) {\n        return (owner, pendingOwner);\n    }\n\n    function getGlobalTransferOperatorStatus(address operator) external view override returns (bool isAuthorized) {\n        return globalTransferOperator[operator];\n    }\n\n    function getAuthorizedCallbackContractStatus(address callback) external view override returns (bool isAuthorized) {\n        return authorizedCallbackContract[callback];\n    }\n\n    function getSecondaryIncentiveRewarder(uint16 currencyId) external view override returns (address rewarder) {\n        address tokenAddress = nTokenHandler.nTokenAddress(currencyId);\n        return address(nTokenHandler.getSecondaryRewarder(tokenAddress));\n    }\n\n    /** Global System State View Methods **/\n    function getPrimeFactors(\n        uint16 currencyId,\n        uint256 blockTime\n    ) external view override returns (\n        PrimeRate memory pr,\n        PrimeCashFactors memory factors,\n        uint256 maxUnderlyingSupply,\n        uint256 totalUnderlyingSupply\n    ) {\n        (pr, factors) = PrimeCashExchangeRate.getPrimeCashRateView(currencyId, blockTime);\n        (maxUnderlyingSupply, totalUnderlyingSupply) = pr.getSupplyCap(currencyId);\n    }\n\n    function getPrimeFactorsStored(\n        uint16 currencyId\n    ) external view override returns (PrimeCashFactors memory) {\n        return PrimeCashExchangeRate.getPrimeCashFactors(currencyId);\n    }\n\n    function getPrimeCashHoldingsOracle(uint16 currencyId) external view override returns (address) {\n        return address(PrimeCashExchangeRate.getPrimeCashHoldingsOracle(currencyId));\n    }\n\n    function getTotalfCashDebtOutstanding(\n        uint16 currencyId, uint256 maturity\n    ) external view override returns (int256) {\n        return PrimeCashExchangeRate.getTotalfCashDebtOutstanding(currencyId, maturity);\n    }\n\n    /// @notice Returns the asset settlement rate for a given maturity\n    function getSettlementRate(uint16 currencyId, uint40 maturity)\n        external view override returns (PrimeRate memory) {\n        _checkValidCurrency(currencyId);\n        return PrimeRateLib.buildPrimeRateSettlementView(\n            currencyId, maturity, block.timestamp\n        );\n    }\n\n    /// @notice Returns a single market\n    function getMarket(\n        uint16 currencyId,\n        uint256 maturity,\n        uint256 settlementDate\n    )\n        external\n        view\n        override\n        returns (MarketParameters memory)\n    {\n        _checkValidCurrency(currencyId);\n        CashGroupParameters memory cashGroup = CashGroup.buildCashGroupView(currencyId);\n        MarketParameters memory market;\n        market.loadMarketWithSettlementDate(\n            currencyId,\n            maturity,\n            block.timestamp,\n            true,\n            cashGroup.getRateOracleTimeWindow(),\n            settlementDate\n        );\n\n        return market;\n    }\n\n    /// @notice Returns all currently active markets for a currency\n    function getActiveMarkets(uint16 currencyId)\n        external\n        view\n        override\n        returns (MarketParameters[] memory)\n    {\n        _checkValidCurrency(currencyId);\n        return _getActiveMarketsAtBlockTime(currencyId, block.timestamp);\n    }\n\n    /// @notice Returns all active markets for a currency at the specified block time, useful for looking\n    /// at historical markets\n    function getActiveMarketsAtBlockTime(uint16 currencyId, uint32 blockTime)\n        external\n        view\n        override\n        returns (MarketParameters[] memory)\n    {\n        _checkValidCurrency(currencyId);\n        return _getActiveMarketsAtBlockTime(currencyId, blockTime);\n    }\n\n    function _getActiveMarketsAtBlockTime(uint16 currencyId, uint256 blockTime)\n        internal\n        view\n        returns (MarketParameters[] memory)\n    {\n        CashGroupParameters memory cashGroup = CashGroup.buildCashGroupView(currencyId);\n        MarketParameters[] memory markets = new MarketParameters[](cashGroup.maxMarketIndex);\n\n        for (uint256 i = 0; i < cashGroup.maxMarketIndex; i++) {\n            cashGroup.loadMarket(markets[i], i + 1, true, blockTime);\n        }\n\n        return markets;\n    }\n\n    /// @notice Returns the current reserve balance for a currency\n    function getReserveBalance(uint16 currencyId)\n        external\n        view\n        override\n        returns (int256 reserveBalance)\n    {\n        _checkValidCurrency(currencyId);\n        reserveBalance = BalanceHandler.getPositiveCashBalance(Constants.FEE_RESERVE, currencyId);\n    }\n\n    function getNTokenPortfolio(address tokenAddress)\n        external\n        view\n        override\n        returns (PortfolioAsset[] memory liquidityTokens, PortfolioAsset[] memory netfCashAssets)\n    {\n        // prettier-ignore\n        (\n            uint16 currencyId,\n            /* incentiveRate */,\n            uint256 lastInitializedTime,\n            uint8 assetArrayLength,\n            /* bytes5 parameters */\n        ) = nTokenHandler.getNTokenContext(tokenAddress);\n\n        liquidityTokens = PortfolioHandler.getSortedPortfolio(tokenAddress, assetArrayLength);\n\n        netfCashAssets = BitmapAssetsHandler.getifCashArray(\n            tokenAddress,\n            currencyId,\n            lastInitializedTime\n        );\n    }\n\n    function getNTokenAccount(address tokenAddress)\n        external\n        view\n        override\n        returns (\n            uint16 currencyId,\n            uint256 totalSupply,\n            uint256 incentiveAnnualEmissionRate,\n            uint256 lastInitializedTime,\n            bytes5 nTokenParameters,\n            int256 cashBalance,\n            uint256 accumulatedNOTEPerNToken,\n            uint256 lastAccumulatedTime\n        )\n    {\n        (\n            currencyId,\n            incentiveAnnualEmissionRate,\n            lastInitializedTime,\n            /* assetArrayLength */,\n            nTokenParameters\n        ) = nTokenHandler.getNTokenContext(tokenAddress);\n\n        // prettier-ignore\n        (\n            totalSupply,\n            accumulatedNOTEPerNToken,\n            lastAccumulatedTime\n        ) = nTokenSupply.getStoredNTokenSupplyFactors(tokenAddress);\n\n        // prettier-ignore\n        (\n            cashBalance,\n            /* */,\n            /* */,\n            /* */\n        ) = BalanceHandler.getBalanceStorageView(tokenAddress, currencyId, block.timestamp);\n    }\n\n    /** Account Specific View Methods **/\n\n    /// @notice Returns all account details in a single view\n    function getAccount(address account)\n        external\n        view\n        override\n        returns (\n            AccountContext memory accountContext,\n            AccountBalance[] memory accountBalances,\n            PortfolioAsset[] memory portfolio\n        )\n    {\n        accountContext = AccountContextHandler.getAccountContext(account);\n        accountBalances = new AccountBalance[](10);\n\n        uint256 i = 0;\n        if (accountContext.isBitmapEnabled()) {\n            AccountBalance memory b = accountBalances[0];\n            b.currencyId = accountContext.bitmapCurrencyId;\n            (\n                b.cashBalance,\n                b.nTokenBalance,\n                b.lastClaimTime,\n                b.accountIncentiveDebt\n            ) = BalanceHandler.getBalanceStorageView(account, accountContext.bitmapCurrencyId, block.timestamp);\n            i += 1;\n        }\n\n        bytes18 currencies = accountContext.activeCurrencies;\n        while (currencies != 0) {\n            AccountBalance memory b = accountBalances[i];\n            b.currencyId = uint16(bytes2(currencies) & Constants.UNMASK_FLAGS);\n            if (b.currencyId == 0) break;\n\n            (\n                b.cashBalance,\n                b.nTokenBalance,\n                b.lastClaimTime,\n                b.accountIncentiveDebt\n            ) = BalanceHandler.getBalanceStorageView(account, b.currencyId, block.timestamp);\n            i += 1;\n            currencies = currencies << 16;\n        }\n\n        if (accountContext.isBitmapEnabled()) {\n            portfolio = BitmapAssetsHandler.getifCashArray(\n                account,\n                accountContext.bitmapCurrencyId,\n                accountContext.nextSettleTime\n            );\n        } else {\n            portfolio = PortfolioHandler.getSortedPortfolio(\n                account,\n                accountContext.assetArrayLength\n            );\n        }\n    }\n\n    /// @notice Returns account context\n    function getAccountContext(address account) external view override returns (AccountContext memory) {\n        return AccountContextHandler.getAccountContext(account);\n    }\n\n    function getAccountPrimeDebtBalance(uint16 currencyId, address account) external view override returns (\n        int256 debtBalance\n    ) {\n        mapping(address => mapping(uint256 => BalanceStorage)) storage store = LibStorage.getBalanceStorage();\n        BalanceStorage storage balanceStorage = store[account][currencyId];\n        int256 cashBalance = balanceStorage.cashBalance;\n\n        // Only return cash balances less than zero\n        debtBalance = cashBalance < 0 ? debtBalance : 0;\n    }\n\n    /// @notice Returns account balances for a given currency\n    function getAccountBalance(uint16 currencyId, address account) external view override returns (\n        int256 cashBalance,\n        int256 nTokenBalance,\n        uint256 lastClaimTime\n    ) {\n        _checkValidCurrency(currencyId);\n        // prettier-ignore\n        (\n            cashBalance,\n            nTokenBalance,\n            lastClaimTime,\n            /* */\n        ) = BalanceHandler.getBalanceStorageView(account, currencyId, block.timestamp);\n    }\n\n    /// @notice Returns account portfolio of assets\n    function getAccountPortfolio(address account) external view override returns (PortfolioAsset[] memory) {\n        AccountContext memory accountContext = AccountContextHandler.getAccountContext(account);\n        if (accountContext.isBitmapEnabled()) {\n            return\n                BitmapAssetsHandler.getifCashArray(\n                    account,\n                    accountContext.bitmapCurrencyId,\n                    accountContext.nextSettleTime\n                );\n        } else {\n            return PortfolioHandler.getSortedPortfolio(account, accountContext.assetArrayLength);\n        }\n    }\n\n    /// @notice Returns the fCash amount at the specified maturity for a bitmapped portfolio\n    function getfCashNotional(address account, uint16 currencyId, uint256 maturity) external view override returns (int256) {\n        _checkValidCurrency(currencyId);\n        return BitmapAssetsHandler.getifCashNotional(account, currencyId, maturity);\n    }\n\n    /// @notice Returns the assets bitmap for an account\n    function getAssetsBitmap(address account, uint16 currencyId) external view override returns (bytes32) {\n        _checkValidCurrency(currencyId);\n        return BitmapAssetsHandler.getAssetsBitmap(account, currencyId);\n    }\n\n    /// @notice Returns free collateral of an account along with an array of the individual net available\n    /// asset cash amounts\n    function getFreeCollateral(address account) external view override returns (int256, int256[] memory) {\n        return FreeCollateralExternal.getFreeCollateralView(account);\n    }\n\n    /// @notice Returns the current treasury manager contract\n    function getTreasuryManager() external view override returns (address) {\n        return treasuryManagerContract;\n    }\n\n    /// @notice Returns the current reserve buffer for a currency\n    /// @param currencyId refers to the currency of the reserve\n    function getReserveBuffer(uint16 currencyId) external view override returns (uint256) {\n        return reserveBuffer[currencyId];\n    }\n\n    function getRebalancingTarget(uint16 currencyId, address holding) external view override returns (uint8) {\n        mapping(address => uint8) storage rebalancingTargets = LibStorage.getRebalancingTargets()[currencyId];\n        return rebalancingTargets[holding];\n    }\n\n    function getRebalancingCooldown(uint16 currencyId) external view override returns (uint40) {\n        mapping(uint16 => RebalancingContextStorage) storage store = LibStorage.getRebalancingContext();\n        return store[currencyId].rebalancingCooldownInSeconds;\n    }\n\n    function getStoredTokenBalances(address[] calldata tokens) external view override returns (uint256[] memory balances) {\n        mapping(address => uint256) storage store = LibStorage.getStoredTokenBalances();\n        balances = new uint256[](tokens.length);\n        for (uint256 i; i < tokens.length; ++i) {\n            balances[i] = store[tokens[i]];\n        }\n    }\n\n    /// @notice Get a list of deployed library addresses (sorted by library name)\n    function getLibInfo() external pure returns (address, address) {\n        return (address(FreeCollateralExternal), address(MigrateIncentives));\n    }\n\n    fallback() external {\n        revert(\"Method not found\");\n    }\n}"
    }
  ]
}