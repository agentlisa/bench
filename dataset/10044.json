{
  "Title": "[M-06] `TimeswapPair.sol#mint()` Malicious user/attacker can mint new liquidity with an extremely small amount of `yIncrease` and malfunction the pair with the maturity",
  "Content": "_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2022-01-timeswap/blob/bf50d2a8bb93a5571f35f96bd74af54d9c92a210/Timeswap/Timeswap-V1-Convenience/contracts/libraries/MintMath.sol#L14-L34>\n\nThe current implementation of `TimeswapPair.sol#mint()` allows the caller to specify an arbitrary value for `yIncrease`.\n\nHowever, since `state.y` is expected to be a large number based at `2**32`, once the initial `state.y` is set to a small number (1 wei for example), the algorithm won't effectively change `state.y` with regular market operations (`borrow`, `lend` and `mint`).\n\n<https://github.com/code-423n4/2022-01-timeswap/blob/bf50d2a8bb93a5571f35f96bd74af54d9c92a210/Timeswap/Timeswap-V1-Core/contracts/libraries/BorrowMath.sol#L17-L37>\n\nThe pair with the maturity will malfunction and can only be abandoned.\n\nA malicious user/attacker can use this to frontrun other users or the platform's `newLiquidity()` call to initiate a griefing attack.\n\nIf the desired `maturity` is a meaningful value for the user/platform, eg, end of year/quarter. This can be a noteworthy issue.\n\n#### Recommendation\n\nConsider adding validation of minimal `state.y` for new liquidity.\n\nCan be `2**32 / 10000` for example.\n\n\n**[Mathepreneur (Timeswap) confirmed](https://github.com/code-423n4/2022-01-timeswap-findings/issues/165)**\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2022-01-timeswap",
  "Code": [
    {
      "filename": "Timeswap/Timeswap-V1-Convenience/contracts/libraries/MintMath.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity =0.8.4;\n\nimport {IPair} from '@timeswap-labs/timeswap-v1-core/contracts/interfaces/IPair.sol';\nimport {Math} from '@timeswap-labs/timeswap-v1-core/contracts/libraries/Math.sol';\nimport {ConstantProduct} from './ConstantProduct.sol';\nimport {SafeCast} from '@timeswap-labs/timeswap-v1-core/contracts/libraries/SafeCast.sol';\n\nlibrary MintMath {\n    using Math for uint256;\n    using ConstantProduct for IPair;\n    using SafeCast for uint256;\n\n    function givenNew(\n        uint256 maturity,\n        uint112 assetIn,\n        uint112 debtIn,\n        uint112 collateralIn\n    ) internal view returns (uint112 yIncrease, uint112 zIncrease) {\n        uint256 _yIncrease = debtIn;\n        _yIncrease -= assetIn;\n        _yIncrease <<= 32;\n        _yIncrease /= maturity - block.timestamp;\n        yIncrease = _yIncrease.toUint112();\n\n        uint256 _zIncrease = collateralIn;\n        _zIncrease <<= 25;\n        uint256 denominator = maturity;\n        denominator -= block.timestamp;\n        denominator += 0x2000000;\n        _zIncrease /= denominator;\n        zIncrease = _zIncrease.toUint112();\n\n    }\n\n    function givenAsset(\n        IPair pair,\n        uint256 maturity,\n        uint112 assetIn\n    ) internal view returns (uint112 yIncrease, uint112 zIncrease) {\n        ConstantProduct.CP memory cp = pair.get(maturity);\n\n        uint256 _yIncrease = cp.y;\n        _yIncrease *= assetIn;\n        _yIncrease /= cp.x;\n        yIncrease = _yIncrease.toUint112();\n\n        uint256 _zIncrease = cp.z;\n        _zIncrease *= assetIn;\n        _zIncrease /= cp.x;\n        zIncrease = _zIncrease.toUint112();\n    }\n\n    function givenDebt(\n        IPair pair,\n        uint256 maturity,\n        uint112 debtIn\n    )\n        internal\n        view\n        returns (\n            uint112 xIncrease,\n            uint112 yIncrease,\n            uint112 zIncrease\n        )\n    {\n        ConstantProduct.CP memory cp = pair.get(maturity);\n\n        uint256 _yIncrease = debtIn;\n        _yIncrease *= cp.y;\n        _yIncrease <<= 32;\n        uint256 denominator = maturity;\n        denominator -= block.timestamp;\n        denominator *= cp.y;\n        uint256 addend = cp.x;\n        addend <<= 32;\n        denominator += addend;\n        _yIncrease /= denominator;\n        yIncrease = _yIncrease.toUint112();\n\n        uint256 _xIncrease = cp.x;\n        _xIncrease *= _yIncrease;\n        _xIncrease /= cp.y;\n        xIncrease = _xIncrease.toUint112();\n\n        uint256 _zIncrease = cp.z;\n        _zIncrease *= _yIncrease;\n        _zIncrease /= cp.y;\n        zIncrease = _zIncrease.toUint112();\n    }\n\n    function givenCollateral(\n        IPair pair,\n        uint256 maturity,\n        uint112 collateralIn\n    )\n        internal\n        view\n        returns (\n            uint112 xIncrease,\n            uint112 yIncrease,\n            uint112 zIncrease\n        )\n    {\n        ConstantProduct.CP memory cp = pair.get(maturity);\n\n        uint256 _zIncrease = collateralIn;\n        _zIncrease <<= 25;\n        uint256 denominator = maturity;\n        denominator -= block.timestamp;\n        denominator += 0x2000000;\n        _zIncrease /= denominator;\n        zIncrease = _zIncrease.toUint112();\n\n        uint256 _xIncrease = cp.x;\n        _xIncrease *= _zIncrease;\n        _xIncrease /= cp.z;\n        xIncrease = _xIncrease.toUint112();\n\n        uint256 _yIncrease = cp.y;\n        _yIncrease *= _zIncrease;\n        _yIncrease /= cp.z;\n        yIncrease = _yIncrease.toUint112();\n    }\n}"
    },
    {
      "filename": "Timeswap/Timeswap-V1-Core/contracts/libraries/BorrowMath.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity =0.8.4;\n\nimport {IPair} from '../interfaces/IPair.sol';\nimport {Math} from './Math.sol';\nimport {FullMath} from './FullMath.sol';\nimport {ConstantProduct} from './ConstantProduct.sol';\nimport {SafeCast} from './SafeCast.sol';\n\n\nlibrary BorrowMath {\n    using Math for uint256;\n    using FullMath for uint256;\n    using ConstantProduct for IPair.State;\n    using SafeCast for uint256;\n\n    function check(\n        IPair.State memory state,\n        uint112 xDecrease,\n        uint112 yIncrease,\n        uint112 zIncrease,\n        uint16 fee\n    ) internal pure {\n        uint128 feeBase = 0x10000 - fee;\n        uint112 xReserve = state.x - xDecrease;\n        uint128 yAdjusted = adjust(state.y, yIncrease, feeBase);\n        uint128 zAdjusted = adjust(state.z, zIncrease, feeBase);\n        state.checkConstantProduct(xReserve, yAdjusted, zAdjusted);\n\n        uint256 minimum = xDecrease;\n        minimum *= state.y;\n        minimum <<= 12;\n        uint256 denominator = xReserve;\n        denominator *= feeBase;\n        minimum = minimum.divUp(denominator);\n        require(yIncrease >= minimum, 'E302');\n    }\n\n    function adjust(\n        uint112 reserve,\n        uint112 increase,\n        uint128 feeBase\n    ) private pure returns (uint128 adjusted) {\n        adjusted = reserve;\n        adjusted <<= 16;\n        adjusted += feeBase * increase;\n    }\n\n    function getDebt(\n        uint256 maturity,\n        uint112 xDecrease,\n        uint112 yIncrease\n    ) internal view returns (uint112 debtIn) {\n        uint256 _debtIn = maturity;\n        _debtIn -= block.timestamp;\n        _debtIn *= yIncrease;\n        _debtIn = _debtIn.shiftRightUp(32);\n        _debtIn += xDecrease;\n        debtIn = _debtIn.toUint112();\n    }\n\n    function getCollateral(\n        uint256 maturity,\n        IPair.State memory state,\n        uint112 xDecrease,\n        uint112 zIncrease\n    ) internal view returns (uint112 collateralIn) {\n        uint256 _collateralIn = maturity;\n        _collateralIn -= block.timestamp;\n        _collateralIn *= zIncrease;\n        _collateralIn = _collateralIn.shiftRightUp(25);\n        uint256 minimum = state.z;\n        minimum *= xDecrease;\n        uint256 denominator = state.x;\n        denominator -= xDecrease;\n        minimum = minimum.divUp(denominator);\n        _collateralIn += minimum;\n        collateralIn = _collateralIn.toUint112();\n    }\n}"
    }
  ]
}