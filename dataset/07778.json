{
  "Title": "[M-02] `BLOCK_PERIOD` is incorrect",
  "Content": "\n[Config.sol#L47](https://github.com/code-423n4/2022-10-zksync/blob/456078b53a6d09636b84522ac8f3e8049e4e3af5/ethereum/contracts/zksync/Config.sol#L47)<br>\n\nThe `BLOCK_PERIOD` is set to 13 seconds in `Config.sol`.\n\n```sol\nuint256 constant BLOCK_PERIOD = 13 seconds;\n```\n\nSince moving to Proof-of-Stake (PoS) after the Merge, block times on ethereum are fixed at 12 seconds per block (slots).\n<https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#:~:text=Whereas%20under%20proof%2Dof%2Dwork,block%20proposer%20in%20every%20slot>.\n\n### Impact\n\nThis results in incorrect calculation of `PRIORITY_EXPIRATION` which is used to determine when a transaction in the Priority Queue should be considered expired.\n\n```sol\nuint256 constant PRIORITY_EXPIRATION_PERIOD = 3 days;\n/// @dev Expiration delta for priority request to be satisfied (in ETH blocks)\nuint256 constant PRIORITY_EXPIRATION = PRIORITY_EXPIRATION_PERIOD/BLOCK_PERIOD;\n```\n\nThe time difference can be calulated\n\n```python\n>>> 3*24*60*60 / 13    # 3 days / 13 sec block period\n19938.46153846154\n>>> 3*24*60*60 / 12    # 3 days / 12 sec block period\n21600.0\n>>> 21600 - 19938      # difference in blocks\n1662\n>>> 1662 * 12 / (60 * 60) # difference in hours\n5.54\n```\n\nBy using block time of 13 seconds, a transaction in the Priority Queue incorrectly expires 5.5 hours earlier than is expected.\n\n5.5 hours is a significant amount of time difference so I believe this issue to be Medium severity.\n\n### Recommended Mitigation Steps\n\nChange the block period to be 12 seconds\n\n```sol\nuint256 constant BLOCK_PERIOD = 12 seconds;\n```\n\n**[miladpiri (zkSync) confirmed and commented](https://github.com/code-423n4/2022-10-zksync-findings/issues/259#issuecomment-1324171828):**\n > This is a valid medium issue! Thanks!\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-10-zksync-findings/issues/259#issuecomment-1329983294):**\n > The warden has shown how, due to an incorrect configuration, L2Transactions will expire earlier than intended.\n> \n> The value would normally be rated a Low Severity, however, because the Warden has shown a more specific impact, I agree with Medium Severity.\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/contests/2022-10-zksync-v2-contest",
  "Code": [
    {
      "filename": "ethereum/contracts/zksync/Config.sol",
      "content": "// SPDX-License-Identifier: MIT OR Apache-2.0\n\npragma solidity ^0.8.0;\n\nbytes32 constant EMPTY_STRING_KECCAK = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;\n\n/// @dev Bytes in raw L2 log\n/// @dev Equal to the bytes size of the tuple - (uint8 ShardId, bool isService, uint16 txNumberInBlock, address sender, bytes32 key, bytes32 value)\nuint256 constant L2_TO_L1_LOG_SERIALIZE_SIZE = 88;\n\n/// @dev Length of the bytes array with L2->L1 logs\nuint256 constant L2_TO_L1_LOGS_COMMITMENT_BYTES = 4 + L2_TO_L1_LOG_SERIALIZE_SIZE * 512;\n\n/// @dev L2 -> L1 logs Merkle tree height\nuint256 constant L2_TO_L1_LOG_MERKLE_TREE_HEIGHT = 9;\n\n/// @dev The value of default leaf hash for L2 -> L1 logs Merkle tree\n/// @dev An incomplete fixed-size tree is filled with this value to be a full binary tree\n/// @dev Actually equal to the `keccak256(new bytes(L2_LOG_BYTES))`\nbytes32 constant L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH = 0x72abee45b59e344af8a6e520241c4744aff26ed411f4c4b00f8af09adada43ba;\n\n/// @dev Length of the bytes array with initial storage changes\nuint256 constant INITIAL_STORAGE_CHANGES_COMMITMENT_BYTES = 4 + 64 * 4896;\n\n/// @dev Length of the bytes array with repeated storage changes\nuint256 constant REPEATED_STORAGE_CHANGES_COMMITMENT_BYTES = 4 + 40 * 7787;\n\n// TODO: change constant to the real root hash of empty Merkle tree (SMA-184)\nbytes32 constant DEFAULT_L2_LOGS_TREE_ROOT_HASH = bytes32(0);\n\n/// @dev The address of the special smart contract that can send arbitrary length message as an L2 log\naddress constant L2_TO_L1_MESSENGER = address(0x8008);\n\n/// @dev The address of the bootloader start program\naddress constant L2_BOOTLOADER_ADDRESS = address(0x8001);\n\n/// @dev The address of the known code storage system contract\naddress constant L2_KNOWN_CODE_STORAGE_ADDRESS = address(0x8004);\n\n/// @dev The address of the context system contract\naddress constant L2_SYSTEM_CONTEXT_ADDRESS = address(0x800b);\n\n/// @dev Denotes the first byte of the zkSync transaction that came from L1.\nuint256 constant PRIORITY_OPERATION_L2_TX_TYPE = 255;\n\n/// @dev Expected average period of block creation\nuint256 constant BLOCK_PERIOD = 13 seconds;\n\n/// @dev Expiration delta for priority request to be satisfied (in seconds)\n/// @dev otherwise incorrect block with priority op could not be reverted.\nuint256 constant PRIORITY_EXPIRATION_PERIOD = 3 days;\n\n/// @dev Expiration delta for priority request to be satisfied (in ETH blocks)\nuint256 constant PRIORITY_EXPIRATION = $(\n    defined(PRIORITY_EXPIRATION) ? PRIORITY_EXPIRATION : PRIORITY_EXPIRATION_PERIOD / BLOCK_PERIOD\n);\n\n/// @dev Notice period before activation preparation status of upgrade mode (in seconds)\n/// @dev NOTE: we must reserve for users enough time to send full exit operation, wait maximum time for processing this operation and withdraw funds from it.\nuint256 constant UPGRADE_NOTICE_PERIOD = $$(defined(UPGRADE_NOTICE_PERIOD) ? UPGRADE_NOTICE_PERIOD : \"14 days\");\n\n/// @dev Timestamp - seconds since unix epoch\nuint256 constant COMMIT_TIMESTAMP_NOT_OLDER = $$(\n    defined(COMMIT_TIMESTAMP_NOT_OLDER) ? COMMIT_TIMESTAMP_NOT_OLDER : \"365 days\"\n);\n\n/// @dev Maximum available error between real commit block timestamp and analog used in the verifier (in seconds)\n/// @dev Must be used cause miner's `block.timestamp` value can differ on some small value (as we know - 15 seconds)\nuint256 constant COMMIT_TIMESTAMP_APPROXIMATION_DELTA = $$(\n    defined(COMMIT_TIMESTAMP_APPROXIMATION_DELTA) ? COMMIT_TIMESTAMP_APPROXIMATION_DELTA : \"365 days\"\n);\n\n/// @dev Bit mask to apply for verifier public input before verifying.\nuint256 constant INPUT_MASK = $$(~uint256(0) >> 8);\n\n/// @dev The maximum number of ergs that a user can request for L1 -> L2 transactions\nuint256 constant PRIORITY_TX_MAX_ERGS_LIMIT = 2097152;\n\n/// @dev Number of security council members that should approve an emergency upgrade\nuint256 constant SECURITY_COUNCIL_APPROVALS_FOR_EMERGENCY_UPGRADE = $$(\n    SECURITY_COUNCIL_APPROVALS_FOR_EMERGENCY_UPGRADE\n);"
    }
  ]
}