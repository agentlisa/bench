{
  "Title": "[H02] SafeGuardFactory can be freezed",
  "Content": "The [`Registry`](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/Registry.sol) contract is intended to keep track of all the [`SafeGuards`](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuard.sol) that the [`SafeGuardFactory` produces](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol). It has the external [`register` function](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/Registry.sol#L27) which is used for this purpose.\n\n\nAt the same time, the `SafeGuardFactory` has, in its constructor, the assignation of the local [`registry` value to the input value](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L28). Thereâ€™s no possibility to change the value of the `registry` variable and for this reason, if a new `Registry` gets deployed, a new factory must be deployed too.\n\n\nThe `SafeGuardFactory` has the [`createSafeGuard` function](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L34), in charge of first [deploying a new `SafeGuard`](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L36), then [a new `Timelock`](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L37) with the address of the `SafeGuard` as `admin`, [then setting the `timelock` variable of the `SafeGuard`](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L38) contract and finally [registering the `SafeGuard` in the registry](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L40).\n\n\nThe issue is that any call to `createSafeGuard` can be forced to fail by an attacker who can directly register the deterministic address of the new `SafeGuard` prior to its creation. Whenever a contract [creates a `new` instance](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/SafeGuardFactory.sol#L36), its nonce is increased, and the address of where the new instance of the contract would be deployed can be determined by the original contract address and its nonce. Therefore, an attacker can precalculate many of the addresses where the new `SafeGuards` will be deployed and register those addresses in the `Registry` by calling the `register` function. This would result in the calls to `createSafeGuard` to [revert](https://github.com/withtally/safeguard/blob/b2c63a9dfc4090be13320d999e7c6c1d842625d3/contracts/Registry.sol#L30) since the `Registry` already contains the address.\n\n\nTo avoid having external actors calling publicly the `Register` contract, consider restricting the access to the `register` function to accept calls exclusively by the `SafeGuardFactory`.\n\n\n**Update:** *Fixed in [PR #10](https://github.com/withtally/safeguard/pull/10). The Tally team has removed the `Registry` contract.*\n\n\n",
  "Impact": "HIGH",
  "Source": "",
  "Code": [
    {
      "filename": "contracts/SafeGuardFactory.sol",
      "content": "//SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport \"./IRegistry.sol\";\nimport \"./SafeGuard.sol\";\nimport \"./mocks/Timelock.sol\";\n\n/**\n *  @title SafeGuardFactory - factory contract for deploying SafeGuard contracts\n */\ncontract SafeGuardFactory {\n    /// @notice Address of the safeGuard registry\n    address public registry;\n\n    /// @notice The version of the rol manager\n    uint8 public constant SAFE_GUARD_VERSION = 1;\n\n    /// @notice Event emitted once new safeGuard is deployed\n    event SafeGuardCreated(\n        address indexed admin,\n        address indexed safeGuardAddress,\n        address indexed timelockAddress,\n        string safeName\n    );\n\n    constructor(address registry_) {\n        registry = registry_;\n    }\n\n    /**\n     * @notice Creates new instance of a SafeGuard contract\n     */\n    function createSafeGuard(uint delay_, string memory safeGuardName, address admin, bytes32[] memory roles, address[] memory rolesAssignees) external returns (address) {\n        require(roles.length == rolesAssignees.length, \"SafeGuardFactory::create: roles assignment arity mismatch\");\n        SafeGuard safeGuard = new SafeGuard(admin, roles, rolesAssignees);\n        Timelock timelock = new Timelock(address(safeGuard), delay_);\n        safeGuard.setTimelock(address(timelock));\n\n        IRegistry(registry).register(address(safeGuard), SAFE_GUARD_VERSION);\n\n        emit SafeGuardCreated(admin, address(safeGuard), address(timelock), safeGuardName);\n        return address(safeGuard);\n    }\n}"
    },
    {
      "filename": "contracts/SafeGuardFactory.sol",
      "content": "//SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport \"./IRegistry.sol\";\nimport \"./SafeGuard.sol\";\nimport \"./mocks/Timelock.sol\";\n\n/**\n *  @title SafeGuardFactory - factory contract for deploying SafeGuard contracts\n */\ncontract SafeGuardFactory {\n    /// @notice Address of the safeGuard registry\n    address public registry;\n\n    /// @notice The version of the rol manager\n    uint8 public constant SAFE_GUARD_VERSION = 1;\n\n    /// @notice Event emitted once new safeGuard is deployed\n    event SafeGuardCreated(\n        address indexed admin,\n        address indexed safeGuardAddress,\n        address indexed timelockAddress,\n        string safeName\n    );\n\n    constructor(address registry_) {\n        registry = registry_;\n    }\n\n    /**\n     * @notice Creates new instance of a SafeGuard contract\n     */\n    function createSafeGuard(uint delay_, string memory safeGuardName, address admin, bytes32[] memory roles, address[] memory rolesAssignees) external returns (address) {\n        require(roles.length == rolesAssignees.length, \"SafeGuardFactory::create: roles assignment arity mismatch\");\n        SafeGuard safeGuard = new SafeGuard(admin, roles, rolesAssignees);\n        Timelock timelock = new Timelock(address(safeGuard), delay_);\n        safeGuard.setTimelock(address(timelock));\n\n        IRegistry(registry).register(address(safeGuard), SAFE_GUARD_VERSION);\n\n        emit SafeGuardCreated(admin, address(safeGuard), address(timelock), safeGuardName);\n        return address(safeGuard);\n    }\n}"
    },
    {
      "filename": "contracts/SafeGuardFactory.sol",
      "content": "//SPDX-License-Identifier: MIT\n\npragma solidity ^0.8.0;\n\nimport \"./IRegistry.sol\";\nimport \"./SafeGuard.sol\";\nimport \"./mocks/Timelock.sol\";\n\n/**\n *  @title SafeGuardFactory - factory contract for deploying SafeGuard contracts\n */\ncontract SafeGuardFactory {\n    /// @notice Address of the safeGuard registry\n    address public registry;\n\n    /// @notice The version of the rol manager\n    uint8 public constant SAFE_GUARD_VERSION = 1;\n\n    /// @notice Event emitted once new safeGuard is deployed\n    event SafeGuardCreated(\n        address indexed admin,\n        address indexed safeGuardAddress,\n        address indexed timelockAddress,\n        string safeName\n    );\n\n    constructor(address registry_) {\n        registry = registry_;\n    }\n\n    /**\n     * @notice Creates new instance of a SafeGuard contract\n     */\n    function createSafeGuard(uint delay_, string memory safeGuardName, address admin, bytes32[] memory roles, address[] memory rolesAssignees) external returns (address) {\n        require(roles.length == rolesAssignees.length, \"SafeGuardFactory::create: roles assignment arity mismatch\");\n        SafeGuard safeGuard = new SafeGuard(admin, roles, rolesAssignees);\n        Timelock timelock = new Timelock(address(safeGuard), delay_);\n        safeGuard.setTimelock(address(timelock));\n\n        IRegistry(registry).register(address(safeGuard), SAFE_GUARD_VERSION);\n\n        emit SafeGuardCreated(admin, address(safeGuard), address(timelock), safeGuardName);\n        return address(safeGuard);\n    }\n}"
    }
  ]
}