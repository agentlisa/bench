{
  "Title": "[M-11] Owner of project NFT has no purpose",
  "Content": "_Submitted by berndartmueller, also found by byndooa and rbserver_\n\nCreating a new project mints a NFT to the `_sender` (builder). The `builder` of a project has special permissions and is required to perform various tasks.\n\nHowever, if the minted NFT is transferred to a different address, the `builder` of a project stays the same and the new owner of the transferred NFT has no purpose and no permissions to access authorized functions in Rigor.\n\nIf real-world use-cases require a change of the `builder` address, there is currently no way to do so. Funds could be locked in the project contract if the current `builder` address is unable to perform any more actions.\n\n### Proof of Concept\n\n[HomeFi.sol#L225](https://github.com/code-423n4/2022-08-rigor/blob/5ab7ea84a1516cb726421ef690af5bc41029f88f/contracts/HomeFi.sol#L225)<br>\n\n```solidity\nfunction createProject(bytes memory _hash, address _currency)\n    external\n    override\n    nonReentrant\n{\n    // Revert if currency not supported by HomeFi\n    validCurrency(_currency);\n\n    address _sender = _msgSender();\n\n    // Create a new project Clone and mint a new NFT for it\n    address _project = projectFactoryInstance.createProject(\n        _currency,\n        _sender\n    );\n    mintNFT(_sender, string(_hash));\n\n    // Update project related mappings\n    projects[projectCount] = _project;\n    projectTokenId[_project] = projectCount;\n\n    emit ProjectAdded(projectCount, _project, _sender, _currency, _hash);\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider preventing transferring the project NFT to a different address for now as long as there is no use-case for the NFT owner/holder or use the actual NFT owner as the `builder` of a project.\n\n**[zgorizzo69 (Rigor) disputed and commented](https://github.com/code-423n4/2022-08-rigor-findings/issues/413#issuecomment-1207294173):**\n > Builders are kyc'ed that's why just by transferring the NFT you don't get any of the builder privileges. \n\n**[parv3213 (Rigor) commented](https://github.com/code-423n4/2022-08-rigor-findings/issues/413#issuecomment-1207340273):**\n > As the warden said, `Owner of project NFT has no purpose` is true and is the intended behavior. Owning this NFT does not change anything.\n\n**[Jack the Pug (judge) confirmed as valid](https://github.com/code-423n4/2022-08-rigor-findings/issues/413)**\n\n\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/contests/2022-08-rigor-protocol-contest",
  "Code": [
    {
      "filename": "contracts/HomeFi.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity 0.8.6;\n\nimport {IHomeFi} from \"./interfaces/IHomeFi.sol\";\nimport {IProjectFactory} from \"./interfaces/IProjectFactory.sol\";\nimport {ReentrancyGuardUpgradeable} from \"@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol\";\nimport {ERC721URIStorageUpgradeable} from \"@openzeppelin/contracts-upgradeable/token/ERC721/extensions/ERC721URIStorageUpgradeable.sol\";\nimport {ContextUpgradeable, ERC2771ContextUpgradeable} from \"@openzeppelin/contracts-upgradeable/metatx/ERC2771ContextUpgradeable.sol\";\n\n/**\n * @title HomeFi v2.5.0 HomeFi Contract.\n\n * @notice Main on-chain client.\n * Administrative controls and project deployment.\n \n * @dev\n * Adheres to -\n * IHomeFi: Allows this contract to be used by other HomeFi contracts.\n\n * @dev\n * Inherits from -\n * ReentrancyGuardUpgradeable: Contract module that helps prevent reentrant calls to a function.\n * ERC721URIStorageUpgradeable: ERC721 token with storage based token URI management.\n * ERC2771ContextUpgradeable: Context variant with ERC2771 support.\n */\ncontract HomeFi is\n    IHomeFi,\n    ReentrancyGuardUpgradeable,\n    ERC721URIStorageUpgradeable,\n    ERC2771ContextUpgradeable\n{\n    /*******************************************************************************\n     * -------------------------PUBLIC STORED PROPERTIES-------------------------- *\n     *******************************************************************************/\n\n    /// @inheritdoc IHomeFi\n    address public override tokenCurrency1;\n    /// @inheritdoc IHomeFi\n    address public override tokenCurrency2;\n    /// @inheritdoc IHomeFi\n    address public override tokenCurrency3;\n    /// @inheritdoc IHomeFi\n    IProjectFactory public override projectFactoryInstance;\n    /// @inheritdoc IHomeFi\n    address public override disputesContract;\n    /// @inheritdoc IHomeFi\n    address public override communityContract;\n    /// @inheritdoc IHomeFi\n    bool public override addrSet;\n    /// @inheritdoc IHomeFi\n    address public override admin;\n    /// @inheritdoc IHomeFi\n    address public override treasury;\n    /// @inheritdoc IHomeFi\n    uint256 public override lenderFee;\n    /// @inheritdoc IHomeFi\n    uint256 public override projectCount;\n    /// @inheritdoc IHomeFi\n    address public override trustedForwarder;\n    /// @inheritdoc IHomeFi\n    mapping(uint256 => address) public override projects;\n    /// @inheritdoc IHomeFi\n    mapping(address => uint256) public override projectTokenId;\n    /// @inheritdoc IHomeFi\n    mapping(address => address) public override wrappedToken;\n\n    /*******************************************************************************\n     * ---------------------------------MODIFIERS--------------------------------- *\n     *******************************************************************************/\n\n    modifier onlyAdmin() {\n        require(admin == _msgSender(), \"HomeFi::!Admin\");\n        _;\n    }\n\n    modifier nonZero(address _address) {\n        require(_address != address(0), \"HomeFi::0 address\");\n        _;\n    }\n\n    modifier noChange(address _oldAddress, address _newAddress) {\n        // Revert if new address is same as old\n        require(_oldAddress != _newAddress, \"HomeFi::!Change\");\n        _;\n    }\n\n    /*******************************************************************************\n     * ---------------------------EXTERNAL TRANSACTIONS--------------------------- *\n     *******************************************************************************/\n    /// @inheritdoc IHomeFi\n    function initialize(\n        address _treasury,\n        uint256 _lenderFee,\n        address _tokenCurrency1,\n        address _tokenCurrency2,\n        address _tokenCurrency3,\n        address _forwarder\n    )\n        external\n        override\n        initializer\n        nonZero(_treasury)\n        nonZero(_tokenCurrency1)\n        nonZero(_tokenCurrency2)\n        nonZero(_tokenCurrency3)\n    {\n        // Initialize ERC721 and ERC2771Context\n        __ERC721_init(\"HomeFiNFT\", \"hNFT\");\n        __ERC2771Context_init(_forwarder);\n\n        // Initialize variables\n        admin = _msgSender();\n        treasury = _treasury;\n        lenderFee = _lenderFee; // the percentage must be multiplied with 10\n        tokenCurrency1 = _tokenCurrency1;\n        tokenCurrency2 = _tokenCurrency2;\n        tokenCurrency3 = _tokenCurrency3;\n        trustedForwarder = _forwarder;\n    }\n\n    /// @inheritdoc IHomeFi\n    function setAddr(\n        address _projectFactory,\n        address _communityContract,\n        address _disputesContract,\n        address _hTokenCurrency1,\n        address _hTokenCurrency2,\n        address _hTokenCurrency3\n    )\n        external\n        override\n        onlyAdmin\n        nonZero(_projectFactory)\n        nonZero(_communityContract)\n        nonZero(_disputesContract)\n        nonZero(_hTokenCurrency1)\n        nonZero(_hTokenCurrency2)\n        nonZero(_hTokenCurrency3)\n    {\n        // Revert if addrSet is true\n        require(!addrSet, \"HomeFi::Set\");\n\n        // Initialize variables\n        projectFactoryInstance = IProjectFactory(_projectFactory);\n        communityContract = _communityContract;\n        disputesContract = _disputesContract;\n        wrappedToken[tokenCurrency1] = _hTokenCurrency1;\n        wrappedToken[tokenCurrency2] = _hTokenCurrency2;\n        wrappedToken[tokenCurrency3] = _hTokenCurrency3;\n        addrSet = true;\n\n        emit AddressSet();\n    }\n\n    /// @inheritdoc IHomeFi\n    function replaceAdmin(address _newAdmin)\n        external\n        override\n        onlyAdmin\n        nonZero(_newAdmin)\n        noChange(admin, _newAdmin)\n    {\n        // Replace admin\n        admin = _newAdmin;\n\n        emit AdminReplaced(_newAdmin);\n    }\n\n    /// @inheritdoc IHomeFi\n    function replaceTreasury(address _newTreasury)\n        external\n        override\n        onlyAdmin\n        nonZero(_newTreasury)\n        noChange(treasury, _newTreasury)\n    {\n        // Replace treasury\n        treasury = _newTreasury;\n\n        emit TreasuryReplaced(_newTreasury);\n    }\n\n    /// @inheritdoc IHomeFi\n    function replaceLenderFee(uint256 _newLenderFee)\n        external\n        override\n        onlyAdmin\n    {\n        // Revert if no change in lender fee\n        require(lenderFee != _newLenderFee, \"HomeFi::!Change\");\n\n        // Reset variables\n        lenderFee = _newLenderFee;\n\n        emit LenderFeeReplaced(_newLenderFee);\n    }\n\n    /// @inheritdoc IHomeFi\n    function setTrustedForwarder(address _newForwarder)\n        external\n        override\n        onlyAdmin\n        noChange(trustedForwarder, _newForwarder)\n    {\n        trustedForwarder = _newForwarder;\n    }\n\n    /// @inheritdoc IHomeFi\n    function createProject(bytes memory _hash, address _currency)\n        external\n        override\n        nonReentrant\n    {\n        // Revert if currency not supported by HomeFi\n        validCurrency(_currency);\n\n        address _sender = _msgSender();\n\n        // Create a new project Clone and mint a new NFT for it\n        address _project = projectFactoryInstance.createProject(\n            _currency,\n            _sender\n        );\n        mintNFT(_sender, string(_hash));\n\n        // Update project related mappings\n        projects[projectCount] = _project;\n        projectTokenId[_project] = projectCount;\n\n        emit ProjectAdded(projectCount, _project, _sender, _currency, _hash);\n    }\n\n    /*******************************************************************************\n     * ------------------------------EXTERNAL VIEWS------------------------------- *\n     *******************************************************************************/\n\n    /// @inheritdoc IHomeFi\n    function isProjectExist(address _project)\n        external\n        view\n        override\n        returns (bool)\n    {\n        return projectTokenId[_project] > 0;\n    }\n\n    /*******************************************************************************\n     * -------------------------------PUBLIC VIEWS-------------------------------- *\n     *******************************************************************************/\n\n    /// @inheritdoc IHomeFi\n    function validCurrency(address _currency) public view override {\n        // _currency must be one of HomeFi supported currencies\n        require(\n            _currency == tokenCurrency1 ||\n                _currency == tokenCurrency2 ||\n                _currency == tokenCurrency3,\n            \"HomeFi::!Currency\"\n        );\n    }\n\n    /// @inheritdoc IHomeFi\n    function isTrustedForwarder(address _forwarder)\n        public\n        view\n        override(ERC2771ContextUpgradeable, IHomeFi)\n        returns (bool)\n    {\n        return trustedForwarder == _forwarder;\n    }\n\n    /*******************************************************************************\n     * ---------------------------INTERNAL TRANSACTIONS--------------------------- *\n     *******************************************************************************/\n    /**\n     * @dev Makes an NFT for every project\n\n     * @param _to address - NFT owner. Initially it will be the project builder.\n     * @param _tokenURI string - IPFS hash of project details like name, description etc\n\n     * @return _tokenIds NFT Id of project\n     */\n    function mintNFT(address _to, string memory _tokenURI)\n        internal\n        returns (uint256)\n    {\n        // Project count starts from 1\n        projectCount += 1;\n\n        // Mints NFT and set token URI\n        _mint(_to, projectCount);\n        _setTokenURI(projectCount, _tokenURI);\n\n        emit NftCreated(projectCount, _to);\n        return projectCount;\n    }\n\n    /*******************************************************************************\n     * ------------------------------INTERNAL VIEWS------------------------------- *\n     *******************************************************************************/\n    /// @dev This is same as ERC2771ContextUpgradeable._msgSender()\n    function _msgSender()\n        internal\n        view\n        override(ContextUpgradeable, ERC2771ContextUpgradeable)\n        returns (address sender)\n    {\n        // We want to use the _msgSender() implementation of ERC2771ContextUpgradeable\n        return super._msgSender();\n    }\n\n    /// @dev This is same as ERC2771ContextUpgradeable._msgData()\n    function _msgData()\n        internal\n        view\n        override(ContextUpgradeable, ERC2771ContextUpgradeable)\n        returns (bytes calldata)\n    {\n        // We want to use the _msgData() implementation of ERC2771ContextUpgradeable\n        return super._msgData();\n    }\n}"
    }
  ]
}