{
  "Title": "M-5: Malicious or compromised admin of certain LSTs could manipulate the price",
  "Content": "# Issue M-5: Malicious or compromised admin of certain LSTs could manipulate the price \n\nSource: https://github.com/sherlock-audit/2023-06-tokemak-judging/issues/570 \n\n## Found by \nctf\\_sec, xiaoming90\n\nMalicious or compromised admin of certain LSTs could manipulate the price of the LSTs.\n\n## Vulnerability Detail\n\n> **Important**\n> Per the [contest detail page](https://github.com/sherlock-audit/2023-06-tokemak-xiaoming9090/tree/main#q-are-the-admins-of-the-protocols-your-contracts-integrate-with-if-any-trusted-or-restricted), admins of the external protocols are marked as \"Restricted\" (Not Trusted). This means that any potential issues arising from the external protocol's admin actions (maliciously or accidentally) are considered valid in the context of this audit.\n>\n> **Q: Are the admins of the protocols your contracts integrate with (if any) TRUSTED or RESTRICTED?**\n>\n> RESTRICTED\n\n> **Note**\n> This issue also applies to other support Liquid Staking Tokens (LSTs) where the admin could upgrade the token contract code. Those examples are omitted for brevity, as the write-up and mitigation are the same and would duplicate this issue.\n\nPer the [contest detail page](https://github.com/sherlock-audit/2023-06-tokemak-xiaoming9090/tree/main#q-which-erc20-tokens-do-you-expect-will-interact-with-the-smart-contracts), the protocol will hold and interact with the Swell ETH (swETH).\n\n> Liquid Staking Tokens\n>\n> - swETH: 0xf951E335afb289353dc249e82926178EaC7DEd78\n\nUpon inspection of the [swETH on-chain contract](https://etherscan.io/token/0xf951e335afb289353dc249e82926178eac7ded78#code), it was found that it is a Transparent Upgradeable Proxy. This means that the admin of Swell protocol could upgrade the contracts. \n\nTokemak relies on the `swEth.swETHToETHRate()` function to determine the price of the swETH LST within the protocol. Thus, a malicious or compromised admin of Swell could upgrade the contract to have the `swETHToETHRate` function return an extremely high to manipulate the total values of the vaults, resulting in users being able to withdraw more assets than expected, thus draining the LMPVault.\n\n```solidity\nFile: SwEthEthOracle.sol\n26:     function getPriceInEth(address token) external view returns (uint256 price) {\n27:         // Prevents incorrect config at root level.\n28:         if (token != address(swEth)) revert Errors.InvalidToken(token);\n29: \n30:         // Returns in 1e18 precision.\n31:         price = swEth.swETHToETHRate();\n32:     }\n```\n\n## Impact\n\nLoss of assets in the scenario as described above.\n\n## Code Snippet\n\nhttps://github.com/sherlock-audit/2023-06-tokemak/blob/main/v2-core-audit-2023-07-14/src/oracles/providers/SwEthEthOracle.sol#L26\n\n## Tool used\n\nManual Review\n\n## Recommendation\n\nThe protocol team should be aware of the above-mentioned risks and consider implementing additional controls to reduce the risks. \n\nReview each of the supported LSTs and determine how much power the Liquid staking protocol team/admin has over its tokens.\n\nFor LSTs that are more centralized (e.g., Liquid staking protocol team could update the token contracts or have the ability to update the exchange rate/price to an arbitrary value without any limit), those LSTs should be subjected to additional controls or monitoring, such as implementing some form of circuit breakers if the price deviates beyond a reasonable percentage to reduce the negative impact to Tokemak if it happens.\n\n",
  "Impact": "MEDIUM",
  "Source": "https://app.sherlock.xyz/audits/contests/101",
  "Code": [
    {
      "filename": "v2-core-audit-2023-07-14/src/oracles/providers/SwEthEthOracle.sol",
      "content": "// SPDX-License-Identifier: UNLICENSED\n// Copyright (c) 2023 Tokemak Foundation. All rights reserved.\n\npragma solidity 0.8.17;\n\nimport { Errors } from \"src/utils/Errors.sol\";\nimport { IswETH } from \"src/interfaces/external/swell/IswETH.sol\";\nimport { ISystemRegistry } from \"src/interfaces/ISystemRegistry.sol\";\nimport { IPriceOracle } from \"src/interfaces/oracles/IPriceOracle.sol\";\nimport { SystemComponent } from \"src/SystemComponent.sol\";\n\n/**\n * @notice Price oracle specifically for swEth (Swell Eth).\n * @dev getPriceEth is not a view fn to support reentrancy checks. Does not actually change state.\n */\ncontract SwEthEthOracle is SystemComponent, IPriceOracle {\n    IswETH public immutable swEth;\n\n    constructor(ISystemRegistry _systemRegistry, IswETH _swEth) SystemComponent(_systemRegistry) {\n        Errors.verifyNotZero(address(_swEth), \"_swEth\");\n\n        swEth = _swEth;\n    }\n\n    /// @inheritdoc IPriceOracle\n    function getPriceInEth(address token) external view returns (uint256 price) {\n        // Prevents incorrect config at root level.\n        if (token != address(swEth)) revert Errors.InvalidToken(token);\n\n        // Returns in 1e18 precision.\n        price = swEth.swETHToETHRate();\n    }\n}"
    }
  ]
}