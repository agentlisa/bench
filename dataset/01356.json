{
  "Title": "Lambda convert logic should continue to be refined",
  "Content": "The purpose of the `LibConvertData::ConvertKind` enum type [`LAMBDA_LAMBDA`](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/libraries/Convert/LibConvertData.sol#L17) is to allow the Bean Denominated Value (BDV) of a deposit to be updated without forcing the owner to first withdraw that deposit, which has the undesirable side-effect of foregoing the grown Stalk of the deposit. The token `amountIn` and `amountOut` are equal when calling [`LibLambdaConvert::convert`](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/libraries/Convert/LibLambdaConvert.sol#L15-L28) through [`ConvertFacet::convert`](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/beanstalk/silo/ConvertFacet.sol#L71), which proceeds to calculate a [new BDV](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/beanstalk/silo/ConvertFacet.sol#L85) for the deposit corresponding to the existing token amount. As mentioned, this allows users to update the BDV of a deposit that is potentially stale to the downside without first withdrawing the deposit; however, by the same token, it is possible for the BDV for a deposit to be stale in such a way that its BDV is higher than it should be in reality. In this case, the user has no incentive to perform a lambda convert on their deposit because it benefits from additional seignorage than it should actually be owed given current market conditions. It is [not currently possible](https://github.com/BeanstalkFarms/Beanstalk/blob/c7a20e56a0a6659c09314a877b440198eff0cd81/protocol/contracts/beanstalk/silo/ConvertFacet.sol#L85) for the BDV of a deposit to decrease, but it is understood that a Game Theoretic solution is intended to be implemented to allow any caller to initiate a lambda convert on the deposit of a given account that may be stale in this way. It is recommended that this solution be implemented as a temporary measure while other methods for handling this issue are explored.",
  "Impact": "LOW",
  "Source": "",
  "Code": [
    {
      "filename": "protocol/contracts/libraries/Convert/LibConvertData.sol",
      "content": "// SPDX-License-Identifier: MIT\n\npragma solidity =0.7.6;\npragma experimental ABIEncoderV2;\n\n/**\n * @title LibConvertData\n * @author LeoFib\n */\nlibrary LibConvertData {\n    // In order to preserve backwards compatibility, make sure new kinds are added at the end of the enum.\n    enum ConvertKind {\n        BEANS_TO_CURVE_LP,\n        CURVE_LP_TO_BEANS,\n        UNRIPE_BEANS_TO_UNRIPE_LP,\n        UNRIPE_LP_TO_UNRIPE_BEANS,\n        LAMBDA_LAMBDA,\n        BEANS_TO_WELL_LP,\n        WELL_LP_TO_BEANS\n    }\n\n    /// @notice Decoder for the Convert Enum\n    function convertKind(bytes memory self)\n        internal\n        pure\n        returns (ConvertKind)\n    {\n        return abi.decode(self, (ConvertKind));\n    }\n\n    /// @notice Decoder for the addLPInBeans Convert\n    function basicConvert(bytes memory self)\n        internal\n        pure\n        returns (uint256 amountIn, uint256 minAmontOut)\n    {\n        (, amountIn, minAmontOut) = abi.decode(\n            self,\n            (ConvertKind, uint256, uint256)\n        );\n    }\n\n    /// @notice Decoder for the addLPInBeans Convert\n    function convertWithAddress(bytes memory self)\n        internal\n        pure\n        returns (\n            uint256 amountIn,\n            uint256 minAmontOut,\n            address token\n        )\n    {\n        (, amountIn, minAmontOut, token) = abi.decode(\n            self,\n            (ConvertKind, uint256, uint256, address)\n        );\n    }\n\n    function lambdaConvert(bytes memory self)\n        internal\n        pure\n        returns (uint256 amount, address token)\n    {\n        (, amount, token) = abi.decode(self, (ConvertKind, uint256, address));\n    }\n}"
    }
  ]
}