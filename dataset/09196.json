{
  "Title": "[G-12] Offsets should only be calculated once per loop",
  "Content": "`i * 2` is calculated twice per loop, wasting gas\n\n*There is 1 instance of this issue:*\n```solidity\nFile: contracts/src/CallyNft.sol   #1\n\n244          for (uint256 i = 0; i < data.length; i++) {\n245              str[2 + i * 2] = alphabet[uint256(uint8(data[i] >> 4))];\n246              str[3 + i * 2] = alphabet[uint256(uint8(data[i] & 0x0f))];\n247:         }\n```\nhttps://github.com/code-423n4/2022-05-cally/blob/1849f9ee12434038aa80753266ce6a2f2b082c59/contracts/src/CallyNft.sol#L244-L247\n\n",
  "Impact": "GAS",
  "Source": "https://code4rena.com/contests/2022-05-cally-contest",
  "Code": [
    {
      "filename": "contracts/src/CallyNft.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.13;\n\nimport \"solmate/tokens/ERC721.sol\";\nimport \"openzeppelin/utils/Strings.sol\";\nimport \"hot-chain-svg/SVG.sol\";\nimport \"base64/base64.sol\";\n\n// removes balanceOf modifications\n// questionable tradeoff but given our use-case it's reasonable\n// saves 20k gas when minting which about 30% gas on buys/vault creations\nabstract contract CallyNft is ERC721(\"Cally\", \"CALL\") {\n    // remove balanceOf modifications\n    function _mint(address to, uint256 id) internal override {\n        require(to != address(0), \"INVALID_RECIPIENT\");\n        require(_ownerOf[id] == address(0), \"ALREADY_MINTED\");\n\n        _ownerOf[id] = to;\n\n        emit Transfer(address(0), to, id);\n    }\n\n    // burns a token without checking owner address is not 0\n    // and removes balanceOf modifications\n    function _burn(uint256 id) internal override {\n        address owner = _ownerOf[id];\n\n        delete _ownerOf[id];\n        delete getApproved[id];\n\n        emit Transfer(owner, address(0), id);\n    }\n\n    // set balanceOf to max for all users\n    function balanceOf(address owner) public pure override returns (uint256) {\n        require(owner != address(0), \"ZERO_ADDRESS\");\n        return type(uint256).max;\n    }\n\n    // forceTransfer option position NFT out of owner's wallet and give to new buyer\n    function _forceTransfer(address to, uint256 id) internal {\n        require(to != address(0), \"INVALID_RECIPIENT\");\n\n        address from = _ownerOf[id];\n        _ownerOf[id] = to;\n        delete getApproved[id];\n\n        emit Transfer(from, to, id);\n    }\n\n    function renderJson(\n        address token_,\n        uint256 tokenIdOrAmount_,\n        uint256 premium_,\n        uint256 durationDays_,\n        uint256 dutchAuctionStartingStrike_,\n        uint256 currentExpiration_,\n        uint256 currentStrike_,\n        bool isExercised_,\n        bool isVault_\n    ) public pure returns (string memory) {\n        string memory token = addressToString(token_);\n        string memory tokenIdOrAmount = Strings.toString(tokenIdOrAmount_);\n        string memory premium = Strings.toString(premium_);\n        string memory durationDays = Strings.toString(durationDays_);\n        string memory dutchAuctionStartingStrike = Strings.toString(dutchAuctionStartingStrike_);\n        string memory currentExpiration = Strings.toString(currentExpiration_);\n        string memory currentStrike = Strings.toString(currentStrike_);\n        string memory isExercised = Strings.toString(isExercised_ ? 1 : 0);\n        string memory nftType = isVault_ ? \"Vault\" : \"Option\";\n\n        string memory svgStr = renderSvg(\n            token,\n            tokenIdOrAmount,\n            premium,\n            durationDays,\n            dutchAuctionStartingStrike,\n            currentExpiration,\n            currentStrike,\n            isExercised,\n            nftType\n        );\n\n        string memory json = string.concat(\n            /* solhint-disable quotes */\n            '{\"name\":\"',\n            \"Cally\",\n            '\",\"description\":\"',\n            \"NFT and ERC20 covered call vaults\",\n            '\",\"image\": \"data:image/svg+xml;base64,',\n            Base64.encode(bytes(svgStr)),\n            '\",\"attributes\": [',\n            '{ \"trait_type\": \"token\",',\n            '\"value\": \"',\n            token,\n            '\"},',\n            '{ \"trait_type\": \"tokenIdOrAmount\",',\n            '\"value\": \"',\n            tokenIdOrAmount,\n            '\"},',\n            '{ \"trait_type\": \"premium\",',\n            '\"value\": \"',\n            premium,\n            '\"},',\n            '{ \"trait_type\": \"durationDays\",',\n            '\"value\": \"',\n            durationDays,\n            '\"},',\n            '{ \"trait_type\": \"dutchAuctionStartingStrike\",',\n            '\"value\": \"',\n            dutchAuctionStartingStrike,\n            '\"},',\n            '{ \"trait_type\": \"currentExpiration\",',\n            '\"value\": \"',\n            currentExpiration,\n            '\"},',\n            '{ \"trait_type\": \"currentStrike\",',\n            '\"value\": \"',\n            currentStrike,\n            '\"},',\n            '{ \"trait_type\": \"isExercised\",',\n            '\"value\": \"',\n            isExercised,\n            '\"},',\n            '{ \"trait_type\": \"nftType\",',\n            '\"value\": \"',\n            nftType,\n            '\"}',\n            \"]}\"\n            /* solhint-enable quotes */\n        );\n\n        return json;\n    }\n\n    function renderSvg(\n        string memory token,\n        string memory tokenIdOrAmount,\n        string memory premium,\n        string memory durationDays,\n        string memory dutchAuctionStartingStrike,\n        string memory currentExpiration,\n        string memory currentStrike,\n        string memory isExercised,\n        string memory nftType\n    ) public pure returns (string memory) {\n        return\n            string.concat(\n                // solhint-disable-next-line quotes\n                '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"350\" height=\"350\" style=\"background:#000\">',\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"20\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Token: \"), token)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"40\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Token ID or Amount: \"), tokenIdOrAmount)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"60\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Premium (WEI): \"), premium)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"80\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Duration (days): \"), durationDays)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"100\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Starting strike (WEI): \"), dutchAuctionStartingStrike)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"120\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Expiration (UNIX): \"), currentExpiration)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"140\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Strike (WEI): \"), currentStrike)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"160\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Exercised (y/n): \"), isExercised)\n                ),\n                svg.text(\n                    string.concat(\n                        svg.prop(\"x\", \"10\"),\n                        svg.prop(\"y\", \"180\"),\n                        svg.prop(\"font-size\", \"12\"),\n                        svg.prop(\"fill\", \"white\")\n                    ),\n                    string.concat(svg.cdata(\"Type: \"), nftType)\n                ),\n                \"</svg>\"\n            );\n    }\n\n    function addressToString(address account) public pure returns (string memory) {\n        bytes memory data = abi.encodePacked(account);\n\n        bytes memory alphabet = \"0123456789abcdef\";\n\n        bytes memory str = new bytes(2 + data.length * 2);\n        str[0] = \"0\";\n        str[1] = \"x\";\n        for (uint256 i = 0; i < data.length; i++) {\n            str[2 + i * 2] = alphabet[uint256(uint8(data[i] >> 4))];\n            str[3 + i * 2] = alphabet[uint256(uint8(data[i] & 0x0f))];\n        }\n\n        return string(str);\n    }\n}"
    }
  ]
}