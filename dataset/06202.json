{
  "Title": "[M-17] `VaultFactory` allows deployment of vaults with non-authentic `TwabController` and `PrizePool`",
  "Content": "\nA malicious vault can be deployed via the official `VaultFactory` contract. Users may lose funds while interacting with such vaults.\n\n### Proof of Concept\n\nThe [VaultFactory.deployVault](https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L55) function allows deploying `Vault` contracts. The factory contract maintains a [mapping to verify that a vault has been deployed via the factory](https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L32-L36). This allows users to check the authenticity of a vault to ensure the that implementation of a vault is authentic (i.e. not altered/malicious).\n\nHowever, the business logic of vaults is split into multiple contracts: [Vault](https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol), [TwabController](https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/TwabController.sol), and [PrizePool](https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol). `TwabController` tracks the historical balances of users to determine their chances of winning prizes. `PrizePool` runs regular draws and distributes prizes among winners. Thus, it's critical that in every authentic `Vault` contract, the implementations of `TwabController` and `PrizePool` are also authentic. Otherwise, a malicious actor could deploy an authentic vault via the official `VaultFactory` and provide malicious `TwabController` and `PrizePool` contracts; which can incorrectly determine user balances, favors some specific addresses when determining winners, or steals the prize token. In the current implementation, users are be able to check the authenticity of a vault contract, but not the authenticity of the `TwabController` and the `PrizePool` contracts that a vault integrates with.\n\n### Recommended Mitigation Steps\n\nConsider implementing `TwabController` and `PrizePool` factory contracts. In the contracts, consider tracking the addresses of the deployed `TwabController` and `PrizePool` contracts. In the `VaultFactory.deployVault` function, consider checking that the passed `_twabController` and `_prizePool` address were deployed via the respective factory contracts.\n\n**[Picodes (judge) commented](https://github.com/code-423n4/2023-07-pooltogether-findings/issues/300#issuecomment-1666995677):**\n > See [Issue #324](https://github.com/code-423n4/2023-07-pooltogether-findings/issues/324#issuecomment-1637047041).\n\n**[asselstine (PoolTogether) acknowledged and commented via duplicate issue #324](https://github.com/code-423n4/2023-07-pooltogether-findings/issues/324#issuecomment-1644594809):**\n> This the point of V5: we are replacing protocol gatekeeping with curation by front-ends.\n>\n> The responsibility of curation will rest on front-ends, who will curate which vaults they show their users.\n\n***\n\n",
  "Impact": "MEDIUM",
  "Source": "https://code4rena.com/reports/2023-07-pooltogether",
  "Code": [
    {
      "filename": "src/VaultFactory.sol",
      "content": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.17;\n\nimport { IERC20, IERC4626 } from \"openzeppelin/token/ERC20/extensions/ERC4626.sol\";\n\nimport { LiquidationPair } from \"v5-liquidator/LiquidationPair.sol\";\nimport { PrizePool } from \"v5-prize-pool/PrizePool.sol\";\nimport { TwabController } from \"v5-twab-controller/TwabController.sol\";\n\nimport { Vault } from \"./Vault.sol\";\n\n/**\n * @title  PoolTogether V5 Vault Factory\n * @author PoolTogether Inc Team, Generation Software Team\n * @notice Factory contract for deploying new vaults using a standard underlying ERC4626 yield vault.\n */\ncontract VaultFactory {\n  /* ============ Events ============ */\n\n  /**\n   * @notice Emitted when a new Vault has been deployed by this factory.\n   * @param vault Address of the vault that was deployed\n   * @param vaultFactory Address of the VaultFactory that deployed `vault`\n   */\n  event NewFactoryVault(Vault indexed vault, VaultFactory indexed vaultFactory);\n\n  /* ============ Variables ============ */\n\n  /// @notice List of all vaults deployed by this factory.\n  Vault[] public allVaults;\n\n  /**\n   * @notice Mapping to verify if a Vault has been deployed via this factory.\n   * @dev Vault address => boolean\n   */\n  mapping(Vault => bool) public deployedVaults;\n\n  /* ============ External Functions ============ */\n\n  /**\n   * @notice Deploy a new vault\n   * @dev `claimer` can be set to address zero if none is available yet.\n   * @param _asset Address of the underlying asset used by the vault\n   * @param _name Name of the ERC20 share minted by the vault\n   * @param _symbol Symbol of the ERC20 share minted by the vault\n   * @param _twabController Address of the TwabController used to keep track of balances\n   * @param _yieldVault Address of the ERC4626 vault in which assets are deposited to generate yield\n   * @param _prizePool Address of the PrizePool that computes prizes\n   * @param _claimer Address of the claimer\n   * @param _yieldFeeRecipient Address of the yield fee recipient\n   * @param _yieldFeePercentage Yield fee percentage\n   * @param _owner Address that will gain ownership of this contract\n   * @return address Address of the newly deployed Vault\n   */\n  function deployVault(\n    IERC20 _asset,\n    string memory _name,\n    string memory _symbol,\n    TwabController _twabController,\n    IERC4626 _yieldVault,\n    PrizePool _prizePool,\n    address _claimer,\n    address _yieldFeeRecipient,\n    uint256 _yieldFeePercentage,\n    address _owner\n  ) external returns (address) {\n    Vault _vault = new Vault(\n      _asset,\n      _name,\n      _symbol,\n      _twabController,\n      _yieldVault,\n      _prizePool,\n      _claimer,\n      _yieldFeeRecipient,\n      _yieldFeePercentage,\n      _owner\n    );\n\n    allVaults.push(_vault);\n    deployedVaults[_vault] = true;\n\n    emit NewFactoryVault(_vault, VaultFactory(address(this)));\n\n    return address(_vault);\n  }\n\n  /**\n   * @notice Total number of vaults deployed by this factory.\n   * @return uint256 Number of vaults deployed by this factory.\n   */\n  function totalVaults() external view returns (uint256) {\n    return allVaults.length;\n  }\n}"
    }
  ]
}