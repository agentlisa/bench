{
  "Title": "[H-01] Update initializer modifier to prevent reentrancy during initialization",
  "Content": "# Lines of code\n\nhttps://github.com/code-423n4/2022-02-hubble/blob/main/package.json#L17\nhttps://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L5\nhttps://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L24\n\n\n# Vulnerability details\n\n## Impact\n\nWhile Governable.sol is out of scope, I figured this issue would still be fair game.\n\nThe solution uses: `\"@openzeppelin/contracts\": \"4.2.0\"`.\nThis dependency has a known high severity vulnerability: https://security.snyk.io/vuln/SNYK-JS-OPENZEPPELINCONTRACTS-2320176\nWhich makes this contract vulnerable:\n```\nFile: Governable.sol\n05: import { Initializable } from \"@openzeppelin/contracts/proxy/utils/Initializable.sol\";\n...\n24: contract Governable is VanillaGovernable, Initializable {}\n```\n\nThis contract is inherited at multiple places:\n```\ncontracts/AMM.sol:\n  11: contract AMM is IAMM, Governable {\n\ncontracts/InsuranceFund.sol:\n  13: contract InsuranceFund is VanillaGovernable, ERC20Upgradeable {\n\ncontracts/Oracle.sol:\n  11: contract Oracle is Governable {\n\ncontracts/legos/HubbleBase.sol:\n  15: contract HubbleBase is Governable, Pausable, ERC2771Context {\n\ncontracts/ClearingHouse.sol:\n  11: contract ClearingHouse is IClearingHouse, HubbleBase {\n\ncontracts/MarginAccount.sol:\n  25: contract MarginAccount is IMarginAccount, HubbleBase {\n```\n\n Ã¬nitializer()` is used here:\n```\ncontracts/AMM.sol:\n  99:     ) external initializer {\n\ncontracts/ClearingHouse.sol:\n  44:     ) external initializer {\n\ncontracts/MarginAccount.sol:\n  124:     ) external initializer {\n\ncontracts/Oracle.sol:\n  20:     function initialize(address _governance) external initializer {\n\n```\n\n## Recommended Mitigation Steps\nUpgrade `@openzeppelin/contracts` to version 4.4.1 or higher.\n\n",
  "Impact": "HIGH",
  "Source": "https://code4rena.com/contests/2022-02-hubble-contest",
  "Code": [
    {
      "filename": "package.json",
      "content": "{\n  \"name\": \"2022-02-hubble\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Perpetual futures exchange on Avalanche.\",\n  \"scripts\": {\n    \"compile\": \"npx hardhat compile\",\n    \"compile:swap\": \"vyper -f abi,bytecode contracts/curve-v2/Swap.vy > contracts/curve-v2/Swap.txt\",\n    \"compile:CurveMath\": \"vyper -f abi,bytecode contracts/curve-v2/CurveMath.vy > contracts/curve-v2/CurveMath.txt\",\n    \"compile:views\": \"vyper -f abi,bytecode contracts/curve-v2/Views.vy > contracts/curve-v2/Views.txt\",\n    \"vyper-compile\": \"npm run compile:swap && npm run compile:CurveMath && npm run compile:views\"\n  },\n  \"license\": \"BUSL-1.1\",\n  \"devDependencies\": {\n    \"@nomiclabs/hardhat-ethers\": \"^2.0.2\",\n    \"@nomiclabs/hardhat-waffle\": \"^2.0.1\",\n    \"@nomiclabs/hardhat-web3\": \"^2.0.0\",\n    \"@openzeppelin/contracts\": \"4.2.0\",\n    \"@openzeppelin/contracts-upgradeable\": \"4.3.2\",\n    \"chai\": \"^4.3.4\",\n    \"csv-parser\": \"^3.0.0\",\n    \"ethereum-waffle\": \"^3.4.0\",\n    \"ethers\": \"^5.4.1\",\n    \"hardhat\": \"^2.8.3\",\n    \"hardhat-docgen\": \"^1.3.0\",\n    \"hardhat-gas-reporter\": \"^1.0.6\",\n    \"hardhat-spdx-license-identifier\": \"^2.0.3\",\n    \"solidity-coverage\": \"^0.7.17\"\n  },\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"git+https://github.com/code-423n4/2022-02-hubble.git\"\n  },\n  \"homepage\": \"https://github.com/code-423n4/2022-02-hubble#readme\"\n}"
    },
    {
      "filename": "contracts/legos/Governable.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\n\npragma solidity 0.8.9;\n\nimport { Initializable } from \"@openzeppelin/contracts/proxy/utils/Initializable.sol\";\n\ncontract VanillaGovernable {\n    address public governance;\n\n    modifier onlyGovernance() {\n        require(msg.sender == governance, \"ONLY_GOVERNANCE\");\n        _;\n    }\n\n    function setGovernace(address _governance) external onlyGovernance {\n        _setGovernace(_governance);\n    }\n\n    function _setGovernace(address _governance) internal {\n        governance = _governance;\n    }\n}\n\ncontract Governable is VanillaGovernable, Initializable {}"
    },
    {
      "filename": "contracts/legos/Governable.sol",
      "content": "// SPDX-License-Identifier: BUSL-1.1\n\npragma solidity 0.8.9;\n\nimport { Initializable } from \"@openzeppelin/contracts/proxy/utils/Initializable.sol\";\n\ncontract VanillaGovernable {\n    address public governance;\n\n    modifier onlyGovernance() {\n        require(msg.sender == governance, \"ONLY_GOVERNANCE\");\n        _;\n    }\n\n    function setGovernace(address _governance) external onlyGovernance {\n        _setGovernace(_governance);\n    }\n\n    function _setGovernace(address _governance) internal {\n        governance = _governance;\n    }\n}\n\ncontract Governable is VanillaGovernable, Initializable {}"
    }
  ]
}